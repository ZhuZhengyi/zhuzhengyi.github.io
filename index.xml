<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Justiceçš„å°ç«™</title><link>https://justice.bj.cn/</link><description>Recent content on Justiceçš„å°ç«™</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 12 Jun 2022 20:44:24 +0800</lastBuildDate><atom:link href="https://justice.bj.cn/index.xml" rel="self" type="application/rss+xml"/><item><title>Justice's Blog</title><link>https://justice.bj.cn/homepage/about/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://justice.bj.cn/homepage/about/</guid><description>&lt;h2 id="self-introduction">Self Introduction&lt;/h2>
&lt;p>Cras ex dui, tristique a libero eget, consectetur semper ligula. Nunc augue arcu, malesuada a nisi et, molestie finibus metus. Sed lacus odio, ultricies a nisl vitae, sollicitudin tempor ipsum. Vivamus quis feugiat arcu. Sed mi nunc, efficitur quis tellus vitae, posuere mattis metus. Phasellus in mattis dui. Nullam blandit, augue non ullamcorper dapibus, lacus dui molestie massa, in iaculis purus lectus eu lectus. Duis hendrerit lacinia tellus, sit amet feugiat dolor placerat id. Aenean ac velit massa. Vivamus feugiat dui at magna viverra, ut dictum nunc rutrum. Duis eget sapien finibus, lobortis orci id, vestibulum tellus. Maecenas lobortis urna libero, quis fermentum lectus lobortis nec. Nullam laoreet volutpat libero, ac mattis magna ullamcorper quis. Duis eget ipsum eu nisi mattis cursus et vitae turpis.&lt;/p>
&lt;p>Aliquam pretium diam eget leo feugiat finibus. Donec malesuada commodo ipsum. Aenean a massa in lacus venenatis vestibulum. Duis vel sem quis elit iaculis consectetur et quis dolor. Morbi eu ipsum hendrerit, malesuada ante sed, dapibus est. Suspendisse feugiat nulla ut gravida convallis. Phasellus id massa posuere, rhoncus justo ut, porttitor dolor. Nulla ultrices malesuada egestas. Nunc fermentum tincidunt sem ac vulputate. Donec mollis sollicitudin justo eget varius. Donec ornare velit et felis blandit, id molestie sapien lobortis. Morbi eget tristique justo. Mauris posuere, nibh eu laoreet ultricies, ligula erat iaculis sapien, vel dapibus lacus libero ut diam. Etiam viverra ante felis, et scelerisque nunc pellentesque vitae. Praesent feugiat dictum molestie.&lt;/p>
&lt;h2 id="details">Details&lt;/h2>
&lt;p>Nunc pellentesque vitae:&lt;/p>
&lt;ul>
&lt;li>Morbi accumsan nibh efficitur diam molestie, non dignissim diam facilisis.&lt;/li>
&lt;li>Donec dignissim leo in mollis faucibus.&lt;/li>
&lt;li>Donec blandit lacus a pellentesque fermentum.&lt;/li>
&lt;/ul>
&lt;p>Donec mollis sollicitudin:&lt;/p>
&lt;ul>
&lt;li>Nunc dictum purus ornare purus consectetur, eu pellentesque massa ullamcorper.&lt;/li>
&lt;li>Aliquam eu leo vitae justo aliquam tincidunt.&lt;/li>
&lt;li>Fusce non massa id augue interdum feugiat sed et nulla.&lt;/li>
&lt;li>Vivamus molestie augue in tristique laoreet.&lt;/li>
&lt;/ul></description></item><item><title>Pages</title><link>https://justice.bj.cn/homepage/pages/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://justice.bj.cn/homepage/pages/</guid><description/></item><item><title>Experiences</title><link>https://justice.bj.cn/homepage/experiences/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://justice.bj.cn/homepage/experiences/</guid><description/></item><item><title>Vintage</title><link>https://justice.bj.cn/homepage/vintage/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://justice.bj.cn/homepage/vintage/</guid><description/></item><item><title>Blank</title><link>https://justice.bj.cn/homepage/blank/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://justice.bj.cn/homepage/blank/</guid><description>
&lt;div style="text-align:center">
&lt;p>Write anything you like here!&lt;/p>
&lt;/div></description></item><item><title>blockchain_rust</title><link>https://justice.bj.cn/post/14.language/rust/rust%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E4%B9%8Bblockchain/</link><pubDate>Sun, 12 Jun 2022 20:44:24 +0800</pubDate><guid>https://justice.bj.cn/post/14.language/rust/rust%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E4%B9%8Bblockchain/</guid><description>&lt;h1 id="blockchain_rust">blockchain_rust&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;p>blockchain_rustæ˜¯githubä¸Šä¸€ä¸ªåŸºäºrustçš„blockchainå®ç°ï¼›&lt;/p>
&lt;h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ&lt;/h2>
&lt;ul>
&lt;li>blockï¼š&lt;/li>
&lt;/ul>
&lt;h2 id="æ“ä½œ">æ“ä½œ&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="o">[&lt;/span>node1&lt;span class="o">]&lt;/span>$ mkdir -p data/node&lt;span class="o">{&lt;/span>1,2,3&lt;span class="o">}&lt;/span>
&lt;span class="o">[&lt;/span>node1&lt;span class="o">]&lt;/span>$ &lt;span class="nb">cd&lt;/span> data/node1
&lt;span class="c1">## åˆ›å»ºwallet&lt;/span>
&lt;span class="o">[&lt;/span>node1&lt;span class="o">]&lt;/span>$ ../../target/debug/blockchain_rust createwallet
Your new address: 13teoDGrDNhMrgGHHRESv7bhcnJoXnicqE
&lt;span class="c1">## åˆ›å»ºblock0&lt;/span>
&lt;span class="o">[&lt;/span>node1&lt;span class="o">]&lt;/span>$ ../../target/debug/blockchain_rust createblockchain 13teoDGrDNhMrgGHHRESv7bhcnJoXnicqE
Mining the block
00518dae1ee13a19da96d24f865654eed74dfb3188f4ae0fe56616c03535acb9
Done!
&lt;span class="c1">## æ‰‹åŠ¨åŒæ­¥åˆ›ä¸–åŒºå—æ•°æ®&lt;/span>
&lt;span class="o">[&lt;/span>node2&lt;span class="o">]&lt;/span> &lt;span class="nb">cd&lt;/span> data/node2&lt;span class="p">;&lt;/span> cp -rf ../node1/data .
&lt;span class="o">[&lt;/span>node3&lt;span class="o">]&lt;/span> &lt;span class="nb">cd&lt;/span> data/node3&lt;span class="p">;&lt;/span> cp -rf ../node1/data .
&lt;span class="c1">## node2åˆ›å»ºé’±åŒ…&lt;/span>
&lt;span class="o">[&lt;/span>node2&lt;span class="o">]&lt;/span>$ ../../target/debug/blockchain_rust createwallet
Your new address: 1JvjDQGrmzVLLAo9dPsXYNNednuNZrGrAm
&lt;span class="o">[&lt;/span>node2&lt;span class="o">]&lt;/span>$ ../../target/debug/blockchain_rust createwallet
Your new address: 1JvjDQGrmzVLLAo9dPsXYNNednuNZrGrAm
&lt;span class="o">[&lt;/span>node2&lt;span class="o">]&lt;/span>$ ../../target/debug/blockchain_rust createwallet
Your new address: 1FztXwduMcABm6x2yxRWgozqT8g1dgeiFS
&lt;span class="c1">## è½¬è´¦&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>&lt;/li>
&lt;/ol></description></item><item><title>IPFS(æ˜Ÿé™…æ–‡ä»¶ç³»ç»Ÿ)</title><link>https://justice.bj.cn/post/60.blockchain/ipfs%E5%9F%BA%E7%A1%80/</link><pubDate>Sun, 12 Jun 2022 20:44:24 +0800</pubDate><guid>https://justice.bj.cn/post/60.blockchain/ipfs%E5%9F%BA%E7%A1%80/</guid><description>&lt;h1 id="ipfsæ˜Ÿé™…æ–‡ä»¶ç³»ç»Ÿ">IPFS(æ˜Ÿé™…æ–‡ä»¶ç³»ç»Ÿ)&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;code>IPFS&lt;/code>(InterPlanetary File Systemï¼Œæ˜Ÿé™…æ–‡ä»¶ç³»ç»Ÿ), æ˜¯ä¸€ä¸ªå¯¹ç­‰çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨å’Œè®¿é—®æ–‡ä»¶ã€ç½‘ç«™ã€åº”ç”¨ç¨‹åºå’Œæ•°æ®ã€‚IPFS æ—¨åœ¨ä¸ºåˆ†å¸ƒå¼ Webâ€”â€”DWeb æä¾›åŠ¨åŠ›ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>IPFSé¡¹ç›®é€šè¿‡æ•´åˆå·²æœ‰çš„æŠ€æœ¯ï¼ˆBitTorrentã€DHTã€Gitå’ŒSFSï¼‰ï¼Œåˆ›å»ºä¸€ç§ç‚¹å¯¹ç‚¹è¶…åª’ä½“åè®®ï¼Œè¯•å›¾æ‰“é€ ä¸€ä¸ªæ›´åŠ å¿«é€Ÿã€å®‰å…¨ã€å¼€æ”¾çš„ä¸‹ä¸€ä»£äº’è”ç½‘ï¼Œå®ç°äº’è”ç½‘ä¸­æ°¸ä¹…å¯ç”¨ã€æ•°æ®å¯ä»¥æ°¸ä¹…ä¿å­˜çš„å…¨çƒæ–‡ä»¶å­˜å‚¨ç³»ç»Ÿã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åŒæ—¶ï¼Œè¯¥åè®®æœ‰å†…å®¹å¯»å€ã€ç‰ˆæœ¬åŒ–ç‰¹æ€§ï¼Œå°è¯•è¡¥å……ç”šè‡³æœ€ç»ˆå–ä»£ä¼´éšäº†æˆ‘ä»¬20å¤šå¹´çš„è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆå³HTTPåè®®ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>IPFSæ˜¯ä¸€ä¸ªåè®®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªP2Pç½‘ç»œï¼Œå®ƒç±»ä¼¼äºç°åœ¨çš„BTç½‘ç»œï¼Œåªæ˜¯æ‹¥æœ‰æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½¿å¾—IPFSæ‹¥æœ‰å¯ä»¥å–ä»£HTTPçš„æ½œåŠ›ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯é˜²æ­¢&lt;a href="https://zh.m.wikipedia.org/wiki/DDoS" title="DDoS">DDoS&lt;/a>æ”»å‡»ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>IPFSå…ˆå°†æ–‡ä»¶åˆ†æˆä¸€ä¸ªä¸ªblockï¼Œæ¯ä¸ªblocké€šè¿‡hashå¾—åˆ°blockidï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰blockidç»„æˆä¸€ä¸ª&lt;code>merkledag&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸åŒblocké€šè¿‡&lt;code>KADç®—æ³•&lt;/code>åˆ†å‘åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸ºä¿è¯å¯é æ€§ï¼ŒåŒä¸€ä¸ªblock å¯èƒ½æœ‰å¤šä¸ªcopy, åˆ†åˆ«å­˜å‚¨åœ¨ä¸åŒçš„ç½‘ç»œèŠ‚ç‚¹ä¸Šï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="filecoin">Filecoin&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Filecoinæ˜¯è¿è¡Œåœ¨IPFSä¸Šçš„ä¸€ä¸ªæ¿€åŠ±å±‚ï¼Œæ˜¯ä¸€ä¸ªåŸºäºåŒºå—é“¾çš„åˆ†å¸ƒå¼å­˜å‚¨ç½‘ç»œï¼Œå®ƒæŠŠäº‘å­˜å‚¨å˜ä¸ºä¸€ä¸ªç®—æ³•å¸‚åœºï¼Œä»£å¸ï¼ˆFILï¼‰åœ¨è¿™é‡Œèµ·åˆ°äº†å¾ˆé‡è¦çš„ä½œç”¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»£å¸æ˜¯æ²Ÿé€šèµ„æºï¼ˆå­˜å‚¨å’Œæ£€ç´¢ï¼‰ä½¿ç”¨è€…ï¼ˆIPFSç”¨æˆ·ï¼‰å’Œèµ„æºçš„æä¾›è€…ï¼ˆFilecoinçŸ¿å·¥ï¼‰ä¹‹é—´çš„ä¸­ä»‹æ¡¥æ¢ï¼Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Filecoinåè®®æ‹¥æœ‰ä¸¤ä¸ªäº¤æ˜“å¸‚åœºâ€”æ•°æ®æ£€ç´¢å’Œæ•°æ®å­˜å‚¨ï¼Œäº¤æ˜“åŒæ–¹åœ¨å¸‚åœºé‡Œé¢æäº¤è‡ªå·±çš„éœ€æ±‚ï¼Œè¾¾æˆäº¤æ˜“ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="get">Get&lt;/h2>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/06/12-18-52-38-ipfs_get.gif" alt="loading-ag-185">&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="https://zh.m.wikipedia.org/zh-hans/%E6%98%9F%E9%99%85%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">æ˜Ÿé™…æ–‡ä»¶ç³»ç»Ÿ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://developer.aliyun.com/article/726565">https://developer.aliyun.com/article/726565&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.jianshu.com/p/3f7cc1ee9ec4">IPFSåŸç†åˆæ¢ - ç®€ä¹¦&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.pseudoyu.com/zh/2021/03/25/blockchain_ipfs_structure/">IPFS åˆ†å¸ƒå¼å­˜å‚¨åè®®åˆ†æä¸æ€è€ƒ Â· Pseudoyu&lt;/a>&lt;/p>
&lt;/li>
&lt;li>&lt;/li>
&lt;/ol></description></item><item><title>Kademliaç®—æ³•</title><link>https://justice.bj.cn/post/13.algorithm/kademlia%E7%AE%97%E6%B3%95/</link><pubDate>Sun, 12 Jun 2022 20:44:24 +0800</pubDate><guid>https://justice.bj.cn/post/13.algorithm/kademlia%E7%AE%97%E6%B3%95/</guid><description>&lt;h1 id="kademliaç®—æ³•">Kademliaç®—æ³•&lt;/h1>
&lt;hr>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Kademliaç®—æ³•æ˜¯2002å¹´ç”±Petar Maymounkov å’Œ David MaziÃ¨res æ‰€è®¾è®¡ï¼Œä»¥å¼‚æˆ–è·ç¦»æ¥å¯¹å“ˆå¸Œè¡¨è¿›è¡Œåˆ†å±‚æ˜¯å…¶ç‰¹ç‚¹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Kademliaåæ¥è¢«eMuleã€BitTorrentç­‰P2Pè½¯ä»¶é‡‡ç”¨ä½œä¸ºåº•å±‚ç®—æ³•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Kademliaå¯ä»¥ä½œä¸ºä¿¡æ¯å®‰å…¨æŠ€æœ¯çš„å¥ åŸºä¹‹ä¸€ã€‚&lt;br>
Kademliaçš„ä¼˜ç‚¹åœ¨äºï¼š&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>å¯¹äºä»»æ„ä¸€ä¸ªæœ‰[ 2(nâˆ’1)Â ,2ğ‘›)ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œï¼Œæœ€å¤šåªéœ€è¦næ­¥æœç´¢å³å¯æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼›&lt;/li>
&lt;li>K-bucketçš„æ›´æ–°æœºåˆ¶ä¸€å®šç¨‹åº¦ä¸Šä¿æŒäº†ç½‘ç»œçš„æ´»æ€§å’Œå®‰å…¨æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;p>Kademliaç®—æ³•æ˜¯ä¸€ç§åˆ†å¸ƒå¼å­˜å‚¨åŠè·¯ç”±çš„ç®—æ³•ã€‚&lt;/p>
&lt;p>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼å­˜å‚¨ï¼Ÿè¯•æƒ³ä¸€ä¸‹ï¼Œä¸€æ‰€1000äººçš„å­¦æ ¡ï¼Œç°åœ¨å­¦æ ¡çªç„¶å†³å®šæ‹†æ‰å›¾ä¹¦é¦†ï¼ˆä¸è®¾ç«‹ä¸­å¿ƒåŒ–çš„æœåŠ¡å™¨ï¼‰ï¼Œå°†å›¾ä¹¦é¦†é‡Œæ‰€æœ‰çš„ä¹¦éƒ½åˆ†å‘åˆ°æ¯ä½å­¦ç”Ÿæ‰‹ä¸Šï¼ˆæ‰€æœ‰çš„æ–‡ä»¶åˆ†æ•£å­˜å‚¨åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šï¼‰ã€‚å³æ˜¯æ‰€æœ‰çš„å­¦ç”Ÿï¼Œå…±åŒç»„æˆäº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„å›¾ä¹¦é¦†ã€‚&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-795f3af7231108b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800/format/webp" alt="">&lt;/p>
&lt;p>ç”±ä¸­å¿ƒå›¾ä¹¦é¦†åˆ°åˆ†å¸ƒå¼å›¾ä¹¦é¦†&lt;/p>
&lt;p>åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæœ‰å‡ ä¸ªå…³é”®çš„é—®é¢˜éœ€è¦å›ç­”ã€‚&lt;/p>
&lt;h3 id="1å…³é”®é—®é¢˜">1ï¼‰å…³é”®é—®é¢˜&lt;/h3>
&lt;ol>
&lt;li>æ¯ä¸ªåŒå­¦æ‰‹ä¸Šéƒ½åˆ†é…å“ªäº›ä¹¦ã€‚å³å¦‚ä½•åˆ†é…å­˜å‚¨å†…å®¹åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œæ–°å¢/åˆ é™¤å†…å®¹å¦‚ä½•å¤„ç†ã€‚&lt;/li>
&lt;li>å½“ä½ éœ€è¦æ‰¾åˆ°ä¸€æœ¬ä¹¦ï¼Œè­¬å¦‚ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹çš„æ—¶å€™ï¼Œå¦‚ä½•çŸ¥é“å“ªä½åŒå­¦æ‰‹ä¸Šæœ‰ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹ï¼ˆå¯¹1000ä¸ªäººæŒ¨ä¸ªé—®ä¸€éï¼Œâ€œä½ æœ‰æ²¡æœ‰ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹ï¼Ÿâ€ï¼Œæ˜¾ç„¶æ˜¯ä¸ªä¸ç»æµçš„åšæ³•ï¼‰ï¼Œåˆå¦‚ä½•è”ç³»ä¸Šè¿™ä½åŒå­¦ã€‚å³ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœæƒ³è·å–æŸä¸ªç‰¹å®šçš„æ–‡ä»¶ï¼Œå¦‚ä½•æ‰¾åˆ°å­˜å‚¨æ–‡ä»¶çš„èŠ‚ç‚¹/åœ°å€/è·¯å¾„ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-8b12f9959fa3144f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/358/format/webp" alt="">&lt;/p>
&lt;p>å¦‚ä½•å¯»æ‰¾éœ€è¦çš„ä¹¦ç±ï¼Ÿ&lt;/p>
&lt;p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹Kademliaç®—æ³•å¦‚ä½•å·§å¦™åœ°è§£å†³è¿™äº›é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="2èŠ‚ç‚¹çš„è¦ç´ ">2ï¼‰èŠ‚ç‚¹çš„è¦ç´ &lt;/h3>
&lt;p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªåŒå­¦ï¼ˆèŠ‚ç‚¹ï¼‰éƒ½æœ‰å“ªäº›å±æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>å­¦å·ï¼ˆNode IDï¼Œ2è¿›åˆ¶ï¼Œ160ä½ï¼‰&lt;/li>
&lt;li>æ‰‹æœºå·ç ï¼ˆèŠ‚ç‚¹çš„IPåœ°å€åŠç«¯å£ï¼‰&lt;/li>
&lt;/ul>
&lt;p>æ¯ä¸ªåŒå­¦ä¼šç»´æŠ¤ä»¥ä¸‹å†…å®¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»å›¾ä¹¦é¦†åˆ†å‘ä¸‹æ¥çš„ä¹¦æœ¬ï¼ˆè¢«åˆ†é…åˆ°éœ€è¦å­˜å‚¨çš„å†…å®¹ï¼‰ï¼Œæ¯æœ¬ä¹¦å½“ç„¶éƒ½æœ‰ä¹¦åå’Œä¹¦æœ¬å†…å®¹ï¼ˆå†…å®¹ä»¥&amp;lt;key, value&amp;gt;å¯¹çš„å½¢å¼å­˜å‚¨ï¼Œå¯ä»¥ç†è§£ä¸ºæ–‡ä»¶åå’Œæ–‡ä»¶å†…å®¹ï¼‰ï¼›&lt;/li>
&lt;li>ä¸€ä¸ªé€šè®¯å½•ï¼ŒåŒ…å«ä¸€å°éƒ¨åˆ†å…¶ä»–åŒå­¦çš„å­¦å·å’Œæ‰‹æœºå·ï¼Œé€šè®¯å½•æŒ‰å­¦å·åˆ†å±‚ï¼ˆä¸€ä¸ªè·¯ç”±è¡¨ï¼Œç§°ä¸ºâ€œk-bucketâ€ï¼ŒæŒ‰Node IDåˆ†å±‚ï¼Œè®°å½•æœ‰é™ä¸ªæ•°çš„å…¶ä»–èŠ‚ç‚¹çš„IDå’ŒIPåœ°å€åŠç«¯å£ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®ä¸Šé¢é‚£ä¸ªç±»æ¯”ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ªè¡¨æ ¼ï¼š&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-ac0338100a380c61.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/601/format/webp" alt="">&lt;/p>
&lt;p>æ¦‚å¿µå¯¹æ¯”&lt;/p>
&lt;p>&lt;em>ï¼ˆHashçš„æ¦‚å¿µè§£é‡Šï¼Œå¯å‚è§&lt;a href="https://links.jianshu.com/go?to=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%25E5%2593%2588%25E5%25B8%258C%25E7%25AE%2597%25E6%25B3%2595%2F4960188">ç™¾åº¦ç™¾ç§‘-å“ˆå¸Œç®—æ³•&lt;/a>ï¼‰&lt;/em>&lt;/p>
&lt;p>&lt;em>å…³äºä¸ºä»€ä¹ˆä¸æ˜¯æ¯ä¸ªåŒå­¦éƒ½æœ‰å…¨é‡é€šè®¯å½•ï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½ç»´æŠ¤å…¨é‡è·¯ç”±ä¿¡æ¯ï¼‰ï¼šå…¶ä¸€ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­èŠ‚ç‚¹çš„è¿›å…¥å’Œé€€å‡ºæ˜¯ç›¸å½“é¢‘ç¹çš„ï¼Œæ¯æ¬¡æœ‰å˜åŠ¨æ—¶éƒ½å…¨ç½‘å¹¿æ’­é€šè®¯å½•æ›´æ–°ï¼Œé€šè®¯é‡ä¼šå¾ˆå¤§ï¼›å…¶äºŒï¼Œä¸€æ—¦ä»»æ„ä¸€ä¸ªåŒå­¦è¢«åäººç»‘æ¶äº†ï¼ˆèŠ‚ç‚¹è¢«é»‘å®¢æ”»ç ´ï¼‰ï¼Œåˆ™åäººé©¬ä¸Šå°±æ‹¥æœ‰äº†æ‰€æœ‰äººçš„æ‰‹æœºå·ç ï¼Œè¿™å¹¶ä¸å®‰å…¨ã€‚&lt;/em>&lt;/p>
&lt;h3 id="3æ–‡ä»¶çš„å­˜å‚¨åŠæŸ¥æ‰¾">3ï¼‰æ–‡ä»¶çš„å­˜å‚¨åŠæŸ¥æ‰¾&lt;/h3>
&lt;p>åŸæ¥æ”¶è—åœ¨å›¾ä¹¦é¦†é‡Œï¼ŒæŒ‰ç´¢å¼•å·ç å¾—æ•´æ•´é½é½çš„ä¹¦ï¼Œä»¥ä¸€ç§ä»€ä¹ˆæ ·çš„æ–¹å¼åˆ†å‘åˆ°åŒå­¦ä»¬æ‰‹é‡Œå‘¢ï¼Ÿ&lt;/p>
&lt;p>å¤§è‡´çš„åŸåˆ™ï¼ŒåŒ…æ‹¬ï¼š&lt;/p>
&lt;p>Â Â Â Â 1ï¼‰ä¹¦æœ¬èƒ½å¤Ÿæ¯”è¾ƒå‡è¡¡åœ°åˆ†å¸ƒåœ¨åŒå­¦ä»¬çš„æ‰‹é‡Œï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†åŒå­¦æ‰‹é‡Œä¹¦ç‰¹åˆ«å¤šã€è€Œå¤§éƒ¨åˆ†åŒå­¦è¿ä¸€æœ¬ä¹¦éƒ½æ²¡æœ‰çš„æƒ…å†µï¼›&lt;/p>
&lt;p>Â Â Â Â 2ï¼‰åŒå­¦æƒ³æ‰¾ä¸€æœ¬ç‰¹å®šçš„ä¹¦çš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¸€ç§ç›¸å¯¹ç®€å•çš„ç´¢å¼•æ–¹å¼æ‰¾åˆ°è¿™æœ¬ä¹¦ã€‚&lt;br>
Kademliaä½œäº†ä¸‹é¢è¿™ç§å®‰æ’ï¼š&lt;br>
å‡è®¾ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹è¿™æœ¬ä¹¦çš„ä¹¦åçš„hashå€¼æ˜¯Â &lt;em>00010000&lt;/em>ï¼Œé‚£ä¹ˆè¿™æœ¬ä¹¦å°±ä¼šè¢«è¦æ±‚å­˜åœ¨å­¦å·ä¸º&lt;em>00010000&lt;/em>çš„åŒå­¦æ‰‹ä¸Šã€‚ï¼ˆè¿™è¦æ±‚hashç®—æ³•çš„å€¼åŸŸä¸node IDçš„å€¼åŸŸä¸€è‡´ã€‚Kademliaçš„Node IDæ˜¯160ä½2è¿›åˆ¶ã€‚è¿™é‡Œçš„ç¤ºä¾‹å¯¹Node IDè¿›è¡Œäº†ç®€ç•¥ï¼‰&lt;br>
ä½†è¿˜å¾—è€ƒè™‘åˆ°ä¼šæœ‰åŒå­¦ç¼ºå‹¤ã€‚ä¸‡ä¸€&lt;em>00010000&lt;/em>ä»Šå¤©æ²¡æ¥ä¸Šå­¦ï¼ˆèŠ‚ç‚¹æ²¡æœ‰ä¸Šçº¿æˆ–å½»åº•é€€å‡ºç½‘ç»œï¼‰ï¼Œé‚£ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹è¿™æœ¬ä¹¦å²‚ä¸æ˜¯è°éƒ½æ‹¿ä¸åˆ°äº†ï¼Ÿé‚£ç®—æ³•è¦æ±‚è¿™æœ¬ä¹¦ä¸èƒ½åªå­˜åœ¨ä¸€ä¸ªåŒå­¦æ‰‹ä¸Šï¼Œè€Œæ˜¯è¢«è¦æ±‚åŒæ—¶å­˜å‚¨åœ¨å­¦å·æœ€æ¥è¿‘&lt;em>00010000&lt;/em>çš„kä½åŒå­¦æ‰‹ä¸Šï¼Œå³&lt;em>00010001&lt;/em>ã€&lt;em>00010010&lt;/em>ã€&lt;em>00010011&lt;/em>â€¦ç­‰åŒå­¦æ‰‹ä¸Šéƒ½ä¼šæœ‰è¿™æœ¬ä¹¦ã€‚&lt;/p>
&lt;p>åŒæ ·åœ°ï¼Œå½“ä½ éœ€è¦æ‰¾ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹è¿™æœ¬ä¹¦æ—¶ï¼Œå°†ä¹¦åhashä¸€ä¸‹ï¼Œå¾—åˆ°Â &lt;em>00010000&lt;/em>ï¼Œè¿™ä¸ªä¾¿æ˜¯ç´¢ä¹¦å·ï¼Œä½ å°±çŸ¥é“è¯¥æ‰¾å“ªï¼ˆå‡ ï¼‰ä½åŒå­¦äº†ã€‚å‰©ä¸‹çš„é—®é¢˜ï¼Œå°±æ˜¯æ‰¾åˆ°è¿™ï¼ˆå‡ ï¼‰ä½åŒå­¦çš„æ‰‹æœºå·ã€‚&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-54dfcb165392638e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/628/format/webp" alt="">&lt;/p>
&lt;p>ä¹¦ç±æœç´¢å®šä½&lt;/p>
&lt;h3 id="4èŠ‚ç‚¹çš„å¼‚æˆ–è·ç¦»">4ï¼‰èŠ‚ç‚¹çš„å¼‚æˆ–è·ç¦»&lt;/h3>
&lt;p>ç”±äºä½ æ‰‹ä¸Šåªæœ‰ä¸€éƒ¨åˆ†åŒå­¦çš„é€šè®¯å½•ï¼Œä½ å¾ˆå¯èƒ½å¹¶æ²¡æœ‰&lt;em>00010000&lt;/em>çš„æ‰‹æœºå·ï¼ˆIPåœ°å€ï¼‰ã€‚é‚£å¦‚ä½•è”ç³»ä¸Šç›®æ ‡åŒå­¦å‘¢ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-41d8839bc652fea1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/338/format/webp" alt="">&lt;/p>
&lt;p>é€šè®¯å½•ä¸Šå¹¶æ²¡æœ‰ç›®æ ‡åŒå­¦çš„æƒ…å†µ&lt;/p>
&lt;p>ä¸€ä¸ªå¯è¡Œçš„æ€è·¯å°±æ˜¯åœ¨ä½ çš„é€šè®¯å½•é‡Œæ‰¾åˆ°ä¸€ä½æ‹¥æœ‰ç›®æ ‡åŒå­¦çš„è”ç³»æ–¹å¼çš„åŒå­¦ã€‚å‰é¢æåˆ°ï¼Œæ¯ä½åŒå­¦æ‰‹ä¸Šçš„é€šè®¯å½•éƒ½æ˜¯æŒ‰è·ç¦»åˆ†å±‚çš„ã€‚ç®—æ³•çš„è®¾è®¡æ˜¯ï¼Œå¦‚æœä¸€ä¸ªåŒå­¦ç¦»ä½ è¶Šè¿‘ï¼Œä½ æ‰‹ä¸Šçš„é€šè®¯å½•é‡Œå­˜æœ‰taçš„æ‰‹æœºå·ç çš„æ¦‚ç‡è¶Šå¤§ã€‚è€Œç®—æ³•çš„æ ¸å¿ƒçš„æ€è·¯å°±å¯ä»¥æ˜¯ï¼šå½“ä½ çŸ¥é“ç›®æ ‡åŒå­¦Zä¸ä½ ä¹‹é—´çš„è·ç¦»ï¼Œä½ å¯ä»¥åœ¨ä½ çš„é€šè®¯å½•ä¸Šå…ˆæ‰¾åˆ°ä¸€ä¸ªä½ è®¤ä¸ºä¸åŒå­¦Zæœ€ç›¸è¿‘çš„åŒå­¦Bï¼Œè¯·åŒå­¦Bå†è¿›ä¸€æ­¥å»æŸ¥æ‰¾åŒå­¦Zçš„æ‰‹æœºå·ã€‚&lt;/p>
&lt;p>ä¸Šæ–‡æåˆ°çš„è·ç¦»ï¼Œæ˜¯å­¦å·ï¼ˆNode IDï¼‰ä¹‹é—´çš„å¼‚æˆ–è·ç¦»(XOR distanceï¼‰ã€‚å¼‚æˆ–æ˜¯é’ˆå¯¹yes/noæˆ–è€…äºŒè¿›åˆ¶çš„è¿ç®—.&lt;/p>
&lt;blockquote>
&lt;p>å¼‚æˆ–çš„è¿ç®—æ³•åˆ™ä¸ºï¼š0âŠ•0=0ï¼Œ1âŠ•0=1ï¼Œ0âŠ•1=1ï¼Œ1âŠ•1=0ï¼ˆåŒä¸º0ï¼Œå¼‚ä¸º1ï¼‰&lt;br>
&lt;a href="https://links.jianshu.com/go?to=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%25E5%25BC%2582%25E6%2588%2596%2F10993677%3Ffr%3Daladdin">ç™¾åº¦ç™¾ç§‘-å¼‚æˆ–&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>ä¸¾2ä¸ªä¾‹å­ï¼š&lt;br>
&lt;em>01010000&lt;/em>ä¸&lt;em>01010010&lt;/em>è·ç¦»ï¼ˆå³æ˜¯2ä¸ªIDçš„å¼‚æˆ–å€¼ï¼‰ä¸º&lt;em>00000010&lt;/em>ï¼ˆæ¢ç®—ä¸ºåè¿›åˆ¶å³ä¸º2ï¼‰ï¼›&lt;br>
&lt;em>01000000&lt;/em>ä¸&lt;em>00000001&lt;/em>è·ç¦»ä¸º&lt;em>01000001&lt;/em>ï¼ˆæ¢ç®—ä¸ºåè¿›åˆ¶å³ä¸º26+1ï¼Œå³65ï¼‰ï¼›&lt;br>
å¦‚æ­¤ç±»æ¨ã€‚&lt;/p>
&lt;p>é‚£é€šè®¯å½•æ˜¯å¦‚ä½•æŒ‰è·ç¦»åˆ†å±‚å‘¢ï¼Ÿä¸‹é¢çš„ç¤ºä¾‹ä¼šå‘Šè¯‰ä½ ï¼ŒæŒ‰å¼‚æˆ–è·ç¦»åˆ†å±‚ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç†è§£ä¸ºæŒ‰ä½æ•°åˆ†å±‚ã€‚è®¾æƒ³ä»¥ä¸‹æƒ…æ™¯ï¼š&lt;br>
ä»¥&lt;em>0000110&lt;/em>ä¸ºåŸºç¡€èŠ‚ç‚¹ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„IDï¼Œå‰é¢æ‰€æœ‰ä½æ•°éƒ½ä¸å®ƒç›¸åŒï¼Œåªæœ‰æœ€å1ä½ä¸åŒï¼Œè¿™æ ·çš„èŠ‚ç‚¹åªæœ‰1ä¸ªâ€”â€”&lt;em>0000111&lt;/em>ï¼Œä¸åŸºç¡€èŠ‚ç‚¹çš„å¼‚æˆ–å€¼ä¸º&lt;em>0000001&lt;/em>ï¼Œå³è·ç¦»ä¸º1ï¼›å¯¹äº&lt;em>0000110&lt;/em>è€Œè¨€ï¼Œè¿™æ ·çš„èŠ‚ç‚¹å½’ä¸º**â€œk-bucket 1â€**ï¼›&lt;br>
å¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„IDï¼Œå‰é¢æ‰€æœ‰ä½æ•°ç›¸åŒï¼Œä»å€’æ•°ç¬¬2ä½å¼€å§‹ä¸åŒï¼Œè¿™æ ·çš„èŠ‚ç‚¹åªæœ‰2ä¸ªï¼š*0000101*ã€*0000100*ï¼Œä¸åŸºç¡€èŠ‚ç‚¹çš„å¼‚æˆ–å€¼ä¸º*0000011*å’Œ*0000010*ï¼Œå³è·ç¦»èŒƒå›´ä¸º3å’Œ2ï¼›å¯¹äº*0000110*è€Œè¨€ï¼Œè¿™æ ·çš„èŠ‚ç‚¹å½’ä¸º**â€œk-bucket 2â€**ï¼›&lt;br>
â€¦â€¦&lt;br>
å¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„IDï¼Œå‰é¢æ‰€æœ‰ä½æ•°ç›¸åŒï¼Œä»å€’æ•°ç¬¬nä½å¼€å§‹ä¸åŒï¼Œè¿™æ ·çš„èŠ‚ç‚¹åªæœ‰2(i-1)ä¸ªï¼Œä¸åŸºç¡€èŠ‚ç‚¹çš„è·ç¦»èŒƒå›´ä¸º[2(i-1), 2iï¼‰ï¼›å¯¹äº*0000110*è€Œè¨€ï¼Œè¿™æ ·çš„èŠ‚ç‚¹å½’ä¸º**â€œk-bucket iâ€**ï¼›&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-6bdd6e96a80d0780.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/430/format/webp" alt="">&lt;/p>
&lt;p>æŒ‰ä½æ•°åŒºåˆ†k-bucket&lt;/p>
&lt;p>å¯¹ä¸Šé¢æè¿°çš„å¦ä¸€ç§ç†è§£æ–¹å¼ï¼šå¦‚æœå°†æ•´ä¸ªç½‘ç»œçš„èŠ‚ç‚¹æ¢³ç†ä¸ºä¸€ä¸ªæŒ‰èŠ‚ç‚¹IDæ’åˆ—çš„äºŒå‰æ ‘ï¼Œæ ‘æœ€æœ«ç«¯çš„æ¯ä¸ªå¶å­ä¾¿æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¸‹å›¾å°±æ¯”è¾ƒç›´è§‚çš„å±•ç°å‡ºï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»çš„å…³ç³»ã€‚&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-c12846900b0525db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/913/format/webp" alt="">&lt;/p>
&lt;p>k-bucketç¤ºæ„å›¾ï¼šå³ä¸‹è§’çš„é»‘è‰²å®å¿ƒåœ†ï¼Œä¸ºåŸºç¡€èŠ‚ç‚¹ï¼ˆæŒ‰wikiç™¾ç§‘çš„é…å›¾ä¿®æ”¹ï¼‰&lt;/p>
&lt;p>å›åˆ°æˆ‘ä»¬çš„ç±»æ¯”ã€‚æ¯ä¸ªåŒå­¦åªç»´æŠ¤ä¸€éƒ¨åˆ†çš„é€šè®¯å½•ï¼Œè¿™ä¸ªé€šè®¯å½•æŒ‰ç…§è·ç¦»åˆ†å±‚ï¼ˆå¯ä»¥ç†è§£ä¸ºæŒ‰å­¦å·ä¸è‡ªå·±çš„å­¦å·ä»ç¬¬å‡ ä½å¼€å§‹ä¸åŒè€Œåˆ†å±‚ï¼‰ï¼Œå³k-bucket1, k-bucket 2, k-bucket 3â€¦è™½ç„¶æ¯ä¸ªk-bucketä¸­å®é™…å­˜åœ¨çš„åŒå­¦äººæ•°é€æ¸å¢å¤šï¼Œä½†æ¯ä¸ªåŒå­¦åœ¨å®ƒè‡ªå·±çš„æ¯ä¸ªk-bucketä¸­åªè®°å½•kä½åŒå­¦çš„æ‰‹æœºå·ï¼ˆkä¸ªèŠ‚ç‚¹çš„åœ°å€ä¸ç«¯å£ï¼Œè¿™é‡Œçš„kæ˜¯ä¸€ä¸ªå¯è°ƒèŠ‚çš„å¸¸é‡å‚æ•°ï¼‰ã€‚&lt;br>
ç”±äºå­¦å·ï¼ˆèŠ‚ç‚¹çš„IDï¼‰æœ‰160ä½ï¼Œæ‰€ä»¥æ¯ä¸ªåŒå­¦çš„é€šè®¯å½•ä¸­å…±åˆ†160å±‚ï¼ˆèŠ‚ç‚¹å…±æœ‰160ä¸ªk-bucketï¼‰ã€‚æ•´ä¸ªç½‘ç»œæœ€å¤šå¯ä»¥å®¹çº³2^160ä¸ªåŒå­¦ï¼ˆèŠ‚ç‚¹ï¼‰ï¼Œä½†æ˜¯æ¯ä¸ªåŒå­¦ï¼ˆèŠ‚ç‚¹ï¼‰æœ€å¤šåªç»´æŠ¤160 * k è¡Œé€šè®¯å½•ï¼ˆå…¶ä»–èŠ‚ç‚¹çš„åœ°å€ä¸ç«¯å£ï¼‰ã€‚&lt;/p>
&lt;h3 id="5èŠ‚ç‚¹å®šä½">5ï¼‰èŠ‚ç‚¹å®šä½&lt;/h3>
&lt;p>æˆ‘ä»¬ç°åœ¨æ¥é˜è¿°ä¸€ä¸ªå®Œæ•´çš„ç´¢ä¹¦æµç¨‹ã€‚&lt;/p>
&lt;p>AåŒå­¦ï¼ˆå­¦å·&lt;em>00000110&lt;/em>ï¼‰æƒ³æ‰¾ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹ï¼Œ&lt;/p>
&lt;p>Aé¦–å…ˆéœ€è¦è®¡ç®—ä¹¦åçš„å“ˆå¸Œå€¼ï¼Œhash(ã€Šåˆ†å¸ƒå¼ç®—æ³•ã€‹) =Â &lt;em>00010000&lt;/em>ã€‚é‚£ä¹ˆAå°±çŸ¥é“taéœ€è¦æ‰¾åˆ°&lt;em>00010000&lt;/em>å·åŒå­¦ï¼ˆå‘½åä¸ºZåŒå­¦ï¼‰æˆ–å­¦å·ä¸Zé‚»è¿‘çš„åŒå­¦ã€‚&lt;br>
Zçš„å­¦å·&lt;em>00010000&lt;/em>ä¸è‡ªå·±çš„å¼‚æˆ–è·ç¦»ä¸ºÂ &lt;em>00010110&lt;/em>ï¼Œè·ç¦»èŒƒå›´åœ¨[24, 25)ï¼Œæ‰€ä»¥è¿™ä¸ªZåŒå­¦å¯èƒ½åœ¨k-bucket 5ä¸­ï¼ˆæˆ–è€…è¯´ï¼ŒZåŒå­¦çš„å­¦å·ä¸AåŒå­¦çš„å­¦å·ä»ç¬¬5ä½å¼€å§‹ä¸åŒï¼Œæ‰€ä»¥ZåŒå­¦å¯èƒ½åœ¨k-bucket 5ä¸­ï¼‰ã€‚&lt;br>
ç„¶åAåŒå­¦çœ‹çœ‹è‡ªå·±çš„k-bucket 5æœ‰æ²¡æœ‰ZåŒå­¦ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœæœ‰ï¼Œé‚£å°±ç›´æ¥è”ç³»ZåŒå­¦è¦ä¹¦ï¼›&lt;/li>
&lt;li>å¦‚æœæ²¡æœ‰ï¼Œåœ¨k-bucket 5é‡Œéšä¾¿æ‰¾ä¸€ä¸ªBåŒå­¦ï¼ˆæ³¨æ„ä»»æ„BåŒå­¦ï¼Œå®ƒçš„å­¦å·ç¬¬5ä½è‚¯å®šä¸Zç›¸åŒï¼Œå³å®ƒä¸ZåŒå­¦çš„è·ç¦»ä¼šå°äº24ï¼Œç›¸å½“äºæ¯”Zã€Aä¹‹é—´çš„è·ç¦»ç¼©çŸ­äº†ä¸€åŠä»¥ä¸Šï¼‰ï¼Œè¯·æ±‚BåŒå­¦åœ¨å®ƒè‡ªå·±çš„é€šè®¯å½•é‡ŒæŒ‰åŒæ ·çš„æŸ¥æ‰¾æ–¹å¼æ‰¾ä¸€ä¸‹ZåŒå­¦ï¼š&lt;br>
&amp;ndash; å¦‚æœBçŸ¥é“ZåŒå­¦ï¼Œé‚£å°±æŠŠZåŒå­¦çš„æ‰‹æœºå·ï¼ˆIP Addressï¼‰å‘Šè¯‰Aï¼›&lt;br>
&amp;ndash; å¦‚æœBä¹Ÿä¸çŸ¥é“ZåŒå­¦ï¼Œé‚£BæŒ‰åŒæ ·çš„æœç´¢æ–¹æ³•ï¼Œå¯ä»¥åœ¨è‡ªå·±çš„é€šè®¯å½•é‡Œæ‰¾åˆ°ä¸€ä¸ªç¦»Zæ›´è¿‘çš„CåŒå­¦ï¼ˆZã€Cä¹‹é—´è·ç¦»å°äº23ï¼‰ï¼ŒæŠŠCåŒå­¦æ¨èç»™Aï¼›AåŒå­¦è¯·æ±‚CåŒå­¦è¿›è¡Œä¸‹ä¸€æ­¥æŸ¥æ‰¾ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-1396765e4e0afb12.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/866/format/webp" alt="">&lt;/p>
&lt;p>æŸ¥è¯¢æ–¹å¼ç¤ºæ„&lt;/p>
&lt;p>Kademliaçš„è¿™ç§æŸ¥è¯¢æœºåˆ¶ï¼Œæœ‰ç‚¹åƒæ˜¯å°†ä¸€å¼ çº¸ä¸æ–­åœ°å¯¹æŠ˜æ¥æ”¶ç¼©æœç´¢èŒƒå›´ï¼Œä¿è¯å¯¹äºä»»æ„nä¸ªå­¦ç”Ÿï¼Œæœ€å¤šåªéœ€è¦æŸ¥è¯¢log2(n)æ¬¡ï¼Œå³å¯æ‰¾åˆ°è·å¾—ç›®æ ‡åŒå­¦çš„è”ç³»æ–¹å¼ï¼ˆå³åœ¨å¯¹äºä»»æ„ä¸€ä¸ªæœ‰[2(nâˆ’1), 2n)ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œï¼Œæœ€å¤šåªéœ€è¦næ­¥æœç´¢å³å¯æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://upload-images.jianshu.io/upload_images/947209-1143169c8318a2ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/666/format/webp" alt="">&lt;/p>
&lt;p>æ¯æ¬¡æœç´¢éƒ½å°†è·ç¦»è‡³å°‘æ”¶ç¼©ä¸€åŠ&lt;/p>
&lt;p>ä»¥ä¸Šä¾¿æ˜¯Kademliaç®—æ³•çš„åŸºæœ¬åŸç†ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹å†ç®€è¦ä»‹ç»åè®®ä¸­çš„æŠ€æœ¯ç»†èŠ‚ã€‚&lt;/p>
&lt;h3 id="6ç®—æ³•çš„ä¸‰ä¸ªå‚æ•°keyspacekå’ŒÎ±">6ï¼‰ç®—æ³•çš„ä¸‰ä¸ªå‚æ•°ï¼škeyspaceï¼Œkå’ŒÎ±&lt;/h3>
&lt;ul>
&lt;li>keyspace&lt;br>
&amp;ndash; å³IDæœ‰å¤šå°‘ä½&lt;br>
&amp;ndash; å†³å®šæ¯ä¸ªèŠ‚ç‚¹çš„é€šè®¯å½•æœ‰å‡ å±‚&lt;/li>
&lt;li>k&lt;br>
&amp;ndash; æ¯ä¸ªä¸€å±‚k-bucketé‡Œè£…kä¸ªnodeçš„ä¿¡æ¯ï¼Œå³&amp;lt;node ID, IP Adress, port&amp;gt;&lt;br>
&amp;ndash; æ¯æ¬¡æŸ¥æ‰¾nodeæ—¶ï¼Œè¿”å›kä¸ªnodeçš„ä¿¡æ¯&lt;br>
&amp;ndash; å¯¹äºæŸä¸ªç‰¹å®šçš„dataï¼Œç¦»å…¶keyæœ€è¿‘çš„kä¸ªèŠ‚ç‚¹è¢«ä¼šè¦æ±‚å­˜å‚¨è¿™ä¸ªdata&lt;/li>
&lt;li>Î±&lt;br>
&amp;ndash; æ¯æ¬¡å‘å…¶ä»–nodeè¯·æ±‚æŸ¥æ‰¾æŸä¸ªnodeæ—¶ï¼Œä¼šå‘Î±ä¸ªnodeå‘å‡ºè¯·æ±‚&lt;/li>
&lt;/ul>
&lt;h3 id="7èŠ‚ç‚¹çš„æŒ‡ä»¤">7ï¼‰èŠ‚ç‚¹çš„æŒ‡ä»¤&lt;/h3>
&lt;p>Kademliaç®—æ³•ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªæœ‰4ä¸ªæŒ‡ä»¤&lt;/p>
&lt;ul>
&lt;li>PING&lt;br>
&amp;ndash; æµ‹è¯•ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦åœ¨çº¿&lt;/li>
&lt;li>STORE&lt;br>
&amp;ndash; è¦æ±‚ä¸€ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸€ä»½æ•°æ®&lt;/li>
&lt;li>FIND_NODE&lt;br>
&amp;ndash; æ ¹æ®èŠ‚ç‚¹IDæŸ¥æ‰¾ä¸€ä¸ªèŠ‚ç‚¹&lt;/li>
&lt;li>FIND_VALUE&lt;br>
&amp;ndash; æ ¹æ®KEYæŸ¥æ‰¾ä¸€ä¸ªæ•°æ®ï¼Œå®åˆ™ä¸Šè·ŸFIND_NODEéå¸¸ç±»ä¼¼&lt;/li>
&lt;/ul>
&lt;h3 id="8k-bucketçš„ç»´æŠ¤åŠæ›´æ–°æœºåˆ¶">8)k-bucketçš„ç»´æŠ¤åŠæ›´æ–°æœºåˆ¶&lt;/h3>
&lt;ul>
&lt;li>æ¯ä¸ªbucketé‡Œçš„èŠ‚ç‚¹éƒ½æŒ‰æœ€åä¸€æ¬¡æ¥è§¦çš„æ—¶é—´å€’åºæ’åˆ—&lt;/li>
&lt;li>æ¯æ¬¡æ‰§è¡Œå››ä¸ªæŒ‡ä»¤ä¸­çš„ä»»æ„ä¸€ä¸ªéƒ½ä¼šè§¦å‘æ›´æ–°&lt;/li>
&lt;li>å½“ä¸€ä¸ªèŠ‚ç‚¹ä¸è‡ªå·±æ¥è§¦æ—¶ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦åœ¨K-bucketä¸­&lt;br>
&amp;ndash; å¦‚æœåœ¨ï¼Œé‚£ä¹ˆå°†å®ƒæŒªåˆ°k-bucketåˆ—è¡¨çš„æœ€åº•ï¼ˆæœ€æ–°ï¼‰&lt;br>
&amp;ndash; å¦‚æœä¸åœ¨ï¼ŒPINGä¸€ä¸‹åˆ—è¡¨æœ€ä¸Šé¢ï¼ˆæœ€æ—§ï¼‰çš„ä¸€ä¸ªèŠ‚ç‚¹&lt;br>
&amp;ndash; a) å¦‚æœPINGé€šäº†ï¼Œå°†æ—§èŠ‚ç‚¹æŒªåˆ°åˆ—è¡¨æœ€åº•ï¼Œå¹¶ä¸¢å¼ƒæ–°èŠ‚ç‚¹&lt;br>
&amp;ndash; b) å¦‚æœPINGä¸é€šï¼Œåˆ é™¤æ—§èŠ‚ç‚¹ï¼Œå¹¶å°†æ–°èŠ‚ç‚¹åŠ å…¥åˆ—è¡¨&lt;/li>
&lt;/ul>
&lt;p>è¯¥æœºåˆ¶ä¿è¯äº†ä»»æ„èŠ‚ç‚¹åŠ å…¥å’Œç¦»å¼€éƒ½ä¸å½±å“æ•´ä½“ç½‘ç»œã€‚&lt;/p>
&lt;h3 id="9æ€»ç»“">9ï¼‰æ€»ç»“&lt;/h3>
&lt;p>Kademliaæ˜¯åˆ†å¸ƒå¼å“ˆå¸Œè¡¨ï¼ˆDistributed Hash Table, DHTï¼‰çš„ä¸€ç§ã€‚è€ŒDHTæ˜¯ä¸€ç±»å»ä¸­å¿ƒåŒ–çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚&lt;/p>
&lt;p>åœ¨è¿™ç±»ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰åˆ†åˆ«ç»´æŠ¤ä¸€éƒ¨åˆ†çš„å­˜å‚¨å†…å®¹ä»¥åŠå…¶ä»–èŠ‚ç‚¹çš„è·¯ç”±/åœ°å€ï¼Œä½¿å¾—ç½‘ç»œä¸­ä»»ä½•å‚ä¸è€…ï¼ˆå³èŠ‚ç‚¹ï¼‰å‘ç”Ÿå˜æ›´ï¼ˆè¿›å…¥/é€€å‡ºï¼‰æ—¶ï¼Œå¯¹æ•´ä¸ªç½‘ç»œé€ æˆçš„å½±å“æœ€å°ã€‚&lt;/p>
&lt;p>DHTå¯ä»¥ç”¨äºæ„å»ºæ›´å¤æ‚çš„åº”ç”¨ï¼ŒåŒ…æ‹¬åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€ç‚¹å¯¹ç‚¹æŠ€æœ¯æ–‡ä»¶åˆ†äº«ç³»ç»Ÿã€åˆä½œçš„ç½‘é¡µé«˜é€Ÿç¼“å­˜ã€åŸŸåç³»ç»Ÿä»¥åŠå®æ—¶é€šä¿¡ç­‰ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://links.jianshu.com/go?to=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FDistributed_hash_table">wikiç™¾ç§‘-åˆ†å¸ƒå¼å“ˆå¸Œè¡¨&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://links.jianshu.com/go?to=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FKademlia">wikiç™¾ç§‘-Kademlia&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://links.jianshu.com/go?to=http%3A%2F%2Fpdos.csail.mit.edu%2F%7Epetar%2Fpapers%2Fmaymounkov-kademlia-lncs.pdf">Kademlia: A Peer-to-peer information system based on the XOR Metric&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://links.jianshu.com/go?to=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000000351815">ç‹å­äº­çš„Kademliaç¬”è®°&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Rustæ¨¡å—åŠåŒ…ç®¡ç†</title><link>https://justice.bj.cn/post/14.language/rust/80.rust%E5%8C%85%E7%AE%A1%E7%90%86/</link><pubDate>Sun, 12 Jun 2022 20:44:24 +0800</pubDate><guid>https://justice.bj.cn/post/14.language/rust/80.rust%E5%8C%85%E7%AE%A1%E7%90%86/</guid><description>&lt;h1 id="rustæ¨¡å—åŠåŒ…ç®¡ç†">Rustæ¨¡å—åŠåŒ…ç®¡ç†&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;p>Rustç¨‹åºä»£ç ç»„ç»‡åˆ†ä¸ºä¸¤ä¸ªå±‚çº§ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>åŒ…(crate)&lt;/strong>ï¼šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç¼–è¯‘å•å…ƒï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ¨¡å—(mod)&lt;/strong>ï¼šæ˜¯åŒ…å†…ä»£ç ç»„ç»‡å•å…ƒï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="åŒ…crate">åŒ…(Crate)&lt;/h2>
&lt;p>åŒ…(&lt;code>crate&lt;/code>)æ˜¯rustå¯ç‹¬ç«‹ç¼–è¯‘çš„å•å…ƒï¼ŒåŒ…è¦ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>åŒ…&lt;code>crate&lt;/code>Â ç”±ä¸€ä¸ªæˆ–ä¸€æ‰¹æ–‡ä»¶ç»„æˆï¼Œå¯ç‹¬ç«‹ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åŒ…æœ‰ä¸¤ç§ç±»å‹ï¼šåº“(lib)å’Œå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶(bin)ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åŒä¸€ä¸ªåŒ…çš„æ–‡ä»¶ä¸€èˆ¬æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¯ä¸ªåŒ…æœ‰ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>äºŒè¿›åˆ¶åŒ…å…¥å£ä¸º&lt;code>main.rs&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åº“çš„å…¥å£æ–‡ä»¶æ˜¯&lt;code>lib.rs&lt;/code>;&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>åŒ…ç”±&lt;code>Cargo.toml&lt;/code>ç®¡ç†ç»„ç»‡ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¼•å…¥å¤–éƒ¨crateï¼š&lt;code>extern crate xxx;&lt;/code>;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¼•ç”¨æœªå‘å¸ƒçš„æœ¬åœ°crate, åœ¨&lt;code>Cargo.toml&lt;/code> &lt;code>dependencies&lt;/code>ä¸­å£°æ˜ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">&lt;span class="p">[&lt;/span>&lt;span class="nx">package&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;crate-name&amp;#34;&lt;/span>
&lt;span class="nx">version&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;0.1.0&amp;#34;&lt;/span>
&lt;span class="nx">authors&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;xxx&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">edition&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;2018&amp;#34;&lt;/span>
&lt;span class="p">[&lt;/span>&lt;span class="nx">dependencies&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c">#xxx&lt;/span>
&lt;span class="p">[&lt;/span>&lt;span class="nx">features&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c">#default = [&amp;#34;test&amp;#34;]&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ¨¡å—module">æ¨¡å—ï¼ˆmoduleï¼‰&lt;/h2>
&lt;p>æ¨¡å—(&lt;code>mod&lt;/code>)æ˜¯åŒ…å†…éƒ¨ä»£ç ç»„ç»‡å•å…ƒï¼Œæ¨¡å—è¦ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ¨¡å—ç”±å…³é”®å­—&lt;code>mod&lt;/code>å®šä¹‰ï¼š&lt;code>mod XXX { ... } &lt;/code>;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨¡å—çš„å‘½åé£æ ¼æ˜¯ &lt;code>lower_snake_case&lt;/code>ï¼Œè·Ÿå…¶å®ƒçš„ Rust çš„æ ‡è¯†ç¬¦ä¸€æ ·ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨¡å—å¯ä»¥åµŒå¥—ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨¡å—ä¸­å¯ä»¥å†™ä»»ä½•åˆæ³•çš„ Rust ä»£ç ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¯ä¸ªåŒ…é»˜è®¤å®ç°äº†ä¸€ä¸ªéšå¼çš„Â &lt;code>æ ¹æ¨¡å—ï¼ˆroot moduleï¼‰&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç‹¬ç«‹çš„ä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªmod, modåå°±æ˜¯æ–‡ä»¶åï¼Œmain.rs, lib.rs, mod.rsæ–‡ä»¶é™¤å¤–ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>mod.rs&lt;/code>çš„æ¨¡å—åå°±æ˜¯å…¶æ‰€åœ¨ç›®å½•çš„åå­—ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>main.rs&lt;/code>, &lt;code>lib.rs&lt;/code> çš„æ¨¡å—åæ˜¯å…¶ç›®å½•ç»“æ„ï¼Œå¦‚ï¼š&lt;code>exp/src/main.rs&lt;/code>æˆ– &lt;code>lip/src/lib.rs&lt;/code> çš„modååˆ†åˆ«æ˜¯expå’Œlipï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ–‡ä»¶å’Œæ–‡ä»¶å¤¹å†…çš„modåŠå…¶å†…éƒ¨å®šä¹‰çš„å‡½æ•°é»˜è®¤éƒ½æ˜¯privateçš„ï¼Œé™¤épubå£°æ˜å…¬å¼€ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>privateå…ƒç´ åªæœ‰æœ¬æ¨¡å—å†…çš„å…ƒç´ ä»¥åŠå®ƒçš„å­æ¨¡å—å¯ä»¥è®¿é—®ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>publicå…ƒç´ ä¸Šä¸€å±‚çš„æ¨¡å—å°±æœ‰æƒè®¿é—®å®ƒï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœå­˜åœ¨ä¸æ–‡ä»¶åŒåçš„ç›®å½•ï¼Œ åˆ™åœ¨è¯¥ç›®å½•ä¸‹å®šä¹‰çš„æ¨¡å—éƒ½æ˜¯è¯¥æ–‡ä»¶çš„å­æ¨¡å—ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Rust çš„å¤šå±‚æ¨¡å—éµå¾ªå¦‚ä¸‹ä¸¤æ¡è§„åˆ™ï¼š&lt;/p>
&lt;ol>
&lt;li>ä¼˜å…ˆæŸ¥æ‰¾&lt;code>xxx.rs&lt;/code>Â æ–‡ä»¶
&lt;ol>
&lt;li>&lt;code>main.rs&lt;/code>ã€&lt;code>lib.rs&lt;/code>ã€&lt;code>mod.rs&lt;/code>ä¸­çš„&lt;code>mod xxx;&lt;/code>Â é»˜è®¤ä¼˜å…ˆæŸ¥æ‰¾åŒçº§ç›®å½•ä¸‹çš„Â &lt;code>xxx.rs&lt;/code>Â æ–‡ä»¶ï¼›&lt;/li>
&lt;li>å…¶ä»–æ–‡ä»¶&lt;code>yyy.rs&lt;/code>ä¸­çš„&lt;code>mod xxx;&lt;/code>é»˜è®¤ä¼˜å…ˆæŸ¥æ‰¾åŒçº§ç›®å½•çš„&lt;code>yyy&lt;/code>ç›®å½•ä¸‹çš„Â &lt;code>xxx.rs&lt;/code>Â æ–‡ä»¶ï¼›&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>å¦‚æœÂ &lt;code>xxx.rs&lt;/code>Â ä¸å­˜åœ¨ï¼Œåˆ™æŸ¥æ‰¾Â &lt;code>xxx/mod.rs&lt;/code>Â æ–‡ä»¶ï¼Œå³Â &lt;code>xxx&lt;/code>Â ç›®å½•ä¸‹çš„Â &lt;code>mod.rs&lt;/code>Â æ–‡ä»¶ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼ŒåŠ è½½æˆæ¨¡å—åï¼Œæ•ˆæœæ˜¯ç›¸åŒçš„ã€‚Rust å°±å‡­è¿™ä¸¤æ¡è§„åˆ™ï¼Œé€šè¿‡è¿­ä»£ä½¿ç”¨ï¼Œç»“åˆÂ &lt;code>pub&lt;/code>Â å…³é”®å­—ï¼Œå®ç°äº†å¯¹æ·±å±‚ç›®å½•ä¸‹æ¨¡å—çš„åŠ è½½ï¼›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">src
â”œâ”€â”€ a
â”‚ â”œâ”€â”€ b
â”‚ â”‚ â”œâ”€â”€ c
â”‚ â”‚ â”‚ â”œâ”€â”€ d.rs
â”‚ â”‚ â”‚ â””â”€â”€ mod.rs
â”‚ â”‚ â””â”€â”€ mod.rs
â”‚ â””â”€â”€ mod.rs
â””â”€â”€ main.rs
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">// a/b/c/d.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">print_ddd&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">println&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;i am ddd.&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// a/b/c/mod.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">d&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// a/b/mod.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">c&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// a/mod.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">b&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// main.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">a&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">use&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>::&lt;span class="n">b&lt;/span>::&lt;span class="n">c&lt;/span>::&lt;span class="n">d&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>::&lt;span class="n">print_ddd&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ¨¡å—è·¯å¾„">æ¨¡å—è·¯å¾„&lt;/h3>
&lt;p>æƒ³è¦è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå°±éœ€è¦çŸ¥é“å®ƒçš„è·¯å¾„ï¼Œåœ¨ Rust ä¸­ï¼Œè¿™ç§è·¯å¾„æœ‰ä¸¤ç§å½¢å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ç»å¯¹è·¯å¾„&lt;/strong>ï¼Œä»åŒ…æ ¹å¼€å§‹ï¼Œè·¯å¾„åä»¥åŒ…åæˆ–è€…Â &lt;code>crate&lt;/code>Â ä½œä¸ºå¼€å¤´&lt;/li>
&lt;li>&lt;strong>ç›¸å¯¹è·¯å¾„&lt;/strong>ï¼Œä»å½“å‰æ¨¡å—å¼€å§‹ï¼Œä»¥Â &lt;code>self&lt;/code>ï¼Œ&lt;code>super&lt;/code>Â æˆ–å½“å‰æ¨¡å—çš„æ ‡è¯†ç¬¦ä½œä¸ºå¼€å¤´&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">// src/lib.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">front_of_house&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">hosting&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">add_to_waitlist&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">eat_at_restaurant&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// ç»å¯¹è·¯å¾„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">crate&lt;/span>::&lt;span class="n">front_of_house&lt;/span>::&lt;span class="n">hosting&lt;/span>::&lt;span class="n">add_to_waitlist&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// ç›¸å¯¹è·¯å¾„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">front_of_house&lt;/span>::&lt;span class="n">hosting&lt;/span>::&lt;span class="n">add_to_waitlist&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ¨¡å—ç³»ç»Ÿ">æ¨¡å—ç³»ç»Ÿ&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>å•æ–‡ä»¶rust ä¸­ç§°ä¸º&lt;code>mod&lt;/code>ï¼Œæ¨¡å—çš„åç§°å°±æ˜¯æ–‡ä»¶çš„åç§°ã€‚&lt;/p>
&lt;p>æ¨¡å—å†…éƒ¨çš„å‡½æ•°ï¼Œåªèƒ½åœ¨æ¨¡å—å†…éƒ¨ä½¿ç”¨ï¼Œå¦‚æœè¦åœ¨æ¨¡å—å¤–è°ƒç”¨ï¼Œéœ€è¦ç”¨&lt;code>pub&lt;/code>å…³é”®è¯ï¼Œæ˜¾å¼å£°æ˜å‡½æ•°å¯åœ¨å¤–éƒ¨ä½¿ç”¨ã€‚&lt;/p>
&lt;p>ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨modå£°æ˜å¼•å…¥ï¼Œmod name::&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">//file: rustmod/src/functions.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">hello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>: &lt;span class="nb">String&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">String&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello, {}!&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// åµŒå¥—å­æ¨¡å—
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">util&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">hello2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>: &lt;span class="nb">String&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">String&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello, {}!&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">//file: rust/src/main.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">functions&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//å£°æ˜æ¨¡å—
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">functions&lt;/span>::&lt;span class="n">hello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;World&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_string&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">println&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">functions&lt;/span>::&lt;span class="n">util&lt;/span>::&lt;span class="n">hello2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;World&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_string&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">println&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s2&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨mod.rs, mod ä¼šå»å¯¹åº”ç›®å½•ä¸‹mod.rsä¸­å¯¼å…¥è¯¥ç›®å½•ä¸‹å£°æ˜çš„mod&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">//file: rustmod/src/util/functions.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">hello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>: &lt;span class="nb">String&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">String&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello, {}!&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">//file: rustmod/src/util/mod.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">functions&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">//file: rustmod/src/main.rs
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">mod&lt;/span> &lt;span class="nn">util&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">util&lt;/span>::&lt;span class="n">functions&lt;/span>::&lt;span class="n">util&lt;/span>::&lt;span class="n">hello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;World&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_string&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">println&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨åŒä¸€å±‚çº§ä¸èƒ½åŒæ—¶å­˜åœ¨æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ç±»å‹çš„æ¨¡å—ï¼Œå¦åˆ™ä¼šåå­—å†²çªã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="å…¸å‹rusté¡¹ç›®ç»“æ„">å…¸å‹rusté¡¹ç›®ç»“æ„&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">.
â”œâ”€â”€ Cargo.toml &lt;span class="c1">## cargoé…ç½®æ–‡ä»¶&lt;/span>
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ src
â”‚ â”œâ”€â”€ main.rs &lt;span class="c1">## é»˜è®¤äºŒè¿›åˆ¶åŒ…å…¥å£&lt;/span>
â”‚ â”œâ”€â”€ lib.rs &lt;span class="c1">## é»˜è®¤libåŒ…å…¥å£&lt;/span>
â”‚ â””â”€â”€ bin
â”‚ â””â”€â”€ main1.rs &lt;span class="c1">## äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶main1&lt;/span>
â”‚ â””â”€â”€ main2.rs &lt;span class="c1">## äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶main2&lt;/span>
â”œâ”€â”€ tests
â”‚ â””â”€â”€ some_integration_tests.rs &lt;span class="c1">## é›†æˆæµ‹è¯•&lt;/span>
â”œâ”€â”€ benches
â”‚ â””â”€â”€ simple_bench.rs &lt;span class="c1">## æ€§èƒ½æµ‹è¯•&lt;/span>
â””â”€â”€ examples
â””â”€â”€ simple_example.rs &lt;span class="c1">## example&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://course.rs/basic/crate-module/intro.html#%E5%8C%85%E5%92%8C%E6%A8%A1%E5%9D%97">Rustè¯­è¨€åœ£ç»(Rust Course)-åŒ…å’Œæ¨¡å—&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Rustç‰¹æ€§(trait)</title><link>https://justice.bj.cn/post/14.language/rust/20.rust%E7%89%B9%E6%80%A7trait/</link><pubDate>Sun, 12 Jun 2022 20:44:24 +0800</pubDate><guid>https://justice.bj.cn/post/14.language/rust/20.rust%E7%89%B9%E6%80%A7trait/</guid><description>&lt;h1 id="rustç‰¹æ€§trait">Rustç‰¹æ€§(trait)&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;code>trait&lt;/code>(ç‰¹æ€§) æ˜¯ä¸€ç»„æ–¹æ³•çš„é›†åˆï¼Œå®ç°traitçš„ç±»å‹å¯ä»¥è®¿é—®è¯¥ trait ä¸­å®šä¹‰çš„å…¶ä»–æ–¹æ³•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»»ä½•ç±»å‹éƒ½å¯ä»¥å®ç° traitï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="è¦ç‚¹">è¦ç‚¹&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Trait&lt;/code>å¿…é¡»å£°æ˜å¯è§åæ‰èƒ½ä½¿ç”¨ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Traitæœ¬èº«å¹¶æ²¡æœ‰å›ºå®šçš„å¤§å°ï¼Œä¸èƒ½ç›´æ¥å£°æ˜å’Œä½¿ç”¨Traitç±»å‹çš„å˜é‡ï¼Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŸä¸ªå®ç°è¯¥Traitç±»å‹çš„å®ä¾‹çš„æœ‰æ•ˆå¼•ç”¨ç§°ä¸º&lt;code>Trait Object&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ‰€æœ‰traitéƒ½æœ‰ä¸€ä¸ªéšè—çš„ç±»å‹&lt;code>Self&lt;/code>ï¼Œä»£è¡¨å½“å‰å®ç°æ­¤Traitçš„å…·ä½“ç±»å‹ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å‡½æ•°&lt;u>ç¬¬ä¸€ä¸ªå‚æ•°&lt;/u>æ˜¯&lt;code>self&lt;/code>ä¸”ä¸º&lt;code>Self&lt;/code>ç›¸å…³ç±»å‹(&lt;code>Self, &amp;amp;Self, &amp;amp;mut Self, Box&amp;lt;Self&amp;gt;&lt;/code>)ï¼Œåˆ™å‡½æ•°ä¸º&lt;strong>æ–¹æ³•&lt;/strong>(method)ï¼Œ&lt;code>self&lt;/code>ç§°ä¸º&lt;code>receiver&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ²¡æœ‰receiverå‚æ•°çš„å‡½æ•°ä¸º&lt;strong>é™æ€æ–¹æ³•&lt;/strong>ï¼Œå¯é€šè¿‡&lt;code>Type::Function()&lt;/code>æ–¹å¼è°ƒç”¨ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åŒ¿åTraitæ— é¡»åå­—ï¼Œå¯ç›´æ¥åœ¨implä¸­å®ç°ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯ä»¥åœ¨traitçš„å£°æ˜ä¸­å®šä¹‰é»˜è®¤æ–¹æ³•ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ‰©å±•trait(extension trait), å¯ä»¥ä¸ºå…¶å®ƒtraitç±»å‹æ‰©å±•å‡ºè‡ªå®šä¹‰traitçš„æ¥å£ï¼Œimplå—å¿…é¡»ä¸traitæˆ–structå£°æ˜åœ¨åŒä¸€ä¸ªcrateä¸­ï¼ˆå­¤å„¿è§„åˆ™ï¼‰ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç»§æ‰¿ï¼šå‡¡æ˜¯å®ç°äº†Subtrait(&lt;code>Creature&lt;/code>)çš„ç±»å‹, ä¹Ÿå¿…é¡»å®ç°çˆ¶Trait(&lt;code>Visible&lt;/code>)çš„&lt;strong>æ‰€æœ‰æ–¹æ³•&lt;/strong>ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="å­¤å„¿è§„åˆ™orphan-rule">å­¤å„¿è§„åˆ™(orphan rule)&lt;/h2>
&lt;ul>
&lt;li>å¦‚æœè¦å®ç°å¤–éƒ¨å®šä¹‰çš„ &lt;code>trait&lt;/code> éœ€è¦å…ˆå°†å…¶å¯¼å…¥ä½œç”¨åŸŸï¼›&lt;/li>
&lt;li>ä¸å…è®¸å¯¹å¤–éƒ¨ç±»å‹å®ç°å¤–éƒ¨ &lt;code>trait&lt;/code>ï¼›&lt;/li>
&lt;li>å¯ä»¥å¯¹å¤–éƒ¨ç±»å‹å®ç°è‡ªå®šä¹‰çš„ &lt;code>trait&lt;/code>ï¼›&lt;/li>
&lt;li>å¯ä»¥å¯¹è‡ªå®šä¹‰ç±»å‹ä¸Šå®ç°å¤–éƒ¨ &lt;code>trait&lt;/code>ï¼›&lt;/li>
&lt;/ul>
&lt;h2 id="ç¤ºä¾‹">ç¤ºä¾‹&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">// traitå£°æ˜
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Shape&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">area1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//method1(self: Self);
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">area&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//area(self: &amp;amp;Self);
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">larger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="kt">f64&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Circle&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">r&lt;/span>: &lt;span class="kt">f64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// trait å®ç°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Shape&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Circle&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">area&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="kt">f64&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">std&lt;/span>::&lt;span class="kt">f64&lt;/span>::&lt;span class="n">consts&lt;/span>::&lt;span class="n">PI&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// åŒ¿åtrait
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Circle&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">get_radius&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="kt">f64&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="trait-æ³›å‹">Trait æ³›å‹&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">// where ä»å¥
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">foo&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>: &lt;span class="nc">T&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">y&lt;/span>: &lt;span class="nc">K&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">T&lt;/span>: &lt;span class="nb">Clone&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">K&lt;/span>: &lt;span class="nb">Clone&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Debug&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clone&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clone&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">println&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{:?}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="traitå¯¹è±¡trait-object">Traitå¯¹è±¡(Trait object)&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>æŒ‡å‘traitçš„æŒ‡é’ˆå°±æ˜¯&lt;code>Trait Object&lt;/code>ï¼Œæ¯”å¦‚Â &lt;code>&amp;amp;SomeTrait&lt;/code>Â å’ŒÂ &lt;code>Box&amp;lt;SomeTrait&amp;gt;&lt;/code>;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>&amp;amp;SomeTrait&lt;/code> ç±»å‹å’Œæ™®é€šçš„æŒ‡é’ˆç±»å‹ä¸åŒ, ä¸ä»…åŒ…æ‹¬æŒ‡å‘çœŸå®å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿˜åŒ…æ‹¬ä¸€ä¸ªæŒ‡å‘è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆ;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>rusté€šè¿‡&lt;code>TraitObject&lt;/code>ç”¨æ¥å®ç°åŠ¨æ€åˆ†å‘ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Trait Object&lt;/code>å®é™…æ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆ&lt;code>fat pointer&lt;/code>, å ç”¨ä¸¤ä¸ªæœºå™¨å­—å­—èŠ‚, ä¸€ä¸ªæŒ‡å‘å®é™…çš„å®ä¾‹å¯¹è±¡, ä¸€ä¸ªæŒ‡å‘è™šåŸºè¡¨&lt;code>vtable&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">//std::raw
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">TraitObject&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">data&lt;/span>: &lt;span class="o">*&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">vtable&lt;/span>: &lt;span class="o">*&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="supertrait">Supertrait&lt;/h2>
&lt;h2 id="å…³è”ç±»å‹">å…³è”ç±»å‹&lt;/h2>
&lt;p>å…³è”ç±»å‹æ˜¯ä¸€ä¸ªå°†ç±»å‹å ä½ç¬¦ä¸trait ç›¸å…³è”çš„æ–¹å¼ï¼Œè¿™æ · trait çš„æ–¹æ³•ç­¾åä¸­å°±å¯ä»¥ä½¿ç”¨è¿™äº›å ä½ç¬¦ç±»å‹ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å…³è”ç±»å‹ç±»ä¼¼æ³›å‹ï¼Œä¸åŒä¹‹å¤„å…³è”ç±»å‹ï¼Œæ— éœ€æ ‡æ³¨ç±»å‹ï¼Œæ— é¡»å¤šæ¬¡å®ç°traitï¼›&lt;/p>
&lt;/li>
&lt;li>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Iterator&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">type&lt;/span> &lt;span class="nc">Item&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//å…³è”ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Self&lt;/span>::&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Iterator&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Counter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">type&lt;/span> &lt;span class="nc">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">u32&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Self&lt;/span>::&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// --snip--
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¸¸ç”¨trait">å¸¸ç”¨Trait&lt;/h2>
&lt;h3 id="default">Default&lt;/h3>
&lt;p>Default traitæ˜¯é’ˆå¯¹æ— å‚æ„é€ å‡½æ•°çš„æŠ½è±¡&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">//std::default::Default
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Default&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">default&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Self&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// Vec default
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Default&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">default&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Vec&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="derive">Derive&lt;/h3>
&lt;p>Rustæä¾›äº†ä¸€ä¸ªç‰¹æ®Šå±æ€§ï¼Œä»¥è‡ªåŠ¨implæŸäº›traitï¼Œç¼–è¯‘é˜¶æ®µä¼šè‡ªåŠ¨å±•å¼€ä¸ºç›¸åº”çš„implå—ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="cp">#[derive(Copy, Clone, Default)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Foo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">data&lt;/span>: &lt;span class="kt">i32&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Rustæ”¯æŒè‡ªåŠ¨deriveçš„traitæœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Debug&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Clone/Copy&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Hash&lt;/p>
&lt;/li>
&lt;li>
&lt;p>PartialEq/Eq/PartialOrd/Ord&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Send/Sync&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Default&lt;/p>
&lt;/li>
&lt;li>
&lt;p>FromPrimitive&lt;/p>
&lt;/li>
&lt;li>
&lt;p>RustcEncodable/RustcDecodable&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="displaydebug">Display/Debug&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>å®ç°&lt;code>Display&lt;/code>ç‰¹æ€§çš„ç±»å‹ï¼Œå¯ç”¨&lt;code>{}&lt;/code>æ ¼å¼æ§åˆ¶æ‰“å°ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®ç°&lt;code>Debug&lt;/code>ç‰¹æ€§çš„ç±»å‹ï¼Œå¯ç”¨&lt;code>{:?},{:#?}&lt;/code>æ ¼å¼æ§åˆ¶æ‰“å°ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Display&lt;/code>ä¸€èˆ¬ç»™æœ€ç»ˆç”¨æˆ·æ˜¾ç¤ºçš„ï¼Œé€šå¸¸ç”¨utf-8æ ¼å¼å­—ç¬¦è¾“å‡ºï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Debug&lt;/code>ç‰¹æ€§ä¸»è¦ç”¨äºè°ƒè¯•ï¼Œä¸€èˆ¬ä¸ºbyteå­—ç¬¦ï¼Œç¼–è¯‘å™¨æä¾›è‡ªåŠ¨deriveåŠŸèƒ½ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®ç°&lt;code>Dispaly&lt;/code>ç‰¹æ€§çš„ç±»å‹éƒ½è‡ªåŠ¨å®ç°äº†&lt;code>ToString&lt;/code>ç‰¹æ€§ï¼Œå¯ç›´æ¥é€šè¿‡&lt;code>to_string()&lt;/code>æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">//std::fmt::Display
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Display&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">fmt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">f&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Formatter&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Error&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">//std::fmt::Debug
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Debug&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">fmt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">f&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Formatter&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Error&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ´¾ç”Ÿderive">æ´¾ç”Ÿ(derive)&lt;/h2>
&lt;p>é€šè¿‡Â &lt;code>#[derive]&lt;/code>Â &lt;a href="https://rustwiki.org/zh-CN/rust-by-example/attribute.html">å±æ€§&lt;/a>ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿæä¾›æŸäº› trait çš„åŸºæœ¬å®ç°ã€‚å¦‚æœ éœ€è¦æ›´å¤æ‚çš„è¡Œä¸ºï¼Œè¿™äº› trait ä¹Ÿå¯ä»¥æ‰‹åŠ¨å®ç°ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯å¯ä»¥è‡ªåŠ¨æ´¾ç”Ÿçš„ traitï¼š&lt;/p>
&lt;ul>
&lt;li>æ¯”è¾ƒ trait:Â &lt;a href="https://rustwiki.org/zh-CN/std/cmp/trait.Eq.html">&lt;code>Eq&lt;/code>&lt;/a>,Â &lt;a href="https://rustwiki.org/zh-CN/std/cmp/trait.PartialEq.html">&lt;code>PartialEq&lt;/code>&lt;/a>,Â &lt;a href="https://rustwiki.org/zh-CN/std/cmp/trait.Ord.html">&lt;code>Ord&lt;/code>&lt;/a>,Â &lt;a href="https://rustwiki.org/zh-CN/std/cmp/trait.PartialOrd.html">&lt;code>PartialOrd&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://rustwiki.org/zh-CN/std/clone/trait.Clone.html">&lt;code>Clone&lt;/code>&lt;/a>, ç”¨æ¥ä»Â &lt;code>&amp;amp;T&lt;/code>Â åˆ›å»ºå‰¯æœ¬Â &lt;code>T&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;a href="https://rustwiki.org/zh-CN/core/marker/trait.Copy.html">&lt;code>Copy&lt;/code>&lt;/a>ï¼Œä½¿ç±»å‹å…·æœ‰ â€œå¤åˆ¶è¯­ä¹‰â€ï¼ˆcopy semanticsï¼‰è€Œé â€œç§»åŠ¨è¯­ä¹‰â€ï¼ˆmove semanticsï¼‰ã€‚&lt;/li>
&lt;li>&lt;a href="https://rustwiki.org/zh-CN/std/hash/trait.Hash.html">&lt;code>Hash&lt;/code>&lt;/a>ï¼Œä»Â &lt;code>&amp;amp;T&lt;/code>Â è®¡ç®—å“ˆå¸Œå€¼ï¼ˆhashï¼‰ã€‚&lt;/li>
&lt;li>&lt;a href="https://rustwiki.org/zh-CN/std/default/trait.Default.html">&lt;code>Default&lt;/code>&lt;/a>, åˆ›å»ºæ•°æ®ç±»å‹çš„ä¸€ä¸ªç©ºå®ä¾‹ã€‚&lt;/li>
&lt;li>&lt;a href="https://rustwiki.org/zh-CN/std/fmt/trait.Debug.html">&lt;code>Debug&lt;/code>&lt;/a>ï¼Œä½¿ç”¨Â &lt;code>{:?}&lt;/code>Â formatter æ¥æ ¼å¼åŒ–ä¸€ä¸ªå€¼ã€‚&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="cp">#[derive(PartialEq, PartialOrd)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Centimeters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">f64&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// `Inches`ï¼Œå¯ä»¥æ‰“å°çš„å…ƒç»„ç»“æ„ä½“
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="cp">#[derive(Debug)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Inches&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">i32&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Inches&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">to_centimeters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Centimeters&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">Inches&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">inches&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Centimeters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">inches&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">f64&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mf">2.54&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ordpartialordeqpartialeq">Ord/PartialOrd/Eq/PartialEq&lt;/h3>
&lt;h2 id="æ ‡ç­¾trait">æ ‡ç­¾Trait&lt;/h2>
&lt;h3 id="sized">Sized&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Sized&lt;/code>æ˜¯ä¸€ç§&lt;code>maker trait&lt;/code>ï¼Œè¡¨ç¤ºç±»å‹sizeæ˜¯å›ºå®šçš„ , æ²¡æœ‰ä»»ä½•æ–¹æ³•å’Œè”åˆç±»å‹ï¼Œæ— æ³•å®ç°ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Rustä¸èƒ½åœ¨å˜é‡é‡Œä¿å­˜&lt;em>unsized&lt;/em>çš„å€¼, ä¹Ÿä¸èƒ½æŠŠ&lt;em>unsize&lt;/em>çš„å€¼ä½œä¸ºå‚æ•°.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ‰€æœ‰å›ºå®šå¤§å°çš„ç±»å‹éƒ½å®ç°é‡Œ&lt;code>std::marker::Sized&lt;/code>traitï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Sized traitåªèƒ½ç”¨äºç»‘å®šåˆ°ç±»å‹å‚æ•°, ä¹Ÿå°±æ˜¯ç”¨äºå‚æ•°çš„ç±»å‹å£°æ˜(åŠæ£€æŸ¥), ä¾‹å¦‚Â &lt;code>T: Sized&lt;/code>ä¸èƒ½ç”¨äºå…¶å®ƒç”¨é€”ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>?Sized&lt;/code>å«Â &lt;em>questionably sized&lt;/em>, å…è®¸å›ºå®šå¤§å°, ä¹Ÿå…è®¸éå›ºå®šå¤§å°ç±»å‹.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>structçš„æœ€åä¸€ä¸ªå­—æ®µå…è®¸æ˜¯&lt;code>?Sized&lt;/code>ç±»å‹, ä½†å¦‚æœè¿™æ ·, structæœ¬èº«å°±å˜ä¸ºäº†unsized.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½†å¦‚æœå†™æˆæ³›å‹, å¹¶ä¼ å…¥ä¸€ä¸ªSizedç±»å‹, é‚£ä¹ˆè¿™ä¸ªç±»å‹çš„structä»ç„¶æ˜¯Sized. å¤§å°å–å†³äºæ³›å‹çš„å‚æ•°ç±»å‹:&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="copyclone">Copy/Clone&lt;/h3>
&lt;p>Copy:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœä¸€ä¸ªç±»å‹ impl äº† Copy traitï¼Œæ„å‘³ç€ä»»ä½•æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•çš„å†…å­˜æ‹·è´å®ç°è¯¥ç±»å‹çš„å¤åˆ¶ï¼Œè€Œä¸ä¼šäº§ç”Ÿä»»ä½•é—®é¢˜ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸€æ—¦ä¸€ä¸ªç±»å‹å®ç°äº† Copy traitï¼Œé‚£ä¹ˆå®ƒåœ¨å˜é‡ç»‘å®šã€å‡½æ•°å‚æ•°ä¼ é€’ã€å‡½æ•°è¿”å›å€¼ä¼ é€’ç­‰åœºæ™¯ä¸‹ï¼Œå®ƒéƒ½æ˜¯ copy è¯­ä¹‰ï¼Œè€Œä¸å†æ˜¯é»˜è®¤çš„ move è¯­ä¹‰ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åªæœ‰æ‰€æœ‰çš„æˆå‘˜éƒ½å®ç°äº† Copy traitï¼Œè¿™ä¸ªç±»å‹æ‰æœ‰èµ„æ ¼å®ç° Copy traitï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Clone:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Clone&lt;/code>æ˜¯&lt;code>Sized&lt;/code>çš„sub-trait, æ‰€ä»¥Selfç±»å‹å¿…é¡»æ˜¯Sizedï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>clone&lt;/code>æ–¹æ³•å¿…é¡»è¿”å›å’Œ&lt;code>self&lt;/code>ç‹¬ç«‹æ— å…³çš„ä¸€ä»½æ‹·è´ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœæ‰€æœ‰çš„å­—æ®µéƒ½å®ç°äº†Clone, é‚£ä¹ˆ&lt;code>struct&lt;/code>å¯ä»¥åŠ ä¸Šå±æ€§:Â &lt;code>#[derive(Clone)]&lt;/code>è‡ªåŠ¨å®ç°Clone traitï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>
&lt;p>é€šå¸¸æƒ…å†µä¸‹cloneçš„æˆæœ¬æ¯”è¾ƒé«˜, ä½†æ˜¯å¯¹äº&lt;code>Rc&amp;lt;T&amp;gt;&lt;/code>å’Œ&lt;code>Arc&amp;lt;T&amp;gt;&lt;/code>è¿™ç±»çš„ç±»å‹, Rustçš„å¯¹å®ƒä»¬çš„cloneåªæ˜¯ç®€å•çš„å¢åŠ è®¡æ•°.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šå¸¸å°½å¯èƒ½ä½¿ç”¨&lt;code>clone_from&lt;/code>æ¥å‡å°‘cloneå¼€é”€, è¿™ä¼šå…è®¸ä¸€äº›ä¼˜åŒ–. ä¾‹å¦‚, Stringçš„clone, è¢«èµ‹å€¼çš„Stringå¦‚æœcapacityå¤Ÿå¤§, å¯ä»¥ä¸éœ€è¦é‡Šæ”¾å†…å­˜, ç›´æ¥æŠŠæºçš„å†…å®¹æ‹·è´è¿‡æ¥.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœæ‰€æœ‰çš„å­—æ®µéƒ½å®ç°äº†Clone, é‚£ä¹ˆ&lt;code>struct&lt;/code>å¯ä»¥åŠ ä¸Šå±æ€§:Â &lt;code>#[derive(Clone)]&lt;/code>è‡ªåŠ¨å®ç°Clone trait&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>clone&lt;/code>æ–¹æ³•ä¸èƒ½å¤±è´¥(&lt;em>infallible&lt;/em>), å¯¹äº&lt;code>std::fs::File&lt;/code>è¿™æ ·çš„ç±»å‹, æœ‰&lt;code>try_clone&lt;/code>æ–¹æ³•, è¿”å›&lt;code>std::io::Result&amp;lt;File&amp;gt;&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>: &lt;span class="nb">Sized&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Self&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">clone_from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">source&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">Self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clone&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="frominto">From/Into&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;code>From&lt;/code>: å¯¹äºç±»å‹ä¸ºÂ &lt;code>U&lt;/code>Â çš„å¯¹è±¡Â &lt;code>foo&lt;/code>ï¼Œå¦‚æœå®ƒå®ç°äº†Â &lt;code>From&amp;lt;T&amp;gt;&lt;/code>ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥é€šè¿‡Â &lt;code>let foo = U::from(bar)&lt;/code>Â æ¥ç”Ÿæˆè‡ªå·±&lt;/p>
&lt;/li>
&lt;li>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Into&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>: &lt;span class="nb">Sized&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">into&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">T&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>: &lt;span class="nb">Sized&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Self&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// é™æ€æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">// as_refå’ŒBorrowçš„åŒºåˆ« ?
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// as_ref æ˜¯è½¬å¼•ç”¨å‡½æ•°, å°†å…·æœ‰æ‰€æœ‰æƒå¯¹è±¡è½¬æ¢æˆå¼•ç”¨å¯¹è±¡,
&lt;/span>&lt;span class="c1">// ä¸æ”¹å˜è¢«è½¬æ¢å¯¹è±¡çš„åŸºç¡€ä¸Šäº§ç”Ÿä¸€ä¸ªå¼•ç”¨å¯¹è±¡.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// as_ref å¹¶ä¸æ˜¯æ‰€æœ‰ç±»å‹éƒ½é»˜è®¤æ”¯æŒ, å¾ˆå¤šæ—¶å€™éƒ½éœ€è¦è‡ªå·±å»å£°æ˜.
&lt;/span>&lt;span class="c1">// as_ref æ˜¯AsRef trait çš„å…¬å…±æ¥å£æ–¹æ³•.
&lt;/span>&lt;span class="c1">// åªæœ‰é‚£äº›å®ç°äº† as_ref å…¬å…±æ¥å£æ–¹æ³•çš„ç±»å‹æ‰èƒ½ä½¿ç”¨as_ref.
&lt;/span>&lt;span class="c1">// ç›®å‰: Option, Box, Result è¿™ä¸‰ç§ç±»å‹é»˜è®¤æä¾›æ”¯æŒas_ref.
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="https://wiki.jikexueyuan.com/project/rust-primer/">https://wiki.jikexueyuan.com/project/rust-primer/&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://unpluggedcoder.me/2019/08/31/Rust%E5%85%A5%E9%97%A8%E5%A4%B1%E8%B4%A5%E4%B9%8BTraits&amp;amp;Generics/">https://unpluggedcoder.me/2019/08/31/Rust%E5%85%A5%E9%97%A8%E5%A4%B1%E8%B4%A5%E4%B9%8BTraits&amp;amp;Generics/&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/21730929">https://zhuanlan.zhihu.com/p/21730929&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://unpluggedcoder.me/2019/09/01/Rust%E5%85%A5%E9%97%A8%E5%A4%B1%E8%B4%A5%E4%B9%8BUtility%20Traits/">https://unpluggedcoder.me/2019/09/01/Rust%E5%85%A5%E9%97%A8%E5%A4%B1%E8%B4%A5%E4%B9%8BUtility%20Traits/&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://wiki.jikexueyuan.com/project/rust-primer/trait/trait-object.html">https://wiki.jikexueyuan.com/project/rust-primer/trait/trait-object.html&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/23791817">https://zhuanlan.zhihu.com/p/23791817&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>UTXOæ¨¡å‹</title><link>https://justice.bj.cn/post/60.blockchain/utxo%E6%A8%A1%E5%9E%8B/</link><pubDate>Sun, 12 Jun 2022 20:44:24 +0800</pubDate><guid>https://justice.bj.cn/post/60.blockchain/utxo%E6%A8%A1%E5%9E%8B/</guid><description>&lt;h1 id="utxoæ¨¡å‹">UTXOæ¨¡å‹&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;ul>
&lt;li>UTXO(Unspent Transaction Output)æ˜¯åŒºå—é“¾ä¸­ç”¨æ¥ä¿å­˜åŒºå—è´¦æˆ·è®°å½•çš„æ–¹å¼ä¹‹ä¸€ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>&lt;/li>
&lt;/ol></description></item><item><title>Linuxç³»ç»Ÿè°ƒç”¨ä¹‹Futex</title><link>https://justice.bj.cn/post/21.linux/linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B9%8Bfutex/</link><pubDate>Mon, 06 Jun 2022 20:41:30 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B9%8Bfutex/</guid><description>&lt;h1 id="linuxç³»ç»Ÿè°ƒç”¨ä¹‹futex">Linuxç³»ç»Ÿè°ƒç”¨ä¹‹Futex&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Futexï¼ˆFast Userspace muTexesï¼‰çš„ç¼©å†™ï¼Œç”±Hubertus Franke, Matthew Kirkwood, Ingo Molnar and Rusty Russellå…±åŒè®¾è®¡å®Œæˆï¼Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Futexæ˜¯ä¸€ç§ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ··åˆçš„åŒæ­¥æœºåˆ¶ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>åŒæ­¥çš„è¿›ç¨‹é—´é€šè¿‡mmapå…±äº«ä¸€æ®µå†…å­˜ï¼Œfutexå˜é‡å°±ä½äºè¿™æ®µå…±äº« çš„å†…å­˜ä¸­ä¸”æ“ä½œæ˜¯åŸå­çš„ï¼Œ&lt;/li>
&lt;li>å½“è¿›ç¨‹å°è¯•è¿›å…¥äº’æ–¥åŒºæˆ–è€…é€€å‡ºäº’æ–¥åŒºçš„æ—¶å€™ï¼Œå…ˆå»æŸ¥çœ‹å…±äº«å†…å­˜ä¸­çš„futexå˜é‡ï¼Œ
3. å¦‚æœæ²¡æœ‰ç«äº‰å‘ç”Ÿï¼Œåˆ™åªä¿®æ”¹futex,è€Œä¸ ç”¨å†æ‰§è¡Œç³»ç»Ÿè°ƒç”¨äº†ã€‚
4. å¦‚æœfutexå˜é‡å‘Šè¯‰è¿›ç¨‹æœ‰ç«äº‰å‘ç”Ÿï¼Œåˆ™æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å»å®Œæˆç›¸åº”çš„å¤„ç†(wait æˆ–è€… wake up)ã€‚&lt;/li>
&lt;/ol>
&lt;p>futex å‡½æ•°ï¼š&lt;/p>
&lt;ol>
&lt;li>FUTEX_WAIT: åŸå­æ€§çš„æ£€æŸ¥uaddrä¸­è®¡æ•°å™¨çš„å€¼æ˜¯å¦ä¸ºval,å¦‚æœæ˜¯åˆ™è®©è¿›ç¨‹ä¼‘çœ ï¼Œç›´åˆ°FUTEX_WAKEæˆ–è€…è¶…æ—¶(time-out)ã€‚ä¹Ÿå°±æ˜¯æŠŠè¿›ç¨‹æŒ‚åˆ°uaddrç›¸å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šå»ã€‚&lt;/li>
&lt;li>ä¸åŠ timeoutå‚æ•°ï¼Œå®ƒä¼šä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°FUTEX_WAKE:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;linux/futex.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/time.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">futex&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">uaddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">timespec&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">timeout&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">uaddr2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">val3&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cp">#define __NR_futex 240
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>FUTEX_WAIT: åŸå­æ€§çš„æ£€æŸ¥uaddrä¸­è®¡æ•°å™¨çš„å€¼æ˜¯å¦ä¸ºval,å¦‚æœæ˜¯åˆ™è®©è¿›ç¨‹ä¼‘çœ ï¼Œç›´åˆ°FUTEX_WAKEæˆ–è€…è¶…æ—¶(time-out)ã€‚ä¹Ÿå°±æ˜¯æŠŠè¿›ç¨‹æŒ‚åˆ°uaddrç›¸å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šå»ã€‚&lt;br>
FUTEX_WAKE: æœ€å¤šå”¤é†’valä¸ªç­‰å¾…åœ¨uaddrä¸Šè¿›ç¨‹ã€‚&lt;/p>
&lt;p>å¯è§FUTEX_WAITå’ŒFUTEX_WAKEåªæ˜¯ç”¨æ¥æŒ‚èµ·æˆ–è€…å”¤é†’è¿›ç¨‹ï¼Œå½“ç„¶è¿™éƒ¨åˆ†å·¥ä½œä¹Ÿåªèƒ½åœ¨å†…æ ¸æ€ä¸‹å®Œæˆã€‚æœ‰äº›äººå°è¯•ç€ç›´æ¥ä½¿ç”¨futexç³»ç»Ÿè°ƒ ç”¨æ¥å®ç°è¿›ç¨‹åŒæ­¥ï¼Œå¹¶å¯„å¸Œæœ›è·å¾—futexçš„æ€§èƒ½ä¼˜åŠ¿ï¼Œè¿™æ˜¯æœ‰é—®é¢˜çš„ã€‚åº”è¯¥åŒºåˆ†futexåŒæ­¥æœºåˆ¶å’Œfutexç³»ç»Ÿè°ƒç”¨ã€‚futexåŒæ­¥æœºåˆ¶è¿˜åŒ…æ‹¬ç”¨æˆ·æ€ ä¸‹çš„æ“ä½œï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹èŠ‚æåˆ°ã€‚&lt;/p>
&lt;h2 id="futexåŒæ­¥æœºåˆ¶">FutexåŒæ­¥æœºåˆ¶&lt;/h2>
&lt;p>æ‰€æœ‰çš„futexåŒæ­¥æ“ä½œéƒ½åº”è¯¥ä»ç”¨æˆ·ç©ºé—´å¼€å§‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªfutexåŒæ­¥å˜é‡ï¼Œä¹Ÿå°±æ˜¯ä½äºå…±äº«å†…å­˜çš„ä¸€ä¸ªæ•´å‹è®¡æ•°å™¨ã€‚&lt;br>
å½“ è¿›ç¨‹å°è¯•æŒæœ‰é”æˆ–è€…è¦è¿›å…¥äº’æ–¥åŒºçš„æ—¶å€™ï¼Œå¯¹futexæ‰§è¡Œ&amp;quot;down&amp;quot;æ“ä½œï¼Œå³åŸå­æ€§çš„ç»™futexåŒæ­¥å˜é‡å‡1ã€‚å¦‚æœåŒæ­¥å˜é‡å˜ä¸º0ï¼Œåˆ™æ²¡æœ‰ç«äº‰å‘ç”Ÿï¼Œ è¿›ç¨‹ç…§å¸¸æ‰§è¡Œã€‚å¦‚æœåŒæ­¥å˜é‡æ˜¯ä¸ªè´Ÿæ•°ï¼Œåˆ™æ„å‘³ç€æœ‰ç«äº‰å‘ç”Ÿï¼Œéœ€è¦è°ƒç”¨futexç³»ç»Ÿè°ƒç”¨çš„futex_waitæ“ä½œä¼‘çœ å½“å‰è¿›ç¨‹ã€‚&lt;br>
å½“è¿›ç¨‹é‡Šæ”¾é”æˆ– è€…è¦ç¦»å¼€äº’æ–¥åŒºçš„æ—¶å€™ï¼Œå¯¹futexè¿›è¡Œ&amp;quot;up&amp;quot;æ“ä½œï¼Œå³åŸå­æ€§çš„ç»™futexåŒæ­¥å˜é‡åŠ 1ã€‚å¦‚æœåŒæ­¥å˜é‡ç”±0å˜æˆ1ï¼Œåˆ™æ²¡æœ‰ç«äº‰å‘ç”Ÿï¼Œè¿›ç¨‹ç…§å¸¸æ‰§è¡Œã€‚å¦‚ æœåŠ ä¹‹å‰åŒæ­¥å˜é‡æ˜¯è´Ÿæ•°ï¼Œåˆ™æ„å‘³ç€æœ‰ç«äº‰å‘ç”Ÿï¼Œéœ€è¦è°ƒç”¨futexç³»ç»Ÿè°ƒç”¨çš„futex_wakeæ“ä½œå”¤é†’ä¸€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…è¿›ç¨‹ã€‚&lt;/p>
&lt;p>è¿™é‡Œçš„åŸå­æ€§åŠ å‡é€šå¸¸æ˜¯ç”¨CAS(Compare and Swap)å®Œæˆçš„ï¼Œä¸å¹³å°ç›¸å…³ã€‚CASçš„åŸºæœ¬å½¢å¼æ˜¯ï¼šCAS(addr,old,new),å½“addrä¸­å­˜æ”¾çš„å€¼ç­‰äºoldæ—¶ï¼Œç”¨newå¯¹å…¶æ›¿æ¢ã€‚åœ¨x86å¹³å°ä¸Šæœ‰ä¸“é—¨çš„ä¸€æ¡æŒ‡ä»¤æ¥å®Œæˆå®ƒ: cmpxchgã€‚&lt;/p>
&lt;p>å¯è§: futexæ˜¯ä»ç”¨æˆ·æ€å¼€å§‹ï¼Œç”±ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€åè°ƒå®Œæˆçš„ã€‚&lt;/p>
&lt;h2 id="è¿›çº¿ç¨‹åˆ©ç”¨futexåŒæ­¥">è¿›/çº¿ç¨‹åˆ©ç”¨futexåŒæ­¥&lt;/h2>
&lt;p>è¿›ç¨‹æˆ–è€…çº¿ç¨‹éƒ½å¯ä»¥åˆ©ç”¨futexæ¥è¿›è¡ŒåŒæ­¥ã€‚&lt;br>
å¯¹äºçº¿ç¨‹ï¼Œæƒ…å†µæ¯”è¾ƒç®€å•ï¼Œå› ä¸ºçº¿ç¨‹å…±äº«è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿåœ°å€å°±å¯ä»¥å”¯ä¸€çš„æ ‡è¯†å‡ºfutexå˜é‡ï¼Œå³çº¿ç¨‹ç”¨åŒæ ·çš„è™šæ‹Ÿåœ°å€æ¥è®¿é—®futexå˜é‡ã€‚&lt;br>
å¯¹ äºè¿›ç¨‹ï¼Œæƒ…å†µç›¸å¯¹å¤æ‚ï¼Œå› ä¸ºè¿›ç¨‹æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œåªæœ‰é€šè¿‡mmap()è®©å®ƒä»¬å…±äº«ä¸€æ®µåœ°å€ç©ºé—´æ¥ä½¿ç”¨futexå˜é‡ã€‚æ¯ä¸ªè¿›ç¨‹ç”¨æ¥è®¿é—®futexçš„ è™šæ‹Ÿåœ°å€å¯ä»¥æ˜¯ä¸ä¸€æ ·çš„ï¼Œåªè¦ç³»ç»ŸçŸ¥é“æ‰€æœ‰çš„è¿™äº›è™šæ‹Ÿåœ°å€éƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†å†…å­˜åœ°å€ï¼Œå¹¶ç”¨ç‰©ç†å†…å­˜åœ°å€æ¥å”¯ä¸€æ ‡è¯†futexå˜é‡ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>&lt;a href="https://www.shuzhiduo.com/A/rV57P2rLdP/">linuxå†…æ ¸çº§åŒæ­¥æœºåˆ¶&amp;ndash;futex&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/farmerjohngit/myblog/issues/6">å…³äºåŒæ­¥çš„ä¸€ç‚¹æ€è€ƒ-ä¸Š Â· Issue #6 Â· farmerjohngit/myblog Â· GitHub&lt;/a>&lt;/p>
&lt;/li>
&lt;li>&lt;/li>
&lt;/ol></description></item><item><title>ToyDB</title><link>https://justice.bj.cn/post/14.language/rust/rust%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E4%B9%8Btoydb/</link><pubDate>Mon, 06 Jun 2022 20:41:30 +0800</pubDate><guid>https://justice.bj.cn/post/14.language/rust/rust%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E4%B9%8Btoydb/</guid><description>&lt;h1 id="toydb">ToyDB&lt;/h1>
&lt;hr>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;ul>
&lt;li>&lt;code>toydb&lt;/code>æ˜¯&lt;code>Erik Grinaker&lt;/code>ä¸ºå­¦ä¹ &lt;code>rust&lt;/code>è¯­è¨€è€Œå¼€å‘çš„åˆ†å¸ƒå¼sqlæ•°æ®åº“ï¼Œæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹;&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="æ¶æ„">æ¶æ„&lt;/h2>
&lt;p>&lt;code>toydb&lt;/code>ä¸»è¦ç”±3éƒ¨åˆ†ç»„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>sqlengine&lt;/code>: è´Ÿè´£sqlè¯­å¥çš„è§£æã€æ‰§è¡Œè®¡åˆ’ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>raftengine&lt;/code>: è´Ÿè´£å­˜å‚¨å±‚çš„æ•°æ®å‰¯æœ¬åŒæ­¥ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>storage&lt;/code>: è´Ÿè´£æä¾›kvåŠmvccå­˜å‚¨ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2021/10/07-18-54-21-2021-10-07-18-54-16-image.png" alt="">&lt;/p>
&lt;h2 id="sqlå±‚">SQLå±‚&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>SQLå±‚ä¸»è¦è´Ÿè´£å°†è¾“å…¥çš„sqlè¯­å¥å­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ‰§è¡Œè®¡åˆ’ï¼Œå¹¶é€šè¿‡raftäº¤ç»™å„ä¸ªå‰¯æœ¬çš„mvccå­˜å‚¨å¼•æ“æ‰§è¡Œï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SQLä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è¯æ³•åˆ†æï¼šsqlè¯­å¥&amp;mdash;&amp;mdash;-&amp;gt;token&amp;mdash;-&amp;gt;ASTï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼šAST&amp;mdash;&amp;ndash;&amp;gt;planner&amp;mdash;&amp;ndash;&amp;gt;ä¼˜åŒ–&amp;mdash;&amp;ndash;&amp;gt;æ‰§è¡Œï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>SQLè¯­å¥ &amp;ndash;&amp;gt; è¯æ³•åˆ†æ &amp;mdash;-&amp;gt; è¯­æ³•åˆ†æ&amp;mdash;&amp;gt;ç”Ÿæˆæ‰§è¡Œè®¡åˆ’&amp;mdash;&amp;gt;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2021/06/18-16-00-47-2021-06-18-16-00-44-image.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2021/06/18-15-38-36-2021-06-18-15-38-32-image.png" alt="">&lt;/p>
&lt;h3 id="è¯æ³•åˆ†ælexer">è¯æ³•åˆ†æ(Lexer)&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>Lexer ä¹Ÿç§°ä¸ºåˆ†è¯ï¼Œä»å·¦å‘å³æ‰«æSQLï¼Œå°†å…¶åˆ†å‰²æˆä¸€ä¸ªä¸ªçš„toke(è¯å…ƒ)ï¼Œåœ¨å°†tokenç»„è£…ä¸ºAST(Abstract Tree);&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Lexerçš„å®ç°ä¸€èˆ¬éƒ½æ˜¯æ„é€ DFA(ç¡®å®šæ€§æœ‰é™çŠ¶æ€è‡ªåŠ¨æœº)æ¥å®ç°çš„ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>çŠ¶æ€è½¬ç§»å›¾å¦‚ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªèƒ½å¤Ÿè¯†åˆ«æ ‡è¯†ç¬¦ï¼Œæ•°å­—å’Œä¸€èˆ¬è¿ç®—ç¬¦çš„è¯æ³•è§£æå™¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2021/06/18-14-44-04-2021-06-18-14-44-00-image.png" alt="">&lt;/p>
&lt;h3 id="è¯­æ³•åˆ†æparser">è¯­æ³•åˆ†æ(Parser)&lt;/h3>
&lt;p>Parseré˜¶æ®µæœ‰ä¸¤ç§ç±»å‹æ–¹æ³•æ¥å®ç°:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¸€ç§æ˜¯è‡ªé¡¶å‘ä¸‹åˆ†ææ³•ï¼Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦ä¸€ç§æ˜¯è‡ªåº•å‘ä¸Šåˆ†ææ³•ï¼Œ&lt;/p>
&lt;p>ç®€å•ä»‹ç»ä¸€ä¸‹ä¸¤ç§ç±»å‹åˆ†ææ³•çš„å¤„ç†æ€è·¯ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ‰§è¡Œè®¡åˆ’">æ‰§è¡Œè®¡åˆ’&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">SQL String ---è¯æ³•åˆ†æ&amp;lt;Lexer&amp;gt;--&amp;gt; Token --&amp;lt;è¯­æ³•åˆ†æ&amp;gt;--&amp;gt; AST Statement
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="sql-engine">Sql Engine&lt;/h2>
&lt;h3 id="parserè§£é‡Šå™¨">Parser(è§£é‡Šå™¨)&lt;/h3>
&lt;h3 id="planner">Planner&lt;/h3>
&lt;h3 id="executor">Executor&lt;/h3>
&lt;h2 id="storageå­˜å‚¨">Storage(å­˜å‚¨)&lt;/h2>
&lt;h3 id="memory">Memory&lt;/h3>
&lt;h2 id="mvcc">MVCC&lt;/h2>
&lt;h2 id="raft-engine">Raft Engine&lt;/h2>
&lt;p>&lt;code>toydb&lt;/code> é€šè¿‡raftæ¥å®ç°å„èŠ‚ç‚¹é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå…¶è‡ªå¸¦çš„raftæ¨¡å—ç”±rustè¯­è¨€æä¾›çš„ä¸€ä¸ªç®€å•çš„å®ç°ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2021/10/08-13-34-25-2021-10-08-13-34-19-image.png" alt="">&lt;/p>
&lt;p>Raftå†…éƒ¨æœ‰2ä¸ªçŠ¶æ€æœºï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¤åˆ¶çŠ¶æ€æœº(): ä¸»è¦ç”¨äºæ—¥å¿—å¤åˆ¶ï¼Œä¿è¯å„ä¸ªå‰¯æœ¬æ—¥å¿—çš„è½ç›˜åŠä¸€è‡´ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŒ‡ä»¤çŠ¶æ€æœº(&lt;code>State&lt;/code>): ä¸»è¦ä½œç”¨æ˜¯æ ¹æ®æ—¥å¿—æ‰§è¡ŒæŒ‡ä»¤ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ç”±äºå¤åˆ¶çŠ¶æ€æœºçš„Raftåè®®å¯ä»¥ä¿è¯æ—¥å¿—åºåˆ—çš„å”¯ä¸€æ€§ï¼Œæ‰€ä»¥ç”±æ—¥å¿—é©±åŠ¨çš„ä¸åŒå‰¯æœ¬çš„æŒ‡ä»¤çŠ¶æ€æœºå°†æ‹¥æœ‰ç›¸åŒçš„è¾“å…¥æŒ‡ä»¤åºåˆ—ï¼Œåœ¨åˆå§‹çŠ¶æ€ç›¸åŒçš„æƒ…å†µä¸‹ï¼ŒæŒ‡ä»¤çŠ¶æ€æœºå°†ä¼šå¾—åˆ°ç›¸åŒçš„è¾“å‡ºï¼Œä»¥æ­¤å°±ä¿è¯äº†å„ä¸ªå‰¯æœ¬å¤–éƒ¨æœ€ç»ˆçŠ¶æ€çš„ä¸€è‡´æ€§ï¼›&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¤åˆ¶çŠ¶æ€æœºæ˜¯raftåè®®çš„æ ¸å¿ƒï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŒ‡ä»¤çŠ¶æ€æœºç”±raftæ—¥å¿—é©±åŠ¨æ¥æ”¹å˜å¤–ç•ŒçŠ¶æ€ï¼Œæ˜¯raftåè®®å’Œå¤–ç•Œäº¤äº’çš„æ¥å£ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="evenloop">EvenLoop&lt;/h2>
&lt;p>&lt;code>Raft&lt;/code> çš„ä¸»é©±åŠ¨æ˜¯&lt;code>EvenLoop&lt;/code>ã€‚èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œä¼šå¼€å¯ä¸€ä¸ª&lt;code>evenloop&lt;/code>åå°å¼‚æ­¥ä»»åŠ¡ï¼ŒæŒç»­ç›‘å¬&lt;code>tick&lt;/code>, &lt;code>tcp_in_tx&lt;/code>, &lt;code>client_rx&lt;/code>, &lt;code>node_rx&lt;/code>è¿™4ä¸ªäº‹ä»¶æºä¸Šçš„æ¶ˆæ¯&lt;code>Msg&lt;/code>ï¼Œä»¥æ­¤æ¥é©±åŠ¨æ•´ä¸ªçŠ¶æ€æœºçš„è¿è¡Œï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>tick&lt;/code>äº‹ä»¶ç”±å®šæ—¶å™¨äº§ç”Ÿï¼Œè½¬å…¥ç›¸åº”rolenodeçš„&lt;code>tick&lt;/code>å¤„ç†ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>tcp_in_tx&lt;/code>äº‹ä»¶ç”±å…¶ä»–èŠ‚ç‚¹peeräº§ç”Ÿï¼Œäº¤ç”±&lt;code>raft&lt;/code> çŠ¶æ€æœº&lt;code>step&lt;/code>å¤„ç†ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>node_rx&lt;/code>äº‹ä»¶ç”±èŠ‚ç‚¹å†…éƒ¨äº§ç”Ÿï¼Œéœ€æ ¹æ®äº‹ä»¶æ¶ˆæ¯çš„æ¥æ”¶å¯¹è±¡(&lt;code>to&lt;/code>)åˆ†åˆ«å¤„ç†ï¼›&lt;/p>
&lt;ul>
&lt;li>å‘å¾€å‰¯æœ¬ï¼ˆ&lt;code>to&lt;/code>ä¸º&lt;code>Address::Peer&lt;/code>, &lt;code>Address::Peers&lt;/code>ï¼‰çš„æ¶ˆæ¯ï¼Œæ”¾å…¥&lt;code>tcp_tx&lt;/code>äº¤ç”±&lt;code>TcpSender&lt;/code>è¿›è¡Œå‘é€ï¼›&lt;/li>
&lt;li>å‘å¾€&lt;code>Client&lt;/code>ï¼ˆ&lt;code>Address::Client&lt;/code>ï¼‰ ä¸”äº‹ä»¶ç±»å‹ä¸º&lt;code>Event::ClientResponse&lt;/code>çš„æ¶ˆæ¯, æ ¹æ®&lt;code>id&lt;/code>ä»&lt;code>requests&lt;/code>è¡¨ä¸­æ‰¾åˆ°è¯¥æ¶ˆæ¯å“åº”rx&lt;code>response_tx&lt;/code>ï¼Œé€šè¿‡&lt;code>response_tx&lt;/code>å°†æ¶ˆæ¯å“åº”å›å¤ç»™&lt;code>Client&lt;/code>;&lt;/li>
&lt;li>å…¶ä»–æ¶ˆæ¯ä¸ºéæ³•æ¶ˆæ¯, æŠ¥é”™å¹¶é€€å‡ºï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>client_rx&lt;/code>äº‹ä»¶ç”±å®¢æˆ·ç«¯äº§ç”Ÿï¼Œå¤„ç†å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å…ˆä¸ºäº‹ä»¶ç”Ÿæˆuuidä½œä¸ºå”¯ä¸€idï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»¥idä¸ºkey, å°†æ¶ˆæ¯å“åº”rx&lt;code>request_rx&lt;/code>æ”¾å…¥&lt;code>requests&lt;/code> å“ˆå¸Œè¡¨ä¸­ï¼Œè¯¥è¡¨ç”¨äºåç»­æ¶ˆæ¯å“åº”æ—¶å¤„ç†æ¶ˆæ¯è¿”å›ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç”Ÿæˆä¸€ä¸ª&lt;code>ClientRequest&lt;/code>ç±»å‹çš„æ¶ˆæ¯ ï¼Œäº¤ç”±&lt;code>Rolenode&lt;/code>çš„&lt;code>step&lt;/code>å¤„ç†ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Evenloop&lt;/code>æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œé€šè¿‡&lt;code>tick()&lt;/code>, &lt;code>step()&lt;/code>æ¥é©±åŠ¨å¤åˆ¶çŠ¶æ€æœºæ‰§è¡Œæ—¥å¿—å¤åˆ¶æ“ä½œã€‚&lt;/p>
&lt;p>å„èŠ‚ç‚¹æ”¶åˆ°&lt;code>ClientRequest&lt;/code>åå¤„ç†æµç¨‹&lt;code>Step()&lt;/code>ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Candidate&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>å°†&lt;code>ClientRequest&lt;/code>æ¶ˆæ¯æ”¾å…¥&lt;code>queued_reqs&lt;/code>é˜Ÿåˆ—ä¸­è¿›è¡Œç¼“å­˜ï¼Œç­‰å¾…å˜ä¸º&lt;code>Leader&lt;/code>åï¼Œå†ä¾æ¬¡å¤„ç†ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Follower&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœæ²¡æœ‰&lt;code>Leader&lt;/code>ï¼Œ åˆ™ä¹Ÿå°†æ¶ˆæ¯æ”¾å…¥&lt;code>queued_reqs&lt;/code>ä¸­ç¼“å­˜ï¼›// queud_reqs åç»­å¤„ç†?&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœæœ‰&lt;code>Leader&lt;/code>, åˆ™å°†æ¶ˆæ¯(id, from)æ”¾å…¥&lt;code>proxied_reqs&lt;/code>ä¸­è®°å½•ä¸‹æ¥ï¼Œç„¶åè½¬å‘åˆ°&lt;code>Leader&lt;/code>ï¼Œç”±&lt;code>Leader&lt;/code>å¤„ç†ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Leader&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Request::Query&lt;/code>æ¶ˆæ¯ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>é€šè¿‡&lt;code>state_tx&lt;/code>ï¼Œå‘çŠ¶æ€æœºå‘é€&lt;code>Instruction::Query&lt;/code>æŒ‡ä»¤ï¼ŒçŠ¶æ€æœºå°†æŒ‡ä»¤æ’å…¥åˆ°&lt;code>queries&lt;/code>ä¸­ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡&lt;code>state_tx&lt;/code>, å‘çŠ¶æ€æœºå‘é€&lt;code>Instruction::Vote&lt;/code>æŒ‡ä»¤, ç»Ÿè®¡ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è‹¥å­˜åœ¨å‰¯æœ¬ï¼Œåˆ™å‘å‰¯æœ¬å‘é€&lt;code>Event::Heartbeat&lt;/code>æ¶ˆæ¯ï¼Œå’Œ&lt;code>Follower&lt;/code>ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Request::Mutate&lt;/code>æ¶ˆæ¯ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å°†æ¶ˆæ¯è®°å½•åˆ°æœ¬åœ°logä¸­;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¤åˆ¶logåˆ°å„ä¸ªFollowerï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¥æ”¶åˆ°å¤šæ•°&lt;code>Follower&lt;/code>çš„ç¡®è®¤æ¶ˆæ¯åï¼Œcommitæ¶ˆæ¯ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç»™çŠ¶æ€æœºå‘é€&lt;code>Instruction::Notify&lt;/code>æŒ‡ä»¤ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœ&lt;code>peers&lt;/code>ä¸ºç©ºï¼Œæäº¤ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Request::Status&lt;/code>æ¶ˆæ¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æ ¹æ®å½“å‰èŠ‚ç‚¹çŠ¶æ€ï¼Œç”Ÿæˆ&lt;code>Instruction::Status&lt;/code>ï¼Œé€šè¿‡&lt;code>state_tx&lt;/code>äº¤ç”±çŠ¶æ€æœºæ‰§è¡Œï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="æŒ‡ä»¤çŠ¶æ€æœº">æŒ‡ä»¤çŠ¶æ€æœº&lt;/h3>
&lt;p>æŒ‡ä»¤çŠ¶æ€æœºç”±&lt;code>Driver::drive()&lt;/code>é©±åŠ¨ã€‚æ¯ä¸ªRaft Nodeæ–°å»ºæ—¶ï¼Œä¼šå¼€å¯ä¸€ä¸ªdriveråå°ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä»&lt;code>state_rx&lt;/code>æ¥æ”¶æŒ‡ä»¤ï¼Œäº¤ç”±&lt;code>execute&lt;/code>å¤„ç†ï¼Œå„æŒ‡ä»¤å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Instruction::Abort&lt;/code>:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Instruction::Apply&lt;/code>:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Instruction::Notify&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœæŒ‡ä»¤&lt;code>index&lt;/code>å¤§äºçŠ¶æ€æœºå·²ç»&lt;code>applied_index&lt;/code>, å°†(index, (address, id))æ’å…¥åˆ°çŠ¶æ€æœº&lt;code>notify&lt;/code>å“ˆå¸Œè¡¨ä¸­ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦åˆ™æŒ‡ä»¤å·²è¢«åº”ç”¨è¿‡ï¼Œé€šè¿‡&lt;code>node_tx&lt;/code>ç»™Raft Node å‘é€&lt;code>ClientResponse&lt;/code>æ¶ˆæ¯ï¼Œç”±Raft Nodeå°†é”™è¯¯æ¶ˆæ¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼›&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Instruction::Query&lt;/code>:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Instruction::Status&lt;/code>:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Instruction::Vote&lt;/code>:&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="æºç ">æºç &lt;/h2>
&lt;ul>
&lt;li>&lt;strong>Log&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Log&lt;/code>(æ—¥å¿—)æ˜¯RaftçŠ¶æ€æœº&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="sd">/// The replicated Raft log
&lt;/span>&lt;span class="sd">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Log&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">super&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">store&lt;/span>: &lt;span class="nb">Box&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">dyn&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>::&lt;span class="n">Store&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">super&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">last_index&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">super&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">last_term&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">super&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">commit_index&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">super&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">commit_term&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;strong>Driver&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">//çŠ¶æ€æœºæ¥å£
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>: &lt;span class="nb">Send&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">applied_index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="kt">u64&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">mutate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">index&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">command&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//ä¿®æ”¹çŠ¶æ€æœºçŠ¶æ€
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">command&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//æŸ¥è¯¢çŠ¶æ€æœº
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">//çŠ¶æ€æœºé©±åŠ¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Driver&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">state_rx&lt;/span>: &lt;span class="nc">mpsc&lt;/span>::&lt;span class="n">UnboundedReceiver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//çŠ¶æ€æœºæŒ‡ä»¤è¾“å…¥å£
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node_tx&lt;/span>: &lt;span class="nc">mpsc&lt;/span>::&lt;span class="n">UnboundedSender&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Message&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//raftåè®®æ¶ˆæ¯è¾“å‡ºå£
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">applied_index&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">notify&lt;/span>: &lt;span class="nc">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Address&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//é€šçŸ¥å®¢æˆ·ç«¯æ›´æ”¹è¢«é‡‡ç”¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queries&lt;/span>: &lt;span class="nc">BTreeMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTreeMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//ç­‰å¾…å¤„ç†çš„å®¢æˆ·ç«¯æŸ¥è¯¢æŒ‡ä»¤ï¼Œ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// çŠ¶æ€æœºæŒ‡ä»¤
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">enum&lt;/span> &lt;span class="nc">Instruction&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Abort&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//å–æ¶ˆ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Apply&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>: &lt;span class="nc">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">},&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//åº”ç”¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Notify&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>: &lt;span class="nc">Address&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">index&lt;/span>: &lt;span class="kt">u64&lt;/span> &lt;span class="p">},&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//é€šçŸ¥
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>: &lt;span class="nc">Address&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">command&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">term&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">index&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">quorum&lt;/span>: &lt;span class="kt">u64&lt;/span> &lt;span class="p">},&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//æŸ¥è¯¢
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Status&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>: &lt;span class="nc">Address&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">status&lt;/span>: &lt;span class="nb">Box&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Status&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">},&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//çŠ¶æ€æœºçŠ¶æ€
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Vote&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">term&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">index&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>: &lt;span class="nc">Address&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">},&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//æŠ•ç¥¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="raftè§’è‰²">Raftè§’è‰²&lt;/h3>
&lt;h4 id="leader">Leader&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="c1">// èŠ‚ç‚¹å…±æœ‰å±æ€§
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">RoleNode&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">R&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>: &lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//èŠ‚ç‚¹id
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">peers&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">term&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>: &lt;span class="nc">Log&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pre_vote&lt;/span>: &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node_tx&lt;/span>: &lt;span class="nc">mpsc&lt;/span>::&lt;span class="n">UnboundedSender&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Message&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//å’Œnodeä¹‹é—´å‘é€Msgé€šé“
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">state_tx&lt;/span>: &lt;span class="nc">mpsc&lt;/span>::&lt;span class="n">UnboundedSender&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//èŠ‚ç‚¹å¾€çŠ¶æ€æœºé©±åŠ¨å‘é€çŠ¶æ€æœºæŒ‡ä»¤é€šé“
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queued_reqs&lt;/span>: &lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Address&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Event&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">proxied_reqs&lt;/span>: &lt;span class="nc">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">Vec&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">u8&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Address&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">role&lt;/span>: &lt;span class="nc">R&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// leaderä¸“æœ‰å±æ€§å­—æ®µ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Leader&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">heartbeat_ticks&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//å¿ƒè·³è®¡æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">peer_next_index&lt;/span>: &lt;span class="nc">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">u64&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//å¤åˆ¶åˆ°å‰¯æœ¬çš„ä¸‹ä¸€ä¸ªindex
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">peer_last_index&lt;/span>: &lt;span class="nc">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">u64&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">//å·²çŸ¥å¤åˆ¶åˆ°å‰¯æœ¬çš„æœ€åindex
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// followerä¸“æœ‰å­—æ®µ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Follower&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">leader&lt;/span>: &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">leader_seen_ticks&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">leader_seen_timeout&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">voted_for&lt;/span>: &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// candidateä¸“æœ‰å­—æ®µ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Candidate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">election_ticks&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">election_timeout&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">votes&lt;/span>: &lt;span class="kt">u64&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://github.com/erikgrinaker/toydb">GitHub - erikgrinaker/toydb: Distributed SQL database in Rust, written as a learning project&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/erikgrinaker/toydb/blob/master/docs/architecture.md">toydb/architecture.md at master Â· erikgrinaker/toydb Â· GitHub&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>AF_XDP</title><link>https://justice.bj.cn/post/21.linux/af_xdp/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/af_xdp/</guid><description>&lt;h1 id="af_xdp">AF_XDP&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;p>&lt;strong>AF_XDP&lt;/strong>æ˜¯ä¸€ç§ç”¨äºé«˜æ€§èƒ½åŒ…å¤„ç†çš„åœ°å€ç°‡(Address Family)ã€‚&lt;/p>
&lt;p>ä½¿ç”¨XDPç¨‹åºä¸­çš„&lt;strong>XDP_REDIRECT&lt;/strong>æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨&lt;code>bpf_redirect_mapï¼ˆï¼‰&lt;/code>å‡½æ•°å°†å…¥å£å¸§é‡å®šå‘åˆ°å…¶ä»–å¯ç”¨XDPçš„ç½‘ç»œè®¾å¤‡ã€‚ AF_XDPå¥—æ¥å­—ä½¿XDPç¨‹åºå¯ä»¥å°†å¸§é‡å®šå‘åˆ°ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜ç¼“å†²åŒºã€‚&lt;/p>
&lt;p>å¯ä»¥é€šè¿‡&lt;code>socket()&lt;/code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºAF_XDP socket (XSK)ã€‚æ¯ä¸ªXSKæ¶‰åŠä¸¤ä¸ªringï¼šRX ringå’ŒTX ringã€‚ä¸€ä¸ªsocketå¯ä»¥ä»RX ringä¸Šæ¥æ”¶æŠ¥æ–‡ï¼Œå¹¶å‘é€åˆ°TX ringã€‚è¿™ä¸¤ä¸ªringsåˆ†åˆ«é€šè¿‡socketé€‰é¡¹&lt;code>XDP_RX_RING&lt;/code>Â å’Œ&lt;code>XDP_TX_RING&lt;/code>è¿›è¡Œæ³¨å†Œã€‚æ¯ä¸ªsocketå¿…é¡»è‡³å°‘å…·æœ‰å…¶ä¸­ä¸€ä¸ªringã€‚RXæˆ–TX ringæè¿°ç¬¦æŒ‡å‘å†…å­˜åŸŸä¸­çš„data bufferï¼Œç§°ä¸ºUMEMã€‚RXå’ŒTXå¯ä»¥å…±äº«ç›¸åŒçš„UMEMï¼Œè¿™æ ·ä¸€ä¸ªæŠ¥æ–‡æ— éœ€åœ¨RXå’ŒTXä¹‹é—´è¿›è¡Œæ‹·è´ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªæŠ¥æ–‡ç”±äºé‡ä¼ éœ€è¦ä¿ç•™ä¸€æ®µæ—¶é—´ï¼Œåˆ™æŒ‡å‘è¯¥æŠ¥æ–‡çš„æè¿°ç¬¦å¯ä»¥æŒ‡å‘å¦å¤–ä¸€ä¸ªæŠ¥æ–‡ï¼Œè¿™æ ·å°±é¿å…äº†æ•°æ®çš„æ‹·è´ã€‚åŸºæœ¬æµç¨‹&lt;a href="https://www.dpdk.org/wp-content/uploads/sites/35/2018/10/pm-06-DPDK-PMD-for-AF_XDP.pdf">å¦‚ä¸‹&lt;/a>ï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-11-39-2020-09-30-17-18-13-image.png" alt="">&lt;/p>
&lt;p>UMEMåŒ…å«ä¸€ç³»åˆ—å¤§å°ç›¸åŒçš„chunksï¼Œringä¸­çš„æè¿°ç¬¦é€šè¿‡å¼•ç”¨å¸§çš„åœ°å€æ¥å¼•ç”¨è¯¥å¸§ï¼Œè¯¥åœ°å€ä¸ºæ•´ä¸ªUMEMåŸŸçš„åç§»é‡ã€‚ç”¨æˆ·ç©ºé—´ä¼šä½¿ç”¨åˆé€‚çš„æ–¹å¼(mallocï¼Œmmapï¼Œå¤§é¡µå†…å­˜ç­‰)ä¸ºUMEMåˆ†é…å†…å­˜ï¼Œç„¶åä½¿ç”¨ä½¿ç”¨æ–°çš„socketé€‰é¡¹&lt;code>XDP_UMEM_REG&lt;/code>å°†å†…å­˜åŸŸæ³¨å†Œåˆ°å†…æ ¸ä¸­ã€‚UMEMä¹ŸåŒ…å«ä¸¤ä¸ªringï¼šFILL ringå’ŒCOMPLETION ringã€‚åº”ç”¨ä¼šä½¿ç”¨FILL ringä¸‹å‘addrï¼Œè®©å†…æ ¸å¡«å†™RXåŒ…æ•°æ®ã€‚ä¸€æ—¦æ¥æ”¶åˆ°æŠ¥æ–‡ï¼ŒRX ringä¼šå¼•ç”¨è¿™äº›å¸§ã€‚COMPLETION ringåŒ…å«å†…æ ¸ä¼ è¾“å®Œçš„å¸§åœ°å€ï¼Œä¸”å¯ä»¥è¢«ç”¨æˆ·ç©ºé—´ä½¿ç”¨ï¼Œç”¨äºTXæˆ–RXã€‚å› æ­¤COMPLETION ringä¸­çš„å¸§åœ°å€ä¸ºå…ˆå‰ä½¿ç”¨TX ringä¼ è¾“çš„åœ°å€ã€‚æ€»ä¹‹ï¼ŒRXå’ŒFILL ringç”¨äºRXè·¯å¾„ï¼ŒTXå’ŒCOMPLETION ringç”¨äºTXè·¯å¾„ã€‚&lt;/p>
&lt;p>æœ€åä¼šä½¿ç”¨bind()è°ƒç”¨å°†socketç»‘å®šåˆ°ä¸€ä¸ªè®¾å¤‡ä»¥åŠè¯¥è®¾å¤‡æŒ‡å®šçš„é˜Ÿåˆ—idä¸Šï¼Œç»‘å®šæ²¡æœ‰å®Œæˆå‰æ— æ³•ä¼ è¾“æµé‡ã€‚&lt;/p>
&lt;p>æœ€åä¼šä½¿ç”¨bind()è°ƒç”¨å°†socketç»‘å®šåˆ°ä¸€ä¸ªè®¾å¤‡ä»¥åŠè¯¥è®¾å¤‡æŒ‡å®šçš„é˜Ÿåˆ—idä¸Šï¼Œç»‘å®šæ²¡æœ‰å®Œæˆå‰æ— æ³•ä¼ è¾“æµé‡ã€‚&lt;/p>
&lt;p>å¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«UMEM ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹éœ€è¦æ›´æ–°UMEMï¼Œåˆ™ä¼šè·³è¿‡æ³¨å†ŒUMEMå’Œå…¶å¯¹åº”çš„ä¸¤ä¸ªringçš„è¿‡ç¨‹ã€‚åœ¨bindè°ƒç”¨ä¸­è®¾ç½®&lt;code>XDP_SHARED_UMEM&lt;/code>Â æ ‡å¿—ï¼Œå¹¶æäº¤è¯¥è¿›ç¨‹æœŸæœ›å…±äº«UMEMçš„XSKï¼Œä»¥åŠæ–°åˆ›å»ºçš„XSK socketã€‚æ–°è¿›ç¨‹ä¼šåœ¨å…¶å…±äº«UMEMçš„RX ringä¸­æ¥æ”¶åˆ°å¸§åœ°å€å¼•ç”¨ã€‚æ³¨æ„ï¼Œç”±äºringçš„ç»“æ„æ˜¯å•ç”Ÿäº§è€…/å•æ¶ˆè´¹è€…çš„ï¼Œæ–°çš„è¿›ç¨‹çš„socketå¿…é¡»åˆ›å»ºç‹¬ç«‹çš„RXå’ŒTX ringã€‚åŒæ ·çš„åŸå› ï¼Œæ¯ä¸ªUMEMä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªFILLå’ŒCOMPLETION ringã€‚æ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦æ­£ç¡®åœ°å¤„ç†å¥½UMEMã€‚&lt;/p>
&lt;p>é‚£ä¹ˆæŠ¥æ–‡æ˜¯æ€ä¹ˆä»XDPç¨‹åºåˆ†å‘åˆ°XSKsçš„å‘¢ï¼Ÿé€šè¿‡åä¸º&lt;code>XSKMAP&lt;/code>(å®Œæ•´åä¸ºBPF_MAP_TYPE_XSKMAP`) BPF mapã€‚ç”¨æˆ·ç©ºé—´çš„åº”ç”¨å¯ä»¥å°†ä¸€ä¸ªXSKæ”¾åˆ°è¯¥mapçš„ä»»æ„ä½ç½®ï¼Œç„¶åXDPç¨‹åºå°±å¯ä»¥å°†ä¸€ä¸ªæŠ¥æ–‡é‡å®šå‘åˆ°è¯¥mapä¸­æŒ‡å®šçš„ç´¢å¼•ä¸­ï¼Œæ­¤æ—¶XDPä¼šæ ¡éªŒmapä¸­çš„XSKç¡®å®ç»‘å®šåˆ°è¯¥è®¾å¤‡å’Œringå·ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥æŠ¥æ–‡ã€‚å¦‚æœmapä¸­çš„ç´¢å¼•ä¸ºç©ºï¼Œä¹Ÿä¼šä¸¢å¼ƒè¯¥æŠ¥æ–‡ã€‚å› æ­¤ï¼Œå½“å‰çš„å®ç°ä¸­å¼ºåˆ¶è¦æ±‚å¿…é¡»åŠ è½½ä¸€ä¸ªXDPç¨‹åº(ä»¥åŠä¿è¯XSKMAPå­˜åœ¨ä¸€ä¸ªXSK)ï¼Œè¿™æ ·æ‰èƒ½é€šè¿‡XSKå°†æµé‡ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚&lt;/p>
&lt;p>AF_XDPå¯ä»¥è¿è¡Œåœ¨ä¸¤ç§æ¨¡å¼ä¸Šï¼š&lt;code>XDP_SKB&lt;/code>å’Œ&lt;code>XDP_DRV&lt;/code>ã€‚å¦‚æœé©±åŠ¨ä¸æ”¯æŒXDPï¼Œåˆ™åœ¨åŠ è½½XDPç¨‹åºæ˜¯éœ€è¦æ˜ç¡®æŒ‡å®šä½¿ç”¨XDP_SKBï¼Œ&lt;code>XDP_SKB&lt;/code>æ¨¡å¼ä½¿ç”¨SKBå’Œé€šç”¨çš„XDPåŠŸèƒ½ï¼Œå¹¶å°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ˜¯ä¸€ç§é€‚ç”¨äºä»»ä½•ç½‘ç»œè®¾å¤‡çš„å›é€€æ¨¡å¼ã€‚ å¦‚æœé©±åŠ¨æ”¯æŒXDPï¼Œå°†ä½¿ç”¨AF_XDPä»£ç æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œä½†ä»ç„¶ä¼šå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„æ“ä½œã€‚&lt;/p>
&lt;h5 id="æœ¯è¯­">æœ¯è¯­&lt;/h5>
&lt;h6 id="umem-umemæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è¿ç»­å†…å­˜åŸŸåˆ†å‰²ä¸ºç›¸åŒå¤§å°çš„å¸§">UMEM: UMEMæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è¿ç»­å†…å­˜åŸŸï¼Œåˆ†å‰²ä¸ºç›¸åŒå¤§å°çš„å¸§ã€‚&lt;/h6>
&lt;p>ä¸€ä¸ªUMEMä¼šå…³è”ä¸€ä¸ªnetdevä»¥åŠè¯¥netdevçš„é˜Ÿåˆ—idã€‚é€šè¿‡&lt;code>XDP_UMEM_REG&lt;/code>Â socketé€‰é¡¹è¿›è¡Œåˆ›å»ºå’Œé…ç½®(chunkå¤§å°ï¼Œheadroomï¼Œå¼€å§‹åœ°å€å’Œå¤§å°)ã€‚é€šè¿‡&lt;code>bind()&lt;/code>ç³»ç»Ÿè°ƒç”¨å°†ä¸€ä¸ªUMEMç»‘å®šåˆ°ä¸€ä¸ªnetdevå’Œé˜Ÿåˆ—idã€‚umemçš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-11-49-1334952-20200807102005413-1869804955.png" alt="">&lt;/p>
&lt;p>ä¸€ä¸ªAF_XDPä¸ºä¸€ä¸ªé“¾æ¥åˆ°ä¸€ä¸ªç‹¬ç«‹çš„UMEMçš„socketï¼Œä½†ä¸€ä¸ªUMEMå¯ä»¥æœ‰å¤šä¸ªAF_XDP socketã€‚ä¸ºäº†å…±äº«ä¸€ä¸ªé€šè¿‡socket Aåˆ›å»ºçš„UMEMï¼Œsocket Bå¯ä»¥å°†ç»“æ„ä½“&lt;code>sockaddr_xdp&lt;/code>ä¸­çš„æˆå‘˜sxdp_flagsè®¾ç½®ä¸º&lt;code>XDP_SHARED_UMEM&lt;/code>ï¼Œå¹¶å°†Açš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™ç»“æ„ä½“&lt;code>sockaddr_xdp&lt;/code>çš„æˆå‘˜&lt;code>sxdp_shared_umem_fd&lt;/code>ã€‚&lt;/p>
&lt;p>UMEMæœ‰ä¸¤ä¸ªå•ç”Ÿäº§è€…/å•æ¶ˆè´¹è€…ringï¼Œç”¨äºåœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºä¹‹é—´è½¬ç§»UMEMå¸§ã€‚&lt;/p>
&lt;h6 id="rings">Rings&lt;/h6>
&lt;p>æœ‰4ç±»ä¸åŒç±»å‹çš„ringï¼šFILL, COMPLETION, RX å’ŒTXï¼Œæ‰€æœ‰çš„ringéƒ½æ˜¯å•ç”Ÿäº§è€…/å•æ¶ˆè´¹è€…ï¼Œå› æ­¤ç”¨æˆ·ç©ºé—´çš„ç¨‹åºéœ€è¦æ˜¾ç¤ºåœ°åŒæ­¥å¯¹è¿™äº›ringsè¿›è¡Œè¯»/å†™çš„å¤šè¿›ç¨‹/çº¿ç¨‹ã€‚&lt;/p>
&lt;p>UMEMä½¿ç”¨2ä¸ªringï¼šFILLå’ŒCOMPLETIONã€‚æ¯ä¸ªå…³è”åˆ°UMEMçš„socketå¿…é¡»æœ‰1ä¸ªRXé˜Ÿåˆ—ï¼Œ1ä¸ªTXé˜Ÿåˆ—æˆ–åŒæ—¶æ‹¥æœ‰2ä¸ªé˜Ÿåˆ—ã€‚å¦‚æœé…ç½®äº†4ä¸ªsocket(åŒæ—¶ä½¿ç”¨TXå’ŒRX)ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šæœ‰1ä¸ªFILL ringï¼Œ1ä¸ªCOMPLETION ringï¼Œ4ä¸ªTX ringå’Œ4ä¸ªRX ringã€‚&lt;/p>
&lt;p>ringæ˜¯åŸºäºé¦–(ç”Ÿäº§è€…)å°¾(æ¶ˆè´¹è€…)çš„ç»“æ„ã€‚ä¸€ä¸ªç”Ÿäº§è€…ä¼šåœ¨ç»“æ„ä½“xdp_ringçš„produceræˆå‘˜æŒ‡å‡ºçš„ringç´¢å¼•å¤„å†™å…¥æ•°æ®ï¼Œå¹¶å¢åŠ ç”Ÿäº§è€…ç´¢å¼•ï¼›ä¸€ä¸ªæ¶ˆè´¹è€…ä¼šç»“æ„ä½“xdp_ringçš„consumeræˆå‘˜æŒ‡å‡ºçš„ringç´¢å¼•å¤„è¯»å–æ•°æ®ï¼Œå¹¶å¢åŠ æ¶ˆè´¹è€…ç´¢å¼•ã€‚&lt;/p>
&lt;p>å¯ä»¥é€šè¿‡_RING setsockoptç³»ç»Ÿè°ƒç”¨é…ç½®å’Œåˆ›å»ºringï¼Œä½¿ç”¨mmap()ï¼Œå¹¶ç»“åˆåˆé€‚çš„åç§»é‡ï¼Œå°†å…¶æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´&lt;/p>
&lt;p>ringçš„å¤§å°éœ€è¦æ˜¯2æ¬¡å¹‚ã€‚&lt;/p>
&lt;h6 id="umem-fill-ring">UMEM Fill Ring&lt;/h6>
&lt;p>FILL ringç”¨äºå°†UMEMå¸§ä»ç”¨æˆ·ç©ºé—´ä¼ é€’åˆ°å†…æ ¸ç©ºé—´ï¼ŒåŒæ—¶å°†UMEMåœ°å€ä¼ é€’ç»™ringã€‚ä¾‹å¦‚ï¼Œå¦‚æœUMEMçš„å¤§å°ä¸º64kï¼Œä¸”æ¯ä¸ªchunkçš„å¤§å°ä¸º4kï¼Œé‚£ä¹ˆUMEMåŒ…å«16ä¸ªchunkï¼Œå¯ä»¥ä¼ é€’çš„åœ°å€ä¸º0åˆ°64kã€‚&lt;/p>
&lt;p>ä¼ é€’ç»™å†…æ ¸çš„å¸§ç”¨äºingressè·¯å¾„(RX rings)ã€‚&lt;/p>
&lt;p>ç”¨æˆ·åº”ç”¨ä¹Ÿä¼šåœ¨è¯¥ringä¸­ç”ŸæˆUMEMåœ°å€ã€‚æ³¨æ„ï¼Œå¦‚æœä»¥å¯¹é½çš„chunkæ¨¡å¼è¿è¡Œåº”ç”¨ï¼Œåˆ™å†…æ ¸ä¼šå±è”½ä¼ å…¥çš„åœ°å€ã€‚å³ï¼Œå¦‚æœä¸€ä¸ªchunkå¤§å°ä¸º2kï¼Œåˆ™ä¼šå±è”½æ‰log2(2048) LSBçš„åœ°å€ï¼Œæ„å‘³ç€2048, 2050 å’Œ3000éƒ½å°†å¼•ç”¨ç›¸åŒçš„chunkã€‚å¦‚æœç”¨æˆ·åº”ç”¨ä½¿ç”¨éå¯¹å…¶çš„chunkæ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆä¼ å…¥çš„åœ°å€å°†ä¿æŒä¸å˜ã€‚&lt;/p>
&lt;h6 id="umem-completion-ring">UMEM Completion Ring&lt;/h6>
&lt;p>COMPLETION Ringç”¨äºå°†UMEMå¸§ä»å†…æ ¸ç©ºé—´ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¸FILL ringç›¸åŒï¼Œä½¿ç”¨äº†UMEMç´¢å¼•ã€‚&lt;/p>
&lt;p>å·²ç»å‘é€çš„ä»å†…æ ¸ç©ºé—´ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´çš„å¸§è¿˜å¯ä»¥è¢«ç”¨æˆ·ç©ºé—´ä½¿ç”¨ã€‚&lt;/p>
&lt;p>ç”¨æˆ·åº”ç”¨ä¼šæ¶ˆè´¹è¯¥ringç§çš„UMEMåœ°å€ã€‚&lt;/p>
&lt;h6 id="rx-ring">RX Ring&lt;/h6>
&lt;p>RX ringä½äºsocketçš„æ¥æ”¶ä¾§ï¼Œringä¸­çš„æ¯ä¸ªè¡¨é¡¹éƒ½æ˜¯ä¸€ä¸ª&lt;code>xdp_desc&lt;/code>Â ç»“æ„çš„æè¿°ç¬¦ã€‚è¯¥æè¿°ç¬¦åŒ…å«UMEMåç§»é‡(åœ°å€)ä»¥åŠæ•°æ®çš„é•¿åº¦ã€‚&lt;/p>
&lt;p>å¦‚æœæ²¡æœ‰å¸§ä»FILL ringä¼ é€’ç»™å†…æ ¸ï¼Œåˆ™RX ringä¸­ä¸ä¼šå‡ºç°ä»»ä½•æè¿°ç¬¦ã€‚&lt;/p>
&lt;p>ç”¨æˆ·ç¨‹åºä¼šæ¶ˆè´¹è¯¥ringä¸­çš„&lt;code>xdp_desc&lt;/code>æè¿°ç¬¦ã€‚&lt;/p>
&lt;h6 id="tx-ring">TX Ring&lt;/h6>
&lt;p>TX Ringç”¨äºå‘é€å¸§ã€‚åœ¨å¡«å……&lt;code>xdp_desc&lt;/code>(ç´¢å¼•ï¼Œé•¿åº¦å’Œåç§»é‡)æè¿°ç¬¦åä¼ é€’ç»™è¯¥ringã€‚&lt;/p>
&lt;p>å¦‚æœè¦å¯åŠ¨æ•°æ®ä¼ è¾“ï¼Œåˆ™å¿…é¡»è°ƒç”¨&lt;code>sendmsg()&lt;/code>ï¼Œæœªæ¥å¯èƒ½ä¼šæ”¾å®½è¿™ç§é™åˆ¶ã€‚&lt;/p>
&lt;p>ç”¨æˆ·ç¨‹åºä¼šç»™TX ringç”Ÿæˆ&lt;code>xdp_desc&lt;/code>Â æè¿°ç¬¦ã€‚&lt;/p>
&lt;h5 id="xskmap--bpf_map_type_xskmap">XSKMAP / BPF_MAP_TYPE_XSKMAP&lt;/h5>
&lt;p>åœ¨XDPä¾§ä¼šç”¨åˆ°ç±»å‹ä¸º&lt;code>BPF_MAP_TYPE_XSKMAP&lt;/code>Â çš„BPF mapï¼Œå¹¶ç»“åˆ&lt;code>bpf_redirect_map()&lt;/code>å°†ingresså¸§ä¼ é€’ç»™socketã€‚&lt;/p>
&lt;p>ç”¨æˆ·åº”ç”¨ä¼šé€šè¿‡&lt;code>bpf()&lt;/code>ç³»ç»Ÿè°ƒç”¨å°†socketæ’å…¥è¯¥mapã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼Œå¦‚æœä¸€ä¸ªXDPç¨‹åºå°è¯•å°†å¸§é‡å®šå‘åˆ°ä¸€ä¸ªä¸é˜Ÿåˆ—é…ç½®å’Œnetdevä¸åŒ¹é…çš„socketæ—¶ï¼Œä¼šä¸¢å¼ƒè¯¥å¸§ã€‚å³ï¼Œå¦‚æœä¸€ä¸ªAF_XDP socketç»‘å®šåˆ°ä¸€ä¸ªåä¸ºeth0ï¼Œé˜Ÿåˆ—ä¸º17çš„netdevä¸Šæ—¶ï¼Œåªæœ‰å½“XDPç¨‹åºæŒ‡å®šåˆ°eth0ä¸”é˜Ÿåˆ—ä¸º17æ—¶ï¼Œæ‰ä¼šå°†æ•°æ®ä¼ é€’ç»™è¯¥socketã€‚å‚è§&lt;code>samples/bpf/&lt;/code>è·å–ä¾‹å­&lt;/p>
&lt;h5 id="é…ç½®æ ‡å¿—ä½å’Œsocketé€‰é¡¹">é…ç½®æ ‡å¿—ä½å’Œsocketé€‰é¡¹&lt;/h5>
&lt;h6 id="xdp_copy-å’Œxdp_zero_copy-bindæ ‡å¿—">XDP_COPY å’ŒXDP_ZERO_COPY bindæ ‡å¿—&lt;/h6>
&lt;p>å½“ç»‘å®šåˆ°ä¸€ä¸ªsocketæ—¶ï¼Œå†…æ ¸ä¼šé¦–å…ˆå°è¯•ä½¿ç”¨é›¶æ‹·è´è¿›è¡Œæ‹·è´ã€‚å¦‚æœä¸æ”¯æŒé›¶æ‹·è´ï¼Œåˆ™ä¼šå›é€€ä¸ºä½¿ç”¨æ‹·è´æ¨¡å¼ã€‚å³ï¼Œå°†æ‰€æœ‰çš„æŠ¥æ–‡æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚ä½†å¦‚æœæƒ³å¼ºåˆ¶æŒ‡å®šä¸€ç§ç‰¹å®šçš„æ¨¡å¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ ‡å¿—ï¼šå¦‚æœç»™bindè°ƒç”¨ä¼ é€’äº†&lt;code>XDP_COPY&lt;/code>ï¼Œåˆ™å†…æ ¸å°†å¼ºåˆ¶è¿›å…¥æ‹·è´æ¨¡å¼ï¼›å¦‚æœæ²¡æœ‰ä½¿ç”¨æ‹·è´æ¨¡å¼ï¼Œåˆ™bindè°ƒç”¨ä¼šå¤±è´¥ï¼Œå¹¶è¿”å›é”™è¯¯ã€‚ç›¸ååœ°ï¼Œ&lt;code>XDP_ZERO_COPY&lt;/code>Â å°†å¼ºåˆ¶socketä½¿ç”¨é›¶æ‹·è´æˆ–è°ƒç”¨å¤±è´¥ã€‚&lt;/p>
&lt;h6 id="xdp_shared_umem-bind-æ ‡å¿—">XDP_SHARED_UMEM bind æ ‡å¿—&lt;/h6>
&lt;p>è¯¥è¡¨ç¤ºå¯ä»¥ä½¿å¤šä¸ªsocketç»‘å®šåˆ°ç³»ç»Ÿçš„UMEMï¼Œä½†ä»…èƒ½ä½¿ç”¨ç³»ç»Ÿçš„é˜Ÿåˆ—idã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªsocketéƒ½æœ‰å…¶å„è‡ªçš„RXå’ŒTX ringï¼Œä½†UMEMåªèƒ½æœ‰ä¸€ä¸ªFILL ringå’Œä¸€ä¸ªCOMPLETION ringã€‚ä¸ºäº†ä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œéœ€è¦åˆ›å»ºç¬¬ä¸€ä¸ªsocketï¼Œå¹¶ä½¿ç”¨æ­£å¸¸æ¨¡å¼è¿›è¡Œç»‘å®šã€‚ç„¶ååˆ›å»ºç¬¬äºŒä¸ªsocketï¼Œå«ä¸€ä¸ªRXå’Œä¸€ä¸ªTX(æˆ–äºŒè€…ä¹‹ä¸€)ï¼Œä½†ä¸ä¼šåˆ›å»ºFILL æˆ–COMPLETION ring(ä¸ç¬¬ä¸€ä¸ªsocketå…±äº«)ã€‚åœ¨bindè°ƒç”¨ä¸­ï¼Œè®¾ç½®&lt;code>XDP_SHARED_UMEM&lt;/code>é€‰é¡¹ï¼Œå¹¶åœ¨sxdp_shared_umem_fdä¸­æä¾›åˆå§‹socketçš„fdã€‚ä»¥æ­¤ç±»æ¨ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆå½“æ¥æ”¶åˆ°ä¸€ä¸ªæŠ¥æ–‡åï¼Œåº”è¯¥ä¸Šé€åˆ°é‚£ä¸ªsocketå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ç”±XDPç¨‹åºæ¥å†³å®šã€‚å°†æ‰€æœ‰çš„socketæ”¾åˆ°XDP_MAPä¸­ï¼Œç„¶åå°†æŠ¥æ–‡å‘é€ç»™æ•°ç»„ä¸­ç´¢å¼•å¯¹åº”çš„socketã€‚ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªç®€å•çš„ä»¥è½®è¯¢æ–¹å¼åˆ†å‘æŠ¥æ–‡çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;linux/bpf.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;bpf_helpers.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#define MAX_SOCKS 16
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">__uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">BPF_MAP_TYPE_XSKMAP&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">__uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">max_entries&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MAX_SOCKS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">__uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">__uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">xsks_map&lt;/span> &lt;span class="n">SEC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;.maps&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">rr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">SEC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;xdp_sock&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">xdp_sock_prog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">xdp_md&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">rr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">MAX_SOCKS&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">bpf_redirect_map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">xsks_map&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">XDP_DROP&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„ï¼Œç”±äºåªæœ‰ä¸€ä¸ªFILLå’Œä¸€ä¸ªCOMPLETION ringï¼Œä¸”æ˜¯å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„ringï¼Œéœ€è¦ç¡®ä¿å¤šå¤„ç†å™¨æˆ–å¤šçº¿ç¨‹ä¸ä¼šåŒæ—¶ä½¿ç”¨è¿™äº›ringã€‚libbpfæ²¡æœ‰æä¾›åŸå­åŒæ­¥åŠŸèƒ½ã€‚&lt;/p>
&lt;p>å½“å¤šä¸ªsocketç»‘å®šåˆ°ç›¸åŒçš„umemæ—¶ï¼Œlibbpfä¼šä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦åœ¨&lt;code>xsk_socket__create&lt;/code>è°ƒç”¨ä¸­æä¾›&lt;code>XSK_LIBBPF_FLAGS__INHIBIT_PROG_LOAD&lt;/code>Â libbpf_flagï¼Œç„¶åå°†å…¶åŠ è½½åˆ°è‡ªå·±çš„XDPç¨‹åºä¸­(å› ä¸ºlibbpfæ²¡æœ‰å†…ç½®è·¯ç”±æµé‡åŠŸèƒ½)ã€‚&lt;/p>
&lt;h6 id="xdp_use_need_wakeup-bindæ ‡å¿—">XDP_USE_NEED_WAKEUP bindæ ‡å¿—&lt;/h6>
&lt;p>è¯¥é€‰æ‹©æ”¯æŒåœ¨FILL ringå’ŒTX ringä¸­è®¾ç½®ä¸€ä¸ªåä¸º&lt;code>need_wakeup&lt;/code>çš„æ ‡å¿—ï¼Œç”¨æˆ·ç©ºé—´ä½œä¸ºè¿™äº›ringçš„ç”Ÿäº§è€…ã€‚å½“åœ¨bindè°ƒç”¨ä¸­è®¾ç½®äº†è¯¥é€‰é¡¹ï¼Œå¦‚æœéœ€è¦æ˜ç¡®åœ°é€šè¿‡ç³»ç»Ÿè°ƒç”¨å”¤é†’å†…æ ¸æ¥ç»§ç»­å¤„ç†æŠ¥æ–‡æ—¶ï¼Œä¼šè®¾ç½®&lt;code>need_wakeup&lt;/code>Â æ ‡å¿—ã€‚&lt;/p>
&lt;p>å¦‚æœå°†è¯¥æ ‡å¿—è®¾ç½®ç»™FILL ringï¼Œåˆ™åº”ç”¨éœ€è¦è°ƒç”¨&lt;code>poll()&lt;/code>ï¼Œä»¥ä¾¿åœ¨RX ringä¸Šç»§ç»­æ¥æ”¶æŠ¥æ–‡ã€‚å¦‚ï¼Œå½“å†…æ ¸æ£€æµ‹åˆ°FILL ringä¸­æ²¡æœ‰è¶³å¤Ÿçš„buffï¼Œä¸”NICçš„RX HW RINGä¸­ä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„bufferæ—¶ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚æ­¤æ—¶ä¼šå…³ä¸­æ–­ï¼Œè¿™æ ·NICå°±æ— æ³•æ¥æ”¶åˆ°ä»»ä½•æŠ¥æ–‡(ç”±äºæ²¡æœ‰è¶³å¤Ÿçš„buffer)ï¼Œç”±äºè®¾ç½®äº†need_wakeupï¼Œè¿™æ ·ç”¨æˆ·ç©ºé—´å°±å¯ä»¥åœ¨FILL ringä¸Šå¢åŠ bufferï¼Œç„¶åè°ƒç”¨&lt;code>poll()&lt;/code>ï¼Œè¿™æ ·å†…æ ¸é©±åŠ¨å°±å¯ä»¥å°†è¿™äº›bufferæ·»åŠ åˆ°HW ringä¸Šç»§ç»­æ¥æ”¶æŠ¥æ–‡ã€‚&lt;/p>
&lt;p>å¦‚æœå°†è¯¥æ ‡å¿—è®¾ç½®ç»™TX ringï¼Œæ„å‘³ç€åº”ç”¨éœ€è¦æ˜ç¡®åœ°é€šçŸ¥å†…æ ¸å‘é€ä½äºTX ringä¸Šçš„æŠ¥æ–‡ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨&lt;code>poll()&lt;/code>ï¼Œæˆ–è°ƒç”¨&lt;code>sendto()&lt;/code>å®Œæˆã€‚&lt;/p>
&lt;p>å¯ä»¥åœ¨&lt;em>samples/bpf/xdpsock_user.c&lt;/em>ä¸­æ‰¾åˆ°ä¾‹å­ã€‚åœ¨TXè·¯å¾„ä¸Šä½¿ç”¨libbpfè¾…åŠ©å‡½æ•°çš„ä¾‹å­å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">xsk_ring_prod__needs_wakeup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_tx_ring&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">sendto&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">xsk_socket__fd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">xsk_handle&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MSG_DONTWAIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»ºè®®å¯ç”¨è¯¥æ¨¡å¼ï¼Œç”±äºå‡å°‘äº†TXè·¯å¾„ä¸Šçš„ç³»ç»Ÿè°ƒç”¨çš„æ•°ç›®ï¼Œå› æ­¤å¯ä»¥åœ¨åº”ç”¨å’Œé©±åŠ¨è¿è¡Œåœ¨åŒä¸€ä¸ª(æˆ–ä¸åŒ)coreçš„æƒ…å†µä¸‹æå‡æ€§èƒ½ã€‚&lt;/p>
&lt;h6 id="xdp_rxtxumem_fillumem_completion_ring-setsockopts">XDP_{RX|TX|UMEM_FILL|UMEM_COMPLETION}_RING setsockopts&lt;/h6>
&lt;p>è¿™äº›socketé€‰é¡¹åˆ†åˆ«è®¾ç½®RX, TX, FILLå’ŒCOMPLETION ringçš„æè¿°ç¬¦æ•°é‡(å¿…é¡»è‡³å°‘è®¾ç½®RXæˆ–TX ringçš„æè¿°ç¬¦å¤§å°)ã€‚å¦‚æœåŒæ—¶è®¾ç½®äº†RXå’ŒTXï¼Œå°±å¯ä»¥åŒæ—¶æ¥æ”¶å’Œå‘é€æ¥è‡ªåº”ç”¨çš„æµé‡ï¼›å¦‚æœä»…è®¾ç½®äº†å…¶ä¸­ä¸€ä¸ªï¼Œå°±å¯ä»¥èŠ‚çœç›¸åº”çš„èµ„æºã€‚å¦‚æœéœ€è¦å°†ä¸€ä¸ªUMEMç»‘å®šåˆ°socketï¼Œéœ€è¦åŒæ—¶è®¾ç½®FILL ringå’ŒCOMPLETION ringã€‚å¦‚æœä½¿ç”¨äº†&lt;code>XDP_SHARED_UMEM&lt;/code>æ ‡å¿—ï¼Œæ— éœ€ä¸ºé™¤ç¬¬ä¸€ä¸ªsocketä¹‹å¤–çš„socketåˆ›å»ºå•ç‹¬çš„UMEMï¼Œæ‰€æœ‰çš„socketå°†ä½¿ç”¨å…±äº«çš„UMEMã€‚æ³¨æ„ringä¸ºå•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ç»“æ„ï¼Œå› æ­¤å¤šè¿›ç¨‹æ— æ³•åŒæ—¶è®¿é—®åŒä¸€ä¸ªringã€‚å‚è§&lt;code>XDP_SHARED_UMEM&lt;/code>ç« èŠ‚ã€‚&lt;/p>
&lt;p>ä½¿ç”¨libbpfæ—¶ï¼Œå¯ä»¥é€šè¿‡ç»™&lt;code>xsk_socket__create&lt;/code>å‡½æ•°çš„rxå’Œtxå‚æ•°è®¾ç½®NULLæ¥åˆ›å»ºRx-onlyå’ŒTx-onlyçš„socketã€‚&lt;/p>
&lt;p>å¦‚æœåˆ›å»ºäº†ä¸€ä¸ªTx-onlyçš„socketï¼Œå»ºè®®ä¸è¦åœ¨FILL ringä¸­æ”¾å…¥ä»»ä½•æŠ¥æ–‡ï¼Œå¦åˆ™ï¼Œé©±åŠ¨å¯èƒ½ä¼šè®¤ä¸ºéœ€è¦æ¥æ”¶æ•°æ®(ä½†å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·çš„)ï¼Œè¿›è€Œå½±å“æ€§èƒ½ã€‚&lt;/p>
&lt;h6 id="xdp_umem_reg-setsockopt">XDP_UMEM_REG setsockopt&lt;/h6>
&lt;p>è¯¥socketé€‰é¡¹ä¼šç»™ä¸€ä¸ªsocketæ³¨å†Œä¸€ä¸ªUMEMï¼Œå…¶å¯¹åº”çš„åŒºåŸŸåŒ…å«äº†å¯ä»¥å®¹çº³æŠ¥æ–‡çš„bufferã€‚è¯¥è°ƒç”¨ä¼šä½¿ç”¨ä¸€ä¸ªæŒ‡å‘è¯¥åŒºåŸŸå¼€å§‹å¤„çš„æŒ‡é’ˆï¼Œä»¥åŠè¯¥åŒºåŸŸçš„å¤§å°ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªUMEMå¯ä»¥åˆ‡åˆ†çš„chunkå¤§å°å‚æ•°(ç›®å‰ä»…æ”¯æŒ2Kæˆ–4K)ã€‚å¦‚æœä¸€ä¸ªUMEMåŒºåŸŸçš„å¤§å°ä¸º128Kï¼Œä¸”chunkå¤§å°ä¸º2Kï¼Œæ„å‘³ç€è¯¥UMEMåŸŸæœ€å¤§å¯ä»¥æœ‰128K / 2K = 64ä¸ªæŠ¥æ–‡ï¼Œä¸”æœ€å¤§çš„æŠ¥æ–‡å¤§å°ä¸º2Kã€‚&lt;/p>
&lt;p>è¿˜æœ‰ä¸€ä¸ªé€‰é¡¹å¯ä»¥åœ¨UMEMä¸­è®¾ç½®æ¯ä¸ªbufferçš„headroomã€‚å¦‚æœè®¾ç½®ä¸ºNå­—èŠ‚ï¼Œæ„å‘³ç€æŠ¥æ–‡ä¼šä»bufferçš„ç¬¬Nä¸ªå­—èŠ‚å¼€å§‹ï¼Œä¸ºåº”ç”¨ä¿ç•™å‰Nä¸ªå­—èŠ‚ã€‚æœ€åä¸€ä¸ªé€‰é¡¹ä¸ºæ ‡å¿—ä½å­—æ®µï¼Œä¼šåœ¨æ¯ä¸ªUMEMæ ‡å¿—ä¸­å•ç‹¬å¤„ç†ã€‚&lt;/p>
&lt;h6 id="xdp_statistics-getsockopt">XDP_STATISTICS getsockopt&lt;/h6>
&lt;p>è·å–ä¸€ä¸ªsocketä¸¢å¼ƒä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•ã€‚æ”¯æŒçš„ä¿¡æ¯ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">struct&lt;/span> &lt;span class="n">xdp_statistics&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">__u64&lt;/span> &lt;span class="n">rx_dropped&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Dropped for reasons other than invalid desc */&lt;/span>
&lt;span class="n">__u64&lt;/span> &lt;span class="n">rx_invalid_descs&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Dropped due to invalid descriptor */&lt;/span>
&lt;span class="n">__u64&lt;/span> &lt;span class="n">tx_invalid_descs&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Dropped due to invalid descriptor */&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h6 id="xdp_options-getsockopt">XDP_OPTIONS getsockopt&lt;/h6>
&lt;p>è·å–ä¸€ä¸ªXDP socketçš„é€‰é¡¹ã€‚ç›®å‰ä»…æ”¯æŒ&lt;code>XDP_OPTIONS_ZEROCOPY&lt;/code>ï¼Œç”¨äºæ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†é›¶æ‹·è´ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä»AF_XDPçš„ç‰¹æ€§ä¸Šå¯ä»¥çœ‹åˆ°å…¶&lt;a href="https://pantheon.tech/what-is-af_xdp/">å±€é™æ€§&lt;/a>ï¼šä¸èƒ½ä½¿ç”¨XDPå°†ä¸åŒçš„æµé‡é‡å®šå‘çš„å¤šä¸ªAF_XDP socketä¸Šï¼ŒåŸå› æ˜¯æ¯ä¸ªAF_XDP socketå¿…é¡»ç»‘å®šåˆ°ç‰©ç†æ¥å£çš„TXé˜Ÿåˆ—ä¸Šã€‚å¤§å¤šæ•°çš„ç‰©ç†å’Œä»¿çœŸHWçš„æ¯ä¸ªæ¥å£ä»…æ”¯æŒä¸€ä¸ªRX/TXé˜Ÿåˆ—ï¼Œå› æ­¤å½“è¯¥æ¥å£ä¸Šç»‘å®šäº†ä¸€ä¸ªAF_XDPåï¼Œåç»­çš„ç»‘å®šæ“ä½œéƒ½å°†å¤±è´¥ã€‚ä»…æœ‰å°‘æ•°HWæ”¯æŒå¤šRX/TXé˜Ÿåˆ—ï¼Œä¸”é€šå¸¸ä»…æœ‰2/4/8ä¸ªé˜Ÿåˆ—ï¼Œæ— æ³•æ‰©å±•ç»™cloudä¸­çš„ä¸Šç™¾ä¸ªå®¹å™¨ä½¿ç”¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ›´å¤šç»†èŠ‚å‚è§AF_XDP&lt;a href="https://www.kernel.org/doc/html/latest/networking/af_xdp.html">å®˜æ–¹æ–‡æ¡£&lt;/a>ä»¥åŠè¿™ç¯‡&lt;a href="http://vger.kernel.org/lpc_net2018_talks/lpc18_paper_af_xdp_perf-v2.pdf">è®ºæ–‡&lt;/a>ã€‚&lt;/p>
&lt;h2 id="tchttpsdocsciliumioenlatestbpftc-traffic-control">&lt;a href="https://docs.cilium.io/en/latest/bpf/#tc-traffic-control">TC&lt;/a>&lt;/h2>
&lt;p>é™¤äº†XDPï¼ŒBPFè¿˜å¯ä»¥åœ¨ç½‘ç»œæ•°æ®è·¯å¾„çš„å†…æ ¸tc(traffic control)å±‚ä¹‹å¤–ä½¿ç”¨ã€‚ä¸Šæ–‡å·²ç»ç»™å‡ºäº†XDPå’ŒTCçš„åŒºåˆ«ã€‚&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>&lt;code>ingress&lt;/code>Â hookï¼š&lt;code>__netif_receive_skb_core() -&amp;gt; sch_handle_ingress()&lt;/code>&lt;/li>
&lt;li>&lt;code>egress&lt;/code>Â hookï¼š&lt;code>__dev_queue_xmit() -&amp;gt; sch_handle_egress()&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-12-21-1334952-20200809204246404-1470995812.png" alt="">&lt;/p>
&lt;/blockquote>
&lt;p>è¿è¡Œåœ¨tcå±‚çš„BPFç¨‹åºä½¿ç”¨çš„æ˜¯Â &lt;code>cls_bpf&lt;/code>Â (clså³Classifiersçš„ç®€ç§°)åˆ†ç±»å™¨ã€‚åœ¨tcä¸­ï¼Œå°†BPFçš„é™„ç€ç‚¹æè¿°ä¸ºä¸€ä¸ª&amp;quot;åˆ†ç±»å™¨&amp;quot;ï¼Œè¿™ä¸ªè¯æœ‰ç‚¹è¯¯å¯¼ï¼Œå› æ­¤å®ƒå°‘æè¿°äº†&lt;code>cls_bpf&lt;/code>çš„æ‰€æ”¯æŒçš„åŠŸèƒ½ã€‚å³ä¸€ä¸ªå®Œæ•´çš„å¯ç¼–ç¨‹çš„æŠ¥æ–‡å¤„ç†å™¨ä¸ä»…å¯ä»¥è¯»å–&lt;code>skb&lt;/code>çš„å…ƒæ•°æ®å’ŒæŠ¥æ–‡æ•°æ®ï¼Œè¿˜å¯ä»¥å¯¹å…¶è¿›è¡Œä»»æ„ä¿®æ”¹ï¼Œæœ€åç»ˆæ­¢tcçš„å¤„ç†ï¼Œå¹¶è¿”å›è£å®šçš„action(è§ä¸‹)ã€‚&lt;code>cls_bpf&lt;/code>å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªè‡ªåŒ…å«çš„ï¼Œå¯ä»¥ç®¡ç†å’Œæ‰§è¡Œtc BPFç¨‹åºçš„å®ä½“ã€‚&lt;/p>
&lt;p>&lt;code>cls_bpf&lt;/code>å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªtc BPFç¨‹åºã€‚é€šå¸¸ï¼Œåœ¨ä¼ ç»Ÿçš„tcæ–¹æ¡ˆä¸­ï¼Œåˆ†ç±»å™¨å’Œactionæ¨¡å—æ˜¯åˆ†å¼€çš„ï¼Œæ¯ä¸ªåˆ†ç±»å™¨å¯ä»¥é™„åŠ ä¸€ä¸ªæˆ–å¤šä¸ªactionï¼Œä¸€æ—¦åŒ¹é…åˆ°åˆ†ç±»å™¨æ—¶å°±ä¼šæ‰§è¡Œactionã€‚ä½†åœ¨ç°ä»£è½¯ä»¶æ•°æ®è·¯å¾„ä¸­ä½¿ç”¨è¿™ç§æ¨¡å¼çš„tcå¤„ç†å¤æ‚çš„æŠ¥æ–‡æ—¶ä¼šé‡åˆ°æ‰©å±•æ€§é—®é¢˜ã€‚ç”±äºé™„åŠ åˆ°cls_bpfçš„tc BPFç¨‹åºæ˜¯å®Œå…¨è‡ªåŒ…å«çš„ï¼Œå› æ­¤å¯ä»¥æœ‰æ•ˆåœ°å°†è§£æå’Œæ“ä½œè¿‡ç¨‹èåˆåˆ°ä¸€ä¸ªå•å…ƒä¸­ã€‚å¹¸å¥½æœ‰äº†&lt;code>cls_bpf&lt;/code>çš„&lt;code>direct-action&lt;/code>æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸‹ï¼Œä»…éœ€è¦è¿”å›tc actionè£å®šç»“æœå¹¶ç«‹å³ç»“æŸå¤„ç†æµå³å¯ï¼Œå¯ä»¥åœ¨ç½‘ç»œæ•°æ®æµä¸­å®ç°å¯æ‰©å±•çš„å¯ç¼–ç¨‹æŠ¥æ–‡å¤„ç†æµç¨‹ï¼ŒåŒæ—¶é¿å…äº†actionçš„çº¿æ€§è¿­ä»£ã€‚&lt;code>cls_bpf&lt;/code>æ˜¯tcå±‚ä¸­å”¯ä¸€èƒ½å¤Ÿå®ç°è¿™ç§å¿«é€Ÿè·¯å¾„çš„â€œåˆ†ç±»å™¨â€æ¨¡å—ã€‚&lt;/p>
&lt;p>ä¸XDP BPFç¨‹åºç±»ä¼¼ï¼Œtc BPFç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡cls_bpfè‡ªåŠ¨æ›´æ–°ï¼Œè€Œä¸ä¼šä¸­æ–­ä»»ä½•ç½‘ç»œæµæˆ–é‡å¯æœåŠ¡ã€‚&lt;/p>
&lt;p>&lt;code>cls_bpf&lt;/code>å¯ä»¥é™„åŠ çš„tc ingresså’Œegreeé’©å­éƒ½é€šè¿‡ä¸€ä¸ªåä¸º&lt;code>sch_clsact&lt;/code>çš„ä¼ªqdiscè¿›è¡Œç®¡ç†ã€‚ç”±äºè¯¥ä¼ªqdiscå¯ä»¥åŒæ—¶ç®¡ç†ingresså’Œegressçš„tcé’©å­ï¼Œå› æ­¤å®ƒæ˜¯ingress qdiscçš„è¶…é›†(ä¹Ÿå¯ç›´æ¥æ›¿æ¢)ã€‚å¯¹äº&lt;code>__dev_queue_xmit()&lt;/code>ä¸­çš„tcçš„egressé’©å­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä¸æ˜¯åœ¨å†…æ ¸çš„qdisc rooté”ä¸‹è¿è¡Œçš„ã€‚å› æ­¤ï¼Œtc ingresså’Œegressé’©å­éƒ½ä»¥æ— é”çš„æ–¹å¼è¿è¡Œåœ¨å¿«é€Ÿè·¯å¾„ä¸­ï¼Œä¸”è¿™ä¸¤ä¸ªé’©å­éƒ½ç¦ç”¨äº†æŠ¢å ï¼Œå¹¶è¿è¡Œåœ¨RCUè¯»å–ä¾§ã€‚&lt;/p>
&lt;p>é€šå¸¸åœ¨egressä¸Šä¼šå­˜åœ¨é™„ç€åˆ°ç½‘ç»œè®¾å¤‡ä¸Šçš„qdiscï¼Œå¦‚&lt;code>sch_mq&lt;/code>ï¼Œ&lt;code>sch_fq&lt;/code>ï¼Œ&lt;code>sch_fq_codel&lt;/code>æˆ–&lt;code>sch_htb&lt;/code>ï¼Œå…¶ä¸­æœ‰äº›æ˜¯å¯åˆ†ç±»çš„qdisc(åŒ…å«å­ç±»)ï¼Œå› æ­¤ä¼šè¦æ±‚ä¸€ä¸ªæŠ¥æ–‡åˆ†ç±»æœºåˆ¶æ¥å†³å®šåœ¨å“ªé‡Œè§£å¤ç”¨æ•°æ®åŒ…ã€‚è¯¥è¿‡ç¨‹é€šè¿‡è°ƒç”¨&lt;code>tcf_classify()&lt;/code>è¿›è¡Œå¤„ç†ï¼Œè¿›è€Œè°ƒç”¨tcåˆ†ç±»å™¨(å¦‚æœå­˜åœ¨)ã€‚&lt;code>cls_bpf&lt;/code>ä¹Ÿå¯ä»¥é™„åŠ å¹¶ç”¨äºå¦‚ä¸‹åœºæ™¯ï¼šä¸€äº›åœ¨qdisc rooté”ä¸‹çš„æ“ä½œå¯èƒ½ä¼šæ”¶åˆ°é”ç«äº‰çš„å½±å“ã€‚&lt;code>sch_clsact&lt;/code>Â qdiscçš„egressé’©å­å‡ºç°åœ¨æ›´æ—©çš„æ—¶é—´ç‚¹ï¼Œä½†å®ƒä¸å±äºè¿™ä¸ªé”çš„èŒƒå›´ï¼Œå› æ­¤ä½œå®Œå…¨ç‹¬ç«‹äºå¸¸è§„çš„egress qdiscsã€‚å› æ­¤ï¼Œå¯¹äº&lt;code>sch_htb&lt;/code>è¿™æ ·çš„æƒ…å†µï¼Œ&lt;code>sch_clsact&lt;/code>Â qdiscå¯ä»¥é€šè¿‡qdisc rooté”ä¹‹å¤–çš„tc BPFæ‰§è¡Œç¹é‡çš„åŒ…åˆ†ç±»å·¥ä½œï¼Œé€šè¿‡åœ¨è¿™äº› tc BPF ç¨‹åºä¸­è®¾ç½®Â &lt;code>skb-&amp;gt;mark&lt;/code>Â æˆ–Â &lt;code>skb-&amp;gt;priority&lt;/code>Â ï¼Œè¿™æ ·Â &lt;code>sch_htb&lt;/code>Â åªéœ€è¦ä¸€ä¸ªç®€å•çš„æ˜ å°„å³å¯ï¼Œä¸éœ€è¦åœ¨rooté”ä¸‹æ‰§è¡Œä»£ä»·é«˜æ˜‚çš„æŠ¥æ–‡åˆ†ç±»å·¥ä½œï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘é”ç«äº‰ã€‚&lt;/p>
&lt;p>åœ¨sch_clsactç»“åˆcls_bpfçš„åœºæ™¯ä¸‹æ”¯æŒoffloaded tc BPFç¨‹åºï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå…ˆå‰åŠ è½½çš„BPFç¨‹åºæ˜¯ä»SmartNICé©±åŠ¨ç¨‹åºjitç”Ÿæˆçš„ï¼Œä»¥ä¾¿åœ¨NICä¸Šä»¥æœ¬æœºæ–¹å¼è¿è¡Œã€‚åªæœ‰åœ¨&lt;code>direct-action&lt;/code>æ¨¡å¼ä¸‹è¿è¡Œçš„&lt;code>cls_bpf&lt;/code>ç¨‹åºæ‰æ”¯æŒoffloadedã€‚&lt;code>cls_bpf&lt;/code>ä»…æ”¯æŒoffloadä¸€ä¸ªå•ç‹¬çš„ç¨‹åº(æ— æ³•offloadå¤šä¸ªç¨‹åº)ï¼Œä¸”åªæœ‰ingressæ”¯æŒoffload BPFç¨‹åºã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>cls_bpf&lt;/code>å®ä¾‹å¯ä»¥åŒ…å«å¤šä¸ªtc BPFç¨‹åºï¼Œå¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆ&lt;code>TC_ACT_UNSPEC&lt;/code>ç¨‹åºè¿”å›ç å¯ä»¥ç»§ç»­æ‰§è¡Œåˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªtc BPFç¨‹åºã€‚ç„¶è€Œï¼Œè¿™æ ·åšçš„ç¼ºç‚¹æ˜¯ï¼Œå¤šä¸ªç¨‹åºéœ€è¦å¤šæ¬¡è§£æç›¸åŒçš„æŠ¥æ–‡ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚&lt;/p>
&lt;h3 id="è¿”å›ç ">è¿”å›ç &lt;/h3>
&lt;p>tcçš„ingresså’Œegressé’©å­å…±äº«ç›¸åŒçš„actionæ¥è¿”å›tc BPFç¨‹åºä½¿ç”¨çš„è£å®šç»“æœï¼Œå®šä¹‰åœ¨Â &lt;code>linux/pkt_cls.h&lt;/code>ç³»ç»Ÿå¤´æ–‡ä»¶ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define TC_ACT_UNSPEC (-1)
&lt;/span>&lt;span class="cp">#define TC_ACT_OK 0
&lt;/span>&lt;span class="cp">#define TC_ACT_SHOT 2
&lt;/span>&lt;span class="cp">#define TC_ACT_STOLEN 4
&lt;/span>&lt;span class="cp">#define TC_ACT_REDIRECT 7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç³»ç»Ÿå¤´æ–‡ä»¶ä¸­è¿˜æœ‰ä¸€äº›ä»¥&lt;code>TC_ACT_*&lt;/code>å¼€å¤´çš„actionå˜é‡ï¼Œå¯ä»¥è¢«ä¸¤ä¸ªé’©å­ä½¿ç”¨ã€‚ä½†å®ƒä»¬ä¸ä¸Šé¢çš„è¯­ä¹‰ç›¸åŒã€‚å³ï¼Œä»tc BPFçš„è§’åº¦æ¥çœ‹&lt;code>TC_ACT_OK&lt;/code>å’Œ&lt;code>TC_ACT_RECLASSIFY&lt;/code>çš„è¯­ä¹‰ç›¸åŒï¼Œä¸‰ä¸ª&lt;code>TC_ACT_stelled&lt;/code>ã€&lt;code>TC_ACT_QUEUED&lt;/code>å’Œ&lt;code>TC_ACT_TRAP&lt;/code>æ“ä½œç çš„è¯­ä¹‰ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚å› æ­¤ï¼Œå¯¹äºè¿™äº›æƒ…å†µï¼Œæˆ‘ä»¬åªæè¿°Â &lt;code>TC_ACT_OK&lt;/code>Â å’ŒÂ &lt;code>TC_ACT_STOLEN&lt;/code>Â æ“ä½œç ã€‚&lt;/p>
&lt;p>ä»&lt;code>TC_ACT_UNSPEC&lt;/code>å¼€å§‹ï¼Œè¡¨ç¤º&amp;quot;æœªæŒ‡å®šçš„action&amp;quot;ï¼Œç”¨äºä»¥ä¸‹ä¸‰ç§åœºæ™¯ï¼ši)å½“ä¸€ä¸ªoffloaded tcç¨‹åºçš„tc ingressé’©å­è¿è¡Œåœ¨&lt;code>cls_bpf&lt;/code>çš„ä½ç½®ï¼Œåˆ™è¯¥offloadedç¨‹åºå°†è¿”å›&lt;code>TC_ACT_UNSPEC&lt;/code>ï¼›ii)ä¸ºäº†åœ¨å¤šç¨‹åºåœºæ™¯ä¸‹ç»§ç»­æ‰§è¡Œ&lt;code>cls_bpf&lt;/code>ä¸­çš„ä¸‹ä¸€ä¸ªBPFç¨‹åºï¼Œåç»­çš„ç¨‹åºéœ€è¦ä¸æ­¥éª¤iä¸­çš„offloaded tc BPFç¨‹åºé…åˆä½¿ç”¨ï¼Œä½†å‡ºç°äº†ä¸€ä¸ªéoffloadedåœºæ™¯ä¸‹è¿è¡Œçš„tc BPFç¨‹åºï¼›iii)&lt;code>TC_ACT_UNSPEC&lt;/code>è¿˜å¯ä»¥ç”¨äºå•ä¸ªç¨‹åºåœºæ™¯ï¼Œç”¨äºå‘Šè¯‰å†…æ ¸ç»§ç»­ä½¿ç”¨skbï¼Œä¸ä¼šäº§ç”Ÿå…¶ä»–å‰¯ä½œç”¨ã€‚&lt;code>TC_ACT_UNSPEC&lt;/code>ä¸&lt;code>TC_ACT_OK&lt;/code>ç±»ä¼¼ï¼Œä¸¤è€…éƒ½ä¼šå°†skbé€šè¿‡ingresså‘ä¸Šä¼ é€’åˆ°ç½‘ç»œæ ˆçš„ä¸Šå±‚ï¼Œæˆ–è€…é€šè¿‡egresså‘ä¸‹ä¼ é€’åˆ°ç½‘ç»œè®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä»¥ä¾¿åœ¨egressè¿›è¡Œä¼ è¾“ã€‚ä¸&lt;code>TC_ACT_OK&lt;/code>çš„å”¯ä¸€ä¸åŒä¹‹å¤„æ˜¯ï¼Œ&lt;code>TC_ACT_OK&lt;/code>åŸºäºtc BPFç¨‹åºè®¾å®šçš„classidæ¥è®¾ç½®&lt;code>skb-&amp;gt;tc_index&lt;/code>ï¼Œè€ŒÂ &lt;code>TC_ACT_UNSPEC&lt;/code>Â æ˜¯é€šè¿‡ tc BPF ç¨‹åºä¹‹å¤–çš„ BPFä¸Šä¸‹æ–‡ä¸­çš„Â &lt;code>skb-&amp;gt;tc_classid&lt;/code>Â è¿›è¡Œè®¾ç½®ã€‚&lt;/p>
&lt;p>&lt;code>TC_ACT_SHOT&lt;/code>é€šçŸ¥å†…æ ¸ä¸¢å¼ƒæŠ¥æ–‡ï¼Œå³ç½‘ç»œæ ˆä¸Šå±‚å°†ä¸ä¼šåœ¨ingressçš„skbä¸­çœ‹åˆ°è¯¥æŠ¥æ–‡ï¼Œç±»ä¼¼åœ°ï¼Œè¿™ç±»æŠ¥æ–‡ä¹Ÿä¸ä¼šåœ¨egressä¸­å‘é€ã€‚&lt;code>TC_ACT_SHOT&lt;/code>å’Œ&lt;code>TC_ACT_STOLEN&lt;/code>æœ¬è´¨ä¸Šæ˜¯ç›¸ä¼¼çš„ï¼Œä»…å­˜åœ¨éƒ¨åˆ†å·®å¼‚ï¼š&lt;code>TC_ACT_SHOT&lt;/code>ä¼šé€šçŸ¥å†…æ ¸å·²ç»é€šè¿‡&lt;code>kfree_skb()&lt;/code>é‡Šæ”¾skbï¼Œä¸”ä¼šç«‹å³ç»™è°ƒç”¨è€…è¿”å›&lt;code>NET_XMIT_DROP&lt;/code>ï¼›è€ŒTC_ACT_STOLENä¼šé€šè¿‡&lt;code>consume_skb()&lt;/code>é‡Šæ”¾skb,å¹¶ç»™ä¸Šå±‚è¿”å›&lt;code>NET_XMIT_SUCCESS&lt;/code>ï¼Œå‡è£…ä¼ è¾“æˆåŠŸã€‚perfçš„æŠ¥æ–‡ä¸¢å¼ƒç›‘æ§ä¼šè®°å½•&lt;code>kfree_skb()&lt;/code>çš„æ“ä½œï¼Œå› æ­¤ä¸ä¼šè®°å½•ä»»ä½•å› ä¸º&lt;code>TC_ACT_STOLEN&lt;/code>ä¸¢å¼ƒçš„æŠ¥æ–‡ï¼Œå› ä¸ºä»è¯­ä¹‰ä¸Šè¯´ï¼Œè¿™äº›Â &lt;code>skb&lt;/code>Â æ˜¯è¢«æ¶ˆè´¹æˆ–æ’é˜Ÿçš„è€Œä¸æ˜¯è¢«ä¸¢å¼ƒçš„ã€‚&lt;/p>
&lt;p>æœ€å&lt;code>TC_ACT_REDIRECT&lt;/code>Â actionå…è®¸tc BPFç¨‹åºé€šè¿‡&lt;code>bpf_redirect()&lt;/code>è¾…åŠ©å‡½æ•°å°†skbé‡å®šå‘åˆ°ç›¸åŒæˆ–ä¸åŒçš„è®¾å¤‡ingressæˆ–egressè·¯å¾„ä¸Šã€‚é€šè¿‡å°†æŠ¥æ–‡å¯¼å…¥å…¶ä»–è®¾å¤‡çš„ingressæˆ–egressæ–¹å‘ï¼Œå¯ä»¥æœ€å¤§åŒ–åœ°å®ç°BPFçš„æŠ¥æ–‡è½¬å‘åŠŸèƒ½ã€‚ä½¿ç”¨è¯¥æ–¹å¼ä¸éœ€è¦å¯¹ç›®æ ‡ç½‘ç»œè®¾å¤‡åšä»»ä½•æ›´æ”¹ï¼Œä¹Ÿä¸éœ€è¦åœ¨ç›®æ ‡è®¾å¤‡ä¸Šè¿è¡Œå¦å¤–ä¸€ä¸ª&lt;code>cls_bpf&lt;/code>å®ä¾‹ã€‚&lt;/p>
&lt;h3 id="åŠ è½½tc-bpfç¨‹åº">åŠ è½½tc BPFç¨‹åº&lt;/h3>
&lt;p>å‡è®¾æœ‰ä¸€ä¸ªåä¸º&lt;code>prog.o&lt;/code>çš„tc BPFç¨‹åºï¼Œå¯ä»¥é€šè¿‡tcå‘½ä»¤å°†è¯¥ç¨‹åºåŠ è½½åˆ°ç½‘ç»œè®¾å¤‡å±±ã€‚ä¸XDPä¸åŒï¼Œå®ƒä¸éœ€è¦ä¾èµ–é©±åŠ¨å°†BPFç¨‹åºé™„åŠ åˆ°è®¾å¤‡ä¸Šï¼Œä¸‹é¢ä¼šç”¨åˆ°ä¸€ä¸ªåä¸º&lt;code>em1&lt;/code>çš„ç½‘ç»œè®¾å¤‡ï¼Œå¹¶å°†ç¨‹åºé™„åŠ åˆ°&lt;code>em1&lt;/code>çš„&lt;code>ingress&lt;/code>æŠ¥æ–‡è·¯å¾„ä¸Šã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc qdisc add dev em1 clsact&lt;/span>
&lt;span class="c1"># tc filter add dev em1 ingress bpf da obj prog.o&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¬¬ä¸€æ­¥é¦–å…ˆé…ç½®ä¸€ä¸ª&lt;code>clsact&lt;/code>Â qdiscã€‚å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œclsactæ˜¯ä¸€ä¸ªä¼ªé€ çš„qdiscï¼Œä¸&lt;code>ingress&lt;/code>Â qdiscç±»ä¼¼ï¼Œä»…åŒ…å«åˆ†ç±»å™¨å’Œactionï¼Œä½†ä¸ä¼šæä¾›å®é™…çš„é˜Ÿåˆ—åŠŸèƒ½ï¼Œå®ƒæ˜¯é™„åŠ bpfåˆ†ç±»å™¨æ‰€å¿…éœ€çš„ã€‚&lt;code>clsact&lt;/code>Â æä¾›äº†ä¸¤ä¸ªç‰¹æ®Šçš„é’©å­ï¼Œç§°ä¸º&lt;code>ingress&lt;/code>å’Œ&lt;code>egress&lt;/code>ï¼Œåˆ†ç±»å™¨å¯ä»¥é™„åŠ åˆ°è¿™ä¸¤ä¸ªé’©å­ä¸Šã€‚&lt;code>ingress&lt;/code>å’Œ&lt;code>egress&lt;/code>é’©å­éƒ½ä½äºç½‘ç»œæ•°æ®è·¯å¾„çš„ä¸­å¤®æ¥æ”¶å’Œå‘é€ä½ç½®ï¼Œæ¯ä¸ªç»è¿‡è®¾å¤‡çš„æŠ¥æ–‡éƒ½ä¼šç»è¿‡æ­¤å¤„ã€‚&lt;code>ingees&lt;/code>é’©å­é€šè¿‡å†…æ ¸çš„&lt;code>__netif_receive_skb_core() -&amp;gt; sch_handle_ingress()&lt;/code>è¿›è¡Œè°ƒç”¨ï¼Œ&lt;code>egress&lt;/code>é’©å­é€šè¿‡&lt;code>__dev_queue_xmit() -&amp;gt; sch_handle_egress()&lt;/code>è¿›è¡Œè°ƒç”¨ã€‚&lt;/p>
&lt;p>å°†ç¨‹åºé™„åŠ åˆ°&lt;code>egress&lt;/code>é’©å­ä¸Šçš„æ“ä½œä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc filter add dev em1 egress bpf da obj prog.o&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>clsact&lt;/code>Â qdiscä»¥æ— é”çš„æ–¹å¼å¤„ç†æ¥è‡ª&lt;code>ingress&lt;/code>å’Œ&lt;code>egress&lt;/code>æ–¹å‘çš„æŠ¥æ–‡ï¼Œä¸”å¯ä»¥é™„åŠ åˆ°ä¸€ä¸ªæ— é˜Ÿåˆ—è™šæ‹Ÿè®¾å¤‡ä¸Šï¼Œå¦‚è¿æ¥åˆ°å®¹å™¨çš„&lt;code>veth&lt;/code>è®¾å¤‡ã€‚&lt;/p>
&lt;p>åœ¨é’©å­ä¹‹åï¼Œ&lt;code>tc filter&lt;/code>å‘½ä»¤é€‰æ‹©ä½¿ç”¨&lt;code>bpf&lt;/code>çš„&lt;code>da&lt;/code>(direct-action)æ¨¡å¼ã€‚æ¨èä½¿ç”¨å¹¶æŒ‡å®šda&lt;code>æ¨¡å¼&lt;/code>ï¼ŒåŸºæœ¬ä¸Šæ„å‘³ç€bpfåˆ†ç±»å™¨ä¸å†éœ€è¦è°ƒç”¨å¤–éƒ¨tc actionæ¨¡å—ï¼Œæ‰€æœ‰æŠ¥æ–‡çš„ä¿®æ”¹ï¼Œè½¬å‘æˆ–å…¶ä»–actionéƒ½å¯ä»¥é€šè¿‡é™„åŠ çš„BPFç¨‹åºæ¥å®ç°ï¼Œå› æ­¤å¤„ç†é€Ÿåº¦æ›´å¿«ã€‚&lt;/p>
&lt;p>åˆ°æ­¤ä½ç½®ï¼Œå·²ç»é™„åŠ bpfç¨‹åºï¼Œä¸€æ—¦æœ‰æŠ¥æ–‡ä¼ è¾“åˆ°è¯¥è®¾å¤‡åå°±ä¼šæ‰§è¡Œè¯¥ç¨‹åºã€‚ä¸XDPç›¸åŒï¼Œå¦‚æœä¸ä½¿ç”¨é»˜è®¤çš„sectionåç§°ï¼Œåˆ™å¯ä»¥åœ¨åŠ è½½æœŸé—´è¿›è¡ŒæŒ‡å®šï¼Œä¾‹å¦‚ï¼Œä¸‹é¢æŒ‡å®šçš„sectionåä¸º&lt;code>foobar&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc filter add dev em1 egress bpf da obj prog.o sec foobar&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>iptables2çš„BPFåŠ è½½å™¨å…è®¸è·¨ç¨‹åºç±»å‹ä½¿ç”¨ç›¸åŒçš„å‘½ä»¤è¡Œè¯­æ³•ã€‚&lt;/p>
&lt;p>é™„åŠ çš„ç¨‹åºå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ—å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc filter show dev em1 ingress&lt;/span>
filter protocol all pref &lt;span class="m">49152&lt;/span> bpf
filter protocol all pref &lt;span class="m">49152&lt;/span> bpf handle 0x1 prog.o:&lt;span class="o">[&lt;/span>ingress&lt;span class="o">]&lt;/span> direct-action id &lt;span class="m">1&lt;/span> tag c5f7825e5dac396f
&lt;span class="c1"># tc filter show dev em1 egress&lt;/span>
filter protocol all pref &lt;span class="m">49152&lt;/span> bpf
filter protocol all pref &lt;span class="m">49152&lt;/span> bpf handle 0x1 prog.o:&lt;span class="o">[&lt;/span>egress&lt;span class="o">]&lt;/span> direct-action id &lt;span class="m">2&lt;/span> tag b2fd5adc0f262714
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>prog.o:[ingress]&lt;/code>çš„è¾“å‡ºè¯´æ˜ç¨‹åºæ®µ&lt;code>ingress&lt;/code>é€šè¿‡æ–‡ä»¶&lt;code>prog.o&lt;/code>è¿›è¡ŒåŠ è½½ï¼Œä¸”&lt;code>bpf&lt;/code>è¿è¡Œåœ¨&lt;code>direct-action&lt;/code>æ¨¡å¼ä¸‹ã€‚ä¸Šé¢ä¸¤ç§æƒ…å†µé™„åŠ äº†ç¨‹åº&lt;code>id&lt;/code>å’Œ&lt;code>tag&lt;/code>ï¼Œå…¶ä¸­åè€…è¡¨ç¤ºå¯¹æŒ‡ä»¤æµçš„hashï¼Œè¯¥hashå¯ä»¥ä¸ç›®æ ‡æ–‡ä»¶æˆ–å¸¦æœ‰å †æ ˆè·Ÿè¸ªçš„perf reportç­‰ç›¸å…³ã€‚æœ€åï¼Œ&lt;code>id&lt;/code>è¡¨ç¤ºç³»ç»ŸèŒƒå›´å†…çš„BPFç¨‹åºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨&lt;code>bpftool&lt;/code>æ¥æŸ¥çœ‹æˆ–dumpé™„åŠ çš„BPFç¨‹åºã€‚&lt;/p>
&lt;p>tcå¯ä»¥é™„åŠ å¤šä¸ªBPFç¨‹åºï¼Œå®ƒæä¾›äº†å…¶ä»–å¯ä»¥é“¾æ¥åœ¨ä¸€èµ·çš„åˆ†ç±»å™¨ã€‚ä½†é™„åŠ ä¸€ä¸ªBPFç¨‹åºå·²ç»å¯ä»¥å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼Œå› ä¸ºé€šè¿‡&lt;code>da&lt;/code>(&lt;code>direct-action&lt;/code>)æ¨¡å¼å¯ä»¥åœ¨ä¸€ä¸ªç¨‹åºä¸­å®ç°æ‰€æœ‰çš„æŠ¥æ–‡æ“ä½œï¼Œæ„å‘³ç€BPFç¨‹åºå°†è¿”å›tc actionè£å®šç»“æœï¼Œå¦‚&lt;code>TC_ACT_OK&lt;/code>,Â &lt;code>TC_ACT_SHOT&lt;/code>ç­‰ã€‚ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½å’Œçµæ´»æ€§ï¼Œæ¨èä½¿ç”¨è¿™ç§æ–¹å¼ã€‚&lt;/p>
&lt;p>åœ¨ä¸Šè¿°&lt;code>show&lt;/code>å‘½ä»¤ä¸­ï¼Œåœ¨BPFçš„ç›¸å…³è¾“å‡ºæ—æ˜¾ç¤ºäº†&lt;code>pref 49152&lt;/code>Â å’Œ&lt;code>handle 0x1&lt;/code>ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡å‘½ä»¤è¡Œæ˜¾å¼åœ°æä¾›ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆçš„è¿™ä¸¤ä¸ªè¾“å‡ºã€‚&lt;code>perf&lt;/code>è¡¨æ˜äº†ä¸€ä¸ªä¼˜å…ˆçº§æ•°å­—ï¼Œå³å½“é™„åŠ äº†å¤šä¸ªåˆ†ç±»å™¨æ—¶ï¼Œå°†ä¼šæŒ‰ç…§ä¼˜å…ˆçº§ä¸Šå‡çš„é¡ºåºæ‰§è¡Œè¿™äº›åˆ†ç±»å™¨ã€‚&lt;code>handle&lt;/code>è¡¨ç¤ºä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œå½“ä¸€ä¸ª&lt;code>perf&lt;/code>åŠ è½½äº†ç³»ç»Ÿåˆ†ç±»å™¨çš„å¤šä¸ªå®ä¾‹æ—¶èµ·ä½œç”¨ã€‚ç”±äºåœ¨BPFåœºæ™¯ä¸‹ï¼Œä¸€ä¸ªç¨‹åºè¶³çŸ£ï¼Œ&lt;code>perf&lt;/code>å’Œ&lt;code>handle&lt;/code>é€šå¸¸å¯ä»¥å¿½ç•¥ã€‚&lt;/p>
&lt;p>åªæœ‰åœ¨éœ€è¦è‡ªåŠ¨æ›¿æ¢é™„åŠ çš„BPFç¨‹åºçš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ¨èåœ¨åˆå§‹åŒ–åŠ è½½å‰æŒ‡å®š&lt;code>pref&lt;/code>å’Œ&lt;code>handle&lt;/code>ï¼Œè¿™æ ·åœ¨ä»¥åæ‰§è¡Œ&lt;code>replace&lt;/code>æ“ä½œæ—¶å°±ä¸å¿…åœ¨è¿›è¡ŒæŸ¥è¯¢ã€‚åˆ›å»ºæ–¹å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc filter add dev em1 ingress pref 1 handle 1 bpf da obj prog.o sec foobar&lt;/span>
&lt;span class="c1"># tc filter show dev em1 ingress&lt;/span>
filter protocol all pref &lt;span class="m">1&lt;/span> bpf
filter protocol all pref &lt;span class="m">1&lt;/span> bpf handle 0x1 prog.o:&lt;span class="o">[&lt;/span>foobar&lt;span class="o">]&lt;/span> direct-action id &lt;span class="m">1&lt;/span> tag c5f7825e5dac396f
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äºåŸå­æ›¿æ¢ï¼Œå¯ä»¥ä½¿ç”¨(æ¥è‡ªæ–‡ä»¶&lt;code>prog.o&lt;/code>ä¸­çš„&lt;code>foobar&lt;/code>Â sectionçš„BPFç¨‹åº)å¦‚ä¸‹å‘½ä»¤æ¥æ›´æ–°ç°æœ‰çš„&lt;code>ingress&lt;/code>é’©å­ä¸Šçš„ç¨‹åº&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc filter replace dev em1 ingress pref 1 handle 1 bpf da obj prog.o sec foobar&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€åï¼Œä¸ºäº†ç§»é™¤æ‰€æœ‰ingresså’Œegressä¸Šé™„åŠ çš„ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc filter del dev em1 ingress&lt;/span>
&lt;span class="c1"># tc filter del dev em1 egress&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸ºäº†ç§»é™¤ç½‘ç»œè®¾å¤‡ä¸Šçš„æ•´ä¸ª&lt;code>clsact&lt;/code>Â qdiscï¼Œå³ç§»é™¤æ‰ingresså’Œegressé’©å­ä¸Šé™„åŠ çš„æ‰€æœ‰ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc qdisc del dev em1 clsact&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœNICå’Œé©±åŠ¨ä¹ŸåƒXDP BPFç¨‹åºä¸€æ ·æ”¯æŒoffloadedï¼Œåˆ™tc BPFç¨‹åºä¹Ÿå¯ä»¥æ˜¯offloadedçš„ã€‚Netronomeçš„nfpåŒæ—¶æ”¯æŒä¸¤ç§ç±»å‹çš„BPF offloadã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># tc qdisc add dev em1 clsact&lt;/span>
&lt;span class="c1"># tc filter replace dev em1 ingress pref 1 handle 1 bpf skip_sw da obj prog.o&lt;/span>
Error: TC offload is disabled on net device.
We have an error talking to the kernel
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœå‡ºç°äº†å¦‚ä¸Šé”™è¯¯ï¼Œåˆ™è¡¨ç¤ºé¦–å…ˆéœ€è¦é€šè¿‡ethtoolçš„&lt;code>hw-tc-offload&lt;/code>æ¥å¯åŠ¨tcç¡¬ä»¶offloadï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># ethtool -K em1 hw-tc-offload on&lt;/span>
&lt;span class="c1"># tc qdisc add dev em1 clsact&lt;/span>
&lt;span class="c1"># tc filter replace dev em1 ingress pref 1 handle 1 bpf skip_sw da obj prog.o&lt;/span>
&lt;span class="c1"># tc filter show dev em1 ingress&lt;/span>
filter protocol all pref &lt;span class="m">1&lt;/span> bpf
filter protocol all pref &lt;span class="m">1&lt;/span> bpf handle 0x1 prog.o:&lt;span class="o">[&lt;/span>classifier&lt;span class="o">]&lt;/span> direct-action skip_sw in_hw id &lt;span class="m">19&lt;/span> tag 57cd311f2e27366b
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>in_hw&lt;/code>æ ‡å¿—è¡¨ç¤ºç¨‹åºå·²ç»offloadåˆ°äº†NICä¸­ã€‚&lt;/p>
&lt;p>æ³¨æ„ä¸èƒ½åŒæ—¶offload tcå’ŒXDP BPFï¼Œå¿…é¡»ä¸”åªèƒ½é€‰æ‹©å…¶ä¸­ä¹‹ä¸€ã€‚&lt;/p></description></item><item><title>eBPFç®€å²(è½¬)</title><link>https://justice.bj.cn/post/21.linux/ebpf%E7%AE%80%E5%8F%B2/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/ebpf%E7%AE%80%E5%8F%B2/</guid><description>&lt;h1 id="ebpfç®€å²è½¬">eBPFç®€å²(è½¬)&lt;/h1>
&lt;h2 id="æºå¤´ä¸€ç¯‡-1992-å¹´çš„è®ºæ–‡">æºå¤´ï¼šä¸€ç¯‡ 1992 å¹´çš„è®ºæ–‡&lt;/h2>
&lt;p>è€ƒè™‘åˆ° BPF çš„çŸ¥ååº¦ï¼Œåœ¨ä»‹ç» eBPF ä¹‹å‰ï¼Œç¬”è€…è‡ªè§‰è¿˜æ˜¯æœ‰å¿…è¦å…ˆæ¥å›ç­”å¦ä¸€ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-bpf">ä»€ä¹ˆæ˜¯ BPF?&lt;/h2>
&lt;p>ç¬”è€…åœ¨å‰æ–‡ä¸­è¯´è¿‡äº†ï¼ŒBPF çš„å…¨ç§°æ˜¯ Berkeley Packet Filterï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºè¿‡æ»¤(filter)ç½‘ç»œæŠ¥æ–‡(packet)çš„æ¶æ„ã€‚&lt;/p>
&lt;p>å…¶å® BPF å¯è°“æ˜¯åæ°”ä¸å¤§ï¼Œä½œç”¨ä¸å°çš„å…¸èŒƒï¼šå¦‚æœç¬”è€…ä¸€å¼€å§‹æå‡º BPF çš„åŒæ—¶è¿˜æå¸¦ä¸Šå¤§åé¼é¼çš„ tcpdump æˆ– wiresharkï¼Œä¼°è®¡ç»å¤§éƒ¨åˆ†è¯»è€…éƒ½ä¼šäº†ç„¶äº†ï¼šBPF å³ä¸º tcpdump æŠ‘æˆ– wireshark ä¹ƒè‡³ç½‘ç»œç›‘æ§(Network Monitoring)é¢†åŸŸçš„åŸºçŸ³ã€‚&lt;/p>
&lt;p>ä»Šå¤©æˆ‘ä»¬çœ‹åˆ°çš„ BPF çš„è®¾è®¡ï¼Œæœ€æ—©å¯ä»¥è¿½æº¯åˆ° 1992 å¹´åˆŠè¡Œåœ¨ USENIX conference ä¸Šçš„ä¸€ç¯‡è®ºæ–‡ï¼šThe BSD Packet Filter: A New Architecture for User-level Packet Captureã€‚ç”±äºæœ€åˆç‰ˆæœ¬çš„ BPF æ˜¯å®ç°äº BSD ç³»ç»Ÿä¹‹ä¸Šçš„ï¼Œäºæ˜¯åœ¨è®ºæ–‡ä¸­ä½œè€…ç§°ä¹‹ä¸º&amp;quot;BSD Packet Filter&amp;quot;ï¼›åæ¥ç”±äº BPF çš„ç†å¿µæ¸æˆä¸»æµï¼Œä¸ºå„å¤§æ“ä½œç³»ç»Ÿæ‰€æ¥å—ï¼ŒB æ‰€ä»£è¡¨çš„ BSD ä¾¿ä¹Ÿæ¸æ¸æ·¡å»ï¼Œæœ€ç»ˆæ¼”åŒ–æˆäº†ä»Šå¤©æˆ‘ä»¬çœ¼ä¸­çš„ Berkeley Packet Filterã€‚&lt;/p>
&lt;p>è¯šç„¶ï¼Œæ— è®º BSD å’Œ Berkeley å¦‚ä½•å˜æ¢ï¼Œå…¶åçš„ Packet Filter æ€»æ˜¯ä¸å˜çš„ï¼Œè¿™ä¸¤ä¸ªå•è¯ä¹ŸåŸºæœ¬æ¦‚æ‹¬äº† BPF çš„ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿‡æ»¤(Filter): æ ¹æ®å¤–ç•Œè¾“å…¥çš„è§„åˆ™è¿‡æ»¤æŠ¥æ–‡ï¼›&lt;/li>
&lt;li>å¤åˆ¶(Copy)ï¼šå°†ç¬¦åˆæ¡ä»¶çš„æŠ¥æ–‡ç”±å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼›&lt;/li>
&lt;/ul>
&lt;p>ä»¥ tcpdump ä¸ºä¾‹ï¼šç†Ÿæ‚‰ç½‘ç»œç›‘æ§(network monitoring)çš„è¯»è€…å¤§æŠµéƒ½çŸ¥é“ tcpdump ä¾èµ–äº pcap åº“ï¼Œtcpdump ä¸­çš„è¯¸å¤šæ ¸å¿ƒåŠŸèƒ½éƒ½ç»ç”±åè€…å®ç°ï¼Œå…¶æ•´ä½“å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>å›¾ 1. Tcpdump å·¥ä½œæµç¨‹&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-22-55-epbf-image001.png" alt="">&lt;/p>
&lt;p>ç”±å›¾ 1 ä¸éš¾çœ‹å‡ºï¼Œä½äºå†…æ ¸ä¹‹ä¸­çš„ BPF æ¨¡å—æ˜¯æ•´ä¸ªæµç¨‹ä¹‹ä¸­æœ€æ ¸å¿ƒçš„ä¸€ç¯ï¼šå®ƒä¸€æ–¹é¢æ¥å— tcpdump ç»ç”± libpcap è½¬ç è€Œæ¥çš„æ»¤åŒ…æ¡ä»¶(Pseudo Machine Language) ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå°†ç¬¦åˆæ¡ä»¶çš„æŠ¥æ–‡å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´æœ€ç»ˆç»ç”± libpcap å‘é€ç»™ tcpdumpã€‚&lt;/p>
&lt;p>è¯»åˆ°è¿™é‡Œï¼Œä¼°è®¡æœ‰ç»éªŒçš„è¯»è€…å·²ç»èƒ½å¤Ÿåœ¨è„‘æµ·é‡Œå¤§è‡´å‹¾å‹’å‡ºä¸€ä¸ª BPF å®ç°çš„å¤§æ¦‚äº†ï¼Œå›¾ 2 å¼•è‡ªæ–‡çŒ® 1ï¼Œè¯»è€…ä»¬å¯ä»¥ç®¡çª¥ä¸€ä¸‹å½“æ—¶ BPF çš„è®¾è®¡ï¼š&lt;/p>
&lt;p>å›¾ 2. BPF Overview&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-23-01-epbf002.png" alt="">&lt;/p>
&lt;p>æ—¶è‡³ä»Šæ—¥ï¼Œä¼ ç»Ÿ BPF ä»ç„¶éµå¾ªå›¾ 2 çš„è·¯æ•°ï¼šé€”ç»ç½‘å¡é©±åŠ¨å±‚çš„æŠ¥æ–‡åœ¨ä¸ŠæŠ¥ç»™åè®®æ ˆçš„åŒæ—¶ä¼šå¤šå‡ºä¸€è·¯æ¥ä¼ é€ç»™ BPFï¼Œå†ç»åè€…è¿‡æ»¤åæœ€ç»ˆæ‹·è´ç»™ç”¨æˆ·æ€çš„åº”ç”¨ã€‚é™¤å¼€æœ¬æ–‡æåŠçš„ tcpdumpï¼Œå½“æ—¶çš„ RARP åè®®ä¹Ÿå¯ä»¥åˆ©ç”¨ BPF å·¥ä½œ(Linux 2.2 èµ·ï¼Œå†…æ ¸å¼€å§‹æä¾› rarp åŠŸèƒ½ï¼Œå› æ­¤å¦‚ä»Šçš„ RARP å·²ç»ä¸å†éœ€è¦ BPF äº†)ã€‚&lt;/p>
&lt;p>æ•´ä½“æ¥è¯´ï¼ŒBPF çš„æ¶æ„è¿˜æ˜¯ç›¸å¯¹æµ…æ˜¾æ˜“æ‡‚çš„ï¼Œä¸è¿‡è¦æ˜¯æ·±å…¥ç»†èŠ‚çš„è¯å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ï¼šå› ä¸ºå…¶ä¸­çš„ filter çš„è®¾è®¡ï¼ˆä¹Ÿæ˜¯æ–‡çŒ® 1 ä¸­ç€å¢¨æœ€å¤šçš„åœ°æ–¹ï¼‰è¦å¤æ‚é‚£ä¹ˆä¸€ç‚¹ç‚¹ã€‚&lt;/p>
&lt;h3 id="pseudo-machine-language">Pseudo Machine Language&lt;/h3>
&lt;p>ä¼°è®¡åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œç›¸å½“æ•°é‡çš„è¯»è€…éƒ½ä¼šè¯¯ä»¥ä¸ºæ‰€è°“çš„ Filter&lt;/p>
&lt;p>çš„æ˜¯æŒ‚åœ¨ tcpdump æœ«å°¾å¤„çš„ expression å§ï¼Œç±»ä¼¼äºå›¾ 1 ä¸­çš„&amp;quot;tcp and dst port 7070&amp;quot;è¿™æ ·ã€‚ä½†å€˜è‹¥æˆ‘ä»¬å¦‚ä¸‹æ–‡è¿™æ ·åœ¨ tcpdump çš„è°ƒç”¨ä¸­åŠ å…¥ä¸€ä¸ª-dï¼Œè¿˜ä¼šå‘ç°å…¶ä¸­å¤§æœ‰ä¹¾å¤ï¼š&lt;/p>
&lt;p>æ¸…å• 1 tcpdump -d&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">#ä»¥ä¸‹ä»£ç å¯ä»¥åœ¨ä»»æ„æ”¯æŒ tcpdump çš„ç±» Unix å¹³å°ä¸Šè¿è¡Œï¼Œè¾“å‡ºå¤§åŒå°å¼‚
bash-3.2$ sudo tcpdump -d -i lo tcp and dst port 7070
(000) ldh [12]
(001) jeq #0x86dd jt 2 jf 6 #æ£€æµ‹æ˜¯å¦ä¸º ipv6 æŠ¥æ–‡ï¼Œè‹¥ä¸ºå‡(jf)åˆ™æŒ‰ç…§ ipv4 æŠ¥æ–‡å¤„ç†(L006)
(002) ldb [20]
(003) jeq #0x6 jt 4 jf 15 #æ£€æµ‹æ˜¯å¦ä¸º tcp æŠ¥æ–‡
(004) ldh [56]
(005) jeq #0x1b9e jt 14 jf 15 #æ£€æµ‹æ˜¯å¦ç›®æ ‡ç«¯å£ä¸º 7070(0x1b9e)ï¼Œè‹¥ä¸ºçœŸ(jt)åˆ™è·³è½¬ L014
(006) jeq #0x800 jt 7 jf 15 #æ£€æµ‹æ˜¯å¦ä¸º ipv4 æŠ¥æ–‡
(007) ldb [23]
(008) jeq #0x6 jt 9 jf 15 #æ£€æµ‹æ˜¯å¦ä¸º tcp æŠ¥æ–‡
(009) ldh [20]
(010) jset #0x1fff jt 15 jf 11 #æ£€æµ‹æ˜¯å¦ä¸º ip åˆ†ç‰‡(IP fragmentation)æŠ¥æ–‡
(011) ldxb 4*([14]&amp;amp;0xf)
(012) ldh [x + 16] #æ‰¾åˆ° tcp æŠ¥æ–‡ä¸­ dest port çš„æ‰€åœ¨ä½ç½®
(013) jeq #0x1b9e jt 14 jf 15 #æ£€æµ‹æ˜¯å¦ç›®æ ‡ç«¯å£ä¸º 7070(0x1b9e)ï¼Œè‹¥ä¸ºçœŸ(jt)åˆ™è·³è½¬ L014
(014) ret #262144 #è¯¥æŠ¥æ–‡ç¬¦åˆè¦æ±‚
(015) ret #0 #è¯¥æŠ¥æ–‡ä¸ç¬¦åˆè¦æ±‚
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ ¹æ® man pageï¼Œtcpdump çš„-d ä¼šå°†è¾“å…¥çš„ expression è½¬ä¹‰ä¸ºä¸€æ®µ&amp;quot;human readable&amp;quot;çš„&amp;quot;compiled packet-matching code&amp;quot;ã€‚å½“ç„¶ï¼Œå¦‚æ¸…å• 1 ä¸­çš„å†…å®¹ï¼Œå¯¹äºå¾ˆå¤šé“è¡Œä¸æ·±çš„è¯»è€…æ¥è¯´ï¼ŒåŸºæœ¬æ˜¯&amp;quot;human unreadable&amp;quot;çš„ï¼Œäºæ˜¯ç¬”è€…ä¸“é—¨åŠ å…¥äº†ä¸€äº›æ³¨é‡ŠåŠ ä»¥è§£é‡Šï¼Œä½†æ˜¯ç›¸è¾ƒäº-dd å’Œ-ddd åäººç±»çš„è¾“å‡ºï¼Œè¿™ç¡®å¯ä»¥ç§°å¾—ä¸Šæ˜¯&amp;quot;ä¸€ç›®äº†ç„¶&amp;quot;çš„ä»£ç äº†ã€‚&lt;/p>
&lt;p>è¿™æ®µçœ‹èµ·æ¥ç±»ä¼¼äºæ±‡ç¼–çš„ä»£ç ï¼Œä¾¿æ˜¯ BPF ç”¨äºå®šä¹‰ Filter çš„ä¼ªä»£ç ï¼Œäº¦å³å›¾ 1 ä¸­ libpcap å’Œå†…æ ¸äº¤äº’çš„ pseudo machine language(ä¹Ÿæœ‰ä¸€ç§è¯´æ³•æ˜¯ï¼ŒBPF ä¼ªä»£ç è®¾è®¡ä¹‹åˆå‚è€ƒè¿‡å½“æ—¶å¤§è¡Œå…¶é“çš„ RISC ä»¤é›†çš„è®¾è®¡ç†å¿µ)ï¼Œå½“ BPF å·¥ä½œæ—¶ï¼Œæ¯ä¸€ä¸ªè¿›å‡ºç½‘å¡çš„æŠ¥æ–‡éƒ½ä¼šè¢«è¿™ä¸€æ®µä»£ç è¿‡æ»¤ä¸€éï¼Œå…¶ä¸­ç¬¦åˆæ¡ä»¶çš„(ret #262144)ä¼šè¢«å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå…¶ä½™çš„(ret #0)åˆ™ä¼šè¢«ä¸¢å¼ƒã€‚&lt;/p>
&lt;p>BPF é‡‡ç”¨çš„æŠ¥æ–‡è¿‡æ»¤è®¾è®¡çš„å…¨ç§°æ˜¯ CFG(Computation Flow Graph)ï¼Œé¡¾åæ€ä¹‰æ˜¯å°†è¿‡æ»¤å™¨æ„ç­‘äºä¸€å¥—åŸºäº if-else çš„æ§åˆ¶æµ(flow graph)ä¹‹ä¸Šï¼Œä¾‹å¦‚æ¸…å• 1 ä¸­çš„ filter å°±å¯ä»¥ç”¨å›¾ 3 æ¥è¡¨ç¤ºï¼š&lt;/p>
&lt;p>å›¾ 3 åŸºäº CFG å®ç°çš„ filter èŒƒä¾‹&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-23-07-epbf003.png" alt="">&lt;/p>
&lt;p>CFG æ¨¡å‹æœ€å¤§çš„ä¼˜åŠ¿æ˜¯å¿«ï¼Œå‚è€ƒæ–‡çŒ® 1 ä¸­å°±æ¯”è¾ƒäº† CFG æ¨¡å‹å’ŒåŸºäºæ ‘å‹ç»“æ„æ„å»ºå‡ºçš„ CSPF æ¨¡å‹çš„ä¼˜åŠ£ï¼Œå¾—å‡ºäº†åŸºäº CFG æ¨¡å‹éœ€è¦çš„è¿ç®—é‡æ›´å°çš„ç»“è®ºï¼›ä½†ä»å¦ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼ŒåŸºäºä¼ªä»£ç çš„è®¾è®¡å´ä¹Ÿå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼šä¸€æ–¹é¢ä¼ªæŒ‡ä»¤é›†å·²ç»è¶³å¤Ÿè®©äººçœ¼èŠ±ç¼­ä¹±çš„äº†ï¼›å¦ä¸€æ–¹é¢ä¸ºäº†æ‰§è¡Œä¼ªä»£ç ï¼Œå†…æ ¸ä¸­è¿˜éœ€è¦ä¸“é—¨å®ç°ä¸€ä¸ªè™šæ‹Ÿæœº(pseudo-machine)ï¼Œè¿™ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†å¼€å‘å’Œç»´æŠ¤çš„é—¨æ§›ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œæˆ–è®¸æ˜¯ä¸ºäº†æå‡ç³»ç»Ÿçš„æ˜“ç”¨æ€§ï¼Œä¸€æ–¹é¢ BPF è®¾è®¡è€…ä»¬åˆé¢å¤–åœ¨ tcpdump ä¸­è®¾è®¡äº†æˆ‘ä»¬ä»Šå¤©å¸¸è§çš„è¿‡æ»¤è¡¨è¾¾å¼(å®é™…å®ç°äº libpcapï¼Œå½“ç„¶ä¸¤è€…ä¹Ÿéƒ½æºäº Lawrence Berkeley Lab)ï¼Œä»¤è¿‡æ»¤å™¨çœŸæ­£æ„ä¹‰ä¸Š&amp;quot;Human Readable&amp;quot;äº†èµ·æ¥ï¼›å¦ä¸€æ–¹é¢ï¼Œç”±äºè®¾è®¡ç›®æ ‡åªæ˜¯è¿‡æ»¤å­—èŠ‚æµå½¢å¼çš„æŠ¥æ–‡ï¼Œè™šæ‹ŸæœºåŠå…¶ä¼ªæŒ‡ä»¤é›†çš„è®¾è®¡ç›¸å¯¹ä¼šç®€å•ä¸å°‘ï¼šæ•´ä¸ªè™šæ‹Ÿæœºåªå®ç°äº†ä¸¤ä¸ª 32 ä½çš„å¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯ç”¨äºè¿ç®—çš„ç´¯åŠ å™¨ A å’Œé€šç”¨å¯„å­˜å™¨ Xï¼›ä¸”æŒ‡ä»¤é›†ä¹Ÿåªæœ‰å¯¥å¯¥ 20 æ¥ä¸ªï¼Œå¦‚è¡¨ 1 æ‰€ç¤ºï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>Category&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Opcodes&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Address modes&lt;/strong>&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>Load Instructions&lt;/strong>&lt;/td>
&lt;td>ldb&lt;/td>
&lt;td>[k]&lt;/td>
&lt;td>[x+k]&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>ldh&lt;/td>
&lt;td>[k]&lt;/td>
&lt;td>[x+k]&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>ld&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>#len&lt;/td>
&lt;td>M[k]&lt;/td>
&lt;td>[k]&lt;/td>
&lt;td>[x+k]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>ldx&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>#len&lt;/td>
&lt;td>M[k]&lt;/td>
&lt;td>4 * ([k] &amp;amp; 0xf)&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Store Instructions&lt;/strong>&lt;/td>
&lt;td>st&lt;/td>
&lt;td>M[k]&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>stx&lt;/td>
&lt;td>M[k]&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>ALU Instruction&lt;/strong>&lt;/td>
&lt;td>add&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>sub&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>mul&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>div&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>and&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>or&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>lsh&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>rsh&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>x&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Branch Instruction&lt;/strong>&lt;/td>
&lt;td>jmp&lt;/td>
&lt;td>L&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>jeq&lt;/td>
&lt;td>#k, Lt, Lf&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>jgt&lt;/td>
&lt;td>#k, Lt, Lf&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>jge&lt;/td>
&lt;td>#k, Lt, Lf&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>jset&lt;/td>
&lt;td>#k, Lt, Lf&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Misc Instruction&lt;/strong>&lt;/td>
&lt;td>tax&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>txa&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Return Instruction&lt;/strong>&lt;/td>
&lt;td>ret&lt;/td>
&lt;td>#k&lt;/td>
&lt;td>a&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ˜“ç”¨æ€§æ–¹é¢çš„æå‡å¾ˆå¤§ç¨‹åº¦ä¸Šå¼¥è¡¥äº† BPF æœ¬èº«çš„å¤æ‚åº¦å¸¦æ¥çš„ç¼ºæ†¾ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ¨åŠ¨äº† BPF çš„å‘å±•ï¼Œæ­¤åæ•°å¹´ï¼ŒBPF é€æ¸ç§°ä¸ºå¤§ä¼—æ‰€è®¤åŒï¼ŒåŒ…æ‹¬ Linux åœ¨å†…çš„ä¼—å¤šæ“ä½œç³»ç»Ÿéƒ½å¼€å§‹å°† BPF å¼•å…¥äº†å†…æ ¸ã€‚&lt;/p>
&lt;p>é‰´äº Linux ä¸Š BPF å¦‚ç«å¦‚è¼çš„å¤§å¥½å½¢åŠ¿ï¼Œæœ¬æ–‡ä½™ä¸‹çš„éƒ¨åˆ†ç¬”è€…å°†åŸºäº Linux ä¸Šçš„ BPF å®ç°è¿›è¡Œå±•å¼€ã€‚&lt;/p>
&lt;h3 id="lsf-linux-ä¸‹çš„-bpf-å®ç°">LSF: Linux ä¸‹çš„ BPF å®ç°&lt;/h3>
&lt;p>BPF æ˜¯åœ¨ 1997 å¹´é¦–æ¬¡è¢«å¼•å…¥ Linux çš„ï¼Œå½“æ—¶çš„å†…æ ¸ç‰ˆæœ¬å°šä¸º 2.1.75ã€‚å‡†ç¡®çš„è¯´ï¼ŒLinux å†…æ ¸ä¸­çš„æŠ¥æ–‡è¿‡æ»¤æœºåˆ¶å…¶å®æ˜¯æœ‰è‡ªå·±çš„åå­—çš„ï¼šLinux Socket Filterï¼Œç®€ç§° LSFã€‚ä½†ä¹Ÿè®¸æ˜¯å› ä¸º BPF åå£°å¤ªå¤§äº†å§ï¼Œè¿&lt;a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">å†…æ ¸æ–‡æ¡£&lt;/a>éƒ½ä¸å¤§ä¹°è¿™ä¸ªå¸ï¼Œç›´è¨€ LSF å…¶å®å°±æ˜¯(aka)BPFã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼ŒLSF å’Œ BPF é™¤äº†åå­—ä¸Šçš„å·®å¼‚ä»¥å¤–ï¼Œè¿˜æ˜¯æœ‰äº›ä¸åŒçš„ï¼Œé¦–å½“å…¶å†²çš„åˆ†æ­§å°±æ˜¯æ¥å£ï¼šä¼ ç»Ÿçš„ BSD å¼€å¯ BPF çš„æ–¹å¼ä¸»è¦æ˜¯é æ‰“å¼€(open)/dev/bpfX è®¾å¤‡ï¼Œä¹‹ååˆ©ç”¨ ioctl æ¥è¿›è¡Œæ§åˆ¶ï¼›è€Œ linux åˆ™é€‰æ‹©äº†åˆ©ç”¨å¥—æ¥å­—é€‰é¡¹(sockopt)SO_ATTACH_FILTER/SO_DETACH_FILTER æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç¯‡å¹…æ‰€é™ï¼Œè¿™éƒ¨åˆ†å†…å®¹ç¬”è€…å°±ä¸æ·±å…¥äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥é€šè¿‡ç§»æ­¥&lt;a href="http://man7.org/linux/man-pages/man7/socket.7.html">socket çš„ manual page&lt;/a>æˆ–&lt;a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">å†…æ ¸ filter æ–‡æ¡£&lt;/a>æ·±å…¥äº†è§£ã€‚è¿™é‡Œç¬”è€…åªç»™å‡ºä¸€ä¸ªä¾‹å­æ¥è®©è¯»è€…ä»¬å¯¹ Linux ä¸‹çš„ BPF çš„å¼€å‘æœ‰ä¸€ä¸ªç›´è§‚çš„æ„Ÿå—ï¼š&lt;/p>
&lt;h5 id="æ¸…å•-2-bpf-sample">æ¸…å• 2 BPF Sample&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;â€¦â€¦&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="c1">// tcpdump -dd ç”Ÿæˆå‡ºçš„ä¼ªä»£ç å—
&lt;/span>&lt;span class="c1">// instruction format:
&lt;/span>&lt;span class="c1">// opcode: 16bits; jt: 8bits; jf: 8bits; k: 32bits
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sock_filter&lt;/span> &lt;span class="n">code&lt;/span>&lt;span class="p">[]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="mh">0x28&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x0000000c&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (000) ldh [12]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x000086dd&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (001) jeq #0x86dd jt 2 jf 6
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x30&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000014&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (002) ldb [20]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000006&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (003) jeq #0x6 jt 4 jf 15
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x28&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000038&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (004) ldh [56]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000438&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (005) jeq #0x438 jt 14 jf 15
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000800&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (006) jeq #0x800 jt 7 jf 15
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x30&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000017&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (007) ldb [23]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000006&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (008) jeq #0x6 jt 9 jf 15
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x28&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000014&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (009) ldh [20]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x45&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00001fff&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (010) jset #0x1fff jt 15 jf 11
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0xb1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x0000000e&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (011) ldxb 4*([14]&amp;amp;0xf)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x48&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000010&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (012) ldh [x + 16]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000438&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (013) jeq #0x438 jt 14 jf 15
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00040000&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (014) ret #262144
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mh">0x6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00000000&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// (015) ret #0
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sock_fprog&lt;/span> &lt;span class="n">bpf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">code&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sock_filter&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">code&lt;/span> &lt;span class="p">};&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 1. åˆ›å»º raw socket
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AF_PACKET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SOCK_RAW&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">htons&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ETH_P_ALL&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 2. å°† socket ç»‘å®šç»™æŒ‡å®šçš„ ethernet dev
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">// ethernet dev ç”± arg 1 ä¼ å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">addr&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">addr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sll_ifindex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">if_nametoindex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sockaddr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">addr&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1">// 3. åˆ©ç”¨ SO_ATTACH_FILTER å°† bpf ä»£ç å—ä¼ å…¥å†…æ ¸
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">setsockopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SOL_SOCKET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SO_ATTACH_FILTER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">bpf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bpf&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(;&lt;/span> &lt;span class="p">;)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">bytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">recv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// 4. åˆ©ç”¨ recv()è·å–ç¬¦åˆæ¡ä»¶çš„æŠ¥æ–‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ip_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">iphdr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">buf&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">ether_header&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">inet_ntop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AF_INET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ip_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">saddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">src_addr_str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src_addr_str&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">inet_ntop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AF_INET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ip_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">daddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dst_addr_str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dst_addr_str&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;IPv%d proto=%d src=%s dst=%s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">ip_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">version&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ip_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">protocol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">src_addr_str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dst_addr_str&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¯‡å¹…æ‰€é™ï¼Œæ¸…å• 2 ä¸­ç¬”è€…åªåˆ—å‡ºäº†éƒ¨åˆ†ä»£ç ï¼Œä»£ç åˆ†æä¹Ÿä»¥æ³¨é‡Šä¸ºä¸»ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ç§»æ­¥&lt;a href="https://raw.githubusercontent.com/windywolf/example/master/eBPF/bpfsample.c">è¿™&lt;/a>&lt;a href="https://raw.githubusercontent.com/windywolf/example/master/eBPF/bpfsample.c">é‡Œ&lt;/a>é˜…è¯»å®Œå…¨ç‰ˆã€‚&lt;/p>
&lt;p>ç”±äºä¸»è¦æ˜¯å’Œè¿‡æ»¤æŠ¥æ–‡æ‰“äº¤é“ï¼Œå†…æ ¸ä¸­(before 3.18)çš„ BPF çš„ç»å¤§éƒ¨åˆ†å®ç°éƒ½è¢«æ”¾åœ¨äº†&lt;a href="http://elixir.free-electrons.com/linux/v2.6.39.4/source/net/core/filter.c">net/core/filter.c&lt;/a>ä¸‹ï¼Œç¯‡å¹…åŸå› ç¬”è€…å°±ä¸å¯¹ä»£ç è¿›è¡Œè¯¦è¿°äº†ï¼Œæ–‡ä»¶ä¸é•¿ï¼Œ600 æ¥è¡Œ(v2.6)ï¼Œæ¯”è¾ƒæµ…æ˜¾æ˜“æ‡‚ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ç§»æ­¥å“è¯„ä¸€ä¸‹ã€‚å€¼å¾—ç•™æ„çš„å‡½æ•°æœ‰ä¸¤ä¸ªï¼Œsk_attach_filter()å’Œsk_run_filter()ï¼šå‰è€…å°† filter ä¼ªä»£ç ç”±ç”¨æˆ·ç©ºé—´å¤åˆ¶è¿›å†…æ ¸ç©ºé—´ï¼›åè€…åˆ™è´Ÿè´£åœ¨æŠ¥æ–‡åˆ°æ¥æ—¶æ‰§è¡Œä¼ªç è§£æã€‚&lt;/p>
&lt;h3 id="æ¼”è¿›jit-for-bpf">æ¼”è¿›ï¼šJIT For BPF&lt;/h3>
&lt;p>BPF è¢«å¼•å…¥ Linux ä¹‹åï¼Œé™¤äº†ä¸€äº›å°çš„æ€§èƒ½æ–¹é¢çš„è°ƒæ•´æ„å¤–ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½æ²¡æœ‰ä»€ä¹ˆåŠ¨é™ã€‚ç›´åˆ° 3.0 æ‰é¦–æ¬¡è¿æ¥äº†æ¯”è¾ƒå¤§çš„é©æ–°ï¼šåœ¨ä¸€äº›ç‰¹å®šç¡¬ä»¶å¹³å°ä¸Šï¼ŒBPF å¼€å§‹æœ‰äº†ç”¨äºæé€Ÿçš„ JIT(Just-In-Time) Compilerã€‚&lt;/p>
&lt;p>æœ€å…ˆå®ç° JIT çš„æ˜¯&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/x86/net">x&lt;/a>&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/x86/net">8&lt;/a>&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/x86/net">6&lt;/a>å¹³å°ï¼Œå…¶ååŒ…æ‹¬&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/arm/net">arm&lt;/a>ã€&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/powerpc/net">ppc&lt;/a>ã€&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/390/net">S390&lt;/a>ã€&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/arch/mips/net">mips&lt;/a>ç­‰ä¸€ä¼—å¹³å°çº·çº·è·Ÿè¿›ï¼Œåˆ°ä»Šå¤© Linux çš„ä¸»æµå¹³å°ä¸­æ”¯æŒ JIT For BPF çš„å·²ç»å äº†ç»å¤§å¤šæ•°äº†ã€‚&lt;/p>
&lt;p>BPF JIT çš„æ¥å£è¿˜æ˜¯ç®€å•æ¸…æ™°çš„ï¼šå„å¹³å°çš„ JIT ç¼–è¯‘å‡½æ•°éƒ½å®ç°äº&lt;a href="http://elixir.free-electrons.com/linux/v3.10.107/source/arch/x86/net/bpf_jit_comp.c#L147">bpf_jit_compile()&lt;/a>ä¹‹ä¸­(3.16 ä¹‹åï¼Œå¼€å§‹é€æ­¥æ”¹ä¸º&lt;a href="http://elixir.free-electrons.com/linux/v3.16/source/arch/x86/net/bpf_jit_comp.c#L869">bpf_int_jit_compile()&lt;/a>)ï¼Œå¦‚æœ CONFIG_BPF_JIT è¢«æ‰“å¼€ï¼Œåˆ™ä¼ å…¥çš„ BPF ä¼ªä»£ç å°±ä¼šè¢«ä¼ å…¥è¯¥å‡½æ•°åŠ ä»¥ç¼–è¯‘ï¼Œç¼–è¯‘ç»“æœè¢«æ‹¿æ¥æ›¿æ¢æ‰é»˜è®¤çš„å¤„ç†å‡½æ•° sk_run_filter()ã€‚JIT çš„å®ç°ä¸åœ¨æœ¬æ–‡è®¨è®ºä¹‹åˆ—ï¼Œå…¶ä»£ç åŸºæœ¬ä½äº arch/&lt;platform>/net ä¹‹ä¸‹ï¼Œæœ‰è‡´åŠ›äºä¼˜åŒ–çš„åŒå­¦å¯ä»¥å°è¯•å­¦ä¹ ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>æ‰“å¼€ BPF çš„ JIT å¾ˆç®€å•ï¼Œåªè¦å‘/proc/sys/net/core/bpf_jit_enable å†™å…¥ 1 å³å¯ï¼›å¯¹äºæœ‰è°ƒè¯•éœ€æ±‚çš„å¼€å‘è€…è€Œè¨€ï¼Œå¦‚æœå†™å…¥ 2 çš„è¯ï¼Œè¿˜å¯ä»¥åœ¨å†…æ ¸ log ä¸­çœ‹åˆ°è½½å…¥ BPF ä»£ç æ—¶å€™ JIT ç”Ÿæˆçš„ä¼˜åŒ–ä»£ç ï¼Œå†…æ ¸å¼€å‘è€…ä»¬è¿˜æä¾›äº†ä¸€ä¸ªæ›´åŠ æ–¹ä¾¿çš„å·¥å…·&lt;a href="http://elixir.free-electrons.com/linux/v4.12.8/source/tools/net">bpf_jit_disam&lt;/a>ï¼Œå¯ä»¥å°†å†…æ ¸ log ä¸­çš„äºŒè¿›åˆ¶è½¬æ¢ä¸ºæ±‡ç¼–ä»¥ä¾¿é˜…è¯»ã€‚&lt;/p>
&lt;p>JIT Compiler ä¹‹åï¼Œé’ˆå¯¹ BPF çš„å°æ”¹è¿›ä¸æ–­ï¼šå¦‚å°† BPF å¼•å…¥ seccomp(3.4)ï¼›æ·»åŠ ä¸€äº› debug å·¥å…·å¦‚ bpf_asm å’Œ bpf_dbg(3.14)ã€‚ä¸è¿‡æ¯”è¾ƒé©å‘½æ€§çš„å¤§åŠ¨ä½œå°±è¦ç­‰åˆ° 3.17 äº†ï¼Œè¿™æ¬¡çš„æ”¹è¿›è¢«ç§°ä¸º extended BPFï¼Œå³ eBPFã€‚&lt;/p>
&lt;h2 id="è¿›åŒ–extended-bpf">è¿›åŒ–ï¼šextended BPF&lt;/h2>
&lt;p>è‡ª 3.15 ä¼Šå§‹ï¼Œä¸€ä¸ªå¥—æºäº BPF çš„å…¨æ–°è®¾è®¡å¼€å§‹é€æ¸è¿›å…¥äººä»¬çš„è§†é‡ï¼Œå¹¶æœ€ç»ˆ(3.17)è¢«æ·»ç½®åˆ°äº† kernel/bpf ä¸‹ã€‚è¿™ä¸€å…¨æ–°è®¾è®¡æœ€ç»ˆè¢«å‘½åä¸ºäº† extended BPF(eBPF)ï¼šé¡¾åæ€ä¹‰ï¼Œæœ‰å…¨é¢æ‰©å……æ—¢æœ‰ BPF åŠŸèƒ½ä¹‹æ„ï¼›è€Œç›¸å¯¹åº”çš„ï¼Œä¸ºäº†åå‘å…¼å®¹ï¼Œä¼ ç»Ÿçš„ BPF ä»è¢«ä¿ç•™äº†ä¸‹æ¥ï¼Œå¹¶è¢«é‡å‘½åä¸º classical BPF(cBPF)ã€‚&lt;/p>
&lt;p>ç›¸å¯¹äº cBPFï¼ŒeBPF å¸¦æ¥çš„æ”¹å˜å¯è°“æ˜¯é©å‘½æ€§çš„ï¼šä¸€æ–¹é¢ï¼Œå®ƒå·²ç»ä¸ºå†…æ ¸è¿½è¸ª(Kernel Tracing)ã€åº”ç”¨æ€§èƒ½è°ƒä¼˜/ç›‘æ§ã€æµæ§(Traffic Control)ç­‰é¢†åŸŸå¸¦æ¥äº†æ¿€åŠ¨äººå¿ƒçš„å˜é©ï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨æ¥å£çš„è®¾è®¡ä»¥åŠæ˜“ç”¨æ€§ä¸Šï¼ŒeBPF ä¹Ÿæœ‰äº†è¾ƒå¤§çš„æ”¹è¿›ã€‚&lt;/p>
&lt;p>Linux å†…æ ¸ä»£ç çš„ samples ç›®å½•ä¸‹æœ‰å¤§é‡å‰äººè´¡çŒ®çš„&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/samples/bpf">eBPF sample&lt;/a>ï¼Œè¿™é‡Œç¬”è€…å…ˆæŒ‘é€‰å…¶ä¸­ç›¸å¯¹ç®€å•çš„ sockex1 æ¥å¸®åŠ©è¯»è€…ä»¬å»ºç«‹ä¸€ä¸ª eBPF çš„åˆæ­¥å°è±¡ï¼š&lt;/p>
&lt;h5 id="æ¸…å•-3-sockex1_userc">æ¸…å• 3 sockex1_user.c&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;â€¦&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="c1">// ç¯‡å¹…æ‰€é™ï¼Œæ¸…å• 3 å’Œ 4 éƒ½åªç½—åˆ—å‡ºéƒ¨åˆ†å…³é”®ä»£ç ï¼Œæœ‰å…´è¶£ä¸€çª¥å…¨è²Œçš„è¯»è€…å¯ä»¥ç§»æ­¥ http://elixir.free-electrons.com/linux/v4.12.6/source/samples/bpfæ·±å…¥å­¦ä¹ 
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">ac&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">// 1. eBPF çš„ä¼ªä»£ç ä½äº sockex1_kern.o ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªç”± llvm ç”Ÿæˆçš„ elf æ ¼å¼æ–‡ä»¶ï¼ŒæŒ‡ä»¤é›†ä¸º bpf;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">snprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;%s_kern.o&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">load_bpf_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// load_bpf_file()å®šä¹‰äº bpf_load.cï¼Œåˆ©ç”¨ libelf æ¥è§£æ sockex1_kern.o
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¹¶åˆ©ç”¨ bpf_load_program å°†è§£æå‡ºçš„ä¼ªä»£ç  attach è¿›å†…æ ¸;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1">// 2. å› ä¸º sockex1_kern.o ä¸­ bpf ç¨‹åºçš„ç±»å‹ä¸º BPF_PROG_TYPE_SOCKET_FILTER
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨ç”¨ SO_ATTACH_BPF æ¥æŒ‡æ˜ç¨‹åºçš„ sk_filter è¦æŒ‚è½½åˆ°å“ªä¸€ä¸ªå¥—æ¥å­—ä¸Š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">sock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">open_raw_sock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;lo&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">setsockopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SOL_SOCKET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SO_ATTACH_BPF&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">prog_fd&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prog_fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]))&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 3. åˆ©ç”¨ map æœºåˆ¶è·å–ç»ç”± lo å‘å‡ºçš„ tcp æŠ¥æ–‡çš„æ€»é•¿åº¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IPPROTO_TCP&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bpf_map_lookup_elem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map_fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">tcp_cnt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¸…å• 4 sockex1_kern.c&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;â€¦â€¦&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="c1">// é¢„å…ˆå®šä¹‰å¥½çš„ map å¯¹è±¡
&lt;/span>&lt;span class="c1">// è¿™é‡Œè¦æ³¨æ„å¥½å…¶å® map æ˜¯éœ€è¦ç”±ç”¨æˆ·ç©ºé—´ç¨‹åºè°ƒç”¨ bpf_create_map()è¿›è¡Œåˆ›å»ºçš„
&lt;/span>&lt;span class="c1">// åœ¨è¿™é‡Œå®šä¹‰çš„ map å¯¹è±¡ï¼Œå®é™…ä¸Šä¼šåœ¨ load_bpf_file()è§£æ ELF æ–‡ä»¶çš„åŒæ—¶è¢«è§£æå’Œåˆ›å»ºå‡ºæ¥
&lt;/span>&lt;span class="c1">// è¿™é‡Œçš„ SEC(NAME)å®è¡¨ç¤ºåœ¨å½“å‰ obj æ–‡ä»¶ä¸­æ–°å¢ä¸€ä¸ªæ®µ(section)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">bpf_map_def&lt;/span> &lt;span class="nf">SEC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;maps&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">my_map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BPF_MAP_TYPE_ARRAY&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">key_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u32&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">value_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">max_entries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">256&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="n">SEC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;socket1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">bpf_prog1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">__sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">// è¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œä»…ä»…æ˜¯è¯»å–è¾“å…¥æŠ¥æ–‡çš„åŒ…å¤´ä¸­çš„åè®®ä½è€Œå·²
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¿™é‡Œçš„ load_byte å®é™…æŒ‡å‘äº† llvm çš„ built-in å‡½æ•° asm(llvm.bpf.load.byte)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ç”¨äºç”Ÿæˆ eBPF æŒ‡ä»¤ BPF_LD_ABS å’Œ BPF_LD_IND
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">load_byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ETH_HLEN&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offsetof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">iphdr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">protocol&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// â€¦â€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ ¹æ® key(&amp;amp;indexï¼Œæ³¨æ„è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„å¼•ç”¨)è·å–å¯¹åº”çš„ value
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bpf_map_lookup_elem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_map&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">__sync_fetch_and_add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//è¿™é‡Œçš„__sync_fetch_and_add æ˜¯ llvm ä¸­çš„å†…åµŒå‡½æ•°ï¼Œè¡¨ç¤º atomic åŠ æ“ä½œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä¸ºäº†æ»¡è¶³ GPL æ¯’è¯çš„éœ€æ±‚ï¼Œæ‰€æœ‰ä¼šæ³¨å…¥å†…æ ¸çš„ BPF ä»£ç éƒ½é¡»æ˜¾å¼çš„æ”¯æŒ GPL åè®®
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="n">_license&lt;/span>&lt;span class="p">[]&lt;/span> &lt;span class="n">SEC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;license&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;GPL&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹æ¯”ä¸€ä¸‹æ¸…å• 3&amp;amp;4 ä»¥åŠæ¸…å• 2 çš„ä»£ç ç‰‡æ®µï¼Œå¾ˆå®¹æ˜“çœ‹å‡ºä¸€äº› eBPF æ˜¾è€Œæ˜“è§çš„é©æ–°ï¼š&lt;/p>
&lt;ul>
&lt;li>ç”¨ C å†™æˆçš„ BPF ä»£ç (sockex1_kern.o)ï¼›&lt;/li>
&lt;li>åŸºäº map çš„å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´çš„äº¤äº’æ–¹å¼ï¼›&lt;/li>
&lt;li>å…¨æ–°çš„å¼€å‘æ¥å£ï¼›&lt;/li>
&lt;/ul>
&lt;p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä¸é‚£ä¹ˆæ˜æ˜¾çš„æ”¹è¿›éšè—åœ¨å†…æ ¸ä¹‹ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>å…¨æ–°çš„ä¼ªæŒ‡ä»¤é›†è®¾è®¡ï¼›&lt;/li>
&lt;li>In-kernel verifier;&lt;/li>
&lt;/ul>
&lt;p>ç”±ä¸€ä¸ªæ–‡ä»¶(net/core/filter.c)è¿›åŒ–åˆ°ä¸€ä¸ªç›®å½•(kernel/bpf)ï¼ŒeBPF çš„èœ•å˜ä¸‰è¨€ä¸¤è¯­é—´å¾ˆéš¾äº¤ä»£æ¸…æ¥šï¼Œä¸‹é¢ç¬”è€…å°±å…ˆåŸºäºä¸Šè¿°çš„å‡ ç‚¹å˜åŒ–æ¥å¸®åŠ©å¤§å®¶å…¥ä¸ªé—¨ï¼Œè‡³äºä¸ªä¸­ç»†èŠ‚ï¼Œå°±åªèƒ½é è¯»è€…ä»¥åè‡ªå·±ä¿®è¡Œäº†ã€‚&lt;/p>
&lt;h3 id="å†è§äº†æ±‡ç¼–">å†è§äº†æ±‡ç¼–&lt;/h3>
&lt;p>åˆ©ç”¨é«˜çº§è¯­è¨€ä¹¦å†™ BPF é€»è¾‘å¹¶ç»ç”±ç¼–è¯‘å™¨ç”Ÿæˆå‡ºä¼ªä»£ç æ¥å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œçš„å°è¯•ï¼Œæ¯”å¦‚ libpcap å°±æ˜¯åœ¨ä»£ç ä¸­å†…åµŒäº†ä¸€ä¸ªå°å‹ç¼–è¯‘å™¨æ¥åˆ†æ tcpdump ä¼ å…¥çš„ filter expression ä»è€Œç”Ÿæˆ BPF ä¼ªç çš„ã€‚åªä¸è¿‡é•¿ä¹…ä»¥æ¥è¯¥åŠŸèƒ½ä¸€ç›´æ²¡æœ‰èƒ½è¢«ç‹¬ç«‹å‡ºæ¥æˆ–è€…åšå¤§åšå¼ºï¼Œç©¶å…¶åŸå› ï¼Œä¸»è¦è¿˜æ˜¯ç”±äºä¼ ç»Ÿçš„ BPF æ‰€è¾–é¢†åŸŸç‹­çª„ï¼Œè¿‡æ»¤æœºåˆ¶ä¹Ÿä¸ç”šå¤æ‚ï¼Œå°±ç®—æ˜¯åšçš„å‡ºæ¥ï¼Œä¼°è®¡ä¹Ÿä¸å ªå¤§ç”¨ã€‚&lt;/p>
&lt;p>ç„¶è€Œåˆ°äº† eBPF çš„æ—¶ä»£ï¼Œæƒ…å†µç»ˆäºå‘ç”Ÿäº†å˜åŒ–ï¼šç°è¡Œçš„ä¼ªæŒ‡ä»¤é›†è¾ƒä¹‹è¿‡å»å·²ç»å¤æ‚å¤ªå¤šï¼Œå†ç”¨çº¯æ±‡ç¼–çš„å¼€å‘æ–¹å¼å·²ç»ä¸åˆæ—¶å®œï¼Œäºæ˜¯ï¼Œè‡ªç„¶è€Œç„¶çš„ï¼Œåˆ©ç”¨ C ä¸€ç±»çš„é«˜çº§è¯­è¨€ä¹¦å†™ BPF ä¼ªä»£ç çš„å‘¼å£°ä¾¿é€æ¸é«˜æ¶¨äº†èµ·æ¥ã€‚&lt;/p>
&lt;p>ç›®å‰ï¼Œæ”¯æŒç”Ÿæˆ BPF ä¼ªä»£ç çš„ç¼–è¯‘å™¨åªæœ‰ llvm ä¸€å®¶ï¼Œå³ä½¿æ˜¯é€šç¯‡ä½¿ç”¨ gcc ç¼–è¯‘çš„ Linux å†…æ ¸ï¼Œsamples ç›®å½•ä¸‹çš„ bpf èŒƒä¾‹ä¹Ÿè¦å€Ÿç”¨ llvm æ¥ç¼–è¯‘å®Œæˆã€‚è¿˜æ˜¯ä»¥ sockex1 ä¸ºä¾‹ï¼Œç”¨æˆ·æ€ä¸‹çš„ä»£ç  sockex_user.c æ˜¯åˆ©ç”¨ HOSTCC å®šä¹‰çš„ç¼–è¯‘å™¨ç¼–è¯‘çš„ï¼›ä½† sockex_kern.c å°±éœ€è¦ç”¨åˆ° clang å’Œ llvm äº†ã€‚åœ¨&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/samples/bpf/Makefile">samples/bpf/Makefile&lt;/a>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼š&lt;/p>
&lt;h5 id="æ¸…å•-5-samplesbpfmakefile">æ¸…å• 5 samples/bpf/Makefile&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="c"># ......
&lt;/span>&lt;span class="c"># List of programs to build
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nv">hostprogs-y&lt;/span> &lt;span class="o">:=&lt;/span> test_lru_dist
&lt;span class="nv">hostprogs-y&lt;/span> &lt;span class="o">+=&lt;/span> sockex1
&lt;span class="c"># â€¦â€¦
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nv">sockex1-objs&lt;/span> &lt;span class="o">:=&lt;/span> bpf_load.o &lt;span class="k">$(&lt;/span>LIBBPF&lt;span class="k">)&lt;/span> sockex1_user.o
&lt;span class="c"># â€¦â€¦
&lt;/span>&lt;span class="c"># æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå° tipï¼Œå°±æ˜¯å¦‚æœåœ¨å†…æ ¸çš„ Makefile ä¸­ï¼Œ
&lt;/span>&lt;span class="c"># æœ‰æŸä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä½ ä¸å¸Œæœ›ä½¿ç”¨å†…æ ¸çš„é€šç”¨ç¼–è¯‘è§„åˆ™çš„è¯(ç±»ä¼¼äºæœ¬æ–‡çš„ sockex1_kern.o)ï¼Œ
&lt;/span>&lt;span class="c"># å¯ä»¥åƒè¿™é‡Œä¸€æ ·ï¼Œå¹¶ä¸æŠŠè¯¥æ–‡ä»¶åŠ å…¥ä»»ä½• xxxprogs æˆ– xxx-objsï¼Œ
&lt;/span>&lt;span class="c"># è€Œæ˜¯ç›´æ¥æ”¾å…¥ alwaysï¼Œè¿™æ ·å†…æ ¸å°±ä¼šåœ¨æœ¬åœ° Makefile ä¸­æœç´¢ç¼–è¯‘è§„åˆ™äº†ã€‚
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nv">always&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">$(&lt;/span>hostprogs-y&lt;span class="k">)&lt;/span>
&lt;span class="err">&amp;lt;strong&amp;gt;always&lt;/span> &lt;span class="err">&amp;lt;/strong&amp;gt;&amp;lt;strong&amp;gt;+=&lt;/span> &lt;span class="err">sockex1_kern.o&amp;lt;/strong&amp;gt;&lt;/span>
&lt;span class="c"># â€¦â€¦
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nv">LLC&lt;/span> &lt;span class="o">?=&lt;/span> llc
&lt;span class="nv">CLANG&lt;/span> &lt;span class="o">?=&lt;/span> clang
&lt;span class="c"># â€¦â€¦
&lt;/span>&lt;span class="c"># sockex1_kern.o å°±æ˜¯ä½¿ç”¨äº†ä¸‹è¿°è§„åˆ™ç¼–è¯‘ä¸º BPF ä»£ç çš„ï¼Œè¯·æ³¨æ„ç¬”è€…åŠ ç²—çš„éƒ¨åˆ†
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nf">$(obj)/%.o&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nv">src&lt;/span>&lt;span class="k">)&lt;/span>/%.&lt;span class="n">c&lt;/span>
&lt;span class="k">$(&lt;/span>&lt;span class="nv">CLANG&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nv">NOSTDINC_FLAGS&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nv">LINUXINCLUDE&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nv">EXTRA_CFLAGS&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="err">\&lt;/span>
&lt;span class="err">-D__KERNEL__&lt;/span> &lt;span class="err">-D__ASM_SYSREG_H&lt;/span> &lt;span class="err">-Wno-unused-value&lt;/span> &lt;span class="err">-Wno-pointer-sign&lt;/span> &lt;span class="err">\&lt;/span>
&lt;span class="err">-Wno-compare-distinct-pointer-types&lt;/span> &lt;span class="err">\&lt;/span>
&lt;span class="err">-Wno-gnu-variable-sized-type-not-at-end&lt;/span> &lt;span class="err">\&lt;/span>
&lt;span class="err">-Wno-address-of-packed-member&lt;/span> &lt;span class="err">-Wno-tautological-compare&lt;/span> &lt;span class="err">\&lt;/span>
&lt;span class="err">-Wno-unknown-warning-option&lt;/span> &lt;span class="err">\&lt;/span>
&lt;span class="err">-O2&lt;/span> &lt;span class="err">-emit-llvm&lt;/span> &lt;span class="err">-c&lt;/span> &lt;span class="k">$&amp;lt;&lt;/span> &lt;span class="err">-o&lt;/span> &lt;span class="err">-|&lt;/span>
&lt;span class="k">$(&lt;/span>&lt;span class="nv">LLC&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="nv">-march&lt;/span>&lt;span class="o">=&lt;/span>bpf -filetype&lt;span class="o">=&lt;/span>obj -o
&lt;span class="k">$@&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>èƒ½ç”¨ C ä¹¦å†™ BPF è‡ªç„¶æ˜¯ä¾¿åˆ©äº†è®¸å¤šï¼Œä½†ä¹Ÿä¸ä»£è¡¨ä½™ä¸‹çš„å¼€å‘å·¥ä½œå°±æ˜¯ä¸€ç‰‡å¦é€”äº†ï¼šé¦–å…ˆ llvm çš„è¾“å‡ºæ˜¯ elf æ–‡ä»¶ï¼Œè¿™ä¹Ÿæ„å‘³ç€æƒ³è¦è·å–èƒ½ä¼ å…¥å†…æ ¸çš„ä»£ç ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–åšä¸€æ®µè§£æ elf çš„å·¥ä½œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Sample ä¸‹çš„èŒƒä¾‹å‡ ä¹æ— ä¸€ä¾‹å¤–åœ°éƒ½é“¾æ¥äº† libelf åº“ï¼›å…¶æ¬¡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹ï¼Œä¸è¦å¿˜è®° BPF çš„ä»£ç æ˜¯è·‘åœ¨å†…æ ¸ç©ºé—´ä¸­çš„ï¼Œå› æ­¤ä¹¦å†™æ—¶å¿…å¾—ç…è´¹è‹¦å¿ƒä¸€ç•ªæ‰å¥½ï¼Œä»¥é˜²ä¸€ä¸ªä¸å°å¿ƒå°±åšå‡ºä¸ªæŠŠå†…æ ¸å¹²è¶´ä¸‹çš„æ¼æ´æ¥ï¼šä¸‹æ–‡ä¸­æåŠçš„ verifier å°±æ˜¯ä¸ºäº†è¿™ä¸€ç‚¹è€Œç”Ÿï¼Œæ¯ä¸€ä¸ªè¢«æ”¾è¿›å†…æ ¸çš„ BPF ä»£ç ï¼Œéƒ½é¡»è¦ç»è¿‡å®ƒçš„æ£€éªŒæ‰è¡Œã€‚&lt;/p>
&lt;h3 id="bpf-ç¨‹åºçš„ç±»åˆ«ä»¥åŠ-map-æœºåˆ¶">BPF ç¨‹åºçš„ç±»åˆ«ä»¥åŠ Map æœºåˆ¶&lt;/h3>
&lt;p>æ¸…å• 3 ä¸­æˆ‘ä»¬çœ‹åˆ° sockex1_kern.o æ˜¯ç”± load_bpf_file()å‡½æ•°è½½å…¥å†…å­˜çš„ï¼Œä½†å®é™…ä¸Š eBPF æä¾›ç”¨æ¥å°† BPF ä»£ç è½½å…¥å†…æ ¸çš„æ­£å¼æ¥å£å‡½æ•°å…¶å®æ˜¯ bpf_load_program()ï¼Œè¯¥æ¥å£è´Ÿè´£é€šè¿‡å‚æ•°å‘å†…æ ¸æä¾›ä¸‰ç±»ä¿¡æ¯ï¼š&lt;/p>
&lt;ul>
&lt;li>BPF ç¨‹åºçš„ç±»å‹ã€&lt;/li>
&lt;li>BPF ä»£ç &lt;/li>
&lt;li>ä»£ç è¿è¡Œæ—¶æ‰€éœ€è¦çš„å­˜æ”¾ log çš„ç¼“å­˜åœ°å€(ä½äºç”¨æˆ·ç©ºé—´)ï¼›&lt;/li>
&lt;/ul>
&lt;p>æœ‰æ„æ€çš„æ˜¯ï¼Œç›®å‰æ‰€æœ‰æ³¨å…¥å†…æ ¸çš„ BPF ç¨‹åºéƒ½éœ€è¦é™„å¸¦ GPL åè®®æ”¯æŒä¿¡æ¯ï¼Œbpf_load_program()çš„ license å‚æ•°å°±æ˜¯ç”¨æ¥è½½å…¥åè®®å­—ä¸²çš„ã€‚&lt;/p>
&lt;p>ç”± eBPF ä¼Šå§‹ï¼ŒBPF ç¨‹åºå¼€å§‹æœ‰åˆ†ç±»äº†ï¼Œé€šè¿‡ bpf_load_program çš„å‚æ•° bpf_prog_typeï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° eBPF æ”¯æŒçš„ç¨‹åºç±»å‹ã€‚è¿™é‡Œç¬”è€…å°†ä¸€äº›å¸¸ç”¨çš„ç±»å‹ç½—åˆ—äºä¸‹è¡¨ä¹‹ä¸­ä¾›è¯»è€…å‚è€ƒï¼š&lt;/p>
&lt;h4 id="è¡¨-2-å¸¸è§-bpf_prog_type-å®šä¹‰">è¡¨ 2 å¸¸è§ bpf_prog_type å®šä¹‰&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>bpf_prog_type&lt;/strong>&lt;/th>
&lt;th>&lt;strong>BPF prog å…¥å£å‚æ•°(R1)&lt;/strong>&lt;/th>
&lt;th>&lt;strong>ç¨‹åºç±»å‹&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_SOCKET_FILTER&lt;/strong>&lt;/td>
&lt;td>&lt;strong>struct __sk_buff&lt;/strong>&lt;/td>
&lt;td>ç”¨äºè¿‡æ»¤è¿›å‡ºå£ç½‘ç»œæŠ¥æ–‡ï¼ŒåŠŸèƒ½ä¸Šå’Œ cBPF ç±»ä¼¼ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_KPROBE&lt;/strong>&lt;/td>
&lt;td>&lt;strong>struct pt_regs&lt;/strong>&lt;/td>
&lt;td>ç”¨äº kprobe åŠŸèƒ½çš„ BPF ä»£ç ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_TRACEPOINT&lt;/strong>&lt;/td>
&lt;td>è¿™ç±» BPF çš„å‚æ•°æ¯”è¾ƒç‰¹æ®Šï¼Œæ ¹æ® tracepoint ä½ç½®çš„ä¸åŒè€Œä¸åŒã€‚&lt;/td>
&lt;td>ç”¨äºåœ¨å„ä¸ª tracepoint èŠ‚ç‚¹è¿è¡Œã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_XDP&lt;/strong>&lt;/td>
&lt;td>&lt;strong>struct xdp_md&lt;/strong>&lt;/td>
&lt;td>ç”¨äºæ§åˆ¶ XDP(eXtreme Data Path)çš„ BPF ä»£ç ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_PERF_EVENT&lt;/strong>&lt;/td>
&lt;td>&lt;strong>struct bpf_perf_event_data&lt;/strong>&lt;/td>
&lt;td>ç”¨äºå®šä¹‰ perf event å‘ç”Ÿæ—¶å›è°ƒçš„ BPF ä»£ç ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_CGROUP_SKB&lt;/strong>&lt;/td>
&lt;td>&lt;strong>struct __sk_buff&lt;/strong>&lt;/td>
&lt;td>ç”¨äºåœ¨ network cgroup ä¸­è¿è¡Œçš„ BPF ä»£ç ã€‚åŠŸèƒ½ä¸Šå’Œ Socket_Filter è¿‘ä¼¼ã€‚å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒèŒƒä¾‹ test_cgrp2_attachã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>BPF_PROG_TYPE_CGROUP_SOCK&lt;/strong>&lt;/td>
&lt;td>&lt;strong>struct bpf_sock&lt;/strong>&lt;/td>
&lt;td>å¦ä¸€ä¸ªç”¨äºåœ¨ network cgroup ä¸­è¿è¡Œçš„ BPF ä»£ç ï¼ŒèŒƒä¾‹ test_cgrp2_sock2 ä¸­å°±å±•ç¤ºäº†ä¸€ä¸ªåˆ©ç”¨ BPF æ¥æ§åˆ¶ host å’Œ netns é—´é€šä¿¡çš„ä¾‹å­ã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ·±å…¥å¯¹æ¯”æ¸…å• 3(eBPF)å’Œæ¸…å• 2(cBPF)çš„å®ç°çš„å·®å¼‚ï¼Œè¿˜ä¼šå‘ç°ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„ä¸åŒä¹‹å¤„ï¼šBPF ä»£ç è¿›å†…æ ¸ä¹‹åï¼ŒcBPF å’Œå†…æ ¸é€šè®¯çš„æ–¹å¼æ˜¯ recv()ï¼›è€Œ eBPF åˆ™å°† socket ä¸¢åˆ°ä¸€è¾¹ï¼Œä½¿ç”¨ä¸€ç§åä¸º map çš„å…¨æ–°æœºåˆ¶å’Œå†…æ ¸é€šè®¯ï¼Œå…¶å¤§è‡´åŸç†ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;h4 id="å›¾-4-ebpf-çš„-map-æœºåˆ¶">å›¾ 4 eBPF çš„ map æœºåˆ¶&lt;/h4>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-23-22-epbf004.png" alt="">&lt;/p>
&lt;p>ä»å›¾ä¸Šçœ‹ï¼Œè¿™å¥—è®¾è®¡æœ¬èº«ä¸å¤æ‚ï¼šä½äºç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨åœ¨å†…æ ¸ä¸­è¾Ÿå‡ºä¸€å—ç©ºé—´å»ºç«‹èµ·ä¸€ä¸ªæ•°æ®åº“ç”¨ä»¥å’Œ eBPF ç¨‹åºäº¤äº’(bpf_create_map())ï¼›æ•°æ®åº“æœ¬èº«ä»¥ Key-Value çš„å½¢å¼è¿›è¡Œç»„ç»‡ï¼Œæ— è®ºæ˜¯ä»ç”¨æˆ·ç©ºé—´è¿˜æ˜¯å†…æ ¸ç©ºé—´éƒ½å¯ä»¥å¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œä¸¤è¾¹æœ‰ç€ç›¸ä¼¼çš„æ¥å£ï¼Œæœ€ç»ˆåœ¨é€»è¾‘ä¸Šä¹Ÿéƒ½æ®Šé€”åŒå½’ã€‚&lt;/p>
&lt;p>ä¸éš¾å‘ç°ï¼Œmap å¸¦æ¥çš„æœ€å¤§ä¼˜åŠ¿æ˜¯æ•ˆç‡ï¼šç›¸å¯¹äº cBPF ä¸€è¨€ä¸åˆå°±æŠŠä¸€ä¸ªé€šä¿¡æŠ¥æ–‡ä»å†…æ ¸ç©ºé—´ä¸¢å‡ºæ¥çš„è±ªæ”¾ï¼Œmap æœºåˆ¶ä¸‹çš„é€šè®¯è€—è´¹å°±è¦å°å®¶ç¢§ç‰çš„å¤šäº†ï¼šè¿˜æ˜¯ä»¥ sockex1 ä¸ºä¾‹ï¼Œä¸€æ¬¡é€šä¿¡ä»å†…æ ¸ä¸­ä»…ä»…å¤åˆ¶ 4 ä¸ªå­—èŠ‚ï¼Œè€Œä¸”è¿˜æ˜¯å·²ç»å¤„ç†å¥½äº†å¯ä»¥ç›´æ¥æ‹¿æ¥å°±ç”¨çš„ï¼Œåšè¿‡å†…æ ¸å¼€å‘çš„äººéƒ½çŸ¥é“è¿™å¯¹äºæ€§èƒ½æ„å‘³ç€ä»€ä¹ˆã€‚&lt;/p>
&lt;p>map æœºåˆ¶è§£å†³çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯é€šä¿¡æ•°æ®çš„å¤šæ ·æ€§é—®é¢˜ã€‚cBPF æ‰€è¦†ç›–çš„åŠŸèƒ½èŒƒå›´å¾ˆç®€å•ï¼Œæ— å¤–ä¹æ˜¯ç½‘ç»œç›‘æ§å’Œ seccomp ä¸¤å—ï¼Œæ•°æ®æ¥å£è®¾è®¡çš„ç²—æ”¾ä¸€ç‚¹ä¹Ÿå°±ç®—äº†ï¼›è€Œ eBPF çš„åˆ©ç”¨èŒƒå›´åˆ™è¦å¹¿çš„å¤šï¼Œæ€§èƒ½è°ƒä¼˜ã€å†…æ ¸ç›‘æ§ã€æµé‡æ§åˆ¶ä»€ä¹ˆçš„åº”æœ‰å°½æœ‰ï¼Œæ•°æ®æ¥å£çš„å¤šæ ·æ€§è®¾è®¡å°±æ˜¾å¾—å¾ˆå¿…è¦äº†ã€‚ä¸‹è¡¨ä¸­å°±åˆ—å‡ºäº†ç°æœ‰ eBPF ä¸­çš„ map æœºåˆ¶ä¸­å¸¸è§çš„æ•°æ®ç±»å‹ï¼š&lt;/p>
&lt;h5 id="è¡¨-3-map-æœºåˆ¶ä¸‹çš„å¸¸è§æ•°æ®ç±»å‹">è¡¨ 3. map æœºåˆ¶ä¸‹çš„å¸¸è§æ•°æ®ç±»å‹&lt;/h5>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>Category&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Source&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Bpf_map_type&lt;/strong>&lt;/th>
&lt;th>&lt;strong>ç”¨é€”&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>Array&lt;/strong>&lt;/td>
&lt;td>Arraymap.c&lt;/td>
&lt;td>BPF_MAP_TYPE_ARRAY BPF_MAP_TYPE_CGROUP_ARRAY BPF_MAP_TYPE_PERF_EVENT_ARRAY BPF_MAP_TYPE_PERCPU_ARRAY BPF_MAP_TYPE_ARRAY_OF_MAPS&lt;/td>
&lt;td>å®é™…å°±æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥æ‰€æœ‰çš„ key å¿…é¡»æ˜¯æ•´æ•°ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>BPF_MAP_TYPE_PROG_ARRAY&lt;/td>
&lt;td>è¯¥ç±»å‹æ˜¯ä¸€ä¸ªç‰¹ä¾‹ï¼Œä¸»è¦ç”¨äºè‡ªå®šä¹‰å‡½æ•°ï¼Œåˆ©ç”¨ JUMP_TAIL_CALLä»¤è·³è½¬&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Hash&lt;/strong>&lt;/td>
&lt;td>Hashmap.c&lt;/td>
&lt;td>BPF_MAP_TYPE_HASH BPF_MAP_TYPE_PERCPU_HASH BPF_MAP_TYPE_LRU_HASH BPF_MAP_TYPE_LRU_PERCPU_HASH BPF_MAP_TYPE_HASH_OF_MAPS&lt;/td>
&lt;td>çœŸæ­£æ„ä¹‰ä¸Šçš„ map æ•°æ®ç±»å‹ï¼Œå¦‚æœ key å€¼ä¸ºæ•´æ•°ä»¥å¤–çš„ç±»å‹å¿…é¡»ä½¿ç”¨&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Stack Trace&lt;/strong>&lt;/td>
&lt;td>Stackmap.c&lt;/td>
&lt;td>BPF_MAP_TYPE_STACK_TRACE&lt;/td>
&lt;td>çœŸæ­£æ„ä¹‰ä¸Šçš„ map æ•°æ®ç±»å‹ï¼Œå¦‚æœ key å€¼ä¸ºæ•´æ•°ä»¥å¤–çš„ç±»å‹å¿…é¡»ä½¿ç”¨å­˜å‚¨ç‰¹å®šåº”ç”¨åœ¨æŸä¸€ç‰¹å®šæ—¶é—´ç‚¹çš„æ ˆçŠ¶æ€(åŒ…æ‹¬å†…æ ¸æ€å’Œç”¨æˆ·æ€)ï¼Œkey åªæœ‰ä¸¤ä¸ªï¼šåˆ†åˆ«ä¸ºå†…æ ¸æ ˆ id å’Œç”¨æˆ·æ ˆ idï¼Œåˆ©ç”¨ bpf_get_stackid()è·å–;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Longest Prefix Match Trie&lt;/strong>&lt;/td>
&lt;td>Lpm_trie.c&lt;/td>
&lt;td>BPF_MAP_TYPE_LPM_TRIE&lt;/td>
&lt;td>åŸºäº Longest Prefix Match å‰ç¼€æ ‘å®ç°ï¼Œé€‚å®œå¤„ç†ä»¥ CIBR ä¸ºé”®å€¼æ—¶çš„æƒ…å†µ&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="æ–°çš„æŒ‡ä»¤é›†">æ–°çš„æŒ‡ä»¤é›†&lt;/h3>
&lt;p>eBPF å¯¹äºæ—¢æœ‰ cBPF ä»¤é›†çš„æ”¹åŠ¨é‡ä¹‹å¤§ï¼Œä»¥è‡³äºåŸºæœ¬ä¸Šä¸èƒ½è®¤ä¸ºä¸¤è€…è¿˜æ˜¯åŒä¸€ç§è¯­è¨€äº†ã€‚ä¸ªä¸­å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åæ±‡ç¼–æ¸…å• 4 çš„æºä»£ç (llvm-objdump &amp;ndash;disassemble)ç•¥çŸ¥ä¸€äºŒï¼š&lt;/p>
&lt;p>æ¸…å• 6 Disassemble of sockex1_kern.o&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-objectivec" data-lang="objectivec">&lt;span class="n">sockex1_kern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nl">o&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="n">format&lt;/span> &lt;span class="n">ELF64&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">BPF&lt;/span>
&lt;span class="n">Disassembly&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">section&lt;/span> &lt;span class="nl">socket1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nl">bpf_prog1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">bf&lt;/span> &lt;span class="mi">16&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r6&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r1&lt;/span>
&lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">30&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mi">17&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u8&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">23&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">63&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">a&lt;/span> &lt;span class="n">fc&lt;/span> &lt;span class="n">ff&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">r10&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r0&lt;/span>
&lt;span class="mi">3&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">61&lt;/span> &lt;span class="mi">61&lt;/span> &lt;span class="mo">04&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">r6&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="mi">4&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">55&lt;/span> &lt;span class="mo">01&lt;/span> &lt;span class="mi">08&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">04&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">r1&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="k">goto&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="mi">5&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">bf&lt;/span> &lt;span class="n">a2&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r10&lt;/span>
&lt;span class="mi">6&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mo">07&lt;/span> &lt;span class="mo">02&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">fc&lt;/span> &lt;span class="n">ff&lt;/span> &lt;span class="n">ff&lt;/span> &lt;span class="n">ff&lt;/span> &lt;span class="n">r2&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">4&lt;/span>
&lt;span class="mi">7&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">18&lt;/span> &lt;span class="mo">01&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0ll&lt;/span>
&lt;span class="mi">9&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">85&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">01&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">call&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="mi">10&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">15&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">02&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">r0&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="k">goto&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="mi">11&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">61&lt;/span> &lt;span class="mi">61&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">r6&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="mi">12&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">db&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u64&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">r0&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">r1&lt;/span>
&lt;span class="nl">LBB0_3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="mi">13&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">b7&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">r0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="mi">14&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">95&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="mo">00&lt;/span> &lt;span class="n">exit&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬ä¸ç”¨ç®¡è¿™æ®µæ±‡ç¼–å†™äº†ç‚¹å„¿ä»€ä¹ˆï¼Œå…ˆè·Ÿæ¸…å• 2 å¼€å¤´çš„é‚£æ®µ cBPF ä»£ç å¯¹æ¯”ä¸€ä¸‹ä¸¤è€…çš„å¼‚åŒï¼š&lt;/p>
&lt;ul>
&lt;li>å¯„å­˜å™¨ï¼šeBPF æ”¯æŒæ›´å¤šçš„å¯„å­˜å™¨ï¼›
&lt;ul>
&lt;li>cBPFï¼šA, X + stack, 32bit;&lt;/li>
&lt;li>eBPFï¼šR1~R10 + stack, 64bitï¼Œæ˜¾ç„¶ï¼Œå¦‚æ­¤çš„è®¾è®¡ä¸»è¦é’ˆå¯¹ç°åœ¨å¤§è¡Œå…¶é“çš„ 64 ä½ç¡¬ä»¶ï¼ŒåŒæ—¶æ›´å¤šçš„å¯„å­˜å™¨è®¾è®¡ä¹Ÿä¾¿äºè¿è¡Œæ—¶å’ŒçœŸå®ç¯å¢ƒä¸‹çš„å¯„å­˜å™¨è¿›è¡Œå¯¹åº”ï¼Œä»¥æé«˜æ•ˆç‡ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>opcodeï¼šä¸¤è€…çš„æ ¼å¼ä¸åŒï¼›
&lt;ul>
&lt;li>cBPF: op 16b, jt 8b, jf 8b, K 32b;&lt;/li>
&lt;li>eBPF: op 8b, dstReg 4b, srcReg 4b, off 16b, imm 32b;&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å…¶ä»–ï¼šsockex1_kern.o è®¾è®¡çš„æ¯”è¾ƒç®€å•ï¼Œä½†è¿˜æ˜¯å¯ä»¥ä»ä¸­çœ‹å‡º eBPF çš„ä¸€å¤§æ”¹è¿›ï¼šå¯ä»¥è°ƒç”¨å†…æ ¸ä¸­é¢„è®¾å¥½çš„å‡½æ•°ï¼ˆCall 1ï¼Œè¿™é‡ŒæŒ‡å‘çš„å‡½æ•°æ˜¯ bpf_map_lookup_elem()ï¼Œå¦‚æœéœ€è¦æ¯”è¾ƒå…¨çš„é¢„è®¾å‡½æ•°ç´¢å¼•çš„è¯å¯ä»¥ç§»æ­¥&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/include/uapi/linux/bpf.h#L494">è¿™é‡Œ&lt;/a>ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒeBPF å‘½ä»¤é›†ä¸­æ¯”è¾ƒé‡è¦çš„æ–°æ™‹åŠŸèƒ½è¿˜æœ‰ï¼š
&lt;ul>
&lt;li>load/store å¤šæ ·åŒ–ï¼š
&lt;ul>
&lt;li>cBPFï¼šä»…å¯ä»¥è¯» packet(å³ skb)ä»¥åŠè¯»å†™ stackï¼›&lt;/li>
&lt;li>eBPFï¼šå¯ä»¥è¯»å†™åŒ…æ‹¬ stack/map/contextï¼Œä¹Ÿå³ BPF prog çš„ä¼ å…¥å‚æ•°å¯è¯»å†™ã€‚æ¢å¥è¯è¯´ï¼Œä»»æ„ä¼ å…¥ BPF ä»£ç çš„æ•°æ®æµå‡å¯ä»¥è¢«ä¿®æ”¹ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>é™¤å¼€é¢„è®¾å‡½æ•°å¤–ï¼Œå¼€å‘è€…è¿˜å¯ä»¥è‡ªå®šä¹‰ BPF å‡½æ•°(JUMP_TAIL_CALL)ï¼›&lt;/li>
&lt;li>é™¤äº†å‰å‘è·³è½¬å¤–(Jump Forwardï¼ŒcBPF æ”¯æŒ)ï¼Œè¿˜å¯ä»¥åå‘è·³è½¬(Jump Backword)ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>è‡³äº eBPF å…·ä½“çš„æŒ‡ä»¤è¡¨ï¼Œå› ä¸ºè¿‡äºåºæ‚è¿™é‡Œç¬”è€…å°±ä¸ä½œæ–‡æŠ„å…¬äº†ã€‚ä¸è¿‡ eBPF ä¸­çš„å‡ ä¸ªå¯„å­˜å™¨çš„åˆ©ç”¨è§„åˆ™è¿™é‡Œè¿˜æ˜¯å¯ä»¥æœ‰çš„ï¼Œå¦åˆ™è¦è¯»æ‡‚æ¸…å• 6 ä¸­çš„ä»£ç ç•¥æœ‰å›°éš¾ï¼š&lt;/p>
&lt;ul>
&lt;li>R0ï¼šä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºå‡½æ•°è¿”å›å€¼ï¼ŒåŒ…æ‹¬æ•´ä¸ª BPF ä»£ç å—ï¼ˆå…¶å®ä¹Ÿå¯è¢«çœ‹åšä¸€ä¸ªå‡½æ•°ï¼‰çš„è¿”å›å€¼ï¼›&lt;/li>
&lt;li>R1~R5ï¼šä¸€èˆ¬ç”¨äºè¡¨ç¤ºå†…æ ¸é¢„è®¾å‡½æ•°çš„å‚æ•°ï¼›&lt;/li>
&lt;li>R6~R9ï¼šåœ¨ BPF ä»£ç ä¸­å¯ä»¥ä½œå­˜å‚¨ç”¨ï¼Œå…¶å€¼ä¸å—å†…æ ¸é¢„è®¾å‡½æ•°å½±å“ï¼›&lt;/li>
&lt;li>R10ï¼šåªè¯»ï¼Œç”¨ä½œæ ˆæŒ‡é’ˆ(SP)ï¼›&lt;/li>
&lt;/ul>
&lt;h3 id="in-kernel-verifier">In-kernel Verifier&lt;/h3>
&lt;p>å…¶å®ç»“åˆå‰é¢é‚£ä¹ˆå¤šçš„å†…å®¹çœ‹ä¸‹æ¥ä¸éš¾å‘ç° eBPF å…¶å®è¿‘ä¼¼äºä¸€ç§æ”¹å¤´æ¢é¢åçš„å†…æ ¸æ¨¡å—ï¼Œåªä¸è¿‡å®ƒæ¯”å†…æ ¸æ¨¡å—æ›´çŸ­å°ç²¾å¹²ï¼Œå®ç°çš„åŠŸèƒ½ä¹Ÿæ›´æ–°é¢–ä¸€äº›ç½¢äº†ï¼Œä½†æ— è®ºæ˜¯ä»€ä¹ˆæ ·çš„æ¶æ„ï¼Œåªè¦å­˜åœ¨æ³¨å…¥çš„ä»£ç å°±ä¼šæœ‰å®‰å…¨éšæ‚£ï¼ŒeBPF ä¹Ÿä¸å¤–å¦‚æ˜¯â€”â€”æ¯•ç«Ÿæ³¨å…¥çš„ä»£ç æ˜¯è¦åœ¨å†…æ ¸ä¸­è¿è¡Œçš„ã€‚&lt;/p>
&lt;p>ä¸ºäº†æœ€å¤§é™åº¦çš„æ§åˆ¶è¿™äº›éšæ‚£ï¼ŒcBPF æ—¶ä»£å°±å¼€å§‹åŠ å…¥äº†&lt;a href="http://elixir.free-electrons.com/linux/v2.6.39.4/source/net/core/filter.c#L498">ä»£ç æ£€æŸ¥æœºåˆ¶&lt;/a>ä»¥é˜²æ­¢ä¸è§„èŒƒçš„æ³¨å…¥ä»£ç ï¼›åˆ°äº† eBPF æ—¶ä»£åˆ™åœ¨è½½å…¥ç¨‹åº(bpf_load_program())æ—¶åŠ å…¥äº†æ›´å¤æ‚çš„&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/kernel/bpf/verifier.c#L3544">verifier æœºåˆ¶&lt;/a>ï¼Œåœ¨è¿è¡Œæ³¨å…¥ç¨‹åºä¹‹å‰ï¼Œå…ˆè¿›è¡Œä¸€ç³»åˆ—çš„å®‰å…¨æ£€æŸ¥ï¼Œæœ€å¤§é™åº¦çš„ä¿è¯ç³»ç»Ÿçš„å®‰å…¨ã€‚å…·ä½“æ¥è¯´ï¼Œverifier æœºåˆ¶ä¼šå¯¹æ³¨å…¥çš„ç¨‹åºåšä¸¤è½®æ£€æŸ¥ï¼š&lt;/p>
&lt;ul>
&lt;li>é¦–è½®æ£€æŸ¥(First passï¼Œå®ç°äº&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/kernel/bpf/verifier.c#L2586">check_cfg()&lt;/a>)å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€æ¬¡æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œä¸»è¦ç›®çš„æ˜¯å¯¹æ³¨å…¥ä»£ç è¿›è¡Œä¸€æ¬¡ DAG(Directed Acyclic Graphï¼Œæœ‰å‘æ— ç¯å›¾)æ£€æµ‹ï¼Œä»¥ä¿è¯å…¶ä¸­æ²¡æœ‰å¾ªç¯å­˜åœ¨ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œä¸€æ—¦åœ¨ä»£ç ä¸­å‘ç°ä»¥ä¸‹ç‰¹å¾ï¼Œverifier ä¹Ÿä¼šæ‹’ç»æ³¨å…¥ï¼š
&lt;ul>
&lt;li>ä»£ç é•¿åº¦è¶…è¿‡ä¸Šé™ï¼Œç›®å‰(å†…æ ¸ç‰ˆæœ¬ 4.12)eBPF çš„ä»£ç é•¿åº¦ä¸Šé™ä¸º 4K æ¡æŒ‡ä»¤â€”â€”è¿™åœ¨ cBPF æ—¶ä»£å¾ˆéš¾è¾¾åˆ°ï¼Œä½†åˆ«å¿˜äº† eBPF ä»£ç æ˜¯å¯ä»¥ç”¨ C å®ç°çš„ï¼›&lt;/li>
&lt;li>å­˜åœ¨å¯èƒ½ä¼šè·³å‡º eBPF ä»£ç èŒƒå›´çš„ JMPï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢æ¶æ„ä»£ç æ•…æ„è®©ç¨‹åºè·‘é£ï¼›&lt;/li>
&lt;li>å­˜åœ¨æ°¸è¿œæ— æ³•è¿è¡Œ(unreachable)çš„ eBPF ä»¤ï¼Œä¾‹å¦‚ä½äº exit ä¹‹åçš„æŒ‡ä»¤ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æ¬¡è½®æ£€æŸ¥(Second passï¼Œå®ç°äº&lt;a href="http://elixir.free-electrons.com/linux/v4.12.6/source/kernel/bpf/verifier.c#L2896">do_check()&lt;/a>)è¾ƒä¹‹äºé¦–è½®åˆ™è¦ç»†è‡´å¾ˆå¤šï¼šåœ¨æœ¬è½®æ£€æµ‹ä¸­æ³¨å…¥ä»£ç çš„æ‰€æœ‰é€»è¾‘åˆ†æ”¯ä»å¤´åˆ°å°¾éƒ½ä¼šè¢«å®Œå…¨è·‘ä¸Šä¸€éï¼Œæ‰€æœ‰çš„æŒ‡ä»¤çš„å‚æ•°ï¼ˆå¯„å­˜å™¨ï¼‰ã€è®¿é—®çš„å†…å­˜ã€è°ƒç”¨çš„å‡½æ•°éƒ½ä¼šè¢«ä»”ç»†çš„æ‹ä¸€éï¼Œä»»ä½•çš„é”™è¯¯éƒ½ä¼šå¯¼è‡´æ³¨å…¥ç¨‹åºè¢«é€€è´§ã€‚ç”±äºè¿‡åˆ†ç»†è‡´ï¼Œæœ¬è½®æ£€æŸ¥å¯¹äºæ³¨å…¥ç¨‹åºçš„å¤æ‚åº¦ä¹Ÿæœ‰æ‰€é™åˆ¶ï¼šé¦–å…ˆç¨‹åºä¸­çš„åˆ†æ”¯(branch)ä¸å…è®¸è¶…è¿‡ 1024 ä¸ªï¼›å…¶æ¬¡ç»æ£€æµ‹çš„æŒ‡ä»¤æ•°ä¹Ÿå¿…é¡»åœ¨ 96K ä»¥å†…ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="overview-ebpf-çš„æ¶æ„">Overview: eBPF çš„æ¶æ„&lt;/h3>
&lt;p>è¯šç„¶ï¼ŒeBPF è®¾è®¡çš„å¤æ‚ç¨‹åº¦å·²æ˜¯è¶…è¶Š cBPF å¤ªå¤šå¤ªå¤šï¼Œç¬”è€…ç½—é‡Œå§å—¦äº†å¤§åŠå¤©ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å°†å°†é¢†ç€å¤§å®¶å…¥é—¨çš„ç¨‹åº¦è€Œå·²ï¼Œä¸ºäº†ä¾¿äºè¯»è€…ä»¬èƒ½å¤ŸæŠŠå‰æ–‡æ‰€è¿°çš„ç¢ç‰‡çŸ¥è¯†ä¸²åˆ°ä¸€èµ·ï¼Œè¿™é‡Œç¬”è€…å°† eBPF çš„å¤§ä½“æ¶æ„è‰ç»˜ä¸€ç•ªï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¤§å®¶å¯¹ eBPF æ„å»ºä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ã€‚&lt;/p>
&lt;h4 id="å›¾-5-architecture-of-ebpf">å›¾ 5. Architecture of eBPF&lt;/h4>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-23-30-epbf005.png" alt="">&lt;/p>
&lt;h3 id="è¿½æ±‚æç®€bpf-compiler-collectionbcc">è¿½æ±‚æç®€ï¼šBPF Compiler Collection(BCC)&lt;/h3>
&lt;p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰èšç„¦åˆ° eBPF çš„ä½¿ç”¨â€”â€”ç›¸ä¿¡è¿™æ˜¯å¤§éƒ¨åˆ†è¯»è€…æœ€æ„Ÿå…´è¶£çš„éƒ¨åˆ†ï¼Œæ¯•ç«Ÿç»å¤§å¤šæ•°äººå…¶å®å¹¶æ²¡æœ‰å¤šå°‘æœºä¼šå‚ä¸ eBPF çš„å¼€å‘â€”â€”é‡æ–°å›åˆ°æ¸…å• 3&amp;amp;4 ä¸­çš„ sockex1ï¼šè¯´å¥è‰¯å¿ƒè¯ï¼Œè™½ç„¶ç°åœ¨å¯ä»¥ç”¨ C æ¥å®ç° BPFï¼Œä½†ç¼–è¯‘å‡ºæ¥çš„å´ä»ç„¶æ˜¯ ELF æ–‡ä»¶ï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨æå‡ºçœŸæ­£å¯ä»¥æ³¨å…¥å†…æ ¸çš„ä»£ç ã€‚è¿™éƒ¨åˆ†å·¥ä½œå¤šå°‘æœ‰äº›éº»çƒ¦ï¼Œå¦‚æœå¯ä»¥æœ‰ä¸€ä¸ªé€šç”¨çš„æ–¹æ¡ˆä¸€æ­¥åˆ°ä½çš„ç”Ÿæˆå‡º BPF ä»£ç å°±å¥½äº†ï¼Œå¼€å‘è€…çš„æ³¨æ„åŠ›åº”è¯¥æ”¾åœ¨å…¶ä»–æ›´æœ‰ä»·å€¼çš„åœ°æ–¹ï¼Œä¸æ˜¯å—ï¼Ÿ&lt;/p>
&lt;p>äºæ˜¯å°±æœ‰äººè®¾è®¡äº† BPF Compiler Collection(BCC)ï¼ŒBCC æ˜¯ä¸€ä¸ª python åº“ï¼Œä½†æ˜¯å…¶ä¸­æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†çš„å®ç°æ˜¯åŸºäº C å’Œ C++çš„ï¼Œpython åªä¸è¿‡å®ç°äº†å¯¹ BCC åº”ç”¨å±‚æ¥å£çš„å°è£…è€Œå·²ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ BCC è¿›è¡Œ BPF çš„å¼€å‘ä»ç„¶éœ€è¦å¼€å‘è€…è‡ªè¡Œåˆ©ç”¨ C æ¥è®¾è®¡ BPF ç¨‹åºâ€”â€”ä½†ä¹Ÿä»…æ­¤è€Œå·²ï¼Œä½™ä¸‹çš„å·¥ä½œï¼ŒåŒ…æ‹¬ç¼–è¯‘ã€è§£æ ELFã€åŠ è½½ BPF ä»£ç å—ä»¥åŠåˆ›å»º map ç­‰ç­‰åŸºæœ¬å¯ä»¥ç”± BCC ä¸€åŠ›æ‰¿æ‹…ï¼Œæ— éœ€å¤šåŠ³å¼€å‘è€…è´¹å¿ƒã€‚&lt;/p>
&lt;p>é™äºç¯‡å¹…å…³äº BCC ç¬”è€…ä¸å†è¿‡å¤šå±•å¼€ï¼Œæ–‡ç« çš„æœ€åç¬”è€…å†ç»™å‡ºä¸€ä¸ªåŸºäº BCC å®ç°çš„ sockex1 çš„ä¾‹å­ï¼Œè¯»è€…å¯ä»¥æ„Ÿå—ä¸€ä¸‹ä½¿ç”¨ BCC å¸¦ç»™å¼€å‘è€…ä»¬çš„ä¾¿åˆ©æ€§ï¼š&lt;/p>
&lt;h5 id="æ¸…å•-7-a-sample-of-bcc">æ¸…å• 7 A sample of BCC&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">bcc&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">BPF&lt;/span>
&lt;span class="c1"># å’Œæ¸…å• 2 ä¸€æ ·ï¼Œç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œåªè´´ä¸€éƒ¨åˆ†æºç ï¼Œå®Œå…¨ç‰ˆè¯·ç§»æ­¥ https://raw.githubusercontent.com/windywolf/example/master/eBPF/bccsample.py&lt;/span>
&lt;span class="n">interface&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;ens160&amp;#34;&lt;/span>
&lt;span class="c1"># BCC å¯ä»¥æ¥å—ç›´æ¥å°† BPF ä»£ç åµŒå…¥ python code ä¹‹ä¸­&lt;/span>
&lt;span class="c1"># ä¸ºäº†æ–¹ä¾¿å±•ç¤ºç¬”è€…ä½¿ç”¨äº†è¿™ä¸€åŠŸèƒ½&lt;/span>
&lt;span class="c1"># æ³¨æ„ï¼šprog ä¸­çš„ä¸­æ–‡æ³¨é‡Šæ˜¯ç”±äºç¬”è€…éœ€è¦å†™ä½œä¹‹æ•…åŠ å…¥ï¼Œå¦‚æœè¯»è€…æƒ³å°è¯•è¿è¡Œè¿™æ®µä»£ç ï¼Œ&lt;/span>
&lt;span class="c1"># åˆ™è¯·å°†ä¸­æ–‡å…¨éƒ¨åˆ é™¤ï¼Œå› ä¸ºç›®å‰ BCC è¿˜ä¸æ”¯æŒåœ¨å†…åµŒ C ä»£ç ä¸­ä½¿ç”¨ä¸­æ–‡æ³¨é‡Š&lt;/span>
&lt;span class="n">prog&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;span class="s2">#include &amp;lt;net/sock.h&amp;gt;
&lt;/span>&lt;span class="s2">#include &amp;lt;bcc/proto.h&amp;gt;
&lt;/span>&lt;span class="s2">// BCC ä¸­ä¸“é—¨ä¸º map å®šä¹‰äº†ä¸€ç³»åˆ—çš„å®ï¼Œä»¥æ–¹ä¾¿ä½¿ç”¨
&lt;/span>&lt;span class="s2">// å®ä¸­çš„ struct ä¸‹è¿˜å®šä¹‰äº†ç›¸åº”çš„å‡½æ•°ï¼Œè®©å¼€å‘è€…å¯ä»¥å¦‚ C++ä¸€èˆ¬æ“ä½œ map
&lt;/span>&lt;span class="s2">// è¿™é‡Œç¬”è€…å®šä¹‰äº†ä¸€ä¸ª array ç±»å‹çš„ mapï¼Œåä¸º my_map1
&lt;/span>&lt;span class="s2">BPF_ARRAY(my_map1, long);
&lt;/span>&lt;span class="s2">// BCC ä¸‹çš„ BPF ç¨‹åºä¸­ä¸å†éœ€è¦å®šä¹‰æŠŠå‡½æ•°æˆ–å˜é‡ä¸“é—¨æ”¾ç½®äºæŸä¸ª section ä¸‹äº†
&lt;/span>&lt;span class="s2">int bpf_prog1(struct __sk_buff *skb)
&lt;/span>&lt;span class="s2">{
&lt;/span>&lt;span class="s2"> // â€¦â€¦
&lt;/span>&lt;span class="s2"> struct ethernet_t *eth = cursor_advance(cursor, sizeof(*eth));
&lt;/span>&lt;span class="s2"> // â€¦â€¦
&lt;/span>&lt;span class="s2"> struct ip_t *ip = cursor_advance(cursor, sizeof(*ip));
&lt;/span>&lt;span class="s2"> int index = ip-&amp;gt;nextp;
&lt;/span>&lt;span class="s2"> long zero = 0; // BCC ä¸‹çš„ bpf ä¹¦å†™è¿˜æ˜¯æœ‰å¾ˆå¤šå‘çš„
&lt;/span>&lt;span class="s2"> // ä¾‹å¦‚ï¼Œè¿™é‡Œå¦‚æœä¸å»å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡ zeroï¼Œ
&lt;/span>&lt;span class="s2"> // è€Œæ˜¯ç›´æ¥ç”¨å¸¸é‡ 0 ä½œä¸º lookup_or_init()çš„å˜é‡å°±ä¼šæŠ¥é”™
&lt;/span>&lt;span class="s2"> // map ç±»ä¸‹çš„å„ä¸ªæ–¹æ³•çš„å…·ä½“ç»†èŠ‚å¯ä»¥å‚ç…§ reference_guide.md
&lt;/span>&lt;span class="s2"> value = my_map1.lookup_or_init(&amp;amp;index, &amp;amp;zero);
&lt;/span>&lt;span class="s2"> if (value)
&lt;/span>&lt;span class="s2"> __sync_fetch_and_add(value, skb-&amp;gt;len);
&lt;/span>&lt;span class="s2"> return 0;
&lt;/span>&lt;span class="s2">}
&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="n">bpf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BPF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">prog&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">debug&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># æ³¨å…¥ bpf_prog1 å‡½æ•°&lt;/span>
&lt;span class="n">function&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bpf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">load_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;bpf_prog1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">BPF&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SOCKET_FILTER&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># è¿™æ˜¯ä¸€æ®µ SOCKET_FILTER ç±»å‹çš„ BPFï¼Œæ‰€ä»¥éœ€è¦æŒ‚è½½åˆ°æŸä¸€ä¸ª interface ä¸Š&lt;/span>
&lt;span class="n">BPF&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">attach_raw_socket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">interface&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># åˆ©ç”¨ map æœºåˆ¶è·å–è¿›å‡º interface çš„å„ä¸ªåè®®çš„æŠ¥æ–‡æ€»é•¿&lt;/span>
&lt;span class="n">bpf_map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bpf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;my_map1&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;TCP : &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">, UDP : &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">, ICMP: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="n">bpf_map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">IPPROTO_TCP&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1"># â€¦&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç»“æŸè¯­">ç»“æŸè¯­&lt;/h2>
&lt;p>æœ¬æ–‡ä» BPF çš„æºå¤´å¼€å§‹ï¼Œä¸€è·¯è®²åˆ°äº†è¿‘å¹´æ¥åˆšåˆšæ€é’çš„ eBPFï¼Œè™½è¯´æ‹˜æ³¥äºç¯‡å¹…ï¼Œå¤§å¤šå†…å®¹åªèƒ½èœ»èœ“ç‚¹æ°´ã€æµ…å°è¾„æ­¢ï¼Œä½†æ–‡ä¸­ BPF çš„åŸç†ã€è®¾è®¡ã€å®ç°å’Œåº”ç”¨å‡æœ‰æ‰€æ¶‰çŒï¼Œå‹‰å¼ºä¹Ÿèƒ½æ‹¿æ¥å…¥ä¸ªé—¨äº†ã€‚åŠ ä¹‹è¿‘å¹´æ¥åŸºäº eBPF çš„åº”ç”¨å±‚å‡ºä¸ç©·ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½æ¿€å‘è¯»è€…ä»¬çš„å¥‡æ€å¦™æƒ³ï¼Œä»è€Œè®¾è®¡å‡ºæ›´å¤šåŸºäº BPF çš„ä¼˜ç§€åº”ç”¨æ¥ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æº">å‚è€ƒèµ„æº&lt;/h2>
&lt;ol>
&lt;li>[Steven McCanne, Van Jacobson] The BSD Packet Filter: A New Architecture for User-level Packet Capture, BPF çš„æºå¤´ï¼Œå¯åœ¨&lt;a href="http://www.tcpdump.org/papers/bpf-usenix93.pdf">è¿™é‡Œ&lt;/a>æŸ¥é˜…ï¼›&lt;/li>
&lt;li>&lt;a href="http://www.tcpdump.org/tcpdump_man.html,">http://www.tcpdump.org/tcpdump_man.html,&lt;/a> tcpdump çš„ manual page;&lt;/li>
&lt;li>&lt;a href="https://www.kernel.org/doc/Documentation/networking/filter.txt,">https://www.kernel.org/doc/Documentation/networking/filter.txt,&lt;/a> å†…æ ¸çš„ BPF æ–‡æ¡£ï¼›&lt;/li>
&lt;li>&lt;a href="http://man7.org/linux/man-pages/man7/socket.7.html,">http://man7.org/linux/man-pages/man7/socket.7.html,&lt;/a> Linux å¥—æ¥å­—çš„ manual pageï¼Œå…¶ä¸­æœ‰å¯¹ Linux Kernel ä¸­ BPF æ¥å£çš„å¤§è‡´ä»‹ç»ï¼Œä¸è¿‡è®ºåŠè¯¦ç»†ç¨‹åº¦è¿˜æ˜¯ä¸åŠå‚è€ƒæ–‡çŒ® 3 çš„ï¼›&lt;/li>
&lt;li>&lt;a href="https://lwn.net/Articles/437981/">https://lwn.net/Articles/437981/&lt;/a>ï¼ŒLWN ä¸ŠåˆŠè½½çš„ JIT For BPF é¦–æ¬¡è¢«å¼•å…¥çš„æ¶ˆæ¯ï¼šA JIT For Packet Filters;&lt;/li>
&lt;li>&lt;a href="https://lwn.net/Articles/603983/,">https://lwn.net/Articles/603983/,&lt;/a> LWN ä¸ŠåˆŠè½½çš„ eBPF çš„ä»‹ç»æ–‡çŒ®ï¼šExtending extended BPFã€‚ç”±äºå¹´ä»£ä¹…è¿œæ¥å£ç›¸å…³çš„å†…å®¹å·²ç»è½åäºæœ€æ–°ä»£ç äº†ï¼Œæƒä½œå‚è€ƒï¼›&lt;/li>
&lt;li>&lt;a href="https://github.com/iovisor/bcc,">https://github.com/iovisor/bcc,&lt;/a> BCC çš„æºç ï¼Œä½†ç”±äºç¼–è¯‘éœ€è¦æ¯”è¾ƒå¤šçš„ä¾èµ–ï¼Œå¦‚æœæƒ³å·ä¸ªæ‡’çš„è¯å¯ä»¥ç§»æ­¥&lt;a href="https://hub.docker.com/r/zlim/bcc/">è¿™é‡Œ&lt;/a>ç›´æ¥è·å– docker imageï¼›&lt;/li>
&lt;li>&lt;a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md">bcc/reference_guide.md at master Â· iovisor/bcc Â· GitHub&lt;/a>, BCC å¼€å‘æŒ‡å—ï¼›&lt;/li>
&lt;li>&lt;a href="http://elixir.free-electrons.com/linux/latest/source,">http://elixir.free-electrons.com/linux/latest/source,&lt;/a> Linux Kernel æºç é˜…è¯»åˆ©å™¨ã€‚&lt;/li>
&lt;/ol></description></item><item><title>Ext4æ–‡ä»¶ç³»ç»Ÿæ¶æ„åˆ†æ(ä¸€)(è½¬)</title><link>https://justice.bj.cn/post/21.linux/ext4%E4%BB%8B%E7%BB%8D/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/ext4%E4%BB%8B%E7%BB%8D/</guid><description>&lt;h2 id="ext4æ–‡ä»¶ç³»ç»Ÿæ¶æ„åˆ†æä¸€è½¬">Ext4æ–‡ä»¶ç³»ç»Ÿæ¶æ„åˆ†æ(ä¸€)(è½¬)&lt;/h2>
&lt;p>æœ¬æ–‡æè¿°Ext4æ–‡ä»¶ç³»ç»Ÿç£ç›˜å¸ƒå±€å’Œå…ƒæ•°æ®çš„ä¸€äº›åˆ†æï¼ŒåŒæ ·é€‚ç”¨äºExt3å’ŒExt2æ–‡ä»¶ç³»ç»Ÿï¼Œé™¤äº†å®ƒä»¬ä¸æ”¯æŒçš„Ext4çš„ç‰¹æ€§å¤–ã€‚æ•´ä¸ªåˆ†æåˆ†ä¸¤ç¯‡åšæ–‡ï¼Œåˆ†åˆ«æ¦‚è¿°å¸ƒå±€å’Œè¯¦ç»†ä»‹ç»å„ä¸ªå¸ƒå±€çš„æ•°æ®ç»“æ„åŠç»„ç»‡å¯»å€æ–¹å¼ç­‰ã€‚æ„Ÿå…´è¶£çš„çœ‹å®˜æ•¬è¯·ç•™æ„å’ŒæŒ‡å¯¼ï¼&lt;/p>
&lt;h2 id="1-ext4æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€ç»¼è¿°">1. Ext4æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€ç»¼è¿°&lt;/h2>
&lt;p>ä¸€ä¸ªExt4æ–‡ä»¶ç³»ç»Ÿè¢«åˆ†æˆä¸€ç³»åˆ—å—ç»„ã€‚ä¸ºå‡å°‘ç£ç›˜ç¢ç‰‡äº§ç”Ÿçš„æ€§èƒ½ç“¶é¢ˆï¼Œå—åˆ†é…å™¨å°½é‡ä¿æŒæ¯ä¸ªæ–‡ä»¶çš„æ•°æ®å—éƒ½åœ¨åŒä¸€ä¸ªå—ç»„ä¸­ï¼Œä»è€Œå‡å°‘å¯»é“æ—¶é—´ã€‚ä»¥4KBçš„æ•°æ®å—ä¸ºä¾‹ï¼Œä¸€ä¸ªå—ç»„å¯ä»¥åŒ…å«32768ä¸ªæ•°æ®å—ï¼Œä¹Ÿå°±æ˜¯128MBã€‚&lt;/p>
&lt;h2 id="11ç£ç›˜å¸ƒå±€">1.1Â ç£ç›˜å¸ƒå±€&lt;/h2>
&lt;p>Ext4æ–‡ä»¶ç³»ç»Ÿçš„æ ‡å‡†ç£ç›˜å¸ƒå±€å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-26-23-28989651_13764045230xDi.jpg" alt="">&lt;/p>
&lt;p>Ext4æ–‡ä»¶ç³»ç»Ÿä¸»è¦ä½¿ç”¨å—ç»„0ä¸­çš„è¶…çº§å—å’Œå—ç»„æè¿°ç¬¦è¡¨ï¼Œåœ¨å…¶ä»–ä¸€äº›ç‰¹å®šå—ç»„ä¸­æœ‰è¶…çº§å—å’Œå—ç»„æè¿°ç¬¦è¡¨çš„å†—ä½™å¤‡ä»½ã€‚å¦‚æœå—ç»„ä¸­ä¸å«å†—ä½™å¤‡ä»½ï¼Œé‚£ä¹ˆå—ç»„å°±ä»¥æ•°æ®å—ä½å›¾å¼€å§‹ã€‚å½“æ ¼å¼åŒ–ç£ç›˜æˆä¸ºExt4æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œmkfså°†åœ¨å—ç»„æè¿°ç¬¦è¡¨åé¢åˆ†é…é¢„ç•™GDTè¡¨æ•°æ®å—(â€œReserveÂ GDTÂ blocksâ€)ä»¥ç”¨äºå°†æ¥æ‰©å±•æ–‡ä»¶ç³»ç»Ÿã€‚ç´§æ¥åœ¨é¢„ç•™GDTè¡¨æ•°æ®å—åçš„æ˜¯æ•°æ®å—ä½å›¾ä¸inodeè¡¨ä½å›¾ï¼Œè¿™ä¸¤ä¸ªä½å›¾åˆ†åˆ«è¡¨ç¤ºæœ¬å—ç»„å†…çš„æ•°æ®å—ä¸inodeè¡¨çš„ä½¿ç”¨ï¼Œinodeè¡¨æ•°æ®å—ä¹‹åå°±æ˜¯å­˜å‚¨æ–‡ä»¶çš„æ•°æ®å—äº†ã€‚åœ¨è¿™äº›å„ç§å„æ ·çš„å—ä¸­ï¼Œè¶…çº§å—ã€GDTã€å—ä½å›¾ã€Inodeä½å›¾éƒ½æ˜¯æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ï¼Œå½“ç„¶inodeè¡¨ä¹Ÿæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ï¼Œä½†æ˜¯inodeè¡¨æ˜¯ä¸æ–‡ä»¶ä¸€ä¸€å¯¹åº”çš„ï¼Œæˆ‘æ›´å€¾å‘äºå°†inodeå½“åšæ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œå› ä¸ºåœ¨å®é™…æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œé™¤äº†å·²ç»ä½¿ç”¨çš„åæ¥ä¸ªå¤–ï¼Œå…¶ä»–inodeè¡¨ä¸­å®é™…ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•æ•°æ®çš„ï¼Œç›´åˆ°åˆ›å»ºäº†ç›¸åº”çš„æ–‡ä»¶æ‰ä¼šåˆ†é…inodeè¡¨ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰ä¼šåœ¨inodeè¡¨ä¸­å†™å…¥ä¸æ–‡ä»¶ç›¸å…³çš„inodeä¿¡æ¯ã€‚&lt;/p>
&lt;h2 id="12flexibleå—ç»„flex_bg">1.2Â FlexibleÂ å—ç»„ï¼ˆflex_bgï¼‰&lt;/h2>
&lt;p>FlexibleÂ å—ç»„ï¼ˆflex_bgï¼‰æ˜¯ä»Ext4å¼€å§‹å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚åœ¨ä¸€ä¸ªflex_bgä¸­ï¼Œå‡ ä¸ªå—ç»„åœ¨ä¸€èµ·ç»„æˆä¸€ä¸ªé€»è¾‘å—ç»„flex_bgã€‚Flex_bgçš„ç¬¬ä¸€ä¸ªå—ç»„ä¸­çš„ä½å›¾ç©ºé—´å’Œinodeè¡¨ç©ºé—´æ‰©å¤§ä¸ºåŒ…å«äº†flex_bgä¸­å…¶ä»–å—ç»„ä¸Šä½å›¾å’Œinodeè¡¨ã€‚&lt;/p>
&lt;p>æ¯”å¦‚flex_bgåŒ…å«4ä¸ªå—ç»„ï¼Œå—ç»„0å°†æŒ‰åºåŒ…å«è¶…çº§å—ã€å—ç»„æè¿°ç¬¦è¡¨ã€å—ç»„0-3çš„æ•°æ®å—ä½å›¾ã€å—ç»„0-3çš„inodeä½å›¾ã€å—ç»„0-3çš„inodeè¡¨ï¼Œå—ç»„0ä¸­çš„å…¶ä»–ç©ºé—´ç”¨äºå­˜å‚¨æ–‡ä»¶æ•°æ®ã€‚åŒæ—¶ï¼Œå…¶ä»–å—ç»„ä¸Šçš„æ•°æ®å—ä½å›¾ã€inodeä½å›¾ã€inodeè¡¨å…ƒæ•°æ®å°±ä¸å­˜åœ¨äº†ï¼Œä½†æ˜¯SBå’ŒGDTè¿˜æ˜¯å­˜åœ¨çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-26-33-28989651_1376404620OKyF.jpg" alt="">&lt;/p>
&lt;p>Flexibleå—ç»„çš„ä½œç”¨æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>èšé›†å…ƒæ•°æ®ï¼ŒåŠ é€Ÿå…ƒæ•°æ®è½½å…¥ï¼›&lt;/li>
&lt;li>ä½¿å¾—å¤§æ–‡ä»¶åœ¨ç£ç›˜ä¸Šå°½é‡è¿ç»­ï¼›&lt;/li>
&lt;/ol>
&lt;p>å³ä½¿å¼€å¯flex_bgç‰¹æ€§ï¼Œè¶…çº§å—å’Œå—ç»„æè¿°ç¬¦çš„å†—ä½™å¤‡ä»½ä»ç„¶ä½äºå—ç»„çš„å¼€å¤´ã€‚Â Flex_bgä¸­å—ç»„çš„ä¸ªæ•°ç”±2^ext4_super_block.s_log_groups_per_flexÂ ç»™å‡ºã€‚&lt;/p>
&lt;h2 id="13å…ƒå—ç»„metablockgroups">1.3Â å…ƒå—ç»„ï¼ˆMetaÂ BlockÂ Groupsï¼‰&lt;/h2>
&lt;p>é€šå¸¸ï¼Œåœ¨æ¯ä¸ªå†—ä½™å¤‡ä»½çš„è¶…çº§å—çš„åé¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„(åŒ…å«æ‰€æœ‰å—ç»„æè¿°ç¬¦çš„)å—ç»„æè¿°ç¬¦è¡¨çš„å¤‡ä»½ã€‚è¿™æ ·ä¼šäº§ç”Ÿä¸€ä¸ªé™åˆ¶ï¼Œä»¥Ext4çš„å—ç»„æè¿°ç¬¦å¤§å°64Â Bytesè®¡ç®—ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸­æœ€å¤šåªèƒ½æœ‰2^21ä¸ªå—ç»„ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ç³»ç»Ÿæœ€å¤§ä¸º256TBã€‚&lt;/p>
&lt;p>ä½¿ç”¨å…ƒå—ç»„MetaÂ BlockÂ Groupsç‰¹æ€§ï¼Œæ¯ä¸ªå—ç»„éƒ½åŒ…å«è¯¥å—ç»„è‡ªå·±çš„æè¿°ç¬¦çš„å†—ä½™å¤‡ä»½ã€‚å› æ­¤å¯ä»¥åˆ›å»º2^33ä¸ªå—ç»„ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ç³»ç»Ÿæœ€å¤§1EBã€‚48ä½æ•°æ®å—ï¼Œæ¯ä¸ªå—ç»„128MBï¼Œå› è€Œå¯ä»¥åˆ›å»º2^33ä¸ªå—ç»„ã€‚&lt;/p>
&lt;p>å…ƒå—ç»„å®é™…ä¸Šæ˜¯å¯ä»¥ç”¨ä¸€ä¸ªå—ç»„æè¿°ç¬¦å—æ¥è¿›è¡Œæè¿°çš„å—ç»„é›†ï¼Œç®€å•çš„è¯´ï¼Œå®ƒç”±ä¸€ç³»åˆ—å—ç»„ç»„æˆï¼ŒåŒæ—¶è¿™äº›å—ç»„å¯¹åº”çš„å—ç»„æè¿°ç¬¦å­˜å‚¨åœ¨ä¸€ä¸ªå—ä¸­ã€‚å®ƒçš„å‡ºç°ä½¿å¾—Ext3å’ŒExt4çš„ç£ç›˜å¸ƒå±€æœ‰äº†ä¸€å®šçš„å˜åŒ–ï¼Œä»¥å¾€è¶…çº§å—åç´§è·Ÿçš„æ˜¯å˜é•¿çš„GDTå—ï¼Œç°åœ¨æ˜¯è¶…çº§å—ä¾ç„¶å†³å®šäºæ˜¯å¦æ˜¯3,5,7çš„å¹‚ï¼Œè€Œä¸€ä¸ªå—ç»„æè¿°ç¬¦å—åˆ™å­˜å‚¨åœ¨å…ƒå—ç»„çš„ç¬¬ä¸€ä¸ªï¼Œç¬¬äºŒä¸ªå’Œæœ€åä¸€ä¸ªå—ç»„çš„å¼€å§‹å¤„(è§ä¸‹å›¾)&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-26-40-28989651_1376404725HTsy.png" alt="">&lt;/p>
&lt;p>(1)Â  æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæ—¶ã€‚ç”¨æˆ·å¯ä»¥æŒ‡å®šä½¿ç”¨è¿™ç§å¸ƒå±€ã€‚Â &lt;/p>
&lt;p>(2)Â  å½“æ–‡ä»¶ç³»ç»Ÿå¢é•¿è€Œä¸”é¢„ç•™çš„ç»„æè¿°ç¬¦å—è€—å°½æ—¶ã€‚ç›®å‰è¶…çº§å—ä¸­æœ‰ä¸€ä¸ªåŸŸs_first_meta_bgç”¨äºæè¿°ç¬¬ä¸€ä¸ªä½¿ç”¨å…ƒå—ç»„çš„å—ç»„ã€‚Â &lt;/p>
&lt;p>Â å½“å¢åŠ æ–°å—ç»„æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç»™ç»„æè¿°ç¬¦è¡¨é¢„ç•™ç©ºé—´ï¼Œè€Œæ˜¯åœ¨å½“å‰æ–‡ä»¶ç³»ç»Ÿåé¢ç›´æ¥æ·»åŠ æ–°çš„å…ƒå—ç»„å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h2 id="14lazyå—ç»„åˆå§‹åŒ–">1.4Â LazyÂ å—ç»„åˆå§‹åŒ–&lt;/h2>
&lt;p>å¦‚æœå—ç»„ä¸­çš„ç›¸åº”æ ‡å¿—å·²è®¾ç½®ï¼Œé‚£ä¹ˆå—ç»„ä¸­çš„inodeä½å›¾å’Œinodeè¡¨å°†ä¸è¢«åˆå§‹åŒ–ã€‚è¿™æ ·å¯ä»¥å‡å°‘mkfsæ—¶é—´ï¼Œå¦‚æœå¼€å¯äº†å—ç»„æè¿°ç¬¦æ ¡éªŒå’ŒåŠŸèƒ½ï¼Œç”šè‡³è¿å—ç»„éƒ½å¯ä»¥ä¸åˆå§‹åŒ–ã€‚&lt;/p>
&lt;h2 id="15ç‰¹æ®Šinodes">1.5Â ç‰¹æ®Šinodes&lt;/h2>
&lt;p>Ext4é¢„ç•™äº†ä¸€äº›inodeåšç‰¹æ®Šç‰¹æ€§ä½¿ç”¨ï¼Œè§ä¸‹è¡¨ï¼š&lt;/p>
&lt;p>è¡¨Â 1Â Â Ext4çš„ç‰¹æ®Šinode&lt;/p>
&lt;p>Inodeå· Â Â Â ç”¨é€”&lt;/p>
&lt;p>0 Â Â Â Â Â ä¸å­˜åœ¨0å·inode&lt;/p>
&lt;p>1 Â Â Â Â Â æŸåæ•°æ®å—é“¾è¡¨&lt;/p>
&lt;p>2Â Â Â Â  Â æ ¹ç›®å½•&lt;/p>
&lt;p>3Â Â Â Â  Â ACLç´¢å¼•&lt;/p>
&lt;p>4 Â Â Â Â Â ACLæ•°æ®&lt;/p>
&lt;p>5Â Â Â Â  Â BootÂ Â loader&lt;/p>
&lt;p>6 Â Â Â Â Â æœªåˆ é™¤çš„ç›®å½•&lt;/p>
&lt;p>7 Â Â Â Â Â é¢„ç•™çš„å—ç»„æè¿°ç¬¦inode&lt;/p>
&lt;p>8 Â Â Â Â Â æ—¥å¿—inode&lt;/p>
&lt;p>11 Â Â Â Â ç¬¬ä¸€ä¸ªéé¢„ç•™çš„inodeï¼Œé€šå¸¸æ˜¯lost+foundç›®å½•&lt;/p>
&lt;h2 id="16æ•°æ®å—å’Œinodeåˆ†é…ç­–ç•¥">1.6Â æ•°æ®å—å’ŒInodeåˆ†é…ç­–ç•¥&lt;/h2>
&lt;p>åœ¨æœºæ¢°ç£ç›˜ä¸Šï¼Œä¿æŒç›¸å…³çš„æ•°æ®å—ç›¸äº’æ¥è¿‘å¯ä»¥æ€»çš„ç£å¤´ç§»åŠ¨æ—¶é—´ï¼Œå› è€Œå¯ä»¥åŠ é€Ÿç£ç›˜IOã€‚åœ¨SSDä¸Šè™½ç„¶æ²¡æœ‰ç£å¤´è½¬åŠ¨ï¼Œæ•°æ®å±€éƒ¨æ€§å¯ä»¥å¢åŠ æ¯æ¬¡IOè¯·æ±‚çš„ä¼ è¾“çš„æ•°æ®å¤§å°ï¼Œå› è€Œå‡å°‘å“åº”IOè¯·æ±‚çš„ä¼ è¾“æ¬¡æ•°ã€‚æ•°æ®çš„å±€éƒ¨æ€§å¯¹å•ä¸ªæ“¦é™¤å—çš„å†™å…¥äº§ç”Ÿå½±å“ï¼Œå¯ä»¥åŠ é€Ÿæ–‡ä»¶é‡å†™çš„é€Ÿåº¦ã€‚å› è€Œå°½å¯èƒ½å‡å°‘ç¢ç‰‡æ˜¯å¿…è¦çš„ã€‚inodeå’Œæ•°æ®å—çš„åˆ†é…ç­–ç•¥å¯ä»¥ä¿è¯æ•°æ®çš„å±€éƒ¨é›†ä¸­ã€‚ä»¥ä¸‹ä¸ºinodeå’Œæ•°æ®å—çš„åˆ†é…ç­–ç•¥ï¼š&lt;/p>
&lt;p>(1)Â  å¤šå—åˆ†é…å¯ä»¥å‡å°‘ç£ç›˜ç¢ç‰‡ã€‚å½“æ–‡ä»¶åˆæ¬¡åˆ›å»ºçš„æ—¶å€™ï¼Œå—åˆ†é…å™¨é¢„æµ‹æ€§åœ°åˆ†é…8KBçš„ç£ç›˜ç©ºé—´ç»™æ–‡ä»¶ã€‚å½“æ–‡ä»¶å…³é—­çš„æ—¶å€™ï¼Œæœªä½¿ç”¨çš„ç©ºé—´å½“ç„¶ä¹Ÿå°±é‡Šæ”¾äº†ã€‚ä½†æ˜¯å¦‚æœæ¨æµ‹æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆæ–‡ä»¶æ•°æ®å°†å†™åˆ°ä¸€ä¸ªå¤šä¸ªå—çš„extentä¸­ã€‚&lt;/p>
&lt;p>(2)Â  å»¶è¿Ÿåˆ†é…ã€‚å½“ä¸€ä¸ªæ–‡ä»¶éœ€è¦æ›´å¤šçš„æ•°æ®å—å¼•èµ·å†™æ“ä½œæ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿæ¨è¿Ÿå†³å®šæ–°æ•°æ®åœ¨ç£ç›˜ä¸Šçš„å­˜æ”¾ä½ç½®ï¼Œç›´åˆ°è„çš„bufferå†™åˆ°ç£ç›˜ä¸ºæ­¢ã€‚&lt;/p>
&lt;p>(3)Â  å°½é‡ä¿æŒæ–‡ä»¶çš„æ•°æ®å—ä¸å…¶inodeåœ¨åŒä¸€ä¸ªå—ç»„ä¸­ã€‚å¯ä»¥å‡å°‘ç£ç›˜å¯»é“æ—¶é—´.&lt;/p>
&lt;p>(4)Â  å°½é‡ä¿æŒåŒä¸€ä¸ªç›®å½•ä¸­çš„æ‰€æœ‰inodesä¸ç›®å½•ä½äºåŒä¸€ä¸ªå—ç»„ä¸­ã€‚è¿™æ ·çš„å‡è®¾å‰ææ˜¯ä¸€ä¸ªç›®å½•ä¸­çš„æ–‡ä»¶æ˜¯ç›¸å…³çš„ã€‚&lt;/p>
&lt;p>(5)Â  ç£ç›˜å·è¢«åˆ†æˆ128MBçš„å—ç»„ã€‚å½“åœ¨æ ¹ç›®å½•ä¸­åˆ›å»ºç›®å½•æ—¶ï¼Œinodeåˆ†é…å™¨æ‰«æå—ç»„å¹¶å°†æ–°ç›®å½•æ”¾åˆ°å®ƒæ‰¾åˆ°çš„ä½¿ç”¨è´Ÿè·æœ€å°çš„å—ç»„ä¸­ã€‚è¿™å¯ä»¥ä¿è¯ç›®å½•åœ¨ç£ç›˜ä¸Šçš„åˆ†æ•£æ€§ã€‚&lt;/p>
&lt;p>(6)Â  å³ä½¿ä¸Šè¿°æœºåˆ¶æ— æ•ˆï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨e4defragæ•´ç†ç¢ç‰‡æ–‡ä»¶ã€‚&lt;/p>
&lt;h2 id="17è¶…çº§å—">1.7Â è¶…çº§å—&lt;/h2>
&lt;p>è¶…çº§å—è®°å½•æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å¤§é‡ä¿¡æ¯ï¼Œå¦‚æ•°æ®å—ä¸ªæ•°ã€inodeä¸ªæ•°ã€æ”¯æŒçš„ç‰¹æ€§ã€ç®¡ç†ä¿¡æ¯ï¼Œç­‰å¾…ã€‚&lt;/p>
&lt;p>å¦‚æœè®¾ç½®sparse_superç‰¹æ€§æ ‡å¿—ï¼Œè¶…çº§å—å’Œå—ç»„æè¿°ç¬¦è¡¨çš„å†—ä½™å¤‡ä»½ä»…å­˜æ”¾åœ¨ç¼–å·ä¸º0æˆ–3ã€5ã€7çš„å¹‚æ¬¡æ–¹çš„å—ç»„ä¸­ã€‚å¦‚æœæœªè®¾ç½®sparse_superç‰¹æ€§æ ‡å¿—ï¼Œå†—ä½™å¤‡ä»½å­˜åœ¨ä¸æ‰€æœ‰çš„å—ç»„ä¸­ã€‚ä»¥ä¸‹æ˜¯2.6.32.18å†…æ ¸ä¸­å¯¹Ext4è¶…çº§å—çš„æè¿°ï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-27-11-28989651_1376493519z4rQ.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-27-15-28989651_1376493582Lvr6.png" alt="">&lt;/p>
&lt;p>3.0çš„å†…æ ¸ä¸­ï¼ŒExt4çš„è¶…çº§å—åŠ å…¥äº†ä»¥ä¸‹ç›¸å…³å…ƒæ•°æ®ï¼šå¿«ç…§ã€æ–‡ä»¶ç³»ç»Ÿé”™è¯¯å¤„ç†ç›¸å…³ã€æŒ‚è½½é€‰é¡¹ã€é…é¢æ–‡ä»¶inodeã€è¶…çº§å—æ ¡éªŒå’Œç­‰ï¼Œè§ä¸‹å›¾ã€‚ç›®å‰æ²¡æœ‰æ·±å…¥ç ”ç©¶è¿™äº›æ–°çš„å…ƒæ•°æ®ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-27-21-28989651_1376493600Aq8i.png" alt="">&lt;/p>
&lt;h2 id="18å—ç»„æè¿°ç¬¦">1.8Â å—ç»„æè¿°ç¬¦&lt;/h2>
&lt;p>ä¸€ä¸ªå—ç»„ä¸­ï¼Œå…·æœ‰å›ºå®šä½ç½®çš„æ•°æ®ç»“æ„æ˜¯è¶…çº§å—å’Œå—ç»„æè¿°ç¬¦ã€‚å…¶ä»–æ•°æ®ç»“æ„ä½ç½®éƒ½å¯ä»¥ä¸å›ºå®šã€‚Flex_bgæœºåˆ¶ä½¿ç”¨è¿™ä¸ªæ€§è´¨å°†å‡ ä¸ªå—ç»„èšåˆæˆä¸€ä¸ªflexå—ç»„ï¼Œå°†flex_bgä¸­æ‰€æœ‰ä½å›¾å’ŒinodeÂ è¡¨æ”¾åˆ°flex_bgçš„ç¬¬ä¸€ä¸ªå—ç»„ä¸­ã€‚è¯¦ç»†æƒ…å†µå¯ä»¥å‚è€ƒæˆ‘çš„ä¸Šä¸€ç¯‡Ext4åˆ†æåšæ–‡çš„FlexibleÂ å—ç»„ï¼ˆflex_bgï¼‰éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-27-25-28989651_1376493616YUiG.png" alt="">&lt;/p>
&lt;h2 id="19æ•°æ®å—ä½å›¾ä¸inodeä½å›¾">1.9Â æ•°æ®å—ä½å›¾ä¸inodeä½å›¾&lt;/h2>
&lt;p>æ•°æ®å—ä½å›¾è·Ÿè¸ªå—ç»„ä¸­æ•°æ®å—ä½¿ç”¨æƒ…å†µã€‚Inodeä½å›¾è·Ÿè¸ªå—ç»„ä¸­Inodeä½¿ç”¨æƒ…å†µã€‚æ¯ä¸ªä½å›¾ä¸€ä¸ªæ•°æ®å—ï¼Œæ¯ä¸€ä½ç”¨0æˆ–1è¡¨ç¤ºä¸€ä¸ªå—ç»„ä¸­æ•°æ®å—æˆ–inodeè¡¨ä¸­inodeçš„ä½¿ç”¨æƒ…å†µã€‚å¦‚æœä¸€ä¸ªæ•°æ®å—å¤§å°æ˜¯4KBçš„è¯ï¼Œé‚£ä¸€ä¸ªä½å›¾å—å¯ä»¥è¡¨ç¤º4&lt;em>1024&lt;/em>8ä¸ªæ•°æ®å—çš„ä½¿ç”¨æƒ…å†µï¼Œè¿™ä¹Ÿæ˜¯å•ä¸ªå—ç»„å…·æœ‰çš„æœ€å¤§æ•°æ®å—ä¸ªæ•°ã€‚è¿™æ ·å¯ä»¥ç®—å‡ºä¸€ä¸ªå—ç»„å¤§å°æ˜¯128MBã€‚å½“ç„¶ä¸€ä¸ªä½å›¾å—ä¹Ÿå¯ä»¥è¡¨ç¤º4&lt;em>1024&lt;/em>8ä¸ªinodeçš„ä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯å®é™…ä¸Šä¸€ä¸ªå—ç»„ä¸­å³ä½¿å­˜æ»¡äº†æ–‡ä»¶ï¼Œä¹Ÿä¸ä¼šç”¨åˆ°è¿™ä¹ˆå¤šçš„inodeï¼Œå› ä¸ºå®é™…ç³»ç»Ÿä¸­åŸºæœ¬ä¸ä¼šå‡ºç°æ‰€æœ‰æ–‡ä»¶å¤§å°éƒ½å°äºç­‰äº1ä¸ªæ•°æ®å—å¤§å°çš„æƒ…å†µã€‚å®é™…ä¸Šä¸€ä¸ªå—ç»„ä¸­æœ‰å¤šå°‘ä¸ªinodeï¼Œåœ¨å—ç»„æè¿°ç¬¦ä¸­æ˜¯ç¡®å®šçš„ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–è¿‡ç¨‹ä¸­ä¹Ÿä¼šçœ‹åˆ°è¿™ä¸ªæ•°å€¼ï¼Œå¦‚æœæ²¡è®°é”™çš„è¯ï¼Œå¤§æ¦‚æ˜¯æ¯4ä¸ªè¿˜æ˜¯8ä¸ªæ•°æ®å—åˆ†é…ä¸€ä¸ªinodeç©ºé—´ã€‚&lt;/p>
&lt;h2 id="110inodeè¡¨">1.10Â Inodeè¡¨&lt;/h2>
&lt;p>ä¸ºäº†æ‰¾åˆ°ä¸ä¸€ä¸ªæ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯ï¼Œå¿…é¡»éå†ç›®å½•æ–‡ä»¶æ‰¾åˆ°ä¸æ–‡ä»¶ç›¸å…³çš„ç›®å½•é¡¹ï¼Œç„¶ååŠ è½½inodeæ‰¾åˆ°è¯¥æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚Ext4åœ¨ç›®å½•é¡¹ä¸­ç”¨ä¸€ä½å­˜å‚¨äº†æ–‡ä»¶ç±»å‹(é€šå¸¸å­˜å‚¨åœ¨inodeä¸­)çš„æ‹·è´ï¼Œè¿™å¯¹æ€§èƒ½æå‡æœ‰ç›Šã€‚Inodeè¡¨çš„å¤§å°ä¸ºext4_super_block.s_inode_sizeÂ *Â ext4_super_block.s_inodes_per_groupÂ Bytesã€‚Â &lt;br>
&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-27-33-28989651_13764936686K5v.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-27-41-28989651_13764936937EGO.png" alt="">&lt;/p>
&lt;h2 id="111æŸ¥æ‰¾inode">1.11Â æŸ¥æ‰¾inode&lt;/h2>
&lt;p>æ¯ä¸ªå—ç»„åŒ…å«ext4_super_block.s_inodes_per_groupä¸ªinodesã€‚å› ä¸º0å·inodeä¸å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹çš„ç®—å¼è®¡ç®—inodeæ‰€åœ¨çš„å—ç»„ï¼š&lt;/p>
&lt;p>&lt;code>bg=(inode_numÂ -1)/Â ext4_super_block.s_inodes_per_group&lt;/code>&lt;/p>
&lt;p>inodeåœ¨å—ç»„ä¸­inodeè¡¨ä¸­çš„ç´¢å¼•indexå¯ä»¥é€šè¿‡å¦‚ä¸‹çš„ç®—å¼è®¡ç®—ï¼š&lt;/p>
&lt;p>&lt;code>index=(inode_numÂ -1)Â %Â ext4_super_block.s_inodes_per_group&lt;/code>&lt;/p>
&lt;p>inodeåœ¨inodeè¡¨ä¸­çš„åœ°å€åç§»ä¸ºï¼š&lt;/p>
&lt;p>&lt;code>offset=indexÂ *Â ext4_super_block.s_inodeÂ _size&lt;/code>&lt;/p>
&lt;h2 id="112inodei_block0sçš„å†…å®¹">1.12Â inode.i_block0[]sçš„å†…å®¹&lt;/h2>
&lt;p>å–å†³äºæ–‡ä»¶ç±»å‹ï¼Œinode.i_blocks[]ä½¿ç”¨çš„æ–¹å¼ä¸åŒã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸è§„æ–‡ä»¶å’Œç›®å½•ç”¨inode.i_blocks[]ä½œä¸ºæ–‡ä»¶æ•°æ®å—ç´¢å¼•ä¿¡æ¯ï¼Œç‰¹æ®Šæ–‡ä»¶å°†inode.i_blocks[]ç”¨äºç‰¹æ®Šç”¨é€”ã€‚å¸¸è§„æ–‡ä»¶ç”¨inode.i_blocks[]ä½œä¸ºæ–‡ä»¶æ•°æ®å—ç´¢å¼•ä¿¡æ¯çš„ä¸‰çº§ç´¢å¼•ç»“æ„ä¼šåœ¨åé¢ç›´æ¥ã€é—´æ¥å—åœ°å€ä¸­è¯¦ç»†ä»‹ç»ã€‚&lt;/p>
&lt;h2 id="113-ç¬¦å·é“¾æ¥">1.13 Â ç¬¦å·é“¾æ¥&lt;/h2>
&lt;p>å¦‚æœç¬¦å·é“¾æ¥çš„ç›®æ ‡å­—ç¬¦ä¸²é•¿åº¦å°äº60å­—èŠ‚ï¼Œé‚£ä¹ˆå°±å°†å…¶å­˜å‚¨åœ¨inode.i_blocks[]ä¸­ï¼Œinodeä¸­inode.i_blocks[]å æ®çš„å¤§å°åˆšå¥½æ˜¯60KBã€‚è¿™é‡Œè¦æ³¨æ„åˆ°çš„æ˜¯ï¼Œæœ‰äº›æ–‡ä»¶å…¶å†…å®¹æ˜¯è·Ÿæ–‡ä»¶çš„å…ƒæ•°æ®æ”¾åœ¨ä¸€èµ·çš„ï¼Œå› è€Œå°±æ²¡æœ‰äº†æ•°æ®å—ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æ¯ä¸ªæ–‡ä»¶æ•°æ®éƒ½å¿…ç„¶å æ®ç€ä¸€ä¸ªæ•°æ®å—ã€‚&lt;/p>
&lt;h2 id="114ç›´æ¥é—´æ¥å—åœ°å€">1.14Â ç›´æ¥/é—´æ¥å—åœ°å€&lt;/h2>
&lt;p>Â Ext2/Ext3ä¸­æ•°æ®å—æ˜ å°„æ–¹å¼å¦‚ä¸‹è¡¨&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-28-43-28989651_1376493721DQi6.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-28-48-28989651_1376493732tfez.png" alt="">&lt;/p>
&lt;h2 id="115extentæ ‘">1.15Â Â Â ExtentÂ æ ‘&lt;/h2>
&lt;p>Ext4ä¸­ç”¨extentæ ‘ä»£æ›¿äº†é€»è¾‘å—æ˜ å°„ã€‚ä½¿ç”¨extentsï¼Œç”¨ä¸€ä¸ªstructÂ ext4_extentç»“æ„å°±å¯ä»¥æ˜ å°„å¤šä¸ªæ•°æ®å—ï¼Œå‡å°‘å…ƒæ•°æ®å—çš„ä½¿ç”¨ã€‚å¦‚æœè®¾ç½®äº†flex_bgï¼Œç”šè‡³å¯ä»¥ç”¨ä¸€ä¸ªextentåˆ†é…ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ã€‚ä½¿ç”¨extentç‰¹æ€§ï¼Œinodeå¿…é¡»è®¾ç½®extentsÂ flagã€‚&lt;/p>
&lt;p>Extentsä»¥æ ‘çš„æ–¹å¼å®‰æ’ã€‚Extentæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä»¥ä¸€ä¸ªext4_extent_headerå¼€å¤´ï¼Œå¦‚æœèŠ‚ç‚¹æ˜¯å†…éƒ¨èŠ‚ç‚¹(ext4_extent_header.eh_depth&amp;gt;0)ï¼Œext4_extent_headeråé¢ç´§è·Ÿçš„æ˜¯ext4_extent_headerÂ .eh_entriesä¸ªç´¢å¼•é¡¹structÂ ext4_extent_idxï¼Œæ¯ä¸ªç´¢å¼•é¡¹æŒ‡å‘è¯¥extentæ ‘ä¸­ä¸€ä¸ªåŒ…å«æ›´å¤šçš„èŠ‚ç‚¹çš„æ•°æ®å—ã€‚å¦‚æœèŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹(ext4_extent_header.eh_depth==0)ï¼Œext4_extent_headeråé¢ç´§è·Ÿçš„æ˜¯ext4_extent_headerÂ .eh_entriesä¸ªstructÂ ext4_extentæ•°æ®ç»“æ„ã€‚è¿™äº›ext4_extentç»“æ„æŒ‡å‘æ–‡ä»¶æ•°æ®å—ã€‚Extentæ ‘çš„æ ¹ç»“ç‚¹å­˜å‚¨åœ¨inode.i_blocksä¸­ï¼Œå¯ä»¥å­˜å‚¨æ–‡ä»¶çš„å‰4ä¸ªextentsè€Œä¸éœ€é¢å¤–çš„å…ƒæ•°æ®å—ã€‚&lt;/p>
&lt;p>ext4_extent_headerï¼š&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-28-54-28989651_1376493751828X.png" alt="">&lt;/p>
&lt;p>structÂ ext4_extent_idxï¼šextentæ ‘çš„å†…éƒ¨èŠ‚ç‚¹ï¼Œä¹Ÿç§°ä¸ºç´¢å¼•èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201308/14/28989651_1376493761Or0J.jpg" alt="">&lt;/p>
&lt;p>ext4_extentï¼šextentæ ‘çš„å¶å­èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-29-08-28989651_1376493772mVMU.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/22-14-29-03-28989651_13764937882FDI.png" alt="">&lt;/p>
&lt;h2 id="116extentæ ‘æ•°æ®å—æ ¡éªŒå’Œå¯èƒ½åŠ å…¥çš„æ–°å…ƒæ•°æ®">1.16Â Extentæ ‘æ•°æ®å—æ ¡éªŒå’Œï¼šå¯èƒ½åŠ å…¥çš„æ–°å…ƒæ•°æ®&lt;/h2>
&lt;p>ç”±äºextentæ ‘çš„æ ¹åœ¨inodeä¸­ï¼Œå› è€ŒExtentæ ‘æ•°æ®å—æŒ‡extentæ ‘çš„é™¤æ ¹æ®èŠ‚ç‚¹å¤–çš„æ‰€æœ‰å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹ã€‚Extentçš„æ ‘æ ¹èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„æ•°æ®å—ä¸­å­˜å‚¨å®Œxt4_extent_idxå’Œxt4_extentæ•°æ®ç»“æ„åè‡³å°‘ä¼šç•™ä¸‹4Â ((2^x%12)&amp;gt;=4)Â bytesçš„ç©ºé—´ã€‚å› è€Œå¯ä»¥åŠ å…¥ä¸€ä¸ªç»“æ„structÂ ext4_extent_tailï¼Œå…¶ä¸­å­˜å‚¨32ä½çš„æ ¡éªŒå’Œã€‚ä½äºinodeä¸­çš„4ä¸ªextentsæ— éœ€æ ¡éªŒå’Œï¼Œå› ä¸ºinodeå·²ç»åšäº†æ ¡éªŒå’Œã€‚&lt;/p>
&lt;h2 id="117ç›®å½•é¡¹">1.17Â ç›®å½•é¡¹&lt;/h2>
&lt;p>Ext4æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç›®å½•å·®ä¸å¤šæ˜¯ä¸€ä¸ªå¹³é¢æ–‡ä»¶ï¼Œæ˜ å°„ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªinodeã€‚æ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨å¤šä¸ªç›®å½•é¡¹å¼•ç”¨åŒä¸€ä¸ªinodeâ€”â€”ç¡¬é“¾æ¥ï¼Œè¿™ä¹Ÿæ˜¯ç¡¬é“¾æ¥ä¸èƒ½é“¾æ¥å…¶ä»–æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶çš„åŸå› ã€‚&lt;/p>
&lt;h2 id="118çº¿æ€§ç»å…¸ç›®å½•">1.18Â çº¿æ€§ï¼ˆç»å…¸ï¼‰ç›®å½•&lt;/h2>
&lt;p>ç¼ºçœåœ°ï¼Œç›®å½•æ–‡ä»¶ä¸­åŒ…å«ä¸€ä¸ªçº¿æ€§çš„ç›®å½•é¡¹æ•°ç»„ã€‚æœªä½¿ç”¨çš„ç›®å½•é¡¹æ ‡è®°ä¸ºinodeÂ =0ã€‚Ext4æ–‡ä»¶ç³»ç»Ÿé»˜è®¤åœ°ä½¿ç”¨structÂ ext4_dir_entry_2è®°å½•ç›®å½•é¡¹ï¼Œé™¤éæ²¡æœ‰è®¾ç½®filetypeç‰¹æ€§æ ‡å¿—ã€‚åœ¨æ²¡æœ‰è®¾ç½®filetypeç‰¹æ€§æ ‡å¿—çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨structÂ ext4_dir_entryè®°å½•ç›®å½•é¡¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">struct&lt;/span> &lt;span class="n">ext4_dir_entry&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="n">__le32&lt;/span> &lt;span class="n">inode&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">__le16&lt;/span> &lt;span class="n">rec_len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">__le16&lt;/span> &lt;span class="n">name_len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">EXT4_NAME_LEN&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">ext4_dir_entry_2&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="n">__le32&lt;/span> &lt;span class="n">inode&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">__le16&lt;/span> &lt;span class="n">rec_len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">__u8&lt;/span> &lt;span class="n">name_len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">__u8&lt;/span> &lt;span class="n">file_type&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">EXT4_NAME_LEN&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="119å“ˆå¸Œæ ‘ç›®å½•">1.19Â å“ˆå¸Œæ ‘ç›®å½•&lt;/h2>
&lt;p>çº¿æ€§ç›®å½•é¡¹ä¸åˆ©äºç³»ç»Ÿæ€§èƒ½æå‡ã€‚å› è€Œä»ext3å¼€å§‹åŠ å…¥äº†å¿«é€Ÿå¹³è¡¡æ ‘å“ˆå¸Œç›®å½•é¡¹åç§°ã€‚å¦‚æœåœ¨inodeä¸­è®¾ç½®EXT4_INDEX_FLæ ‡å¿—ï¼Œç›®å½•ä½¿ç”¨å“ˆå¸Œçš„Bæ ‘ï¼ˆhashed btree ï¼Œhtreeï¼‰ç»„ç»‡å’ŒæŸ¥æ‰¾ç›®å½•é¡¹ã€‚ä¸ºäº†å‘ååªè¯»å…¼å®¹Ext2ï¼Œhtreeå®é™…ä¸Šéšè—åœ¨ç›®å½•æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;p>Ext2çš„æƒ¯ä¾‹ï¼Œæ ‘çš„æ ¹æ€»æ˜¯åœ¨ç›®å½•æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªæ•°æ®å—ä¸­ã€‚â€œ.â€å’Œâ€œ..â€ç›®å½•é¡¹å¿…é¡»å‡ºç°åœ¨ç¬¬ä¸€ä¸ªæ•°æ®å—çš„å¼€å¤´ã€‚å› è€Œè¿™ä¸¤ä¸ªç›®å½•é¡¹åœ¨æ•°æ®å—çš„å¼€å¤´å­˜æ”¾ä¸¤ä¸ªstruct ext4_dir_entry_2ç»“æ„ï¼Œä¸”å®ƒä»¬ä¸å­˜åˆ°æ ‘ä¸­ã€‚æ ¹ç»“ç‚¹çš„å…¶ä»–éƒ¨åˆ†åŒ…å«æ ‘çš„å…ƒæ•°æ®ï¼Œæœ€åä¸€ä¸ªhash-&amp;gt;block mapæŸ¥æ‰¾åˆ°htreeä¸­æ›´ä½çš„èŠ‚ç‚¹ã€‚å¦‚æœdx_root.info.indirect_levelsä¸ä¸º0ï¼Œé‚£ä¹ˆhtreeæœ‰ä¸¤å±‚ï¼›htreeæ ¹ç»“ç‚¹çš„mapæŒ‡å‘çš„æ•°æ®å—æ˜¯ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹ï¼Œç”±ä¸€ä¸ªminor hashç´¢å¼•ã€‚Htreeä¸­çš„å†…éƒ¨èŠ‚ç‚¹çš„minor_hash-&amp;gt;block mapä¹‹ååŒ…å«ä¸€ä¸ªé›¶åŒ–çš„(zeroed out) structext4_dir_entry_2æ‰¾åˆ°å¶å­èŠ‚ç‚¹ã€‚å¶å­èŠ‚ç‚¹åŒ…æ‹¬ä¸€ä¸ªçº¿æ€§çš„struct ext4_dir_entry_2æ•°ç»„ï¼›æ‰€æœ‰è¿™äº›é¡¹éƒ½å“ˆå¸Œåˆ°ç›¸åŒçš„å€¼ã€‚å¦‚æœå‘ç”Ÿæº¢å‡ºï¼Œç›®å½•é¡¹ç®€å•åœ°æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå“ˆå¸Œçš„least-significantä½ï¼ˆå†…éƒ¨èŠ‚ç‚¹çš„mapï¼‰åšç›¸åº”è®¾ç½®ã€‚&lt;/p>
&lt;p>Â Â Â Â Â Â  ä»¥htreeçš„æ–¹å¼éå†ç›®å½•ï¼Œè®¡ç®—è¦æŸ¥æ‰¾çš„ç›®å½•æ–‡ä»¶åç§°çš„å“ˆå¸Œå€¼ï¼Œç„¶åä½¿ç”¨å“ˆå¸Œå€¼æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å—å·ã€‚å¦‚æœæ ‘æ˜¯flatï¼Œè¯¥æ•°æ®å—æ˜¯ç›®å½•é¡¹çš„çº¿æ€§æ•°ç»„ï¼Œå› è€Œå¯è¢«æœç´¢åˆ°ï¼›å¦åˆ™ï¼Œè®¡ç®—æ–‡ä»¶åç§°çš„minor hashï¼Œå¹¶ä½¿ç”¨minor hashæŸ¥æ‰¾ç›¸åº”çš„ç¬¬ä¸‰ä¸ªæ•°æ®å—å·ã€‚ç¬¬ä¸‰ä¸ªæ•°æ®å—æ˜¯ç›®å½•é¡¹çº¿æ€§æ•°ç»„ã€‚&lt;/p>
&lt;p>**Htreeçš„æ ¹ ï¼š**struct dx_root&lt;br>
&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_13838358542Gih.jpg" alt="">&lt;/p>
&lt;p>&lt;strong>Htree****çš„å†…éƒ¨èŠ‚ç‚¹ï¼š&lt;/strong>Â struct dx_node&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_13838359310LhJ.jpg" alt="">&lt;/p>
&lt;p>HtreeÂ æ ‘æ ¹å’ŒèŠ‚ç‚¹ä¸­éƒ½å­˜åœ¨çš„Â &lt;strong>Hash map&lt;/strong>**ï¼š**Â struct dx_entry&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383835946jC8F.jpg" alt="">&lt;/p>
&lt;h2 id="120æ‰©å±•å±æ€§ea">1.20Â æ‰©å±•å±æ€§EA&lt;/h2>
&lt;p>æ‰©å±•å±æ€§ï¼ˆxattrsï¼‰é€šå¸¸å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ä¸€ä¸ªå•ç‹¬çš„æ•°æ®å—ä¸­ï¼Œé€šè¿‡inode.i_file_acl*å¼•ç”¨ã€‚æ‰©å±•å±æ€§çš„ç¬¬ä¸€åº”ç”¨æ˜¯å­˜å‚¨æ–‡ä»¶çš„ACLä»¥åŠå…¶ä»–å®‰å…¨æ•°æ®(selinux)ã€‚ä½¿ç”¨user_xattræŒ‚è½½é€‰é¡¹å°±å¯ä¸ºç”¨æˆ·å­˜å‚¨ä»¥â€œuserâ€å¼€å¤´çš„æ‰€æœ‰æ‰©å±•å±æ€§ã€‚è¿™æ ·çš„é™åˆ¶åœ¨3.0å†…æ ¸ä¸­å·²ç»æ¶ˆå¤±ã€‚&lt;/p>
&lt;p>å¯ä»¥åœ¨ä¸¤ä¸ªåœ°æ–¹æ‰¾åˆ°æ‰©å±•å±æ€§ï¼šä¸€æ˜¯åœ¨ä¸€ä¸ªinodeé¡¹ç»“å°¾åˆ°ä¸‹ä¸€ä¸ªinodeé¡¹å¼€å¤´çš„åœ°æ–¹ï¼›äºŒæ˜¯inode.i_file_aclæŒ‡å‘ çš„æ•°æ®å—ä¹‹ä¸­ï¼Œåˆ°3.0ä¸ºæ­¢ï¼Œè¿™ä¸ªæ•°æ®å—ä¸­ä¸åŒ…å«æŒ‡å‘ç¬¬äºŒä¸ªæ‰©å±•å±æ€§æ•°æ®å—çš„æŒ‡é’ˆã€‚ç†è®ºä¸Šå¯ä»¥å°†æ¯ä¸ªå±æ€§å€¼å­˜å‚¨åˆ°ä¸€ä¸ªå•ç‹¬çš„æ•°æ®å—ä¸­ï¼Œä½†æ˜¯3.0å†…æ ¸ä¸ºæ­¢ä»ç„¶æ²¡æœ‰è¿™æ ·åšã€‚&lt;/p>
&lt;p>å½“æ‰©å±•å±æ€§ä¸å­˜å‚¨åœ¨ä¸€ä¸ªinodeä¹‹åçš„æ—¶å€™ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªå¤´éƒ¨ext4_xattr_ibody_header&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836044J1Ee.jpg" alt="">&lt;/p>
&lt;p>æ‰©å±•å±æ€§æ•°æ®å—çš„å¼€å¤´æ˜¯ext4_xattr _header&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836053bZMK.jpg" alt="">&lt;/p>
&lt;p>ç´§è·Ÿåœ¨ext4_xattr_ibody_headeræˆ–è€…ext4_xattr _headeråé¢çš„æ˜¯ç»“æ„æ•°ç»„Â struct ext4_xattr_entry&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_13838360603T4T.jpg" alt="">&lt;/p>
&lt;p>æ‰©å±•å±æ€§å€¼å¯ä»¥ç´§è·Ÿåœ¨ext4_xattr_entryé¡¹è¡¨åé¢ã€‚è€ƒè™‘4 byteså¯¹é½ã€‚æ‰©å±•å±æ€§å€¼ä»æ‰©å±•å±æ€§æ•°æ®å—çš„æœ«å°¾å¼€å§‹å‘ext4_xattr _header / ext4_xattr_entryè¡¨çš„æ–¹å‘å¢é•¿ã€‚å½“å‘ç”Ÿæº¢å‡ºæ—¶ï¼Œæº¢å‡ºçš„éƒ¨åˆ†æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„ç£ç›˜æ•°æ®å—ä¸Šã€‚&lt;/p>
&lt;h2 id="121æ—¥å¿—jbd2">1.21Â æ—¥å¿—ï¼ˆJBD2ï¼‰&lt;/h2>
&lt;p>æ–‡ä»¶ç³»ç»Ÿåœ¨ç£ç›˜ä¸Šä¿ç•™ä¸€æ®µå°çš„è¿ç»­åŒºåŸŸ(é»˜è®¤128MB)ï¼Œä½œä¸ºå°½å¯èƒ½éœ€è¦å¿«é€Ÿå†™å…¥ç£ç›˜çš„â€œé‡è¦â€æ•°æ®çš„å­˜æ”¾åœ°ã€‚ä¸€æ—¦è¯¥é‡è¦æ•°æ®äº‹åŠ¡å®Œå…¨å†™åˆ°ç£ç›˜ï¼Œå°†å…¶ä»ç£ç›˜å†™ç¼“å­˜ä¸­åˆ·å‡ºã€‚è¢«æäº¤çš„æ•°æ®ä¸€ä»½è®°å½•ä¹Ÿè¢«å†™åˆ°æ—¥å¿—ã€‚ä¸€æ®µæ—¶é—´åï¼Œæ—¥å¿—åœ¨æ“¦é™¤æäº¤è®°å½•å‰å°†äº‹åŠ¡å†™åˆ°å®ƒä»¬åœ¨ç£ç›˜ä¸Šçš„æœ€ç»ˆä½ç½®(å¯èƒ½åŒ…å«å¤§é‡çš„å¯»é“æˆ–è€…å¤§é‡çš„è¯»-å†™-æ“¦é™¤)ã€‚&lt;/p>
&lt;p>ä»æ€§èƒ½æ–¹é¢è€ƒè™‘ï¼ŒExt4é»˜è®¤ç›´æ¥å°†æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®å†™åˆ°æ—¥å¿—ã€‚å› è€Œä¸èƒ½ä¿è¯æ–‡ä»¶æ•°æ®å—çš„ä¸€è‡´æ€§ã€‚&lt;/p>
&lt;p>Â Â Â Â Â Â Â æ—¥å¿—çš„inodeä¸º8ã€‚æ—¥å¿—inodeçš„å‰68 byteså¤åˆ¶äº†ext4Â è¶…çº§å—ã€‚æ—¥å¿—æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ˜¯æ™®é€šæ–‡ä»¶ï¼Œä½†æ˜¯éšè—ä¸å¯è§ã€‚æ—¥å¿—æ–‡ä»¶é€šå¸¸æ¶ˆè€—ä¸€ä¸ªå®Œæ•´çš„å—ç»„ï¼Œå¯ä»¥é€šè¿‡mke2fså°†æ—¥å¿—æ–‡ä»¶æ”¾åœ¨ç£ç›˜çš„ä¸­é—´ã€‚&lt;/p>
&lt;p>Ext4å’ŒOcfs2éƒ½ä½¿ç”¨JBD2ã€‚&lt;/p>
&lt;h3 id="1211å¸ƒå±€">1.21.1Â å¸ƒå±€&lt;/h3>
&lt;p>æ—¥å¿—å¸ƒå±€&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836366A8dq.jpg" alt="">&lt;/p>
&lt;p>ä¸€ä¸ªäº‹åŠ¡ä»¥æè¿°ç¬¦å’Œä¸€äº›æ•°æ®æˆ–è€…block revocationé“¾è¡¨å¼€å§‹ã€‚ä¸€ä¸ªç»“æŸçš„äº‹åŠ¡æ€»æ˜¯ä»¥ä¸€ä¸ªæäº¤å—ç»“æŸã€‚å¦‚æœæ²¡æœ‰æäº¤è®°å½•ï¼ˆæˆ–è€…æ ¡éªŒå’Œä¸åŒ¹é…ï¼‰ï¼Œäº‹åŠ¡åœ¨æ—¥å¿—é‡æ¼”çš„æ—¶å€™å°†è¢«ä¸¢å¼ƒã€‚&lt;/p>
&lt;h3 id="1212-æ•°æ®å—å¤´éƒ¨">1.21.2 Â æ•°æ®å—å¤´éƒ¨&lt;/h3>
&lt;p>æ—¥å¿—ä¸­çš„æ¯ä¸ªæ•°æ®å—çš„å¼€å¤´éƒ½æ˜¯ä¸€ä¸ª12 bytesçš„æ•°æ®ç»“æ„Â struct journal_header_s&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836376fBf6.jpg" alt="">&lt;/p>
&lt;h3 id="1213-è¶…çº§å—">1.21.3 Â è¶…çº§å—&lt;/h3>
&lt;p>æ—¥å¿—çš„è¶…çº§å—æ¯”Ext4çš„è¶…çº§å—ç®€å•ã€‚ä¿å­˜åœ¨æ—¥å¿—çš„è¶…çº§å—ä¸­æ˜¯æ—¥å¿—çš„å…³é”®æ•°æ®ã€‚æ—¥å¿—è¶…çº§å—ä½¿ç”¨æ•°æ®ç»“æ„struct journal_superblock_sè¡¨ç¤ºï¼Œå¤§å°ä¸º1024 bytesã€‚&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836388Dhwt.jpg" alt="">&lt;/p>
&lt;h3 id="1214-æè¿°æ•°æ®å—descriptor-block">1.21.4 Â æè¿°æ•°æ®å—Descriptor Block&lt;/h3>
&lt;p>Descriptor BlockåŒ…å«ä¸€ä¸ªæ—¥å¿—æ•°æ®å—tagsçš„æ•°ç»„ï¼Œè¿™äº›tagsæè¿°äº†æ—¥å¿—ä¸­æ¥ä¸‹æ¥çš„æ•°æ®å—çš„æœ€ç»ˆä½ç½®ã€‚&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836398lSZl.jpg" alt="">&lt;/p>
&lt;p>æ—¥å¿—æ•°æ®å—tagså…·æœ‰å¦‚ä¸‹æ ¼å¼ï¼šç”±æ•°æ®ç»“æ„struct journal_block_tag_sè¡¨ç¤ºï¼Œå¯ä»¥æ˜¯8ï¼Œ12ï¼Œ24æˆ–38bytesã€‚&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_13838364075ta9.jpg" alt="">&lt;/p>
&lt;h3 id="1215-æ•°æ®å—data-block">1.21.5 Â æ•°æ®å—Data Block&lt;/h3>
&lt;p>å­˜æ”¾çš„æ˜¯é€šè¿‡æ—¥å¿—å†™åˆ°ç£ç›˜çš„æ•°æ®å—ã€‚ä½†æ˜¯å¦‚æœæ•°æ®å—çš„å‰4 bytesä¸jbd2çš„é­”æ•°åŒ¹é…ï¼Œé‚£ä¹ˆè¿™äº›4 bytesç”¨0ä»£æ›¿ï¼Œå¹¶ä¸”åœ¨Descriptor Blockä¸­è®¾ç½®escapedã€‚&lt;/p>
&lt;p>&lt;strong>1.21.6 Â Revocation Block&lt;/strong>&lt;/p>
&lt;p>Revocation blockç”¨äºè®°å½•æœ¬äº‹åŠ¡ä¸­çš„æ•°æ®å—é“¾è¡¨ï¼Œå–ä»£ä»»ä½•æ½œåœ¨æ—¥å¿—ä¸­çš„æ›´é™ˆæ—§çš„æ•°æ®å—è¿™æ ·å¯ä»¥åŠ é€Ÿæ¢å¤ï¼Œå› ä¸ºé™ˆæ—§çš„æ•°æ®å—ä¸å¿…å†™åˆ°ç£ç›˜ã€‚&lt;/p>
&lt;p>Revocation blockä½¿ç”¨ structjbd2_journal_revoke_header_sç»“æ„è¡¨ç¤º&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836484127L.jpg" alt="">&lt;/p>
&lt;h3 id="1217-æäº¤å—">1.21.7 Â æäº¤å—&lt;/h3>
&lt;p>æäº¤å¿«è¡¨æ˜äº†ä¸€ä¸ªäº‹åŠ¡å·²å®Œæ•´å†™åˆ°æ—¥å¿—ã€‚ä¸€æ—¦æäº¤å—åˆ°è¾¾æ—¥å¿—ï¼Œå­˜å‚¨åœ¨è¯¥äº‹åŠ¡ä¸­çš„æ•°æ®å¯ä»¥å†™åˆ°å®ƒä»¬åœ¨ç£ç›˜ä¸­çš„æœ€ç»ˆä½ç½®ã€‚&lt;/p>
&lt;p>æäº¤å¿«ç”±æ•°æ®ç»“æ„struct commit_headerè¡¨ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="http://blog.chinaunix.net/attachment/201311/7/28989651_1383836493RAT5.jpg" alt="">&lt;/p></description></item><item><title>FUSE- linuxç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ(è½¬)</title><link>https://justice.bj.cn/post/21.linux/linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B9%8Bfuse/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B9%8Bfuse/</guid><description>&lt;h1 id="fuse-linuxç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿè½¬">FUSE: linuxç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ(è½¬)&lt;/h1>
&lt;h2 id="ç®€ä»‹">ç®€ä»‹&lt;/h2>
&lt;h2 id="æ¶æ„">æ¶æ„&lt;/h2>
&lt;p>ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„æ¦‚å¿µï¼ŒæŒ‡å®Œå…¨åœ¨ç”¨æˆ·æ€å®ç°çš„æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/p>
&lt;p>ç›®å‰Linuxé€šè¿‡å†…æ ¸æ¨¡å—å¯¹æ­¤è¿›è¡Œæ”¯æŒã€‚ä¸€äº›æ–‡ä»¶ç³»ç»Ÿå¦‚ZFSï¼Œglusterfsä½¿ç”¨FUSEå®ç°ã€‚&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/209af4d9f14a2bf12bd44e9d77b47eaa_1174x826.png" alt="">&lt;/p>
&lt;p>FUSEçš„å·¥ä½œåŸç†å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚&lt;/p>
&lt;p>å‡è®¾åŸºäºFUSEçš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»ŸhelloæŒ‚è½½åœ¨/tmp/fuseç›®å½•ä¸‹ã€‚&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å½“åº”ç”¨å±‚ç¨‹åºè¦è®¿é—®/tmp/fuseä¸‹çš„æ–‡ä»¶æ—¶ï¼Œé€šè¿‡glibcä¸­çš„å‡½æ•°è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå¤„ç†è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„VFSä¸­çš„å‡½æ•°ä¼šè°ƒç”¨FUSEåœ¨å†…æ ¸ä¸­çš„æ–‡ä»¶ç³»ç»Ÿï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å†…æ ¸ä¸­çš„FUSEæ–‡ä»¶ç³»ç»Ÿå°†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå‘é€ç»™ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿhelloï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿæ”¶åˆ°è¯·æ±‚åï¼Œè¿›è¡Œå¤„ç†ï¼Œå°†ç»“æœè¿”å›ç»™å†…æ ¸ä¸­çš„FUSEæ–‡ä»¶ç³»ç»Ÿï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœ€åï¼Œå†…æ ¸ä¸­çš„FUSEæ–‡ä»¶ç³»ç»Ÿå°†æ•°æ®è¿”å›ç»™ç”¨æˆ·æ€ç¨‹åºã€‚&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>Linux IO ä¹‹ IOä¸ç½‘ç»œæ¨¡å‹</title><link>https://justice.bj.cn/post/21.linux/linux-io-%E4%B9%8B-io%E4%B8%8E%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/linux-io-%E4%B9%8B-io%E4%B8%8E%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/</guid><description>&lt;h1 id="linux-io-ä¹‹-ioä¸ç½‘ç»œæ¨¡å‹">Linux IO ä¹‹ IOä¸ç½‘ç»œæ¨¡å‹&lt;/h1>
&lt;p>&lt;img src="https://img.kancloud.cn/3a/19/3a190c1c6a523a9dd47174ede0e7a557_703x536.png" alt="">&lt;/p>
&lt;ul>
&lt;li>
&lt;p>atomic åŸå­å˜é‡: x86åœ¨å¤šæ ¸ç¯å¢ƒä¸‹ï¼Œå¤šæ ¸ç«äº‰æ•°æ®æ€»çº¿æ—¶ï¼Œæä¾›LockæŒ‡ä»¤è¿›è¡Œé”æ€»çº¿æ“ä½œã€‚ä¿è¯â€œè¯»-ä¿®æ”¹-å†™â€çš„æ“ä½œåœ¨èŠ¯ç‰‡çº§çš„åŸå­æ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>spinlock è‡ªæ—‹é”: è‡ªæ—‹é”å°†å½“å‰çº¿ç¨‹ä¸åœåœ°æ‰§è¡Œå¾ªç¯ä½“ï¼Œè€Œä¸æ”¹å˜çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œåœ¨CPUä¸Šå®ç°å¿™ç­‰ï¼Œä»¥æ­¤ä¿è¯å“åº”é€Ÿåº¦æ›´å¿«ã€‚è¿™ç§ç±»å‹çš„çº¿ç¨‹æ•°ä¸æ–­å¢åŠ æ—¶ï¼Œæ€§èƒ½æ˜æ˜¾ä¸‹é™ã€‚æ‰€ä»¥è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¿…é¡»å°ï¼Œæ“ä½œè¿‡ç¨‹å¿…é¡»çŸ­ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>semaphore ä¿¡å·é‡: ä¿¡å·é‡ç”¨äºä¿æŠ¤æœ‰é™æ•°é‡çš„ä¸´ç•Œèµ„æºï¼Œä¿¡å·é‡åœ¨è·å–å’Œé‡Šæ”¾æ—¶ï¼Œé€šè¿‡è‡ªæ—‹é”ä¿æŠ¤ï¼Œå½“æœ‰ä¸­æ–­ä¼šæŠŠä¸­æ–­ä¿å­˜åˆ°eflagså¯„å­˜å™¨ï¼Œæœ€åå†æ¢å¤ä¸­æ–­ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>mutex äº’æ–¥é”: ä¸ºäº†æ§åˆ¶åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œè®©æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ä¼‘çœ ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>rw-lock è¯»å†™é”: è¯»å†™é”ï¼ŒæŠŠè¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«è¿›è¡ŒåŠ é”å¤„ç†ï¼Œå‡å°äº†åŠ é”ç²’åº¦ï¼Œä¼˜åŒ–äº†è¯»å¤§äºå†™çš„åœºæ™¯ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="preempt-æŠ¢å ">preempt æŠ¢å &lt;/h2>
&lt;ul>
&lt;li>æ—¶é—´ç‰‡ç”¨å®Œåè°ƒç”¨scheduleå‡½æ•°ã€‚&lt;/li>
&lt;li>ç”±äºIOç­‰åŸå› è‡ªå·±ä¸»åŠ¨è°ƒç”¨scheduleã€‚&lt;/li>
&lt;li>å…¶ä»–æƒ…å†µï¼Œå½“å‰è¿›ç¨‹è¢«å…¶ä»–è¿›ç¨‹æ›¿æ¢çš„æ—¶å€™ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="per-cpu-å˜é‡">per-cpu å˜é‡&lt;/h2>
&lt;p>linuxä¸ºè§£å†³cpu å„è‡ªä½¿ç”¨çš„L2 cache æ•°æ®ä¸å†…å­˜ä¸­çš„ä¸ä¸€è‡´çš„é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="rcuæœºåˆ¶-read-copy-update">RCUæœºåˆ¶ (Read, Copy, Update)&lt;/h2>
&lt;p>ç”¨äºè§£å†³å¤šä¸ªCPUåŒæ—¶è¯»å†™å…±äº«æ•°æ®çš„åœºæ™¯ã€‚å®ƒå…è®¸å¤šä¸ªCPUåŒæ—¶è¿›è¡Œå†™æ“ä½œï¼Œä¸ä½¿ç”¨é”ï¼Œå¹¶ä¸”å®ç°åƒåœ¾å›æ”¶æ¥å¤„ç†æ—§æ•°æ®ã€‚&lt;br>
&lt;img src="https://img.kancloud.cn/eb/25/eb25aceb1f3a87e34bc659922a23fb7f_850x379.png" alt="">&lt;/p>
&lt;h2 id="å†…å­˜å±éšœ-memory-barrier">å†…å­˜å±éšœ memory-barrier&lt;/h2>
&lt;p>ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹å†…å­˜è®¿é—®ä¸ä¸€å®šæŒ‰ç…§ä»£ç ç¼–å†™çš„é¡ºåºæ¥è¿›è¡Œã€‚&lt;/p>
&lt;ol>
&lt;li>ç¼–è¯‘å™¨å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚&lt;/li>
&lt;li>å¤šcpuæ¶æ„å­˜åœ¨æŒ‡ä»¤ä¹±åºè®¿é—®å†…å­˜çš„å¯èƒ½ã€‚&lt;/li>
&lt;/ol>
&lt;h1 id="io-ä¸ç½‘ç»œæ¨¡å‹">I/O ä¸ç½‘ç»œæ¨¡å‹&lt;/h1>
&lt;p>ä»‹ç»å„ç§å„æ ·çš„I/Oæ¨¡å‹ï¼ŒåŒ…æ‹¬ä»¥ä¸‹åœºæ™¯ï¼š&lt;/p>
&lt;ol>
&lt;li>é˜»å¡ &amp;amp; éé˜»å¡&lt;/li>
&lt;li>å¤šè·¯å¤ç”¨&lt;/li>
&lt;li>Signal IO&lt;/li>
&lt;li>å¼‚æ­¥ IO&lt;/li>
&lt;li>libevent&lt;/li>
&lt;/ol>
&lt;p>ç°å®ç”Ÿæ´»ä¸­çš„åœºæ™¯å¤æ‚ï¼ŒLinux CPUå’ŒIOè¡Œä¸ºï¼Œä»–ä»¬ä¹‹é—´äº’ç›¸ç­‰å¾…ã€‚ä¾‹å¦‚ï¼Œé˜»å¡çš„IOå¯èƒ½ä¼šè®©CPUæš‚åœã€‚&lt;/p>
&lt;p>I/Oæ¨¡å‹å¾ˆéš¾è¯´å¥½ä¸åï¼Œåªèƒ½è¯´åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ›´é€‚åˆæŸäº›IOæ¨¡å‹ã€‚å…¶ä¸­ï¼Œ1ã€4 æ›´é€‚åˆå—è®¾å¤‡ï¼Œ2ã€3 æ›´é€‚ç”¨äºå­—ç¬¦è®¾å¤‡ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆç¡¬ç›˜æ²¡æœ‰æ‰€è°“çš„ å¤šè·¯å¤ç”¨ï¼Œlibeventï¼Œsignal IOï¼Ÿ&lt;/p>
&lt;p>å› ä¸ºselect(ä¸²å£), epollï¼ˆsocketï¼‰ è¿™äº›éƒ½æ˜¯åœ¨ç›‘å¬äº‹ä»¶ï¼Œæ‰€ä»¥å„ç§å„æ ·çš„IOæ¨¡å‹ï¼Œæ›´å¤šæ˜¯æè¿°å­—ç¬¦è®¾å¤‡å’Œç½‘ç»œsocketçš„é—®é¢˜ã€‚ä½†ç¡¬ç›˜çš„æ–‡ä»¶ï¼Œåªæœ‰è¯»å†™ï¼Œæ²¡æœ‰ epollè¿™äº›ã€‚è¿™äº›IOæ¨¡å‹æ›´å¤šæ˜¯åœ¨å­—ç¬¦è®¾å¤‡ï¼Œç½‘ç»œsocketçš„åœºæ™¯ã€‚&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆç¨‹åºè¦é€‰æ‹©æ­£ç¡®çš„ioæ¨¡å‹">ä¸ºä»€ä¹ˆç¨‹åºè¦é€‰æ‹©æ­£ç¡®çš„IOæ¨¡å‹ï¼Ÿ&lt;/h2>
&lt;p>è“è‰²ä»£è¡¨ï¼šcpuï¼Œçº¢è‰²ä»£è¡¨ï¼šio&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/2362bcb8a9159af33c0ec6d3e701c3df_1876x1340.png" alt="">&lt;/p>
&lt;p>å¦‚ä¸Šå›¾ï¼ŒæŸä¸ªåº”ç”¨æ‰“å¼€ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼Œå…ˆéœ€è¦100msåˆå§‹åŒ–ï¼Œæ¥ä¸‹æ¥100msè¯»è¿™ä¸ªå›¾ç‰‡ã€‚é‚£æ‰“å¼€è¿™ä¸ªå›¾ç‰‡å°±éœ€è¦200msã€‚&lt;/p>
&lt;p>ä½†æ˜¯ æ˜¯å¦å¯ä»¥å¼€ä¸¤ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶åšè¿™ä¸¤ä»¶äº‹ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/561dc951ee90a91df7d4de84ec3e88ce_1538x1128.png" alt="">&lt;/p>
&lt;p>å¦‚ä¸Šå›¾ï¼Œç½‘ç»œæ”¶å‘ç¨‹åºï¼Œå¦‚æœä¸²è¡Œæ‰§è¡Œï¼ŒCPUå’ŒIOä¼šéœ€è¦äº’ç›¸ç­‰å¾…ã€‚&lt;br>
ä¸ºä»€ä¹ˆCPUå’ŒIOå¯ä»¥å¹¶è¡Œï¼Ÿå› ä¸ºä¸€èˆ¬ç¡¬ä»¶ï¼ŒIOé€šè¿‡DMAï¼Œcpuæ¶ˆè€—æ¯”è¾ƒå°ï¼Œåœ¨ç¡¬ä»¶ä¸Šæ“ä½œçš„æ—¶é—´æ›´é•¿ã€‚CPUå’Œç¡¬ç›˜æ˜¯ä¸¤ä¸ªä¸åŒçš„ç¡¬ä»¶ã€‚&lt;/p>
&lt;p>å†æ¯”å¦‚å¼€æœºåŠ é€Ÿä¸­systemdä½¿ç”¨çš„readaheadåŠŸèƒ½:&lt;br>
ç¬¬ä¸€æ¬¡å¯åŠ¨è¿‡ç¨‹ï¼Œè¯»çš„æ–‡ä»¶ï¼Œä¼šé€šè¿‡Linux inotifyç›‘æ§linuxå†…æ ¸æ–‡ä»¶è¢«æ“ä½œçš„æƒ…å†µï¼Œè®°å½•ä¸‹æ¥ã€‚ç¬¬äºŒæ¬¡å¯åŠ¨ï¼Œåå°æœ‰è¿›ç¨‹ç›´æ¥è¯»è¿™äº›æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç­‰åˆ°éœ€è¦çš„æ—¶å€™å†è¯»ã€‚&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/7bcb94f8c0d49a964dabf226688164cc_1244x954.png" alt="">&lt;/p>
&lt;p>I/Oæ¨¡å‹ä¼šæ·±åˆ»å½±å“åº”ç”¨çš„æœ€ç»ˆæ€§èƒ½ï¼Œé˜»å¡ &amp;amp; éé˜»å¡ ã€å¼‚æ­¥ IO æ˜¯é’ˆå¯¹ç¡¬ç›˜ï¼Œ å¤šè·¯å¤ç”¨ã€signal ioã€libevent æ˜¯é’ˆå¯¹å­—ç¬¦è®¾å¤‡å’Œ socketã€‚&lt;/p>
&lt;h2 id="ç®€å•çš„ioæ¨¡å‹">ç®€å•çš„IOæ¨¡å‹&lt;/h2>
&lt;p>&lt;img src="https://box.kancloud.cn/97be9252cd80c3254efc34e477cfb28a_1242x742.png" alt="">&lt;/p>
&lt;p>å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦è¯» é”®ç›˜ã€è§¦å±ã€é¼ æ ‡æ—¶ï¼Œè¿›ç¨‹ä¼šé˜»å¡ã€‚ä½†å¯¹äºå¤§é‡å¹¶å‘çš„åœºæ™¯ï¼Œé˜»å¡IOæ— æ³•æå®šï¼Œä¹Ÿå¯èƒ½ä¼šè¢«ä¿¡å·æ‰“æ–­ã€‚&lt;/p>
&lt;p>å†…æ ¸ç¨‹åºç­‰å¾…IOï¼Œgobal fifo readä¸åˆ°&lt;/p>
&lt;p>ä¸€èˆ¬æƒ…å†µselectè¿”å›ï¼Œä¼šè°ƒç”¨ if signal_pendingï¼Œè¿›ç¨‹ä¼šè¿”å› ERESTARTSYSï¼›æ­¤æ—¶ï¼Œè¿›ç¨‹çš„read è¿”å›ç”±singalå†³å®šã€‚æœ‰å¯èƒ½è¿”å›ï¼ˆEINTRï¼‰ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸è¿”å›ã€‚&lt;/p>
&lt;h3 id="demo">demo:&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;signal.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/types.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;errno.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">sig_handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">signum&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;int handler %d&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">signum&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">ssize_t&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">sigaction&lt;/span> &lt;span class="n">oldact&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">sigaction&lt;/span> &lt;span class="n">act&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">act&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sa_handler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sig_handler&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">act&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sa_flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// act.sa_flags |= SA_RESTART;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">sigemptyset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">act&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sa_mask&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">sigaction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SIGUSR1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">act&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldact&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sigaction failed!/n&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">bzero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">do&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">STDIN_FILENO&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">ret&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">errno&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">EINTR&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;retry after eintr&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">ret&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">errno&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">EINTR&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ret&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read %d bytes, content is %s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://box.kancloud.cn/d8477b6d3cf9bcc5804f316ea0246aef_719x709.png" alt="">&lt;/p>
&lt;p>ä¸€ä¸ªé˜»å¡çš„IOï¼Œåœ¨ç¡çœ ç­‰IOæ—¶Readyï¼Œä½†ä¸­é€”è¢«ä¿¡å·æ‰“æ–­ï¼Œlinuxå“åº”ä¿¡å·ï¼Œread/writeè¯·æ±‚é˜»å¡ã€‚&lt;br>
é…ç½®ä¿¡å·æ—¶ï¼Œåœ¨SA_FLAGæ˜¯ä¸æ˜¯åŠ â€œè‡ªåŠ¨â€ï¼ŒSA_RESTARTæŒ‡å®š è¢«é˜»å¡çš„IOè¯·æ±‚æ˜¯å¦é‡å‘ï¼Œå¹¶ä¸”åº”ç”¨ä¸­å¯ä»¥æ•æ‰ã€‚åŠ äº†SA_RESTARTé‡å‘ï¼Œå°±ä¸ä¼šè¿”å›å‡ºé”™ç EINTRã€‚&lt;br>
æ²¡æœ‰åŠ SA_RESTARTé‡å‘ï¼Œå°±ä¼šè¿”å›å‡ºé”™ç ï¼ˆEINTRï¼‰ï¼Œè¿™æ ·å¯ä»¥æ£€æµ‹readè¢«ä¿¡å·æ‰“æ–­æ—¶çš„è¿”å›ã€‚&lt;/p>
&lt;p>ä½†Linuxä¸­æœ‰ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œå³ä¾¿ä½ åŠ äº†è‡ªåŠ¨é‡å‘ï¼Œä¹Ÿä¸èƒ½è‡ªåŠ¨é‡å‘ã€‚man signal.&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/4708e2b53d43c11f9d32c0d590f0711a_2172x938.png" alt="">&lt;/p>
&lt;p>å½“ä½¿ç”¨é˜»å¡IOæ—¶ï¼Œè¦å°å¿ƒè¿™éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/c92635e764196130ce6938048bed23f3_2258x1366.png" alt="">&lt;/p>
&lt;h2 id="å¤šè¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å‹">å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹æ¨¡å‹&lt;/h2>
&lt;p>å½“æœ‰å¤šä¸ªsocketæ¶ˆæ¯éœ€è¦å¤„ç†ï¼Œé˜»å¡IOæä¸å®šï¼Œæœ‰ä¸€ç§å¯èƒ½æ˜¯å¤šä¸ªè¿›ç¨‹/çº¿ç¨‹ï¼Œæ¯å½“æœ‰ä¸€ä¸ªè¿æ¥å»ºç«‹ï¼ˆaccept socket)ï¼Œéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†æ–°å»ºç«‹çš„è¿æ¥ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ¨¡å‹æ€§èƒ½ä¸å¤ªå¥½ï¼Œåˆ›å»ºå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹æ—¶ä¼šæœ‰å¼€é”€ã€‚&lt;/p>
&lt;p>ç»å…¸çš„C10Ké—®é¢˜ï¼Œæ„æ€æ˜¯ åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šç»´æŠ¤1wä¸ªè¿æ¥ï¼Œéœ€è¦å»ºç«‹1wä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ã€‚é‚£ä¹ˆå¦‚æœç»´æŠ¤1äº¿ç”¨æˆ·åœ¨çº¿ï¼Œåˆ™éœ€è¦1wå°æœåŠ¡å™¨ã€‚&lt;/p>
&lt;p>IOå¤šè·¯å¤ç”¨ï¼Œåˆ™æ˜¯è§£å†³ä»¥ä¸Šé—®é¢˜çš„åœºæ™¯ã€‚&lt;/p>
&lt;p>æ€»ç»“ï¼šå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹æ¨¡å‹ä¼å›¾æŠŠæ¯ä¸€ä¸ªfdæ”¾åˆ°ä¸åŒçš„çº¿ç¨‹/è¿›ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡çš„é—®é¢˜ï¼Œä»è€Œå¼•å…¥äº†è¿›ç¨‹åˆ›å»º\æ’¤é”€ï¼Œè°ƒåº¦çš„å¼€é”€ã€‚èƒ½å¦åœ¨ä¸€ä¸ªçº¿ç¨‹å†…æå®šæ‰€æœ‰IO? &amp;ndash; è¿™å°±æ˜¯&lt;code>å¤šè·¯å¤ç”¨&lt;/code>çš„ä½œç”¨ã€‚&lt;/p>
&lt;h2 id="å¤šè·¯å¤ç”¨">å¤šè·¯å¤ç”¨&lt;/h2>
&lt;p>&lt;img src="https://box.kancloud.cn/4ddb3f8f232beb837f294c27011cc050_2174x1226.png" alt="">&lt;/p>
&lt;h3 id="heading">&lt;/h3>
&lt;h3 id="å¼‚æ­¥io">å¼‚æ­¥IO&lt;/h3>
&lt;p>&lt;img src="https://box.kancloud.cn/03f7f8364fe3a3f4db456252f83755b3_1454x906.png" alt="">&lt;/p>
&lt;p>Linuxä¸­&lt;/p>
&lt;p>ä¸è¦æŠŠaioä¸²èµ·æ¥ï¼Œ&lt;/p>
&lt;p>åŸºäºepollç­‰apiè¿›è¡Œä¸Šå±‚çš„å°è£…ï¼Œå†åŸºäºäº‹ä»¶ç¼–ç¨‹ã€‚æŸä¸ªäº‹ä»¶æˆç«‹äº†ï¼Œå°±å¼€å§‹å»åšæŸä»¶äº‹ã€‚&lt;/p>
&lt;h3 id="libevent">libevent&lt;/h3>
&lt;p>&lt;img src="https://box.kancloud.cn/503a1ac368ec755abf62083f1573099a_1150x798.png" alt="">&lt;/p>
&lt;p>å°±åƒMFCä¸€æ ·ï¼Œç•Œé¢ä¸Šçš„æŒ‰é’®ï¼ŒVCä¼šäº§ç”Ÿä¸€ä¸ªon_buttonï¼Œè°ƒå¯¹åº”çš„å‡½æ•°ã€‚æ˜¯ä¸€ç§å…¸å‹çš„äº‹ä»¶å¾ªç¯ã€‚&lt;/p>
&lt;p>æœ¬è´¨ä¸Šè¿˜æ˜¯ç”¨äº†epollï¼Œåªæ˜¯åŸºäºäº‹ä»¶ç¼–ç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/869403b17eca63bf85ec38d2a99be3b1_1146x812.png" alt="">&lt;/p>
&lt;p>ç‚¹èµ&lt;/p></description></item><item><title>Linux IO ä¹‹ æ–‡ä»¶ç³»ç»Ÿçš„æ¶æ„(è½¬)</title><link>https://justice.bj.cn/post/21.linux/linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84/</guid><description>&lt;h1 id="linux-io-ä¹‹-æ–‡ä»¶ç³»ç»Ÿçš„æ¶æ„è½¬">Linux IO ä¹‹ æ–‡ä»¶ç³»ç»Ÿçš„æ¶æ„(è½¬)&lt;/h1>
&lt;h3 id="vfså’Œæ–‡ä»¶ç³»ç»Ÿæ€»ç»“">VFSå’Œæ–‡ä»¶ç³»ç»Ÿæ€»ç»“&lt;/h3>
&lt;p>ä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶ï¼š VFS&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/42fc84d8385cd6f0bf3c2573f2e58eea_1702x1054.png" alt="">&lt;/p>
&lt;p>æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡ï¼Œç±»ä¼¼ æŠ½è±¡åŸºç±»ï¼Œé¢å‘å¯¹è±¡çš„æ€æƒ³ã€‚&lt;/p>
&lt;p>è™šå‡½æ•°éƒ½å¿…é¡»ç”±åº•å±‚æ´¾ç”Ÿå‡ºçš„å®ä¾‹å®ç°ï¼Œä½¿ç”¨æˆå‘˜å‡½æ•° file_operationsã€‚åœ¨linuxé‡Œé¢çš„æ–‡ä»¶æ“ä½œï¼Œåº•å±‚éƒ½è¦å®ç°file_operationsï¼ŒæŠ½è±¡å‡ºownerï¼Œwriteï¼Œopenï¼Œreleaseã€‚æ‰€ä»¥ï¼Œæ— è®ºæ˜¯å­—ç¬¦å—ï¼Œè¿˜æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ï¼Œæœ€ç»ˆæ“ä½œå°±å¿…é¡»æ˜¯file_operationsã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œå®ç°ä¸€ä¸ªå­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œå°±æ˜¯å»å®ç°file_operationsã€‚VFS_readæ—¶å°±ä¼šè°ƒç”¨å­—ç¬¦è®¾å¤‡çš„file_operationsã€‚&lt;/p>
&lt;hr>
&lt;p>å—è®¾å¤‡çš„ä¸¤ç§è®¿é—®æ–¹æ³•ï¼Œä¸€æ˜¯è®¿é—®è£¸åˆ†åŒºï¼ŒäºŒæ˜¯è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/p>
&lt;p>å½“ç›´æ¥è®¿é—®è£¸åˆ†åŒºï¼Œæ˜¯é€šè¿‡fs/block_dev.c ä¸­çš„ file_operations def_blk_fopsï¼Œä¹Ÿæœ‰read,write,openï¼Œä¸€åˆ‡ç»§æ‰¿åˆ°file_operationsã€‚å¦‚æœæ˜¯è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œå°±ä¼šé€šè¿‡å®ç° {ext4}_file_operations æ¥å¯¹æ¥VFSå¯¹æ–‡ä»¶çš„æ“ä½œã€‚&lt;/p>
&lt;p>å—è®¾å¤‡é©±åŠ¨å°±ä¸éœ€è¦çŸ¥é“file_operationsï¼Œæ— è®ºæ˜¯è£¸è®¾å¤‡ï¼Œè¿˜æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„fileã€‚ä»–ä»¬å®ç°çš„file_operationsæ˜¯æŠŠlinuxä¸­çš„å„ç§è®¾å¤‡ï¼Œhookè¿› VFSçš„æ–¹æ³•ã€‚&lt;/p>
&lt;h3 id="æ–‡ä»¶æœ€ç»ˆå¦‚ä½•è½¬åŒ–æˆå¯¹ç£ç›˜çš„è®¿é—®">æ–‡ä»¶æœ€ç»ˆå¦‚ä½•è½¬åŒ–æˆå¯¹ç£ç›˜çš„è®¿é—®ï¼Ÿ&lt;/h3>
&lt;p>file_operation è·Ÿpagecache ä»¥åŠç¡¬ç›˜çš„å…³ç³»ï¼Ÿ&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/1072c5381bd5ae4a96ebd0ec110a1a25_1686x1186.png" alt="">&lt;/p>
&lt;p>æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡Œï¼Œé™¤äº†æ”¾æ–‡ä»¶æœ¬èº«çš„æ•°æ®ï¼Œè¿˜åŒ…æ‹¬æ–‡ä»¶çš„ç®¡ç†æ•°æ®ï¼ŒåŒ…æ‹¬&lt;/p>
&lt;ul>
&lt;li>
&lt;p>super blockï¼Œä¿å­˜åœ¨å…¨å±€çš„ superblockç»“æ„ä¸­ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>inodeï¼Œæ˜¯æ–‡ä»¶çš„å”¯ä¸€ç‰¹å®šæ ‡è¯†ï¼Œæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨bitmapæ¥æ ‡è¯†ï¼Œinodeæ˜¯å¦ä½¿ç”¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>block bitmapï¼Œæ¥è¡¨ç¤ºè¿™äº›blockæ˜¯å¦å ç”¨ï¼Œå®ƒåœ¨æ”¹å˜æ–‡ä»¶å¤§å°ï¼Œåˆ›å»ºåˆ é™¤ç­‰æ“ä½œæ—¶ï¼Œéƒ½ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>inode table/diagram ï¼š bitmap åªæ˜¯è¡¨ç¤ºinodeå’Œblockæ˜¯å¦è¢«å ç”¨ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://box.kancloud.cn/f00f3c82d9785e742b49db1975721a00_1666x1202.png" alt="">&lt;/p>
&lt;h3 id="è¶…çº§å—ç›®å½•inode">è¶…çº§å—ã€ç›®å½•ã€inode&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>file_system_type æ•°æ®ç»“æ„ï¼š æŒ‡çš„æ˜¯ æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹ï¼Œmount/umount çš„æ—¶å€™ä¼šç”¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>superblockæ•°æ®ç»“æ„ï¼šåŒ…å«super_operationsï¼Œå…¶ä¸­åŒ…å«å¦‚ä½•åˆ†é…/é”€æ¯ä¸€ä¸ªinodeã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>inode æ•°æ®ç»“æ„ï¼šåŒ…å« inode_operations å’Œ file_operationsã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback"> file_operationsé‡Œé¢è®°å½•è¿™ç§ç±»å‹çš„æ–‡ä»¶ï¼ŒåŒ…å«å“ªäº›æ“ä½œã€‚
inode_operationsé‡Œé¢åŒ…å«å¦‚ä½•ç”Ÿæˆæ–°çš„inodeï¼Œæ ¹æ®æ–‡ä»¶åå­—æ‰¾åˆ°inodeï¼Œå¦‚ä½•mkdir,unlink.
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>dentry æ•°æ®ç»“æ„: å¯¹åº”è·¯å¾„ï¼Œç›®å½•åœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œé¢æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹æ˜¯ä¸€ä¸ªinodeå’Œæ–‡ä»¶çš„è¡¨æ ¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>file æ•°æ®ç»“æ„:&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://box.kancloud.cn/8d9afa6c6797f98151f5f2ef9835d096_796x509.png" alt="">&lt;/p>
&lt;ul>
&lt;li>inodeè¡¨ï¼šåŒ…å«æ–‡ä»¶çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¤§å°ï¼Œåˆ›å»ºæ—¥æœŸï¼Œå±æ€§ã€‚è¿˜æœ‰ä¸€äº›æˆå‘˜æŒ‡å‘ç¡¬ç›˜æ‰€åœ¨çš„ä½ç½®ã€‚&lt;br>
ç”³è¯·slabåŒºåŸŸï¼Œæ¯”å¦‚ ext4_inode_cache , ext3_inode_cache. è¿™äº›cacheä¼šåˆ›å»ºå•ç‹¬çš„slabï¼Œè¿™äº›slabå’Œå†…å­˜é‡Œçš„pageä¸€ä¸€å¯¹åº”ã€‚&lt;/li>
&lt;/ul>
&lt;p>ext2/ext4æ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨é—´æ¥æ˜ å°„è¡¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/aedf91b68e0ddc9140f5cca3a57f162b_1574x1116.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/d2504c197b79aecf377855f29a810ba1_1498x1112.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/8116806badcf819ebf297c067976978c_1596x1094.png" alt="">&lt;/p>
&lt;p>ç¡¬ç›˜é‡Œçš„inode diagramé‡Œçš„æ•°æ®ç»“æ„ï¼Œåœ¨å†…å­˜ä¸­ä¼šé€šè¿‡slabåˆ†é…å™¨ï¼Œç»„ç»‡æˆ xxx_inode_cacheï¼Œå‡ºç°åœ¨meminfoçš„å¯å›æ”¶çš„å†…å­˜ã€‚ inodeè¡¨ä¹Ÿä¼šè®°å½•æ¯ä¸€ä¸ªinode åœ¨ç¡¬ç›˜ä¸­æ‘†æ”¾çš„ä½ç½®ã€‚&lt;/p>
&lt;h3 id="ç›®å½•çš„ç»„ç»‡">ç›®å½•çš„ç»„ç»‡&lt;/h3>
&lt;p>&lt;img src="https://box.kancloud.cn/43f11c7e2cc0fcc45e7891c932f82895_1464x1074.png" alt="">&lt;/p>
&lt;p>ç›®å½•åœ¨ç¡¬ç›˜é‡Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå’Œä¹‹å‰çš„fileç»“æ„ä½“ä¸åŒã€‚ç›®å½•åœ¨ç¡¬ç›˜ä¸­å¯¹åº”ä¸€ä¸ªinodeï¼Œè®°å½•æ–‡ä»¶çš„åå­—å’Œinodeå·ã€‚æŸ¥æ‰¾ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ æ ¹inodeå’Œç›®å½•ï¼Œæ ¹æ®æ ¹ç›®å½•å’Œæ ¹inodeï¼Œæ‰¾åˆ°æ ¹ç›®å½•æ‰€åœ¨ç¡¬ç›˜çš„ä½ç½®ã€‚å†å»åšå­—ç¬¦ä¸²åŒ¹é…ï¼Œèƒ½å¤Ÿæ‰¾åˆ° /A/B/ ã€‚inodeè¡¨ä¹Ÿä¼šè®°å½•æ¯ä¸€ä¸ªinode åœ¨ç¡¬ç›˜ä¸­æ‘†æ”¾çš„ä½ç½®ã€‚&lt;/p>
&lt;h3 id="å‘ç°å¹¶è¯»å–usrbinxxxçš„å…¨æµç¨‹">å‘ç°å¹¶è¯»å–/usr/bin/xxxçš„å…¨æµç¨‹&lt;/h3>
&lt;p>&lt;img src="https://box.kancloud.cn/44f2fbe905a636b07986d3b69f795351_1680x1066.png" alt="">&lt;/p>
&lt;p>å¦‚ä¸Šå›¾ï¼Œå½“ä½ åœ¨ç¡¬ç›˜æŸ¥æ‰¾ /usr/bin/emacsæ–‡ä»¶æ—¶ï¼Œä»æ ¹çš„inodeå’Œdentryï¼Œæ ¹æ®/çš„inodeè¡¨ï¼Œæ‰¾åˆ°/ ç›®å½•æ–‡ä»¶æ‰€åœ¨çš„ç¡¬ç›˜ä¸­çš„ä½ç½®ï¼Œè¯»ç¡¬ç›˜/ç›®å½•æ–‡ä»¶çš„å†…å®¹ï¼Œå‘ç° usr å¯¹åº”inode 2, bin å¯¹åº”inode 3, share å¯¹åº”inode4ã€‚å†å»æŸ¥inodeè¡¨ï¼Œinode 2æ‰€åœ¨ç¡¬ç›˜çš„ä½ç½®ï¼Œå³/usr ç›®å½•æ–‡ä»¶æ‰€åœ¨ç¡¬ç›˜çš„ä½ç½®ã€‚è¯»å‡ºå†…å®¹åŒ…æ‹¬ var å¯¹åº” inode 10, bin å¯¹åº”inode 11, optå¯¹åº”inode 12ï¼Œã€‚&lt;/p>
&lt;p>è¿™ä¸ªè¿‡ç¨‹ä¼šæŸ¥æ‰¾å¾ˆå¤šinodeå’Œ dentryï¼Œè¿™äº›éƒ½ä¼šé€šè¿‡ icache å’Œdcacheç¼“å­˜ã€‚&lt;/p>
&lt;h2 id="ç¬¦å·é“¾æ¥-ä¸-ç¡¬é“¾æ¥">ç¬¦å·é“¾æ¥ ä¸ ç¡¬é“¾æ¥&lt;/h2>
&lt;p>&lt;img src="https://box.kancloud.cn/b52f2fdfec772ded1282a69aa9e56b53_1216x794.png" alt="">&lt;/p>
&lt;p>æ–‡ä»¶åæ˜¯ç‰¹æ®Šç›®å½•æ–‡ä»¶çš„å†…å®¹ï¼Œæ¯”å¦‚ Aç›®å½•ä¸‹æœ‰b\c\dï¼Œå…¶å®å°±æ˜¯ Aè¿™ä¸ªç›®å½•æ–‡ä»¶ï¼Œé‡Œé¢å¯¹åº”ç›®å½•b,c,då’Œå¯¹åº”inodeçš„è¡¨ã€‚&lt;/p>
&lt;p>ç¡¬é“¾æ¥ï¼šåœ¨ç¡¬ç›˜ä¸­æ˜¯åŒä¸€ä¸ªinodeå­˜åœ¨ï¼Œåœ¨ç›®å½•æ–‡ä»¶ä¸­å¤šäº†ä¸€ä¸ªç›®å½•å’Œinodeå¯¹åº”ã€‚&lt;/p>
&lt;p>ç¬¦å·é“¾æ¥ï¼šæ˜¯linuxä¸­æ˜¯çœŸå®å­˜åœ¨çš„å®ä½“æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æŒ‡å‘ å…¶ä»–æ–‡ä»¶ã€‚ç¬¦å·é“¾æ¥å’Œæ–‡ä»¶æ˜¯ä¸åŒçš„inodeã€‚&lt;/p>
&lt;ol>
&lt;li>ç¡¬é“¾æ¥ä¸èƒ½è·¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ&lt;/li>
&lt;li>ç¡¬é“¾æ¥ä¸èƒ½é’ˆå¯¹ç›®å½•&lt;/li>
&lt;li>é’ˆå¯¹ç›®å½•çš„è½¯é“¾æ¥ï¼Œç”¨rm -fr åˆ é™¤ä¸äº†ç›®å½•é‡Œçš„å†…å®¹&lt;/li>
&lt;li>é’ˆå¯¹ç›®å½•çš„è½¯é“¾æ¥ï¼Œ&amp;ldquo;cd ..&amp;ldquo;è¿›çš„æ˜¯è½¯é“¾æ¥æ‰€åœ¨ç›®å½•çš„ä¸Šçº§ç›®å½•&lt;/li>
&lt;li>å¯ä»¥å¯¹æ–‡ä»¶æ‰§è¡Œunlinkæˆ–rmï¼Œä½†æ˜¯ä¸èƒ½å¯¹ç›®å½•æ‰§è¡Œunlink&lt;/li>
&lt;/ol>
&lt;h2 id="æ–‡ä»¶ç³»ç»Ÿä¸­çš„icache-å’Œ-dcache">æ–‡ä»¶ç³»ç»Ÿä¸­çš„icache å’Œ dcache&lt;/h2>
&lt;p>&lt;img src="https://box.kancloud.cn/4200715ec3487a8ffb56d2281824275b_1204x806.png" alt="">&lt;/p>
&lt;p>æ–‡ä»¶ç³»ç»Ÿåœ¨å®ç°æ—¶ï¼Œåœ¨vfsè¿™ä¸€å±‚çš„ inode cache å’Œ dentry cacheï¼Œä¸ç®¡ç¡¬ç›˜çš„ç³»ç»Ÿï¼Œè·¨æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„é€šç”¨ä¿¡æ¯ã€‚&lt;/p>
&lt;p>é’ˆå¯¹è¿™äº›cacheï¼Œè¿™äº›å¯ä»¥å›æ”¶çš„slabï¼Œlinuxæä¾›äº†ä¸“é—¨çš„slab shrink- æ”¶ç¼©å‡½æ•°ã€‚&lt;br>
æœ€åæ‰€æœ‰å¯å›æ”¶çš„å†…å­˜ï¼Œéƒ½å¿…é¡»é€šè¿‡&lt;code>LRUç®—æ³•&lt;/code>å»å›æ”¶ã€‚&lt;br>
æœ‰äº›è‡ªå·±ç”³è¯·çš„ reclaimçš„å†…å­˜ï¼Œç”±äºæ²¡æœ‰å†™ shrinkå‡½æ•°ï¼Œæ‰€ä»¥å°±æ— æ³•è¿›è¡Œå†…å­˜çš„å›æ”¶ã€‚&lt;/p>
&lt;h2 id="æ–‡ä»¶è¯»å†™å¦‚ä½•é€šè¿‡file_operation-å’Œpagecacheçš„å…³ç³»">æ–‡ä»¶è¯»å†™å¦‚ä½•é€šè¿‡file_operation å’Œpagecacheçš„å…³ç³»ï¼Œ&lt;/h2>
&lt;p>&lt;img src="https://box.kancloud.cn/71ce1fb31cdeed119f972c8b1771972c_1524x1100.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/6ed93b05cf6600220d744a0dcae115f9_1126x724.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://box.kancloud.cn/bdbb3ff0a3278c93493379a0f6076fc8_1202x730.png" alt="">&lt;/p>
&lt;h2 id="heading">&lt;/h2></description></item><item><title>Linux ç½‘ç»œåŒ…å‘é€è¿‡ç¨‹(è½¬)</title><link>https://justice.bj.cn/post/21.linux/linux-%E7%BD%91%E7%BB%9C%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E5%9B%BE%E8%A7%A3/</link><pubDate>Sat, 04 Jun 2022 10:26:13 +0800</pubDate><guid>https://justice.bj.cn/post/21.linux/linux-%E7%BD%91%E7%BB%9C%E5%8F%91%E5%8C%85%E8%BF%87%E7%A8%8B%E5%9B%BE%E8%A7%A3/</guid><description>&lt;h1 id="linux-ç½‘ç»œåŒ…å‘é€è¿‡ç¨‹è½¬">Linux ç½‘ç»œåŒ…å‘é€è¿‡ç¨‹(è½¬)&lt;/h1>
&lt;p>åœ¨å¼€å§‹ä»Šå¤©çš„æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å…ˆæ¥è¯·å¤§å®¶æ€è€ƒå‡ ä¸ªå°é—®é¢˜ã€‚&lt;/p>
&lt;ul>
&lt;li>é—®1ï¼šæˆ‘ä»¬åœ¨æŸ¥çœ‹å†…æ ¸å‘é€æ•°æ®æ¶ˆè€—çš„ CPU æ—¶ï¼Œæ˜¯åº”è¯¥çœ‹ sy è¿˜æ˜¯ si ï¼Ÿ&lt;/li>
&lt;li>é—®2ï¼šä¸ºä»€ä¹ˆä½ æœåŠ¡å™¨ä¸Šçš„ /proc/softirqs é‡Œ NET_RX è¦æ¯” NET_TX å¤§çš„å¤šçš„å¤šï¼Ÿ&lt;/li>
&lt;li>é—®3ï¼šå‘é€ç½‘ç»œæ•°æ®çš„æ—¶å€™éƒ½æ¶‰åŠåˆ°å“ªäº›å†…å­˜æ‹·è´æ“ä½œï¼Ÿ&lt;/li>
&lt;/ul>
&lt;p>è¿™äº›é—®é¢˜è™½ç„¶åœ¨çº¿ä¸Šç»å¸¸çœ‹åˆ°ï¼Œä½†æˆ‘ä»¬ä¼¼ä¹å¾ˆå°‘å»æ·±ç©¶ã€‚å¦‚æœçœŸçš„èƒ½é€å½»åœ°æŠŠè¿™äº›é—®é¢˜ç†è§£åˆ°ä½ï¼Œæˆ‘ä»¬å¯¹æ€§èƒ½çš„æŒæ§èƒ½åŠ›å°†ä¼šå˜å¾—æ›´å¼ºã€‚&lt;/p>
&lt;p>å¸¦ç€è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©å¯¹ Linux å†…æ ¸ç½‘ç»œå‘é€è¿‡ç¨‹çš„æ·±åº¦å‰–æã€‚è¿˜æ˜¯æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„ä¼ ç»Ÿï¼Œå…ˆä»ä¸€æ®µç®€å•çš„ä»£ç ä½œä¸ºåˆ‡å…¥ã€‚å¦‚ä¸‹ä»£ç æ˜¯ä¸€ä¸ªå…¸å‹æœåŠ¡å™¨ç¨‹åºçš„å…¸å‹çš„ç¼©å¾®ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;span class="n">fd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AF_INET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SOCK_STREAM&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...);&lt;/span>
&lt;span class="n">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...);&lt;/span>
&lt;span class="n">cfd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">accept&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...);&lt;/span>
&lt;span class="c1">// æ¥æ”¶ç”¨æˆ·è¯·æ±‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...);&lt;/span>
&lt;span class="c1">// ç”¨æˆ·è¯·æ±‚å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">dosometing&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// ç»™ç”¨æˆ·è¿”å›ç»“æœ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»Šå¤©æˆ‘ä»¬æ¥è®¨è®ºä¸Šè¿°ä»£ç ä¸­ï¼Œè°ƒç”¨ send ä¹‹åå†…æ ¸æ˜¯æ€ä¹ˆæ ·æŠŠæ•°æ®åŒ…å‘é€å‡ºå»çš„ã€‚æœ¬æ–‡åŸºäºLinux 3.10ï¼Œç½‘å¡é©±åŠ¨é‡‡ç”¨Intelçš„igbç½‘å¡ä¸¾ä¾‹ã€‚&lt;/p>
&lt;h2 id="linux-ç½‘ç»œå‘é€è¿‡ç¨‹æ€»è§ˆ">Linux ç½‘ç»œå‘é€è¿‡ç¨‹æ€»è§ˆ&lt;/h2>
&lt;p>é£å“¥è§‰å¾—çœ‹ Linux æºç æœ€é‡è¦çš„æ˜¯å¾—æœ‰æ•´ä½“ä¸Šçš„æŠŠæ¡ï¼Œè€Œä¸æ˜¯ä¸€å¼€å§‹å°±é™·å…¥å„ç§ç»†èŠ‚ã€‚&lt;/p>
&lt;p>æˆ‘è¿™é‡Œå…ˆç»™å¤§å®¶å‡†å¤‡äº†ä¸€ä¸ªæ€»çš„æµç¨‹å›¾ï¼Œç®€å•é˜è¿°ä¸‹ send å‘é€äº†çš„æ•°æ®æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥è¢«å‘é€åˆ°ç½‘å¡çš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-18543fabe38c2eddcb2f0eba9e0e79f4_720w.jpg" alt="">&lt;/p>
&lt;p>åœ¨è¿™å¹…å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç”¨æˆ·æ•°æ®è¢«æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç„¶åç»è¿‡åè®®æ ˆå¤„ç†åè¿›å…¥åˆ°äº† RingBuffer ä¸­ã€‚éšåç½‘å¡é©±åŠ¨çœŸæ­£å°†æ•°æ®å‘é€äº†å‡ºå»ã€‚å½“å‘é€å®Œæˆçš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡ç¡¬ä¸­æ–­æ¥é€šçŸ¥ CPUï¼Œç„¶åæ¸…ç† RingBufferã€‚&lt;/p>
&lt;p>å› ä¸ºæ–‡ç« åé¢è¦è¿›å…¥æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬å†ä»æºç çš„è§’åº¦ç»™å‡ºä¸€ä¸ªæµç¨‹å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-b511a062c2803ecfc6931bfdcf3f2b51_720w.jpg" alt="">&lt;/p>
&lt;p>è™½ç„¶æ•°æ®è¿™æ—¶å·²ç»å‘é€å®Œæ¯•ï¼Œä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ä»¶é‡è¦çš„äº‹æƒ…æ²¡æœ‰åšï¼Œé‚£å°±æ˜¯é‡Šæ”¾ç¼“å­˜é˜Ÿåˆ—ç­‰å†…å­˜ã€‚&lt;/p>
&lt;p>é‚£å†…æ ¸æ˜¯å¦‚ä½•çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰èƒ½é‡Šæ”¾å†…å­˜çš„å‘¢ï¼Œå½“ç„¶æ˜¯ç­‰ç½‘ç»œå‘é€å®Œæ¯•ä¹‹åã€‚ç½‘å¡åœ¨å‘é€å®Œæ¯•çš„æ—¶å€™ï¼Œä¼šç»™ CPU å‘é€ä¸€ä¸ªç¡¬ä¸­æ–­æ¥é€šçŸ¥ CPUã€‚æ›´å®Œæ•´çš„æµç¨‹çœ‹å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://pic3.zhimg.com/80/v2-4040c1e92f7b492c522848b786285e96_720w.jpg" alt="">&lt;/p>
&lt;p>æ³¨æ„ï¼Œæˆ‘ä»¬ä»Šå¤©çš„ä¸»é¢˜è™½ç„¶æ˜¯å‘é€æ•°æ®ï¼Œä½†æ˜¯ç¡¬ä¸­æ–­æœ€ç»ˆè§¦å‘çš„è½¯ä¸­æ–­å´æ˜¯ NET_RX_SOFTIRQï¼Œè€Œå¹¶ä¸æ˜¯ NET_TX_SOFTIRQ ï¼ï¼ï¼ï¼ˆT æ˜¯ transmit çš„ç¼©å†™ï¼ŒR è¡¨ç¤º receiveï¼‰&lt;/p>
&lt;p>&lt;strong>æ„ä¸æ„å¤–ï¼ŒæƒŠä¸æƒŠå–œï¼Ÿï¼Ÿï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>æ‰€ä»¥è¿™å°±æ˜¯å¼€ç¯‡é—®é¢˜ 1 çš„ä¸€éƒ¨åˆ†çš„åŸå› ï¼ˆæ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€éƒ¨åˆ†åŸå› ï¼‰ã€‚&lt;/p>
&lt;blockquote>
&lt;p>é—®1ï¼šåœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ /proc/softirqsï¼Œä¸ºä»€ä¹ˆ NET_RX è¦æ¯” NET_TX å¤§çš„å¤šçš„å¤šï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>ä¼ è¾“å®Œæˆæœ€ç»ˆä¼šè§¦å‘ NET_RXï¼Œè€Œä¸æ˜¯ NET_TXã€‚ æ‰€ä»¥è‡ªç„¶ä½ è§‚æµ‹ /proc/softirqs ä¹Ÿå°±èƒ½çœ‹åˆ° NET_RX æ›´å¤šäº†ã€‚&lt;/p>
&lt;p>å¥½ï¼Œç°åœ¨ä½ å·²ç»å¯¹å†…æ ¸æ˜¯æ€ä¹ˆå‘é€ç½‘ç»œåŒ…çš„æœ‰ä¸€ä¸ªå…¨å±€ä¸Šçš„æŠŠæ¡äº†ã€‚ä¸è¦å¾—æ„ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£çš„ç»†èŠ‚æ‰æ˜¯æ›´æœ‰ä»·å€¼çš„åœ°æ–¹ï¼Œè®©æˆ‘ä»¬ç»§ç»­ï¼ï¼&lt;/p>
&lt;p>&amp;mdash; è¿™é‡Œæ’å…¥ä¸€ä»½ç”µå­ä¹¦èµ„æ–™&lt;/p>
&lt;p>é£å“¥ç»å¸¸ä¼šæ”¶åˆ°è¯»è€…çš„ç§ä¿¡ï¼Œè¯¢é—®å¯å¦æ¨èä¸€äº›ä¹¦ç»§ç»­æ·±å…¥å­¦ä¹ å†…åŠŸã€‚æ‰€ä»¥æˆ‘å¹²è„†å°±å†™äº†ç¯‡æ–‡ç« ã€‚æŠŠèƒ½æœé›†åˆ°çš„ç”µå­ç‰ˆä¹Ÿå¸®å¤§å®¶æ±‡æ€»äº†ä¸€ä¸‹ï¼Œå–éœ€ï¼&lt;/p>
&lt;p>&lt;strong>&lt;a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/BZv4WpKLB38KsACpJ9csNQ">ç­”è¯»è€…é—®ï¼Œèƒ½å¦æ¨èå‡ æœ¬æœ‰ä»·å€¼çš„å‚è€ƒä¹¦(å«ä¸‹è½½åœ°å€)&lt;/a>&lt;/strong>&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-1fad277dcd9842c3db483dbb7a3fbfe9_720w.jpg" alt="">&lt;/p>
&lt;p>èµ„æ–™æ’æ’­å®Œæ¯•ï¼Œè¿™å›çœŸçš„ç»§ç»­ï¼ï¼&lt;/p>
&lt;h2 id="äºŒç½‘å¡å¯åŠ¨å‡†å¤‡">&lt;strong>äºŒã€ç½‘å¡å¯åŠ¨å‡†å¤‡&lt;/strong>&lt;/h2>
&lt;p>ç°åœ¨çš„æœåŠ¡å™¨ä¸Šçš„ç½‘å¡ä¸€èˆ¬éƒ½æ˜¯æ”¯æŒå¤šé˜Ÿåˆ—çš„ã€‚æ¯ä¸€ä¸ªé˜Ÿåˆ—ä¸Šéƒ½æ˜¯ç”±ä¸€ä¸ª RingBuffer è¡¨ç¤ºçš„ï¼Œå¼€å¯äº†å¤šé˜Ÿåˆ—ä»¥åçš„çš„ç½‘å¡å°±ä¼šå¯¹åº”æœ‰å¤šä¸ª RingBufferã€‚&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-ce24c3abe8e58f9fd4d269bd64291347_720w.jpg" alt="">&lt;/p>
&lt;p>ç½‘å¡åœ¨å¯åŠ¨æ—¶æœ€é‡è¦çš„ä»»åŠ¡ä¹‹ä¸€å°±æ˜¯åˆ†é…å’Œåˆå§‹åŒ– RingBufferï¼Œç†è§£äº† RingBuffer å°†ä¼šéå¸¸æœ‰åŠ©äºåé¢æˆ‘ä»¬æŒæ¡å‘é€ã€‚å› ä¸ºä»Šå¤©çš„ä¸»é¢˜æ˜¯å‘é€ï¼Œæ‰€ä»¥å°±ä»¥ä¼ è¾“é˜Ÿåˆ—ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ç½‘å¡å¯åŠ¨æ—¶åˆ†é… RingBuffer çš„å®é™…è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>åœ¨ç½‘å¡å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ° __igb_open å‡½æ•°ï¼ŒRingBuffer å°±æ˜¯åœ¨è¿™é‡Œåˆ†é…çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">__igb_open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">netdev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="n">resuming&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_adapter&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">adapter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">netdev_priv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">netdev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//åˆ†é…ä¼ è¾“æè¿°ç¬¦æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">igb_setup_all_tx_resources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">adapter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//åˆ†é…æ¥æ”¶æè¿°ç¬¦æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">igb_setup_all_rx_resources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">adapter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//å¼€å¯å…¨éƒ¨é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">netif_tx_start_all_queues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">netdev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä¸Šé¢ __igb_open å‡½æ•°è°ƒç”¨ igb_setup_all_tx_resources åˆ†é…æ‰€æœ‰çš„ä¼ è¾“ RingBuffer, è°ƒç”¨ igb_setup_all_rx_resources åˆ›å»ºæ‰€æœ‰çš„æ¥æ”¶ RingBufferã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">igb_setup_all_tx_resources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_adapter&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">adapter&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//æœ‰å‡ ä¸ªé˜Ÿåˆ—å°±æ„é€ å‡ ä¸ª RingBuffer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">adapter&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">num_tx_queues&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">igb_setup_tx_resources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">adapter&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çœŸæ­£çš„ RingBuffer æ„é€ è¿‡ç¨‹æ˜¯åœ¨ igb_setup_tx_resources ä¸­å®Œæˆçš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">igb_setup_tx_resources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_ring&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//1.ç”³è¯· igb_tx_buffer æ•°ç»„å†…å­˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_tx_buffer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tx_buffer_info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">vzalloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//2.ç”³è¯· e1000_adv_tx_desc DMA æ•°ç»„å†…å­˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">union&lt;/span> &lt;span class="n">e1000_adv_tx_desc&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ALIGN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4096&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">desc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dma_alloc_coherent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dma&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">GFP_KERNEL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//3.åˆå§‹åŒ–é˜Ÿåˆ—æˆå‘˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next_to_use&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next_to_clean&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šä¸€ä¸ª RingBuffer çš„å†…éƒ¨ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç¯å½¢é˜Ÿåˆ—æ•°ç»„ï¼Œè€Œæ˜¯æœ‰ä¸¤ä¸ªã€‚&lt;/p>
&lt;p>1ï¼‰igb_tx_buffer æ•°ç»„ï¼šè¿™ä¸ªæ•°ç»„æ˜¯å†…æ ¸ä½¿ç”¨çš„ï¼Œé€šè¿‡ vzalloc ç”³è¯·çš„ã€‚&lt;br>
2ï¼‰e1000_adv_tx_desc æ•°ç»„ï¼šè¿™ä¸ªæ•°ç»„æ˜¯ç½‘å¡ç¡¬ä»¶ä½¿ç”¨çš„ï¼Œç¡¬ä»¶æ˜¯å¯ä»¥é€šè¿‡ DMA ç›´æ¥è®¿é—®è¿™å—å†…å­˜ï¼Œé€šè¿‡ dma_alloc_coherent åˆ†é…ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ—¶å€™å®ƒä»¬ä¹‹é—´è¿˜æ²¡æœ‰å•¥è”ç³»ã€‚å°†æ¥åœ¨å‘é€çš„æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªç¯å½¢æ•°ç»„ä¸­ç›¸åŒä½ç½®çš„æŒ‡é’ˆå°†éƒ½å°†æŒ‡å‘åŒä¸€ä¸ª skbã€‚è¿™æ ·ï¼Œå†…æ ¸å’Œç¡¬ä»¶å°±èƒ½å…±åŒè®¿é—®åŒæ ·çš„æ•°æ®äº†ï¼Œå†…æ ¸å¾€ skb é‡Œå†™æ•°æ®ï¼Œç½‘å¡ç¡¬ä»¶è´Ÿè´£å‘é€ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-3385217f1469def5689fc0057739df64_720w.jpg" alt="">&lt;/p>
&lt;p>æœ€åè°ƒç”¨ netif_tx_start_all_queues å¼€å¯é˜Ÿåˆ—ã€‚å¦å¤–ï¼Œå¯¹äºç¡¬ä¸­æ–­çš„å¤„ç†å‡½æ•° igb_msix_ring å…¶å®ä¹Ÿæ˜¯åœ¨ __igb_open ä¸­æ³¨å†Œçš„ã€‚&lt;/p>
&lt;h2 id="ä¸‰accept-åˆ›å»ºæ–°-socket">&lt;strong>ä¸‰ã€accept åˆ›å»ºæ–° socket&lt;/strong>&lt;/h2>
&lt;p>åœ¨å‘é€æ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬å¾€å¾€è¿˜éœ€è¦ä¸€ä¸ªå·²ç»å»ºç«‹å¥½è¿æ¥çš„ socketã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å°±ä»¥å¼€ç¯‡æœåŠ¡å™¨ç¼©å¾®æºä»£ç ä¸­æåˆ°çš„ accept ä¸ºä¾‹ï¼Œå½“ accept ä¹‹åï¼Œè¿›ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ socket å‡ºæ¥ï¼Œç„¶åæŠŠå®ƒæ”¾åˆ°å½“å‰è¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶åˆ—è¡¨ä¸­ï¼Œä¸“é—¨ç”¨äºå’Œå¯¹åº”çš„å®¢æˆ·ç«¯é€šä¿¡ã€‚&lt;/p>
&lt;p>å‡è®¾æœåŠ¡å™¨è¿›ç¨‹é€šè¿‡ accept å’Œå®¢æˆ·ç«¯å»ºç«‹äº†ä¸¤æ¡è¿æ¥ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤æ¡è¿æ¥å’Œè¿›ç¨‹çš„å…³è”å…³ç³»ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-52d6007054ead81044fef43870b3cadb_720w.jpg" alt="">&lt;/p>
&lt;p>å…¶ä¸­ä»£è¡¨ä¸€æ¡è¿æ¥çš„ socket å†…æ ¸å¯¹è±¡æ›´ä¸ºå…·ä½“ä¸€ç‚¹çš„ç»“æ„å›¾å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-c2bdf3847e53d464b53478491968f6ff_720w.jpg" alt="">&lt;/p>
&lt;p>ä¸ºäº†é¿å…å–§å®¾å¤ºä¸»ï¼Œaccept è¯¦ç»†çš„æºç è¿‡ç¨‹è¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£è¯·å‚è€ƒÂ &lt;strong>&lt;a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/OmRdUgO1guMX76EdZn11UQ">ã€Šå›¾è§£ | æ·±å…¥æ­ç§˜ epoll æ˜¯å¦‚ä½•å®ç° IO å¤šè·¯å¤ç”¨çš„ï¼ã€‹&lt;/a>&lt;/strong>ã€‚ä¸€æ–‡ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>ä»Šå¤©æˆ‘ä»¬è¿˜æ˜¯æŠŠé‡ç‚¹æ”¾åˆ°æ•°æ®å‘é€è¿‡ç¨‹ä¸Šã€‚&lt;/p>
&lt;h2 id="å››å‘é€æ•°æ®çœŸæ­£å¼€å§‹">&lt;strong>å››ã€å‘é€æ•°æ®çœŸæ­£å¼€å§‹&lt;/strong>&lt;/h2>
&lt;h3 id="41-send-ç³»ç»Ÿè°ƒç”¨å®ç°">&lt;strong>4.1 send ç³»ç»Ÿè°ƒç”¨å®ç°&lt;/strong>&lt;/h3>
&lt;p>send ç³»ç»Ÿè°ƒç”¨çš„æºç ä½äºæ–‡ä»¶ net/socket.c ä¸­ã€‚åœ¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨é‡Œï¼Œå†…éƒ¨å…¶å®çœŸæ­£ä½¿ç”¨çš„æ˜¯ sendto ç³»ç»Ÿè°ƒç”¨ã€‚æ•´ä¸ªè°ƒç”¨é“¾æ¡è™½ç„¶ä¸çŸ­ï¼Œä½†å…¶å®ä¸»è¦åªå¹²äº†ä¸¤ä»¶ç®€å•çš„äº‹æƒ…ï¼Œ&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€æ˜¯åœ¨å†…æ ¸ä¸­æŠŠçœŸæ­£çš„ socket æ‰¾å‡ºæ¥ï¼Œåœ¨è¿™ä¸ªå¯¹è±¡é‡Œè®°å½•ç€å„ç§åè®®æ ˆçš„å‡½æ•°åœ°å€ã€‚&lt;/li>
&lt;li>ç¬¬äºŒæ˜¯æ„é€ ä¸€ä¸ª struct msghdr å¯¹è±¡ï¼ŒæŠŠç”¨æˆ·ä¼ å…¥çš„æ•°æ®ï¼Œæ¯”å¦‚ bufferåœ°å€ã€æ•°æ®é•¿åº¦å•¥çš„ï¼Œç»Ÿç»Ÿéƒ½è£…è¿›å».&lt;/li>
&lt;/ul>
&lt;p>å‰©ä¸‹çš„äº‹æƒ…å°±äº¤ç»™ä¸‹ä¸€å±‚ï¼Œåè®®æ ˆé‡Œçš„å‡½æ•° inet_sendmsg äº†ï¼Œå…¶ä¸­ inet_sendmsg å‡½æ•°çš„åœ°å€æ˜¯é€šè¿‡ socket å†…æ ¸å¯¹è±¡é‡Œçš„ ops æˆå‘˜æ‰¾åˆ°çš„ã€‚å¤§è‡´æµç¨‹å¦‚å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-33dbbf07ba4846e60c8edb671d00c07f_720w.jpg" alt="">&lt;/p>
&lt;p>æœ‰äº†ä¸Šé¢çš„äº†è§£ï¼Œæˆ‘ä»¬å†çœ‹èµ·æºç å°±è¦å®¹æ˜“è®¸å¤šäº†ã€‚æºç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/socket.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">SYSCALL_DEFINE4&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="n">__user&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buff&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">sys_sendto&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buff&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">SYSCALL_DEFINE6&lt;/span>&lt;span class="p">(......)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//1.æ ¹æ® fd æŸ¥æ‰¾åˆ° socket
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">sock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sockfd_lookup_light&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">fput_needed&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//2.æ„é€  msghdr
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">msghdr&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">iovec&lt;/span> &lt;span class="n">iov&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">iov&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">iov_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">iov&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">iov_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">msg_iovlen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">msg_iov&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">iov&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">msg_flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="c1">//3.å‘é€æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">sock_sendmsg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»æºç å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·æ€ä½¿ç”¨çš„ send å‡½æ•°å’Œ sendto å‡½æ•°å…¶å®éƒ½æ˜¯ sendto ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚send åªæ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œå°è£…å‡ºæ¥çš„ä¸€ä¸ªæ›´æ˜“äºè°ƒç”¨çš„æ–¹å¼è€Œå·²ã€‚&lt;/p>
&lt;p>åœ¨ sendto ç³»ç»Ÿè°ƒç”¨é‡Œï¼Œé¦–å…ˆæ ¹æ®ç”¨æˆ·ä¼ è¿›æ¥çš„ socket å¥æŸ„å·æ¥æŸ¥æ‰¾çœŸæ­£çš„ socket å†…æ ¸å¯¹è±¡ã€‚æ¥ç€æŠŠç”¨æˆ·è¯·æ±‚çš„ buffã€lenã€flag ç­‰å‚æ•°éƒ½ç»Ÿç»Ÿæ‰“åŒ…åˆ°ä¸€ä¸ª struct msghdr å¯¹è±¡ä¸­ã€‚&lt;/p>
&lt;p>æ¥ç€è°ƒç”¨äº† sock_sendmsg =&amp;gt; __sock_sendmsg ==&amp;gt; __sock_sendmsg_nosecã€‚åœ¨__sock_sendmsg_nosec ä¸­ï¼Œè°ƒç”¨å°†ä¼šç”±ç³»ç»Ÿè°ƒç”¨è¿›å…¥åˆ°åè®®æ ˆï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒçš„æºç ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/socket.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">__sock_sendmsg_nosec&lt;/span>&lt;span class="p">(...)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">sock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ops&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sendmsg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">iocb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡ç¬¬ä¸‰èŠ‚é‡Œçš„ socket å†…æ ¸å¯¹è±¡ç»“æ„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ sock-&amp;gt;ops-&amp;gt;sendmsg å®é™…æ‰§è¡Œçš„æ˜¯ inet_sendmsgã€‚è¿™ä¸ªå‡½æ•°æ˜¯ AF_INET åè®®æ—æä¾›çš„é€šç”¨å‘é€å‡½æ•°ã€‚&lt;/p>
&lt;h3 id="42-ä¼ è¾“å±‚å¤„ç†">&lt;strong>4.2 ä¼ è¾“å±‚å¤„ç†&lt;/strong>&lt;/h3>
&lt;h3 id="1ä¼ è¾“å±‚æ‹·è´">&lt;strong>1ï¼‰ä¼ è¾“å±‚æ‹·è´&lt;/strong>&lt;/h3>
&lt;p>åœ¨è¿›å…¥åˆ°åè®®æ ˆ inet_sendmsg ä»¥åï¼Œå†…æ ¸æ¥ç€ä¼šæ‰¾åˆ° socket ä¸Šçš„å…·ä½“åè®®å‘é€å‡½æ•°ã€‚å¯¹äº TCP åè®®æ¥è¯´ï¼Œé‚£å°±æ˜¯ tcp_sendmsgï¼ˆåŒæ ·ä¹Ÿæ˜¯é€šè¿‡ socket å†…æ ¸å¯¹è±¡æ‰¾åˆ°çš„ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå†…æ ¸ä¼šç”³è¯·ä¸€ä¸ªå†…æ ¸æ€çš„ skb å†…å­˜ï¼Œå°†ç”¨æˆ·å¾…å‘é€çš„æ•°æ®æ‹·è´è¿›å»ã€‚æ³¨æ„è¿™ä¸ªæ—¶å€™ä¸ä¸€å®šä¼šçœŸæ­£å¼€å§‹å‘é€ï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ°å‘é€æ¡ä»¶çš„è¯å¾ˆå¯èƒ½è¿™æ¬¡è°ƒç”¨ç›´æ¥å°±è¿”å›äº†ã€‚å¤§æ¦‚è¿‡ç¨‹å¦‚å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-ffad55e8c65199c7c6604bd394088e41_720w.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ inet_sendmsg å‡½æ•°çš„æºç ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/af_inet.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">inet_sendmsg&lt;/span>&lt;span class="p">(......)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">sk&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sk_prot&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sendmsg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">iocb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°å…·ä½“åè®®çš„å‘é€å‡½æ•°ã€‚åŒæ ·å‚è€ƒç¬¬ä¸‰èŠ‚é‡Œçš„ socket å†…æ ¸å¯¹è±¡ç»“æ„å›¾ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯¹äº TCP åè®®ä¸‹çš„ socket æ¥è¯´ï¼Œæ¥è¯´ sk-&amp;gt;sk_prot-&amp;gt;sendmsg æŒ‡å‘çš„æ˜¯ tcp_sendmsgï¼ˆå¯¹äº UPD æ¥è¯´æ˜¯ udp_sendmsgï¼‰ã€‚&lt;/p>
&lt;p>tcp_sendmsg è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†å¤šæ¬¡æ¥çœ‹å®ƒã€‚ å…ˆçœ‹è¿™ä¸€æ®µ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/tcp.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">tcp_sendmsg&lt;/span>&lt;span class="p">(...)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(...){&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(...){&lt;/span>
&lt;span class="c1">//è·å–å‘é€é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tcp_write_queue_tail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//ç”³è¯·skb å¹¶æ‹·è´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//file: include/net/tcp.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">tcp_write_queue_tail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">skb_peek_tail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sk_write_queue&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç†è§£å¯¹ socket è°ƒç”¨ tcp_write_queue_tail æ˜¯ç†è§£å‘é€çš„å‰æã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨è·å– socket å‘é€é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ª skbã€‚ skb æ˜¯ struct sk_buff å¯¹è±¡çš„ç®€ç§°ï¼Œç”¨æˆ·çš„å‘é€é˜Ÿåˆ—å°±æ˜¯è¯¥å¯¹è±¡ç»„æˆçš„ä¸€ä¸ªé“¾è¡¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-bb693e4a2fdae5870609d9b76133c0ad_720w.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬å†æ¥ç€çœ‹ tcp_sendmsg çš„å…¶å®ƒéƒ¨åˆ†ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/tcp.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">tcp_sendmsg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">kiocb&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">iocb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">msghdr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//è·å–ç”¨æˆ·ä¼ é€’è¿‡æ¥çš„æ•°æ®å’Œæ ‡å¿—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">iov&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">msg_iov&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//ç”¨æˆ·æ•°æ®åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">iovlen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">msg_iovlen&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//æ•°æ®å—æ•°ä¸º1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">msg_flags&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//å„ç§æ ‡å¿—
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">//éå†ç”¨æˆ·å±‚çš„æ•°æ®å—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">iovlen&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¾…å‘é€æ•°æ®å—çš„åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">__user&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">from&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iov&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">iov_base&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">seglen&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//éœ€è¦ç”³è¯·æ–°çš„ skb
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">copy&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//ç”³è¯· skbï¼Œå¹¶æ·»åŠ åˆ°å‘é€é˜Ÿåˆ—çš„å°¾éƒ¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sk_stream_alloc_skb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">select_size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sg&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="n">sk&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sk_allocation&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//æŠŠ skb æŒ‚åˆ°socketçš„å‘é€é˜Ÿåˆ—ä¸Š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb_entail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// skb ä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">skb_availroom&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ‹·è´ç”¨æˆ·ç©ºé—´çš„æ•°æ®åˆ°å†…æ ¸ç©ºé—´ï¼ŒåŒæ—¶è®¡ç®—æ ¡éªŒå’Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//fromæ˜¯ç”¨æˆ·ç©ºé—´çš„æ•°æ®åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb_add_data_nocache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">from&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">copy&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œä¸è¿‡å…¶å®é€»è¾‘å¹¶ä¸å¤æ‚ã€‚å…¶ä¸­ msg-&amp;gt;msg_iov å­˜å‚¨çš„æ˜¯ç”¨æˆ·æ€å†…å­˜çš„è¦å‘é€çš„æ•°æ®çš„ bufferã€‚æ¥ä¸‹æ¥åœ¨å†…æ ¸æ€ç”³è¯·å†…æ ¸å†…å­˜ï¼Œæ¯”å¦‚ skbï¼Œå¹¶æŠŠç”¨æˆ·å†…å­˜é‡Œçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸æ€å†…å­˜ä¸­ã€‚&lt;strong>è¿™å°±ä¼šæ¶‰åŠåˆ°ä¸€æ¬¡æˆ–è€…å‡ æ¬¡å†…å­˜æ‹·è´çš„å¼€é”€&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic3.zhimg.com/80/v2-cbd951cef795058fe8379ac46765d172_720w.jpg" alt="">&lt;/p>
&lt;p>è‡³äºå†…æ ¸ä»€ä¹ˆæ—¶å€™çœŸæ­£æŠŠ skb å‘é€å‡ºå»ã€‚åœ¨ tcp_sendmsg ä¸­ä¼šè¿›è¡Œä¸€äº›åˆ¤æ–­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">//file: net/ipv4/tcp.c
int tcp_sendmsg(...)
{
while(...){
while(...){
//ç”³è¯·å†…æ ¸å†…å­˜å¹¶è¿›è¡Œæ‹·è´
//å‘é€åˆ¤æ–­
if (forced_push(tp)) {
tcp_mark_push(tp, skb);
__tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH);
} else if (skb == tcp_send_head(sk))
tcp_push_one(sk, mss_now);
}
continue;
}
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åªæœ‰æ»¡è¶³ forced_push(tp) æˆ–è€… skb == tcp_send_head(sk) æˆç«‹çš„æ—¶å€™ï¼Œå†…æ ¸æ‰ä¼šçœŸæ­£å¯åŠ¨å‘é€æ•°æ®åŒ…ã€‚å…¶ä¸­ forced_push(tp) åˆ¤æ–­çš„æ˜¯æœªå‘é€çš„æ•°æ®æ•°æ®æ˜¯å¦å·²ç»è¶…è¿‡æœ€å¤§çª—å£çš„ä¸€åŠäº†ã€‚&lt;/p>
&lt;p>æ¡ä»¶éƒ½ä¸æ»¡è¶³çš„è¯ï¼Œ&lt;strong>è¿™æ¬¡çš„ç”¨æˆ·è¦å‘é€çš„æ•°æ®åªæ˜¯æ‹·è´åˆ°å†…æ ¸å°±ç®—å®Œäº‹äº†ï¼&lt;/strong>&lt;/p>
&lt;h3 id="2ä¼ è¾“å±‚å‘é€">&lt;strong>2ï¼‰ä¼ è¾“å±‚å‘é€&lt;/strong>&lt;/h3>
&lt;p>å‡è®¾ç°åœ¨å†…æ ¸å‘é€æ¡ä»¶å·²ç»æ»¡è¶³äº†ï¼Œæˆ‘ä»¬å†æ¥è·Ÿè¸ªä¸€ä¸‹å®é™…çš„å‘é€è¿‡ç¨‹ã€‚ å¯¹äºä¸Šå°èŠ‚å‡½æ•°ä¸­ï¼Œå½“æ»¡è¶³çœŸæ­£å‘é€æ¡ä»¶çš„æ—¶å€™ï¼Œæ— è®ºè°ƒç”¨çš„æ˜¯ __tcp_push_pending_frames è¿˜æ˜¯ tcp_push_one æœ€ç»ˆéƒ½å®é™…ä¼šæ‰§è¡Œåˆ° tcp_write_xmitã€‚&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä» tcp_write_xmit çœ‹èµ·ï¼Œè¿™ä¸ªå‡½æ•°å¤„ç†äº†ä¼ è¾“å±‚çš„æ‹¥å¡æ§åˆ¶ã€æ»‘åŠ¨çª—å£ç›¸å…³çš„å·¥ä½œã€‚æ»¡è¶³çª—å£è¦æ±‚çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸‹ TCP å¤´ç„¶åå°† skb ä¼ åˆ°æ›´ä½çš„ç½‘ç»œå±‚è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-18f6157c989ac8838e7048941260809d_720w.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸‹ tcp_write_xmit çš„æºç ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/tcp_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="nf">tcp_write_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">mss_now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">nonagle&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">push_one&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gfp_t&lt;/span> &lt;span class="n">gfp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¾ªç¯è·å–å¾…å‘é€ skb
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tcp_send_head&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ»‘åŠ¨çª—å£ç›¸å…³
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">cwnd_quota&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tcp_cwnd_test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">tcp_snd_wnd_test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mss_now&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">tcp_mss_split_point&lt;/span>&lt;span class="p">(...);&lt;/span>
&lt;span class="n">tso_fragment&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...);&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="c1">//çœŸæ­£å¼€å¯å‘é€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tcp_transmit_skb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gfp&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰åœ¨ç½‘ç»œåè®®é‡Œå­¦çš„æ»‘åŠ¨çª—å£ã€æ‹¥å¡æ§åˆ¶å°±æ˜¯åœ¨è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆçš„ï¼Œè¿™éƒ¨åˆ†å°±ä¸è¿‡å¤šå±•å¼€äº†ï¼Œæ„Ÿå…´è¶£åŒå­¦è‡ªå·±æ‰¾è¿™æ®µæºç æ¥è¯»ã€‚æˆ‘ä»¬ä»Šå¤©åªçœ‹å‘é€ä¸»è¿‡ç¨‹ï¼Œé‚£å°±èµ°åˆ°äº† tcp_transmit_skbã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/tcp_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">tcp_transmit_skb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">clone_it&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">gfp_t&lt;/span> &lt;span class="n">gfp_mask&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//1.å…‹éš†æ–° skb å‡ºæ¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">likely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clone_it&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">skb_clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gfp_mask&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//2.å°è£… TCP å¤´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">th&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tcp_hdr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">th&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">source&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">inet&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">inet_sport&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">th&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">inet&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">inet_dport&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">th&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">window&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">...;&lt;/span>
&lt;span class="n">th&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">urg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">...;&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="c1">//3.è°ƒç”¨ç½‘ç»œå±‚å‘é€æ¥å£
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">icsk&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">icsk_af_ops&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">queue_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">inet&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">cork&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">fl&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¬¬ä¸€ä»¶äº‹æ˜¯å…ˆå…‹éš†ä¸€ä¸ªæ–°çš„ skbï¼Œè¿™é‡Œé‡ç‚¹è¯´ä¸‹ä¸ºä»€ä¹ˆè¦å¤åˆ¶ä¸€ä¸ª skb å‡ºæ¥å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ˜¯å› ä¸º skb åç»­åœ¨è°ƒç”¨ç½‘ç»œå±‚ï¼Œæœ€ååˆ°è¾¾ç½‘å¡å‘é€å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ª skb ä¼šè¢«é‡Šæ”¾æ‰ã€‚è€Œæˆ‘ä»¬çŸ¥é“ TCP åè®®æ˜¯æ”¯æŒä¸¢å¤±é‡ä¼ çš„ï¼Œåœ¨æ”¶åˆ°å¯¹æ–¹çš„ ACK ä¹‹å‰ï¼Œè¿™ä¸ª skb ä¸èƒ½è¢«åˆ é™¤ã€‚æ‰€ä»¥å†…æ ¸çš„åšæ³•å°±æ˜¯æ¯æ¬¡è°ƒç”¨ç½‘å¡å‘é€çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼ é€’å‡ºå»çš„æ˜¯ skb çš„ä¸€ä¸ªæ‹·è´ã€‚ç­‰æ”¶åˆ° ACK å†çœŸæ­£åˆ é™¤ã€‚&lt;/p>
&lt;p>ç¬¬äºŒä»¶äº‹æ˜¯ä¿®æ”¹ skb ä¸­çš„ TCP headerï¼Œæ ¹æ®å®é™…æƒ…å†µæŠŠ TCP å¤´è®¾ç½®å¥½ã€‚è¿™é‡Œè¦ä»‹ç»ä¸€ä¸ªå°æŠ€å·§ï¼Œskb å†…éƒ¨å…¶å®åŒ…å«äº†ç½‘ç»œåè®®ä¸­æ‰€æœ‰çš„ headerã€‚åœ¨è®¾ç½® TCP å¤´çš„æ—¶å€™ï¼Œåªæ˜¯æŠŠæŒ‡é’ˆæŒ‡å‘ skb çš„åˆé€‚ä½ç½®ã€‚åé¢å†è®¾ç½® IP å¤´çš„æ—¶å€™ï¼Œåœ¨æŠŠæŒ‡é’ˆæŒªä¸€æŒªå°±è¡Œï¼Œé¿å…é¢‘ç¹çš„å†…å­˜ç”³è¯·å’Œæ‹·è´ï¼Œæ•ˆç‡å¾ˆé«˜ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-cfce7d6f807c3325de9ef21df529e4c3_720w.jpg" alt="">&lt;/p>
&lt;p>tcp_transmit_skb æ˜¯å‘é€æ•°æ®ä½äºä¼ è¾“å±‚çš„æœ€åä¸€æ­¥ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›å…¥åˆ°ç½‘ç»œå±‚è¿›è¡Œä¸‹ä¸€å±‚çš„æ“ä½œäº†ã€‚è°ƒç”¨äº†ç½‘ç»œå±‚æä¾›çš„å‘é€æ¥å£icsk-&amp;gt;icsk_af_ops-&amp;gt;queue_xmit()ã€‚&lt;/p>
&lt;p>åœ¨ä¸‹é¢çš„è¿™ä¸ªæºç ä¸­ï¼Œæˆ‘ä»¬çš„çŸ¥é“äº† queue_xmit å…¶å®æŒ‡å‘çš„æ˜¯ ip_queue_xmit å‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/tcp_ipv4.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">inet_connection_sock_af_ops&lt;/span> &lt;span class="n">ipv4_specific&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">queue_xmit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ip_queue_xmit&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">send_check&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tcp_v4_send_check&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‡ªæ­¤ï¼Œä¼ è¾“å±‚çš„å·¥ä½œä¹Ÿå°±éƒ½å®Œæˆäº†ã€‚ æ•°æ®ç¦»å¼€äº†ä¼ è¾“å±‚ï¼Œæ¥ä¸‹æ¥å°†ä¼šè¿›å…¥åˆ°å†…æ ¸åœ¨ç½‘ç»œå±‚çš„å®ç°é‡Œã€‚&lt;/p>
&lt;h3 id="43-ç½‘ç»œå±‚å‘é€å¤„ç†">&lt;strong>4.3 ç½‘ç»œå±‚å‘é€å¤„ç†&lt;/strong>&lt;/h3>
&lt;p>Linux å†…æ ¸ç½‘ç»œå±‚çš„å‘é€çš„å®ç°ä½äº net/ipv4/ip_output.c è¿™ä¸ªæ–‡ä»¶ã€‚ä¼ è¾“å±‚è°ƒç”¨åˆ°çš„ ip_queue_xmit ä¹Ÿåœ¨è¿™é‡Œã€‚ï¼ˆä»æ–‡ä»¶åä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥è¿›å…¥åˆ° IP å±‚äº†ï¼Œæºæ–‡ä»¶åå·²ç»ä» tcp_xxx å˜æˆäº† ip_xxxã€‚ï¼‰&lt;/p>
&lt;p>åœ¨ç½‘ç»œå±‚é‡Œä¸»è¦å¤„ç†è·¯ç”±é¡¹æŸ¥æ‰¾ã€IP å¤´è®¾ç½®ã€netfilter è¿‡æ»¤ã€skb åˆ‡åˆ†ï¼ˆå¤§äº MTU çš„è¯ï¼‰ç­‰å‡ é¡¹å·¥ä½œï¼Œå¤„ç†å®Œè¿™äº›å·¥ä½œåä¼šäº¤ç»™æ›´ä¸‹å±‚çš„é‚»å±…å­ç³»ç»Ÿæ¥å¤„ç†ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-0070e8bac1946baba239c56a27555a00_720w.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹ç½‘ç»œå±‚å…¥å£å‡½æ•° ip_queue_xmit çš„æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/ip_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">ip_queue_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">flowi&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">fl&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ£€æŸ¥ socket ä¸­æ˜¯å¦æœ‰ç¼“å­˜çš„è·¯ç”±è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">rt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">rtable&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">__sk_dst_check&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rt&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ²¡æœ‰ç¼“å­˜åˆ™å±•å¼€æŸ¥æ‰¾
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//åˆ™æŸ¥æ‰¾è·¯ç”±é¡¹ï¼Œ å¹¶ç¼“å­˜åˆ° socket ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">rt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ip_route_output_ports&lt;/span>&lt;span class="p">(...);&lt;/span>
&lt;span class="n">sk_setup_caps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//ä¸º skb è®¾ç½®è·¯ç”±è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb_dst_set_noref&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//è®¾ç½® IP header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">iph&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ip_hdr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">iph&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">protocol&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sk&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">sk_protocol&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">iph&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ttl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ip_select_ttl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">inet&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">iph&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">frag_off&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">...;&lt;/span>
&lt;span class="c1">//å‘é€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ip_local_out&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ip_queue_xmit å·²ç»åˆ°äº†ç½‘ç»œå±‚ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ç½‘ç»œå±‚ç›¸å…³çš„åŠŸèƒ½è·¯ç”±é¡¹æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†åˆ™è®¾ç½®åˆ° skb ä¸Šï¼ˆæ²¡æœ‰è·¯ç”±çš„è¯å°±ç›´æ¥æŠ¥é”™è¿”å›äº†ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨ Linux ä¸Šé€šè¿‡ route å‘½ä»¤å¯ä»¥çœ‹åˆ°ä½ æœ¬æœºçš„è·¯ç”±é…ç½®ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-026979a5417056df4cd921841ce4cb61_720w.png" alt="">&lt;/p>
&lt;p>åœ¨è·¯ç”±è¡¨ä¸­ï¼Œå¯ä»¥æŸ¥åˆ°æŸä¸ªç›®çš„ç½‘ç»œåº”è¯¥é€šè¿‡å“ªä¸ª Ifaceï¼ˆç½‘å¡ï¼‰ï¼Œå“ªä¸ª Gatewayï¼ˆç½‘å¡ï¼‰å‘é€å‡ºå»ã€‚æŸ¥æ‰¾å‡ºæ¥ä»¥åç¼“å­˜åˆ° socket ä¸Šï¼Œä¸‹æ¬¡å†å‘é€æ•°æ®å°±ä¸ç”¨æŸ¥äº†ã€‚&lt;/p>
&lt;p>æ¥ç€æŠŠè·¯ç”±è¡¨åœ°å€ä¹Ÿæ”¾åˆ° skb é‡Œå»ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: include/linux/skbuff.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//ä¿å­˜äº†ä¸€äº›è·¯ç”±ç›¸å…³ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">_skb_refdst&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥å°±æ˜¯å®šä½åˆ° skb é‡Œçš„ IP å¤´çš„ä½ç½®ä¸Šï¼Œç„¶åå¼€å§‹æŒ‰ç…§åè®®è§„èŒƒè®¾ç½® IP headerã€‚&lt;/p>
&lt;p>&lt;img src="https://pic3.zhimg.com/80/v2-f75b423219d405ff7c6885b10ee11c0a_720w.jpg" alt="">&lt;/p>
&lt;p>å†é€šè¿‡ ip_local_out è¿›å…¥åˆ°ä¸‹ä¸€æ­¥çš„å¤„ç†ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/ip_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">ip_local_out&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ‰§è¡Œ netfilter è¿‡æ»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__ip_local_out&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//å¼€å§‹å‘é€æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">likely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dst_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ ip_local_out =&amp;gt; __ip_local_out =&amp;gt; nf_hook ä¼šæ‰§è¡Œ netfilter è¿‡æ»¤ã€‚å¦‚æœä½ ä½¿ç”¨ iptables é…ç½®äº†ä¸€äº›è§„åˆ™ï¼Œé‚£ä¹ˆè¿™é‡Œå°†æ£€æµ‹æ˜¯å¦å‘½ä¸­è§„åˆ™ã€‚Â &lt;strong>å¦‚æœä½ è®¾ç½®äº†éå¸¸å¤æ‚çš„ netfilter è§„åˆ™ï¼Œåœ¨è¿™ä¸ªå‡½æ•°è¿™é‡Œå°†ä¼šå¯¼è‡´ä½ çš„è¿›ç¨‹ CPU å¼€é”€ä¼šæå¤§å¢åŠ &lt;/strong>ã€‚&lt;/p>
&lt;p>è¿˜æ˜¯ä¸å¤šå±•å¼€è¯´ï¼Œç»§ç»­åªèŠå’Œå‘é€æœ‰å…³çš„è¿‡ç¨‹ dst_outputã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: include/net/dst.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">dst_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">skb_dst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤å‡½æ•°æ‰¾åˆ°åˆ°è¿™ä¸ª skb çš„è·¯ç”±è¡¨ï¼ˆdst æ¡ç›®ï¼‰ ï¼Œç„¶åè°ƒç”¨è·¯ç”±è¡¨çš„ output æ–¹æ³•ã€‚è¿™åˆæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯ ip_output æ–¹æ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/ip_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">ip_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//ç»Ÿè®¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">.....&lt;/span>
&lt;span class="c1">//å†æ¬¡äº¤ç»™ netfilterï¼Œå®Œæ¯•åå›è°ƒ ip_finish_output
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">NF_HOOK_COND&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NFPROTO_IPV4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">NF_INET_POST_ROUTING&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">ip_finish_output&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IPCB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">flags&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IPSKB_REROUTED&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ ip_output ä¸­è¿›è¡Œä¸€äº›ç®€å•çš„ï¼Œç»Ÿè®¡å·¥ä½œï¼Œå†æ¬¡æ‰§è¡Œ netfilter è¿‡æ»¤ã€‚è¿‡æ»¤é€šè¿‡ä¹‹åå›è°ƒ ip_finish_outputã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/ip_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">ip_finish_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//å¤§äº mtu çš„è¯å°±è¦è¿›è¡Œåˆ†ç‰‡äº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">len&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">ip_skb_dst_mtu&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">skb_is_gso&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ip_fragment&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ip_finish_output2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">else&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ip_finish_output2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ ip_finish_output ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œ&lt;strong>å¦‚æœæ•°æ®å¤§äº MTU çš„è¯ï¼Œæ˜¯ä¼šæ‰§è¡Œåˆ†ç‰‡çš„ã€‚&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>å®é™… MTU å¤§å°ç¡®å®šä¾èµ– MTU å‘ç°ï¼Œä»¥å¤ªç½‘å¸§ä¸º 1500 å­—èŠ‚ã€‚ä¹‹å‰ QQ å›¢é˜Ÿåœ¨æ—©æœŸçš„æ—¶å€™ï¼Œä¼šå°½é‡æ§åˆ¶è‡ªå·±æ•°æ®åŒ…å°ºå¯¸å°äº MTUï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥ä¼˜åŒ–ç½‘ç»œæ€§èƒ½ã€‚å› ä¸ºåˆ†ç‰‡ä¼šå¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š1ã€éœ€è¦è¿›è¡Œé¢å¤–çš„åˆ‡åˆ†å¤„ç†ï¼Œæœ‰é¢å¤–æ€§èƒ½å¼€é”€ã€‚2ã€åªè¦ä¸€ä¸ªåˆ†ç‰‡ä¸¢å¤±ï¼Œæ•´ä¸ªåŒ…éƒ½å¾—é‡ä¼ ã€‚æ‰€ä»¥é¿å…åˆ†ç‰‡æ—¢æœç»äº†åˆ†ç‰‡å¼€é”€ï¼Œä¹Ÿå¤§å¤§é™ä½äº†é‡ä¼ ç‡ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ ip_finish_output2 ä¸­ï¼Œç»ˆäºå‘é€è¿‡ç¨‹ä¼šè¿›å…¥åˆ°ä¸‹ä¸€å±‚ï¼Œé‚»å±…å­ç³»ç»Ÿä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/ipv4/ip_output.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">ip_finish_output2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//æ ¹æ®ä¸‹ä¸€è·³ IP åœ°å€æŸ¥æ‰¾é‚»å±…é¡¹ï¼Œæ‰¾ä¸åˆ°å°±åˆ›å»ºä¸€ä¸ª
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">nexthop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">__force&lt;/span> &lt;span class="n">u32&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">rt_nexthop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ip_hdr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">daddr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">neigh&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__ipv4_neigh_lookup_noref&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">nexthop&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unlikely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">neigh&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">neigh&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__neigh_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">arp_tbl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">nexthop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//ç»§ç»­å‘ä¸‹å±‚ä¼ é€’
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dst_neigh_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">neigh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="44-é‚»å±…å­ç³»ç»Ÿ">&lt;strong>4.4 é‚»å±…å­ç³»ç»Ÿ&lt;/strong>&lt;/h3>
&lt;p>é‚»å±…å­ç³»ç»Ÿæ˜¯ä½äºç½‘ç»œå±‚å’Œæ•°æ®é“¾è·¯å±‚ä¸­é—´çš„ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä½œç”¨æ˜¯å¯¹ç½‘ç»œå±‚æä¾›ä¸€ä¸ªå°è£…ï¼Œè®©ç½‘ç»œå±‚ä¸å¿…å…³å¿ƒä¸‹å±‚çš„åœ°å€ä¿¡æ¯ï¼Œè®©ä¸‹å±‚æ¥å†³å®šå‘é€åˆ°å“ªä¸ª MAC åœ°å€ã€‚&lt;/p>
&lt;p>è€Œä¸”è¿™ä¸ªé‚»å±…å­ç³»ç»Ÿå¹¶ä¸ä½äºåè®®æ ˆ net/ipv4/ ç›®å½•å†…ï¼Œè€Œæ˜¯ä½äº net/core/neighbour.cã€‚å› ä¸ºæ— è®ºæ˜¯å¯¹äº IPv4 è¿˜æ˜¯ IPv6 ï¼Œéƒ½éœ€è¦ä½¿ç”¨è¯¥æ¨¡å—ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-980285236de5b4b2efcf7176d1d6f9d9_720w.jpg" alt="">&lt;/p>
&lt;p>åœ¨é‚»å±…å­ç³»ç»Ÿé‡Œä¸»è¦æ˜¯æŸ¥æ‰¾æˆ–è€…åˆ›å»ºé‚»å±…é¡¹ï¼Œåœ¨åˆ›é€ é‚»å±…é¡¹çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šå‘å‡ºå®é™…çš„ arp è¯·æ±‚ã€‚ç„¶åå°è£…ä¸€ä¸‹ MAC å¤´ï¼Œå°†å‘é€è¿‡ç¨‹å†ä¼ é€’åˆ°æ›´ä¸‹å±‚çš„ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿã€‚å¤§è‡´æµç¨‹å¦‚å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-c2fffa7864d22f96118c7ce39ead1057_720w.jpg" alt="">&lt;/p>
&lt;p>ç†è§£äº†å¤§è‡´æµç¨‹ï¼Œæˆ‘ä»¬å†å›å¤´çœ‹æºç ã€‚åœ¨ä¸Šé¢å°èŠ‚ ip_finish_output2 æºç ä¸­è°ƒç”¨äº† __ipv4_neigh_lookup_norefã€‚å®ƒæ˜¯åœ¨ arp ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå…¶ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯è·¯ç”±ä¸‹ä¸€è·³ IP ä¿¡æ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: include/net/arp.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">extern&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">neigh_table&lt;/span> &lt;span class="n">arp_tbl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">neighbour&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">__ipv4_neigh_lookup_noref&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">u32&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">neigh_hash_table&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">nht&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rcu_dereference_bh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arp_tbl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">nht&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//è®¡ç®— hash å€¼ï¼ŒåŠ é€ŸæŸ¥æ‰¾
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">hash_val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">arp_hashfn&lt;/span>&lt;span class="p">(......);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rcu_dereference_bh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nht&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">hash_buckets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">hash_val&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">n&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rcu_dereference_bh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dev&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">dev&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">primary_key&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæŸ¥æ‰¾ä¸åˆ°ï¼Œåˆ™è°ƒç”¨ __neigh_create åˆ›å»ºä¸€ä¸ªé‚»å±…ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/neighbour.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">neighbour&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">__neigh_create&lt;/span>&lt;span class="p">(......)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//ç”³è¯·é‚»å±…è¡¨é¡¹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">neighbour&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">rc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">neigh_alloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tbl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//æ„é€ èµ‹å€¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">primary_key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pkey&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dev&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">parms&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">neigh_setup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//æœ€åæ·»åŠ åˆ°é‚»å±… hashtable ä¸­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">rcu_assign_pointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nht&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">hash_buckets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">hash_val&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ‰äº†é‚»å±…é¡¹ä»¥åï¼Œæ­¤æ—¶ä»ç„¶è¿˜ä¸å…·å¤‡å‘é€ IP æŠ¥æ–‡çš„èƒ½åŠ›ï¼Œå› ä¸ºç›®çš„ MAC åœ°å€è¿˜æœªè·å–ã€‚ è°ƒç”¨ dst_neigh_output ç»§ç»­ä¼ é€’ skbã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: include/net/dst.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">dst_neigh_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">dst_entry&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">neighbour&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è°ƒç”¨ outputï¼Œå®é™…æŒ‡å‘çš„æ˜¯ neigh_resolve_outputã€‚åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨æœ‰å¯èƒ½ä¼šå‘å‡º arp ç½‘ç»œè¯·æ±‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/neighbour.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">neigh_resolve_output&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;span class="c1">//æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½ä¼šè§¦å‘ arp è¯·æ±‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">neigh_event_send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">neigh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//neigh-&amp;gt;ha æ˜¯ MAC åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">dev_hard_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ntohs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">protocol&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="n">neigh&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ha&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//å‘é€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">dev_queue_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“è·å–åˆ°ç¡¬ä»¶ MAC åœ°å€ä»¥åï¼Œå°±å¯ä»¥å°è£… skb çš„ MAC å¤´äº†ã€‚æœ€åè°ƒç”¨ dev_queue_xmit å°† skb ä¼ é€’ç»™ Linux ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿã€‚&lt;/p>
&lt;h3 id="45-ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿ">&lt;strong>4.5 ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿ&lt;/strong>&lt;/h3>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-6fa56c1f95237a49703f6a0161daa7e3_720w.jpg" alt="">&lt;/p>
&lt;p>é‚»å±…å­ç³»ç»Ÿé€šè¿‡ dev_queue_xmit è¿›å…¥åˆ°ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿä¸­æ¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/dev.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">dev_queue_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//é€‰æ‹©å‘é€é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">txq&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">netdev_pick_tx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//è·å–ä¸æ­¤é˜Ÿåˆ—å…³è”çš„æ’é˜Ÿè§„åˆ™
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">q&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rcu_dereference_bh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">txq&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">qdisc&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//å¦‚æœæœ‰é˜Ÿåˆ—ï¼Œåˆ™è°ƒç”¨__dev_xmit_skb ç»§ç»­å¤„ç†æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">enqueue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">rc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__dev_xmit_skb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">q&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">txq&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">goto&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//æ²¡æœ‰é˜Ÿåˆ—çš„æ˜¯å›ç¯è®¾å¤‡å’Œéš§é“è®¾å¤‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¼€ç¯‡ç¬¬äºŒèŠ‚ç½‘å¡å¯åŠ¨å‡†å¤‡é‡Œæˆ‘ä»¬è¯´è¿‡ï¼Œç½‘å¡æ˜¯æœ‰å¤šä¸ªå‘é€é˜Ÿåˆ—çš„ï¼ˆå°¤å…¶æ˜¯ç°åœ¨çš„ç½‘å¡ï¼‰ã€‚ä¸Šé¢å¯¹ netdev_pick_tx å‡½æ•°çš„è°ƒç”¨å°±æ˜¯é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—è¿›è¡Œå‘é€ã€‚&lt;/p>
&lt;p>netdev_pick_tx å‘é€é˜Ÿåˆ—çš„é€‰æ‹©å— XPS ç­‰é…ç½®çš„å½±å“ï¼Œè€Œä¸”è¿˜æœ‰ç¼“å­˜ï¼Œä¹Ÿæ˜¯ä¸€å¥—å°å¤æ‚çš„é€»è¾‘ã€‚è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ä¸¤ä¸ªé€»è¾‘ï¼Œé¦–å…ˆä¼šè·å–ç”¨æˆ·çš„ XPS é…ç½®ï¼Œå¦åˆ™å°±è‡ªåŠ¨è®¡ç®—äº†ã€‚ä»£ç è§ netdev_pick_tx =&amp;gt; __netdev_pick_txã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/flow_dissector.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">u16&lt;/span> &lt;span class="nf">__netdev_pick_tx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//è·å– XPS é…ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">new_index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_xps_queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//è‡ªåŠ¨è®¡ç®—é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">new_index&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">new_index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">skb_tx_hash&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">);}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åè·å–ä¸æ­¤é˜Ÿåˆ—å…³è”çš„ qdiscã€‚åœ¨ linux ä¸Šé€šè¿‡ tc å‘½ä»¤å¯ä»¥çœ‹åˆ° qdisc ç±»å‹ï¼Œä¾‹å¦‚å¯¹äºæˆ‘çš„æŸå°å¤šé˜Ÿåˆ—ç½‘å¡æœºå™¨ä¸Šæ˜¯ mq discã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">#tc qdisc
qdisc mq 0: dev eth0 root
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¤§éƒ¨åˆ†çš„è®¾å¤‡éƒ½æœ‰é˜Ÿåˆ—ï¼ˆå›ç¯è®¾å¤‡å’Œéš§é“è®¾å¤‡é™¤å¤–ï¼‰ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬è¿›å…¥åˆ° __dev_xmit_skbã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/dev.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">__dev_xmit_skb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">netdev_queue&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">txq&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//1.å¦‚æœå¯ä»¥ç»•å¼€æ’é˜Ÿç³»ç»Ÿ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">flags&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">TCQ_F_CAN_BYPASS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">qdisc_qlen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="n">qdisc_run_begin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//2.æ­£å¸¸æ’é˜Ÿ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å…¥é˜Ÿ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">q&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">enqueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//å¼€å§‹å‘é€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">__qdisc_run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šè¿°ä»£ç ä¸­åˆ†ä¸¤ç§æƒ…å†µï¼Œ1 æ˜¯å¯ä»¥ bypassï¼ˆç»•è¿‡ï¼‰æ’é˜Ÿç³»ç»Ÿçš„ï¼Œå¦å¤–ä¸€ç§æ˜¯æ­£å¸¸æ’é˜Ÿã€‚æˆ‘ä»¬åªçœ‹ç¬¬äºŒç§æƒ…å†µã€‚&lt;/p>
&lt;p>å…ˆè°ƒç”¨ q-&amp;gt;enqueue æŠŠ skb æ·»åŠ åˆ°é˜Ÿåˆ—é‡Œã€‚ç„¶åè°ƒç”¨ __qdisc_run å¼€å§‹å‘é€ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/sched/sch_generic.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">__qdisc_run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">quota&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">weight_p&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//å¾ªç¯ä»é˜Ÿåˆ—å–å‡ºä¸€ä¸ª skb å¹¶å‘é€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">qdisc_restart&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¦‚æœå‘ç”Ÿä¸‹é¢æƒ…å†µä¹‹ä¸€ï¼Œåˆ™å»¶åå¤„ç†ï¼š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 1. quota ç”¨å°½
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 2. å…¶ä»–è¿›ç¨‹éœ€è¦ CPU
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">quota&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">need_resched&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//å°†è§¦å‘ä¸€æ¬¡ NET_TX_SOFTIRQ ç±»å‹ softirq
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">__netif_schedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° while å¾ªç¯ä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡º skb å¹¶è¿›è¡Œå‘é€ã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®éƒ½å ç”¨çš„æ˜¯ç”¨æˆ·è¿›ç¨‹çš„ç³»ç»Ÿæ€æ—¶é—´(sy)ã€‚ åªæœ‰å½“ quota ç”¨å°½æˆ–è€…å…¶å®ƒè¿›ç¨‹éœ€è¦ CPU çš„æ—¶å€™æ‰è§¦å‘è½¯ä¸­æ–­è¿›è¡Œå‘é€ã€‚&lt;/p>
&lt;p>&lt;strong>æ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€èˆ¬æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ /proc/softirqsï¼Œä¸€èˆ¬ NET_RX éƒ½è¦æ¯” NET_TX å¤§çš„å¤šçš„ç¬¬äºŒä¸ªåŸå› &lt;/strong>ã€‚å¯¹äºè¯»æ¥è¯´ï¼Œéƒ½æ˜¯è¦ç»è¿‡ NET_RX è½¯ä¸­æ–­ï¼Œè€Œå¯¹äºå‘é€æ¥è¯´ï¼Œåªæœ‰ç³»ç»Ÿæ€é…é¢ç”¨å°½æ‰è®©è½¯ä¸­æ–­ä¸Šã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥æŠŠç²¾åŠ›åœ¨æ”¾åˆ° qdisc_restart ä¸Šï¼Œç»§ç»­çœ‹å‘é€è¿‡ç¨‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">qdisc_restart&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//ä» qdisc ä¸­å–å‡ºè¦å‘é€çš„ skb
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dequeue_skb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">...&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">sch_direct_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">q&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">txq&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">root_lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>qdisc_restart ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª skbï¼Œå¹¶è°ƒç”¨ sch_direct_xmit ç»§ç»­å‘é€ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/sched/sch_generic.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">sch_direct_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">netdev_queue&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">txq&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">spinlock_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">root_lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//è°ƒç”¨é©±åŠ¨ç¨‹åºæ¥å‘é€æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev_hard_start_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">txq&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="46-è½¯ä¸­æ–­è°ƒåº¦">&lt;strong>4.6 è½¯ä¸­æ–­è°ƒåº¦&lt;/strong>&lt;/h3>
&lt;p>åœ¨ 4.5 å’±ä»¬çœ‹åˆ°äº†å¦‚æœç³»ç»Ÿæ€ CPU å‘é€ç½‘ç»œåŒ…ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ __netif_schedule è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­ã€‚è¯¥å‡½æ•°ä¼šè¿›å…¥åˆ° __netif_rescheduleï¼Œç”±å®ƒæ¥å®é™…å‘å‡º NET_TX_SOFTIRQ ç±»å‹è½¯ä¸­æ–­ã€‚&lt;/p>
&lt;p>è½¯ä¸­æ–­æ˜¯ç”±å†…æ ¸çº¿ç¨‹æ¥è¿è¡Œçš„ï¼Œè¯¥çº¿ç¨‹ä¼šè¿›å…¥åˆ° net_tx_action å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­èƒ½è·å–åˆ°å‘é€é˜Ÿåˆ—ï¼Œå¹¶ä¹Ÿæœ€ç»ˆè°ƒç”¨åˆ°é©±åŠ¨ç¨‹åºé‡Œçš„å…¥å£å‡½æ•° dev_hard_start_xmitã€‚&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-7b7da5c8cebe7a05ef2fddc3b98d7ec5_720w.jpg" alt="">&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/dev.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">__netif_reschedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">sd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">__get_cpu_var&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">softnet_data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">q&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next_sched&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">output_queue_tailp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">q&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">output_queue_tailp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next_sched&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="n">raise_softirq_irqoff&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NET_TX_SOFTIRQ&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¯¥å‡½æ•°é‡Œåœ¨è½¯ä¸­æ–­èƒ½è®¿é—®åˆ°çš„ softnet_data é‡Œè®¾ç½®äº†è¦å‘é€çš„æ•°æ®é˜Ÿåˆ—ï¼Œæ·»åŠ åˆ°äº† output_queue é‡Œäº†ã€‚ç´§æ¥ç€è§¦å‘äº† NET_TX_SOFTIRQ ç±»å‹çš„è½¯ä¸­æ–­ã€‚ï¼ˆT ä»£è¡¨ transmit ä¼ è¾“ï¼‰&lt;/p>
&lt;p>è½¯ä¸­æ–­çš„å…¥å£ä»£ç æˆ‘è¿™é‡Œä¹Ÿä¸è¯¦ç»†æ‰’äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å‚è€ƒ**&lt;a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/GoYDsfy9m0wRoXi_NCfCmg">ã€Šå›¾è§£Linuxç½‘ç»œåŒ…æ¥æ”¶è¿‡ç¨‹ã€‹&lt;/a>**ä¸€æ–‡ä¸­çš„ 3.2 å°èŠ‚ - ksoftirqdå†…æ ¸çº¿ç¨‹å¤„ç†è½¯ä¸­æ–­ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç›´æ¥ä» NET_TX_SOFTIRQ softirq æ³¨å†Œçš„å›è°ƒå‡½æ•° net_tx_actionè®²èµ·ã€‚ç”¨æˆ·æ€è¿›ç¨‹è§¦å‘å®Œè½¯ä¸­æ–­ä¹‹åï¼Œä¼šæœ‰ä¸€ä¸ªè½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹ä¼šæ‰§è¡Œåˆ° net_tx_actionã€‚&lt;/p>
&lt;p>&lt;strong>ç‰¢è®°ï¼Œè¿™ä»¥åå‘é€æ•°æ®æ¶ˆè€—çš„ CPU å°±éƒ½æ˜¾ç¤ºåœ¨ si è¿™é‡Œäº†ï¼Œä¸ä¼šæ¶ˆè€—ç”¨æˆ·è¿›ç¨‹çš„ç³»ç»Ÿæ—¶é—´äº†&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/dev.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">net_tx_action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">softirq_action&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//é€šè¿‡ softnet_data è·å–å‘é€é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">softnet_data&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">__get_cpu_var&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">softnet_data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// å¦‚æœ output queue ä¸Šæœ‰ qdisc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">output_queue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å°† head æŒ‡å‘ç¬¬ä¸€ä¸ª qdisc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">head&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">output_queue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//éå† qdsics åˆ—è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">head&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">head&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">head&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">head&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next_sched&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//å‘é€æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">qdisc_run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è½¯ä¸­æ–­è¿™é‡Œä¼šè·å– softnet_dataã€‚å‰é¢æˆ‘ä»¬çœ‹åˆ°è¿›ç¨‹å†…æ ¸æ€åœ¨è°ƒç”¨ __netif_reschedule çš„æ—¶å€™æŠŠå‘é€é˜Ÿåˆ—å†™åˆ° softnet_data çš„ output_queue é‡Œäº†ã€‚ è½¯ä¸­æ–­å¾ªç¯éå† sd-&amp;gt;output_queue å‘é€æ•°æ®å¸§ã€‚&lt;/p>
&lt;p>æ¥çœ‹ qdisc_runï¼Œå®ƒå’Œè¿›ç¨‹ç”¨æˆ·æ€ä¸€æ ·ï¼Œä¹Ÿä¼šè°ƒç”¨åˆ° __qdisc_runã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: include/net/pkt_sched.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">qdisc_run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">qdisc_run_begin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">__qdisc_run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åä¸€æ ·å°±æ˜¯è¿›å…¥ qdisc_restart =&amp;gt; sch_direct_xmitï¼Œç›´åˆ°é©±åŠ¨ç¨‹åºå‡½æ•° dev_hard_start_xmitã€‚&lt;/p>
&lt;h3 id="47-igb-ç½‘å¡é©±åŠ¨å‘é€">&lt;strong>4.7 igb ç½‘å¡é©±åŠ¨å‘é€&lt;/strong>&lt;/h3>
&lt;p>æˆ‘ä»¬å‰é¢çœ‹åˆ°ï¼Œæ— è®ºæ˜¯å¯¹äºç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸æ€ï¼Œè¿˜æ˜¯å¯¹äºè½¯ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œéƒ½ä¼šè°ƒç”¨åˆ°ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿä¸­çš„ dev_hard_start_xmit å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨åˆ°é©±åŠ¨é‡Œçš„å‘é€å‡½æ•° igb_xmit_frameã€‚&lt;/p>
&lt;p>åœ¨é©±åŠ¨å‡½æ•°é‡Œï¼Œå°† skb ä¼šæŒ‚åˆ° RingBufferä¸Šï¼Œé©±åŠ¨è°ƒç”¨å®Œæ¯•åï¼Œæ•°æ®åŒ…å°†çœŸæ­£ä»ç½‘å¡å‘é€å‡ºå»ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-dd72dd5d2ddcaa38bcde752bb5d073c4_720w.jpg" alt="">&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹çœ‹å®é™…çš„æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: net/core/dev.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">dev_hard_start_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">netdev_queue&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">txq&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//è·å–è®¾å¤‡çš„å›è°ƒå‡½æ•°é›†åˆ ops
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device_ops&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ops&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">netdev_ops&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//è·å–è®¾å¤‡æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">features&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">netif_skb_features&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//è°ƒç”¨é©±åŠ¨çš„ ops é‡Œé¢çš„å‘é€å›è°ƒå‡½æ•° ndo_start_xmit å°†æ•°æ®åŒ…ä¼ ç»™ç½‘å¡è®¾å¤‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">skb_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">rc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ops&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ndo_start_xmit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ ndo_start_xmit æ˜¯ç½‘å¡é©±åŠ¨è¦å®ç°çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ˜¯åœ¨ net_device_ops ä¸­å®šä¹‰çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: include/linux/netdevice.h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device_ops&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">netdev_tx_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">ndo_start_xmit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ igb ç½‘å¡é©±åŠ¨æºç ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device_ops&lt;/span> &lt;span class="n">igb_netdev_ops&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">ndo_open&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">igb_open&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">ndo_stop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">igb_close&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="n">ndo_start_xmit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">igb_xmit_frame&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">...&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºç½‘ç»œè®¾å¤‡å±‚å®šä¹‰çš„ ndo_start_xmitï¼Œ igb çš„å®ç°å‡½æ•°æ˜¯ igb_xmit_frameã€‚è¿™ä¸ªå‡½æ•°æ˜¯åœ¨ç½‘å¡é©±åŠ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«èµ‹å€¼çš„ã€‚å…·ä½“åˆå§‹åŒ–è¿‡ç¨‹å‚è§**&lt;a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/GoYDsfy9m0wRoXi_NCfCmg">ã€Šå›¾è§£Linuxç½‘ç»œåŒ…æ¥æ”¶è¿‡ç¨‹ã€‹&lt;/a>**ä¸€æ–‡ä¸­çš„ 2.4 èŠ‚ï¼Œç½‘å¡é©±åŠ¨åˆå§‹åŒ–ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åœ¨ä¸Šé¢ç½‘ç»œè®¾å¤‡å±‚è°ƒç”¨ ops-&amp;gt;ndo_start_xmit çš„æ—¶å€™ï¼Œä¼šå®é™…ä¸Šè¿›å…¥ igb_xmit_frame è¿™ä¸ªå‡½æ•°ä¸­ã€‚æˆ‘ä»¬è¿›å…¥è¿™ä¸ªå‡½æ•°æ¥çœ‹çœ‹é©±åŠ¨ç¨‹åºæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="n">netdev_tx_t&lt;/span> &lt;span class="nf">igb_xmit_frame&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">netdev&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="p">......&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">igb_xmit_frame_ring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">igb_tx_queue_mapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">adapter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">netdev_tx_t&lt;/span> &lt;span class="nf">igb_xmit_frame_ring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_ring&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//è·å–TX Queue ä¸­ä¸‹ä¸€ä¸ªå¯ç”¨ç¼“å†²åŒºä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">first&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tx_buffer_info&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next_to_use&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">first&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">first&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">bytecount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">first&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">gso_segs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//igb_tx_map å‡½æ•°å‡†å¤‡ç»™è®¾å¤‡å‘é€çš„æ•°æ®ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">igb_tx_map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">first&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hdr_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¿™é‡Œä»ç½‘å¡çš„å‘é€é˜Ÿåˆ—çš„ RingBuffer ä¸­å–ä¸‹æ¥ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°† skb æŒ‚åˆ°å…ƒç´ ä¸Šã€‚&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-53210da030eea44896489582bbbc13f0_720w.jpg" alt="">&lt;/p>
&lt;p>igb_tx_map å‡½æ•°å¤„ç†å°† skb æ•°æ®æ˜ å°„åˆ°ç½‘å¡å¯è®¿é—®çš„å†…å­˜ DMA åŒºåŸŸã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">igb_tx_map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_ring&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_tx_buffer&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="n">u8&lt;/span> &lt;span class="n">hdr_len&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//è·å–ä¸‹ä¸€ä¸ªå¯ç”¨æè¿°ç¬¦æŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tx_desc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IGB_TX_DESC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//ä¸º skb-&amp;gt;data æ„é€ å†…å­˜æ˜ å°„ï¼Œä»¥å…è®¸è®¾å¤‡é€šè¿‡ DMA ä» RAM ä¸­è¯»å–æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">dma&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dma_map_single&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx_ring&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DMA_TO_DEVICE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//éå†è¯¥æ•°æ®åŒ…çš„æ‰€æœ‰åˆ†ç‰‡,ä¸º skb çš„æ¯ä¸ªåˆ†ç‰‡ç”Ÿæˆæœ‰æ•ˆæ˜ å°„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">frag&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">skb_shinfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">frags&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">];;&lt;/span> &lt;span class="n">frag&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">tx_desc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">buffer_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cpu_to_le64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dma&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">tx_desc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cmd_type_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">...;&lt;/span>
&lt;span class="n">tx_desc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">olinfo_status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//è®¾ç½®æœ€åä¸€ä¸ªdescriptor
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">cmd_type&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">IGB_TXD_DCMD&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">tx_desc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cmd_type_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cpu_to_le32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd_type&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Force memory writes to complete before letting h/w know there
&lt;/span>&lt;span class="cm"> * are new descriptors to fetch
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="n">wmb&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“æ‰€æœ‰éœ€è¦çš„æè¿°ç¬¦éƒ½å·²å»ºå¥½ï¼Œä¸” skb çš„æ‰€æœ‰æ•°æ®éƒ½æ˜ å°„åˆ° DMA åœ°å€åï¼Œé©±åŠ¨å°±ä¼šè¿›å…¥åˆ°å®ƒçš„æœ€åä¸€æ­¥ï¼Œè§¦å‘çœŸå®çš„å‘é€ã€‚&lt;/p>
&lt;h3 id="48-å‘é€å®Œæˆç¡¬ä¸­æ–­">&lt;strong>4.8 å‘é€å®Œæˆç¡¬ä¸­æ–­&lt;/strong>&lt;/h3>
&lt;p>å½“æ•°æ®å‘é€å®Œæˆä»¥åï¼Œå…¶å®å·¥ä½œå¹¶æ²¡æœ‰ç»“æŸã€‚å› ä¸ºå†…å­˜è¿˜æ²¡æœ‰æ¸…ç†ã€‚å½“å‘é€å®Œæˆçš„æ—¶å€™ï¼Œç½‘å¡è®¾å¤‡ä¼šè§¦å‘ä¸€ä¸ªç¡¬ä¸­æ–­æ¥é‡Šæ”¾å†…å­˜ã€‚&lt;/p>
&lt;p>åœ¨**&lt;a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/GoYDsfy9m0wRoXi_NCfCmg">ã€Šå›¾è§£Linuxç½‘ç»œåŒ…æ¥æ”¶è¿‡ç¨‹ã€‹&lt;/a>**Â ä¸€æ–‡ä¸­çš„ 3.1 å’Œ 3.2 å°èŠ‚ï¼Œæˆ‘ä»¬è¯¦ç»†è®²è¿°è¿‡ç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>åœ¨å‘é€ç¡¬ä¸­æ–­é‡Œï¼Œä¼šæ‰§è¡Œ RingBuffer å†…å­˜çš„æ¸…ç†å·¥ä½œï¼Œå¦‚å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-4a1721e48e34c50390132f018c5ad1d4_720w.jpg" alt="">&lt;/p>
&lt;p>å†å›å¤´çœ‹ä¸€ä¸‹ç¡¬ä¸­æ–­è§¦å‘è½¯ä¸­æ–­çš„æºç ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">static&lt;/span> &lt;span class="nx">inline&lt;/span> &lt;span class="nx">void&lt;/span> &lt;span class="nf">____napi_schedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="nf">list_add_tail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">napi&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="nx">poll_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">sd&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="nx">poll_list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nf">__raise_softirq_irqoff&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">NET_RX_SOFTIRQ&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™é‡Œæœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„ç»†èŠ‚ï¼Œæ— è®ºç¡¬ä¸­æ–­æ˜¯å› ä¸ºæ˜¯æœ‰æ•°æ®è¦æ¥æ”¶ï¼Œè¿˜æ˜¯è¯´å‘é€å®Œæˆé€šçŸ¥ï¼Œ&lt;strong>ä»ç¡¬ä¸­æ–­è§¦å‘çš„è½¯ä¸­æ–­éƒ½æ˜¯ NET_RX_SOFTIRQ&lt;/strong>ã€‚ è¿™ä¸ªæˆ‘ä»¬åœ¨ç¬¬ä¸€èŠ‚è¯´è¿‡äº†ï¼Œè¿™æ˜¯è½¯ä¸­æ–­ç»Ÿè®¡ä¸­ RX è¦é«˜äº TX çš„ä¸€ä¸ªåŸå› ã€‚&lt;/p>
&lt;p>å¥½æˆ‘ä»¬æ¥ç€è¿›å…¥è½¯ä¸­æ–­çš„å›è°ƒå‡½æ•° igb_pollã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæˆ‘ä»¬æ³¨æ„åˆ°æœ‰ä¸€è¡Œ igb_clean_tx_irqï¼Œå‚è§æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">igb_poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">struct&lt;/span> &lt;span class="nx">napi_struct&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">napi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nx">budget&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//performs the transmit completion operations
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">q_vector&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ring&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">clean_complete&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">igb_clean_tx_irq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">q_vector&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬æ¥çœ‹çœ‹å½“ä¼ è¾“å®Œæˆçš„æ—¶å€™ï¼Œigb_clean_tx_irq éƒ½å¹²å•¥äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">//file: drivers/net/ethernet/intel/igb/igb_main.c
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">static&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="nf">igb_clean_tx_irq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">igb_q_vector&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">q_vector&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="c1">//free the skb
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">dev_kfree_skb_any&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx_buffer&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//clear tx_buffer data
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tx_buffer&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">skb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">dma_unmap_len_set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx_buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// clear last DMA location and unmap remaining buffers */
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tx_desc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">eop_desc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ— éå°±æ˜¯æ¸…ç†äº† skbï¼Œè§£é™¤äº† DMA æ˜ å°„ç­‰ç­‰ã€‚ åˆ°äº†è¿™ä¸€æ­¥ï¼Œä¼ è¾“æ‰ç®—æ˜¯åŸºæœ¬å®Œæˆäº†ã€‚&lt;/p>
&lt;p>ä¸ºå•¥æˆ‘è¯´æ˜¯åŸºæœ¬å®Œæˆï¼Œè€Œä¸æ˜¯å…¨éƒ¨å®Œæˆäº†å‘¢ï¼Ÿå› ä¸ºä¼ è¾“å±‚éœ€è¦ä¿è¯å¯é æ€§ï¼Œæ‰€ä»¥ skb å…¶å®è¿˜æ²¡æœ‰åˆ é™¤ã€‚å®ƒå¾—ç­‰æ”¶åˆ°å¯¹æ–¹çš„ ACK ä¹‹åæ‰ä¼šçœŸæ­£åˆ é™¤ï¼Œé‚£ä¸ªæ—¶å€™æ‰ç®—æ˜¯å½»åº•çš„å‘é€å®Œæ¯•ã€‚&lt;/p>
&lt;h2 id="æœ€å">&lt;strong>æœ€å&lt;/strong>&lt;/h2>
&lt;p>ç”¨ä¸€å¼ å›¾æ€»ç»“ä¸€ä¸‹æ•´ä¸ªå‘é€è¿‡ç¨‹&lt;/p>
&lt;p>&lt;img src="https://pic4.zhimg.com/80/v2-ecb73e1531032fea52e21644f2aa1413_720w.jpg" alt="">&lt;/p>
&lt;p>äº†è§£äº†æ•´ä¸ªå‘é€è¿‡ç¨‹ä»¥åï¼Œæˆ‘ä»¬å›å¤´å†æ¥å›é¡¾å¼€ç¯‡æåˆ°çš„å‡ ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;p>&lt;strong>1.æˆ‘ä»¬åœ¨ç›‘æ§å†…æ ¸å‘é€æ•°æ®æ¶ˆè€—çš„ CPU æ—¶ï¼Œæ˜¯åº”è¯¥çœ‹ sy è¿˜æ˜¯ si ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>åœ¨ç½‘ç»œåŒ…çš„å‘é€è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ï¼ˆåœ¨å†…æ ¸æ€ï¼‰å®Œæˆäº†ç»å¤§éƒ¨åˆ†çš„å·¥ä½œï¼Œç”šè‡³è¿è°ƒç”¨é©±åŠ¨çš„äº‹æƒ…éƒ½å¹²äº†ã€‚ åªæœ‰å½“å†…æ ¸æ€è¿›ç¨‹è¢«åˆ‡èµ°å‰æ‰ä¼šå‘èµ·è½¯ä¸­æ–­ã€‚ å‘é€è¿‡ç¨‹ä¸­ï¼Œç»å¤§éƒ¨åˆ†ï¼ˆ90%ï¼‰ä»¥ä¸Šçš„å¼€é”€éƒ½æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹å†…æ ¸æ€æ¶ˆè€—æ‰çš„ã€‚&lt;/p>
&lt;p>åªæœ‰ä¸€å°‘éƒ¨åˆ†æƒ…å†µä¸‹æ‰ä¼šè§¦å‘è½¯ä¸­æ–­ï¼ˆNET_TX ç±»å‹ï¼‰ï¼Œç”±è½¯ä¸­æ–­ ksoftirqd å†…æ ¸è¿›ç¨‹æ¥å‘é€ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œåœ¨ç›‘æ§ç½‘ç»œ IO å¯¹æœåŠ¡å™¨é€ æˆçš„ CPU å¼€é”€çš„æ—¶å€™ï¼Œä¸èƒ½ä»…ä»…åªçœ‹ siï¼Œè€Œæ˜¯åº”è¯¥æŠŠ siã€sy éƒ½è€ƒè™‘è¿›æ¥ã€‚&lt;/p>
&lt;p>&lt;strong>2. åœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ /proc/softirqsï¼Œä¸ºä»€ä¹ˆ NET_RX è¦æ¯” NET_TX å¤§çš„å¤šçš„å¤šï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>ä¹‹å‰æˆ‘è®¤ä¸º NET_RX æ˜¯è¯»å–ï¼ŒNET_TX æ˜¯ä¼ è¾“ã€‚å¯¹äºä¸€ä¸ªæ—¢æ”¶å–ç”¨æˆ·è¯·æ±‚ï¼Œåˆç»™ç”¨æˆ·è¿”å›çš„ Server æ¥è¯´ã€‚ è¿™ä¸¤å—çš„æ•°å­—åº”è¯¥å·®ä¸å¤šæ‰å¯¹ï¼Œè‡³å°‘ä¸ä¼šæœ‰æ•°é‡çº§çš„å·®å¼‚ã€‚ä½†äº‹å®ä¸Šï¼Œé£å“¥æ‰‹å¤´çš„ä¸€å°æœåŠ¡å™¨æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;p>&lt;img src="https://pic1.zhimg.com/80/v2-519963353aadc56140fc233c7bdf6db0_720w.jpg" alt="">&lt;/p>
&lt;p>ç»è¿‡ä»Šå¤©çš„æºç åˆ†æï¼Œå‘ç°è¿™ä¸ªé—®é¢˜çš„åŸå› æœ‰ä¸¤ä¸ªã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªåŸå› æ˜¯å½“æ•°æ®å‘é€å®Œæˆä»¥åï¼Œé€šè¿‡ç¡¬ä¸­æ–­çš„æ–¹å¼æ¥é€šçŸ¥é©±åŠ¨å‘é€å®Œæ¯•ã€‚ä½†æ˜¯ç¡¬ä¸­æ–­æ— è®ºæ˜¯æœ‰æ•°æ®æ¥æ”¶ï¼Œè¿˜æ˜¯å¯¹äºå‘é€å®Œæ¯•ï¼Œè§¦å‘çš„è½¯ä¸­æ–­éƒ½æ˜¯ NET_RX_SOFTIRQï¼Œè€Œå¹¶ä¸æ˜¯ NET_TX_SOFTIRQã€‚&lt;/p>
&lt;p>ç¬¬äºŒä¸ªåŸå› æ˜¯å¯¹äºè¯»æ¥è¯´ï¼Œéƒ½æ˜¯è¦ç»è¿‡ NET_RX è½¯ä¸­æ–­çš„ï¼Œéƒ½èµ° ksoftirqd å†…æ ¸è¿›ç¨‹ã€‚è€Œå¯¹äºå‘é€æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹å†…æ ¸æ€å¤„ç†äº†ï¼Œåªæœ‰ç³»ç»Ÿæ€é…é¢ç”¨å°½æ‰ä¼šå‘å‡º NET_TXï¼Œè®©è½¯ä¸­æ–­ä¸Šã€‚&lt;/p>
&lt;p>ç»¼ä¸Šä¸¤ä¸ªåŸå› ï¼Œé‚£ä¹ˆåœ¨æœºå™¨ä¸ŠæŸ¥çœ‹ NET_RX æ¯” NET_TX å¤§çš„å¤šå°±ä¸éš¾ç†è§£äº†ã€‚&lt;/p>
&lt;p>&lt;strong>3.å‘é€ç½‘ç»œæ•°æ®çš„æ—¶å€™éƒ½æ¶‰åŠåˆ°å“ªäº›å†…å­˜æ‹·è´æ“ä½œï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>è¿™é‡Œçš„å†…å­˜æ‹·è´ï¼Œæˆ‘ä»¬åªç‰¹æŒ‡å¾…å‘é€æ•°æ®çš„å†…å­˜æ‹·è´ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€æ¬¡æ‹·è´æ“ä½œæ˜¯å†…æ ¸ç”³è¯·å®Œ skb ä¹‹åï¼Œè¿™æ—¶å€™ä¼šå°†ç”¨æˆ·ä¼ é€’è¿›æ¥çš„ buffer é‡Œçš„æ•°æ®å†…å®¹éƒ½æ‹·è´åˆ° skb ä¸­ã€‚å¦‚æœè¦å‘é€çš„æ•°æ®é‡æ¯”è¾ƒå¤§çš„è¯ï¼Œè¿™ä¸ªæ‹·è´æ“ä½œå¼€é”€è¿˜æ˜¯ä¸å°çš„ã€‚&lt;/p>
&lt;p>ç¬¬äºŒæ¬¡æ‹·è´æ“ä½œæ˜¯ä»ä¼ è¾“å±‚è¿›å…¥ç½‘ç»œå±‚çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ª skb éƒ½ä¼šè¢«å…‹éš†ä¸€ä¸ªæ–°çš„å‰¯æœ¬å‡ºæ¥ã€‚ç½‘ç»œå±‚ä»¥åŠä¸‹é¢çš„é©±åŠ¨ã€è½¯ä¸­æ–­ç­‰ç»„ä»¶åœ¨å‘é€å®Œæˆçš„æ—¶å€™ä¼šå°†è¿™ä¸ªå‰¯æœ¬åˆ é™¤ã€‚ä¼ è¾“å±‚ä¿å­˜ç€åŸå§‹çš„ skbï¼Œåœ¨å½“ç½‘ç»œå¯¹æ–¹æ²¡æœ‰ ack çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥é‡æ–°å‘é€ï¼Œä»¥å®ç° TCP ä¸­è¦æ±‚çš„å¯é ä¼ è¾“ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰æ¬¡æ‹·è´ä¸æ˜¯å¿…é¡»çš„ï¼Œåªæœ‰å½“ IP å±‚å‘ç° skb å¤§äº MTU æ—¶æ‰éœ€è¦è¿›è¡Œã€‚ä¼šå†ç”³è¯·é¢å¤–çš„ skbï¼Œå¹¶å°†åŸæ¥çš„ skb æ‹·è´ä¸ºå¤šä¸ªå°çš„ skbã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™é‡Œæ’å…¥ä¸ªé¢˜å¤–è¯ï¼Œå¤§å®¶åœ¨ç½‘ç»œæ€§èƒ½ä¼˜åŒ–ä¸­ç»å¸¸å¬åˆ°çš„é›¶æ‹·è´ï¼Œæˆ‘è§‰å¾—è¿™æœ‰ç‚¹ç‚¹å¤¸å¼ çš„æˆåˆ†ã€‚TCP ä¸ºäº†ä¿è¯å¯é æ€§ï¼Œç¬¬äºŒæ¬¡çš„æ‹·è´æ ¹æœ¬å°±æ²¡æ³•çœã€‚å¦‚æœåŒ…å†å¤§äº MTU çš„è¯ï¼Œåˆ†ç‰‡æ—¶çš„æ‹·è´åŒæ ·ä¹Ÿé¿å…ä¸äº†ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å†…æ ¸å‘é€æ•°æ®åŒ…å¯¹äºä½ æ¥è¯´ï¼Œå·²ç»ä¸å†æ˜¯ä¸€ä¸ªå®Œå…¨ä¸æ‡‚çš„é»‘ç›’äº†ã€‚æœ¬æ–‡å“ªæ€•ä½ åªçœ‹æ‡‚ååˆ†ä¹‹ä¸€ï¼Œä½ ä¹Ÿå·²ç»æŒæ¡äº†è¿™ä¸ªé»‘ç›’çš„æ‰“å¼€æ–¹å¼ã€‚è¿™åœ¨ä½ å°†æ¥ä¼˜åŒ–ç½‘ç»œæ€§èƒ½æ—¶ä½ å°±ä¼šçŸ¥é“ä»å“ªå„¿ä¸‹æ‰‹äº†ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">&lt;strong>å‚è€ƒ&lt;/strong>&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//blog.packagecloud.io/eng/2017/02/06/monitoring-tuning-linux-networking-stack-sending-data/">Monitoring and Tuning the Linux Networking Stack: Sending Data&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//blog.csdn.net/qq_34258344/article/details/108956205">ä¸Šè¿°æ–‡ç« çš„ä¸€ä¸ªç¿»è¯‘ç‰ˆæœ¬,åªç¿»è¯‘äº†ä¸€åŠ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//ggaaooppeenngg.github.io/zh-CN/2017/08/07/neighboring-subsystem-%25E6%25B5%2585%25E6%259E%2590/">ç¿»è¯‘çš„æ˜¯å¦å¤–ä¸€åŠï¼Œneighboring subsystem æµ…æ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=http%3A//kerneltravel.net/blog/2020/network_ljr14/">LINUXå†…æ ¸ç½‘ç»œæ•°æ®åŒ…å‘é€ï¼ˆå››ï¼‰â€”â€”LINUX NETDEVICE å­ç³»ç»Ÿ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=http%3A//kerneltravel.net/blog/2020/network_ljr13/">LINUXå†…æ ¸ç½‘ç»œæ•°æ®åŒ…å‘é€ï¼ˆä¸‰ï¼‰â€”â€”IPåè®®å±‚åˆ†æ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=http%3A//kerneltravel.net/blog/2020/dma_bjq/">LINUXç½‘ç»œå­ç³»ç»Ÿä¸­DMAæœºåˆ¶çš„å®ç°&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//blog.csdn.net/weixin_43722423/article/details/103276437">Linux socket æ•°æ®å‘é€è¿‡ç¨‹æ·±å…¥åˆ†æ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//man7.org/linux/man-pages/man2/send.2.html">send å‡½æ•°&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//ivanzz1001.github.io/records/post/linux/2017/11/04/linux-msghdr">Linux msghdrç»“æ„è®²è§£&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//blog.csdn.net/zhangskd/article/details/48207553">TCPçš„å‘é€ç³»åˆ— â€” tcp_sendmsg()çš„å®ç°ï¼ˆä¸€ï¼‰&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//www.cnblogs.com/myguaiguai/p/12069485.html">å‚è€ƒï¼šsendå’ŒrecvèƒŒåæ•°æ®çš„æ”¶å‘è¿‡ç¨‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=https%3A//blog.csdn.net/luckywang1103/article/details/51422664">linux netå­ç³»ç»Ÿ-åè®®å±‚ï¼ˆä¼ è¾“å±‚ä¸ç½‘ç»œå±‚)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.zhihu.com/?target=http%3A//kerneltravel.net/blog/2020/network_ljr_no1/">LINUXå†…æ ¸ç½‘ç»œï¼ˆä¸€ï¼‰â€”â€”åˆæ¢å†…æ ¸ç½‘ç»œ&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>