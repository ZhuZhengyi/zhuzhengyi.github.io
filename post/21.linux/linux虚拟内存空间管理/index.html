<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Linux虚拟内存空间管理 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Linux虚拟内存空间管理 段 在 32 位的操作系统中，每个进程都拥有 4GB 的虚拟内存空间。 Linux 根据功能上的差异，把整个虚拟内存空间划分为多个不同区间，称">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/21.linux/linux%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Linux虚拟内存空间管理">
<meta property="og:description" content="Linux虚拟内存空间管理 段 在 32 位的操作系统中，每个进程都拥有 4GB 的虚拟内存空间。 Linux 根据功能上的差异，把整个虚拟内存空间划分为多个不同区间，称">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/21.linux/linux%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2023-06-27T10:28:19+08:00">
<meta property="article:modified_time" content="2023-06-27T10:28:19+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Linux虚拟内存空间管理">
<meta itemprop=description content="Linux虚拟内存空间管理 段 在 32 位的操作系统中，每个进程都拥有 4GB 的虚拟内存空间。 Linux 根据功能上的差异，把整个虚拟内存空间划分为多个不同区间，称"><meta itemprop=datePublished content="2023-06-27T10:28:19+08:00">
<meta itemprop=dateModified content="2023-06-27T10:28:19+08:00">
<meta itemprop=wordCount content="3012">
<meta itemprop=keywords content="linux,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Linux虚拟内存空间管理">
<meta name=twitter:description content="Linux虚拟内存空间管理 段 在 32 位的操作系统中，每个进程都拥有 4GB 的虚拟内存空间。 Linux 根据功能上的差异，把整个虚拟内存空间划分为多个不同区间，称"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn style=display:inline-block href=javascript:void(0);>
<span class=icon-search>FastSearch</span>
</a>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Linux虚拟内存空间管理</h1>
<div class=post-meta>
<time datetime=2023-06-27 class=post-time>
2023-06-27 10:28:19
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/linux/> linux </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#段>段</a></li>
<li><a href=#虚拟内存区>虚拟内存区</a></li>
<li><a href=#加载程序镜像>加载程序镜像</a>
<ul>
<li><a href=#elf文件>ELF文件</a></li>
<li><a href=#加载过程>加载过程</a></li>
</ul>
</li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=linux虚拟内存空间管理>Linux虚拟内存空间管理</h1>
<h2 id=段>段</h2>
<p>在 32 位的操作系统中，每个进程都拥有 4GB 的虚拟内存空间。</p>
<p>Linux 根据功能上的差异，把整个虚拟内存空间划分为多个不同区间，称为 <code>段</code>。</p>
<p>Linux 进程虚拟内存空间的布局图，如图 1 所示：</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2023/03/01-08-17-37-2023-03-01-08-17-30-image.png alt></p>
<p>进程的用户空间大小为 3GB。Linux 按照功能上的差异，把一个进程的用户空间划分为多个段，下面介绍一下各个段的作用：</p>
<ul>
<li><code>代码段</code>：用于存放程序中可执行代码的段。</li>
<li><code>数据段</code>：用于存放已经初始化的全局变量或静态变量的段。如在 C 语言中，使用语句 <code>int global = 10;</code> 定义的全局变量。</li>
<li><code>未初始化数据段</code>：用于存放未初始化的全局变量或静态变量的段。如在 C 语言中，使用语句 <code>int global;</code> 定义的全局变量。</li>
<li><code>堆</code>：用于存放使用 <code>malloc</code> 函数申请的内存。</li>
<li><code>mmap区</code>：用于存放使用 <code>mmap</code> 函数映射的内存区。</li>
<li><code>栈</code>：用于存放函数局部变量和函数参数。</li>
</ul>
<h2 id=虚拟内存区>虚拟内存区</h2>
<p>从上面的介绍可知，Linux 按照功能上的差异，把虚拟内存空间划分为多个 <code>段</code>。那么在内核中，是通过什么结构来管理这些段的呢？</p>
<blockquote>
<p>答案就是：<strong>vm_area_struct</strong>。</p>
</blockquote>
<p>内核通过 <code>vm_area_struct</code> 结构（虚拟内存区）来管理各个 <code>段</code>，其定义如下：</p>
<p>复制</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>struct</span> <span class=nx>vm_area_struct</span> <span class=p>{</span>
    <span class=nx>struct</span> <span class=nx>mm_struct</span> <span class=o>*</span><span class=nx>vm_mm</span><span class=p>;</span> <span class=cm>/* The address space we belong to. */</span>
    <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>vm_start</span><span class=p>;</span>  <span class=cm>/* Our start address within vm_mm. */</span>
    <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>vm_end</span><span class=p>;</span>    <span class=cm>/* The first byte after our end address within vm_mm. */</span>

    <span class=cm>/* linked list of VM areas per task, sorted by address */</span>
    <span class=nx>struct</span> <span class=nx>vm_area_struct</span> <span class=o>*</span><span class=nx>vm_next</span><span class=p>;</span>

    <span class=nx>pgprot_t</span> <span class=nx>vm_page_prot</span><span class=p>;</span>   <span class=cm>/* Access permissions of this VMA. */</span>
    <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>vm_flags</span><span class=p>;</span>  <span class=cm>/* Flags, see mm.h. */</span>
    <span class=nx>struct</span> <span class=nx>rb_node</span> <span class=nx>vm_rb</span><span class=p>;</span>
    <span class=p>...</span>
    <span class=cm>/* Function pointers to deal with this struct. */</span>
    <span class=kr>const</span> <span class=nx>struct</span> <span class=nx>vm_operations_struct</span> <span class=o>*</span><span class=nx>vm_ops</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>};</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>下面介绍一下各个字段的作用：</p>
<ul>
<li><code>vm_mm</code>：指向进程的内存管理对象，每个进程都有一个类型为 <code>mm_struct</code> 的内存管理对象，用于管理进程的虚拟内存空间和内存映射等。</li>
<li><code>vm_start</code>：虚拟内存区的起始虚拟内存地址。</li>
<li><code>vm_end</code>：虚拟内存区的结束虚拟内存地址。</li>
<li><code>vm_next</code>：Linux 会通过链表把进程的所有虚拟内存区连接起来，这个字段用于指向下一个虚拟内存区。</li>
<li><code>vm_page_prot</code>：主要用于保存当前虚拟内存区所映射的物理内存页的读写权限。</li>
<li><code>vm_flags</code>：标识当前虚拟内存区的功能特性。</li>
<li><code>vm_rb</code>：某些场景中需要通过虚拟内存地址查找对应的虚拟内存区，为了加速查找过程，内核以虚拟内存地址作为key，把进程所有的虚拟内存区保存到一棵红黑树中，而这个字段就是红黑树的节点结构。</li>
<li><code>vm_ops</code>：每个虚拟内存区都可以自定义一套操作接口，通过操作接口，能够让虚拟内存区实现一些特定的功能，比如：把虚拟内存区映射到文件。而 <code>vm_ops</code> 字段就是虚拟内存区的操作接口集，一般在创建虚拟内存区时指定。</li>
</ul>
<p>我们通过图 2 来展示内核是怎么通过 <code>vm_area_struct</code> 结构来管理进程中的所有 <code>段</code>：</p>
<p><img src=https://ask.qcloudimg.com/http-save/yehe-7686797/20907977pa.png?imageView2/2/w/1620 alt></p>
<p>从上图可以看出，内核通过一个链表和一棵红黑树来管理进程中所有的 <code>段</code>。<code>mm_struct</code> 结构的 <code>mmap</code> 字段就是链表的头节点，而 <code>mm_rb</code> 字段就是红黑树的根节点。</p>
<h2 id=加载程序镜像>加载程序镜像</h2>
<p>前面我们介绍了 Linux 会把虚拟内存地址划分为多个 <code>段</code>，并且使用 <code>vm_area_struct</code> 结构来管理这些段。那么，这些虚拟内存区是怎么建立起来的呢？</p>
<p>在介绍进程虚拟内存区建立的过程前，我们先来简单介绍一下 <code>ELF文件格式</code>。</p>
<h3 id=elf文件>ELF文件</h3>
<p>ELF 全称 <strong>Executable and Linkable Format</strong>，即可执行可链接文件格式。在 Linux 系统中，就是使用这种文件格式来存储一个可执行的应用程序。让我们来看一下 ELF 文件格式由哪些结构组成：</p>
<p>一般一个 ELF 文件由以下三部分组成：</p>
<ul>
<li>ELF 头（ELF header）：描述应用程序的类型、CPU架构、入口地址、程序头表偏移和节头表偏移等等；</li>
<li>程序头表（Program header table）：列举了所有有效的段（segments）和他们的属性，程序头表需要加载器将文件中的段加载到虚拟内存段中；</li>
<li>节头表（Section header table）：包含对节（sections）的描述。</li>
</ul>
<p>ELF 文件的结构大概如图3所示：</p>
<p><img src=https://ask.qcloudimg.com/http-save/yehe-7686797/1ek0ihekji.png?imageView2/2/w/1620 alt></p>
<p>当内核加载一个应用程序时，就是通过读取 ELF 文件的信息，然后把文件中所有的段加载到虚拟内存的段中。ELF 文件通过 <code>程序头表</code> 来描述应用程序中所有的段，表中的每一个项都描述一个段的信息。我们先来看看 <code>程序头表</code> 项的结构定义：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>typedef</span> <span class=nx>struct</span> <span class=nx>elf64_phdr</span> <span class=p>{</span>
   <span class=nx>Elf64_Word</span> <span class=nx>p_type</span><span class=p>;</span>     <span class=c1>// 段的类型
</span><span class=c1></span>   <span class=nx>Elf64_Word</span> <span class=nx>p_flags</span><span class=p>;</span>    <span class=c1>// 可读写标志
</span><span class=c1></span>   <span class=nx>Elf64_Off</span> <span class=nx>p_offset</span><span class=p>;</span>    <span class=c1>// 段在ELF文件中的偏移量
</span><span class=c1></span>   <span class=nx>Elf64_Addr</span> <span class=nx>p_vaddr</span><span class=p>;</span>    <span class=c1>// 段的虚拟内存地址
</span><span class=c1></span>   <span class=nx>Elf64_Addr</span> <span class=nx>p_paddr</span><span class=p>;</span>    <span class=c1>// 段的物理内存地址
</span><span class=c1></span>   <span class=nx>Elf64_Xword</span> <span class=nx>p_filesz</span><span class=p>;</span>  <span class=c1>// 段占用文件的大小
</span><span class=c1></span>   <span class=nx>Elf64_Xword</span> <span class=nx>p_memsz</span><span class=p>;</span>   <span class=c1>// 段占用内存的大小
</span><span class=c1></span>   <span class=nx>Elf64_Xword</span> <span class=nx>p_align</span><span class=p>;</span>   <span class=c1>// 内存对齐
</span><span class=c1></span><span class=p>}</span> <span class=nx>Elf64_Phdr</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>所以，程序加载器可以通过 ELF 头中获取到程序头表的偏移量，然后通过程序头表的偏移量读取到程序头表的数据，再通过程序头表来获取到所有段的信息。</p>
<p>我们可以通过 <code>readelf -S file</code> 命令来查看 ELF 文件的段（节）信息，如下图所示：</p>
<p><img src=https://ask.qcloudimg.com/http-save/yehe-7686797/lxgeyl149c.png?imageView2/2/w/1620 alt></p>
<p>上面列出了 <code>代码段</code>、<code>数据段</code>、<code>未初始化数据段</code> 和 <code>注释段</code> 的信息。</p>
<h3 id=加载过程>加载过程</h3>
<p>要加载一个程序，需要调用 <code>execve</code> 系统调用来完成。我们来看看 <code>execve</code> 系统调用的调用栈：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>sys_execve</span>
<span class=err>└→</span> <span class=nx>do_execve</span>
  <span class=err>└→</span> <span class=nx>do_execveat_common</span>
     <span class=err>└→</span> <span class=mi>__</span><span class=nx>do_execve_file</span>
        <span class=err>└→</span> <span class=nx>exec_binprm</span>
           <span class=err>└→</span> <span class=nx>search_binary_handler</span>
              <span class=err>└→</span> <span class=nx>load_elf_binary</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>复制</p>
<p>从上面的调用者可以看出，<code>execve</code> 系统调用最终会调用 <code>load_elf_binary</code> 函数来加载程序的 ELF 文件。</p>
<p>由于 <code>load_elf_binary</code> 函数的实现比较复杂，所以我们分段来解说：</p>
<p><strong>（1）读取并检查ELF头</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kr>static</span> <span class=kr>int</span> <span class=nx>load_elf_binary</span><span class=p>(</span><span class=nx>struct</span> <span class=nx>linux_binprm</span> <span class=o>*</span><span class=nx>bprm</span><span class=p>,</span> <span class=nx>struct</span> <span class=nx>pt_regs</span> <span class=o>*</span><span class=nx>regs</span><span class=p>)</span>
<span class=p>{</span>
   <span class=p>...</span>
   <span class=nx>struct</span> <span class=p>{</span>
       <span class=nx>struct</span> <span class=nx>elfhdr</span> <span class=nx>elf_ex</span><span class=p>;</span>
       <span class=nx>struct</span> <span class=nx>elfhdr</span> <span class=nx>interp_elf_ex</span><span class=p>;</span>
   <span class=p>}</span> <span class=o>*</span><span class=nx>loc</span><span class=p>;</span>

   <span class=nx>loc</span> <span class=o>=</span> <span class=nx>kmalloc</span><span class=p>(</span><span class=nx>sizeof</span><span class=p>(</span><span class=o>*</span><span class=nx>loc</span><span class=p>),</span> <span class=nx>GFP_KERNEL</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>loc</span><span class=p>)</span> <span class=p>{</span>
       <span class=nx>retval</span> <span class=o>=</span> <span class=o>-</span><span class=nx>ENOMEM</span><span class=p>;</span>
       <span class=kr>goto</span> <span class=nx>out_ret</span><span class=p>;</span>
   <span class=p>}</span>

   <span class=c1>// 1. 获取ELF头
</span><span class=c1></span>   <span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=nx>struct</span> <span class=nx>elfhdr</span> <span class=o>*</span><span class=p>)</span><span class=nx>bprm</span><span class=o>-&gt;</span><span class=nx>buf</span><span class=p>);</span>

   <span class=nx>retval</span> <span class=o>=</span> <span class=o>-</span><span class=nx>ENOEXEC</span><span class=p>;</span>
   <span class=c1>// 2. 检查ELF签名是否正确
</span><span class=c1></span>   <span class=k>if</span> <span class=p>(</span><span class=nx>memcmp</span><span class=p>(</span><span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>.</span><span class=nx>e_ident</span><span class=p>,</span> <span class=nx>ELFMAG</span><span class=p>,</span> <span class=nx>SELFMAG</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
       <span class=kr>goto</span> <span class=nx>out</span><span class=p>;</span>

   <span class=c1>// 3. 是否是可执行文件或者动态库
</span><span class=c1></span>   <span class=k>if</span> <span class=p>(</span><span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>.</span><span class=nx>e_type</span> <span class=o>!=</span> <span class=nx>ET_EXEC</span> <span class=o>&amp;&amp;</span> <span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>.</span><span class=nx>e_type</span> <span class=o>!=</span> <span class=nx>ET_DYN</span><span class=p>)</span>
       <span class=kr>goto</span> <span class=nx>out</span><span class=p>;</span>

   <span class=c1>// 4. 检查系统架构是否正确
</span><span class=c1></span>   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>elf_check_arch</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>))</span>
       <span class=kr>goto</span> <span class=nx>out</span><span class=p>;</span>
   <span class=p>...</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>复制</p>
<p>上面这段代码主要是读取应用程序的 ELF 头，然后检查 ELF 头信息是否合法。</p>
<p><strong>（2）读取程序头表</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript>   <span class=nx>size</span> <span class=o>=</span> <span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>.</span><span class=nx>e_phnum</span> <span class=o>*</span> <span class=nx>sizeof</span><span class=p>(</span><span class=nx>struct</span> <span class=nx>elf_phdr</span><span class=p>);</span> <span class=c1>// 程序头表的大小
</span><span class=c1></span>   <span class=nx>retval</span> <span class=o>=</span> <span class=o>-</span><span class=nx>ENOMEM</span><span class=p>;</span>

   <span class=nx>elf_phdata</span> <span class=o>=</span> <span class=nx>kmalloc</span><span class=p>(</span><span class=nx>size</span><span class=p>,</span> <span class=nx>GFP_KERNEL</span><span class=p>);</span> <span class=c1>// 申请一块内存来保存程序头表
</span><span class=c1></span>   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>elf_phdata</span><span class=p>)</span>
       <span class=kr>goto</span> <span class=nx>out</span><span class=p>;</span>

<span class=c1>// 从ELF文件中读取程序头表的数据, 并且保存到 elf_phdata 变量中
</span><span class=c1></span>   <span class=nx>retval</span> <span class=o>=</span> <span class=nx>kernel_read</span><span class=p>(</span><span class=nx>bprm</span><span class=o>-&gt;</span><span class=nx>file</span><span class=p>,</span> <span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>.</span><span class=nx>e_phoff</span><span class=p>,</span> <span class=p>(</span><span class=kr>char</span> <span class=o>*</span><span class=p>)</span><span class=nx>elf_phdata</span><span class=p>,</span> <span class=nx>size</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=nx>retval</span> <span class=o>!=</span> <span class=nx>size</span><span class=p>)</span> <span class=p>{</span>
       <span class=k>if</span> <span class=p>(</span><span class=nx>retval</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
           <span class=nx>retval</span> <span class=o>=</span> <span class=o>-</span><span class=nx>EIO</span><span class=p>;</span>
       <span class=kr>goto</span> <span class=nx>out_free_ph</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>复制</p>
<p>上面的代码主要完成以下几个工作：</p>
<ul>
<li>从 ELF 头的信息中获取到程序头表的大小。</li>
<li>调用 <code>kmalloc</code> 函数申请一块内存来保存程序头表。</li>
<li>调用 <code>kernel_read</code> 函数从 ELF 文件中读取程序头表的数据，保存到 <code>elf_phdata</code> 变量中，程序头表的偏移量可以通过 ELF 头的 <code>e_phoff</code> 字段获取。</li>
</ul>
<p><strong>（3）加载段到虚拟内存</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript>   <span class=c1>// 遍历程序头表所有的段
</span><span class=c1></span>   <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>elf_ppnt</span> <span class=o>=</span> <span class=nx>elf_phdata</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>loc</span><span class=o>-&gt;</span><span class=nx>elf_ex</span><span class=p>.</span><span class=nx>e_phnum</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>,</span> <span class=nx>elf_ppnt</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
       <span class=kr>int</span> <span class=nx>elf_prot</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>elf_flags</span><span class=p>;</span>
       <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>vaddr</span><span class=p>;</span>

       <span class=k>if</span> <span class=p>(</span><span class=nx>elf_ppnt</span><span class=o>-&gt;</span><span class=nx>p_type</span> <span class=o>!=</span> <span class=nx>PT_LOAD</span><span class=p>)</span>  <span class=c1>// 判断段是否需要加载
</span><span class=c1></span>           <span class=k>continue</span><span class=p>;</span>
      <span class=p>...</span>
       <span class=c1>// 段的可读写权限
</span><span class=c1></span>       <span class=k>if</span> <span class=p>(</span><span class=nx>elf_ppnt</span><span class=o>-&gt;</span><span class=nx>p_flags</span> <span class=o>&amp;</span> <span class=nx>PF_R</span><span class=p>)</span>
           <span class=nx>elf_prot</span> <span class=o>|=</span> <span class=nx>PROT_READ</span><span class=p>;</span>
       <span class=k>if</span> <span class=p>(</span><span class=nx>elf_ppnt</span><span class=o>-&gt;</span><span class=nx>p_flags</span> <span class=o>&amp;</span> <span class=nx>PF_W</span><span class=p>)</span>
           <span class=nx>elf_prot</span> <span class=o>|=</span> <span class=nx>PROT_WRITE</span><span class=p>;</span>
       <span class=k>if</span> <span class=p>(</span><span class=nx>elf_ppnt</span><span class=o>-&gt;</span><span class=nx>p_flags</span> <span class=o>&amp;</span> <span class=nx>PF_X</span><span class=p>)</span>
           <span class=nx>elf_prot</span> <span class=o>|=</span> <span class=nx>PROT_EXEC</span><span class=p>;</span>

       <span class=nx>elf_flags</span> <span class=o>=</span> <span class=nx>MAP_PRIVATE</span> <span class=o>|</span> <span class=nx>MAP_DENYWRITE</span> <span class=o>|</span> <span class=nx>MAP_EXECUTABLE</span><span class=p>;</span>

       <span class=nx>vaddr</span> <span class=o>=</span> <span class=nx>elf_ppnt</span><span class=o>-&gt;</span><span class=nx>p_vaddr</span><span class=p>;</span>  <span class=c1>// 获取段的虚拟内存地址
</span><span class=c1></span>      <span class=p>...</span>
       <span class=c1>// 把段加载到虚拟内存
</span><span class=c1></span>       <span class=nx>error</span> <span class=o>=</span> <span class=nx>elf_map</span><span class=p>(</span><span class=nx>bprm</span><span class=o>-&gt;</span><span class=nx>file</span><span class=p>,</span> <span class=nx>load_bias</span> <span class=o>+</span> <span class=nx>vaddr</span><span class=p>,</span> <span class=nx>elf_ppnt</span><span class=p>,</span> <span class=nx>elf_prot</span><span class=p>,</span> <span class=nx>elf_flags</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
      <span class=p>...</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>复制</p>
<p>上面这段代码主要完成的工作是：</p>
<ul>
<li>遍历程序头表所有的段。</li>
<li>判断段是否需要加载。</li>
<li>获取段的可读写权限和段的虚拟内存地址。</li>
<li>调用 <code>elf_map</code> 函数把段加载到虚拟内存。</li>
</ul>
<p>所以，把段加载到虚拟内存主要通过 <code>elf_map</code> 函数完成。我们来看看 <code>elf_map</code> 函数的调用栈：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>elf_map</span>
<span class=err>└→</span> <span class=nx>do_mmap</span>
   <span class=err>└→</span> <span class=nx>do_mmap_pgoff</span>
      <span class=err>└→</span> <span class=nx>mmap_region</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>复制</p>
<p>从上面的调用者可以看出，<code>elf_map</code> 函数最终会调用 <code>mmap_region</code> 来完成加载段到虚拟内存。我们分析一下 <code>mmap_region</code> 函数的实现：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>unsigned</span> <span class=kr>long</span>
<span class=nx>mmap_region</span><span class=p>(</span><span class=nx>struct</span> <span class=nx>file</span> <span class=o>*</span><span class=nx>file</span><span class=p>,</span> <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>len</span><span class=p>,</span>
           <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>flags</span><span class=p>,</span> <span class=nx>unsigned</span> <span class=kr>int</span> <span class=nx>vm_flags</span><span class=p>,</span> <span class=nx>unsigned</span> <span class=kr>long</span> <span class=nx>pgoff</span><span class=p>)</span>
<span class=p>{</span>
   <span class=nx>struct</span> <span class=nx>mm_struct</span> <span class=o>*</span><span class=nx>mm</span> <span class=o>=</span> <span class=nx>current</span><span class=o>-&gt;</span><span class=nx>mm</span><span class=p>;</span>
   <span class=nx>struct</span> <span class=nx>vm_area_struct</span> <span class=o>*</span><span class=nx>vma</span><span class=p>,</span> <span class=o>*</span><span class=nx>prev</span><span class=p>;</span>
  <span class=p>...</span>
   <span class=c1>// 申请一个 vm_area_struct 结构
</span><span class=c1></span>   <span class=nx>vma</span> <span class=o>=</span> <span class=nx>kmem_cache_zalloc</span><span class=p>(</span><span class=nx>vm_area_cachep</span><span class=p>,</span> <span class=nx>GFP_KERNEL</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>vma</span><span class=p>)</span> <span class=p>{</span>
       <span class=nx>error</span> <span class=o>=</span> <span class=o>-</span><span class=nx>ENOMEM</span><span class=p>;</span>
       <span class=kr>goto</span> <span class=nx>unacct_error</span><span class=p>;</span>
  <span class=p>}</span>

   <span class=c1>// 设置 vm_area_struct 结构各个字段的值
</span><span class=c1></span>   <span class=nx>vma</span><span class=o>-&gt;</span><span class=nx>vm_mm</span> <span class=o>=</span> <span class=nx>mm</span><span class=p>;</span>
   <span class=nx>vma</span><span class=o>-&gt;</span><span class=nx>vm_start</span> <span class=o>=</span> <span class=nx>addr</span><span class=p>;</span>        <span class=c1>// 段的开始虚拟内存地址
</span><span class=c1></span>   <span class=nx>vma</span><span class=o>-&gt;</span><span class=nx>vm_end</span> <span class=o>=</span> <span class=nx>addr</span> <span class=o>+</span> <span class=nx>len</span><span class=p>;</span>    <span class=c1>// 段的结束虚拟内存地址
</span><span class=c1></span>   <span class=nx>vma</span><span class=o>-&gt;</span><span class=nx>vm_flags</span> <span class=o>=</span> <span class=nx>vm_flags</span><span class=p>;</span>    <span class=c1>// 段的功能特性
</span><span class=c1></span>   <span class=nx>vma</span><span class=o>-&gt;</span><span class=nx>vm_page_prot</span> <span class=o>=</span> <span class=nx>vm_get_page_prot</span><span class=p>(</span><span class=nx>vm_flags</span><span class=p>);</span>
   <span class=nx>vma</span><span class=o>-&gt;</span><span class=nx>vm_pgoff</span> <span class=o>=</span> <span class=nx>pgoff</span><span class=p>;</span>

  <span class=p>...</span>
   <span class=c1>// 把 vm_area_struct 结构连接到虚拟内存区链表和红黑树中
</span><span class=c1></span>   <span class=nx>vma_link</span><span class=p>(</span><span class=nx>mm</span><span class=p>,</span> <span class=nx>vma</span><span class=p>,</span> <span class=nx>prev</span><span class=p>,</span> <span class=nx>rb_link</span><span class=p>,</span> <span class=nx>rb_parent</span><span class=p>);</span>
  <span class=p>...</span>

   <span class=k>return</span> <span class=nx>addr</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>复制</p>
<p>上面代码对 <code>mmap_region</code> 函数进行了精简，精简后的工作主要有：</p>
<ul>
<li>调用 <code>kmem_cache_zalloc</code> 函数申请一个 <code>vm_area_struct</code>（虚拟内存区）结构。</li>
<li>设置 <code>vm_area_struct</code> 结构各个字段的值。</li>
<li>调用 <code>vma_link</code> 函数把 <code>vm_area_struct</code> 结构连接到虚拟内存区链表和红黑树中。</li>
</ul>
<p>通过上面的过程，内核就把应用程序的所有段加载到虚拟内存中。</p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p><a href=https://cloud.tencent.com/developer/article/1835295>完全剖析 - Linux虚拟内存空间管理 - 腾讯云开发者社区-腾讯云</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA3NzYzODg1OA==&mid=2648464745&idx=1&sn=374b770823d0a9e9677386160e57f71c&scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzA3NzYzODg1OA==&mid=2648464745&idx=1&sn=374b770823d0a9e9677386160e57f71c&scene=21#wechat_redirect</a></p>
</li>
<li>
<p><a href=https://wangxuemin.github.io/2015/07/30/LINUX%E7%A8%8B%E5%BA%8F(%E8%BF%9B%E7%A8%8B)%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%B8%83%E5%B1%80/>LINUX程序(进程)在内存中的布局 | mumumuwudi的博客</a></p>
</li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2023-06-27 10:28:19
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/linux/>linux</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/leetcode/2351.%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%87%BA%E7%8E%B0%E4%B8%A4%E6%AC%A1%E7%9A%84%E5%AD%97%E6%AF%8D/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">第一个出现两次的字母</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/leetcode/474.%E4%B8%80%E5%92%8C%E9%9B%B6/>
<span class="next-text nav-default">一和零</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
</body>
</html>