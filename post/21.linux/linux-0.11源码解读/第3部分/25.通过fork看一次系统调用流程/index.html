<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>25.fork调用 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="25.fork调用 书接上回，上回书咱们说到，我们通过自己设计了一遍进程调度，又看了一次 Linux 0.11 的进程调度的全过程。有了这两回做铺垫，我们下一回就">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC3%E9%83%A8%E5%88%86/25.%E9%80%9A%E8%BF%87fork%E7%9C%8B%E4%B8%80%E6%AC%A1%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.59a446ca0f76fe2dfc772a3a0b7512965043b4433e3e0dcf5b8ebeede14fae0c.css integrity="sha256-WaRGyg92/i38dyo6C3USllBDtEM+Pg3PW46+7eFPrgw=" media=screen crossorigin=anonymous>
<meta property="og:title" content="25.fork调用">
<meta property="og:description" content="25.fork调用 书接上回，上回书咱们说到，我们通过自己设计了一遍进程调度，又看了一次 Linux 0.11 的进程调度的全过程。有了这两回做铺垫，我们下一回就">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC3%E9%83%A8%E5%88%86/25.%E9%80%9A%E8%BF%87fork%E7%9C%8B%E4%B8%80%E6%AC%A1%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2024-01-08T06:47:33+08:00">
<meta property="article:modified_time" content="2024-01-08T06:47:33+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="25.fork调用">
<meta itemprop=description content="25.fork调用 书接上回，上回书咱们说到，我们通过自己设计了一遍进程调度，又看了一次 Linux 0.11 的进程调度的全过程。有了这两回做铺垫，我们下一回就"><meta itemprop=datePublished content="2024-01-08T06:47:33+08:00">
<meta itemprop=dateModified content="2024-01-08T06:47:33+08:00">
<meta itemprop=wordCount content="2348">
<meta itemprop=keywords content="linux,linux-0.11源码解读,第3部分,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="25.fork调用">
<meta name=twitter:description content="25.fork调用 书接上回，上回书咱们说到，我们通过自己设计了一遍进程调度，又看了一次 Linux 0.11 的进程调度的全过程。有了这两回做铺垫，我们下一回就"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>25.fork调用</h1>
<div class=post-meta>
<time datetime=2024-01-08 class=post-time>
2024-01-08 06:47:33
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/linux/> linux </a>
<a href=https://justice.bj.cn/categories/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/> linux-0.11源码解读 </a>
<a href=https://justice.bj.cn/categories/%E7%AC%AC3%E9%83%A8%E5%88%86/> 第3部分 </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents></nav>
</div>
</div>
<div class=post-content>
<h1 id=25fork调用>25.fork调用</h1>
<p>书接上回，上回书咱们说到，我们通过自己设计了一遍进程调度，又看了一次 Linux 0.11 的进程调度的全过程。有了这两回做铺垫，我们下一回就该非常自信地回到我们的主流程！</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>        
    <span class=n>move_to_user_mode</span><span class=p>();</span>    
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>fork</span><span class=p>())</span> <span class=p>{</span>        
        <span class=n>init</span><span class=p>();</span>    
    <span class=p>}</span>    
    <span class=k>for</span><span class=p>(;;)</span> <span class=n>pause</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>也就是这个 fork 函数干了啥？</p>
<p>这个 fork 函数稍稍绕了点，我们看如下代码。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kr>_inline</span> <span class=nf>_syscall0</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=n>fork</span><span class=p>)</span>
<span class=cp>#define _syscall0(type,name) \
</span><span class=cp>    type name(void) \
</span><span class=cp>    </span><span class=p>{</span> \
        <span class=kt>long</span> <span class=n>__res</span><span class=p>;</span> \
        <span class=n>__asm__</span> <span class=k>volatile</span> <span class=p>(</span><span class=s>&#34;int $0x80&#34;</span> \
                        <span class=o>:</span> <span class=s>&#34;=a&#34;</span> <span class=p>(</span><span class=n>__res</span><span class=p>)</span> <span class=err>\</span>    
                        <span class=o>:</span> <span class=s>&#34;0&#34;</span> <span class=p>(</span><span class=n>__NR_</span><span class=err>##</span><span class=n>name</span><span class=p>));</span> \
        <span class=k>if</span> <span class=p>(</span><span class=n>__res</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=err>\</span>    
            <span class=k>return</span> <span class=p>(</span><span class=n>type</span><span class=p>)</span> <span class=n>__res</span><span class=p>;</span> \
        <span class=n>errno</span> <span class=o>=</span> <span class=o>-</span><span class=n>__res</span><span class=p>;</span> \
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> \
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>别急，我把它变成稍稍能看得懂的样子，就是这样。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define _syscall0(type,name) \
</span><span class=cp>    type name(void) \
</span><span class=cp>    { \    
</span><span class=cp></span>        <span class=k>volatile</span> <span class=kt>long</span> <span class=n>__res</span><span class=p>;</span> <span class=err>\</span>    
        <span class=n>_asm</span> <span class=p>{</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=n>__NR_</span><span class=err>##</span><span class=n>name</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=kt>int</span> <span class=mi>80</span><span class=n>h</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>__res</span><span class=p>,</span><span class=n>eax</span> <span class=err>\</span>    
        <span class=p>}</span> <span class=err>\</span>    
        <span class=k>if</span> <span class=p>(</span><span class=n>__res</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=err>\</span>        
            <span class=k>return</span> <span class=p>(</span><span class=n>type</span><span class=p>)</span> <span class=n>__res</span><span class=p>;</span> <span class=err>\</span>    
        <span class=n>errno</span> <span class=o>=</span> <span class=o>-</span><span class=n>__res</span><span class=p>;</span> <span class=err>\</span>    
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> \
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以，把宏定义都展开，其实就相当于<strong>定义了一个函数</strong>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>     
    <span class=k>volatile</span> <span class=kt>long</span> <span class=n>__res</span><span class=p>;</span>    
    <span class=n>_asm</span> <span class=p>{</span>        
        <span class=n>_asm</span> <span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=n>__NR_fork</span>        
        <span class=n>_asm</span> <span class=kt>int</span> <span class=mi>80</span><span class=n>h</span>        
        <span class=n>_asm</span> <span class=n>mov</span> <span class=n>__res</span><span class=p>,</span><span class=n>eax</span>    
    <span class=p>}</span>    
    <span class=k>if</span> <span class=p>(</span><span class=n>__res</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>        
        <span class=k>return</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=n>__res</span><span class=p>;</span>    
    <span class=n>errno</span> <span class=o>=</span> <span class=o>-</span><span class=n>__res</span><span class=p>;</span>    
    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>仅此而已。</p>
<p>具体看一下 fork 函数里面的代码，又是讨厌的内联汇编，不过上面我已经变成好看一点的样子了，而且不用你看懂，听我说就行。</p>
<p>关键指令就是一个 0x80 号软中断的触发，<strong>int 80h</strong>。</p>
<p>其中还有一个 eax 寄存器里的参数是 <strong>__NR_fork</strong>，这也是个宏定义，值是 <strong>2</strong>。</p>
<p>OK，还记得 0x80 号中断的处理函数么？这个是我们在 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247500496&idx=1&sn=3bddde6c68c2b03d9721ba74e949cfa8&chksm=c2c5b87df5b2316b083015a4fdba2df29211f38fcfd1cdb040e02ab410432608e26383a43ef5&scene=21#wechat_redirect">第18回 | 大名鼎鼎的进程调度就是从这里开始的</a> <strong>sched_init</strong> 里面设置的。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>set_system_gate</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>system_call</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>看这个 system_call 的汇编代码，我们发现这么一行。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=nl>_system_call:</span><span class=err>    </span>
<span class=err>    </span><span class=nf>...</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=p>[</span><span class=nv>_sys_call_table</span><span class=err> </span><span class=o>+</span><span class=err> </span><span class=nb>eax</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span><span class=err>    </span>
<span class=err>    </span><span class=nf>...</span>
</code></pre></td></tr></table>
</div>
</div><p>刚刚那个值就用上了，eax 寄存器里的值是 2，所以这个就是在这个 <strong>sys_call_table</strong> 表里找下标 2 位置处的函数，然后跳转过去。</p>
<p>那我们接着看 sys_call_table 是个啥。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>fn_ptr</span> <span class=n>sys_call_table</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span> 
    <span class=n>sys_setup</span><span class=p>,</span> <span class=n>sys_exit</span><span class=p>,</span> <span class=n>sys_fork</span><span class=p>,</span> <span class=n>sys_read</span><span class=p>,</span>  
    <span class=n>sys_write</span><span class=p>,</span> <span class=n>sys_open</span><span class=p>,</span> <span class=n>sys_close</span><span class=p>,</span> <span class=n>sys_waitpid</span><span class=p>,</span> 
    <span class=n>sys_creat</span><span class=p>,</span> <span class=n>sys_link</span><span class=p>,</span>  <span class=n>sys_unlink</span><span class=p>,</span> <span class=n>sys_execve</span><span class=p>,</span> 
    <span class=n>sys_chdir</span><span class=p>,</span> <span class=n>sys_time</span><span class=p>,</span> <span class=n>sys_mknod</span><span class=p>,</span> <span class=n>sys_chmod</span><span class=p>,</span>  
    <span class=n>sys_chown</span><span class=p>,</span> <span class=n>sys_break</span><span class=p>,</span> <span class=n>sys_stat</span><span class=p>,</span> <span class=n>sys_lseek</span><span class=p>,</span> 
    <span class=n>sys_getpid</span><span class=p>,</span> <span class=n>sys_mount</span><span class=p>,</span>  <span class=n>sys_umount</span><span class=p>,</span> <span class=n>sys_setuid</span><span class=p>,</span> 
    <span class=n>sys_getuid</span><span class=p>,</span> <span class=n>sys_stime</span><span class=p>,</span> <span class=n>sys_ptrace</span><span class=p>,</span> <span class=n>sys_alarm</span><span class=p>,</span>  
    <span class=n>sys_fstat</span><span class=p>,</span> <span class=n>sys_pause</span><span class=p>,</span> <span class=n>sys_utime</span><span class=p>,</span> <span class=n>sys_stty</span><span class=p>,</span> 
    <span class=n>sys_gtty</span><span class=p>,</span> <span class=n>sys_access</span><span class=p>,</span>  <span class=n>sys_nice</span><span class=p>,</span> <span class=n>sys_ftime</span><span class=p>,</span> 
    <span class=n>sys_sync</span><span class=p>,</span> <span class=n>sys_kill</span><span class=p>,</span> <span class=n>sys_rename</span><span class=p>,</span> <span class=n>sys_mkdir</span><span class=p>,</span>  
    <span class=n>sys_rmdir</span><span class=p>,</span> <span class=n>sys_dup</span><span class=p>,</span> <span class=n>sys_pipe</span><span class=p>,</span> <span class=n>sys_times</span><span class=p>,</span> <span class=n>sys_prof</span><span class=p>,</span> 
    <span class=n>sys_brk</span><span class=p>,</span> <span class=n>sys_setgid</span><span class=p>,</span>  <span class=n>sys_getgid</span><span class=p>,</span> <span class=n>sys_signal</span><span class=p>,</span> 
    <span class=n>sys_geteuid</span><span class=p>,</span> <span class=n>sys_getegid</span><span class=p>,</span> <span class=n>sys_acct</span><span class=p>,</span> <span class=n>sys_phys</span><span class=p>,</span>  
    <span class=n>sys_lock</span><span class=p>,</span> <span class=n>sys_ioctl</span><span class=p>,</span> <span class=n>sys_fcntl</span><span class=p>,</span> <span class=n>sys_mpx</span><span class=p>,</span> <span class=n>sys_setpgid</span><span class=p>,</span> 
    <span class=n>sys_ulimit</span><span class=p>,</span>  <span class=n>sys_uname</span><span class=p>,</span> <span class=n>sys_umask</span><span class=p>,</span> <span class=n>sys_chroot</span><span class=p>,</span> <span class=n>sys_ustat</span><span class=p>,</span> 
    <span class=n>sys_dup2</span><span class=p>,</span> <span class=n>sys_getppid</span><span class=p>,</span>  <span class=n>sys_getpgrp</span><span class=p>,</span> <span class=n>sys_setsid</span><span class=p>,</span> 
    <span class=n>sys_sigaction</span><span class=p>,</span> <span class=n>sys_sgetmask</span><span class=p>,</span> <span class=n>sys_ssetmask</span><span class=p>,</span>  
    <span class=n>sys_setreuid</span><span class=p>,</span> <span class=n>sys_setregid</span>
<span class=p>};</span>
</code></pre></td></tr></table>
</div>
</div><p>看到没，就是各种函数指针组成的一个数组，说白了就是个系统调用函数表。</p>
<p>那下标 2 位置处是啥？从第零项开始数，第二项就是 <strong>sys_fork</strong> 函数！</p>
<p>至此，我们终于找到了 fork 函数，通过系统调用这个中断，最终走到内核层面的函数是什么，就是 sys_fork。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=nl>_sys_fork:</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=nv>_find_empty_process</span><span class=err>    </span>
<span class=err>    </span><span class=nf>testl</span><span class=err> </span><span class=o>%</span><span class=nb>eax</span><span class=p>,</span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>js</span><span class=err> </span><span class=mi>1</span><span class=nv>f</span><span class=err>    </span>
<span class=err>    </span><span class=nf>push</span><span class=err> </span><span class=o>%</span><span class=nb>gs</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>esi</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>edi</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>ebp</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=nv>_copy_process</span><span class=err>    </span>
<span class=err>    </span><span class=nf>addl</span><span class=err> </span><span class=kc>$</span><span class=mi>20</span><span class=p>,</span><span class=o>%</span><span class=nb>esp</span>
<span class=err>1:  </span>
<span class=err>    </span><span class=nf>ret</span>
</code></pre></td></tr></table>
</div>
</div><p>至于这个函数是什么，我们下一讲再说。</p>
<p>从这讲的探索我们也可以看出，操作系统通过<strong>系统调用</strong>，提供给用户态可用的功能，都暴露在 <strong>sys_call_table</strong> 里了。</p>
<p>系统调用统一通过 <strong>int 0x80</strong> 中断来进入，具体调用这个表里的哪个功能函数，就由 <strong>eax</strong> 寄存器传过来，这里的值是个数组索引的下标，通过这个下标就可以找到在 sys_call_table 这个数组里的具体函数。</p>
<p>同时也可以看出，用户进程调用内核的功能，可以直接通过写一句 int 0x80 汇编指令，并且给 eax 赋值，当然这样就比较麻烦。</p>
<p>所以也可以直接调用 fork 这样的包装好的方法，而这个方法里本质也是 int 0x80 以及 eax 赋值而已。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-16-35-28-e71bef13b407d0f4405f778c7cf03a80.png alt=图片></p>
<p>本讲就借着这个机会，讲讲系统调用的玩法，你学会了么？</p>
<hr>
<p>那我们再多说两句，刚刚定义 fork 的系统调用模板函数时，用的是 <strong>syscall0</strong>，其实这个表示参数个数为 0，也就是 sys_fork 函数并不需要任何参数。</p>
<p>所以其实，在 unistd.h 头文件里，还定义了 syscall0 ~ syscall3 一共四个宏。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define _syscall0(type,name)
</span><span class=cp>#define _syscall1(type,name,atype,a)
</span><span class=cp>#define _syscall2(type,name,atype,a,btype,b)
</span><span class=cp>#define _syscall3(type,name,atype,a,btype,b,ctype,c)
</span></code></pre></td></tr></table>
</div>
</div><p>看都能看出来，其实 <strong>syscall1</strong> 就表示有<strong>一个参数</strong>，<strong>syscall2</strong> 就表示有<strong>两个参数</strong>。</p>
<p>哎，就这么简单。</p>
<p>那这些参数放在哪里了呢？总得有个约定的地方吧？</p>
<p>我们看一个今后要讲的重点函数，<strong>execve</strong>，是一个通常和 fork 在一起配合的变身函数，在之后的进程 1 创建进程 2 的过程中，就是这样玩的。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>pid</span><span class=o>=</span><span class=n>fork</span><span class=p>()))</span> <span class=p>{</span>        
        <span class=p>...</span>        
        <span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=n>argv_rc</span><span class=p>,</span><span class=n>envp_rc</span><span class=p>);</span>        
        <span class=p>...</span>    
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>当然我们的重点不是研究这个函数的作用，仅仅把它当做研究 syscall3 的一个例子，因为它的宏定义就是 <strong>syscall3</strong>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=n>argv_rc</span><span class=p>,</span><span class=n>envp_rc</span><span class=p>);</span>
<span class=n>_syscall3</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=n>execve</span><span class=p>,</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>,</span><span class=n>file</span><span class=p>,</span><span class=kt>char</span> <span class=o>**</span><span class=p>,</span><span class=n>argv</span><span class=p>,</span><span class=kt>char</span> <span class=o>**</span><span class=p>,</span><span class=n>envp</span><span class=p>)</span>
<span class=cp>#define _syscall3(type,name,atype,a,btype,b,ctype,c) \
</span><span class=cp>    type name(atype a,btype b,ctype c) { \    
</span><span class=cp></span>        <span class=k>volatile</span> <span class=kt>long</span> <span class=n>__res</span><span class=p>;</span> <span class=err>\</span>    
        <span class=n>_asm</span> <span class=p>{</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=n>__NR_</span><span class=err>##</span><span class=n>name</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>ebx</span><span class=p>,</span><span class=n>a</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>ecx</span><span class=p>,</span><span class=n>b</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>edx</span><span class=p>,</span><span class=n>c</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=kt>int</span> <span class=mi>80</span><span class=n>h</span> <span class=err>\</span>        
            <span class=n>_asm</span> <span class=n>mov</span> <span class=n>__res</span><span class=p>,</span><span class=n>eax</span><span class=err>\</span>    
        <span class=p>}</span> <span class=err>\</span>    
        <span class=k>if</span> <span class=p>(</span><span class=n>__res</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=err>\</span>        
            <span class=k>return</span> <span class=p>(</span><span class=n>type</span><span class=p>)</span> <span class=n>__res</span><span class=p>;</span> <span class=err>\</span>    
        <span class=n>errno</span> <span class=o>=</span> <span class=o>-</span><span class=n>__res</span><span class=p>;</span> <span class=err>\</span>    
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> \
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看出，<strong>参数 a 被放在了 ebx 寄存器，参数 b 被放在了 ecx 寄存器，参数 c 被放在了 edx 寄存器</strong>。</p>
<p>我们再打开 system_call 的代码，刚刚我们只看了它的关键一行，就是去系统调用表里找函数。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=nl>_system_call:</span><span class=err>    </span>
<span class=err>    </span><span class=nf>...</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=p>[</span><span class=nv>_sys_call_table</span><span class=err> </span><span class=o>+</span><span class=err> </span><span class=nb>eax</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span><span class=err>    </span>
<span class=err>    </span><span class=nf>...</span>
</code></pre></td></tr></table>
</div>
</div><p>我们再看看全貌。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=nl>_system_call:</span><span class=err>    </span>
<span class=err>    </span><span class=nf>cmpl</span><span class=err> </span><span class=kc>$</span><span class=nv>nr_system_calls</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>ja</span><span class=err> </span><span class=nv>bad_sys_call</span><span class=err>    </span>
<span class=err>    </span><span class=nf>push</span><span class=err> </span><span class=o>%</span><span class=nb>ds</span><span class=err>    </span>
<span class=err>    </span><span class=nf>push</span><span class=err> </span><span class=o>%</span><span class=nb>es</span><span class=err>    </span>
<span class=err>    </span><span class=nf>push</span><span class=err> </span><span class=o>%</span><span class=nb>fs</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>edx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=err>      </span>
<span class=err>    # </span><span class=nf>push</span><span class=err> </span><span class=o>%</span><span class=nb>ebx</span><span class=p>,</span><span class=o>%</span><span class=nb>ecx</span><span class=p>,</span><span class=o>%</span><span class=nb>edx</span><span class=err> </span><span class=nv>as</span><span class=err> </span><span class=nv>parameters</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>ebx</span><span class=err>      # </span><span class=nv>to</span><span class=err> </span><span class=nv>the</span><span class=err> </span><span class=nv>system</span><span class=err> </span><span class=nv>call</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=kc>$</span><span class=mh>0x10</span><span class=p>,</span><span class=o>%</span><span class=nb>edx</span><span class=err>     # </span><span class=nv>set</span><span class=err> </span><span class=nv>up</span><span class=err> </span><span class=nb>ds</span><span class=p>,</span><span class=nb>es</span><span class=err> </span><span class=nv>to</span><span class=err> </span><span class=nv>kernel</span><span class=err> </span><span class=nb>sp</span><span class=nv>ace</span><span class=err>    </span>
<span class=err>    </span><span class=nf>mov</span><span class=err> </span><span class=o>%</span><span class=nb>dx</span><span class=p>,</span><span class=o>%</span><span class=nb>ds</span><span class=err>    </span>
<span class=err>    </span><span class=nf>mov</span><span class=err> </span><span class=o>%</span><span class=nb>dx</span><span class=p>,</span><span class=o>%</span><span class=nb>es</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=kc>$</span><span class=mh>0x17</span><span class=p>,</span><span class=o>%</span><span class=nb>edx</span><span class=err>     # </span><span class=nb>fs</span><span class=err> </span><span class=nv>points</span><span class=err> </span><span class=nv>to</span><span class=err> </span><span class=nv>local</span><span class=err> </span><span class=nv>data</span><span class=err> </span><span class=nb>sp</span><span class=nv>ace</span><span class=err>    </span>
<span class=err>    </span><span class=nf>mov</span><span class=err> </span><span class=o>%</span><span class=nb>dx</span><span class=p>,</span><span class=o>%</span><span class=nb>fs</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=nv>_sys_call_table</span><span class=p>(,</span><span class=o>%</span><span class=nb>eax</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=nv>_current</span><span class=p>,</span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>cmpl</span><span class=err> </span><span class=kc>$</span><span class=mi>0</span><span class=p>,</span><span class=nv>state</span><span class=p>(</span><span class=o>%</span><span class=nb>eax</span><span class=p>)</span><span class=err>     # </span><span class=nv>state</span><span class=err>    </span>
<span class=err>    </span><span class=nf>jne</span><span class=err> </span><span class=nv>reschedule</span><span class=err>    </span>
<span class=err>    </span><span class=nf>cmpl</span><span class=err> </span><span class=kc>$</span><span class=mi>0</span><span class=p>,</span><span class=nv>counter</span><span class=p>(</span><span class=o>%</span><span class=nb>eax</span><span class=p>)</span><span class=err>       # </span><span class=nv>counter</span><span class=err>    </span>
<span class=err>    </span><span class=nf>je</span><span class=err> </span><span class=nv>reschedule</span>
<span class=nl>ret_from_sys_call:</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=nv>_current</span><span class=p>,</span><span class=o>%</span><span class=nb>eax</span><span class=err>      # </span><span class=nv>task</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=err> </span><span class=nv>cannot</span><span class=err> </span><span class=nv>have</span><span class=err> </span><span class=nb>si</span><span class=nv>gnals</span><span class=err>    </span>
<span class=err>    </span><span class=nf>cmpl</span><span class=err> </span><span class=nv>_task</span><span class=p>,</span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>je</span><span class=err> </span><span class=mi>3</span><span class=nv>f</span><span class=err>    </span>
<span class=err>    </span><span class=nf>cmpw</span><span class=err> </span><span class=kc>$</span><span class=mh>0x0f</span><span class=p>,</span><span class=nb>CS</span><span class=p>(</span><span class=o>%</span><span class=nb>esp</span><span class=p>)</span><span class=err>     # </span><span class=nv>was</span><span class=err> </span><span class=nv>old</span><span class=err> </span><span class=nv>code</span><span class=err> </span><span class=ow>seg</span><span class=nv>ment</span><span class=err> </span><span class=nv>supervisor</span><span class=err> </span><span class=nv>?</span><span class=err>    </span>
<span class=err>    </span><span class=nf>jne</span><span class=err> </span><span class=mi>3</span><span class=nv>f</span><span class=err>    </span>
<span class=err>    </span><span class=nf>cmpw</span><span class=err> </span><span class=kc>$</span><span class=mh>0x17</span><span class=p>,</span><span class=nv>OLDSS</span><span class=p>(</span><span class=o>%</span><span class=nb>esp</span><span class=p>)</span><span class=err>      # </span><span class=nv>was</span><span class=err> </span><span class=nv>stack</span><span class=err> </span><span class=ow>seg</span><span class=nv>ment</span><span class=err> = </span><span class=mh>0x17</span><span class=err> </span><span class=nv>?</span><span class=err>    </span>
<span class=err>    </span><span class=nf>jne</span><span class=err> </span><span class=mi>3</span><span class=nv>f</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=nb>si</span><span class=nv>gnal</span><span class=p>(</span><span class=o>%</span><span class=nb>eax</span><span class=p>),</span><span class=o>%</span><span class=nb>ebx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=nb>bl</span><span class=nv>ocked</span><span class=p>(</span><span class=o>%</span><span class=nb>eax</span><span class=p>),</span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>notl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>andl</span><span class=err> </span><span class=o>%</span><span class=nb>ebx</span><span class=p>,</span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>bsfl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=p>,</span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>je</span><span class=err> </span><span class=mi>3</span><span class=nv>f</span><span class=err>    </span>
<span class=err>    </span><span class=nf>btrl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=p>,</span><span class=o>%</span><span class=nb>ebx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>movl</span><span class=err> </span><span class=o>%</span><span class=nb>ebx</span><span class=p>,</span><span class=nb>si</span><span class=nv>gnal</span><span class=p>(</span><span class=o>%</span><span class=nb>eax</span><span class=p>)</span><span class=err>    </span>
<span class=err>    </span><span class=nf>incl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=nv>_do_signal</span><span class=err>    </span>
<span class=err>    </span><span class=nf>popl</span><span class=err> </span><span class=o>%</span><span class=nb>eax</span>
<span class=err>3:  </span>
<span class=err>    </span><span class=nf>popl</span><span class=err> </span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>popl</span><span class=err> </span><span class=o>%</span><span class=nb>ebx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>popl</span><span class=err> </span><span class=o>%</span><span class=nb>ecx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>popl</span><span class=err> </span><span class=o>%</span><span class=nb>edx</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pop</span><span class=err> </span><span class=o>%</span><span class=nb>fs</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pop</span><span class=err> </span><span class=o>%</span><span class=nb>es</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pop</span><span class=err> </span><span class=o>%</span><span class=nb>ds</span><span class=err>    </span>
<span class=err>    </span><span class=nf>iret</span>
</code></pre></td></tr></table>
</div>
</div><p>又被吓到了是不是？</p>
<p>别怕，我们只关注压栈的情况，还记不记得在 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247501522&idx=1&sn=936f7837421870a572ee2a82d745a519&chksm=c2c5bc7ff5b23569eb0b3472ac7dcfc25c5de25a0ff75b4c5e805056fa3e1492870cf59df324&scene=21#wechat_redirect">一个新进程的诞生（二）从内核态到用户态</a> 讲中，我们聊到触发了中断后，CPU 会自动帮我们做如下压栈操作。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-16-35-39-585014ed980dbcb12caa8fa60ce38e9a.png alt=图片></p>
<p>因为 system_call 是通过 int 80h 这个软中断进来的，所以也属于中断的一种，具体说是属于特权级发生变化的，且没有错误码情况的中断，所以在这之前栈已经被压了 <strong>SS、ESP、EFLAGS、CS、EIP</strong> 这些值。</p>
<p>接下来 system_call 又压入了一些值，具体说来有 <strong>ds、es、fs、edx、ecx、ebx、eax</strong>。</p>
<p>如果你看源码费劲，得不出我上述结论，那你可以看 system_call.s 上面的注释，Linus 作者已经很贴心地给你写出了此时的堆栈状态。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>/* 
* Stack layout in &#39;ret_from_system_call&#39;: 
* 
*   0(%esp) - %eax *   4(%esp) - %ebx 
*   8(%esp) - %ecx *   C(%esp) - %edx 
*  10(%esp) - %fs *  14(%esp) - %es 
*  18(%esp) - %ds *  1C(%esp) - %eip 
*  20(%esp) - %cs *  24(%esp) - %eflags 
*  28(%esp) - %oldesp 
*  2C(%esp) - %oldss 
*/
</code></pre></td></tr></table>
</div>
</div><p>看，就是 CPU 中断压入的 5 个值，加上 system_call 手动压入的 7 个值。</p>
<p>所以之后，中断处理程序如果有需要的话，就可以从这里取出它想要的值，包括 CPU 压入的那五个值，或者 system_call 手动压入的 7 个值。</p>
<p>比如 <strong>sys_execve</strong> 这个中断处理函数，一开始就取走了位于栈顶 0x1C 位置处的 EIP 的值。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=nf>EIP</span><span class=err> = </span><span class=mh>0x1C</span>
<span class=nl>_sys_execve:</span><span class=err>    </span>
<span class=err>    </span><span class=nf>lea</span><span class=err> </span><span class=nv>EIP</span><span class=p>(</span><span class=o>%</span><span class=nb>esp</span><span class=p>),</span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>pushl</span><span class=err> </span><span class=o>%</span><span class=nb>eax</span><span class=err>    </span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=nv>_do_execve</span><span class=err>    </span>
<span class=err>    </span><span class=nf>addl</span><span class=err> </span><span class=kc>$</span><span class=mi>4</span><span class=p>,</span><span class=o>%</span><span class=nb>esp</span><span class=err>    </span>
<span class=err>    </span><span class=nf>ret</span>
</code></pre></td></tr></table>
</div>
</div><p>随后在 <strong>do_execve</strong> 函数中，又通过 C 语言函数调用的约定，取走了 <strong>filename，argv，envp</strong> 等参数。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>int do_execve(        
    unsigned long * eip,        
    long tmp,        
    char * filename,        
    char ** argv,        
    char ** envp) {    
        ...
}
</code></pre></td></tr></table>
</div>
</div><p>具体这个函数的详细流程和作用，将会在第四部分的 shell 程序装载章节讲到。</p>
<p>今天你只需要记住<strong>一次系统调用的流程和原理</strong>，就可以了，把下图印在脑子里。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-16-36-39-e71bef13b407d0f4405f778c7cf03a80.png alt=图片></p>
<p>之后很多函数都会像今天的 fork 一样，走一遍系统调用的流程，到时候我就不再展开了。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2024-01-08 06:47:33
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/linux/>linux</a>
<a href=https://justice.bj.cn/tags/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/>linux-0.11源码解读</a>
<a href=https://justice.bj.cn/tags/%E7%AC%AC3%E9%83%A8%E5%88%86/>第3部分</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC3%E9%83%A8%E5%88%86/24.%E4%BB%8E%E4%B8%80%E6%AC%A1%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BB%B4%E7%AD%94%E6%9D%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">24.定时器</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC3%E9%83%A8%E5%88%86/26.fork%E4%B8%AD%E8%BF%9B%E7%A8%8B%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E7%9A%84%E5%A4%8D%E5%88%B6/>
<span class="next-text nav-default">26.fork中进程基本信息的复制</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#search-btn").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #search-btn").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</body>
</html>