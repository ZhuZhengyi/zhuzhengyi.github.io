<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>36.缺页中断 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="36.缺页中断 书接上回，上回书咱们说到，进程 2 通过 execve 函数，将自己摇身一变成为 /bin/sh 程序，也就是 shell 程序开始执行。 1 2 3 4 5 6 7 8 9 10 11 // main.c void init(void) { ...">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC4%E9%83%A8%E5%88%86/36.%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="36.缺页中断">
<meta property="og:description" content="36.缺页中断 书接上回，上回书咱们说到，进程 2 通过 execve 函数，将自己摇身一变成为 /bin/sh 程序，也就是 shell 程序开始执行。 1 2 3 4 5 6 7 8 9 10 11 // main.c void init(void) { ...">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC4%E9%83%A8%E5%88%86/36.%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2024-01-08T06:47:33+08:00">
<meta property="article:modified_time" content="2024-01-08T06:47:33+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="36.缺页中断">
<meta itemprop=description content="36.缺页中断 书接上回，上回书咱们说到，进程 2 通过 execve 函数，将自己摇身一变成为 /bin/sh 程序，也就是 shell 程序开始执行。 1 2 3 4 5 6 7 8 9 10 11 // main.c void init(void) { ..."><meta itemprop=datePublished content="2024-01-08T06:47:33+08:00">
<meta itemprop=dateModified content="2024-01-08T06:47:33+08:00">
<meta itemprop=wordCount content="3576">
<meta itemprop=keywords content="linux,linux-0.11源码解读,第4部分,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="36.缺页中断">
<meta name=twitter:description content="36.缺页中断 书接上回，上回书咱们说到，进程 2 通过 execve 函数，将自己摇身一变成为 /bin/sh 程序，也就是 shell 程序开始执行。 1 2 3 4 5 6 7 8 9 10 11 // main.c void init(void) { ..."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>36.缺页中断</h1>
<div class=post-meta>
<time datetime=2024-01-08 class=post-time>
2024-01-08 06:47:33
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/linux/> linux </a>
<a href=https://justice.bj.cn/categories/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/> linux-0.11源码解读 </a>
<a href=https://justice.bj.cn/categories/%E7%AC%AC4%E9%83%A8%E5%88%86/> 第4部分 </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#跳转到一个不存在的地址会发生什么>跳转到一个不存在的地址会发生什么</a></li>
<li><a href=#缺页中断-do_no_page>缺页中断 do_no_page</a></li>
<li><a href=#缺页中断返回>缺页中断返回</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=36缺页中断>36.缺页中断</h1>
<p>书接上回，上回书咱们说到，进程 2 通过 <strong>execve</strong> 函数，将自己摇身一变成为 <strong>/bin/sh</strong> 程序，也就是 <strong>shell</strong> 程序开始执行。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// main.c
</span><span class=c1></span><span class=kt>void</span> <span class=nf>init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>pid</span><span class=o>=</span><span class=n>fork</span><span class=p>()))</span> <span class=p>{</span>        
        <span class=n>close</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>        
        <span class=n>open</span><span class=p>(</span><span class=s>&#34;/etc/rc&#34;</span><span class=p>,</span><span class=n>O_RDONLY</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>        
        <span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=n>argv_rc</span><span class=p>,</span><span class=n>envp_rc</span><span class=p>);</span>        
        <span class=n>_exit</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>    
    <span class=p>}</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>那么此时进程 2 就是 shell 程序了。</p>
<p>再进一步讲，相当于之前的进程 1 通过 <strong>fork + execve</strong> 这两个函数的组合，创建了一个新的进程去加载并执行了 shell 程序。</p>
<p>我们在 Linux 里执行一个程序，比如在命令行中 ./xxx，其内部实现逻辑都是 fork + execve 这个原理。</p>
<p>当然，此时我们仅仅是通过 execve，使得下一条 CPU 指令将会执行到 /bin/sh 程序所在的内存起始位置处，也就是 /bin/sh 头部结构中 <strong>a_entry</strong> 所描述的地址。</p>
<p>但有个问题是，我们仅仅将 /bin/sh 文件的头部加载到了内存，其他部分并没有进行加载，那我们是怎么执行到的 /bin/sh 的程序指令呢？</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-44-22-2ddc77fe8686ba8e985c099d1efe6d7d.png alt=图片></p>
<p>我们就带着这个问题，开始今天的探索。</p>
<h2 id=跳转到一个不存在的地址会发生什么>跳转到一个不存在的地址会发生什么</h2>
<p>/bin/sh 这个文件并不是 Linux 0.11 源码里的内容，Linux 0.11 只管按照 a.out 这种格式去解读它，跳转到 a.out 格式头部数据结构 <strong>exec.a_entry</strong> 所指向的内存地址去执行指令。</p>
<p>所以这个 a_entry 的值是多少，就完全取决于硬盘中 /bin/sh 这个文件是怎么构造的了，我们简单点，就假设它为 <strong>0</strong>，这表示随后的 CPU 将跳转到 0 地址处进行执行。</p>
<p>当然，这个 0 仅仅表示<strong>逻辑地址</strong>，既没有进行分段，也没有进行分页。</p>
<p>之前说过无数次了，Linux 0.11 的每个进程是通过不同的局部描述符在线性地址空间中瓜分出不同的空间，一个进程占 64M。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-44-29-a49168ac30ab0b1f45ae4daac902533d.png alt=图片></p>
<p>由于我们现在所处的代码是属于进程 2，所以逻辑地址 0 通过分段机制映射到线性地址空间，就是 <strong>0x8000000</strong>，表示 <strong>128M</strong> 位置处。</p>
<p>好，128M 这个线性地址，随后将会通过<strong>分页机制</strong>的映射转化为物理地址，这才定位到最终的真实物理内存。</p>
<p>可是，128M 这个线性地址并没有页表映射它，也就是因为上面我们说的，我们除了 /bin/sh 文件的头部加载到了内存外，其他部分并没有进行加载操作。</p>
<p><strong>再准确点说，是 0x8000000 这个线性地址的访问，遇到了页表项的存在位 P 等于 0 的情况。</strong></p>
<p>一旦遇到了这种情况，CPU 会触发一个中断：<strong>页错误（Page-Fault）</strong>，这在 Intel 手册 Volume-3 Chapter 4.7 章节里给出了这个信息。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-44-36-228eec2d7f2b4640d7441ca0d4aa7be9.png alt=图片></p>
<p>当然，Page-Fault 在很多情况都会触发，具体是因为什么情况触发的，CPU 会帮我们保存在中断的出错码 <strong>Error Code</strong> 里，这在随后的 Figure 4-12 中给出了详细的出错码说明。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-44-42-371d5c9369c149d21699fa1f594c81f2.png alt=图片></p>
<p>这块之所以讲这么详细，因为我想让大家知道一切的原理都有最一手资料的来源，这些一手资料写的都非常详细和友好，大家完全不必道听途说，也不必毫无头绪地搜索网上的博客。</p>
<p>当然，与本文相关的，就是这个<strong>存在位 P</strong>。</p>
<p>当触发这个 Page-Fault 中断后，就会进入 Linux 0.11 源码中的 <strong>page_fault</strong> 方法，由于 Linux 0.11 的 page_fault 是汇编写的，很不直观，这里我选 Linux 1.0 的代码给大家看，逻辑是一样的。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>do_page_fault</span><span class=p>(...,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>error_code</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>       
    <span class=k>if</span> <span class=p>(</span><span class=n>error_code</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>        
        <span class=n>do_wp_page</span><span class=p>(</span><span class=n>error_code</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>current</span><span class=p>,</span> <span class=n>user_esp</span><span class=p>);</span>    
    <span class=k>else</span>        
        <span class=n>do_no_page</span><span class=p>(</span><span class=n>error_code</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>current</span><span class=p>,</span> <span class=n>user_esp</span><span class=p>);</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>根据 <strong>error_code</strong> 的不同，有不同的逻辑。</p>
<p>刚刚说了，这个中断是由于 <strong>0x8000000</strong> 这个线性地址的访问，遇到了页表项的<strong>存在位 P</strong> 等于 0 的情况，所以 error_code 的第 0 位就是 0，会走 <strong>do_no_page</strong> 逻辑。</p>
<p>之前在讲 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247502033&idx=1&sn=1acfd8b7f4c805906ecd51c33d0010eb&chksm=c2c5b27cf5b23b6a41051c7f93407afc97094a4b0a36ea050616778f4d072f074602f98983b2&scene=21#wechat_redirect">第30回 | 番外篇 - 写时复制就这么几行代码</a> 的时候，讲了 <strong>do_wp_page</strong>，这是在 P=1 时的逻辑，文章的结尾我说过，后面会把页表项的存在位 P 为 0 时触发的 do_no_page 逻辑讲给大家，这不就来了么。</p>
<p>do_wp_page 叫<strong>页写保护中断</strong>，do_no_page 叫<strong>缺页中断</strong>。</p>
<p>好了，我们用了很大篇幅，说明白了跳转到一个 P=0 的地址会发生什么，接下来就是具体看 do_no_page 函数的逻辑咯。</p>
<h2 id=缺页中断-do_no_page>缺页中断 do_no_page</h2>
<p>我们先一睹为快它的代码。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>error_code</span><span class=p>,</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=kt>int</span> <span class=n>nr</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>    
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>tmp</span><span class=p>;</span>    
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>page</span><span class=p>;</span>    
    <span class=kt>int</span> <span class=n>block</span><span class=p>,</span><span class=n>i</span><span class=p>;</span>    
    <span class=n>address</span> <span class=o>&amp;=</span> <span class=mh>0xfffff000</span><span class=p>;</span>    
    <span class=n>tmp</span> <span class=o>=</span> <span class=n>address</span> <span class=o>-</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>start_code</span><span class=p>;</span>    
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span> <span class=o>||</span> <span class=n>tmp</span> <span class=o>&gt;=</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>end_data</span><span class=p>)</span> <span class=p>{</span>        
        <span class=n>get_empty_page</span><span class=p>(</span><span class=n>address</span><span class=p>);</span>        
        <span class=k>return</span><span class=p>;</span>    
    <span class=p>}</span>    
    <span class=k>if</span> <span class=p>(</span><span class=n>share_page</span><span class=p>(</span><span class=n>tmp</span><span class=p>))</span>        
        <span class=k>return</span><span class=p>;</span>    
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>page</span> <span class=o>=</span> <span class=n>get_free_page</span><span class=p>()))</span>        
        <span class=n>oom</span><span class=p>();</span>
    <span class=cm>/* remember that 1 block is used for header */</span>    
    <span class=n>block</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>tmp</span><span class=o>/</span><span class=n>BLOCK_SIZE</span><span class=p>;</span>    
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span> <span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>4</span> <span class=p>;</span> <span class=n>block</span><span class=o>++</span><span class=p>,</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>        
        <span class=n>nr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>bmap</span><span class=p>(</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=p>,</span><span class=n>block</span><span class=p>);</span>    
    <span class=n>bread_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=o>-&gt;</span><span class=n>i_dev</span><span class=p>,</span><span class=n>nr</span><span class=p>);</span>    
    <span class=n>i</span> <span class=o>=</span> <span class=n>tmp</span> <span class=o>+</span> <span class=mi>4096</span> <span class=o>-</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>end_data</span><span class=p>;</span>    
    <span class=n>tmp</span> <span class=o>=</span> <span class=n>page</span> <span class=o>+</span> <span class=mi>4096</span><span class=p>;</span>    
    <span class=k>while</span> <span class=p>(</span><span class=n>i</span><span class=o>--</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>        
        <span class=n>tmp</span><span class=o>--</span><span class=p>;</span>        
        <span class=o>*</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>tmp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>    
    <span class=p>}</span>    
    <span class=k>if</span> <span class=p>(</span><span class=n>put_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>address</span><span class=p>))</span>        
        <span class=k>return</span><span class=p>;</span>    
    <span class=n>free_page</span><span class=p>(</span><span class=n>page</span><span class=p>);</span>    
    <span class=n>oom</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们仍然是去掉一些不重要的分支，假设跳转不会超过数据末端 end_data，也没有共享内存页面，申请空闲内存时也不会内存不足产生 oom 等，将程序简化如下。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=c1>// 线性地址的页面地址 0x8000000    
</span><span class=c1></span>    <span class=n>address</span> <span class=o>&amp;=</span> <span class=mh>0xfffff000</span><span class=p>;</span>    
    <span class=c1>// 计算相对于进程基址的偏移 0    
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>address</span> <span class=o>-</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>start_code</span><span class=p>;</span>    
    <span class=c1>// 寻找空闲的一页内存    
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>page</span> <span class=o>=</span> <span class=n>get_free_page</span><span class=p>();</span>    
    <span class=c1>// 计算这个地址在文件中的哪个数据块 1    
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>block</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>tmp</span><span class=o>/</span><span class=n>BLOCK_SIZE</span><span class=p>;</span>    
    <span class=c1>// 一个数据块 1024 字节，所以一页内存需要读 4 个数据块    
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>nr</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>    
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span> <span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>4</span> <span class=p>;</span> <span class=n>block</span><span class=o>++</span><span class=p>,</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>        
        <span class=n>nr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>bmap</span><span class=p>(</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=p>,</span><span class=n>block</span><span class=p>);</span>    
    <span class=n>bread_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=o>-&gt;</span><span class=n>i_dev</span><span class=p>,</span><span class=n>nr</span><span class=p>);</span>    
    <span class=p>...</span>    
    <span class=c1>// 完成页表的映射    
</span><span class=c1></span>    <span class=n>put_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>address</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这就简单多了，我们还是一点点看。</p>
<p>首先，缺页产生的线性地址，之前假设过了，是 0x8000000，也就是进程 2 自己线性地址空间的起始处 128M 这个位置。</p>
<p>由于我们的页表映射是以<strong>页</strong>为单位的，所以首先计算出 address 所在的页，其实就是完成一次 <strong>4KB 的对齐</strong>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=c1>// 线性地址的页面地址 0x8000000    
</span><span class=c1></span>    <span class=n>address</span> <span class=o>&amp;=</span> <span class=mh>0xfffff000</span><span class=p>;</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>此时 address 对齐后仍然是 0x8000000。</p>
<p>这个地址是整个线性地址空间的地址，但对于进程 2 自己来说，需要计算出相对于进程 2 的偏移地址，也就是去掉进程 2 的段基址部分。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=c1>// 计算相对于进程基址的偏移 0    
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>address</span> <span class=o>-</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>start_code</span><span class=p>;</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的 current->start_code 就是进程 2 的段基址，也是 128M。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-44-51-a49168ac30ab0b1f45ae4daac902533d.png alt=图片></p>
<p>所以偏移地址 tmp 计算后等于 <strong>0</strong>，这和我们之前假设的 a_entry = 0 是一致的。</p>
<p>接下来很简单，就是寻找一个空闲页。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=c1>// 寻找空闲的一页内存    
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>page</span> <span class=o>=</span> <span class=n>get_free_page</span><span class=p>();</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个 <strong>get_free_page</strong> 是用汇编语言写的，其实就是去 <strong>mem_map[]</strong> 中寻找一个值为 0 的位置，这就表示找到了空闲内存。</p>
<p>这部分忘记的同学，可以看一下 <a href="https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247500089&idx=1&sn=9a3fd6e585b0fd1ec528599ead6677c6&scene=21#wechat_redirect">第13回 | 主内存初始化 mem_init</a>，之前苦苦建立的一些初始化的数据结构，就用上了。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-44-57-150f714f07d49eae3c6ee4a2cda35b6e.png alt=图片></p>
<p>找到一页物理内存后，当然是把硬盘中的数据加载进来，下面的代码就是完成这个工作。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=c1>// 计算这个地址在文件中的哪个数据块 1    
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>block</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>tmp</span><span class=o>/</span><span class=n>BLOCK_SIZE</span><span class=p>;</span>    
    <span class=c1>// 一个数据块 1024 字节，所以一页内存需要读 4 个数据块    
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>nr</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>    
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span> <span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>4</span> <span class=p>;</span> <span class=n>block</span><span class=o>++</span><span class=p>,</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>        
        <span class=n>nr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>bmap</span><span class=p>(</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=p>,</span><span class=n>block</span><span class=p>);</span>    
    <span class=n>bread_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=o>-&gt;</span><span class=n>i_dev</span><span class=p>,</span><span class=n>nr</span><span class=p>);</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>从硬盘的哪个位置开始读呢？</p>
<p>首先 0 内存地址，应该就对应着这个文件 0 号数据块，当然由于 /bin/sh 这个 a.out 格式的文件使用了 1 个数据块作为头部 exec 结构，所以我们<strong>跳过头部</strong>，从文件 1 号数据块开始读。</p>
<p>读多少块呢？</p>
<p>因为硬盘中的 1 个数据块为 1024 字节，而一页内存为 4096 字节，所以要读 4 块，这就是 nr[4] 的缘故。</p>
<p>之后读取数据主要是两个函数，<strong>bmap</strong> 负责将相对于文件的数据块转换为相对于整个硬盘的数据块，比如这个文件的第 1 块数据，可能对应在整个硬盘的第 24 块的位置。</p>
<p><strong>bread_page</strong> 就是连续读取 4 个数据块到 1 页内存的函数，这个函数原理就复杂了，之后第五部分会讲这块的内容，但站在用户层的效果很好理解，就是把硬盘数据复制到内存罢了。</p>
<p>OK，现在硬盘上所需要的内容已经被读入物理内存了。</p>
<p>最后一步完成<strong>页表的映射</strong>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=c1>// 完成页表的映射    
</span><span class=c1></span>    <span class=n>put_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>address</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这是因为我们此时仅仅是申请了物理内存页，并且把硬盘数据复制了进来，但我们并没有把这个物理内存页和线性地址空间的内存页进行映射，也就是没建立相关的<strong>页表</strong>。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-18-45-05-b7d999c9bc53aea332ff6ddfa99b976d.png alt=图片></p>
<p>建立页表的映射，由于 Linux 0.11 使用的是二级页表，所以实际上就是写入<strong>页目录项</strong>和<strong>页表项</strong>的过程，我把 <strong>put_page</strong> 函数简化了一下，只考虑页目录项还不存在的场景。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1></span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=nf>put_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>page</span><span class=p>,</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>tmp</span><span class=p>,</span> <span class=o>*</span><span class=n>page_table</span><span class=p>;</span>    
    <span class=c1>// 找到页目录项    
</span><span class=c1></span>    <span class=n>page_table</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=n>address</span><span class=o>&gt;&gt;</span><span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xffc</span><span class=p>);</span>    
    <span class=c1>// 写入页目录项    
</span><span class=c1></span>    <span class=n>tmp</span> <span class=o>=</span> <span class=n>get_free_page</span><span class=p>();</span>    
    <span class=o>*</span><span class=n>page_table</span> <span class=o>=</span> <span class=n>tmp</span><span class=o>|</span><span class=mi>7</span><span class=p>;</span>    
    <span class=c1>// 写入页表项    
</span><span class=c1></span>    <span class=n>page_table</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span> <span class=n>tmp</span><span class=p>;</span>    
    <span class=n>page_table</span><span class=p>[(</span><span class=n>address</span><span class=o>&gt;&gt;</span><span class=mi>12</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x3ff</span><span class=p>]</span> <span class=o>=</span> <span class=n>page</span> <span class=o>|</span> <span class=mi>7</span><span class=p>;</span>    
    <span class=k>return</span> <span class=n>page</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>大家可以结合页目录表和页表的数据结构看一下，很简单，就是个计算过程。</p>
<p>关于页目录表和页表这些<strong>分页</strong>相关的知识，可以回顾之前的 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247499821&idx=1&sn=df90a7c57607bf501b5ef535f8440d98&chksm=c2c5ba80f5b233969bf591f919107e28e7be51f066821cba1ea39bf19cc0332b95b94d29467d&scene=21#wechat_redirect">第9回 | Intel 内存管理两板斧：分段与分页</a>，这里就不再赘述。</p>
<h2 id=缺页中断返回>缺页中断返回</h2>
<p>好了，这就是整个缺页中断处理的过程，本质上就是加载硬盘对应位置的数据，然后建立页表的过程。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// memory.c
</span><span class=c1>// address 缺页产生的线性地址 0x8000000
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_no_page</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>address</span><span class=p>)</span> <span class=p>{</span>    
    <span class=c1>// 线性地址的页面地址 0x8000000    
</span><span class=c1></span>    <span class=n>address</span> <span class=o>&amp;=</span> <span class=mh>0xfffff000</span><span class=p>;</span>    
    <span class=c1>// 计算相对于进程基址的偏移 0    
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>address</span> <span class=o>-</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>start_code</span><span class=p>;</span>    
    <span class=c1>// 寻找空闲的一页内存    
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>page</span> <span class=o>=</span> <span class=n>get_free_page</span><span class=p>();</span>    
    <span class=c1>// 计算这个地址在文件中的哪个数据块 1    
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>block</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>tmp</span><span class=o>/</span><span class=n>BLOCK_SIZE</span><span class=p>;</span>    
    <span class=c1>// 一个数据块 1024 字节，所以一页内存需要读 4 个数据块    
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>nr</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>    
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span> <span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>4</span> <span class=p>;</span> <span class=n>block</span><span class=o>++</span><span class=p>,</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>        
        <span class=n>nr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>bmap</span><span class=p>(</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=p>,</span><span class=n>block</span><span class=p>);</span>    
    <span class=n>bread_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>current</span><span class=o>-&gt;</span><span class=n>executable</span><span class=o>-&gt;</span><span class=n>i_dev</span><span class=p>,</span><span class=n>nr</span><span class=p>);</span>    
    <span class=p>...</span>    
    <span class=c1>// 完成页表的映射    
</span><span class=c1></span>    <span class=n>put_page</span><span class=p>(</span><span class=n>page</span><span class=p>,</span><span class=n>address</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>再回过头看整个代码，是不是清晰了不少？</p>
<p>好，那我们再往上看，我们之前是在进程 2 里执行了 execve 函数将程序替换成 /bin/sh，也就是 shell 程序。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// main.c
</span><span class=c1></span><span class=kt>void</span> <span class=nf>init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>    
    <span class=p>...</span>    
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>pid</span><span class=o>=</span><span class=n>fork</span><span class=p>()))</span> <span class=p>{</span>        
        <span class=n>close</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>        
        <span class=n>open</span><span class=p>(</span><span class=s>&#34;/etc/rc&#34;</span><span class=p>,</span><span class=n>O_RDONLY</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>        
        <span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=n>argv_rc</span><span class=p>,</span><span class=n>envp_rc</span><span class=p>);</span>        
        <span class=n>_exit</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>    
    <span class=p>}</span>    
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>execve 函数返回后，CPU 就跳转到 /bin/sh 程序的第一行开始执行，但由于跳转到的线性地址不存在，所以引发了今天我们讲的<strong>缺页中断</strong>，把硬盘里 /bin/sh 所需要的内容加载到了内存，此时缺页中断返回。</p>
<p>返回后，CPU 会再次尝试跳转到 0x8000000 这个线性地址，此时由于缺页中断的处理结果，<strong>使得该线性地址已有对应的页表进行映射</strong>，所以顺利地映射到了物理地址，也就是 /bin/sh 的代码部分（从硬盘加载过来的），那接下来就终于可以执行 /bin/sh 程序，也就是 shell 程序了。</p>
<p>那这个 shell 程序到底是啥呢？他的代码并不在 Linux 0.11 的源码里，所以我们的重点将不是分析它的源码，仅仅了解它的原理即可。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2024-01-08 06:47:33
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/linux/>linux</a>
<a href=https://justice.bj.cn/tags/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/>linux-0.11源码解读</a>
<a href=https://justice.bj.cn/tags/%E7%AC%AC4%E9%83%A8%E5%88%86/>第4部分</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC4%E9%83%A8%E5%88%86/35.execve%E5%8A%A0%E8%BD%BD%E5%B9%B6%E6%89%A7%E8%A1%8Cshell%E7%A8%8B%E5%BA%8F/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">35.扒开execve的皮</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC4%E9%83%A8%E5%88%86/37.shell%E7%A8%8B%E5%BA%8F%E8%B7%91%E8%B5%B7%E6%9D%A5%E4%BA%86/>
<span class="next-text nav-default">37.shell程序跑起来了</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
$("#search-btn").click(function(){
$(".modal-dialog").addClass("visible");
});
$("#closeSearch").click(function(){
$(".modal-dialog").removeClass("visible");
});
$(document).click(function(event) {
//if you click on anything except the modal itself or the "open modal" link, close the modal
if (!$(event.target).closest(".modal-content, #search-btn").length) {
$("body").find(".modal-dialog").removeClass("visible");
}
});
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</body>
</html>