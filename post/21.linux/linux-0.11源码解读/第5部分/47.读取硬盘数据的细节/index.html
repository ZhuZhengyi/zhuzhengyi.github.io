<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>47.读取硬盘数据的细节 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="47.读取硬盘数据的细节 新建一个非常简单的 info.txt 文件。 1 2 3 4 5 [root@linux0.11]$ cat &amp;gt; info.txt &amp;lt;&amp;lt;EOF name:flash age:28 language:java EOF 在命令行输入一条十分简单的命令。 1 2 [root@linux0.11]$ cat info.txt | wc -l 3 这条命令的意">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC5%E9%83%A8%E5%88%86/47.%E8%AF%BB%E5%8F%96%E7%A1%AC%E7%9B%98%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%86%E8%8A%82/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="47.读取硬盘数据的细节">
<meta property="og:description" content="47.读取硬盘数据的细节 新建一个非常简单的 info.txt 文件。 1 2 3 4 5 [root@linux0.11]$ cat > info.txt <<EOF name:flash age:28 language:java EOF 在命令行输入一条十分简单的命令。 1 2 [root@linux0.11]$ cat info.txt | wc -l 3 这条命令的意">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC5%E9%83%A8%E5%88%86/47.%E8%AF%BB%E5%8F%96%E7%A1%AC%E7%9B%98%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%86%E8%8A%82/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2024-01-08T06:47:33+08:00">
<meta property="article:modified_time" content="2024-01-08T06:47:33+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="47.读取硬盘数据的细节">
<meta itemprop=description content="47.读取硬盘数据的细节 新建一个非常简单的 info.txt 文件。 1 2 3 4 5 [root@linux0.11]$ cat > info.txt <<EOF name:flash age:28 language:java EOF 在命令行输入一条十分简单的命令。 1 2 [root@linux0.11]$ cat info.txt | wc -l 3 这条命令的意"><meta itemprop=datePublished content="2024-01-08T06:47:33+08:00">
<meta itemprop=dateModified content="2024-01-08T06:47:33+08:00">
<meta itemprop=wordCount content="2735">
<meta itemprop=keywords content="linux,linux-0.11源码解读,第5部分,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="47.读取硬盘数据的细节">
<meta name=twitter:description content="47.读取硬盘数据的细节 新建一个非常简单的 info.txt 文件。 1 2 3 4 5 [root@linux0.11]$ cat > info.txt <<EOF name:flash age:28 language:java EOF 在命令行输入一条十分简单的命令。 1 2 [root@linux0.11]$ cat info.txt | wc -l 3 这条命令的意"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn class="menu-item-link menu-item-search" href=javascript:void(0);>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>47.读取硬盘数据的细节</h1>
<div class=post-meta>
<time datetime=2024-01-08 class=post-time>
2024-01-08 06:47:33
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/linux/> linux </a>
<a href=https://justice.bj.cn/categories/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/> linux-0.11源码解读 </a>
<a href=https://justice.bj.cn/categories/%E7%AC%AC5%E9%83%A8%E5%88%86/> 第5部分 </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents></nav>
</div>
</div>
<div class=post-content>
<h1 id=47读取硬盘数据的细节>47.读取硬盘数据的细节</h1>
<p>新建一个非常简单的 info.txt 文件。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@linux0.11<span class=o>]</span>$ cat &gt; info.txt <span class=s>&lt;&lt;EOF
</span><span class=s>name:flash
</span><span class=s>age:28
</span><span class=s>language:java
</span><span class=s>EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>在命令行输入一条十分简单的命令。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=o>[</span>root@linux0.11<span class=o>]</span>$ cat info.txt <span class=p>|</span> wc -l
<span class=m>3</span>
</code></pre></td></tr></table>
</div>
</div><p>这条命令的意思是读取刚刚的 info.txt 文件，输出它的行数。 </p>
<p>上一回中，我们讲述了读硬盘数据的全流程。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-17-06-12-c92d06aed5f6384a96d00e68f20e077d.png alt=图片></p>
<p>其中 <code>ll_rw_block()</code> 方法负责把硬盘中指定数据块中的数据，复制到 <code>getblk()</code>方法申请到的缓冲块里，上一回没有展开详细讲解。</p>
<p>所以我们这一回，就详细讲讲，<code>ll_rw_block()</code> 是如何完成这一任务的。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// buffer.c
</span><span class=c1></span><span class=k>struct</span> <span class=n>buffer_head</span> <span class=o>*</span> <span class=nf>bread</span><span class=p>(</span><span class=kt>int</span> <span class=n>dev</span><span class=p>,</span><span class=kt>int</span> <span class=n>block</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>ll_rw_block</span><span class=p>(</span><span class=n>READ</span><span class=p>,</span><span class=n>bh</span><span class=p>);</span>
    <span class=p>...</span>
<span class=p>}</span>
<span class=kt>void</span> <span class=nf>ll_rw_block</span> <span class=p>(</span><span class=kt>int</span> <span class=n>rw</span><span class=p>,</span> <span class=k>struct</span> <span class=n>buffer_head</span> <span class=o>*</span><span class=n>bh</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>make_request</span><span class=p>(</span><span class=n>major</span><span class=p>,</span> <span class=n>rw</span><span class=p>,</span> <span class=n>bh</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>struct</span> <span class=n>request</span> <span class=n>request</span><span class=p>[</span><span class=n>NR_REQUEST</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
<span class=k>static</span> <span class=kt>void</span> <span class=nf>make_request</span><span class=p>(</span><span class=kt>int</span> <span class=n>major</span><span class=p>,</span><span class=kt>int</span> <span class=n>rw</span><span class=p>,</span> <span class=k>struct</span> <span class=n>buffer_head</span> <span class=o>*</span> <span class=n>bh</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=n>request</span> <span class=o>*</span><span class=n>req</span><span class=p>;</span>
        <span class=p>...</span>
    <span class=c1>// 从 request 队列找到一个空位
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>rw</span> <span class=o>==</span> <span class=n>READ</span><span class=p>)</span>
        <span class=n>req</span> <span class=o>=</span> <span class=n>request</span><span class=o>+</span><span class=n>NR_REQUEST</span><span class=p>;</span>
    <span class=k>else</span>
        <span class=n>req</span> <span class=o>=</span> <span class=n>request</span><span class=o>+</span><span class=p>((</span><span class=n>NR_REQUEST</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=mi>3</span><span class=p>);</span>
    <span class=k>while</span> <span class=p>(</span><span class=o>--</span><span class=n>req</span> <span class=o>&gt;=</span> <span class=n>request</span><span class=p>)</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=o>-&gt;</span><span class=n>dev</span><span class=o>&lt;</span><span class=mi>0</span><span class=p>)</span>
            <span class=k>break</span><span class=p>;</span>
    <span class=p>...</span>
    <span class=c1>// 构造 request 结构
</span><span class=c1></span>    <span class=n>req</span><span class=o>-&gt;</span><span class=n>dev</span> <span class=o>=</span> <span class=n>bh</span><span class=o>-&gt;</span><span class=n>b_dev</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>cmd</span> <span class=o>=</span> <span class=n>rw</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>errors</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>sector</span> <span class=o>=</span> <span class=n>bh</span><span class=o>-&gt;</span><span class=n>b_blocknr</span><span class=o>&lt;&lt;</span><span class=mi>1</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>nr_sectors</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>bh</span><span class=o>-&gt;</span><span class=n>b_data</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>waiting</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>bh</span> <span class=o>=</span> <span class=n>bh</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>add_request</span><span class=p>(</span><span class=n>major</span><span class=o>+</span><span class=n>blk_dev</span><span class=p>,</span><span class=n>req</span><span class=p>);</span>
<span class=p>}</span>
<span class=c1>// ll_rw_blk.c
</span><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>add_request</span> <span class=p>(</span><span class=k>struct</span> <span class=n>blk_dev_struct</span> <span class=o>*</span><span class=n>dev</span><span class=p>,</span> <span class=k>struct</span> <span class=n>request</span> <span class=o>*</span><span class=n>req</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=n>request</span> <span class=o>*</span> <span class=n>tmp</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>cli</span><span class=p>();</span>    <span class=c1>// 清空 dirt 位
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>req</span><span class=o>-&gt;</span><span class=n>bh</span><span class=p>)</span>
        <span class=n>req</span><span class=o>-&gt;</span><span class=n>bh</span><span class=o>-&gt;</span><span class=n>b_dirt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=c1>// 当前请求项为空，那么立即执行当前请求项
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>tmp</span> <span class=o>=</span> <span class=n>dev</span><span class=o>-&gt;</span><span class=n>current_request</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>dev</span><span class=o>-&gt;</span><span class=n>current_request</span> <span class=o>=</span> <span class=n>req</span><span class=p>;</span>
        <span class=n>sti</span><span class=p>();</span>
        <span class=p>(</span><span class=n>dev</span><span class=o>-&gt;</span><span class=n>request_fn</span><span class=p>)();</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// 插入到链表中
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span> <span class=p>;</span> <span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span> <span class=p>;</span> <span class=n>tmp</span><span class=o>=</span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>IN_ORDER</span><span class=p>(</span><span class=n>tmp</span><span class=p>,</span><span class=n>req</span><span class=p>)</span> <span class=o>||</span>
            <span class=o>!</span><span class=n>IN_ORDER</span><span class=p>(</span><span class=n>tmp</span><span class=p>,</span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
            <span class=n>IN_ORDER</span><span class=p>(</span><span class=n>req</span><span class=p>,</span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>))</span>
            <span class=k>break</span><span class=p>;</span>
    <span class=n>req</span><span class=o>-&gt;</span><span class=n>next</span><span class=o>=</span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
    <span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=o>=</span><span class=n>req</span><span class=p>;</span>
    <span class=n>sti</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>调用链很长，主线是从 request 数组中找到一个空位，然后作为链表项插入到 request 链表中。</p>
<p>没错 request 是一个 32 大小的数组，里面的每一个 request 结构间通过 next 指针相连又形成链表。</p>
<p>如果你熟悉 <a href="https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247500147&idx=1&sn=409f5ed34ae3822e40a6b443207d40c5&scene=21#wechat_redirect">第15回 | 块设备请求项初始化 blk_dev_init</a> 所讲的内容，就会明白这个说法咯。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-17-06-21-af5133bdd119146aba298ee96ef5999d.png alt=图片></p>
<p>request 的具体结构是。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// blk.h
</span><span class=c1></span><span class=k>struct</span> <span class=n>request</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>dev</span><span class=p>;</span>        <span class=cm>/* -1 if no request */</span>
    <span class=kt>int</span> <span class=n>cmd</span><span class=p>;</span>        <span class=cm>/* READ or WRITE */</span>
    <span class=kt>int</span> <span class=n>errors</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>sector</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>nr_sectors</span><span class=p>;</span>
    <span class=kt>char</span> <span class=o>*</span> <span class=n>buffer</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span> <span class=n>waiting</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>buffer_head</span> <span class=o>*</span> <span class=n>bh</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>request</span> <span class=o>*</span> <span class=n>next</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></td></tr></table>
</div>
</div><p>表示一个读盘的请求参数。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-17-06-28-3ab2df19b2650fd5287b4d18a27c3cfe.png alt=图片></p>
<p>有了这些参数，底层方法拿到这个结构之后，就知道怎么样访问硬盘了。</p>
<p>那是谁不断从这个 request 队列中取出 request 结构并对硬盘发起读请求操作的呢？</p>
<p>这里 Linux 0.11 有个很巧妙的设计，我们看看。</p>
<p>有没有注意到 add_request 方法有如下分支。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// blk.h
</span><span class=c1></span><span class=k>struct</span> <span class=n>blk_dev_struct</span> <span class=p>{</span>
    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>request_fn</span><span class=p>)(</span><span class=kt>void</span><span class=p>);</span>
    <span class=k>struct</span> <span class=n>request</span> <span class=o>*</span> <span class=n>current_request</span><span class=p>;</span>
<span class=p>};</span>
<span class=c1>// ll_rw_blk.c
</span><span class=c1></span><span class=k>struct</span> <span class=n>blk_dev_struct</span> <span class=n>blk_dev</span><span class=p>[</span><span class=n>NR_BLK_DEV</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>},</span>     <span class=cm>/* no_dev */</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>},</span>     <span class=cm>/* dev mem */</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>},</span>     <span class=cm>/* dev fd */</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>},</span>     <span class=cm>/* dev hd */</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>},</span>     <span class=cm>/* dev ttyx */</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>},</span>     <span class=cm>/* dev tty */</span>
    <span class=p>{</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>}</span>      <span class=cm>/* dev lp */</span>
<span class=p>};</span>
<span class=k>static</span> <span class=kt>void</span> <span class=nf>make_request</span><span class=p>(</span><span class=kt>int</span> <span class=n>major</span><span class=p>,</span><span class=kt>int</span> <span class=n>rw</span><span class=p>,</span> <span class=k>struct</span> <span class=n>buffer_head</span> <span class=o>*</span> <span class=n>bh</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>add_request</span><span class=p>(</span><span class=n>major</span><span class=o>+</span><span class=n>blk_dev</span><span class=p>,</span><span class=n>req</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>static</span> <span class=kt>void</span> <span class=nf>add_request</span> <span class=p>(</span><span class=k>struct</span> <span class=n>blk_dev_struct</span> <span class=o>*</span><span class=n>dev</span><span class=p>,</span> <span class=k>struct</span> <span class=n>request</span> <span class=o>*</span><span class=n>req</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=c1>// 当前请求项为空，那么立即执行当前请求项
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>tmp</span> <span class=o>=</span> <span class=n>dev</span><span class=o>-&gt;</span><span class=n>current_request</span><span class=p>))</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=p>(</span><span class=n>dev</span><span class=o>-&gt;</span><span class=n>request_fn</span><span class=p>)();</span>
        <span class=p>...</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>就是当设备的当前请求项为空，也就是第一次收到硬盘操作请求时，会立即执行该设备的 <strong>request_fn</strong> 方法，<strong>这便是整个读盘循环的最初推手</strong>。</p>
<p>当前设备的设备号是 3，也就是硬盘，会从 blk_dev 数组中取索引下标为 3 的设备结构。</p>
<p>在 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247500982&idx=1&sn=3e40716e0054796bdffef8250f478927&chksm=c2c5be1bf5b2370d469c244b99289271e0433e3044b287f366589a3722df99ff4e3f7b08ffb5&scene=21#wechat_redirect">第20回 | 硬盘初始化 hd_init</a> 的时候，设备号为 3 的设备结构的 request_fn 被赋值为<strong>硬盘请求函数 do_hd_request</strong> 了。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// hd.c
</span><span class=c1></span><span class=kt>void</span> <span class=nf>hd_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>blk_dev</span><span class=p>[</span><span class=mi>3</span><span class=p>].</span><span class=n>request_fn</span> <span class=o>=</span> <span class=n>do_hd_request</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以，刚刚的 request_fn 背后的具体执行函数，就是这个 <code>do_hd_request()</code>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define CURRENT (blk_dev[MAJOR_NR].current_request)
</span><span class=cp></span><span class=c1>// hd.c
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_hd_request</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>dev</span> <span class=o>=</span> <span class=n>MINOR</span><span class=p>(</span><span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>block</span> <span class=o>=</span> <span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>sector</span><span class=p>;</span>
    <span class=p>...</span>
    <span class=n>nsect</span> <span class=o>=</span> <span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>nr_sectors</span><span class=p>;</span>
    <span class=p>...</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>cmd</span> <span class=o>==</span> <span class=n>WRITE</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>hd_out</span><span class=p>(</span><span class=n>dev</span><span class=p>,</span><span class=n>nsect</span><span class=p>,</span><span class=n>sec</span><span class=p>,</span><span class=n>head</span><span class=p>,</span><span class=n>cyl</span><span class=p>,</span><span class=n>WIN_WRITE</span><span class=p>,</span><span class=o>&amp;</span><span class=n>write_intr</span><span class=p>);</span>
        <span class=p>...</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>cmd</span> <span class=o>==</span> <span class=n>READ</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>hd_out</span><span class=p>(</span><span class=n>dev</span><span class=p>,</span><span class=n>nsect</span><span class=p>,</span><span class=n>sec</span><span class=p>,</span><span class=n>head</span><span class=p>,</span><span class=n>cyl</span><span class=p>,</span><span class=n>WIN_READ</span><span class=p>,</span><span class=o>&amp;</span><span class=n>read_intr</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span>
        <span class=n>panic</span><span class=p>(</span><span class=s>&#34;unknown hd-command&#34;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>我去掉了一大坨根据起始扇区号计算对应硬盘的磁头 head、柱面 cyl、扇区号 sec 等信息的代码。</p>
<p>可以看到最终会根据当前请求是写（WRITE）还是读（READ），在调用 <strong>hd_out</strong> 时传入不同的参数。</p>
<p>hd_out 就是读硬盘的最最最最底层的函数了。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// hd.c
</span><span class=c1></span><span class=k>static</span> <span class=kt>void</span> 
<span class=nf>hd_out</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>drive</span><span class=p>,</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>nsect</span><span class=p>,</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>sect</span><span class=p>,</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>head</span><span class=p>,</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>cyl</span><span class=p>,</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>cmd</span><span class=p>,</span>
        <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>intr_addr</span><span class=p>)(</span><span class=kt>void</span><span class=p>)){</span>
    <span class=p>...</span>
    <span class=n>do_hd</span> <span class=o>=</span> <span class=n>intr_addr</span><span class=p>;</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=n>hd_info</span><span class=p>[</span><span class=n>drive</span><span class=p>].</span><span class=n>ctl</span><span class=p>,</span><span class=n>HD_CMD</span><span class=p>);</span>
    <span class=n>port</span><span class=o>=</span><span class=n>HD_DATA</span><span class=p>;</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=n>hd_info</span><span class=p>[</span><span class=n>drive</span><span class=p>].</span><span class=n>wpcom</span><span class=o>&gt;&gt;</span><span class=mi>2</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=n>nsect</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=n>sect</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=n>cyl</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=n>cyl</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
    <span class=n>outb_p</span><span class=p>(</span><span class=mh>0xA0</span><span class=o>|</span><span class=p>(</span><span class=n>drive</span><span class=o>&lt;&lt;</span><span class=mi>4</span><span class=p>)</span><span class=o>|</span><span class=n>head</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
    <span class=n>outb</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=o>++</span><span class=n>port</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，最底层的读盘请求，其实就是向一堆外设端口做读写操作。</p>
<p>这个函数实际上在 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247500414&idx=1&sn=f3e77f90848dbfa0b82a220590e56e45&chksm=c2c5b8d3f5b231c5c2e0dc3a722ae1d2bf9690eb98daa85b9083e41fb0eb1592bcac4ff713b9&scene=21#wechat_redirect">第17回 | 时间初始化 time_init</a> 为了讲解与 CMOS 外设交互方式的时候讲过了，简单说硬盘的端口表是这样的。</p>
<table>
<thead>
<tr>
<th>端口</th>
<th>读</th>
<th>写</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x1F0</td>
<td>数据寄存器</td>
<td>数据寄存器</td>
</tr>
<tr>
<td>0x1F1</td>
<td>错误寄存器</td>
<td>特征寄存器</td>
</tr>
<tr>
<td>0x1F2</td>
<td>扇区计数寄存器</td>
<td>扇区计数寄存器</td>
</tr>
<tr>
<td>0x1F3</td>
<td>扇区号寄存器或 LBA 块地址 0~7</td>
<td>扇区号或 LBA 块地址 0~7</td>
</tr>
<tr>
<td>0x1F4</td>
<td>磁道数低 8 位或 LBA 块地址 8~15</td>
<td>磁道数低 8 位或 LBA 块地址 8~15</td>
</tr>
<tr>
<td>0x1F5</td>
<td>磁道数高 8 位或 LBA 块地址 16~23</td>
<td>磁道数高 8 位或 LBA 块地址 16~23</td>
</tr>
<tr>
<td>0x1F6</td>
<td>驱动器/磁头或 LBA 块地址 24~27</td>
<td>驱动器/磁头或 LBA 块地址 24~27</td>
</tr>
<tr>
<td>0x1F7</td>
<td>命令寄存器或状态寄存器</td>
<td>命令寄存器</td>
</tr>
</tbody>
</table>
<p>读硬盘就是，往除了第一个以外的后面几个端口写数据，告诉要读硬盘的哪个扇区，读多少。</p>
<p>然后再从 0x1F0 端口一个字节一个字节的读数据。</p>
<p>这就完成了一次硬盘读操作。</p>
<p>当然，从 0x1F0 端口读出硬盘数据，是在硬盘读好数据并放在 0x1F0 后发起的硬盘中断，进而执行硬盘中断处理函数里进行的。</p>
<p>在 <a href="http://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247500982&idx=1&sn=3e40716e0054796bdffef8250f478927&chksm=c2c5be1bf5b2370d469c244b99289271e0433e3044b287f366589a3722df99ff4e3f7b08ffb5&scene=21#wechat_redirect">第20回 | 硬盘初始化 hd_init</a> 的时候，将 hd_interrupt 设置为了硬盘中断处理函数，中断号是 0x2E，代码如下。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// hd.c
</span><span class=c1></span><span class=kt>void</span> <span class=nf>hd_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>set_intr_gate</span><span class=p>(</span><span class=mh>0x2E</span><span class=p>,</span><span class=o>&amp;</span><span class=n>hd_interrupt</span><span class=p>);</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以，在硬盘读完数据后，发起 0x2E 中断，便会进入到 hd_interrupt 方法里。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=err>// </span><span class=nf>system_call.s</span>
<span class=nl>_hd_interrupt:</span>
<span class=err>    </span><span class=nf>...</span>
<span class=err>    </span><span class=nf>xchgl</span><span class=err> </span><span class=nv>_do_hd</span><span class=p>,</span><span class=o>%</span><span class=nb>edx</span>
<span class=err>    </span><span class=nf>...</span>
<span class=err>    </span><span class=nf>call</span><span class=err> </span><span class=o>*%</span><span class=nb>edx</span>
<span class=err>    </span><span class=nf>...</span>
<span class=err>    </span><span class=nf>iret</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法主要是调用 do_hd 方法，这个方法是一个指针，就是高级语言里所谓的接口，读操作的时候，将会指向 read_intr 这个具体实现。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// hd.c
</span><span class=c1></span><span class=kt>void</span> <span class=nf>do_hd_request</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>cmd</span> <span class=o>==</span> <span class=n>READ</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>hd_out</span><span class=p>(</span><span class=n>dev</span><span class=p>,</span><span class=n>nsect</span><span class=p>,</span><span class=n>sec</span><span class=p>,</span><span class=n>head</span><span class=p>,</span><span class=n>cyl</span><span class=p>,</span><span class=n>WIN_READ</span><span class=p>,</span><span class=o>&amp;</span><span class=n>read_intr</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>
<span class=k>static</span> <span class=kt>void</span> <span class=n>hd_out</span><span class=p>(...,</span> <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>intr_addr</span><span class=p>)(</span><span class=kt>void</span><span class=p>))</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>do_hd</span> <span class=o>=</span> <span class=n>intr_addr</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>看，一切都有千丝万缕的联系，是不是很精妙。</p>
<p>我们展开 read_intr 方法继续看。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// hd.c
</span><span class=c1></span><span class=cp>#define port_read(port,buf,nr) 
</span><span class=cp></span>    <span class=err>\</span> <span class=n>__asm__</span><span class=p>(</span><span class=s>&#34;cld;rep;insw&#34;</span><span class=o>::</span><span class=s>&#34;d&#34;</span> <span class=p>(</span><span class=n>port</span><span class=p>),</span><span class=s>&#34;D&#34;</span> <span class=p>(</span><span class=n>buf</span><span class=p>),</span><span class=s>&#34;c&#34;</span> <span class=p>(</span><span class=n>nr</span><span class=p>)</span><span class=o>:</span><span class=s>&#34;cx&#34;</span><span class=p>,</span><span class=s>&#34;di&#34;</span><span class=p>)</span>
<span class=k>static</span> <span class=kt>void</span> <span class=n>read_intr</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=c1>// 从数据端口读出数据到内存
</span><span class=c1></span>    <span class=n>port_read</span><span class=p>(</span><span class=n>HD_DATA</span><span class=p>,</span><span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span><span class=mi>256</span><span class=p>);</span>
    <span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>errors</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>buffer</span> <span class=o>+=</span> <span class=mi>512</span><span class=p>;</span>
    <span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>sector</span><span class=o>++</span><span class=p>;</span>
    <span class=c1>// 还没有读完，则直接返回等待下次
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>CURRENT</span><span class=o>-&gt;</span><span class=n>nr_sectors</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>do_hd</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>read_intr</span><span class=p>;</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// 所有扇区都读完了
</span><span class=c1></span>    <span class=c1>// 删除本次都请求项
</span><span class=c1></span>    <span class=n>end_request</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
    <span class=c1>// 再次触发硬盘操作
</span><span class=c1></span>    <span class=n>do_hd_request</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里使用了 <code>port_read()</code> 宏定义的方法，从端口 HD_DATA 中读 256 次数据，每次读一个字，总共就是 512 字节的数据。</p>
<p>如果没有读完发起读盘请求时所要求的字节数，那么直接返回，等待下次硬盘触发中断并执行到 <code>read_intr</code> 即可。</p>
<p>如果已经读完了，就调用 <code>end_request()</code> 方法将请求项清除掉，然后再次调用 <code>do_hd_request()</code> 方法循环往复。</p>
<p>那重点就在于，如何结束掉本次请求的 end_request 方法。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>// blk.h
#define CURRENT (blk_dev[MAJOR_NR].current_request)
extern inline void 
end_request(int uptodate) {
    DEVICE_OFF(CURRENT-&gt;dev);
    if (CURRENT-&gt;bh) {
        CURRENT-&gt;bh-&gt;b_uptodate = uptodate;
        unlock_buffer(CURRENT-&gt;bh);
    }
    ...
    wake_up(&amp;CURRENT-&gt;waiting);
    wake_up(&amp;wait_for_request);
    CURRENT-&gt;dev = -1;
    CURRENT = CURRENT-&gt;next;
}
</code></pre></td></tr></table>
</div>
</div><p>两个 <code>wake_up()</code> 方法。</p>
<p>第一个唤醒了该请求项所对应的进程 <strong>&CURRENT->waiting</strong>，告诉这个进程我这个请求项的读盘操作处理完了，你继续执行吧。</p>
<p>另一个是唤醒了因为 request 队列满了没有将请求项插进来的进程 <strong>&wait_for_request</strong>。</p>
<p>随后，将当前设备的当前请求项 CURRENT，即 request 数组里的一个请求项 request 的 dev 置空，并将当前请求项指向链表中的下一个请求项。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-17-07-04-3f3635a29705a94e89682ef94831e76a.png alt=图片></p>
<p>这样，do_hd_request 方法处理的就是下一个请求项的内容了，直到将所有请求项都处理完毕。</p>
<p>整个流程就这样形成了闭环，<strong>通过这样的机制，可以做到好似存在一个额外的进程，在不断处理 request 链表里的读写盘请求一样</strong>。</p>
<p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2024/01/02-17-07-13-99d03df94c14a8d04176e0ae19a42543.png alt=图片></p>
<p>当设备的当前请求项为空时，也就是没有在执行的块设备请求项时，ll_rw_block 就会在执行到 add_request 方法时，直接执行 do_hd_request 方法发起读盘请求。</p>
<p>如果已经有在执行的请求项了，就插入 request 链表中。</p>
<p>do_hd_request 方法执行完毕后，硬盘发起读或写请求，执行完毕后会发起硬盘中断，进而调用 read_intr 中断处理函数。</p>
<p>read_intr 会改变当前请求项指针指向 request 链表的下一个请求项，并再次调用 do_hd_request 方法。</p>
<p><strong>所以 do_hd_request 方法一旦调用，就会不断处理 request 链表中的一项一项的硬盘请求项，这个循环就形成了，是不是很精妙</strong>！</p>
<p>OK，通过上一回和这一回的讲解，读盘请求的全部细节终于讲解完毕了！你还好么？</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2024-01-08 06:47:33
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/linux/>linux</a>
<a href=https://justice.bj.cn/tags/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/>linux-0.11源码解读</a>
<a href=https://justice.bj.cn/tags/%E7%AC%AC5%E9%83%A8%E5%88%86/>第5部分</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC5%E9%83%A8%E5%88%86/46.%E8%AF%BB%E7%A1%AC%E7%9B%98%E6%95%B0%E6%8D%AE%E5%85%A8%E6%B5%81%E7%A8%8B/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">46.读硬盘数据全流程</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/21.linux/linux-0.11%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/%E7%AC%AC5%E9%83%A8%E5%88%86/48.%E4%BF%A1%E5%8F%B7/>
<span class="next-text nav-default">48.信号</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
</body>
</html>