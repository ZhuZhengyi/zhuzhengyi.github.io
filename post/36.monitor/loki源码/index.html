<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Grafana loki 简介 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Grafana loki 简介 Grafana 发布了名为 “loki” 的新项目, 用于解决云原生架构下的日志收集与存储问题. loki 受 Prometheus 影响很深, github 主页 上的简介则是 Like Prometheus, but for logs.. Cortex 分析 loki 代码">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/36.monitor/loki%E6%BA%90%E7%A0%81/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Grafana loki 简介">
<meta property="og:description" content="Grafana loki 简介 Grafana 发布了名为 “loki” 的新项目, 用于解决云原生架构下的日志收集与存储问题. loki 受 Prometheus 影响很深, github 主页 上的简介则是 Like Prometheus, but for logs.. Cortex 分析 loki 代码">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/36.monitor/loki%E6%BA%90%E7%A0%81/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-12-25T10:57:29+00:00">
<meta property="article:modified_time" content="2020-12-25T10:57:29+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Grafana loki 简介">
<meta itemprop=description content="Grafana loki 简介 Grafana 发布了名为 “loki” 的新项目, 用于解决云原生架构下的日志收集与存储问题. loki 受 Prometheus 影响很深, github 主页 上的简介则是 Like Prometheus, but for logs.. Cortex 分析 loki 代码"><meta itemprop=datePublished content="2020-12-25T10:57:29+00:00">
<meta itemprop=dateModified content="2020-12-25T10:57:29+00:00">
<meta itemprop=wordCount content="4473">
<meta itemprop=keywords content="monitor,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Grafana loki 简介">
<meta name=twitter:description content="Grafana loki 简介 Grafana 发布了名为 “loki” 的新项目, 用于解决云原生架构下的日志收集与存储问题. loki 受 Prometheus 影响很深, github 主页 上的简介则是 Like Prometheus, but for logs.. Cortex 分析 loki 代码"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Grafana loki 简介</h1>
<div class=post-meta>
<time datetime=2020-12-25 class=post-time>
2020-12-25 10:57:29
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/monitor/> monitor </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#cortex>Cortex</a></li>
<li><a href=#loki-overview>Loki Overview</a></li>
<li><a href=#promtail-日志采集>Promtail 日志采集</a></li>
<li><a href=#日志采集分析>日志采集分析</a></li>
<li><a href=#一些问题>一些问题</a></li>
<li><a href=#loki-backend>Loki Backend</a></li>
<li><a href=#distributor>distributor</a></li>
<li><a href=#ingester>ingester</a></li>
<li><a href=#querierhttpsaleiwucompostgrafana-lokiquerier>Querier<a href=https://aleiwu.com/post/grafana-loki/#querier></a></a></li>
<li><a href=#结语>结语</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=grafana-loki-简介>Grafana loki 简介</h1>
<p>Grafana 发布了名为 “loki” 的新项目, 用于解决云原生架构下的日志收集与存储问题. loki 受 Prometheus 影响很深, <a href=https://github.com/grafana/loki>github 主页</a> 上的简介则是 <code>Like Prometheus, but for logs.</code>.</p>
<h2 id=cortex>Cortex</h2>
<p>分析 loki 代码之前, 不得不先提一下 <a href=https://github.com/cortexproject/cortex>cortex</a> 项目. <code>cortex</code> 是一个 Prometheus 的 Remote Backend, 核心价值是为 Prometheus 添加了水平扩展和(廉价的)指标长期存储能力. cortex 的完整设计可以看看它的<a href="https://docs.google.com/document/d/1C7yhMnb1x2sfeoe45f4mnnKConvroWhJ8KQZwIHJOuw/edit#heading=h.nimsq29kl184">设计白皮书</a>, 这里摘几个要点:</p>
<ul>
<li><strong>扩展</strong>: 读写分离, 写入端分两层, 第一层 <code>distributor</code> 做一致性哈希, 将负载分发到第二层 <code>ingester</code> 上, <code>ingester</code> 在内存中缓存 Metrics 数据, 异步写入 Storage Backend</li>
<li><strong>易于维护</strong>: 所有节点无状态, 随时可以迁移扩展</li>
<li><strong>成本</strong>: 以 <code>chunk</code> 作为基本存储对象, 可以用廉价的对象存储(比如 S3)来作为 Storage Backend</li>
</ul>
<p>loki 和 <code>cortex</code> 的作者都是 <a href=https://github.com/tomwilkie>tomwilkie</a>, loki 也完全沿用了 <code>cortex</code> 的<code>distributor</code>, <code>ingester</code>, <code>querier</code>, <code>chunk</code> 这一套.</p>
<h2 id=loki-overview>Loki Overview</h2>
<p>在 <code>cortex</code> 体系中, Prometheus 只是一个 Metrics 采集器: 收集指标, 然后扔给 <code>cortex</code>. 我们只要把 Prometheus 这个组件替换成采集日志的 <code>Promtail</code>, 就(差不多)得到了 loki:</p>
<p><img src=https://aleiwu.com/img/loki/loki-arch.png alt=loki></p>
<p>这个架构图与 <a href=https://github.com/cortexproject/cortex/blob/master/docs/architecture.md>cortex 的架构图</a> 相差无几. 唯一不同的是 Prometheus 可以部署在一个远端集群中, 而 <code>Promtail</code> 必须部署到所有需要日志收集的 Node 上去.</p>
<p>目前 loki 的运行模式还是 <code>All in One</code> 的, 即<code>distributor</code>, <code>querier</code>, <code>ingester</code>这些组件全都跑在 loki 主进程里. 不过这些组件之间的交互全都通过 gRPC 完成, 因此只要稍加改造就能作为一个分布式系统来跑.</p>
<h2 id=promtail-日志采集>Promtail 日志采集</h2>
<p><code>promtail</code> 可以理解为采集日志的 “Prometheus”. 它最巧妙的设计是完全复用了 Prometheus 的服务发现机制与 label 机制.</p>
<p>以 Kubernetes 服务发现为例, Prometheus 可以通过 <code>Pod</code> 的 <code>Annotations</code> 与 <code>Labels</code> 等信息来确定 <code>Pod</code> 是否需要抓取指标, 假如要的话 <code>Pod</code> 的指标暴露在哪个端口上, 以及这个 <code>Pod</code> 本身有哪些 label, 即 target label.</p>
<p>确定了这些信息之后, Prometheus 就可以去拉应用的指标了. 同时, 这些指标都会被打上 target label, 用于标注指标的来源. 等到在查询的时候, 我们就可以通过 target label, 比方说 <code>pod_name=foo-123512</code> 或 <code>service=user-service</code> 来获取特定的一个或一组 <code>Pod</code> 上的指标信息.</p>
<p><code>promtail</code> 是一样的道理. 它也是通过 <code>Pod</code> 的一些元信息来确定该 <code>Pod</code> 的日志文件位置, 同时为日志打上特定的 target label. 但要注意, 这个 label 不是标注在每一行日志事件上的, 而是被标注在”整个日志”上的. 这里”整个日志”在 loki 中抽象为 <code>stream</code>(日志流). 这就是 loki 文档中所说的”不索引日志, 只索引日志流”. 最终在查询端, 我们通过这些 label 就可以快速查询一个或一组特定的 <code>stream</code>.</p>
<p>服务发现部分的代码非常直白, 可以去 <code>pkg/promtail/targetmanager.go</code> 中自己看一下, 提两个实现细节:</p>
<ul>
<li><code>promtail</code> 要求所有 target 都跟自己属于同一个 node, 处于其它 node 上的 target 会被忽略;</li>
<li><code>promtail</code> 使用 target 的 <code>__path__</code> label 来确定日志路径;</li>
</ul>
<p>通过服务发现确定要收集的应用以及应用的日志路径后, <code>promtail</code> 就开始了真正的日志收集过程. 这里分三步:</p>
<ol>
<li>用 <code>fsnotify</code> 监听对应目录下的文件创建与删除(处理 log rolling)</li>
<li>对每个活跃的日志文件起一个 goroutine 进行类似 <code>tail -f</code> 的读取, 读取到的内容发送给 <code>channel</code></li>
<li>一个单独的 goroutine 会解析 <code>channel</code> 中的日志行, 分批发送给 loki 的 backend</li>
</ol>
<h2 id=日志采集分析>日志采集分析</h2>
<p>首先是 <code>fsnotify</code>(源码里的一些错误处理会简略掉)</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=k>for</span> <span class=p>{</span>
    <span class=k>select</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>event</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>Events</span><span class=p>:</span>
        <span class=k>switch</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Op</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Create</span><span class=p>:</span>
            <span class=c1>// protect against double Creates.
</span><span class=c1></span>            <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>tails</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
                <span class=nx>level</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>).</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;got &#39;create&#39; for existing file&#34;</span><span class=p>,</span> <span class=s>&#34;filename&#34;</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
                <span class=k>continue</span>
            <span class=p>}</span>

            <span class=c1>// newTailer 中会启动一个 goroutine 来读目标文件
</span><span class=c1></span>            <span class=nx>tailer</span> <span class=o>:=</span> <span class=nf>newTailer</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>positions</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
            <span class=nx>t</span><span class=p>.</span><span class=nx>tails</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>]</span> <span class=p>=</span> <span class=nx>tailer</span>

        <span class=k>case</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Remove</span><span class=p>:</span>
            <span class=nx>tailer</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>tails</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>]</span>
            <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
                <span class=c1>// 关闭 tailer
</span><span class=c1></span>                <span class=nx>helpers</span><span class=p>.</span><span class=nf>LogError</span><span class=p>(</span><span class=s>&#34;stopping tailer&#34;</span><span class=p>,</span> <span class=nx>tailer</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
                <span class=nb>delete</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>tails</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>err</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>Errors</span><span class=p>:</span>
        <span class=nx>level</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>).</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;error from fswatch&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>quit</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来是 <code>newTailer()</code> 这个方法中启动的日志文件读取逻辑:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>newTailer</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>tail</span> <span class=o>:=</span> <span class=nx>tail</span><span class=p>.</span><span class=nf>TailFile</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>tail</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
        <span class=nx>Follow</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
        <span class=nx>Location</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>tail</span><span class=p>.</span><span class=nx>SeekInfo</span><span class=p>{</span>
            <span class=nx>Offset</span><span class=p>:</span> <span class=nx>positions</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>path</span><span class=p>),</span>
            <span class=nx>Whence</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=p>},</span>
    <span class=p>})</span>

    <span class=nx>tailer</span> <span class=o>:=</span> <span class=o>...</span>
    <span class=k>go</span> <span class=nx>tailer</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>tailer</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>{</span>
        <span class=k>select</span> <span class=p>{</span>
        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>positionWait</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
            <span class=c1>// 定时同步当前读取位置
</span><span class=c1></span>            <span class=nx>pos</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>tail</span><span class=p>.</span><span class=nf>Tell</span><span class=p>()</span>
            <span class=nx>t</span><span class=p>.</span><span class=nx>positions</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=nx>pos</span><span class=p>)</span>

        <span class=k>case</span> <span class=nx>line</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>tail</span><span class=p>.</span><span class=nx>Lines</span><span class=p>:</span>
            <span class=c1>// handler.Handle() 中是一些日志行的预处理逻辑, 最后将日志行转化为 `Entry` 对象扔进 channel
</span><span class=c1></span>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=nx>model</span><span class=p>.</span><span class=nx>LabelSet</span><span class=p>{},</span> <span class=nx>line</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>line</span><span class=p>.</span><span class=nx>Text</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>level</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>).</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;error handling line&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里直接调用了 <code>hpcloud/tail</code> 这个包来完成文件的 tail 操作. <code>hpcloud/tail</code> 的内部实现中, 在读到 EOF 之后, 同样调用了 <code>fsnotify</code> 来获取新内容写入的通知. <code>fsnotify</code> 这个包内部则是依赖了 <code>inotify_init</code> 和 <code>inotify_add_watch</code> 这两个系统调用, 可以参考<a href=http://man7.org/linux/man-pages/man7/inotify.7.html>inotify</a>.</p>
<p>最后是日志发送, 这里有一个单独的 goroutine 会读取所有 tailer 通过 channel 传过来的日志(<code>Entry</code>对象), 然后按批发送给 loki:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=k>for</span> <span class=p>{</span>
    <span class=c1>// 每次发送之后要重置计时器
</span><span class=c1></span>    <span class=nx>maxWait</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>BatchWait</span><span class=p>)</span>
    <span class=k>select</span> <span class=p>{</span>
    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>quit</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=k>case</span> <span class=nx>e</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>entries</span><span class=p>:</span>
        <span class=c1>// Batch 足够大之后, 执行发送逻辑
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>batchSize</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>Line</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>BatchSize</span> <span class=p>{</span>
            <span class=nx>c</span><span class=p>.</span><span class=nf>send</span><span class=p>(</span><span class=nx>batch</span><span class=p>)</span>
            <span class=c1>// 重置 Batch
</span><span class=c1></span>            <span class=nx>batchSize</span> <span class=p>=</span> <span class=mi>0</span>
            <span class=nx>batch</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>model</span><span class=p>.</span><span class=nx>Fingerprint</span><span class=p>]</span><span class=o>*</span><span class=nx>logproto</span><span class=p>.</span><span class=nx>Stream</span><span class=p>{}</span>
        <span class=p>}</span>

        <span class=c1>// 收到 Entry, 先写进 Batch 当中
</span><span class=c1></span>        <span class=nx>batchSize</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>Line</span><span class=p>)</span>

        <span class=c1>// 每个 entry 要根据 label 放进对应的日志流(Stream)中
</span><span class=c1></span>        <span class=nx>fp</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>labels</span><span class=p>.</span><span class=nf>FastFingerprint</span><span class=p>()</span>
        <span class=nx>stream</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>batch</span><span class=p>[</span><span class=nx>fp</span><span class=p>]</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
            <span class=nx>stream</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>logproto</span><span class=p>.</span><span class=nx>Stream</span><span class=p>{</span>
                <span class=nx>Labels</span><span class=p>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>labels</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
            <span class=p>}</span>
            <span class=nx>batch</span><span class=p>[</span><span class=nx>fp</span><span class=p>]</span> <span class=p>=</span> <span class=nx>stream</span>
        <span class=p>}</span>
        <span class=nx>stream</span><span class=p>.</span><span class=nx>Entries</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>stream</span><span class=p>.</span><span class=nx>Entries</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Entry</span><span class=p>)</span>

    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>maxWait</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
        <span class=c1>// 到达每个批次的最大等待时间, 同样执行发送
</span><span class=c1></span>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>batch</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
            <span class=nx>c</span><span class=p>.</span><span class=nf>send</span><span class=p>(</span><span class=nx>batch</span><span class=p>);</span>
            <span class=nx>batchSize</span> <span class=p>=</span> <span class=mi>0</span>
            <span class=nx>batch</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>model</span><span class=p>.</span><span class=nx>Fingerprint</span><span class=p>]</span><span class=o>*</span><span class=nx>logproto</span><span class=p>.</span><span class=nx>Stream</span><span class=p>{}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这段代码中出现了 <code>Entry</code>(一条日志) 的 label, 看上去好像和一开始说的 “loki只索引日志流” 自相矛盾. 但其实这里只是代码上的实现细节, <code>Entry</code> 的 label 完全来自于服务发现, 最后发送时, label 也只是用于标识 <code>Stream</code>, 与上层抽象完全符合.</p>
<p>另外, 用 <code>channel</code> + <code>select</code> 写 batch 逻辑真的挺优雅, 简单易读.</p>
<h2 id=一些问题>一些问题</h2>
<p>目前 <code>promtail</code> 的代码还完全不到 production-ready, 它的本地没有 buffer, 并且没有处理 back pressure. 假设 loki 的流量太大处理不过来了, 那么 <code>promtail</code> 日志发送失败或超时直接就会丢日志. 同时, 文件读取位置, LAG(当前行数和文件最新行数的距离) 这些关键的监控指标都没暴露出来, 这是一个提 PR 的好时机.</p>
<h2 id=loki-backend>Loki Backend</h2>
<p>接下来是存储端, 这一部分在<a href=https://grafana.com/blog/2018/12/12/loki-prometheus-inspired-open-source-logging-for-cloud-natives/>官方博客</a>中就已经说得比较多了, 而且图很好看, 我也不拾人牙慧了. 挑几个重点看一下:</p>
<h2 id=distributor>distributor</h2>
<p><code>distributor</code> 直接接收来自 <code>promtail</code> 的日志写入请求, 请求体由 protobuf 编码, 格式如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// 一次写入请求, 包含多段日志流
</span><span class=c1></span><span class=kd>type</span> <span class=nx>PushRequest</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Streams</span> <span class=p>[]</span><span class=o>*</span><span class=nx>Stream</span> <span class=s>`protobuf:&#34;bytes,1,rep,name=streams&#34; json:&#34;streams,omitempty&#34;`</span>
<span class=p>}</span>
<span class=c1>// 一段日志流, 包含它的 label, 以及这段日志流当中的每个日志事件: Entry
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Stream</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Labels</span>  <span class=kt>string</span>  <span class=s>`protobuf:&#34;bytes,1,opt,name=labels,proto3&#34; json:&#34;labels,omitempty&#34;`</span>
    <span class=nx>Entries</span> <span class=p>[]</span><span class=nx>Entry</span> <span class=s>`protobuf:&#34;bytes,2,rep,name=entries&#34; json:&#34;entries&#34;`</span>
<span class=p>}</span>
<span class=c1>// 一个日志事件, 包含时间戳与内容
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Entry</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`protobuf:&#34;bytes,1,opt,name=timestamp,stdtime&#34; json:&#34;timestamp&#34;`</span>
    <span class=nx>Line</span>      <span class=kt>string</span>    <span class=s>`protobuf:&#34;bytes,2,opt,name=line,proto3&#34; json:&#34;line,omitempty&#34;`</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>distributor</code> 收到请求后, 会将一个 <code>PushRequest</code> 中的 <code>Stream</code> 根据 labels 拆分成多个 <code>PushRequest</code>, 这个过程使用一致性哈希:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>streams</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>streamTracker</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Streams</span><span class=p>))</span>
<span class=nx>keys</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>uint32</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Streams</span><span class=p>))</span>
<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>stream</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Streams</span> <span class=p>{</span>
    <span class=c1>// 获取每个 stream 的 label hash
</span><span class=c1></span>    <span class=nx>keys</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nf>tokenFor</span><span class=p>(</span><span class=nx>userID</span><span class=p>,</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>Labels</span><span class=p>))</span>
    <span class=nx>streams</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>stream</span> <span class=p>=</span> <span class=nx>stream</span>
<span class=p>}</span>

<span class=c1>// 根据 label hash 到 hash ring 上获取对应的 ingester 节点
</span><span class=c1>// 这里的节点指 hash ring 上的节点, 一个节点可能有多个对等的 ingester 副本来做 HA
</span><span class=c1></span><span class=nx>replicationSets</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>ring</span><span class=p>.</span><span class=nf>BatchGet</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>ring</span><span class=p>.</span><span class=nx>Write</span><span class=p>)</span>

<span class=c1>// 将 Stream 按对应的 ingester 节点进行分组
</span><span class=c1></span><span class=nx>samplesByIngester</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=o>*</span><span class=nx>streamTracker</span><span class=p>{}</span>
<span class=nx>ingesterDescs</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>ring</span><span class=p>.</span><span class=nx>IngesterDesc</span><span class=p>{}</span>
<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>replicationSet</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>replicationSets</span> <span class=p>{</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ingester</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>replicationSet</span><span class=p>.</span><span class=nx>Ingesters</span> <span class=p>{</span>
        <span class=nx>samplesByIngester</span><span class=p>[</span><span class=nx>ingester</span><span class=p>.</span><span class=nx>Addr</span><span class=p>]</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>samplesByIngester</span><span class=p>[</span><span class=nx>ingester</span><span class=p>.</span><span class=nx>Addr</span><span class=p>],</span> <span class=o>&amp;</span><span class=nx>streams</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
        <span class=nx>ingesterDescs</span><span class=p>[</span><span class=nx>ingester</span><span class=p>.</span><span class=nx>Addr</span><span class=p>]</span> <span class=p>=</span> <span class=nx>ingester</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>for</span> <span class=nx>ingester</span><span class=p>,</span> <span class=nx>samples</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>samplesByIngester</span> <span class=p>{</span>
    <span class=c1>// 每组 Stream[] 又作为一个 PushRequest, 下发给对应的 ingester 节点
</span><span class=c1></span>    <span class=nx>d</span><span class=p>.</span><span class=nf>sendSamples</span><span class=p>(</span><span class=nx>localCtx</span><span class=p>,</span> <span class=nx>ingester</span><span class=p>,</span> <span class=nx>samples</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>tracker</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>All in One</code> 的运行模式中, hash ring 直接存储在内存中. 在生产环境, 由于要起多个 <code>distributor</code> 节点做高可用, 这个 hash ring 会存储到外部的 Consul 集群中.</p>
<h2 id=ingester>ingester</h2>
<p><code>ingester</code> 接收 <code>distributor</code> 下发的 <code>PushRequest</code>, 也就是多段日志流(<code>[]Entry</code>). 在 <code>ingester</code> 内部会先将收到的 <code>[]Entry</code> Append 到内存中的 Chunk 流(<code>[]Chunk</code>). 同时会有一组 <code>goroutine</code> 异步将 Chunk 流存储到对象存储当中:</p>
<p><img src=https://aleiwu.com/img/loki/loki-ingester.png alt=loki-ingester></p>
<p>第一个 Append 过程很关键(代码有简化):</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>i</span> <span class=o>*</span><span class=nx>instance</span><span class=p>)</span> <span class=nf>Push</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>logproto</span><span class=p>.</span><span class=nx>PushRequest</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>s</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Streams</span> <span class=p>{</span>
        <span class=c1>// 将收到的日志流 Append 到内存中的日志流上, 同样地, 日志流按 label hash 索引
</span><span class=c1></span>        <span class=nx>fp</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>FastFingerprint</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>labels</span><span class=p>)</span>
        <span class=nx>stream</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>streams</span><span class=p>[</span><span class=nx>fp</span><span class=p>]</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
            <span class=nx>stream</span> <span class=p>=</span> <span class=nf>newStream</span><span class=p>(</span><span class=nx>fp</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>labels</span><span class=p>)</span>
            <span class=c1>// 这个过程中, 还会维护日志流的倒排索引(label -&gt; stream)
</span><span class=c1></span>            <span class=nx>i</span><span class=p>.</span><span class=nx>index</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>fp</span><span class=p>)</span>
            <span class=nx>i</span><span class=p>.</span><span class=nx>streams</span><span class=p>[</span><span class=nx>fp</span><span class=p>]</span> <span class=p>=</span> <span class=nx>stream</span>
        <span class=p>}</span>
        <span class=nx>stream</span><span class=p>.</span><span class=nf>Push</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Entries</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>stream</span><span class=p>)</span> <span class=nf>Push</span><span class=p>(</span><span class=nx>_</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>entries</span> <span class=p>[]</span><span class=nx>logproto</span><span class=p>.</span><span class=nx>Entry</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>entries</span> <span class=p>{</span>
        <span class=c1>// 假如当前 Chunk 已经关闭或者已经到达设定的最大 Chunk 大小, 则再创建一个新的 Chunk
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>chunks</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>closed</span> <span class=o>||</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nx>chunks</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>chunk</span><span class=p>.</span><span class=nf>SpaceFor</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>entries</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span> <span class=p>{</span>
            <span class=nx>s</span><span class=p>.</span><span class=nx>chunks</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>chunks</span><span class=p>,</span> <span class=nx>chunkDesc</span><span class=p>{</span>
                <span class=nx>chunk</span><span class=p>:</span> <span class=nx>chunkenc</span><span class=p>.</span><span class=nf>NewMemChunk</span><span class=p>(</span><span class=nx>chunkenc</span><span class=p>.</span><span class=nx>EncGZIP</span><span class=p>),</span>
            <span class=p>})</span>
        <span class=p>}</span>
        <span class=nx>s</span><span class=p>.</span><span class=nx>chunks</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>chunks</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>].</span><span class=nx>chunk</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>entries</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Chunk</code> 其实就是多条日志构成的压缩包. 将日志压成 <code>Chunk</code> 的意义是可以直接存入对象存储, 而对象存储是最便宜的(便宜是 loki 的核心目标之一). 在 一个 <code>Chunk</code> 到达指定大小之前它就是 open 的, 会不断 Append 新的日志(<code>Entry</code>) 到里面. 而在达到大小之后, <code>Chunk</code> 就会关闭等待持久化(强制持久化也会关闭 Chunk, 比如关闭 <code>ingester</code> 实例时就会关闭所有的 Chunk并持久化).</p>
<p>对 Chunk 的大小控制是一个调优要点:</p>
<ul>
<li>假如 Chunk 容量过小: 首先是导致压缩效率不高. 同时也会增加整体的 Chunk 数量, 导致倒排索引过大. 最后, 对象存储的操作次数也会变多, 带来额外的性能开销;</li>
<li>假如 Chunk 过大: 一个 Chunk 的 open 时间会更长, 占用额外的内存空间, 同时, 也增加了丢数据的风险. 最后, Chunk 过大也会导致查询读放大, 比方说查一小时的数据却要下载整天的 Chunk;</li>
</ul>
<p>丢数据问题: 所有 Chunk 要在 close 之后才会进行存储. 因此假如 ingester 异常宕机, 处于 open 状态的 Chunk, 以及 close 了但还没有来得及持久化的 Chunk 数据都会丢失. 从这个角度来说, ingester 其实也是 stateful 的, 在生产中可以通过给 ingester 跑多个副本来解决这个问题. 另外, <code>ingester</code> 里似乎还没有写 WAL, 这感觉是一个 PR 机会, 可以练习一下写存储的基本功.</p>
<p>异步存储过程就很简单了, 是一个一对多的生产者消费者模型:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// 一个 goroutine 将所有的待存储的 chunks enqueue
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>i</span> <span class=o>*</span><span class=nx>Ingester</span><span class=p>)</span> <span class=nf>sweepStream</span><span class=p>(</span><span class=nx>instance</span> <span class=o>*</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>stream</span> <span class=o>*</span><span class=nx>stream</span><span class=p>,</span> <span class=nx>immediate</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>

    <span class=c1>// 有一组待存储的队列(默认16个), 取模找一个队列把要存储的 chunk 的引用塞进去
</span><span class=c1></span>    <span class=nx>flushQueueIndex</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>(</span><span class=nb>uint64</span><span class=p>(</span><span class=nx>stream</span><span class=p>.</span><span class=nx>fp</span><span class=p>)</span> <span class=o>%</span> <span class=nb>uint64</span><span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>ConcurrentFlushes</span><span class=p>))</span>
    <span class=nx>firstTime</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>chunks</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>chunk</span><span class=p>.</span><span class=nf>Bounds</span><span class=p>()</span>
    <span class=nx>i</span><span class=p>.</span><span class=nx>flushQueues</span><span class=p>[</span><span class=nx>flushQueueIndex</span><span class=p>].</span><span class=nf>Enqueue</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>flushOp</span><span class=p>{</span>
        <span class=nx>model</span><span class=p>.</span><span class=nf>TimeFromUnixNano</span><span class=p>(</span><span class=nx>firstTime</span><span class=p>.</span><span class=nf>UnixNano</span><span class=p>()),</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>instanceID</span><span class=p>,</span>
        <span class=nx>stream</span><span class=p>.</span><span class=nx>fp</span><span class=p>,</span> <span class=nx>immediate</span><span class=p>,</span>
    <span class=p>})</span>
<span class=p>}</span>

<span class=c1>// 每个队列都有一个 goroutine 作为消费者在 dequeue
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>i</span> <span class=o>*</span><span class=nx>Ingester</span><span class=p>)</span> <span class=nf>flushLoop</span><span class=p>(</span><span class=nx>j</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>op</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>flushQueues</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nf>Dequeue</span><span class=p>()</span>
        <span class=c1>// 实际的存储操作在这个方法中, 存储完成后, Chunk 会被清理掉
</span><span class=c1></span>        <span class=nx>i</span><span class=p>.</span><span class=nf>flushUserSeries</span><span class=p>(</span><span class=nx>op</span><span class=p>.</span><span class=nx>userID</span><span class=p>,</span> <span class=nx>op</span><span class=p>.</span><span class=nx>fp</span><span class=p>,</span> <span class=nx>op</span><span class=p>.</span><span class=nx>immediate</span><span class=p>)</span>

        <span class=c1>// 存储失败的 chunk 会重新塞回队列中
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>op</span><span class=p>.</span><span class=nx>immediate</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>op</span><span class=p>.</span><span class=nx>from</span> <span class=p>=</span> <span class=nx>op</span><span class=p>.</span><span class=nx>from</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>flushBackoff</span><span class=p>)</span>
            <span class=nx>i</span><span class=p>.</span><span class=nx>flushQueues</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nf>Enqueue</span><span class=p>(</span><span class=nx>op</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后是清理过程, 同样是一个单独的 goroutine 定时在跑. <code>ingester</code> 里的所有 <code>Chunk</code> 会在持久化之后隔一小段时间才被清理掉. 这个”一小段时间”由 <code>chunk-retain-time</code> 参数进行控制(默认 15 分钟). 这么做是为了加速热点数据的读取(真正被人看的日志中, 有99%都是生成后的一小段时间内被查看的).</p>
<h2 id=querierhttpsaleiwucompostgrafana-lokiquerier>Querier<a href=https://aleiwu.com/post/grafana-loki/#querier></a></h2>
<p>最后是 <code>Querier</code>, 这个比较简单了, 大致逻辑就是根据<code>chunk index</code>中的索引信息, 请求 <code>ingester</code> 和对象存储. 合并后返回. 这里主要看一下”合并”操作:</p>
<blockquote>
<p>这里的代码其实可以作为一个简单的面试题: 假如你的日志按 class 分成了上百个文件, 现在要将它们合并输出(按时间顺序), 你会怎么做?</p>
</blockquote>
<p><code>loki</code> 里用了堆, 时间正序就用最小堆, 时间逆序就用最大堆:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// 这部分代码实现了一个简单的二叉堆, MinHeap 和 MaxHeap 实现了相反的 `Less()` 方法
</span><span class=c1></span><span class=kd>type</span> <span class=nx>iteratorHeap</span> <span class=p>[]</span><span class=nx>EntryIterator</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>iteratorHeap</span><span class=p>)</span> <span class=nf>Len</span><span class=p>()</span> <span class=kt>int</span>            <span class=p>{</span> <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>h</span><span class=p>)</span> <span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>iteratorHeap</span><span class=p>)</span> <span class=nf>Swap</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>j</span> <span class=kt>int</span><span class=p>)</span>       <span class=p>{</span> <span class=nx>h</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>h</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>h</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>h</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>iteratorHeap</span><span class=p>)</span> <span class=nf>Peek</span><span class=p>()</span> <span class=nx>EntryIterator</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>h</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>iteratorHeap</span><span class=p>)</span> <span class=nf>Push</span><span class=p>(</span><span class=nx>x</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>h</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=o>*</span><span class=nx>h</span><span class=p>,</span> <span class=nx>x</span><span class=p>.(</span><span class=nx>EntryIterator</span><span class=p>))</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>iteratorHeap</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>()</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
    <span class=nx>old</span> <span class=o>:=</span> <span class=o>*</span><span class=nx>h</span>
    <span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>old</span><span class=p>)</span>
    <span class=nx>x</span> <span class=o>:=</span> <span class=nx>old</span><span class=p>[</span><span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
    <span class=o>*</span><span class=nx>h</span> <span class=p>=</span> <span class=nx>old</span><span class=p>[</span><span class=mi>0</span> <span class=p>:</span> <span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>return</span> <span class=nx>x</span>
<span class=p>}</span>
<span class=kd>type</span> <span class=nx>iteratorMinHeap</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>iteratorHeap</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>iteratorMinHeap</span><span class=p>)</span> <span class=nf>Less</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>j</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>h</span><span class=p>.</span><span class=nx>iteratorHeap</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nf>Entry</span><span class=p>().</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>iteratorHeap</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nf>Entry</span><span class=p>().</span><span class=nx>Timestamp</span><span class=p>)</span>
<span class=p>}</span>
<span class=kd>type</span> <span class=nx>iteratorMaxHeap</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>iteratorHeap</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>iteratorMaxHeap</span><span class=p>)</span> <span class=nf>Less</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>j</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>h</span><span class=p>.</span><span class=nx>iteratorHeap</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nf>Entry</span><span class=p>().</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>iteratorHeap</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nf>Entry</span><span class=p>().</span><span class=nx>Timestamp</span><span class=p>)</span>
<span class=p>}</span>

<span class=c1>// 将一组 Stream 的 iterator 合并成一个 HeapIterator
</span><span class=c1></span><span class=kd>func</span> <span class=nf>NewHeapIterator</span><span class=p>(</span><span class=nx>is</span> <span class=p>[]</span><span class=nx>EntryIterator</span><span class=p>,</span> <span class=nx>direction</span> <span class=nx>logproto</span><span class=p>.</span><span class=nx>Direction</span><span class=p>)</span> <span class=nx>EntryIterator</span> <span class=p>{</span>
    <span class=nx>result</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>heapIterator</span><span class=p>{}</span>
    <span class=k>switch</span> <span class=nx>direction</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>logproto</span><span class=p>.</span><span class=nx>BACKWARD</span><span class=p>:</span>
        <span class=nx>result</span><span class=p>.</span><span class=nx>heap</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>iteratorMaxHeap</span><span class=p>{}</span>
    <span class=k>case</span> <span class=nx>logproto</span><span class=p>.</span><span class=nx>FORWARD</span><span class=p>:</span>
        <span class=nx>result</span><span class=p>.</span><span class=nx>heap</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>iteratorMinHeap</span><span class=p>{}</span>
    <span class=k>default</span><span class=p>:</span>
        <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;bad direction&#34;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// pre-next each iterator, drop empty.
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>is</span> <span class=p>{</span>
        <span class=nx>result</span><span class=p>.</span><span class=nf>requeue</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>result</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>i</span> <span class=o>*</span><span class=nx>heapIterator</span><span class=p>)</span> <span class=nf>requeue</span><span class=p>(</span><span class=nx>ei</span> <span class=nx>EntryIterator</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>ei</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>heap</span><span class=p>.</span><span class=nf>Push</span><span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>heap</span><span class=p>,</span> <span class=nx>ei</span><span class=p>)</span>
        <span class=k>return</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ei</span><span class=p>.</span><span class=nf>Error</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>i</span><span class=p>.</span><span class=nx>errs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>errs</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>helpers</span><span class=p>.</span><span class=nf>LogError</span><span class=p>(</span><span class=s>&#34;closing iterator&#34;</span><span class=p>,</span> <span class=nx>ei</span><span class=p>.</span><span class=nx>Close</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>i</span> <span class=o>*</span><span class=nx>heapIterator</span><span class=p>)</span> <span class=nf>Next</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>i</span><span class=p>.</span><span class=nx>curr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>i</span><span class=p>.</span><span class=nf>requeue</span><span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>curr</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>i</span><span class=p>.</span><span class=nx>heap</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>false</span>
    <span class=p>}</span>
    <span class=nx>i</span><span class=p>.</span><span class=nx>curr</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>Pop</span><span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>heap</span><span class=p>).(</span><span class=nx>EntryIterator</span><span class=p>)</span>
    <span class=nx>currEntry</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nf>Entry</span><span class=p>()</span>
    <span class=c1>// keep popping entries off if they match, to dedupe
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>i</span><span class=p>.</span><span class=nx>heap</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=nx>next</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>heap</span><span class=p>.</span><span class=nf>Peek</span><span class=p>()</span>
        <span class=nx>nextEntry</span> <span class=o>:=</span> <span class=nx>next</span><span class=p>.</span><span class=nf>Entry</span><span class=p>()</span>
        <span class=k>if</span> <span class=p>!</span><span class=nx>currEntry</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>nextEntry</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>break</span>
        <span class=p>}</span>

        <span class=nx>next</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>Pop</span><span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>heap</span><span class=p>).(</span><span class=nx>EntryIterator</span><span class=p>)</span>
        <span class=nx>i</span><span class=p>.</span><span class=nf>requeue</span><span class=p>(</span><span class=nx>next</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>true</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=结语>结语</h2>
<p>写源码分析的文章还是挺累的, 虽然前面说了不拾人牙慧, 但最后还是要重复一下 Grafana 官方已经说了的一些要点, 那就是 loki 的思路和 <code>ELK</code> 这样的思路确实完全不同. loki 不索引日志内容大大减轻了存储成本, 同时聚焦于 <code>distribute grep</code>, 而不再考虑各种分析,报表的花架子, 也让”日志”的作用更为专一: 服务于可观察性.</p>
<p>另外, <code>Grafana loki</code> 为 Grafana 生态填上了可观察性中的重要一环, logging. 再加上早已成为 CloudNative 中可观察性事实标准的 Prometheus + Grafana Stack, Grafana 生态已经只缺 Trace 这一块了(他们的 Slides 中提到已经在做了), 未来可期.</p>
<p>最后想说的是, 现今摩尔定律已近失效, 没有了每年翻一番的硬件性能, 整个后端架构需要更精细化地运作. 像以前那样用昂贵的全文索引或者列式存储直接存大量低价值的日志信息(99%没人看)已经不合时宜了. 在程序的运行信息(“日志”)和埋点,用户行为等业务信息(也是”日志”)之间进行业务,抽象与架构上的逐步切分, 让各自的架构适应到各自的 ROI 最大的那个点上, 会是未来的趋势, 而 <code>Grafana Loki</code> 则恰到好处地把握住了这个趋势.</p>
<hr>
<p><a href=https://www.aleiwu.com/tags/monitoring>monitoring</a></p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p><a href=https://www.infoq.cn/article/thfsXOQwv0lL>https://www.infoq.cn/article/thfsXOQwv0lL</a>*5UDAkjF</p>
</li>
<li>
<p><a href=https://speakerdeck.com/davkal/on-the-path-to-full-observability-with-oss-and-launch-of-loki>KubeCon 的 Slides</a></p>
</li>
<li>
<p><a href=https://docs.google.com/document/d/11tjK_lvp1-SVsFZjgOTr1vV3-q6vBAsZYIQ5ZeYBkyM/view>design doc</a></p>
</li>
<li>
<p><a href=https://grafana.com/blog/2018/12/12/loki-prometheus-inspired-open-source-logging-for-cloud-natives/>一篇介绍性的 Blog</a></p>
</li>
<li>
<p><a href=https://github.com/grafana/loki#getting-started>Github 主页上的 Getting Started</a></p>
</li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2020-12-25 10:57:29
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/monitor/>monitor</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/14.language/golang/gorocksdb%E7%BC%96%E8%AF%91/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">gorocksdb 编译</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/70.tool/grub/>
<span class="next-text nav-default">grub</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/l2d/L2Dwidget.min.js></script>
<script src=/js/l2d/L2Dwidget.0.min.js></script>
<script src=/js/l2d/L2Dwidget.init.js></script>
</body>
</html>