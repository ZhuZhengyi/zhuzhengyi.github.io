<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Prometheus配置 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Prometheus配置 简介 Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的B">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/36.monitor/prometheus/prometheus%E9%85%8D%E7%BD%AE/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Prometheus配置">
<meta property="og:description" content="Prometheus配置 简介 Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的B">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/36.monitor/prometheus/prometheus%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-02-11T00:00:00+00:00">
<meta property="article:modified_time" content="2022-02-11T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Prometheus配置">
<meta itemprop=description content="Prometheus配置 简介 Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的B"><meta itemprop=datePublished content="2022-02-11T00:00:00+00:00">
<meta itemprop=dateModified content="2022-02-11T00:00:00+00:00">
<meta itemprop=wordCount content="4415">
<meta itemprop=keywords content="monitor,prometheus,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Prometheus配置">
<meta name=twitter:description content="Prometheus配置 简介 Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的B"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Prometheus配置</h1>
<div class=post-meta>
<time datetime=2022-02-11 class=post-time>
2022-02-11
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/monitor/> monitor </a>
<a href=https://justice.bj.cn/categories/prometheus/> prometheus </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#特点>特点</a></li>
<li><a href=#架构>架构</a></li>
<li><a href=#工作流程>工作流程</a></li>
<li><a href=#数据模型>数据模型</a></li>
<li><a href=#指标类型>指标类型</a></li>
<li><a href=#存储模型>存储模型</a></li>
<li><a href=#高可用方案>高可用方案</a></li>
<li><a href=#存储原理>存储原理</a>
<ul>
<li></li>
<li><a href=#内存使用>内存使用</a></li>
<li><a href=#storage参数>storage参数</a></li>
<li><a href=#storagelocalmemory-chunks>storage.local.memory-chunks</a></li>
<li><a href=#storagelocalretention>storage.local.retention</a></li>
<li><a href=#storagelocalseries-file-shrink-ratio>storage.local.series-file-shrink-ratio</a></li>
<li><a href=#storagelocalmax-chunks-to-persist>storage.local.max-chunks-to-persist</a></li>
<li><a href=#storagelocalnum-fingerprint-mutexes>storage.local.num-fingerprint-mutexes</a></li>
<li><a href=#索引><strong>索引</strong></a></li>
<li><a href=#联邦federate集群>联邦（federate）集群</a></li>
<li><a href=#go_metrics>go_metrics</a></li>
</ul>
</li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=prometheus配置>Prometheus配置</h1>
<hr>
<h2 id=简介>简介</h2>
<p>Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的Brog系统演变而来），从2012年开始由前Google工程师在Soundcloud以开源软件的形式进行研发，并且于2015年早期对外发布早期版本。2016年5月继Kubernetes之后成为第二个正式加入CNCF基金会的项目，同年6月正式发布1.0版本。2017年底发布了基于全新存储层的2.0版本，能更好地与容器平台、云平台配合。</p>
<hr>
<h2 id=特点>特点</h2>
<ul>
<li><strong>易于部署</strong>：单一二进制文件，部署简单</li>
<li><strong>高效数据模型</strong>：监控指标以时序序列保存在存储中，并可灵活设置标签来对数据不同维度进行区分；</li>
<li><strong>强大查询语言</strong>PromQL：内置的PromQL支持查询、聚合、过滤等复杂操作，可实现高效的查询；</li>
<li><strong>易于扩展</strong>：支持分区和联邦集群部署，并可结合thano实现分布式部署；</li>
<li><strong>易于集成</strong>：支持多种语言SDK，拥有大量第三方集成模块，可方便与第三方系统进行集成</li>
</ul>
<hr>
<h2 id=架构>架构</h2>
<p>Prometheus 的主要模块包括：Prometheus server, exporters, Pushgateway, PromQL, Alertmanager 以及图形界面。</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/11-11-51-35-2022-02-11-11-51-30-image.png alt></p>
<hr>
<h2 id=工作流程>工作流程</h2>
<ol>
<li>Prometheus server 定期从配置好的 jobs 或者 exporters 中拉 metrics，或者接收来自 Pushgateway 发过来的 metrics，或者从其他的 Prometheus server 中拉 metrics。</li>
<li>Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，记录新的时间序列或者向 Alertmanager 推送警报。</li>
<li>Alertmanager 根据配置文件，对接收到的警报进行处理，发出告警。</li>
<li>在图形界面中，可视化采集数据。</li>
</ol>
<h2 id=数据模型>数据模型</h2>
<p>Prometheus 中存储的数据为时间序列，是由 metric 的名字和一系列的标签（键值对）唯一标识的，不同的标签则代表不同的时间序列，如：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>api_http_requests_total{path=&#34;/users&#34;,status=200,method=&#34;GET&#34;,instance=&#34;10.111.201.26&#34;}  100
</code></pre></td></tr></table>
</div>
</div><p>该时序的名字为 api_http_requests_total，标签为 path、status、method 和 instance，只有时序名字和标签键值完全相同的时序才是同一个时序。事实上，时序名字就是一个隐藏标签：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>{name=&#34;api_http_requests_total&#34;,path=&#34;/users&#34;,status=200,method=&#34;GET&#34;,instance=&#34;10.111.201.26&#34;}  100
</code></pre></td></tr></table>
</div>
</div><h2 id=指标类型>指标类型</h2>
<p>Prometheus的时序数据包含以下四种类型：</p>
<ul>
<li><strong>Counter</strong>: 用于累计计数，例如用来记录请求次数。Counter的特点是一直增加不会减少。</li>
<li><strong>Gauge</strong>：用于记录常规数值，可以增加或减少。例如用来记录CPU、内存的变化</li>
<li><strong>Histogram</strong>：可理解为直方图，常用于跟踪事件发生的规模，如请求耗时、响应大小。可对记录的内容分组和聚合(count,sum等)，例如响应时间小于500毫秒的多少次、500毫秒~1000毫秒之间多少次、1000毫秒以上的多少次</li>
<li><strong>Summary</strong>：与Histogram类似，但支持按百分比跟踪结果</li>
</ul>
<hr>
<h2 id=存储模型>存储模型</h2>
<p>prometheus是一个时序型KV数据库，时序数据拥有<em>垂直写，水平读</em>的特点，在此基础上</p>
<ul>
<li>
<p>第1代: Prototype：直接利用LevelDB作为本地持久化存储，</p>
</li>
<li>
<p>第2代: Prometheus V1</p>
</li>
<li>
<p>第3代: Prometheus V2</p>
</li>
</ul>
<hr>
<h2 id=高可用方案>高可用方案</h2>
<hr>
<h2 id=存储原理>存储原理</h2>
<p>Prometheus按2小时一个block进行存储，每个block由一个目录组成，该目录里包含：</p>
<ul>
<li>
<p>一个或者多个chunk文件（保存timeseries数据）；</p>
</li>
<li>
<p>一个metadata文件；</p>
</li>
<li>
<p>一个index文件（通过metric name和labels查找timeseries数据在chunk文件的位置）。</p>
</li>
</ul>
<p>最新写入的数据保存在内存block中，达到2小时后写入磁盘。为了防止程序崩溃导致数据丢失，实现了WAL（write-ahead-log）机制，启动时会以写入日志(WAL)的方式来实现重播，从而恢复数据。</p>
<p>删除数据时，删除条目会记录在独立的tombstone文件中，而不是立即从chunk文件删除。</p>
<p>通过时间窗口的形式保存所有的样本数据，可以明显提高Prometheus的查询效率，当查询一段时间范围内的所有样本数据时，只需要简单的从落在该范围内的块中查询数据即可。</p>
<p>这些2小时的block会在后台压缩成更大的block，数据压缩合并成更高level的block文件后删除低level的block文件。这个和leveldb、rocksdb等LSM树的思路一致。</p>
<p>这些设计和Gorilla的设计高度相似，所以Prometheus几乎就是等于一个缓存TSDB。它本地存储的特点决定了它不能用于long-term数据存储，只能用于短期窗口的timeseries数据保存和查询，并且不具有高可用性（宕机会导致历史数据无法读取）。</p>
<p>内存中的block数据未写入磁盘时，block目录下面主要保存wal文件:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>./data/01BKGV7JBM69T2G1BGBGM6KB12
./data/01BKGV7JBM69T2G1BGBGM6KB12/meta.json
./data/01BKGV7JBM69T2G1BGBGM6KB12/wal/000002
./data/01BKGV7JBM69T2G1BGBGM6KB12/wal/000001
</code></pre></td></tr></table>
</div>
</div><p>持久化的block目录下wal文件被删除，timeseries数据保存在chunk文件里。index用于索引timeseries在wal文件里的位置。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>./data/01BKGV7JC0RY8A6MACW02A2PJD
./data/01BKGV7JC0RY8A6MACW02A2PJD/meta.json
./data/01BKGV7JC0RY8A6MACW02A2PJD/index
./data/01BKGV7JC0RY8A6MACW02A2PJD/chunks
./data/01BKGV7JC0RY8A6MACW02A2PJD/chunks/000001
./data/01BKGV7JC0RY8A6MACW02A2PJD/tombstones
</code></pre></td></tr></table>
</div>
</div><hr>
<h4 id=存储配置>存储配置</h4>
<p>对于本地存储，prometheus提供了一些配置项，主要包括：</p>
<ul>
<li>–storage.tsdb.path: 存储数据的目录，默认为data/，如果要挂外部存储，可以指定该目录</li>
<li>–storage.tsdb.retention.time: 数据过期清理时间，默认保存15天</li>
<li>–storage.tsdb.retention.size: 实验性质，声明数据块的最大值，不包括wal文件，如512MB</li>
<li>–storage.tsdb.retention: 已被废弃，改为使用storage.tsdb.retention.time</li>
</ul>
<p>Prometheus将所有当前使用的块保留在内存中。此外，它将最新使用的块保留在内存中，最大内存可以通过storage.local.memory-chunks标志配置。</p>
<p>监测当前使用的内存量：</p>
<ul>
<li>prometheus_local_storage_memory_chunks</li>
<li>process_resident_memory_bytes</li>
</ul>
<p>监测当前使用的存储指标：</p>
<ul>
<li>prometheus_local_storage_memory_series: 时间序列持有的内存当前块数量</li>
<li>prometheus_local_storage_memory_chunks: 在内存中持久块的当前数量</li>
<li>prometheus_local_storage_chunks_to_persist: 当前仍然需要持久化到磁盘的的内存块数量</li>
<li>prometheus_local_storage_persistence_urgency_score: 紧急程度分数</li>
</ul>
<hr>
<h3 id=内存使用>内存使用</h3>
<p>prometheus在内存里保存了最近使用的chunks，具体chunks的最大个数可以通过storage.local.memory-chunks来设定，默认值为1048576，即1048576个chunk，大小为1G。<br>
除了采用的数据，prometheus还需要对数据进行各种运算，因此整体内存开销肯定会比配置的local.memory-chunks大小要来的大，因此官方建议要预留3倍的local.memory-chunks的内存大小。</p>
<blockquote>
<p>As a rule of thumb, you should have at least three times more RAM available than needed by the memory chunks alone</p>
</blockquote>
<p>可以通过server的metrics去查看prometheus_local_storage_memory_chunks以及process_resident_memory_byte两个指标值。</p>
<ul>
<li>prometheus_local_storage_memory_chunks</li>
</ul>
<blockquote>
<p>The current number of chunks in memory, excluding cloned chunks<br>
目前内存中暴露的chunks的个数</p>
</blockquote>
<ul>
<li>process_resident_memory_byte</li>
</ul>
<blockquote>
<p>Resident memory size in bytes<br>
驻存在内存的数据大小</p>
</blockquote>
<ul>
<li>prometheus_local_storage_persistence_urgency_score<br>
介于0-1之间，当该值小于等于0.7时，prometheus离开rushed模式。</li>
</ul>
<p>当大于0.8的时候，进入rushed模式</p>
<ul>
<li>prometheus_local_storage_rushed_mode<br>
1表示进入了rushed mode，0表示没有。进入了rushed模式的话，prometheus会利用storage.local.series-sync-strategy以及storage.local.checkpoint-interval的配置加速chunks的持久化。</li>
</ul>
<hr>
<h3 id=storage参数>storage参数</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>docker run -p 9090:9090 <span class=se>\
</span><span class=se></span>    -v /tmp/prometheus-data:/prometheus-data <span class=se>\
</span><span class=se></span>    prom/prometheus <span class=se>\
</span><span class=se></span>    -storage.local.retention 168h0m0s <span class=se>\
</span><span class=se></span>    -storage.local.max-chunks-to-persist <span class=m>3024288</span> <span class=se>\
</span><span class=se></span>    -storage.local.memory-chunks<span class=o>=</span><span class=m>50502740</span> <span class=se>\
</span><span class=se></span>    -storage.local.num-fingerprint-mutexes<span class=o>=</span><span class=m>300960</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=storagelocalmemory-chunks>storage.local.memory-chunks</h3>
<p>设定prometheus内存中保留的chunks的最大个数，默认为1048576，即为1G大小</p>
<h3 id=storagelocalretention>storage.local.retention</h3>
<p>用来配置采用数据存储的时间，168h0m0s即为24*7小时，即1周</p>
<h3 id=storagelocalseries-file-shrink-ratio>storage.local.series-file-shrink-ratio</h3>
<p>用来控制序列文件rewrite的时机，默认是在10%的chunks被移除的时候进行rewrite，如果磁盘空间够大，不想频繁rewrite，可以提升该值，比如0.3，即30%的chunks被移除的时候才触发rewrite。</p>
<h3 id=storagelocalmax-chunks-to-persist>storage.local.max-chunks-to-persist</h3>
<p>该参数控制等待写入磁盘的chunks的最大个数，如果超过这个数，Prometheus会限制采样的速率，直到这个数降到指定阈值的95%。建议这个值设定为storage.local.memory-chunks的50%。Prometheus会尽力加速存储速度，以避免限流这种情况的发送。</p>
<h3 id=storagelocalnum-fingerprint-mutexes>storage.local.num-fingerprint-mutexes</h3>
<p>当prometheus server端在进行checkpoint操作或者处理开销较大的查询的时候，采集指标的操作会有短暂的停顿，这是因为prometheus给时间序列分配的mutexes可能不够用，可以通过这个指标来增大预分配的mutexes，有时候可以设置到上万个。</p>
<h4 id=storagelocalseries-sync-strategy>storage.local.series-sync-strategy</h4>
<p>控制写入数据之后，何时同步到磁盘，有&rsquo;never', &lsquo;always&rsquo;, &lsquo;adaptive&rsquo;. 同步操作可以降低因为操作系统崩溃带来数据丢失，但是会降低写入数据的性能。<br>
默认为adaptive的策略，即不会写完数据就立刻同步磁盘，会利用操作系统的page cache来批量同步。</p>
<h4 id=storagelocalcheckpoint-interval>storage.local.checkpoint-interval</h4>
<p>进行checkpoint的时间间隔，即对尚未写入到磁盘的内存chunks执行checkpoint操作。</p>
<hr>
<h3 id=索引><strong>索引</strong></h3>
<p>一般prometheus的查询是把metric+label做关键字的，而且是很宽泛，完全用户自定义的字符，因此没办法使用常规的sql数据库，prometheus的存储层使用了全文检索中的<a href=https://nlp.stanford.edu/IR-book/html/htmledition/a-first-take-at-building-an-inverted-index-1.html>倒排索引</a>概念，将每个时间序列视为一个小文档。而metric和label对应的是文档中的单词。</p>
<p>例如，requests_total{path=”/status”, method=”GET”, instance=”10.0.0.1:80″}是包含以下单词的文档：</p>
<ul>
<li><strong>name</strong>=”requests_total”</li>
<li>path=”/status”</li>
<li>method=”GET”</li>
</ul>
<hr>
<h3 id=联邦federate集群>联邦（federate）集群</h3>
<p>每一个Prometheus Server都包含一个/federate的接口，可用来获取当前节点中的监控数据。因此可通过该接口对整个prometheus集群进行拆分组合，建立分级节点，以做到集群的扩展，此模式称为联邦模式。</p>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/11/03-15-48-04-image-20190425092255032.png?token=AARMIEXWLIVX5F5HMVN5YMS7UEFXE" alt=image-20190425092255032></p>
<p>3级联邦集群</p>
<ul>
<li>
<p>L0：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=c># my global config</span><span class=w>
</span><span class=w></span><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;/export/App/prometheus/conf/*_rules.yml&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Here it&#39;s Prometheus itself.</span><span class=w>
</span><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hbase&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>      </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>45s</span><span class=w>
</span><span class=w>      </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/federate&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>&#39;match[]&#39;</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=s1>&#39;{service=~&#34;.base&#34;}&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.132.62</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.5.176</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.166.111</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.166.112</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.198.231</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.53.221</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.230.96</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.134.32</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>L1</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=c># my global config</span><span class=w>
</span><span class=w></span><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;/export/App/prometheus/conf/*_rules.yml&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Here it&#39;s Prometheus itself.</span><span class=w>
</span><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hbase&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>      </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>45s</span><span class=w>
</span><span class=w>      </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/federate&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>&#39;match[]&#39;</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=s1>&#39;{service=~&#34;.base&#34;}&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]</span><span class=w>
</span><span class=w>          </span><span class=nt>modulus</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w>  </span><span class=l>__tmp_hash</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w>        </span><span class=l>hashmod</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__tmp_hash]</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w>  </span><span class=l>^1$  </span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w>  </span><span class=l>keep</span><span class=w>
</span><span class=w>      </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.95.179</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.5.41</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.5.42</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.196.172</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.37.33</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.37.34</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.97.88</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.108.239</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.108.240</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.131.202</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.165.240</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.228.41</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.163.237</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.163.236</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.228.40</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.247.2</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.17.130.94</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.163.235</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.70.175</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>            </span>- <span class=m>11.18.131.201</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span><span class=w>
</span><span class=w>            </span><span class=m>11.18.28.106</span><span class=w>
</span><span class=w>            </span><span class=m>11.18.166.71</span><span class=w>    
</span><span class=w>            </span><span class=m>11.18.85.93</span><span class=w>
</span><span class=w>            </span><span class=m>11.18.28.107</span><span class=w>
</span><span class=w>            </span><span class=m>11.17.198.232</span><span class=w>
</span><span class=w>            </span><span class=m>11.18.134.35</span><span class=w>
</span><span class=w>            </span><span class=m>11.17.230.97</span><span class=w>
</span><span class=w>            </span><span class=m>11.17.98.43</span><span class=w>
</span><span class=w>            </span><span class=m>11.18.85.92</span><span class=w>
</span><span class=w>            </span><span class=m>11.18.134.34</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>L2</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=c># my global config</span><span class=w>
</span><span class=w></span><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w></span><span class=c># Alertmanager configuration</span><span class=w>
</span><span class=w></span><span class=c>#alerting:</span><span class=w>
</span><span class=w></span><span class=c>#  alertmanagers:</span><span class=w>
</span><span class=w></span><span class=c>#  - static_configs:</span><span class=w>
</span><span class=w></span><span class=c>#    - targets:</span><span class=w>
</span><span class=w></span><span class=c>#      - ALERTMANAGER_ADDR:9093</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;/export/App/prometheus/conf/*_rules.yml&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Here it&#39;s Prometheus itself.</span><span class=w>
</span><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;consul&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;__meta_consul_service&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;(.*)&#34;</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${1}&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;service&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;__meta_consul_tags&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;,(?:[^,]+,){0}([^=]+)=([^,]+),.*&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${2}&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${1}&#39;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;__meta_consul_tags&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;,(?:[^,]+,){1}([^=]+)=([^,]+),.*&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${2}&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${1}&#39;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;__meta_consul_tags&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;,(?:[^,]+,){2}([^=]+)=([^,]+),.*&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${2}&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${1}&#39;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]</span><span class=w>
</span><span class=w>          </span><span class=nt>modulus</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w>  </span><span class=l>__tmp_hash</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w>        </span><span class=l>hashmod</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__tmp_hash]</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w>  </span><span class=l>^1$  </span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w>  </span><span class=l>keep</span><span class=w>
</span><span class=w>    </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>    </span><span class=nt>consul_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>11.25.146.232</span><span class=p>:</span><span class=m>8500</span><span class=w>
</span><span class=w>          </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=l>hbase</span><span class=w>
</span><span class=w>              </span>- <span class=l>cbase</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h3 id=go_metrics>go_metrics</h3>
<ul>
<li>go_memstats_alloc_bytes: Number of bytes allocated and still in use</li>
<li>go_memstats_alloc_bytes_total: Total number of bytes allocated, even if freed.</li>
<li>go_memstats_buck_hash_sys_bytes: Number of bytes used by the profiling bucket hash table.</li>
<li>go_memstats_frees_total: Total number of frees.</li>
<li>go_memstats_gc_cpu_fraction: The fraction of this program&rsquo;s available CPU time used by the GC since the program started.</li>
<li>go_memstats_gc_sys_bytes: Number of bytes used for garbage collection system metadata.</li>
<li>go_memstats_heap_alloc_bytes: Number of heap bytes allocated and still in use.</li>
<li>go_memstats_heap_idle_bytes: Number of heap bytes waiting to be used.</li>
<li>go_memstats_heap_inuse_bytes: Number of heap bytes that are in use.</li>
<li>go_memstats_heap_objects: Number of allocated objects.</li>
<li>go_memstats_heap_released_bytes: Number of heap bytes released to OS.</li>
<li>go_memstats_heap_sys_bytes: Number of heap bytes obtained from system.</li>
<li>go_memstats_last_gc_time_seconds: Number of seconds since 1970 of last garbage collection.</li>
<li>go_memstats_lookups_total: Total number of pointer lookups.</li>
<li>go_memstats_mallocs_total: Total number of mallocs.</li>
<li>go_memstats_mcache_inuse_bytes: Number of bytes in use by mcache structures.</li>
<li>go_memstats_mcache_sys_bytes: Number of bytes used for mcache structures obtained from system.</li>
<li>go_memstats_mspan_inuse_bytes: Number of bytes in use by mspan structures.</li>
<li>go_memstats_next_gc_bytes: Number of heap bytes when next garbage collection will take place.</li>
<li>go_memstats_other_sys_bytes: Number of bytes used for other system allocations.</li>
<li>go_memstats_stack_inuse_bytes: Number of bytes in use by the stack allocator.</li>
<li>go_memstats_stack_sys_bytes: Number of bytes obtained from system for stack allocator.</li>
<li>go_memstats_sys_bytes: Number of bytes obtained from system.</li>
</ul>
<hr>
<h2 id=参考>参考</h2>
<ol>
<li><a href=https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/quickstart/why-monitor>https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/quickstart/why-monitor</a></li>
<li><a href=http://dockerone.com/article/8605>Prometheus 不完全避坑指南 - DockOne.io</a></li>
<li><a href=http://dockerone.com/article/10143>Prometheus Metrics 设计的最佳实践和应用实例 - DockOne.io</a></li>
<li></li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-02-11
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/monitor/>monitor</a>
<a href=https://justice.bj.cn/tags/prometheus/>prometheus</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/36.monitor/prometheus/prometheus%E4%B9%8B%E7%9B%B4%E6%96%B9%E5%9B%BE/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Prometheus直方图</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/rcfile/>
<span class="next-text nav-default">RCFile</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js></script>
<script src=/js/l2d.js></script>
</body>
</html>