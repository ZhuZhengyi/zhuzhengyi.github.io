<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Zipkin分布式追踪系统 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Zipkin分布式追踪系统 前言 传统单机系统在使用过程中，如果某个请求响应过慢或是响应出错，开发人员可以清楚知道某个请求出了问题，查看日志可以">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/36.monitor/zipkin/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Zipkin分布式追踪系统">
<meta property="og:description" content="Zipkin分布式追踪系统 前言 传统单机系统在使用过程中，如果某个请求响应过慢或是响应出错，开发人员可以清楚知道某个请求出了问题，查看日志可以">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/36.monitor/zipkin/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-10-10T00:00:00+00:00">
<meta property="article:modified_time" content="2021-10-10T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Zipkin分布式追踪系统">
<meta itemprop=description content="Zipkin分布式追踪系统 前言 传统单机系统在使用过程中，如果某个请求响应过慢或是响应出错，开发人员可以清楚知道某个请求出了问题，查看日志可以"><meta itemprop=datePublished content="2021-10-10T00:00:00+00:00">
<meta itemprop=dateModified content="2021-10-10T00:00:00+00:00">
<meta itemprop=wordCount content="6142">
<meta itemprop=keywords content="monitor,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Zipkin分布式追踪系统">
<meta name=twitter:description content="Zipkin分布式追踪系统 前言 传统单机系统在使用过程中，如果某个请求响应过慢或是响应出错，开发人员可以清楚知道某个请求出了问题，查看日志可以"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Zipkin分布式追踪系统</h1>
<div class=post-meta>
<time datetime=2021-10-10 class=post-time>
2021-10-10
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/monitor/> monitor </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#前言>前言</a></li>
<li><a href=#整体结构长啥样>整体结构长啥样</a></li>
<li><a href=#基本概念了解下>基本概念了解下</a></li>
<li><a href=#具体怎么追踪的>具体怎么追踪的</a></li>
<li><a href=#1分钟安装zipkin>1分钟安装zipkin</a></li>
<li><a href=#写个demo用起来spring-boot整合zipkin>写个Demo用起来（Spring Boot整合zipkin）</a>
<ul>
<li><a href=#maven-依赖zipkin_client>maven 依赖（zipkin_client）</a></li>
<li><a href=#配置类编写zipkin_client>配置类编写（zipkin_client）</a></li>
<li><a href=#boot-服务模块>boot 服务模块</a></li>
<li><a href=#启动验证>启动验证</a></li>
</ul>
</li>
<li><a href=#span数据结构详解>span数据结构详解</a>
<ul>
<li><a href=#json结构概览与各字段含义>json结构概览与各字段含义</a></li>
<li><a href=#聊聊-annotation-和-kind-的前世姻缘>聊聊 annotation 和 kind 的前世姻缘</a></li>
<li><a href=#再看demo中追踪链路的json数据>再看Demo中追踪链路的JSON数据</a></li>
</ul>
</li>
<li><a href=#结束语>结束语</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=zipkin分布式追踪系统>Zipkin分布式追踪系统</h1>
<h2 id=前言>前言</h2>
<p>传统单机系统在使用过程中，如果某个请求响应过慢或是响应出错，开发人员可以清楚知道某个请求出了问题，查看日志可以定位到具体方法。但是在分布式系统中，倘若客户端一个请求到达服务器后，由多个服务协作完成。比如：服务A调用服务B，服务B又调用服务C和服务D，服务D又调用服务E，那么想要知道是哪个服务处理时间过长或是处理异常导致这个请求响应缓慢或中断的话，就需要开发人员一个服务接一个服务的去机器上查看日志，先定位到出问题的服务，再定位出问题的具体地方。试想一下，随着系统越来越壮大，服务越来越多，一个请求对应处理的服务调用链越来越长，这种排查方式何其艰难。为了解决这种问题，便诞生了各种分布式场景中追踪问题的解决方案，zipkin就是其中之一。</p>
<h2 id=整体结构长啥样>整体结构长啥样</h2>
<p>一个独立的分布式追踪系统，客户端存在于应用中（即各服务中），应具备追踪信息生成、采集发送等功能，而服务端应该包含以下基本的三个功能：</p>
<ul>
<li>信息收集：用来收集各服务端采集的信息，并对这些信息进行梳理存储、建立索引。</li>
<li>数据存储：存储追踪数据。</li>
<li>查询服务：提供查询请求链路信息的接口。</li>
</ul>
<p>zipkin 整体结构图如下：</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f7fabf207ba3?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt="zipkin 结构图"></p>
<p>zipkin(服务端)包含四个组件，分别是collector、storage、search、web UI。</p>
<ul>
<li>collector 就是信息收集器,作为一个守护进程，它会时刻等待客户端传递过来的追踪数据，对这些数据进行验证、存储以及创建查询需要的索引。</li>
<li>storage 是存储组件。zipkin 默认直接将数据存在内存中，此外支持使用Cassandra、ElasticSearch 和 Mysql。</li>
<li>search 是一个查询进程，它提供了简单的JSON API来供外部调用查询。</li>
<li>web UI 是zipkin的服务端展示平台，主要调用search提供的接口，用图表将链路信息清晰地展示给开发人员。</li>
</ul>
<p>zipkin的客户端主要负责根据应用的调用情况生成追踪信息，并且将这些追踪信息发送至zipkin由收集器接收。各语言支持均不同，具体可以查看<a href=https://zipkin.io/pages/tracers_instrumentation.html>zipkin官网</a>,java语言的支持就是brave。上面结构图中，有追踪器就是指集成了brave。</p>
<h2 id=基本概念了解下>基本概念了解下</h2>
<p>在使用zipkin之前，先了解一下Trace和Span这两个基本概念。一个请求到达应用后所调用的所有服务所有服务组成的调用链就像一个树结构（如下图），我们<strong>追踪</strong>这个调用<strong>链路</strong>得到的这个树结构可以称之为<strong>Trace</strong>。</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f85bbaffeb7e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p>
<p>在一次Trace中，每个服务的<strong>每一次调用</strong>，就是一个<strong>基本工作单元</strong>，就像上图中的每一个树节点，称之为<strong>span</strong>。每一个span都有一个<strong>id作为唯一标识</strong>，同样每一次Trace都会生成一个<strong>traceId在span中作为追踪标识</strong>，另外再通过一个<strong>parentId标明本次调用的发起者</strong>（就是发起者的span-id）。当span有了上面三个标识后，就可以很清晰的将多个span进行梳理串联，最终归纳出一条完整的跟踪链路。此外，span还会有其他数据，比如：名称、节点上下文、时间戳以及K-V结构的tag信息等等（Zipkin v1核心注解如“cs”和“sr”已被Span.Kind取代，详情查看<a href=https://zipkin.io/zipkin-api/#/>zipkin-api</a>，本文会在入门的demo介绍完后对具体的Span数据模型进行说明）。</p>
<h2 id=具体怎么追踪的>具体怎么追踪的</h2>
<p>追踪器位于应用程序上，负责生成相关ID、记录span需要的信息，最后通过传输层传递给服务端的收集器。我们首先思考下面几个问题：</p>
<ul>
<li>每个span需要的基本信息何时生成？</li>
<li>哪些信息需要随着服务调用传递给服务提供方？</li>
<li>什么时候发送span至zipkin 服务端？</li>
<li>以何种方式发送span?</li>
</ul>
<p>一个 span 表示一次服务调用，那么追踪器必定是被服务调用发起的动作触发，生成基本信息，同时为了追踪服务提供方对其他服务的调用情况，便需要传递本次追踪链路的traceId和本次调用的span-id。服务提供方完成服务将结果响应给调用方时，需要根据调用发起时记录的时间戳与当前时间戳计算本次服务的持续时间进行记录，至此这次调用的追踪span完成，就可以发送给zipkin服务端了。但是需要注意的是，发送span给zipkin collector不得影响此次业务结果，其发送成功与否跟业务无关，因此这里需要采用异步的方式发送，防止追踪系统发送延迟与发送失败导致用户系统的延迟与中断。下图就表示了一次http请求调用的追踪流程（基于zipkin官网提供的流程图）：</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f8df1ee94a56?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt=一次http请求调用的追踪流程></p>
<p>可以看出服务A请求服务B时先被追踪器拦截，记录tag信息、时间戳，同时将追踪标识添加进http header中传递给服务B，在服务B响应后，记录持续时间，最终采取异步的方式发送给zipkin收集器。span从被追踪的服务传送到Zipkin收集器有三种主要的传送方式：http、Kafka以及Scribe（Facebook开源的日志收集系统）。</p>
<h2 id=1分钟安装zipkin>1分钟安装zipkin</h2>
<p>上文对基于zipkin实现分布式追踪系统的原理做了全面的说明，这里简单介绍一下zipkin的安装方法，下载jar包，直接运行。简单粗暴，但要注意必须jdk1.8及以上。其余两种安装方式见官方介绍。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>wget -O zipkin.jar &#39;https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec&#39;
java -jar zipkin.jar
复制代码
</code></pre></td></tr></table>
</div>
</div><p>启动成功后，打开浏览器访问zipkin的webUI，输入http://ip:9411/,显示页面如下图。具体使用后面介绍。</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f90852a44524?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p>
<h2 id=写个demo用起来spring-boot整合zipkin>写个Demo用起来（Spring Boot整合zipkin）</h2>
<p>java版客户端 Brave的官方文档很少，都在github里。小白当时找的那叫个头疼啊，网上各路大神写的博客中的代码你扒下来换最新的依赖后都会显示那些类被标记为过时，不建议使用。</p>
<ul>
<li>
<p>brave 源码地址：<a href=https://github.com/openzipkin/brave>github.com/openzipkin/…</a></p>
</li>
<li>
<p>官方demo地址：<a href=https://github.com/openzipkin/brave-webmvc-example>github.com/openzipkin/…</a></p>
</li>
<li>
<p>友情提示：本节代码较多，注释还算详细，介绍文字偏少。 小白写的demo结构如下图，分别创建了service1、service2、service3三个boot应用，将brave整合部分单独作为一个module，这样可以嵌入服务中复用，避免重复编码。</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f919f534f99f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p>
</li>
</ul>
<h3 id=maven-依赖zipkin_client>maven 依赖（zipkin_client）</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class=nt>&lt;project</span> <span class=na>xmlns=</span><span class=s>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class=na>xsi:schemaLocation=</span><span class=s>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>

    <span class=nt>&lt;groupId&gt;</span>com.ycg<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>zipkin_client<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>1.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;name&gt;</span>zipkin_client<span class=nt>&lt;/name&gt;</span>

    <span class=nt>&lt;build&gt;</span>
        <span class=nt>&lt;plugins&gt;</span>
            <span class=nt>&lt;plugin&gt;</span>
                <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
                <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
                <span class=nt>&lt;configuration&gt;</span>
                    <span class=nt>&lt;source&gt;</span>6<span class=nt>&lt;/source&gt;</span>
                    <span class=nt>&lt;target&gt;</span>6<span class=nt>&lt;/target&gt;</span>
                <span class=nt>&lt;/configuration&gt;</span>
            <span class=nt>&lt;/plugin&gt;</span>
        <span class=nt>&lt;/plugins&gt;</span>
    <span class=nt>&lt;/build&gt;</span>
    <span class=nt>&lt;packaging&gt;</span>jar<span class=nt>&lt;/packaging&gt;</span>

    <span class=nt>&lt;properties&gt;</span>
        <span class=nt>&lt;java.version&gt;</span>1.8<span class=nt>&lt;/java.version&gt;</span>
        <span class=nt>&lt;spring-boot.version&gt;</span>2.1.1.RELEASE<span class=nt>&lt;/spring-boot.version&gt;</span>
        <span class=nt>&lt;brave.version&gt;</span>5.6.0<span class=nt>&lt;/brave.version&gt;</span>
    <span class=nt>&lt;/properties&gt;</span>

    <span class=nt>&lt;dependencyManagement&gt;</span>
        <span class=nt>&lt;dependencies&gt;</span>
            <span class=nt>&lt;dependency&gt;</span>
                <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
                <span class=nt>&lt;artifactId&gt;</span>spring-boot-dependencies<span class=nt>&lt;/artifactId&gt;</span>
                <span class=nt>&lt;version&gt;</span>${spring-boot.version}<span class=nt>&lt;/version&gt;</span>
                <span class=nt>&lt;type&gt;</span>pom<span class=nt>&lt;/type&gt;</span>
                <span class=nt>&lt;scope&gt;</span>import<span class=nt>&lt;/scope&gt;</span>
            <span class=nt>&lt;/dependency&gt;</span>
            <span class=nt>&lt;dependency&gt;</span>
                <span class=nt>&lt;groupId&gt;</span>io.zipkin.brave<span class=nt>&lt;/groupId&gt;</span>
                <span class=nt>&lt;artifactId&gt;</span>brave-bom<span class=nt>&lt;/artifactId&gt;</span>
                <span class=nt>&lt;version&gt;</span>${brave.version}<span class=nt>&lt;/version&gt;</span>
                <span class=nt>&lt;type&gt;</span>pom<span class=nt>&lt;/type&gt;</span>
                <span class=nt>&lt;scope&gt;</span>import<span class=nt>&lt;/scope&gt;</span>
            <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;/dependencies&gt;</span>
    <span class=nt>&lt;/dependencyManagement&gt;</span>

    <span class=nt>&lt;dependencies&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.httpcomponents<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>httpclient<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=c>&lt;!-- zipkin客户端依赖 --&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>io.zipkin.brave<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>brave<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>io.zipkin.reporter2<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>zipkin-sender-okhttp3<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=c>&lt;!-- 添加记录MVC的类、方法名到span的依赖 --&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>io.zipkin.brave<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>brave-instrumentation-spring-webmvc<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=c>&lt;!-- 添加brave的httpclient依赖 --&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>io.zipkin.brave<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>brave-instrumentation-httpclient<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
        <span class=c>&lt;!-- 集成Brave上下文的log --&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>io.zipkin.brave<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>brave-context-slf4j<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;/dependencies&gt;</span>

<span class=nt>&lt;/project&gt;</span>
复制代码
</code></pre></td></tr></table>
</div>
</div><h3 id=配置类编写zipkin_client>配置类编写（zipkin_client）</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>com.ycg.zipkin_client</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>brave.CurrentSpanCustomizer</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.SpanCustomizer</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.Tracing</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.context.slf4j.MDCScopeDecorator</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.http.HttpTracing</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.httpclient.TracingHttpClientBuilder</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.propagation.B3Propagation</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.propagation.ExtraFieldPropagation</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.propagation.ThreadLocalCurrentTraceContext</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.servlet.TracingFilter</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>brave.spring.webmvc.SpanCustomizingAsyncHandlerInterceptor</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.impl.client.CloseableHttpClient</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.beans.factory.annotation.Value</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.boot.web.client.RestTemplateCustomizer</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Bean</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Import</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.http.client.HttpComponentsClientHttpRequestFactory</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.client.RestTemplate</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.servlet.config.annotation.InterceptorRegistry</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>zipkin2.Span</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>zipkin2.reporter.AsyncReporter</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>zipkin2.reporter.Sender</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>zipkin2.reporter.okhttp3.OkHttpSender</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>javax.servlet.Filter</span><span class=o>;</span>

<span class=cm>/**
</span><span class=cm> * 针对mvc controller 和 restTemplate 的 zipkin客户端配置
</span><span class=cm> */</span>
<span class=nd>@Configuration</span>
<span class=nd>@Import</span><span class=o>(</span><span class=n>SpanCustomizingAsyncHandlerInterceptor</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ZipkinClientConfiguration</span> <span class=kd>implements</span> <span class=n>WebMvcConfigurer</span> <span class=o>{</span>

    <span class=cm>/**
</span><span class=cm>     * 配置如何向 zipkin 发送 span
</span><span class=cm>     */</span>
    <span class=nd>@Bean</span>
    <span class=n>Sender</span> <span class=nf>sender</span><span class=o>()</span> <span class=o>{</span>
        <span class=c1>// 注意这里更换为自己安装的zipkin所在的主机IP
</span><span class=c1></span>        <span class=k>return</span> <span class=n>OkHttpSender</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s>&#34;http://10.150.27.36:9411/api/v2/spans&#34;</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=cm>/**
</span><span class=cm>     * 配置如何把 span 缓冲到给 zipkin 的消息
</span><span class=cm>     */</span>
    <span class=nd>@Bean</span>
    <span class=n>AsyncReporter</span><span class=o>&lt;</span><span class=n>Span</span><span class=o>&gt;</span> <span class=nf>spanReporter</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>AsyncReporter</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>sender</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=cm>/**
</span><span class=cm>     * 配置跟踪过程中的Trace信息
</span><span class=cm>     */</span>
    <span class=nd>@Bean</span>
    <span class=n>Tracing</span> <span class=nf>tracing</span><span class=o>(</span><span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${spring.application.name}&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>serviceName</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>Tracing</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
                <span class=o>.</span><span class=na>localServiceName</span><span class=o>(</span><span class=n>serviceName</span><span class=o>)</span>  <span class=c1>// 设置节点名称
</span><span class=c1></span>                <span class=o>.</span><span class=na>propagationFactory</span><span class=o>(</span><span class=n>ExtraFieldPropagation</span><span class=o>.</span><span class=na>newFactory</span><span class=o>(</span><span class=n>B3Propagation</span><span class=o>.</span><span class=na>FACTORY</span><span class=o>,</span> <span class=s>&#34;user-name&#34;</span><span class=o>))</span>
                <span class=o>.</span><span class=na>currentTraceContext</span><span class=o>(</span><span class=n>ThreadLocalCurrentTraceContext</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
                        <span class=o>.</span><span class=na>addScopeDecorator</span><span class=o>(</span><span class=n>MDCScopeDecorator</span><span class=o>.</span><span class=na>create</span><span class=o>())</span> <span class=c1>// puts trace IDs into logs
</span><span class=c1></span>                        <span class=o>.</span><span class=na>build</span><span class=o>()</span>
                <span class=o>)</span>
                <span class=o>.</span><span class=na>spanReporter</span><span class=o>(</span><span class=n>spanReporter</span><span class=o>()).</span><span class=na>build</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=cm>/** 注入可定制的Span */</span>
    <span class=nd>@Bean</span>
    <span class=n>SpanCustomizer</span> <span class=nf>spanCustomizer</span><span class=o>(</span><span class=n>Tracing</span> <span class=n>tracing</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>CurrentSpanCustomizer</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>tracing</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=cm>/** 决定如何命名和标记span。 默认情况下，它们的名称与http方法相同 */</span>
    <span class=nd>@Bean</span>
    <span class=n>HttpTracing</span> <span class=nf>httpTracing</span><span class=o>(</span><span class=n>Tracing</span> <span class=n>tracing</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>HttpTracing</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>tracing</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=cm>/** 导入过滤器，该过滤器中会为http请求创建span */</span>
    <span class=nd>@Bean</span>
    <span class=n>Filter</span> <span class=nf>tracingFilter</span><span class=o>(</span><span class=n>HttpTracing</span> <span class=n>httpTracing</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>TracingFilter</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>httpTracing</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=cm>/**
</span><span class=cm>     * 导入 zipkin 定制的 RestTemplateCustomizer
</span><span class=cm>     */</span>
    <span class=nd>@Bean</span>
    <span class=n>RestTemplateCustomizer</span> <span class=nf>useTracedHttpClient</span><span class=o>(</span><span class=n>HttpTracing</span> <span class=n>httpTracing</span><span class=o>)</span> <span class=o>{</span>
        <span class=kd>final</span> <span class=n>CloseableHttpClient</span> <span class=n>httpClient</span> <span class=o>=</span> <span class=n>TracingHttpClientBuilder</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>httpTracing</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>RestTemplateCustomizer</span><span class=o>()</span> <span class=o>{</span>
            <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>customize</span><span class=o>(</span><span class=n>RestTemplate</span> <span class=n>restTemplate</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>restTemplate</span><span class=o>.</span><span class=na>setRequestFactory</span><span class=o>(</span><span class=k>new</span> <span class=n>HttpComponentsClientHttpRequestFactory</span><span class=o>(</span><span class=n>httpClient</span><span class=o>));</span>
            <span class=o>}</span>
        <span class=o>};</span>
    <span class=o>}</span>

    <span class=nd>@Autowired</span>
    <span class=n>SpanCustomizingAsyncHandlerInterceptor</span> <span class=n>webMvcTracingCustomizer</span><span class=o>;</span>

    <span class=cm>/** 使用应用程序定义的Web标记装饰服务器span */</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addInterceptors</span><span class=o>(</span><span class=n>InterceptorRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>registry</span><span class=o>.</span><span class=na>addInterceptor</span><span class=o>(</span><span class=n>webMvcTracingCustomizer</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=n>复制代码</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=boot-服务模块>boot 服务模块</h3>
<ol>
<li><strong>maven依赖</strong>：boot+web起步依赖，另引入上面封装的zipkin_client模块依赖。</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>com.ycg<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>zipkin_client<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>1.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start=2>
<li><strong>启动类导入</strong> zipkin_client模块 的配置类 <strong>ZipkinClientConfiguration</strong>。</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@SpringBootApplication</span>
<span class=nd>@Import</span><span class=o>(</span><span class=n>ZipkinClientConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Service1Application</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>Service1Application</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=n>复制代码</span>
</code></pre></td></tr></table>
</div>
</div><ol start=3>
<li>编写Controller，service2和service3的代码类似。由于zipkin配置类那边向IOC容器注入zipkin定制的RestTemplateCustomizer,注意这里<strong>使用注入的RestTemplateBuilder创建restTemplate</strong>。</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@EnableAutoConfiguration</span>
<span class=nd>@RestController</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Service1Controller</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=n>RestTemplate</span> <span class=n>restTemplate</span><span class=o>;</span>

    <span class=nd>@Autowired</span> <span class=n>Service1Controller</span><span class=o>(</span><span class=n>RestTemplateBuilder</span> <span class=n>restTemplateBuilder</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>restTemplate</span> <span class=o>=</span> <span class=n>restTemplateBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=nd>@GetMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/service1&#34;</span><span class=o>)</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getService</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>100</span><span class=o>);</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=s>&#34;service1 sleep 100ms -&gt;&#34;</span> <span class=o>+</span> <span class=n>restTemplate</span><span class=o>.</span><span class=na>getForObject</span><span class=o>(</span><span class=s>&#34;http://localhost:8882/service2&#34;</span><span class=o>,</span><span class=n>String</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=n>复制代码</span>
</code></pre></td></tr></table>
</div>
</div><ol start=4>
<li>设置三个boot服务的内置tomcat端口号分别为8881、8882、8883。</li>
</ol>
<h3 id=启动验证>启动验证</h3>
<p>到这里，就完成了一个springboot整合zipkin简单的demo，分别启动三个boot应用后，在浏览器访问http://localhost:8881/service1，浏览器显示如下图：</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f96372968c46?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p>
<p>打开zipkin-webUI,点击查询，便可以查到刚才请求的追踪链路，如下图。</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f969b33c0154?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p>
<p>继续点击查到的链路信息，便可查看该条追踪链路的详细信息。这里采用缩进的形式展示了整条调用链路，并且再每个调用后表明了所花费时间。点击右上角json按钮，便能看到本次trace的json数据。</p>
<p><img src=https://user-gold-cdn.xitu.io/2019/1/15/1684f96e00c4e5c9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p>
<h2 id=span数据结构详解>span数据结构详解</h2>
<h3 id=json结构概览与各字段含义>json结构概览与各字段含义</h3>
<p>一次追踪链路会包含很多个span,因此一个trace便是一个数组，其标准的json结构如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>[
  {
    &#34;traceId&#34;: &#34;string&#34;,    // 追踪链路ID
    &#34;name&#34;: &#34;string&#34;,       // span名称，一般为方法名称
    &#34;parentId&#34;: &#34;string&#34;,   // 调用者ID
    &#34;id&#34;: &#34;string&#34;,         // spanID
    &#34;kind&#34;: &#34;CLIENT&#34;,       // 替代zipkin v1的注解中的四个核心状态，详细介绍见下文
    &#34;timestamp&#34;: 0,         // 时间戳，调用时间
    &#34;duration&#34;: 0,          // 持续时间-调用的服务所消耗的时间
    &#34;debug&#34;: true,          
    &#34;shared&#34;: true,
    &#34;localEndpoint&#34;: {      // 本地网络节点上下文
      &#34;serviceName&#34;: &#34;string&#34;,
      &#34;ipv4&#34;: &#34;string&#34;,
      &#34;ipv6&#34;: &#34;string&#34;,
      &#34;port&#34;: 0
    },
    &#34;remoteEndpoint&#34;: {    // 远端网络节点上下文
      &#34;serviceName&#34;: &#34;string&#34;,
      &#34;ipv4&#34;: &#34;string&#34;,
      &#34;ipv6&#34;: &#34;string&#34;,
      &#34;port&#34;: 0
    },
    &#34;annotations&#34;: [      // value通常是缩写代码，对应的时间戳表示代码标记事件的时间
      {
        &#34;timestamp&#34;: 0,
        &#34;value&#34;: &#34;string&#34;
      }
    ],
    &#34;tags&#34;: {        // span的上下文信息，比如：http.method、http.path
      &#34;additionalProp1&#34;: &#34;string&#34;,
      &#34;additionalProp2&#34;: &#34;string&#34;,
      &#34;additionalProp3&#34;: &#34;string&#34;
    }
  }
]
复制代码
</code></pre></td></tr></table>
</div>
</div><h3 id=聊聊-annotation-和-kind-的前世姻缘>聊聊 annotation 和 kind 的前世姻缘</h3>
<p><strong>zipkin V1 之 Annotation</strong> V1 时Annotation 用于记录一个事件，事件由value标识，事件发生时间则记录对应的时间戳。一些核心注解核心注解用于定义一个请求的开始和结束。主要是如下四种注解：</p>
<ul>
<li>cs - Client Send，表示客户端发起请求.</li>
<li>sr - Server Receive，表示服务端收到请求。使用sr的时间减去cs的时间便可得到网络传输的时间。</li>
<li>ss - Server Send，表示服务端完成处理，并将结果发送给客户端。使用ss的时间减去sr的时间便是服务端处理请求的时间。</li>
<li>cr - Client Received，表示客户端获取到服务端返回信息。使用cr的时间减去cs的时间便是整个请求所消耗的时间。</li>
</ul>
<p><strong>zipkin V2 之 Kind</strong> V2 使用Span.Kind替代了V1的几个表示请求开始与结束的核心注解。kind一共有四种状态，其为不同状态时，timestamp、duration、remoteEndpoint代表的意义均不相同。</p>
<ul>
<li>
<p>CLIENT：</p>
<blockquote>
<p>timestamp是请求被发送的时刻，相当于v1中注解 cs。<br>
duration代表发送请求后，接收到服务端响应前的持续时间，也就是整个请求所消耗的时间。<br>
remoteEndpoint表示被调用方的网络节点信息。</p>
</blockquote>
</li>
<li>
<p>SERVER：</p>
<blockquote>
<p>timestamp是服务端接到请求并准备开始处理它的时间，相当于v1中的sr。<br>
duration代表服务端接到请求后、发送响应前的持续时间，也就是服务端的净处理时间。<br>
remoteEndpoint表示调用方的网络节点信息。</p>
</blockquote>
</li>
<li>
<p>PRODUCER：</p>
<blockquote>
<p>timestamp是消息被发送的时刻。<br>
duration代表发送方发送后，消息队列结束到消息前的延迟时间，比如批处理的场景。<br>
remoteEndpoint表示消息队列的网络节点信息。</p>
</blockquote>
</li>
<li>
<p>CONSUMER：</p>
<blockquote>
<p>timestamp是消息被消息队列接收到的时刻。<br>
duration代表消息被消息队列接收到，被消费者消费前的持续时间，比如消息积压的场景。<br>
remoteEndpoint表示消费者节点信息，未知则表示service name。</p>
</blockquote>
</li>
</ul>
<p>V1 针对消息队列也有ms、mr等注解，这里就不再详细介绍了。小白觉得kind这种替换后，整个追踪链路更为清晰直观，或许这也是zipkin的考虑之一吧。</p>
<h3 id=再看demo中追踪链路的json数据>再看Demo中追踪链路的JSON数据</h3>
<p>相信看到这里的小伙伴回头再看demo中链路的json数据，应该可以明白具体的意思了。小白这里再梳理一下。追踪链路的JSON数据如下（建议直接跳过数据看下面分析）：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json>  <span class=p>{</span>
    <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;parentId&#34;</span><span class=p>:</span> <span class=s2>&#34;7dd11a047eb02622&#34;</span><span class=p>,</span>
    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;e5427222edb62a7c&#34;</span><span class=p>,</span>
    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;SERVER&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get /service3&#34;</span><span class=p>,</span>
    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1547458424863333</span><span class=p>,</span>
    <span class=nt>&#34;duration&#34;</span><span class=p>:</span> <span class=mi>409599</span><span class=p>,</span>
    <span class=nt>&#34;localEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;serviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;server3&#34;</span><span class=p>,</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;172.30.22.138&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;remoteEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>52845</span>
    <span class=p>},</span>
    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;http.method&#34;</span><span class=p>:</span> <span class=s2>&#34;GET&#34;</span><span class=p>,</span>
      <span class=nt>&#34;http.path&#34;</span><span class=p>:</span> <span class=s2>&#34;/service3&#34;</span><span class=p>,</span>
      <span class=nt>&#34;mvc.controller.class&#34;</span><span class=p>:</span> <span class=s2>&#34;Service3Controller&#34;</span><span class=p>,</span>
      <span class=nt>&#34;mvc.controller.method&#34;</span><span class=p>:</span> <span class=s2>&#34;getService&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;shared&#34;</span><span class=p>:</span> <span class=kc>true</span>
  <span class=p>}</span><span class=err>,</span>
  <span class=p>{</span>
    <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;parentId&#34;</span><span class=p>:</span> <span class=s2>&#34;7dd11a047eb02622&#34;</span><span class=p>,</span>
    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;e5427222edb62a7c&#34;</span><span class=p>,</span>
    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;CLIENT&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span>
    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1547458424756985</span><span class=p>,</span>
    <span class=nt>&#34;duration&#34;</span><span class=p>:</span> <span class=mi>520649</span><span class=p>,</span>
    <span class=nt>&#34;localEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;serviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;server2&#34;</span><span class=p>,</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;172.30.22.138&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;http.method&#34;</span><span class=p>:</span> <span class=s2>&#34;GET&#34;</span><span class=p>,</span>
      <span class=nt>&#34;http.path&#34;</span><span class=p>:</span> <span class=s2>&#34;/service3&#34;</span>
    <span class=p>}</span>
  <span class=p>}</span><span class=err>,</span>
  <span class=p>{</span>
    <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;parentId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;7dd11a047eb02622&#34;</span><span class=p>,</span>
    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;SERVER&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get /service2&#34;</span><span class=p>,</span>
    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1547458424446556</span><span class=p>,</span>
    <span class=nt>&#34;duration&#34;</span><span class=p>:</span> <span class=mi>880044</span><span class=p>,</span>
    <span class=nt>&#34;localEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;serviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;server2&#34;</span><span class=p>,</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;172.30.22.138&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;remoteEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>52844</span>
    <span class=p>},</span>
    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;http.method&#34;</span><span class=p>:</span> <span class=s2>&#34;GET&#34;</span><span class=p>,</span>
      <span class=nt>&#34;http.path&#34;</span><span class=p>:</span> <span class=s2>&#34;/service2&#34;</span><span class=p>,</span>
      <span class=nt>&#34;mvc.controller.class&#34;</span><span class=p>:</span> <span class=s2>&#34;Service2Controller&#34;</span><span class=p>,</span>
      <span class=nt>&#34;mvc.controller.method&#34;</span><span class=p>:</span> <span class=s2>&#34;getService&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;shared&#34;</span><span class=p>:</span> <span class=kc>true</span>
  <span class=p>}</span><span class=err>,</span>
  <span class=p>{</span>
    <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;parentId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;7dd11a047eb02622&#34;</span><span class=p>,</span>
    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;CLIENT&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span>
    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1547458424271786</span><span class=p>,</span>
    <span class=nt>&#34;duration&#34;</span><span class=p>:</span> <span class=mi>1066836</span><span class=p>,</span>
    <span class=nt>&#34;localEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;serviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;server1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;172.30.22.138&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;http.method&#34;</span><span class=p>:</span> <span class=s2>&#34;GET&#34;</span><span class=p>,</span>
      <span class=nt>&#34;http.path&#34;</span><span class=p>:</span> <span class=s2>&#34;/service2&#34;</span>
    <span class=p>}</span>
  <span class=p>}</span><span class=err>,</span>
  <span class=p>{</span>
    <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;3857b4a56c99e9f8&#34;</span><span class=p>,</span>
    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;SERVER&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get /service1&#34;</span><span class=p>,</span>
    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1547458424017344</span><span class=p>,</span>
    <span class=nt>&#34;duration&#34;</span><span class=p>:</span> <span class=mi>1358590</span><span class=p>,</span>
    <span class=nt>&#34;localEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;serviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;server1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;ipv4&#34;</span><span class=p>:</span> <span class=s2>&#34;172.30.22.138&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;remoteEndpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;ipv6&#34;</span><span class=p>:</span> <span class=s2>&#34;::1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>52841</span>
    <span class=p>},</span>
    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;http.method&#34;</span><span class=p>:</span> <span class=s2>&#34;GET&#34;</span><span class=p>,</span>
      <span class=nt>&#34;http.path&#34;</span><span class=p>:</span> <span class=s2>&#34;/service1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;mvc.controller.class&#34;</span><span class=p>:</span> <span class=s2>&#34;Service1Controller&#34;</span><span class=p>,</span>
      <span class=nt>&#34;mvc.controller.method&#34;</span><span class=p>:</span> <span class=s2>&#34;getService&#34;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=err>]</span>
</code></pre></td></tr></table>
</div>
</div><p>我们从下往上看，这才是请求最开始的地方。首先看最下面的span（3857b4a56c99e9f8）。请求（<a href=http://localhost:8881/>http://localhost:8881</a>）是由浏览器发出,那么当请求到达服务1时，作为服务端便会生成kind为SERVER的span，其中duration便是本次请求到后端后的净处理时间，localEndpoint是server1的节点信息，remoteEndpoint的调用方也就是浏览器的节点信息。</p>
<p>接着服务1需要调用服务2的服务，这时服务1是作为客户端发出请求的。因此会记录出从下往上第二个span(7dd11a047eb02622),一个客户端span,也就是kind=CLIENT。localEndpoint还是自己，同时tag里添加了发出的请求信息，duration表示发出/service2的请求后，到接收到server2的响应所消耗的时间。再往上span(7dd11a047eb02622)，就是server2接收到server1的请求后记录的SERVER span。剩下的同理，小白就不多说了。</p>
<h2 id=结束语>结束语</h2>
<p>到这里小白就介绍完了基于zipkin实现分布式追踪系统的基本原理与实现，当然这只是一个入门，追踪信息是全量收集还是采样收集，设置什么样的采样频率，异步发送span使用http还是kafka，这些问题都是需要在生产环境中根据实际场景综合考量的。就本文而言，小白觉得只要你仔细阅读了，认真思考了，一定还是收获不少的，当然有深入研究的小伙伴除外。后续小白会深入Brave的源码了解具体的追踪实现，如有错误，也请多多拍砖多多交流。另，画图、码字、梳理知识不易，<strong>如要转载，请注明出处</strong>。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2021-10-10
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/monitor/>monitor</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/30.architech/graphdb/tinkerpop/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">TinkerPop</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/graphdb/%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%BC%E8%BF%B0/>
<span class="next-text nav-default">图数据库综述</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/L2Dwidget.min.js></script>
<script src=/js/l2d.js></script>
</body>
</html>