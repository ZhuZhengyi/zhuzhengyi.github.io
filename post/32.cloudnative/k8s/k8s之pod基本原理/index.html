<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>k8s之Pod基本原理 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="k8s之Pod基本原理 简介 Pod、Service、Volume 和 Namespace 是 Kubernetes 集群中四大基本对象， 它们能够表示系统中部署的应用、工作负载、网络和磁盘">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/32.cloudnative/k8s/k8s%E4%B9%8Bpod%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="k8s之Pod基本原理">
<meta property="og:description" content="k8s之Pod基本原理 简介 Pod、Service、Volume 和 Namespace 是 Kubernetes 集群中四大基本对象， 它们能够表示系统中部署的应用、工作负载、网络和磁盘">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/32.cloudnative/k8s/k8s%E4%B9%8Bpod%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-04-30T00:25:08+08:00">
<meta property="article:modified_time" content="2022-04-30T00:25:08+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="k8s之Pod基本原理">
<meta itemprop=description content="k8s之Pod基本原理 简介 Pod、Service、Volume 和 Namespace 是 Kubernetes 集群中四大基本对象， 它们能够表示系统中部署的应用、工作负载、网络和磁盘"><meta itemprop=datePublished content="2022-04-30T00:25:08+08:00">
<meta itemprop=dateModified content="2022-04-30T00:25:08+08:00">
<meta itemprop=wordCount content="3903">
<meta itemprop=keywords content="cloudnative,k8s,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="k8s之Pod基本原理">
<meta name=twitter:description content="k8s之Pod基本原理 简介 Pod、Service、Volume 和 Namespace 是 Kubernetes 集群中四大基本对象， 它们能够表示系统中部署的应用、工作负载、网络和磁盘"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>k8s之Pod基本原理</h1>
<div class=post-meta>
<time datetime=2022-04-30 class=post-time>
2022-04-30 00:25:08
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/cloudnative/> cloudnative </a>
<a href=https://justice.bj.cn/categories/k8s/> k8s </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#概述>概述</a>
<ul>
<li><a href=#容器>容器</a></li>
<li><a href=#卷>卷</a></li>
<li><a href=#网络>网络</a></li>
<li><a href=#小结>小结</a></li>
</ul>
</li>
<li><a href=#生命周期>生命周期</a>
<ul>
<li><a href=#创建>创建</a></li>
<li><a href=#健康检查>健康检查</a></li>
<li><a href=#删除>删除</a></li>
</ul>
</li>
<li><a href=#总结>总结</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=k8s之pod基本原理>k8s之Pod基本原理</h1>
<h2 id=简介>简介</h2>
<p>Pod、Service、Volume 和 Namespace 是 Kubernetes 集群中四大基本对象，</p>
<p>它们能够表示系统中部署的应用、工作负载、网络和磁盘资源，共同定义了集群的状态。</p>
<p>Kubernetes 中很多其他的资源其实只对这些基本的对象进行了组合。</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-basic-objects.png alt=kubernetes-basic-objects></p>
<p>Pod 是 Kubernetes 集群中能够被创建和管理的最小部署单元。</p>
<h2 id=概述>概述</h2>
<p>作为 Kubernetes 集群中的基本单元，Pod 就是最小并且最简单的 Kubernetes 对象，</p>
<p>这个简单的对象其实就能够独立启动一个后端进程并在集群的内部为调用方提供服务。</p>
<p>在上一篇文章  <a href=https://draveness.me/kubernetes-object-intro>从 Kubernetes 中的对象谈起</a>  中，我们曾经介绍过简单的 Kubernetes Pod 是如何使用 YAML 进行描述的：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>sleep</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;3600&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>这个 YAML 文件描述了一个 Pod 启动时运行的容器和命令以及它的重启策略，</p>
<p>在当前 Pod 出现错误或者执行结束后是否应该被 Kubernetes 的控制器拉起来，</p>
<p>除了这些比较显眼的配置之外，元数据  <code>metadata</code>  的配置也非常重要，<code>name</code>  是当前对象在 Kubernetes 集群中的唯一标识符，</p>
<p>而标签  <code>labels</code>  可以帮助我们快速选择对象。</p>
<p>在同一个 Pod 中，有几个概念特别值得关注，</p>
<p>首先就是容器，在 Pod 中其实可以同时运行一个或者多个容器，这些容器能够共享网络、存储以及 CPU、内存等资源。</p>
<p>在这一小节中我们将关注 Pod 中的容器、卷和网络三大概念。</p>
<h3 id=容器>容器</h3>
<p>每一个 Kubernetes 的 Pod 其实都具有两种不同的容器，两种不同容器的职责其实十分清晰，</p>
<p>一种是  <code>InitContainer</code>，这种容器会在 Pod 启动时运行，主要用于初始化一些配置，</p>
<p>另一种是 Pod 在 Running 状态时内部存活的  <code>Container</code>，它们的主要作用是对外提供服务或者作为工作节点处理异步任务等等。</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-pod-init-and-regular-containers.png alt=kubernetes-pod-init-and-regular-containers></p>
<p>通过对不同容器类型的命名我们也可以看出，</p>
<p><code>InitContainer</code>  会比  <code>Container</code>  优先启动，在  <code>kubeGenericRuntimeManager.SyncPod</code>  方法中会先后启动两种容器。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=nf>SyncPod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>_</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodStatus</span><span class=p>,</span> <span class=nx>podStatus</span> <span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>PodStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Secret</span><span class=p>,</span> <span class=nx>backOff</span> <span class=o>*</span><span class=nx>flowcontrol</span><span class=p>.</span><span class=nx>Backoff</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>PodSyncResult</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Step 1: Compute sandbox and container changes.
</span><span class=c1></span>    <span class=c1>// Step 2: Kill the pod if the sandbox has changed.
</span><span class=c1></span>    <span class=c1>// Step 3: kill any running containers in this pod which are not to keep.
</span><span class=c1></span>    <span class=c1>// Step 4: Create a sandbox for the pod if necessary.
</span><span class=c1></span>    <span class=c1>// ...
</span><span class=c1></span>
    <span class=c1>// Step 5: start the init container.
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>container</span> <span class=o>:=</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>NextInitContainerToStart</span><span class=p>;</span> <span class=nx>container</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>msg</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>startContainer</span><span class=p>(</span><span class=nx>podSandboxID</span><span class=p>,</span> <span class=nx>podSandboxConfig</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>,</span> <span class=nx>podIP</span><span class=p>,</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerTypeInit</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// Step 6: start containers in podContainerChanges.ContainersToStart.
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>idx</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>ContainersToStart</span> <span class=p>{</span>
        <span class=nx>container</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>[</span><span class=nx>idx</span><span class=p>]</span>

        <span class=nx>msg</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>startContainer</span><span class=p>(</span><span class=nx>podSandboxID</span><span class=p>,</span> <span class=nx>podSandboxConfig</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>,</span> <span class=nx>podIP</span><span class=p>,</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerTypeRegular</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过分析私有方法  <code>startContainer</code>  的实现我们得出：容器的类型最终只会影响在 Debug 时创建的标签，所以对于 Kubernetes 来说两种容器的启动和执行也就只有顺序先后的不同。</p>
<h3 id=卷>卷</h3>
<p>每一个 Pod 中的容器是可以通过  <a href=https://draveness.me/kubernetes-volume>卷（Volume）</a>  的方式共享文件目录的，这些 Volume 能够存储持久化的数据；在当前 Pod 出现故障或者滚动更新时，对应 Volume 中的数据并不会被清除，而是会在 Pod 重启后重新挂载到期望的文件目录中：</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-containers-share-volumes.png alt=kubernetes-containers-share-volumes></p>
<p>kubelet.go 文件中的私有方法  <code>syncPod</code>  会调用  <code>WaitForAttachAndMount</code>  方法为等待当前 Pod 启动需要的挂载文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>vm</span> <span class=o>*</span><span class=nx>volumeManager</span><span class=p>)</span> <span class=nf>WaitForAttachAndMount</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>expectedVolumes</span> <span class=o>:=</span> <span class=nf>getExpectedVolumes</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=nx>uniquePodName</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>GetUniquePodName</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>

    <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>.</span><span class=nf>ReprocessPod</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>)</span>

    <span class=nx>wait</span><span class=p>.</span><span class=nf>PollImmediate</span><span class=p>(</span>
        <span class=nx>podAttachAndMountRetryInterval</span><span class=p>,</span>
        <span class=nx>podAttachAndMountTimeout</span><span class=p>,</span>
        <span class=nx>vm</span><span class=p>.</span><span class=nf>verifyVolumesMountedFunc</span><span class=p>(</span><span class=nx>uniquePodName</span><span class=p>,</span> <span class=nx>expectedVolumes</span><span class=p>))</span>

    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们会在  <a href=https://draveness.me/kubernetes-volume>后面的章节</a>  详细地介绍 Kubernetes 中卷的创建、挂载是如何进行的，在这里我们需要知道的是卷的挂载是 Pod 启动之前必须要完成的工作：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>syncPod</span><span class=p>(</span><span class=nx>o</span> <span class=nx>syncPodOptions</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// ...
</span><span class=c1></span>
    <span class=k>if</span> <span class=p>!</span><span class=nx>kl</span><span class=p>.</span><span class=nf>podIsTerminated</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nx>volumeManager</span><span class=p>.</span><span class=nf>WaitForAttachAndMount</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>pullSecrets</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nf>getPullSecretsForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>

    <span class=nx>result</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>containerRuntime</span><span class=p>.</span><span class=nf>SyncPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>apiPodStatus</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>,</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>backOff</span><span class=p>)</span>
    <span class=nx>kl</span><span class=p>.</span><span class=nx>reasonCache</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span>

    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在当前 Pod 的卷创建完成之后，就会调用上一节中提到的  <code>SyncPod</code>  公有方法继续进行同步 Pod 信息和创建、启动容器的工作。</p>
<h3 id=网络>网络</h3>
<p>同一个 Pod 中的多个容器会被共同分配到同一个 Host 上并且共享网络栈，</p>
<p>这些 Pod 能够通过 localhost 互相访问到彼此的端口和服务，如果使用了相同的端口也会发生冲突，</p>
<p>同一个 Pod 上的所有容器会连接到同一个网络设备上，这个网络设备就是由 Pod Sandbox 中的沙箱容器在  <code>RunPodSandbox</code>  方法中启动时创建的：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>ds</span> <span class=o>*</span><span class=nx>dockerService</span><span class=p>)</span> <span class=nf>RunPodSandbox</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>runtimeapi</span><span class=p>.</span><span class=nx>RunPodSandboxRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>runtimeapi</span><span class=p>.</span><span class=nx>RunPodSandboxResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>config</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetConfig</span><span class=p>()</span>

    <span class=c1>// Step 1: Pull the image for the sandbox.
</span><span class=c1></span>    <span class=nx>image</span> <span class=o>:=</span> <span class=nx>defaultSandboxImage</span>

    <span class=c1>// Step 2: Create the sandbox container.
</span><span class=c1></span>    <span class=nx>createConfig</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ds</span><span class=p>.</span><span class=nf>makeSandboxDockerConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>,</span> <span class=nx>image</span><span class=p>)</span>
    <span class=nx>createResp</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ds</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>CreateContainer</span><span class=p>(</span><span class=o>*</span><span class=nx>createConfig</span><span class=p>)</span>

    <span class=nx>resp</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>runtimeapi</span><span class=p>.</span><span class=nx>RunPodSandboxResponse</span><span class=p>{</span><span class=nx>PodSandboxId</span><span class=p>:</span> <span class=nx>createResp</span><span class=p>.</span><span class=nx>ID</span><span class=p>}</span>

    <span class=nx>ds</span><span class=p>.</span><span class=nf>setNetworkReady</span><span class=p>(</span><span class=nx>createResp</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>

    <span class=c1>// Step 3: Create Sandbox Checkpoint.
</span><span class=c1></span>    <span class=nx>ds</span><span class=p>.</span><span class=nx>checkpointManager</span><span class=p>.</span><span class=nf>CreateCheckpoint</span><span class=p>(</span><span class=nx>createResp</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nf>constructPodSandboxCheckpoint</span><span class=p>(</span><span class=nx>config</span><span class=p>))</span>

    <span class=c1>// Step 4: Start the sandbox container.
</span><span class=c1></span>    <span class=nx>ds</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>StartContainer</span><span class=p>(</span><span class=nx>createResp</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span>

    <span class=c1>// Step 5: Setup networking for the sandbox.
</span><span class=c1></span>    <span class=nx>cID</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nf>BuildContainerID</span><span class=p>(</span><span class=nx>runtimeName</span><span class=p>,</span> <span class=nx>createResp</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span>
    <span class=nx>networkOptions</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span>
    <span class=nx>ds</span><span class=p>.</span><span class=nx>network</span><span class=p>.</span><span class=nf>SetUpPod</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nf>GetMetadata</span><span class=p>().</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nf>GetMetadata</span><span class=p>().</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>cID</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>,</span> <span class=nx>networkOptions</span><span class=p>)</span>

    <span class=k>return</span> <span class=nx>resp</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>沙箱容器其实就是  <code>pause</code>  容器，</p>
<p>上述方法引用的  <code>defaultSandboxImage</code>  其实就是官方提供的  <code>k8s.gcr.io/pause:3.1</code>  镜像，</p>
<p>这里会创建沙箱镜像和检查点并启动容器。</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-pod-network.png alt=kubernetes-pod-network></p>
<p>每一个节点上都会由 Kubernetes 的网络插件 Kubenet 创建一个基本的  <code>cbr0</code>  网桥并为每一个 Pod 创建  <code>veth</code>  虚拟网络设备，同一个 Pod 中的所有容器就会通过这个网络设备共享网络，也就是能够通过 localhost 互相访问彼此暴露的端口和服务。</p>
<h3 id=小结>小结</h3>
<p>Kubernetes 中的每一个 Pod 都包含多个容器，这些容器在通过 Kubernetes 创建之后就能共享网络和存储，这其实是 Pod 非常重要的特性，我们能通过这个特性构建比较复杂的服务拓扑和依赖关系。</p>
<h2 id=生命周期>生命周期</h2>
<p>想要深入理解 Pod 的实现原理，最好最快的办法就是从 Pod 的生命周期入手，通过理解 Pod 创建、重启和删除的原理我们最终就能够系统地掌握 Pod 的生命周期与核心原理。</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-pod-lifecycle.png alt=kubernetes-pod-lifecycle></p>
<p>当 Pod 被创建之后，就会进入健康检查状态，</p>
<p>当 Kubernetes 确定当前 Pod 已经能够接受外部的请求时，才会将流量打到新的 Pod 上并继续对外提供服务，</p>
<p>在这期间如果发生了错误就可能会触发重启机制，在 Pod 被删除之前都会触发一个  <code>PreStop</code>  的钩子，</p>
<p>其中的方法完成之后 Pod 才会被删除，接下来我们就会按照这里的顺序依次介绍 Pod 『从生到死』的过程。</p>
<h3 id=创建>创建</h3>
<p>Pod 的创建都是通过  <code>SyncPod</code>  来实现的，创建的过程大体上可以分为六个步骤：</p>
<ol>
<li>计算 Pod 中沙盒和容器的变更；</li>
<li>强制停止 Pod 对应的沙盒；</li>
<li>强制停止所有不应该运行的容器；</li>
<li>为 Pod 创建新的沙盒；</li>
<li>创建 Pod 规格中指定的初始化容器；</li>
<li>依次创建 Pod 规格中指定的常规容器；</li>
</ol>
<p>我们可以看到 Pod 的创建过程其实是比较简单的，首先计算 Pod 规格和沙箱的变更，然后停止可能影响这一次创建或者更新的容器，最后依次创建沙盒、初始化容器和常规容器。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=nf>SyncPod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>_</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodStatus</span><span class=p>,</span> <span class=nx>podStatus</span> <span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>PodStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Secret</span><span class=p>,</span> <span class=nx>backOff</span> <span class=o>*</span><span class=nx>flowcontrol</span><span class=p>.</span><span class=nx>Backoff</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>PodSyncResult</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>podContainerChanges</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>computePodActions</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>CreateSandbox</span> <span class=p>{</span>
        <span class=nx>ref</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ref</span><span class=p>.</span><span class=nf>GetReference</span><span class=p>(</span><span class=nx>legacyscheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>KillPod</span> <span class=p>{</span>
        <span class=k>if</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>CreateSandbox</span> <span class=p>{</span>
            <span class=nx>m</span><span class=p>.</span><span class=nf>purgeInitContainers</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>for</span> <span class=nx>containerID</span><span class=p>,</span> <span class=nx>containerInfo</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>ContainersToKill</span> <span class=p>{</span>
            <span class=nx>m</span><span class=p>.</span><span class=nf>killContainer</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>containerID</span><span class=p>,</span> <span class=nx>containerInfo</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>containerInfo</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=nx>podSandboxID</span> <span class=o>:=</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>SandboxID</span>
    <span class=k>if</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>CreateSandbox</span> <span class=p>{</span>
        <span class=nx>podSandboxID</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>createPodSandbox</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>Attempt</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>podSandboxConfig</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>generatePodSandboxConfig</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>Attempt</span><span class=p>)</span>

    <span class=k>if</span> <span class=nx>container</span> <span class=o>:=</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>NextInitContainerToStart</span><span class=p>;</span> <span class=nx>container</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>msg</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>startContainer</span><span class=p>(</span><span class=nx>podSandboxID</span><span class=p>,</span> <span class=nx>podSandboxConfig</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>,</span> <span class=nx>podIP</span><span class=p>,</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerTypeInit</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>idx</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podContainerChanges</span><span class=p>.</span><span class=nx>ContainersToStart</span> <span class=p>{</span>
        <span class=nx>container</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>[</span><span class=nx>idx</span><span class=p>]</span>
        <span class=nx>msg</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>startContainer</span><span class=p>(</span><span class=nx>podSandboxID</span><span class=p>,</span> <span class=nx>podSandboxConfig</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>podStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>,</span> <span class=nx>podIP</span><span class=p>,</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerTypeRegular</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>简化后的  <code>SyncPod</code>  方法的脉络非常清晰，可以很好地理解整个创建 Pod 的工作流程；而初始化容器和常规容器被调用  <code>startContainer</code>  来启动：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=nf>startContainer</span><span class=p>(</span><span class=nx>podSandboxID</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>podSandboxConfig</span> <span class=o>*</span><span class=nx>runtimeapi</span><span class=p>.</span><span class=nx>PodSandboxConfig</span><span class=p>,</span> <span class=nx>container</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Container</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>podStatus</span> <span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>PodStatus</span><span class=p>,</span> <span class=nx>pullSecrets</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Secret</span><span class=p>,</span> <span class=nx>podIP</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>containerType</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerType</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>imageRef</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>imagePuller</span><span class=p>.</span><span class=nf>EnsureImageExists</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>pullSecrets</span><span class=p>)</span>

    <span class=c1>// ...
</span><span class=c1></span>    <span class=nx>containerID</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>runtimeService</span><span class=p>.</span><span class=nf>CreateContainer</span><span class=p>(</span><span class=nx>podSandboxID</span><span class=p>,</span> <span class=nx>containerConfig</span><span class=p>,</span> <span class=nx>podSandboxConfig</span><span class=p>)</span>

    <span class=nx>m</span><span class=p>.</span><span class=nx>internalLifecycle</span><span class=p>.</span><span class=nf>PreStartContainer</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>containerID</span><span class=p>)</span>

    <span class=nx>m</span><span class=p>.</span><span class=nx>runtimeService</span><span class=p>.</span><span class=nf>StartContainer</span><span class=p>(</span><span class=nx>containerID</span><span class=p>)</span>

    <span class=k>if</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Lifecycle</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Lifecycle</span><span class=p>.</span><span class=nx>PostStart</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>kubeContainerID</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerID</span><span class=p>{</span>
            <span class=nx>Type</span><span class=p>:</span> <span class=nx>m</span><span class=p>.</span><span class=nx>runtimeName</span><span class=p>,</span>
            <span class=nx>ID</span><span class=p>:</span>   <span class=nx>containerID</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=nx>msg</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>runner</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>kubeContainerID</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Lifecycle</span><span class=p>.</span><span class=nx>PostStart</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在启动每一个容器的过程中也都按照相同的步骤进行操作：</p>
<ol>
<li>通过镜像拉取器获得当前容器中使用镜像的引用；</li>
<li>调用远程的  <code>runtimeService</code>  创建容器；</li>
<li>调用内部的生命周期方法  <code>PreStartContainer</code>  为当前的容器设置分配的 CPU 等资源；</li>
<li>调用远程的  <code>runtimeService</code>  开始运行镜像；</li>
<li>如果当前的容器包含  <code>PostStart</code>  钩子就会执行该回调；</li>
</ol>
<p>每次  <code>SyncPod</code>  被调用时不一定是创建新的 Pod 对象，它还会承担更新、删除和同步 Pod 规格的职能，根据输入的新规格执行相应的操作。</p>
<h3 id=健康检查>健康检查</h3>
<p>如果我们遵循 Pod 的最佳实践，其实应该尽可能地为每一个 Pod 添加  <code>livenessProbe</code>  和  <code>readinessProbe</code>  的健康检查，这两者能够为 Kubernetes 提供额外的存活信息，如果我们配置了合适的健康检查方法和规则，那么就不会出现服务未启动就被打入流量或者长时间未响应依然没有重启等问题。</p>
<p>在 Pod 被创建或者被移除时，会被加入到当前节点上的  <code>ProbeManager</code>  中，<code>ProbeManager</code>  会负责这些 Pod 的健康检查：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>HandlePodAdditions</span><span class=p>(</span><span class=nx>pods</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>start</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pods</span> <span class=p>{</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nx>podManager</span><span class=p>.</span><span class=nf>AddPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nf>dispatchWork</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>kubetypes</span><span class=p>.</span><span class=nx>SyncPodCreate</span><span class=p>,</span> <span class=nx>mirrorPod</span><span class=p>,</span> <span class=nx>start</span><span class=p>)</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nx>probeManager</span><span class=p>.</span><span class=nf>AddPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>HandlePodRemoves</span><span class=p>(</span><span class=nx>pods</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>start</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pods</span> <span class=p>{</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nx>podManager</span><span class=p>.</span><span class=nf>DeletePod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nf>deletePod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
        <span class=nx>kl</span><span class=p>.</span><span class=nx>probeManager</span><span class=p>.</span><span class=nf>RemovePod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>简化后的  <code>HandlePodAdditions</code>  和  <code>HandlePodRemoves</code>  方法非常直白，我们可以直接来看  <code>ProbeManager</code>  如何处理不同节点的健康检查。</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-probe-manager.png alt=kubernetes-probe-manager></p>
<p>每一个新的 Pod 都会被调用  <code>ProbeManager</code>  的<code>AddPod</code>  函数，这个方法会初始化一个新的 Goroutine 并在其中运行对当前 Pod 进行健康检查：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>manager</span><span class=p>)</span> <span class=nf>AddPod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>key</span> <span class=o>:=</span> <span class=nx>probeKey</span><span class=p>{</span><span class=nx>podUID</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>}</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span> <span class=p>{</span>
        <span class=nx>key</span><span class=p>.</span><span class=nx>containerName</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Name</span>

        <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ReadinessProbe</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>key</span><span class=p>.</span><span class=nx>probeType</span> <span class=p>=</span> <span class=nx>readiness</span>
            <span class=nx>w</span> <span class=o>:=</span> <span class=nf>newWorker</span><span class=p>(</span><span class=nx>m</span><span class=p>,</span> <span class=nx>readiness</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>c</span><span class=p>)</span>
            <span class=nx>m</span><span class=p>.</span><span class=nx>workers</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>w</span>
            <span class=k>go</span> <span class=nx>w</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>LivenessProbe</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>key</span><span class=p>.</span><span class=nx>probeType</span> <span class=p>=</span> <span class=nx>liveness</span>
            <span class=nx>w</span> <span class=o>:=</span> <span class=nf>newWorker</span><span class=p>(</span><span class=nx>m</span><span class=p>,</span> <span class=nx>liveness</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>c</span><span class=p>)</span>
            <span class=nx>m</span><span class=p>.</span><span class=nx>workers</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>w</span>
            <span class=k>go</span> <span class=nx>w</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在执行健康检查的过程中，Worker 只是负责根据当前 Pod 的状态定期触发一次  <code>Probe</code>，它会根据 Pod 的配置分别选择调用  <code>Exec</code>、<code>HTTPGet</code>  或  <code>TCPSocket</code>  三种不同的  <code>Probe</code>  方式：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>pb</span> <span class=o>*</span><span class=nx>prober</span><span class=p>)</span> <span class=nf>runProbe</span><span class=p>(</span><span class=nx>probeType</span> <span class=nx>probeType</span><span class=p>,</span> <span class=nx>p</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Probe</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>status</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodStatus</span><span class=p>,</span> <span class=nx>container</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>Container</span><span class=p>,</span> <span class=nx>containerID</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerID</span><span class=p>)</span> <span class=p>(</span><span class=nx>probe</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>timeout</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>TimeoutSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>
    <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Exec</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>command</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nf>ExpandContainerCommandOnlyStatic</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Exec</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Env</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>exec</span><span class=p>.</span><span class=nf>Probe</span><span class=p>(</span><span class=nx>pb</span><span class=p>.</span><span class=nf>newExecInContainer</span><span class=p>(</span><span class=nx>container</span><span class=p>,</span> <span class=nx>containerID</span><span class=p>,</span> <span class=nx>command</span><span class=p>,</span> <span class=nx>timeout</span><span class=p>))</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>HTTPGet</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>scheme</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>HTTPGet</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>))</span>
        <span class=nx>host</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>HTTPGet</span><span class=p>.</span><span class=nx>Host</span>
        <span class=nx>port</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nf>extractPort</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>HTTPGet</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span> <span class=nx>container</span><span class=p>)</span>
        <span class=nx>path</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>HTTPGet</span><span class=p>.</span><span class=nx>Path</span>
        <span class=nx>url</span> <span class=o>:=</span> <span class=nf>formatURL</span><span class=p>(</span><span class=nx>scheme</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>path</span><span class=p>)</span>
        <span class=nx>headers</span> <span class=o>:=</span> <span class=nf>buildHeader</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>HTTPGet</span><span class=p>.</span><span class=nx>HTTPHeaders</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>probeType</span> <span class=o>==</span> <span class=nx>liveness</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>livenessHttp</span><span class=p>.</span><span class=nf>Probe</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>headers</span><span class=p>,</span> <span class=nx>timeout</span><span class=p>)</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// readiness
</span><span class=c1></span>            <span class=k>return</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>readinessHttp</span><span class=p>.</span><span class=nf>Probe</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>headers</span><span class=p>,</span> <span class=nx>timeout</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>TCPSocket</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>port</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nf>extractPort</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>TCPSocket</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span> <span class=nx>container</span><span class=p>)</span>
        <span class=nx>host</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>TCPSocket</span><span class=p>.</span><span class=nx>Host</span>
        <span class=k>return</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>tcp</span><span class=p>.</span><span class=nf>Probe</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>timeout</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>probe</span><span class=p>.</span><span class=nx>Unknown</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Missing probe handler for %s:%s&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=p>.</span><span class=nf>Pod</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Kubernetes 在 Pod 启动后的  <code>InitialDelaySeconds</code>  时间内会等待 Pod 的启动和初始化，在这之后会开始健康检查，默认的健康检查重试次数是三次，如果健康检查正常运行返回了一个确定的结果，那么 Worker 就是记录这次的结果，在连续失败  <code>FailureThreshold</code>  次或者成功  <code>SuccessThreshold</code>  次，那么就会改变当前 Pod 的状态，这也是为了避免由于服务不稳定带来的抖动。</p>
<h3 id=删除>删除</h3>
<p>当 Kubelet 在  <code>HandlePodRemoves</code>  方法中接收到来自客户端的删除请求时，就会通过一个名为  <code>deletePod</code>  的私有方法中的 Channel 将这一事件传递给 PodKiller 进行处理：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>kl</span> <span class=o>*</span><span class=nx>Kubelet</span><span class=p>)</span> <span class=nf>deletePod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>kl</span><span class=p>.</span><span class=nx>podWorkers</span><span class=p>.</span><span class=nf>ForgetWorker</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>

    <span class=nx>runningPods</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>kl</span><span class=p>.</span><span class=nx>runtimeCache</span><span class=p>.</span><span class=nf>GetPods</span><span class=p>()</span>
    <span class=nx>runningPod</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>runningPods</span><span class=p>).</span><span class=nf>FindPod</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>
    <span class=nx>podPair</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>PodPair</span><span class=p>{</span><span class=nx>APIPod</span><span class=p>:</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>RunningPod</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>runningPod</span><span class=p>}</span>

    <span class=nx>kl</span><span class=p>.</span><span class=nx>podKillingCh</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>podPair</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Kubelet 除了将事件通知给 PodKiller 之外，还需要将当前 Pod 对应的 Worker 从持有的  <code>podWorkers</code>  中删除；PodKiller 其实就是 Kubelet 持有的一个 Goroutine，它会在后台持续运行并监听来自  <code>podKillingCh</code>  的事件：</p>
<p><img src=https://img.draveness.me/2018-12-25-kubernetes-pod-killer.png alt=kubernetes-pod-killer></p>
<p>经过一系列的方法调用之后，最终调用容器运行时的  <code>killContainersWithSyncResult</code>  方法，这个方法会同步地杀掉当前 Pod 中全部的容器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=nf>killContainersWithSyncResult</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>runningPod</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>gracePeriodOverride</span> <span class=o>*</span><span class=kt>int64</span><span class=p>)</span> <span class=p>(</span><span class=nx>syncResults</span> <span class=p>[]</span><span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>SyncResult</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>containerResults</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>SyncResult</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>runningPod</span><span class=p>.</span><span class=nx>Containers</span><span class=p>))</span>

    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>container</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>runningPod</span><span class=p>.</span><span class=nx>Containers</span> <span class=p>{</span>
        <span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>container</span> <span class=o>*</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>Container</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>killContainerResult</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nf>NewSyncResult</span><span class=p>(</span><span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>KillContainer</span><span class=p>,</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
            <span class=nx>m</span><span class=p>.</span><span class=nf>killContainer</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>container</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>container</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;Need to kill Pod&#34;</span><span class=p>,</span> <span class=nx>gracePeriodOverride</span><span class=p>)</span>
            <span class=nx>containerResults</span> <span class=o>&lt;-</span> <span class=nx>killContainerResult</span>
        <span class=p>}(</span><span class=nx>container</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nb>close</span><span class=p>(</span><span class=nx>containerResults</span><span class=p>)</span>

    <span class=k>for</span> <span class=nx>containerResult</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>containerResults</span> <span class=p>{</span>
        <span class=nx>syncResults</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>syncResults</span><span class=p>,</span> <span class=nx>containerResult</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>return</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>对于每一个容器来说，它们在被停止之前都会先调用  <code>PreStop</code>  的钩子方法，让容器中的应用程序能够有时间完成一些未处理的操作，随后调用远程的服务停止运行的容器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=nf>killContainer</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>containerID</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nx>ContainerID</span><span class=p>,</span> <span class=nx>containerName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>reason</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>gracePeriodOverride</span> <span class=o>*</span><span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>containerSpec</span> <span class=o>:=</span> <span class=nx>kubecontainer</span><span class=p>.</span><span class=nf>GetContainerSpec</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>containerName</span><span class=p>);</span>

    <span class=nx>gracePeriod</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>minimumGracePeriodInSeconds</span><span class=p>)</span>
    <span class=k>switch</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>DeletionGracePeriodSeconds</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
        <span class=nx>gracePeriod</span> <span class=p>=</span> <span class=o>*</span><span class=nx>pod</span><span class=p>.</span><span class=nx>DeletionGracePeriodSeconds</span>
    <span class=k>case</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TerminationGracePeriodSeconds</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
        <span class=nx>gracePeriod</span> <span class=p>=</span> <span class=o>*</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TerminationGracePeriodSeconds</span>
    <span class=p>}</span>

    <span class=nx>m</span><span class=p>.</span><span class=nf>executePreStopHook</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>containerID</span><span class=p>,</span> <span class=nx>containerSpec</span><span class=p>,</span> <span class=nx>gracePeriod</span><span class=p>)</span>
    <span class=nx>m</span><span class=p>.</span><span class=nx>internalLifecycle</span><span class=p>.</span><span class=nf>PreStopContainer</span><span class=p>(</span><span class=nx>containerID</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span>
    <span class=nx>m</span><span class=p>.</span><span class=nx>runtimeService</span><span class=p>.</span><span class=nf>StopContainer</span><span class=p>(</span><span class=nx>containerID</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=nx>gracePeriod</span><span class=p>)</span>
    <span class=nx>m</span><span class=p>.</span><span class=nx>containerRefManager</span><span class=p>.</span><span class=nf>ClearRef</span><span class=p>(</span><span class=nx>containerID</span><span class=p>)</span>

    <span class=k>return</span> <span class=nx>err</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>从这个简化版本的  <code>killContainer</code>  方法中，我们可以大致看出停止运行容器的大致逻辑，先从 Pod 的规格中计算出当前停止所需要的时间，然后运行钩子方法和内部的生命周期方法，最后将容器停止并清除引用。</p>
<h2 id=总结>总结</h2>
<p>在这篇文章中，我们已经介绍了 Pod 中的几个重要概念 — 容器、卷和网络以及从创建到删除整个过程是如何实现的。</p>
<p>Kubernetes 中 Pod 的运行和管理总是与 kubelet 以及它的组件密不可分，后面的文章中也会介绍 kubelet 究竟是什么，它在整个 Kubernetes 中扮演什么样的角色。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-04-30 00:25:08
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/cloudnative/>cloudnative</a>
<a href=https://justice.bj.cn/tags/k8s/>k8s</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/32.cloudnative/k8s/k8s%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">k8s存储架构</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/32.cloudnative/k8s/k8s%E4%B9%8Bvolume%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/>
<span class="next-text nav-default">K8S之Volume原理</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
<div class=modal-dialog>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
$("#openSearch, #openSearchMobile").click(function(){
$(".modal-dialog").addClass("visible");
});
$("#closeSearch").click(function(){
$(".modal-dialog").removeClass("visible");
});
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</body>
</html>