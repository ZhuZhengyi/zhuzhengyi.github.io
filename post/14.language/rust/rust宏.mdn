# Rustå®

## ç®€ä»‹

ä¸€èˆ¬æ¥è¯´ï¼Œå®æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œåœ¨ç¼–è¯‘æœŸæ‰§è¡Œçš„ï¼Œç”¨äºå®ç°å…ƒç¼–ç¨‹çš„ä¸€ç§è¯­æ³•æ‰©å±•æŠ€æœ¯ï¼›

Rustä¸­çš„å®å¤„ç†å‘ç”Ÿåœ¨ AST ç”Ÿæˆä¹‹åï¼Œ

## ç‰¹æ€§

rustä¸­çš„å®æ‹¥æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š

- å«ç”Ÿå®ï¼Œç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶ä¼šä¿è¯å®é‡Œé¢å®šä¹‰çš„å˜é‡æˆ–å‡½æ•°ä¸ä¼šä¸å¤–é¢çš„å†²çªï¼Œåœ¨å®é‡Œé¢ä»¥æ™®é€šæ–¹å¼å®šä¹‰çš„å˜é‡ä½œç”¨åŸŸä¸ä¼šè·‘åˆ°å®å¤–é¢ï¼›
- å¯å˜å‚æ•°ã€‚rustä¸­çš„å®å‚æ•°æ•°é‡æ˜¯å¯å˜çš„ï¼›

## åˆ†ç±»

rustä¸­çš„å®åˆ†ä¸ºå£°æ˜å®å’Œè¿‡ç¨‹å®ä¸¤å¤§ç±»ï¼š

- **å£°æ˜**ï¼ˆ*Declarative*ï¼‰å®ï¼šä½¿ç”¨ `macro_rules!` å®šä¹‰ï¼›

- **è¿‡ç¨‹**ï¼ˆ*Procedural*ï¼‰å®ï¼šè¿‡ç¨‹å®æ¥æ”¶ Rust ä»£ç ä½œä¸ºè¾“å…¥ï¼Œåœ¨è¿™äº›ä»£ç ä¸Šè¿›è¡Œæ“ä½œï¼Œç„¶åäº§ç”Ÿå¦ä¸€äº›ä»£ç ä½œä¸ºè¾“å‡ºï¼Œè€Œéåƒå£°æ˜å¼å®é‚£æ ·åŒ¹é…å¯¹åº”æ¨¡å¼ç„¶åä»¥å¦ä¸€éƒ¨åˆ†ä»£ç æ›¿æ¢å½“å‰ä»£ç ã€‚è¿‡ç¨‹å®åŒ…å«ä»¥ä¸‹ä¸‰ç§ï¼š
  
  - `#[derive]` è¿‡ç¨‹å®ï¼šåœ¨ç»“æ„ä½“å’Œæšä¸¾ä¸ŠæŒ‡å®šé€šè¿‡ `derive` å±æ€§æ·»åŠ çš„ä»£ç ï¼›
  
  - ç±»å±æ€§ï¼ˆAttribute-likeï¼‰å®ï¼šå®šä¹‰å¯ç”¨äºä»»æ„é¡¹çš„è‡ªå®šä¹‰å±æ€§
  
  - ç±»å‡½æ•°å®ï¼šçœ‹èµ·æ¥åƒå‡½æ•°ä¸è¿‡ä½œç”¨äºä½œä¸ºå‚æ•°ä¼ é€’çš„ token

## å®è¯­æ³•

å®çš„è¯­æ³•åˆ†ä¸º**å®šä¹‰**å’Œ**è°ƒç”¨**ä¸¤ä¸ªæ–¹é¢ï¼š

```rust
// å®šä¹‰
macro_rules! <macro_name> { 
    macro_body 
}

// è°ƒç”¨
<macro_name>!<(macro_args)> 
```

æ³¨æ„ï¼š

* å®çš„å®šä¹‰å¿…é¡»å‡ºç°åœ¨å®è°ƒç”¨ä¹‹å‰;

* å®çš„è°ƒç”¨å‚æ•°å¯ä»¥ä½¿ç”¨`()`ã€`[]`ã€`{}`ä¸­çš„ä»»æ„è¿›è¡ŒåŒ…æ‹¬ï¼›

* 

## å£°æ˜å®macro_rules

* å£°æ˜å®æ˜¯ç”¨æ¥å£°æ˜ä¸€ä¸ªå®è°ƒç”¨çš„ï¼›

```rust
#[macro_export]           //å°†å®è¿›è¡Œäº†å¯¼å‡ºï¼Œå…¶å®ƒçš„åŒ…å°±å¯ä»¥å°†è¯¥å®å¼•å…¥åˆ°å½“å‰ä½œç”¨åŸŸä¸­ä½¿ç”¨
macro_rules! vec {        //macro_rulesï¼å®šä¹‰å®
    ( $( $x:expr ),* ) => {    //å®æ¨¡å¼åŒ¹é…
        {
            let mut temp_vec = Vec::new();
            $(
                temp_vec.push($x);
            )*
            temp_vec
        }
    };
}

vec![1, 2, 3]; //è¿™ä¸ªå®åœ¨ç¼–è¯‘æ—¶è¢«è½¬æ¢ä¸ºå¦‚ä¸‹ä»£ç æ®µ
{
    let mut temp_vec = Vec::new();
    temp_vec.push(1);
    temp_vec.push(2);
    temp_vec.push(3);
    temp_vec
}
```

### æŒ‡ç¤ºç¬¦(designator)

å®é‡Œé¢çš„å˜é‡éƒ½æ˜¯ä»¥Â `$`Â å¼€å¤´çš„ï¼Œå…¶ä½™çš„éƒ½æ˜¯æŒ‰å­—é¢å»åŒ¹é…ï¼Œä»¥Â `$`Â å¼€å¤´çš„å˜é‡éƒ½æ˜¯ç”¨æ¥è¡¨ç¤ºè¯­æ³•(syntactic)å…ƒç´ ï¼Œä¸ºäº†é™å®šåŒ¹é…ä»€ä¹ˆç±»å‹çš„è¯­æ³•å…ƒç´ ï¼Œéœ€è¦ç”¨æŒ‡ç¤ºç¬¦(designator)åŠ ä»¥é™å®šï¼Œå°±è·Ÿæ™®é€šçš„å˜é‡ç»‘å®šä¸€æ ·ç”¨å†’å·å°†å˜é‡å’Œç±»å‹åˆ†å¼€ï¼Œå½“å‰å®æ”¯æŒä»¥ä¸‹å‡ ç§æŒ‡ç¤ºç¬¦ï¼š

- [`block`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#block)ï¼šä»£ç å—(block)ï¼Œå¦‚ä¸€å—è¯­å¥æˆ–è€…ç”±å¤§æ‹¬å·åŒ…å›´çš„ä¸é™æ•°é‡çš„è¡¨è¾¾å¼ï¼›
- [`expr`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#expr)ï¼šè¡¨è¾¾å¼ (expression)ï¼ŒåŒ¹é…ä»»ä½•å½¢å¼çš„è¡¨è¾¾å¼ ([expression](https://doc.rust-lang.org/reference/expressions.html))ï¼Œå¦‚`"literal"`ã€`funcall()`ã€`future.await`;
- [`ident`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#ident)ï¼šæ ‡è¯†ç¬¦ (identifier)ï¼ŒåŒ¹é…ä»»ä½•å½¢å¼çš„æ ‡è¯†ç¬¦ ([identifier](https://doc.rust-lang.org/reference/identifiers.html)) æˆ–è€…å…³é”®å­—ï¼Œå¦‚`foo`ã€`async`ã€`O___O`ï¼›
- [`item`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#item)ï¼šæ¡ç›®(item), åŒ¹é… Rust çš„ [item](https://doc.rust-lang.org/reference/items.html) çš„ **å®šä¹‰** (definitions), å¦‚`struct Foo;`ã€`impl Foo {}`ã€`enum Bar {}`;
- [`lifetime`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#lifetime)ï¼šç”Ÿå‘½å‘¨æœŸæ³¨è§£(lifetime), æ¯”å¦‚Â `'foo`ã€`'static`;
- [`literal`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#literal)ï¼šå­—é¢å€¼(literal), æ¯”å¦‚Â `"Hello World!"`ã€`3.14`ã€`'ğŸ¦€'`;
- [`meta`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#meta)ï¼šå…ƒä¿¡æ¯(meta), åŒ¹é…å±æ€§ ([attribute](https://doc.rust-lang.org/reference/attributes.html))é‡Œé¢çš„å†…å®¹;
- [`pat`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#pat)ï¼šæ¨¡å¼ (pattern), æ™®é€šæ¨¡å¼åŒ¹é…ï¼ˆéå®æœ¬èº«çš„æ¨¡å¼ï¼‰ä¸­çš„æ¨¡å¼ï¼Œä¾‹å¦‚ `Some(t)`, `(3, 'a', _)`;
- [`path`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#path)ï¼šè·¯å¾„()path), æ¯”å¦‚Â `foo`ã€`::std::mem::replace`ã€`transmute::<_, int>`ï¼‰;
- [`stmt`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#stmt)ï¼šè¯­å¥ (statment), å¦‚ `let a = 42;`;
- [`tt`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#tt)ï¼š æ ‡è®°æ ‘(token tree), èƒ½åŒ¹é…å‡ ä¹æ‰€æœ‰ä¸œè¥¿ï¼Œ åœ¨ä½¿ç”¨å®ä¹‹åæ£€æŸ¥ (inspect) åŒ¹é…çš„å†…å®¹;
- [`ty`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#ty)ï¼šç±»å‹(type), åŒ¹é…ä»»ä½•å½¢å¼çš„ç±»å‹è¡¨è¾¾å¼ï¼Œå¦‚ `i32`, `char`ç­‰;
- [`vis`](https://zjp-cn.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#vis)ï¼šå¯è§†æ ‡è¯†ç¬¦ï¼Œå¯èƒ½ä¸ºç©º, æ¯”å¦‚Â `pub`ã€`pub(in crate)`;

### é‡å¤(repetition)

å®ç›¸æ¯”å‡½æ•°ä¸€ä¸ªå¾ˆå¤§çš„ä¸åŒæ˜¯å®å¯ä»¥æ¥å—ä»»æ„å¤šä¸ªå‚æ•°ï¼Œä¾‹å¦‚Â `println!`Â å’ŒÂ `vec!`ï¼Œä½¿ç”¨Â `+`Â å’ŒÂ `*`è¡¨ç¤ºé‡å¤ï¼›

* `+`Â è¡¨ç¤ºä¸€æ¬¡æˆ–å¤šæ¬¡ï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰ï¼›

* `*`Â è¡¨ç¤º0æ¬¡æˆ–å¤šæ¬¡ï¼›

* `?`æœ€å¤šä¸€æ¬¡é‡å¤ï¼›

é‡å¤çš„æ¨¡å¼éœ€è¦ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œå¤–é¢å†åŠ ä¸ŠÂ `$`ï¼Œä¾‹å¦‚Â `$(...)*`,Â `$(...)+`ã€‚

æ‹¬å·ä¸‰ç§æ‹¬å·ä¸­çš„ä»»æ„ä¸€ç§ï¼Œå› ä¸ºæ‹¬å·åœ¨è¿™é‡Œä»…ä»…æ˜¯ç”¨æ¥æ ‡è®°ä¸€ä¸ªæ¨¡å¼çš„å¼€å§‹å’Œç»“æŸï¼Œå¤§éƒ¨åˆ†æƒ…å†µé‡å¤çš„æ¨¡å¼æ˜¯ç”¨é€—å·æˆ–åˆ†å·åˆ†éš”çš„ï¼Œæ‰€ä»¥ä½ ä¼šç»å¸¸çœ‹åˆ°Â `$(...),*`,Â `$(...);*`,Â `$(...),+`,Â `$(...);+`Â è¿™æ ·çš„ç”¨æ¥è¡¨ç¤ºé‡å¤ã€‚

## è¿‡ç¨‹å®proc_macro

* è¿‡ç¨‹å®æ˜¯ä½¿ç”¨æºä»£ç ä½œä¸ºè¾“å…¥å‚æ•°ï¼ŒåŸºäºä»£ç è¿›è¡Œä¸€ç³»åˆ—æ“ä½œåï¼Œå†è¾“å‡ºä¸€æ®µå…¨æ–°çš„ä»£ç ;

* ä¸å£°æ˜å®ä¸åŒ,è¿‡ç¨‹å®ä¸­çš„ derive å®è¾“å‡ºçš„ä»£ç å¹¶ä¸ä¼šæ›¿æ¢ä¹‹å‰çš„ä»£ç ;

* è¿‡ç¨‹å®å¿…é¡»å…ˆè¢«ç¼–è¯‘åæ‰èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥å…¶å®šä¹‰å¿…é¡»è¦æ”¾å…¥ä¸€ä¸ªç‹¬ç«‹çš„åŒ…ä¸­ï¼›

### deriveè¿‡ç¨‹å®

```rust
//å®šä¹‰derive proc macro
use proc_macro;

#[proc_macro_derive(HelloMacro)]
pub fn some_name(input: TokenStream) -> TokenStream {
}


//ä½¿ç”¨derive proc macro
use hello_macro::HelloMacro;
use hello_macro_derive::HelloMacro;

#[derive(HelloMacro)]
struct Sunfei;

#[derive(HelloMacro)]
struct Sunface;
```

### å±æ€§è¿‡ç¨‹å®

å±æ€§è¿‡ç¨‹å®çš„å®šä¹‰å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ç”¨äºè¯´æ˜å±æ€§åŒ…å«çš„å†…å®¹ï¼š`Get, "/"` éƒ¨åˆ†
- ç¬¬äºŒä¸ªæ˜¯å±æ€§æ‰€æ ‡æ³¨çš„ç±»å‹é¡¹ï¼Œåœ¨è¿™é‡Œæ˜¯ `fn index() {...}`ï¼Œæ³¨æ„ï¼Œå‡½æ•°ä½“ä¹Ÿè¢«åŒ…å«å…¶ä¸­

ç±»å±æ€§å®çš„å·¥ä½œæ–¹å¼ï¼š

- åˆ›å»ºä¸€ä¸ªåŒ…ï¼Œç±»å‹æ˜¯ `proc-macro`ï¼›

- æ¥ç€å®ç°ä¸€ä¸ªå‡½æ•°ç”¨äºç”Ÿæˆæƒ³è¦çš„ä»£ç ã€‚

```rust
//å±æ€§å®å®šä¹‰
#[proc_macro_attribute]
pub fn route(attr: TokenStream, item: TokenStream) -> TokenStream {
    ...
}

//ä½¿ç”¨å±æ€§è¿‡ç¨‹å®
#[route(GET, "/")]
fn index() {
   ...
}
```

### å‡½æ•°è¿‡ç¨‹å®(Function-like macros)

- å‡½æ•°è¿‡ç¨‹å®å’Œå£°æ˜å® `macro_rules` æœ‰äº›ç±»ä¼¼, éƒ½å¯ä»¥æƒ³å‡½æ•°é‚£æ ·ç›´æ¥è°ƒç”¨ï¼›

- å‡½æ•°è¿‡ç¨‹å®å’Œå£°æ˜å®ä¸åŒä¹‹å¤„åœ¨äºå‡½æ•°è¿‡ç¨‹å®å®šä¹‰ä¸å¿…ä½¿ç”¨matchï¼Œè€Œæ˜¯æ›´çµæ´»ï¼Œä¹Ÿèƒ½å®ç°æ›´å¤æ‚çš„åŠŸèƒ½ï¼›

```rust
//å®šä¹‰å‡½æ•°è¿‡ç¨‹å®
#[proc_macro]
pub fn sql(input: TokenStream) -> TokenStream {}

//ä½¿ç”¨å‡½æ•°è¿‡ç¨‹å®
let sql = sql!(SELECT * FROM posts WHERE id=1);
```

## å‚è€ƒ

1. [å®ç³»ç»Ÿ Â· Rust Primer - ç»™åˆå­¦è€…çš„Rustä¸­æ–‡æ•™ç¨‹](https://hardocs.com/d/rustprimer/macro/macro.html)

2. [å® - Rust ç¨‹åºè®¾è®¡è¯­è¨€ ç®€ä½“ä¸­æ–‡ç‰ˆ](https://kaisery.github.io/trpl-zh-cn/ch19-06-macros.html)

3. [Rust Macro æ‰‹å†Œ](https://zhuanlan.zhihu.com/p/106016118)

4. 
