<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>ES倒排索引原理 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="ES倒排索引原理 简介 Elasticsearch通过Lucene的倒排索引技术实现比关系型数据库更快的过滤。 它对多条件的过滤支持非常好，比如年">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/30.architech/elasticsearch/es%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="ES倒排索引原理">
<meta property="og:description" content="ES倒排索引原理 简介 Elasticsearch通过Lucene的倒排索引技术实现比关系型数据库更快的过滤。 它对多条件的过滤支持非常好，比如年">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/30.architech/elasticsearch/es%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-01-10T00:00:00+00:00">
<meta property="article:modified_time" content="2022-01-10T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="ES倒排索引原理">
<meta itemprop=description content="ES倒排索引原理 简介 Elasticsearch通过Lucene的倒排索引技术实现比关系型数据库更快的过滤。 它对多条件的过滤支持非常好，比如年"><meta itemprop=datePublished content="2022-01-10T00:00:00+00:00">
<meta itemprop=dateModified content="2022-01-10T00:00:00+00:00">
<meta itemprop=wordCount content="4411">
<meta itemprop=keywords content="architech,elasticsearch,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="ES倒排索引原理">
<meta name=twitter:description content="ES倒排索引原理 简介 Elasticsearch通过Lucene的倒排索引技术实现比关系型数据库更快的过滤。 它对多条件的过滤支持非常好，比如年"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>ES倒排索引原理</h1>
<div class=post-meta>
<time datetime=2022-01-10 class=post-time>
2022-01-10
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/architech/> architech </a>
<a href=https://justice.bj.cn/categories/elasticsearch/> elasticsearch </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#如何联合索引查询>如何联合索引查询？</a></li>
<li><a href=#利用-skip-list-合并>利用 Skip List 合并</a></li>
<li><a href=#利用bitset合并>利用bitset合并</a></li>
<li><a href=#如何减少文档数>如何减少文档数？</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=es倒排索引原理>ES倒排索引原理</h1>
<h2 id=简介>简介</h2>
<p>Elasticsearch通过Lucene的倒排索引技术实现比关系型数据库更快的过滤。</p>
<p>它对多条件的过滤支持非常好，比如年龄在18和30之间，性别为女性这样的组合查询。</p>
<p>倒排索引很多地方都有介绍，但是其比关系型数据库的b-tree索引快在哪里？</p>
<p>b-tree索引是为写入优化的索引结构。</p>
<p>可以用预先排序等方式换取更小的存储空间，更快的检索速度等好处，其代价就是更新慢。</p>
<p>要进一步深入的化，还是要看一下Lucene的倒排索引是怎么构成的。</p>
<p><img src=https://pic3.zhimg.com/80/v2-378bc62acf1a493c402291a8f8e99e6a_720w.jpg alt></p>
<p>这里有好几个概念。我们来看一个实际的例子，假设有如下的数据：</p>
<p><img src=https://pic4.zhimg.com/80/v2-e6b81003803254b1d11b3384626c93ab_720w.jpg alt></p>
<p>这里每一行是一个document。</p>
<p>每个document都有一个docid。那么给这些document建立的倒排索引就是：</p>
<p><img src=https://pic1.zhimg.com/80/v2-c1cf40e4c4218fd3e992258c08e4e334_720w.jpg alt></p>
<p>可以看到，倒排索引是per field的，一个字段由一个自己的倒排索引。</p>
<p>18,20这些叫做 term，而[1,3]就是posting list。</p>
<p>Posting list就是一个int的数组，存储了所有符合某个term的文档id。</p>
<p>那么什么是term dictionary 和 term index？</p>
<p>假设我们有很多个term，比如：<code>Carla,Sara,Elin,Ada,Patty,Kate,Selena</code></p>
<p>如果按照这样的顺序排列，找出某个特定的term一定很慢，因为term没有排序，需要全部过滤一遍才能找出特定的term。</p>
<p>排序之后就变成了：<code>Ada,Carla,Elin,Kate,Patty,Sara,Selena</code></p>
<p>这样我们可以用二分查找的方式，比全遍历更快地找出目标的term。</p>
<p>这个就是 term dictionary。</p>
<p>有了<code>term dictionary</code>之后，可以用 <code>logN</code> 次磁盘查找得到目标。</p>
<p>但是磁盘的随机读操作仍然是非常昂贵的（一次<code>random access</code>大概需要10ms的时间）。</p>
<p>所以尽量少的读磁盘，有必要把一些数据缓存到内存里。</p>
<p>但是整个<code>term dictionary</code>本身又太大了，无法完整地放到内存里。</p>
<p>于是就有了<code>term index</code>。</p>
<p><code>term index</code>有点像一本字典的大的章节表。</p>
<p>比如：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>A开头的term ……………. Xxx页
C开头的term ……………. Xxx页
E开头的term ……………. Xxx页
</code></pre></td></tr></table>
</div>
</div><p>如果所有的term都是英文字符的话，可能这个term index就真的是26个英文字符表构成的了。</p>
<p>但是实际的情况是，term未必都是英文字符，term可以是任意的byte数组。</p>
<p>而且26个英文字符也未必是每一个字符都有均等的term，比如x字符开头的term可能一个都没有，</p>
<p>而s开头的term又特别多。实际的term index是一棵trie 树：</p>
<p><img src=https://pic1.zhimg.com/80/v2-e4632ac1392b01f7a39d963fddb1a1e0_720w.jpg alt></p>
<p>例子是一个包含 &ldquo;A&rdquo;, &ldquo;to&rdquo;, &ldquo;tea&rdquo;, &ldquo;ted&rdquo;, &ldquo;ten&rdquo;, &ldquo;i&rdquo;, &ldquo;in&rdquo;, 和 &ldquo;inn&rdquo; 的 trie 树。</p>
<p>这棵树不会包含所有的term，它包含的是term的一些前缀。</p>
<p>通过term index可以快速地定位到term dictionary的某个offset，然后从这个位置再往后顺序查找。</p>
<p>再加上一些压缩技术（搜索 Lucene Finite State Transducers） term index 的尺寸可以只有所有term的尺寸的几十分之一，</p>
<p>使得用内存缓存整个term index变成可能。整体上来说就是这样的效果。</p>
<p><img src=https://pic3.zhimg.com/80/v2-e4599b618e270df9b64a75eb77bfb326_720w.jpg alt></p>
<p>现在我们可以回答“为什么Elasticsearch/Lucene检索可以比mysql快了。</p>
<p>Mysql只有term dictionary这一层，是以b-tree排序的方式存储在磁盘上的。</p>
<p>检索一个term需要若干次的random access的磁盘操作。</p>
<p>而Lucene在term dictionary的基础上添加了term index来加速检索，term index以树的形式缓存在内存中。</p>
<p>从term index查到对应的term dictionary的block位置之后，</p>
<p>再去磁盘上找term，大大减少了磁盘的random access次数。</p>
<p>额外值得一提的两点是：</p>
<p>term index在内存中是以FST（finite state transducers）的形式保存的，其特点是非常节省内存。</p>
<p>Term dictionary在磁盘上是以分block的方式保存的，一个block内部利用公共前缀压缩，</p>
<p>比如都是Ab开头的单词就可以把Ab省去。这样term dictionary可以比b-tree更节约磁盘空间。</p>
<h2 id=如何联合索引查询>如何联合索引查询？</h2>
<p>所以给定查询过滤条件 age=18 的过程就是先从term index找到18在term dictionary的大概位置，</p>
<p>然后再从term dictionary里精确地找到18这个term，然后得到一个posting list或者一个指向posting list位置的指针。</p>
<p>然后再查询 gender=女 的过程也是类似的。</p>
<p>最后得出 age=18 AND gender=女 就是把两个 posting list 做一个“与”的合并。</p>
<p>这个理论上的“与”合并的操作可不容易。</p>
<p>对于mysql来说，如果你给age和gender两个字段都建立了索引，</p>
<p>查询的时候只会选择其中最selective的来用，然后另外一个条件: 是在遍历行的过程中在内存中计算之后过滤掉。</p>
<p>那么要如何才能联合使用两个索引呢？有两种办法：</p>
<ul>
<li>使用skip list数据结构。同时遍历gender和age的posting list，互相skip；</li>
<li>使用bitset数据结构，对gender和age两个filter分别求出bitset，对两个bitset做AN操作。</li>
</ul>
<p>PostgreSQL 从 8.4 版本开始支持通过bitmap联合使用两个索引，就是利用了bitset数据结构来做到的。</p>
<p>当然一些商业的关系型数据库也支持类似的联合索引的功能。</p>
<p>Elasticsearch支持以上两种的联合索引方式，如果查询的filter缓存到了内存中（以bitset的形式），</p>
<p>那么合并就是两个bitset的AND。</p>
<p>如果查询的filter没有缓存，那么就用skip list的方式去遍历两个on disk的posting list。</p>
<h2 id=利用-skip-list-合并>利用 Skip List 合并</h2>
<p><img src=https://pic4.zhimg.com/80/v2-eafa46683272ff1b2081edbc8db5469f_720w.jpg alt></p>
<p>以上是三个posting list。我们现在需要把它们用AND的关系合并，得出posting list的交集。</p>
<p>首先选择最短的posting list，然后从小到大遍历。</p>
<p>遍历的过程可以跳过一些元素，比如我们遍历到绿色的13的时候，就可以跳过蓝色的3了，因为3比13要小。</p>
<p>整个过程如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-text data-lang=text>Next -&gt; 2
Advance(2) -&gt; 13
Advance(13) -&gt; 13
Already on 13
Advance(13) -&gt; 13 MATCH!!!
Next -&gt; 17
Advance(17) -&gt; 22
Advance(22) -&gt; 98
Advance(98) -&gt; 98
Advance(98) -&gt; 98 MATCH!!!
</code></pre></td></tr></table>
</div>
</div><p>最后得出的交集是[13,98]，所需的时间比完整遍历三个posting list要快得多。</p>
<p>但是前提是每个list需要指出Advance这个操作，快速移动指向的位置。</p>
<p>什么样的list可以这样Advance往前做蛙跳？skip list：</p>
<p><img src=https://pic1.zhimg.com/80/v2-a8b78c8e861c34a1afd7891284852b34_720w.jpg alt></p>
<p>从概念上来说，对于一个很长的posting list，比如：</p>
<p><code>[1,3,13,101,105,108,255,256,257]</code></p>
<p>我们可以把这个list分成三个block：</p>
<p><code>[1,3,13] [101,105,108] [255,256,257]</code></p>
<p>然后可以构建出skip list的第二层：</p>
<p><code>[1,101,255]</code></p>
<p>1,101,255分别指向自己对应的block。这样就可以很快地跨block的移动指向位置了。</p>
<p>Lucene自然会对这个block再次进行压缩。其压缩方式叫做Frame Of Reference编码。示例如下：</p>
<p><img src=https://pic4.zhimg.com/80/v2-9c03d3e449e3f8fb8182287048ad6db7_720w.jpg alt></p>
<p>考虑到频繁出现的term（所谓low cardinality的值），比如gender里的男或者女。</p>
<p>如果有1百万个文档，那么性别为男的posting list里就会有50万个int值。</p>
<p>用Frame of Reference编码进行压缩可以极大减少磁盘占用。</p>
<p>这个优化对于减少索引尺寸有非常重要的意义。</p>
<p>当然mysql b-tree里也有一个类似的posting list的东西，是未经过这样压缩的。</p>
<p>因为这个Frame of Reference的编码是有解压缩成本的。</p>
<p>利用skip list，除了跳过了遍历的成本，也跳过了解压缩这些压缩过的block的过程，从而节省了cpu。</p>
<h2 id=利用bitset合并>利用bitset合并</h2>
<p>Bitset是一种很直观的数据结构，对应posting list如：</p>
<p><code>[1,3,4,7,10]</code></p>
<p>对应的bitset就是：</p>
<p><code>[1,0,1,1,0,0,1,0,0,1]</code></p>
<p>每个文档按照文档id排序对应其中的一个bit。</p>
<p>Bitset自身就有压缩的特点，其用一个byte就可以代表8个文档。</p>
<p>所以100万个文档只需要12.5万个byte。</p>
<p>但是考虑到文档可能有数十亿之多，在内存里保存bitset仍然是很奢侈的事情。</p>
<p>而且对于个每一个filter都要消耗一个bitset，比如age=18缓存起来的话是一个bitset，18&lt;=age&lt;25是另外一个filter缓存起来也要一个bitset。</p>
<p>所以秘诀就在于需要有一个数据结构：</p>
<ul>
<li>可以很压缩地保存上亿个bit代表对应的文档是否匹配filter；</li>
<li>这个压缩的bitset仍然可以很快地进行AND和 OR的逻辑操作。</li>
</ul>
<p>Lucene使用的这个数据结构叫做 <code>Roaring Bitmap</code>。</p>
<p><img src=https://pic3.zhimg.com/80/v2-9482b84c4aa3fb77a959c1ead553037e_720w.jpg alt></p>
<p>其压缩的思路其实很简单。与其保存100个0，占用100个bit。</p>
<p>还不如保存0一次，然后声明这个0重复了100遍。</p>
<p>这两种合并使用索引的方式都有其用途。</p>
<p>Elasticsearch对其性能有详细的对比（<a href="https://link.zhihu.com/?target=https%3A//www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps">https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps</a>）。</p>
<p>简单的结论是：</p>
<p>因为Frame of Reference编码是如此 高效，对于简单的相等条件的过滤缓存成纯内存的bitset还不如需要访问磁盘的skip list的方式要快。</p>
<h2 id=如何减少文档数>如何减少文档数？</h2>
<p>一种常见的压缩存储时间序列的方式是把多个数据点合并成一行。</p>
<p>Opentsdb支持海量数据的一个绝招就是定期把很多行数据合并成一行，这个过程叫compaction。</p>
<p>类似的vivdcortext使用mysql存储的时候，也把一分钟的很多数据点合并存储到mysql的一行里以减少行数。</p>
<p>这个过程可以示例如下：</p>
<p><img src=https://pic1.zhimg.com/80/v2-252d8f8ebe62e508f62049e80a9b9468_720w.jpg alt></p>
<p>可以看到，行变成了列了。</p>
<p>每一列可以代表这一分钟内一秒的数据。</p>
<p>Elasticsearch有一个功能可以实现类似的优化效果，那就是Nested Document。</p>
<p>我们可以把一段时间的很多个数据点打包存储到一个父文档里，变成其嵌套的子文档。</p>
<p>示例如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-text data-lang=text>{timestamp:12:05:01, idc:sz, value1:10,value2:11}
{timestamp:12:05:02, idc:sz, value1:9,value2:9}
{timestamp:12:05:02, idc:sz, value1:18,value:17}
</code></pre></td></tr></table>
</div>
</div><p>可以打包成：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=err>max_timestamp:12:05:02,</span> 
    <span class=err>min_timestamp:</span> <span class=err>1205:01,</span> 
    <span class=err>idc:sz,</span>
    <span class=err>records:</span> <span class=err>[</span>
        <span class=err>{timestamp:12:05:01,</span> <span class=err>value1:10,value2:11</span><span class=p>}</span>
        <span class=p>{</span><span class=err>timestamp:12:05:02,</span> <span class=err>value1:9,value2:9</span><span class=p>}</span>
        <span class=p>{</span><span class=err>timestamp:12:05:02,</span> <span class=err>value1:18,value:17</span><span class=p>}</span>
    <span class=err>]</span>
<span class=err>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这样可以把数据点公共的维度字段上移到父文档里，而不用在每个子文档里重复存储，从而减少索引的尺寸。</p>
<p><img src=https://pic4.zhimg.com/80/v2-917578288797efab8f67e7b74d5ec6a3_720w.jpg alt></p>
<p>在存储的时候，无论父文档还是子文档，对于Lucene来说都是文档，都会有文档Id。</p>
<p>但是对于嵌套文档来说，可以保存起子文档和父文档的文档id是连续的，而且父文档总是最后一个。</p>
<p>有这样一个排序性作为保障，那么有一个所有父文档的posting list就可以跟踪所有的父子关系。</p>
<p>也可以很容易地在父子文档id之间做转换。</p>
<p>把父子关系也理解为一个filter，那么查询时检索的时候不过是又AND了另外一个filter而已。</p>
<p>前面我们已经看到了Elasticsearch可以非常高效地处理多filter的情况，充分利用底层的索引。</p>
<p>使用了嵌套文档之后，对于term的posting list只需要保存父文档的doc id就可以了，</p>
<p>可以比保存所有的数据点的doc id要少很多。</p>
<p>如果我们可以在一个父文档里塞入50个嵌套文档，那么posting list可以变成之前的1/50。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-01-10
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/architech/>architech</a>
<a href=https://justice.bj.cn/tags/elasticsearch/>elasticsearch</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/14.language/c++/stl/stl%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">智能指针</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/14.language/golang/golang%E4%B9%8Bmutex/>
<span class="next-text nav-default">Golang之mutex</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
</body>
</html>