<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Flink内存管理 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Flink内存管理 JVM存在的问题 对象存储密度低 Full GC 影响性能 OOM 影响稳定 Cache Miss 代码结构： 基础数据结构（package:org.apache.fl">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/30.architech/flink/flink%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Flink内存管理">
<meta property="og:description" content="Flink内存管理 JVM存在的问题 对象存储密度低 Full GC 影响性能 OOM 影响稳定 Cache Miss 代码结构： 基础数据结构（package:org.apache.fl">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/30.architech/flink/flink%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-01-08T00:00:00+00:00">
<meta property="article:modified_time" content="2022-01-08T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Flink内存管理">
<meta itemprop=description content="Flink内存管理 JVM存在的问题 对象存储密度低 Full GC 影响性能 OOM 影响稳定 Cache Miss 代码结构： 基础数据结构（package:org.apache.fl"><meta itemprop=datePublished content="2022-01-08T00:00:00+00:00">
<meta itemprop=dateModified content="2022-01-08T00:00:00+00:00">
<meta itemprop=wordCount content="3109">
<meta itemprop=keywords content="architech,flink,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Flink内存管理">
<meta name=twitter:description content="Flink内存管理 JVM存在的问题 对象存储密度低 Full GC 影响性能 OOM 影响稳定 Cache Miss 代码结构： 基础数据结构（package:org.apache.fl"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Flink内存管理</h1>
<div class=post-meta>
<time datetime=2022-01-08 class=post-time>
2022-01-08
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/architech/> architech </a>
<a href=https://justice.bj.cn/categories/flink/> flink </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#jvm存在的问题>JVM存在的问题</a></li>
<li><a href=#代码结构>代码结构：</a></li>
<li><a href=#内存布局>内存布局</a></li>
<li><a href=#数据结构>数据结构</a></li>
<li><a href=#序列化>序列化</a></li>
<li><a href=#数据操作>数据操作</a></li>
<li><a href=#flink内存管理优势>Flink内存管理优势：</a></li>
</ul>
</li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=flink内存管理>Flink内存管理</h1>
<h3 id=jvm存在的问题>JVM存在的问题</h3>
<ol>
<li>
<p>对象存储密度低</p>
</li>
<li>
<p>Full GC 影响性能</p>
</li>
<li>
<p>OOM 影响稳定</p>
</li>
<li>
<p>Cache Miss</p>
</li>
</ol>
<h3 id=代码结构>代码结构：</h3>
<ul>
<li>基础数据结构（package:org.apache.flink.core.memory）</li>
<li>内存管理机制(package:org.apache.flink.runtime.memory)</li>
</ul>
<h3 id=内存布局>内存布局</h3>
<p>Flink 中的 Worker 名叫 TaskManager，是用来运行用户代码的 JVM 进程。</p>
<p>入口：</p>
<p><code>TaskManagerRunner.main() --> runTaskManager() --> ... -->TaskManagerServices </code></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TaskManagerServices</span> <span class=o>{</span>
    <span class=o>...</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>MemoryManager</span> <span class=n>memoryManager</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>NetworkEnvironment</span> <span class=n>networkEnvironment</span><span class=o>;</span>
    <span class=o>...</span>
     <span class=kd>public</span> <span class=kd>static</span> <span class=n>TaskManagerServices</span> <span class=nf>fromConfiguration</span><span class=o>()</span> <span class=o>{</span>
        <span class=o>...</span>
        <span class=kd>final</span> <span class=n>NetworkEnvironment</span> <span class=n>network</span> <span class=o>=</span> <span class=n>createNetworkEnvironment</span><span class=o>(</span><span class=n>taskManagerServicesConfiguration</span><span class=o>,</span> <span class=n>maxJvmHeapMemory</span><span class=o>);</span>
        <span class=kd>final</span> <span class=n>MemoryManager</span> <span class=n>memoryManager</span> <span class=o>=</span> <span class=n>createMemoryManager</span><span class=o>(</span><span class=n>taskManagerServicesConfiguration</span><span class=o>,</span> <span class=n>freeHeapMemoryWithDefrag</span><span class=o>,</span> <span class=n>maxJvmHeapMemory</span><span class=o>);</span>
        <span class=o>...</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-57-36-TB17qs5JpXXXXXhXpXXXXXXXXXX.png alt=img></p>
<ul>
<li><strong>Network Buffers:</strong> 一定数量的32KB大小的 buffer，主要用于数据的网络传输。在 TaskManager 启动的时候就会分配。默认数量是 2048 个，可以通过 <code>taskmanager.network.numberOfBuffers</code> 来配置。</li>
<li><strong>Memory Manager Pool:</strong> 这是一个由 <code>MemoryManager</code> 管理的，由众多<code>MemorySegment</code>组成的超大集合。Flink 中的算法（如 sort/shuffle/join）会向这个内存池申请 MemorySegment，将序列化后的数据存于其中，使用完后释放回内存池。默认情况下，池子占了堆内存的 70% 的大小。</li>
<li><strong>Remaining (Free) Heap:</strong> 这部分的内存是留给用户代码以及 TaskManager 的数据结构使用的。因为这些数据结构一般都很小，所以基本上这些内存都是给用户代码使用的。从GC的角度来看，可以把这里看成的新生代，也就是说这里主要都是由用户代码生成的短期对象。</li>
</ul>
<h3 id=数据结构>数据结构</h3>
<p>基础的内存数据结构：</p>
<ul>
<li>
<p>内存管理器：MemoryManager</p>
</li>
<li>
<p>内存池: MemoryPool/HybridHeapMemoryPool/HybridOffHeapMemoryPool</p>
</li>
<li>
<p>内存片段：MemorySegment/HeapMemorySegment/HybridMemorySegment</p>
</li>
<li>
<p>数据视图：DataInputView/DataOutputView</p>
</li>
<li>
<p><strong>内存管理器（MemoryManager）</strong></p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MemoryManager</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>MemoryPool</span> <span class=n>memoryPool</span><span class=o>;</span>    <span class=c1>//内存池
</span><span class=c1></span>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>MemoryType</span> <span class=n>memoryType</span><span class=o>;</span>    <span class=c1>//内存类型，HEAP/OFF_HEAP
</span><span class=c1></span>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isPreAllocated</span><span class=o>;</span>    <span class=c1>//是否预先分配
</span><span class=c1></span>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>MemorySegment</span><span class=o>&gt;&gt;</span> <span class=n>allocatedSegments</span><span class=o>;</span>    <span class=c1>//已分配的内存片段
</span><span class=c1></span>
    <span class=kd>public</span> <span class=nf>MemoryManager</span><span class=o>(...)</span> <span class=o>{</span>
        <span class=o>...</span>
        <span class=k>switch</span> <span class=o>(</span><span class=n>memoryType</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>case</span> <span class=n>HEAP</span><span class=o>:</span>
                <span class=k>this</span><span class=o>.</span><span class=na>memoryPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HybridHeapMemoryPool</span><span class=o>(</span><span class=n>memToAllocate</span><span class=o>,</span> <span class=n>pageSize</span><span class=o>);</span>
                <span class=k>break</span><span class=o>;</span>
            <span class=k>case</span> <span class=n>OFF_HEAP</span><span class=o>:</span>
                <span class=k>if</span> <span class=o>(!</span><span class=n>preAllocateMemory</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>LOG</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;It is advisable to set &#39;taskmanager.memory.preallocate&#39; to true when&#34;</span> <span class=o>+</span>
                        <span class=s>&#34; the memory type &#39;taskmanager.memory.off-heap&#39; is set to true.&#34;</span><span class=o>);</span>
                <span class=o>}</span>
                <span class=k>this</span><span class=o>.</span><span class=na>memoryPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HybridOffHeapMemoryPool</span><span class=o>(</span><span class=n>memToAllocate</span><span class=o>,</span> <span class=n>pageSize</span><span class=o>);</span>
                <span class=k>break</span><span class=o>;</span>
            <span class=k>default</span><span class=o>:</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;unrecognized memory type: &#34;</span> <span class=o>+</span> <span class=n>memoryType</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>allocatePages</span><span class=o>(</span><span class=n>Object</span> <span class=n>owner</span><span class=o>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>MemorySegment</span><span class=o>&gt;</span> <span class=n>target</span><span class=o>,</span> <span class=kt>int</span> <span class=n>numPages</span><span class=o>);</span>
       <span class=kd>public</span> <span class=kt>void</span> <span class=nf>release</span><span class=o>(</span><span class=n>MemorySegment</span> <span class=n>segment</span><span class=o>);</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>releaseAll</span><span class=o>(</span><span class=n>Object</span> <span class=n>owner</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>内存池（MemoryPool）</strong></li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>abstract</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>MemoryPool</span> <span class=o>{</span>
    <span class=kd>abstract</span> <span class=kt>int</span> <span class=nf>getNumberOfAvailableMemorySegments</span><span class=o>();</span>        <span class=c1>//获取有效内存片段数
</span><span class=c1></span>    <span class=kd>abstract</span> <span class=n>MemorySegment</span> <span class=nf>allocateNewSegment</span><span class=o>(</span><span class=n>Object</span> <span class=n>owner</span><span class=o>);</span>    <span class=c1>//分配新的内存片段
</span><span class=c1></span>    <span class=kd>abstract</span> <span class=n>MemorySegment</span> <span class=nf>requestSegmentFromPool</span><span class=o>(</span><span class=n>Object</span> <span class=n>owner</span><span class=o>);</span>    <span class=c1>//从内存池中获取内存片段
</span><span class=c1></span>    <span class=kd>abstract</span> <span class=kt>void</span> <span class=nf>returnSegmentToPool</span><span class=o>(</span><span class=n>MemorySegment</span> <span class=n>segment</span><span class=o>);</span>    <span class=c1>//将内存片段还给内存池
</span><span class=c1></span>    <span class=kd>abstract</span> <span class=kt>void</span> <span class=nf>clear</span><span class=o>();</span>
<span class=o>}</span>

<span class=n>HybridHeapMemoryPool</span><span class=o>(</span><span class=kt>int</span> <span class=n>numInitialSegments</span><span class=o>,</span> <span class=kt>int</span> <span class=n>segmentSize</span><span class=o>)</span> <span class=o>{</span>
   <span class=k>this</span><span class=o>.</span><span class=na>availableMemory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;(</span><span class=n>numInitialSegments</span><span class=o>);</span>
   <span class=k>this</span><span class=o>.</span><span class=na>segmentSize</span> <span class=o>=</span> <span class=n>segmentSize</span><span class=o>;</span>

   <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>numInitialSegments</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
      <span class=c1>// 使用 new 在 jvm 堆上分配内存
</span><span class=c1></span>      <span class=k>this</span><span class=o>.</span><span class=na>availableMemory</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>segmentSize</span><span class=o>]);</span>
   <span class=o>}</span>
<span class=o>}</span>

<span class=n>HybridOffHeapMemoryPool</span><span class=o>(</span><span class=kt>int</span> <span class=n>numInitialSegments</span><span class=o>,</span> <span class=kt>int</span> <span class=n>segmentSize</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>this</span><span class=o>.</span><span class=na>availableMemory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;(</span><span class=n>numInitialSegments</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>segmentSize</span> <span class=o>=</span> <span class=n>segmentSize</span><span class=o>;</span>

    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>numInitialSegments</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
        <span class=c1>// 使用 allocateDirect 直接堆外内存
</span><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>availableMemory</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>ByteBuffer</span><span class=o>.</span><span class=na>allocateDirect</span><span class=o>(</span><span class=n>segmentSize</span><span class=o>));</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>内存片段工厂</strong></li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>MemorySegmentFactory</span> <span class=o>{</span>
    <span class=o>...</span>
    <span class=c1>// 从池外(jvm堆中)分配内存段
</span><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>MemorySegment</span> <span class=nf>allocateUnpooledSegment</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>HybridMemorySegment</span><span class=o>(</span><span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>size</span><span class=o>],</span> <span class=n>owner</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=c1>// 从内存池 中 获取堆内存片段
</span><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>MemorySegment</span> <span class=nf>wrapPooledHeapMemory</span><span class=o>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>memory</span><span class=o>,</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>HybridMemorySegment</span><span class=o>(</span><span class=n>memory</span><span class=o>,</span> <span class=n>owner</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=c1>// 从内存池中 获取 非堆内存片段
</span><span class=c1></span>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>MemorySegment</span> <span class=nf>wrapPooledOffHeapMemory</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>memory</span><span class=o>,</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=k>new</span> <span class=n>HybridMemorySegment</span><span class=o>(</span><span class=n>memory</span><span class=o>,</span> <span class=n>owner</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>内存片段(MemorySegment)</strong></p>
</li>
<li>
<p>HeapMemorySegment : 管理的内存还是JVM堆内存的一部分</p>
</li>
<li>
<p>HybridMemorySegment : Hybrid(on-heap or off-heap)MemorySegment，内存可能为JVM堆内存，也可能不是。</p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>MemorySegment</span> <span class=o>{</span>
    <span class=kd>protected</span> <span class=kd>final</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>heapMemory</span><span class=o>;</span>    <span class=c1>//堆内存
</span><span class=c1></span>    <span class=kd>protected</span> <span class=kt>long</span> <span class=n>address</span><span class=o>;</span>    <span class=c1>//字节数组对应的相对地址（若heapMemory为null，即可能为off-heap内存的绝对地址
</span><span class=c1></span>    <span class=kd>protected</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>addressLimit</span><span class=o>;</span>    <span class=c1>//
</span><span class=c1></span>    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>sun</span><span class=o>.</span><span class=na>misc</span><span class=o>.</span><span class=na>Unsafe</span> <span class=n>UNSAFE</span> <span class=o>=</span> <span class=n>MemoryUtils</span><span class=o>.</span><span class=na>UNSAFE</span><span class=o>;</span>    <span class=c1>//用来对堆/非堆内存进行操作，是JVM的非安全的API
</span><span class=c1></span>    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>BYTE_ARRAY_BASE_OFFSET</span> <span class=o>=</span> <span class=n>UNSAFE</span><span class=o>.</span><span class=na>arrayBaseOffset</span><span class=o>(</span><span class=kt>byte</span><span class=o>[].</span><span class=na>class</span><span class=o>);</span>    <span class=c1>//二进制字节数组的起始索引，相对于字节数组对象
</span><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>LITTLE_ENDIAN</span> <span class=o>=</span> <span class=o>(</span><span class=n>ByteOrder</span><span class=o>.</span><span class=na>nativeOrder</span><span class=o>()</span> <span class=o>==</span> <span class=n>ByteOrder</span><span class=o>.</span><span class=na>LITTLE_ENDIAN</span><span class=o>);</span>    <span class=c1>//字节序
</span><span class=c1></span>    <span class=kd>protected</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>size</span><span class=o>;</span>    <span class=c1>//内存段的字节数
</span><span class=c1></span>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>;</span>    <span class=c1>//该内存段owner
</span><span class=c1></span>    <span class=o>...</span>
 <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>HeapMemorySegment</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>//堆内存
</span><span class=c1></span><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>HeapMemorySegment</span> <span class=kd>extends</span> <span class=n>MemorySegment</span> <span class=o>{</span>
  <span class=c1>// 指向heapMemory的额外引用，用来如数组越界的检查
</span><span class=c1></span>  <span class=kd>private</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>memory</span><span class=o>;</span>
  <span class=c1>// 只能初始化堆内存
</span><span class=c1></span>  <span class=n>HeapMemorySegment</span><span class=o>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>memory</span><span class=o>,</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>Objects</span><span class=o>.</span><span class=na>requireNonNull</span><span class=o>(</span><span class=n>memory</span><span class=o>),</span> <span class=n>owner</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>memory</span> <span class=o>=</span> <span class=n>memory</span><span class=o>;</span>
  <span class=o>}</span>
  <span class=c1>//...
</span><span class=c1></span><span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>HybridMemorySegment</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java>  <span class=c1>//混合内存
</span><span class=c1></span>
  <span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>HybridMemorySegment</span> <span class=kd>extends</span> <span class=n>MemorySegment</span> <span class=o>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ByteBuffer</span> <span class=n>offHeapBuffer</span><span class=o>;</span>
  <span class=c1>// 非堆内存
</span><span class=c1></span>  <span class=n>HybridMemorySegment</span><span class=o>(</span><span class=n>ByteBuffer</span> <span class=n>buffer</span><span class=o>,</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>checkBufferAndGetAddress</span><span class=o>(</span><span class=n>buffer</span><span class=o>),</span> <span class=n>buffer</span><span class=o>.</span><span class=na>capacity</span><span class=o>(),</span> <span class=n>owner</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>offHeapBuffer</span> <span class=o>=</span> <span class=n>buffer</span><span class=o>;</span>
  <span class=o>}</span>

  <span class=c1>// 堆内存初始化
</span><span class=c1></span>  <span class=n>HybridMemorySegment</span><span class=o>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>buffer</span><span class=o>,</span> <span class=n>Object</span> <span class=n>owner</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>buffer</span><span class=o>,</span> <span class=n>owner</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>offHeapBuffer</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
  <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>数据视图</strong></li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-57-49-flink-source-code-analysis-memory-management_dataview-class-diagram.png alt=dataview-class-diagram></p>
<p>提供内存逻辑视图操作</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DataInputView</span> <span class=kd>extends</span> <span class=n>DataInput</span> <span class=o>{</span>
  <span class=kt>void</span> <span class=nf>skipBytesToRead</span><span class=o>(</span><span class=kt>int</span> <span class=n>numBytes</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>;</span>
  <span class=kt>int</span> <span class=nf>read</span><span class=o>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>b</span><span class=o>,</span> <span class=kt>int</span> <span class=n>off</span><span class=o>,</span> <span class=kt>int</span> <span class=n>len</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>;</span>    <span class=c1>//读取数据到b中
</span><span class=c1></span>  <span class=kt>int</span> <span class=nf>read</span><span class=o>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>b</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>;</span>
<span class=o>}</span>

<span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DataOutputView</span> <span class=kd>extends</span> <span class=n>DataOutput</span> <span class=o>{</span>
    <span class=kt>void</span> <span class=nf>skipBytesToWrite</span><span class=o>(</span><span class=kt>int</span> <span class=n>numBytes</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>;</span>
    <span class=kt>void</span> <span class=nf>write</span><span class=o>(</span><span class=n>DataInputView</span> <span class=n>source</span><span class=o>,</span> <span class=kt>int</span> <span class=n>numBytes</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>;</span> <span class=c1>//
</span><span class=c1></span><span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=序列化>序列化</h3>
<p>Flink 中处理的数据流通常是同一类型，由于数据集对象的类型固定，对于数据集可以只保存一份对象Schema信息，节省大量的存储空间。同时，对于固定大小的类型，也可通过固定的偏移位置存取。当我们需要访问某个对象成员变量的时候，通过定制的序列化工具，并不需要反序列化整个Java对象，而是可以直接通过偏移量，只是反序列化特定的对象成员变量。如果对象的成员变量较多时，能够大大减少Java对象的创建开销，以及内存数据的拷贝大小。</p>
<p>Flink支持任意的Java或是Scala类型。Flink 在数据类型上有很大的进步，不需要实现一个特定的接口（像Hadoop中的<code>org.apache.hadoop.io.Writable</code>），Flink 能够自动识别数据类型。Flink 通过 Java Reflection 框架分析基于 Java 的 Flink 程序 UDF (User Define Function)的返回类型的类型信息，通过 Scala Compiler 分析基于 Scala 的 Flink 程序 UDF 的返回类型的类型信息。类型信息由 <code>TypeInformation</code> 类表示，TypeInformation 支持以下几种类型：</p>
<ul>
<li><code>BasicTypeInfo</code>: 任意Java 基本类型（装箱的）或 String 类型。</li>
<li><code>BasicArrayTypeInfo</code>: 任意Java基本类型数组（装箱的）或 String 数组。</li>
<li><code>WritableTypeInfo</code>: 任意 Hadoop Writable 接口的实现类。</li>
<li><code>TupleTypeInfo</code>: 任意的 Flink Tuple 类型(支持Tuple1 to Tuple25)。Flink tuples 是固定长度固定类型的Java Tuple实现。</li>
<li><code>CaseClassTypeInfo</code>: 任意的 Scala CaseClass(包括 Scala tuples)。</li>
<li><code>PojoTypeInfo</code>: 任意的 POJO (Java or Scala)，例如，Java对象的所有成员变量，要么是 public 修饰符定义，要么有 getter/setter 方法。</li>
<li><code>GenericTypeInfo</code>: 任意无法匹配之前几种类型的类。</li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-57-56-image-20180513121031892.png alt=image-20180513121031892></p>
<p>如下图展示 一个内嵌型的Tuple3 对象的序列化过程。</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-58-03-TB1lvdbJFXXXXa9XVXXXXXXXXXX.png alt=img></p>
<p>可以看出这种序列化方式存储密度是相当紧凑的。其中 int 占4字节，double 占8字节，POJO多个一个字节的header，PojoSerializer只负责将header序列化进去，并委托每个字段对应的serializer对字段进行序列化。</p>
<p>Flink 的类型系统可以很轻松地扩展出自定义的TypeInformation、Serializer以及Comparator，来提升数据类型在序列化和比较时的性能。</p>
<h3 id=数据操作>数据操作</h3>
<p>Flink 提供了如 group、sort、join 等操作，这些操作都需要访问海量数据。这里，我们以sort为例，这是一个在 Flink 中使用非常频繁的操作。</p>
<p>首先，Flink 会从 MemoryManager 中申请一批 MemorySegment，我们把这批 MemorySegment 称作 sort buffer，用来存放排序的数据。</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-58-12-TB1_hhgJFXXXXc2XFXXXXXXXXXX.png alt=img></p>
<p>我们会把 sort buffer 分成两块区域。一个区域是用来存放所有对象完整的二进制数据。另一个区域用来存放指向完整二进制数据的指针以及定长的序列化后的key（key+pointer）。如果需要序列化的key是个变长类型，如String，则会取其前缀序列化。如上图所示，当一个对象要加到 sort buffer 中时，它的二进制数据会被加到第一个区域，指针（可能还有key）会被加到第二个区域。</p>
<p>将实际的数据和指针加定长key分开存放有两个目的:</p>
<p>第一，交换定长块（key+pointer）更高效，不用交换真实的数据也不用移动其他key和pointer。</p>
<p>第二，这样做是缓存友好的，因为key都是连续存储在内存中的，可以大大减少 cache miss。</p>
<p>排序的关键是比大小和交换。Flink 中，会先用 key 比大小，这样就可以直接用二进制的key比较而不需要反序列化出整个对象。因为key是定长的，所以如果key相同（或者没有提供二进制key），那就必须将真实的二进制数据反序列化出来，然后再做比较。之后，只需要交换key+pointer就可以达到排序的效果，真实的数据不用移动。</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-58-20-TB1f6BnJFXXXXbnXFXXXXXXXXXX.png alt=img></p>
<h3 id=flink内存管理优势>Flink内存管理优势：</h3>
<ol>
<li>节省内存空间</li>
<li>高效的内存操作</li>
<li>缓存友好的计算</li>
<li>减少OOM</li>
<li>减少GC</li>
</ol>
<h2 id=参考>参考</h2>
<ol>
<li><a href=https://juejin.im/post/5c4f16dbe51d454f342fb7e7>https://juejin.im/post/5c4f16dbe51d454f342fb7e7</a></li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-01-08
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/architech/>architech</a>
<a href=https://justice.bj.cn/tags/flink/>flink</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/30.architech/flink/flink%E5%85%A5%E9%97%A8/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Flink入门</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/flink/flink%E7%AE%80%E4%BB%8B/>
<span class="next-text nav-default">Flink简介</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/L2Dwidget.0.min.js></script>
<script src=/js/L2Dwidget.min.js></script>
<script src=/js/l2d.js></script>
</body>
</html>