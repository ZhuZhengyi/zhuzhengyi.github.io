<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>HBase Region 自动拆分策略 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="HBase Region 自动拆分策略 HBase-2.x支持7种Region自动拆分Region的策略，类图如下: 设置自动拆分策略的关键配置如下: 1 2 3 4 5 6 7 8">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/30.architech/hbase/hbase_split_policy/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="HBase Region 自动拆分策略">
<meta property="og:description" content="HBase Region 自动拆分策略 HBase-2.x支持7种Region自动拆分Region的策略，类图如下: 设置自动拆分策略的关键配置如下: 1 2 3 4 5 6 7 8">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/30.architech/hbase/hbase_split_policy/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-10-10T12:59:52+08:00">
<meta property="article:modified_time" content="2021-10-10T12:59:52+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="HBase Region 自动拆分策略">
<meta itemprop=description content="HBase Region 自动拆分策略 HBase-2.x支持7种Region自动拆分Region的策略，类图如下: 设置自动拆分策略的关键配置如下: 1 2 3 4 5 6 7 8"><meta itemprop=datePublished content="2021-10-10T12:59:52+08:00">
<meta itemprop=dateModified content="2021-10-10T12:59:52+08:00">
<meta itemprop=wordCount content="5030">
<meta itemprop=keywords content="architech,hbase,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="HBase Region 自动拆分策略">
<meta name=twitter:description content="HBase Region 自动拆分策略 HBase-2.x支持7种Region自动拆分Region的策略，类图如下: 设置自动拆分策略的关键配置如下: 1 2 3 4 5 6 7 8"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-click class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>HBase Region 自动拆分策略</h1>
<div class=post-meta>
<time datetime=2021-10-10 class=post-time>
2021-10-10 12:59:52
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/architech/> architech </a>
<a href=https://justice.bj.cn/categories/hbase/> hbase </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#1-constantsizeregionsplitpolicy>1. ConstantSizeRegionSplitPolicy</a>
<ul>
<li><a href=#策略描述>策略描述</a></li>
<li><a href=#相关参数>相关参数</a></li>
<li><a href=#部分源码>部分源码</a></li>
<li><a href=#拆分效果>拆分效果</a></li>
<li><a href=#设置方法>设置方法</a></li>
</ul>
</li>
<li><a href=#2-increasingtoupperboundregionsplitpolicy>2. IncreasingToUpperBoundRegionSplitPolicy</a>
<ul>
<li><a href=#策略描述-1>策略描述</a></li>
<li><a href=#相关配置>相关配置</a></li>
<li><a href=#部分源码-1>部分源码</a></li>
<li><a href=#设置方法-1>设置方法</a></li>
<li><a href=#拆分效果-1>拆分效果</a></li>
</ul>
</li>
<li><a href=#3-keyprefixregionsplitpolicy>3. KeyPrefixRegionSplitPolicy</a>
<ul>
<li><a href=#策略描述-2>策略描述</a></li>
<li><a href=#相关配置-1>相关配置</a></li>
<li><a href=#设置方法-2>设置方法</a></li>
<li><a href=#适用场景>适用场景</a></li>
</ul>
</li>
<li><a href=#4-delimitedkeyprefixregionsplitpolicy>4. DelimitedKeyPrefixRegionSplitPolicy</a>
<ul>
<li><a href=#拆分策略>拆分策略</a></li>
<li><a href=#相关配置-2>相关配置</a></li>
<li><a href=#配置方法>配置方法</a></li>
<li><a href=#拆分效果-2>拆分效果</a></li>
</ul>
</li>
<li><a href=#5-steppingsplitpolicy>5. SteppingSplitPolicy</a>
<ul>
<li><a href=#策略描述-3>策略描述</a></li>
<li><a href=#源码>源码</a></li>
<li><a href=#设置方法-3>设置方法</a></li>
</ul>
</li>
<li><a href=#6-busyregionsplitpolicy-hbase-2x-only>6. BusyRegionSplitPolicy (HBase-2.x Only)</a>
<ul>
<li><a href=#策略描述-4>策略描述</a></li>
<li><a href=#相关配置-3>相关配置</a></li>
<li><a href=#设置方法-4>设置方法</a></li>
<li><a href=#适用场景-1>适用场景</a></li>
</ul>
</li>
<li><a href=#7-disabledregionsplitpolicy>7. DisabledRegionSplitPolicy</a>
<ul>
<li><a href=#策略描述-5>策略描述</a></li>
<li><a href=#设置方法-5>设置方法</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=hbase-region-自动拆分策略>HBase Region 自动拆分策略</h1>
<p>HBase-2.x支持7种Region自动拆分Region的策略，类图如下:</p>
<p><img src=assets/2020-04-02-17-31-02-image.png alt></p>
<p>设置自动拆分策略的关键配置如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>hbase.regionserver.region.split.policy
description: Region自动拆分的策略
default: 
    HBase-1.2.x: org.apache.hadoop.hbase.regionserver.IncreasingToUpperBoundRegionSplitPolicy
    HBase-2.x: org.apache.hadoop.hbase.regionserver.SteppingSplitPolicy
option: 
    org.apache.hadoop.hbase.regionserver.DisabledRegionSplitPolicy
    org.apache.hadoop.hbase.regionserver.ConstantSizeRegionSplitPolicy
    org.apache.hadoop.hbase.regionserver.IncreasingToUpperBoundRegionSplitPolicy
    org.apache.hadoop.hbase.regionserver.SteppingSplitPolicy
    org.apache.hadoop.hbase.regionserver.KeyPrefixRegionSplitPolicy
    org.apache.hadoop.hbase.regionserver.DelimitedKeyPrefixRegionSplitPolicy
    org.apache.hadoop.hbase.regionserver.BusyRegionSplitPolicy (HBase-2.x Only)
</code></pre></td></tr></table>
</div>
</div><p>配置方法：</p>
<ul>
<li>在hbase-site.xml中配置，例如：</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;property&gt;</span> 
    <span class=nt>&lt;name&gt;</span>hbase.regionserver.region.split.policy<span class=nt>&lt;/name&gt;</span>  
    <span class=nt>&lt;value&gt;</span>org.apache.hadoop.hbase.regionserver.IncreasingToUpperBoundRegionSplitPolicy<span class=nt>&lt;/value&gt;</span> 
<span class=nt>&lt;/property&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在HBase Configuration中配置</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kd>static</span> <span class=n>Configuration</span> <span class=n>conf</span> <span class=o>=</span> <span class=n>HBaseConfiguration</span><span class=o>.</span><span class=na>create</span><span class=o>();</span>
<span class=n>conf</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;hbase.regionserver.region.split.policy&#34;</span><span class=o>,</span> <span class=s>&#34;org.apache.hadoop.hbase.regionserver.SteppingSplitPolicy&#34;</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在创建表的时候配置
Region的拆分策略需要根据表的属性来合理的配置，所以建议不要使用前两种方法来配置拆分策略，关于在建表的时候怎么配置，会在下面解释每种策略的时候说明。</li>
</ul>
<p>接下来将详细介绍这7种Region自动拆分的策略。</p>
<h2 id=1-constantsizeregionsplitpolicy>1. ConstantSizeRegionSplitPolicy</h2>
<h3 id=策略描述>策略描述</h3>
<p>这种策略非常简单，只要Region的大小达到了<code>hbase.hregion.max.filesize</code>所定义的大小，就进行拆分。</p>
<h3 id=相关参数>相关参数</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>hbase.hregion.max.filesize
    default: 10737418240 (10GB)
    description: 当一个Region的容量达到这个配置定义的大小后,就会拆分Region

hbase.server.thread.wakefrequency
    default: 10000 (10s)
    description: 检测Region的大小是否超过限制的时间间隔
</code></pre></td></tr></table>
</div>
</div><h3 id=部分源码>部分源码</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=cm>/** Conf key for the max file size after which we split the region */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>HREGION_MAX_FILESIZE</span> <span class=o>=</span> <span class=s>&#34;hbase.hregion.max.filesize&#34;</span><span class=o>;</span>
<span class=cm>/** Default maximum file size */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>DEFAULT_MAX_FILE_SIZE</span> <span class=o>=</span> <span class=n>10</span> <span class=o>*</span> <span class=n>1024</span> <span class=o>*</span> <span class=n>1024</span> <span class=o>*</span> <span class=n>1024L</span><span class=o>;</span>

<span class=cm>/**
</span><span class=cm>
</span><span class=cm>* 获取拆分上限值
</span><span class=cm>  */</span>
  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>configureForRegion</span><span class=o>(</span><span class=n>HRegion</span> <span class=n>region</span><span class=o>)</span> <span class=o>{</span>
   <span class=n>Configuration</span> <span class=n>conf</span> <span class=o>=</span> <span class=n>getConf</span><span class=o>();</span>
   <span class=n>HTableDescriptor</span> <span class=n>desc</span> <span class=o>=</span> <span class=n>region</span><span class=o>.</span><span class=na>getTableDesc</span><span class=o>();</span>
   <span class=k>if</span> <span class=o>(</span><span class=n>desc</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
     <span class=c1>// 如果用户在建表时指定了该表的单个Region的上限, 取用户定义的这个值
</span><span class=c1></span>     <span class=k>this</span><span class=o>.</span><span class=na>desiredMaxFileSize</span> <span class=o>=</span> <span class=n>desc</span><span class=o>.</span><span class=na>getMaxFileSize</span><span class=o>();</span>
   <span class=o>}</span>
   <span class=c1>// 如果用户没有定义, 取&#39;hbase.hregion.max.filesize&#39;这个配置定义的值, 如果这个配置没有定义, 取默认值 10G
</span><span class=c1></span>   <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>desiredMaxFileSize</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
     <span class=k>this</span><span class=o>.</span><span class=na>desiredMaxFileSize</span> <span class=o>=</span> <span class=n>conf</span><span class=o>.</span><span class=na>getLong</span><span class=o>(</span><span class=n>HConstants</span><span class=o>.</span><span class=na>HREGION_MAX_FILESIZE</span><span class=o>,</span>

       <span class=n>HConstants</span><span class=o>.</span><span class=na>DEFAULT_MAX_FILE_SIZE</span><span class=o>);</span>

   <span class=o>}</span>
   <span class=o>...</span>
  <span class=o>}</span>

<span class=cm>/**
</span><span class=cm>
</span><span class=cm>* 判断是否进行拆分
</span><span class=cm>  */</span>
  <span class=kd>protected</span> <span class=kt>boolean</span> <span class=nf>shouldSplit</span><span class=o>()</span> <span class=o>{</span>
   <span class=kt>boolean</span> <span class=n>force</span> <span class=o>=</span> <span class=n>region</span><span class=o>.</span><span class=na>shouldForceSplit</span><span class=o>();</span>
   <span class=kt>boolean</span> <span class=n>foundABigStore</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>

   <span class=k>for</span> <span class=o>(</span><span class=n>Store</span> <span class=n>store</span> <span class=o>:</span> <span class=n>region</span><span class=o>.</span><span class=na>getStores</span><span class=o>())</span> <span class=o>{</span>
     <span class=c1>// 如果有任何一个Region此时不能被拆分(例如还有一些代码或者线程在访问它), 那么返回false
</span><span class=c1></span>     <span class=k>if</span> <span class=o>((!</span><span class=n>store</span><span class=o>.</span><span class=na>canSplit</span><span class=o>()))</span> <span class=o>{</span>

       <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>

     <span class=o>}</span>

     <span class=c1>// 如果Region的大小已经大于desiredMaxFileSize这个值, 返回true
</span><span class=c1></span>     <span class=k>if</span> <span class=o>(</span><span class=n>store</span><span class=o>.</span><span class=na>getSize</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>desiredMaxFileSize</span><span class=o>)</span> <span class=o>{</span>

       <span class=n>foundABigStore</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>

     <span class=o>}</span>
   <span class=o>}</span>

   <span class=k>return</span> <span class=n>foundABigStore</span> <span class=o>||</span> <span class=n>force</span><span class=o>;</span>

   <span class=c1>// 只要shouldSplit()方法返回true, 就进行Region的拆分
</span><span class=c1></span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=拆分效果>拆分效果</h3>
<p>经过这种策略的拆分后，Region的大小是均匀的，例如一个10G的Region，拆分为两个Region后，这两个新的Region的大小是相差不大的，理想状态是每个都是5G。</p>
<h3 id=设置方法>设置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=s>&#34;tableName&#34;</span><span class=o>));</span>

<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.ConstantSizeRegionSplitPolicy&#34;</span><span class=o>);</span>
<span class=c1>// 以下配置根据需要配置或者不配置
</span><span class=c1></span><span class=n>tableDesc</span><span class=o>.</span><span class=na>setMaxFileSize</span><span class=o>(</span><span class=n>1048576000</span><span class=o>);</span>

<span class=n>tableDesc</span><span class=o>.</span><span class=na>addFamily</span><span class=o>(...)</span>
<span class=n>admin</span><span class=o>.</span><span class=na>createTable</span><span class=o>(</span><span class=n>tableDesc</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=2-increasingtoupperboundregionsplitpolicy>2. IncreasingToUpperBoundRegionSplitPolicy</h2>
<h3 id=策略描述-1>策略描述</h3>
<p>这种拆分策略是HBase-1.2.x的默认使用的拆分策略，Region的前几次拆分的阈值不是固定的数值，是需要进行计算得到，计算过程在源码中说明。</p>
<h3 id=相关配置>相关配置</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>hbase.hregion.memstore.flush.size
    default: 134217728 (128MB)
    description: 如果Memstore的大小超过这个字节数,它将被刷新到磁盘.

hbase.increasing.policy.initial.size
    default: none
    description: IncreasingToUpperBoundRegionSplitPolicy拆分策略下用于计算Region阈值的一个初始值
</code></pre></td></tr></table>
</div>
</div><h3 id=部分源码-1>部分源码</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>protected</span> <span class=kt>long</span> <span class=nf>getSizeToCheck</span><span class=o>(</span><span class=kd>final</span> <span class=kt>int</span> <span class=n>tableRegionsCount</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>return</span> <span class=n>tableRegionsCount</span> <span class=o>==</span> <span class=n>0</span> <span class=o>||</span> <span class=n>tableRegionsCount</span> <span class=o>&gt;</span> <span class=n>100</span>
               <span class=o>?</span> <span class=n>getDesiredMaxFileSize</span><span class=o>()</span>
               <span class=o>:</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>getDesiredMaxFileSize</span><span class=o>(),</span>
                          <span class=n>initialSize</span> <span class=o>*</span> <span class=n>tableRegionsCount</span> <span class=o>*</span> <span class=n>tableRegionsCount</span> <span class=o>*</span> <span class=n>tableRegionsCount</span><span class=o>);</span>

<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果表目前的Region个数为0或者大于100，那么Region拆分上限值是10G，因为getDesiredMaxFileSize()方法是父类ConstantSizeRegionSplitPolicy的方法，而我们上面分析过，上限大小默认是10G。</p>
<p>如果表目前的Region个数在[1,100]之间，那么使用以下公式来确定Region的上限大小:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Math.min(
    getDesiredMaxFileSize(), 
    initialSize * tableRegionsCount * tableRegionsCount * tableRegionsCount
)
</code></pre></td></tr></table>
</div>
</div><p>initialSize的计算过程如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>HREGION_MEMSTORE_FLUSH_SIZE</span> <span class=o>=</span> <span class=s>&#34;hbase.hregion.memstore.flush.size&#34;</span><span class=o>;</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>DEFAULT_MEMSTORE_FLUSH_SIZE</span> <span class=o>=</span> <span class=n>1024</span><span class=o>*</span><span class=n>1024</span><span class=o>*</span><span class=n>128L</span><span class=o>;</span>

<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>configureForRegion</span><span class=o>(</span><span class=n>HRegion</span> <span class=n>region</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>Configuration</span> <span class=n>conf</span> <span class=o>=</span> <span class=n>getConf</span><span class=o>();</span>
    <span class=c1>// 如果配置了&#39;hbase.increasing.policy.initial.size&#39;, 取这个值
</span><span class=c1></span>    <span class=n>initialSize</span> <span class=o>=</span> <span class=n>conf</span><span class=o>.</span><span class=na>getLong</span><span class=o>(</span><span class=s>&#34;hbase.increasing.policy.initial.size&#34;</span><span class=o>,</span> <span class=o>-</span><span class=n>1</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>initialSize</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>return</span><span class=o>;</span>
    <span class=o>}</span>
    <span class=c1>// 如果设置了MemStoreFlushSize, initialSize的值为该值 * 2
</span><span class=c1></span>    <span class=n>HTableDescriptor</span> <span class=n>desc</span> <span class=o>=</span> <span class=n>region</span><span class=o>.</span><span class=na>getTableDesc</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>desc</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>initialSize</span> <span class=o>=</span> <span class=n>2</span> <span class=o>*</span> <span class=n>desc</span><span class=o>.</span><span class=na>getMemStoreFlushSize</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=c1>// 如果用户没有设置MemStoreFlushSize,配置文件中也没有&#39;hbase.increasing.policy.initial.size&#39;这个配置
</span><span class=c1></span>    <span class=c1>// 那么initialSize = 2 * hbase.hregion.memstore.flush.size的值
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>initialSize</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>initialSize</span> <span class=o>=</span> <span class=n>2</span> <span class=o>*</span> <span class=n>conf</span><span class=o>.</span><span class=na>getLong</span><span class=o>(</span><span class=n>HConstants</span><span class=o>.</span><span class=na>HREGION_MEMSTORE_FLUSH_SIZE</span><span class=o>,</span>
                                     <span class=n>HTableDescriptor</span><span class=o>.</span><span class=na>DEFAULT_MEMSTORE_FLUSH_SIZE</span><span class=o>);</span>
    <span class=o>}</span>
  <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>根据以上内容我们可以得知，在默认情况，即我们什么都没有配置的情况下，使用IncreasingToUpperBoundRegionSplitPolicy策略拆分Region的过程是:</p>
<ul>
<li>某张表刚开始只有一个Region, 此时</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>tableRegionsCount = 1
initialSize = 2 * 128M = 256M
getDesiredMaxFileSize() = 10G
min(getDesiredMaxFileSize(), initialSize * tableRegionsCount * tableRegionsCount * tableRegionsCount) = min(10G, 256M) = 256M
</code></pre></td></tr></table>
</div>
</div><p>即当第一个Region达到256M的时候开始拆分</p>
<ul>
<li>拆分后这张表有两个Region</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>tableRegionsCount = 2
initialSize = 2 * 128M = 256M
getDesiredMaxFileSize() = 10G
min(getDesiredMaxFileSize(), initialSize * tableRegionsCount * tableRegionsCount * tableRegionsCount) 
= min(10G, 2 * 2 * 2 * 256M) 
= min(10G, 2G)
= 2G
</code></pre></td></tr></table>
</div>
</div><p>即当Region大小达到2GB时开始拆分</p>
<ul>
<li>以此类推，当表有3个Region的时候，Region的最大容量为6.75G</li>
<li>当表有4个Region的时候，计算出来的结果大于10GB，所以使用10GB作为以后的拆分上限</li>
</ul>
<p>总结一下就是，使用IncreasingToUpperBoundRegionSplitPolicy策略，Region最大容量为:
<code>256M -> 2GB -> 6.75GB -> 10GB -> 10GB -> ...</code></p>
<h3 id=设置方法-1>设置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=s>&#34;tableName&#34;</span><span class=o>));</span>

<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.IncreasingToUpperBoundRegionSplitPolicy&#34;</span><span class=o>);</span>
<span class=c1>// 以下配置根据需要配置或者不配置
</span><span class=c1></span><span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;hbase.increasing.policy.initial.size&#34;</span><span class=o>,</span> <span class=s>&#34;1048576000&#34;</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setMaxFileSize</span><span class=o>(</span><span class=n>1048576000</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setMemStoreFlushSize</span><span class=o>(</span><span class=n>1048576000</span><span class=o>);</span>

<span class=n>tableDesc</span><span class=o>.</span><span class=na>addFamily</span><span class=o>(...)</span>
<span class=n>admin</span><span class=o>.</span><span class=na>createTable</span><span class=o>(</span><span class=n>tableDesc</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=拆分效果-1>拆分效果</h3>
<p>均匀拆分</p>
<h2 id=3-keyprefixregionsplitpolicy>3. KeyPrefixRegionSplitPolicy</h2>
<h3 id=策略描述-2>策略描述</h3>
<p>除了简单粗暴地根据大小来拆分，我们还可以自己定义拆分点。KeyPrefixRegionSplitPolicy是IncreasingToUpperBoundRegionSplitPolicy的子类，在前者的基础上增加了对拆分点(splitPoint，拆分点就是Region被拆分处的rowkey)的定义。它保证了有相同前缀的rowkey不会被拆分到两个不同的Region里面。</p>
<h3 id=相关配置-1>相关配置</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>KeyPrefixRegionSplitPolicy.prefix_length

### 注意，有的博客中这个配置是

`prefix_split_key_policy.prefix_length

# 这个配置在HBase-1.2.x版本中已经标志为 Deprecated
</code></pre></td></tr></table>
</div>
</div><p>以上参数指定了在rowkey中，取前几个字符作为前缀，例如这个设置这个值为5，那么在rowkey中，如果前5个字符是相同的，拆分后也一定会在一个Region中。</p>
<p><strong>拆分效果</strong></p>
<ul>
<li>普通的拆分</li>
</ul>
<p><img src=/Users/zhuzhengyi/Documents/gitnote/img/2020-04-02-17-45-44-image.png alt></p>
<ul>
<li>按照Rowkey前缀拆分</li>
</ul>
<p><img src=/Users/zhuzhengyi/Documents/gitnote/img/2020-04-02-17-46-10-image.png alt></p>
<h3 id=设置方法-2>设置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>tableNameStr</span><span class=o>));</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.KeyPrefixRegionSplitPolicy&#34;</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;KeyPrefixRegionSplitPolicy.prefix_length&#34;</span><span class=o>,</span> <span class=s>&#34;5&#34;</span><span class=o>);</span>

<span class=c1>// 以下配置根据需要配置或者不配置
</span><span class=c1></span><span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;hbase.increasing.policy.initial.size&#34;</span><span class=o>,</span> <span class=s>&#34;1048576000&#34;</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setMaxFileSize</span><span class=o>(</span><span class=n>1048576000</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setMemStoreFlushSize</span><span class=o>(</span><span class=n>1048576000</span><span class=o>);</span>

<span class=n>tableDesc</span><span class=o>.</span><span class=na>addFamily</span><span class=o>(...)</span>
<span class=n>admin</span><span class=o>.</span><span class=na>createTable</span><span class=o>(</span><span class=n>tableDesc</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>说明</strong></p>
<p>KeyPrefixRegionSplitPolicy是IncreasingToUpperBoundRegionSplitPolicy类的子类，就是按照rowkey的前缀去拆分Region，但是什么时候拆分，原Region容量的最大值是多少还是需要使用IncreasingToUpperBoundRegionSplitPolicy的方法去计算。SteppingSplitPolicy、DelimitedKeyPrefixRegionSplitPolicy、BusyRegionSplitPolicy (HBase-2.x Only)，他们获取Region的拆分阈值的方式都是继承自IncreasingToUpperBoundRegionSplitPolicy。</p>
<h3 id=适用场景>适用场景</h3>
<p>如果你的所有数据都只有一两个前缀，那么采用默认的策略较好。
如果你的前缀划分的比较细，你的查询就比较容易发生跨Region查询的情况，此时采用KeyPrefixRegionSplitPolicy较好。
所以这个策略适用的场景是：</p>
<ul>
<li>数据有多种前缀。</li>
<li>查询多是针对前缀，较少跨越多个前缀来查询数据。</li>
</ul>
<h2 id=4-delimitedkeyprefixregionsplitpolicy>4. DelimitedKeyPrefixRegionSplitPolicy</h2>
<h3 id=拆分策略>拆分策略</h3>
<p>该策略也是继承自IncreasingToUpperBoundRegionSplitPolicy，它也是根据你的rowkey前缀来进行拆分的。唯一的不同就是：KeyPrefixRegionSplitPolicy是根据rowkey的固定前几位字符来进行判断，而DelimitedKeyPrefixRegionSplitPolicy是根据分隔符来判断的。</p>
<p>在有些系统中rowkey的前缀可能不一定都是定长的，比如你拿服务器的名字来当前缀，有的服务器叫host12有的叫host1。这些场景下严格地要求所有前缀都定长可能比较难，而且这个定长如果未来想改也不容易。DelimitedKeyPrefixRegionSplitPolicy就给了你一个定义长度字符前缀的自由。</p>
<h3 id=相关配置-2>相关配置</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>DelimitedKeyPrefixRegionSplitPolicy.delimiter
</code></pre></td></tr></table>
</div>
</div><p>使用该参数定义的分隔符分隔rowkey，分隔后的前部分相同的rowkey拆分后一定会在一个Region中。</p>
<h3 id=配置方法>配置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>tableNameStr</span><span class=o>));</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.DelimitedKeyPrefixRegionSplitPolicy&#34;</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;DelimitedKeyPrefixRegionSplitPolicy.delimiter&#34;</span><span class=o>,</span> <span class=s>&#34;_&#34;</span><span class=o>);</span>
<span class=o>...</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=拆分效果-2>拆分效果</h3>
<p><img src=/Users/zhuzhengyi/Documents/gitnote/img/2020-04-02-17-47-18-image.png alt></p>
<h2 id=5-steppingsplitpolicy>5. SteppingSplitPolicy</h2>
<h3 id=策略描述-3>策略描述</h3>
<p>这种策略和<code>IncreasingToUpperBoundRegionSplitPolicy</code>策略很相似，但更简单，第一个Region容量的上限为256M，之后都是10G，这个策略考虑到<code>IncreasingToUpperBoundRegionSplitPolicy</code>会多拆分几个Region(256M -> 2G -> 6.75G -> 10G)，所以进行了简化，它的源码只有一个方法，其他都是继承自<code>IncreasingToUpperBoundRegionSplitPolicy</code>类</p>
<h3 id=源码>源码</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>protected</span> <span class=kt>long</span> <span class=nf>getSizeToCheck</span><span class=o>(</span><span class=kd>final</span> <span class=kt>int</span> <span class=n>tableRegionsCount</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>return</span> <span class=n>tableRegionsCount</span> <span class=o>==</span> <span class=n>1</span>  <span class=o>?</span> <span class=k>this</span><span class=o>.</span><span class=na>initialSize</span> <span class=o>:</span> <span class=n>getDesiredMaxFileSize</span><span class=o>();</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=设置方法-3>设置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>tableNameStr</span><span class=o>));</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.SteppingSplitPolicy&#34;</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=6-busyregionsplitpolicy-hbase-2x-only>6. BusyRegionSplitPolicy (HBase-2.x Only)</h2>
<h3 id=策略描述-4>策略描述</h3>
<p>此前的拆分策略都没有考虑热点问题。所谓热点问题就是数据库中的Region被访问的频率并不一样，某些Region在短时间内被访问的很频繁，承载了很大的压力，这些Region就是热点Region。</p>
<h3 id=相关配置-3>相关配置</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>hbase.busy.policy.blockedRequests
    default: 0.2f
    description: 请求阻塞率，即请求被阻塞的严重程度。
    取值范围是[0.0, 1.0]，默认是0.2，即20%的请求被阻塞的意思。

hbase.busy.policy.minAge
  default: 600000 (10min)
  description: 拆分最小年龄。

当Region的年龄比这个小的时候不拆分，这是为了防止在判断是否要拆分的时候出现了短时间的访问频率波峰，结果没必要拆分的Region被拆分了，因为短时间的波峰会很快地降回到正常水平。单位毫秒，默认值是600000，即10分钟。

hbase.busy.policy.aggWindow
  default: 300000 (5min)
  description: 计算是否繁忙的时间窗口，单位毫秒，默认值是300000，即5分钟。
用以控制计算的频率。
</code></pre></td></tr></table>
</div>
</div><p><strong>如何确定为热点Region(Busy Region)</strong></p>
<p>如果"当前时间 – 上次检测时间" >= hbase.busy.policy.aggWindow，则进行如下计算：</p>
<p>请求的被阻塞率(aggBlockedRate) = 这段时间被阻塞的请求 / 这段时间的总请求</p>
<p>如果 aggBlockedRate > hbase.busy.policy.blockedRequests 且该Region的 hbase.busy.policy.minAge > 10min，则判断该Region为Busy Region</p>
<p>当Region被判定为Busy Region，就会被拆分。</p>
<h3 id=设置方法-4>设置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>tableNameStr</span><span class=o>));</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.BusyRegionSplitPolicy&#34;</span><span class=o>);</span>

<span class=c1>// 以下配置根据需要适当修改
</span><span class=c1></span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;hbase.busy.policy.blockedRequests&#34;</span><span class=o>,</span> <span class=s>&#34;0.2&#34;</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;hbase.busy.policy.minAge&#34;</span><span class=o>,</span> <span class=s>&#34;600000&#34;</span><span class=o>);</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;hbase.busy.policy.aggWindow&#34;</span><span class=o>,</span> <span class=s>&#34;300000&#34;</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=适用场景-1>适用场景</h3>
<p>如果你的系统常常会出现热点Region，而你对性能有很高的追求，那么这种策略可能会比较适合你。它会通过拆分热点Region来缓解热点Region的压力，但是根据热点来拆分Region也会带来很多不确定性因素，因为你也不知道下一个被拆分的Region是哪个。</p>
<h2 id=7-disabledregionsplitpolicy>7. DisabledRegionSplitPolicy</h2>
<h3 id=策略描述-5>策略描述</h3>
<p>禁止Region拆分，这个策略是极少使用的，因为就算是你按照自己数据的特性在建表的时候合理的进行了预拆分（即还没有写入的数据的时候就已经手动分好了Region），但是后续随着数据的持续写入，我们自己预先分好的Region的大小也一定会达到阈值，那时候还是要依靠HBase的自动拆分策略去拆分Region。</p>
<p>当然，这种策略也有它的用途：</p>
<p>假如我们有一批数据，根据它的用途我们知道它分为几个Region或者在什么时候拆分最合适，例如有一批数据，rowkey是手机号，而且每个手机号码前缀下（手机号码前三位）的数据量都差不多，而且这批数据主要是用于查询，要求查询的性能好一些，而且这批数据是一批静态数据，即一次存入后以后不会再加入新数据，而且这批数据的量很大，那么此时预先设置好拆分点（比如每个相同的手机号前缀一定要分到一个Region下），设置拆分策略为禁止拆分，然后导入数据即可。</p>
<p>在使用禁止自动拆分策略的诸多条件中，数据量大是很重要的一点，因为当使用自动拆分时，无论你设置了哪种拆分策略，一开始数据进入HBase的时候都只会往一个Region塞数据。必须要等到一个Region的大小膨胀到某个阀值的时候才会根据拆分策略来进行拆分。但是当大量的数据涌入的时候，可能会出现一边拆分一边写入大量数据的情况，由于拆分要占用大量IO，此时HBase数据库的压力是很大的。</p>
<h3 id=设置方法-5>设置方法</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>tableDesc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=n>TableName</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>tableNameStr</span><span class=o>));</span>
<span class=n>tableDesc</span><span class=o>.</span><span class=na>setRegionSplitPolicyClassName</span><span class=o>(</span><span class=s>&#34;org.apache.hadoop.hbase.regionserver.DisabledRegionSplitPolicy&#34;</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2021-10-10 12:59:52
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/architech/>architech</a>
<a href=https://justice.bj.cn/tags/hbase/>hbase</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/30.architech/hbase/hbase-memstore%E5%88%86%E6%9E%90/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">HBase MemStore 分析</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/hbase/hbase-rpc/>
<span class="next-text nav-default">HBase RPC</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
</body>
</html>