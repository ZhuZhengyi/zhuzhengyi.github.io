<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>HBase协处理器 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="HBase协处理器 简介 HBase 的协处理器是从 0.92.0 开始引入的，参见 HBASE-2000。它的实现灵感来源于 Jeff Dean 在 LADIS 2009 分享主题 《Designs, Lessons and Advice fromBuilding">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/30.architech/hbase/hbase-%E5%8D%8F%E5%A4%84%E7%90%86%E5%99%A8/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="HBase协处理器">
<meta property="og:description" content="HBase协处理器 简介 HBase 的协处理器是从 0.92.0 开始引入的，参见 HBASE-2000。它的实现灵感来源于 Jeff Dean 在 LADIS 2009 分享主题 《Designs, Lessons and Advice fromBuilding">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/30.architech/hbase/hbase-%E5%8D%8F%E5%A4%84%E7%90%86%E5%99%A8/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-10-10T00:00:00+00:00">
<meta property="article:modified_time" content="2021-10-10T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="HBase协处理器">
<meta itemprop=description content="HBase协处理器 简介 HBase 的协处理器是从 0.92.0 开始引入的，参见 HBASE-2000。它的实现灵感来源于 Jeff Dean 在 LADIS 2009 分享主题 《Designs, Lessons and Advice fromBuilding"><meta itemprop=datePublished content="2021-10-10T00:00:00+00:00">
<meta itemprop=dateModified content="2021-10-10T00:00:00+00:00">
<meta itemprop=wordCount content="3532">
<meta itemprop=keywords content="architech,hbase,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="HBase协处理器">
<meta name=twitter:description content="HBase协处理器 简介 HBase 的协处理器是从 0.92.0 开始引入的，参见 HBASE-2000。它的实现灵感来源于 Jeff Dean 在 LADIS 2009 分享主题 《Designs, Lessons and Advice fromBuilding"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>HBase协处理器</h1>
<div class=post-meta>
<time datetime=2021-10-10 class=post-time>
2021-10-10
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/architech/> architech </a>
<a href=https://justice.bj.cn/categories/hbase/> hbase </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#协处理器支持的扩展>协处理器支持的扩展</a>
<ul>
<li><a href=#observer>Observer</a></li>
<li><a href=#endpoint>Endpoint</a></li>
</ul>
</li>
<li><a href=#协处理器编写和配置>协处理器编写和配置</a></li>
<li><a href=#协处理器部署>协处理器部署</a>
<ul>
<li><a href=#通过-hbase-shell-配置>通过 HBase Shell 配置</a></li>
<li><a href=#通过-hbase-api-配置>通过 HBase API 配置</a></li>
<li><a href=#如何判断协处理器设置生效>如何判断协处理器设置生效</a></li>
</ul>
</li>
<li><a href=#使用协处理器>使用协处理器</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=hbase协处理器>HBase协处理器</h1>
<h2 id=简介>简介</h2>
<p>HBase 的协处理器是从 0.92.0 开始引入的，参见 <a href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9IQkFTRS0yMDAw&article=true">HBASE-2000</a>。它的实现灵感来源于 Jeff Dean 在 LADIS 2009 分享主题 <a href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly96aC5zY3JpYmQuY29tL2RvYy8yMTYzMTQ0OC9EZWFuLUtleW5vdGUtTGFkaXMyMDA5&article=true">《Designs, Lessons and Advice fromBuilding LargeDistributed Systems》</a>中关于 Google 的 BigTable 协处理器的分享。当时的 BigTable 协处理器具有以下功能：</p>
<ul>
<li>每个表服务器的任意子表都可以运行代码；</li>
<li>客户端的高层调用接口；</li>
<li>跨多行的调用会自动拆分为多个并行化的 RPC 请求；</li>
<li>通过协处理器可以非常灵活的构建分布式服务模型，能够自动化扩展、负载均衡、应用请求路由等。</li>
</ul>
<p>HBase 当然也想要一个这么好的功能，因为通过这个功能我们可以实现二级索引（secondary indexing）、复杂过滤（complex filtering） 比如谓词下推（push down predicates）以及访问控制等功能。虽然 HBase 协处理器受 BigTable 协处理器的启发，但在实现细节方面存在差异。HBase 为我们建立了一个框架，并提供类库和运行时环境，使得我们可以在 HBase RegionServer 和 Master 上运行用户自定义代码；而 Google 的 BigTable 却不是这样的。</p>
<h2 id=协处理器支持的扩展>协处理器支持的扩展</h2>
<p>协处理器框架已经为我们提供了一些实现类，我们可以通过继承这些类来扩展自己的功能。这些类主要分为两大类，即 Observer 和 Endpoint。</p>
<h3 id=observer>Observer</h3>
<p>Observer 和 RDMBS 的触发器很类似，在一些特定的事件发生时被执行。这些事件包括用户产生的事件，也包括服务器内部产生的事件。 目前 HBase 内置实现的 Observer 主要有以下几个：</p>
<ul>
<li><strong>WALObserver</strong>：提供控制 WAL 的钩子函数；</li>
<li><strong>MasterObserver</strong>：可以被用作管理或 DDL 类型的操作，这些是集群级的事件；</li>
<li><strong>RegionObserver</strong>：用户可以用这种处理器处理数据修改事件，它们与表的 Region 联系紧密；</li>
<li><strong>BulkLoadObserver</strong>：进行 BulkLoad 的操作之前或之后会触发这个钩子函数；</li>
<li><strong>RegionServerObserver</strong> ：RegionServer 上发生的一些操作可以触发一些这个钩子函数，这个是 RegionServer 级别的事件；</li>
<li><strong>EndpointObserver</strong>：每当用户调用 Endpoint 之前或之后会触发这个钩子，主要提供了一些回调方法。</li>
</ul>
<h3 id=endpoint>Endpoint</h3>
<p>Endpoint 和 RDMBS 的存储过程很类似，用户提供一些自定义代码，并在 HBase 服务器端执行，结果通过 RPC 返回给客户。比较常见的场景包括聚合操作（求和、计数等）。有了 Endpoint ，我们就可以充分利用服务器的资源，进行一些计算，大大提升计算的效率和通讯的开销。</p>
<h2 id=协处理器编写和配置>协处理器编写和配置</h2>
<p>下面我将通过介绍一个计数的例子来介绍 HBase 协处理器的使用。我们知道，HBase 自带了一个 <code>count</code> 命令用于计算某张表的行数，但是这个命令是单线程执行，效率非常低。我们可以通过 Endpoint 来实现一个计数类，并利用集群的资源来计算，最终将结果返回到客户端，客户端这边通过对结果进行汇总得到最终的结果。其实，HBase 自带了一个名为 <code>RowCountEndpoint</code> 的例子，里面就实现了计数逻辑。注意本文基于 HBase 1.4.0 进行介绍的，HBase 2.x 的代码已经有些变化，但大部分结构都类似。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>org.apache.hadoop.hbase.coprocessor.example</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.List</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.Cell</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.CellUtil</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.Coprocessor</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.CoprocessorEnvironment</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.client.Scan</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.coprocessor.CoprocessorException</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.coprocessor.CoprocessorService</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.coprocessor.RegionCoprocessorEnvironment</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.coprocessor.example.generated.ExampleProtos</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.filter.FirstKeyOnlyFilter</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.protobuf.ResponseConverter</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.regionserver.InternalScanner</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.util.Bytes</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>com.google.protobuf.RpcCallback</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>com.google.protobuf.RpcController</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>com.google.protobuf.Service</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>RowCountEndpoint</span> <span class=kd>extends</span> <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>RowCountService</span>
    <span class=kd>implements</span> <span class=n>Coprocessor</span><span class=o>,</span> <span class=n>CoprocessorService</span> <span class=o>{</span>
  <span class=kd>private</span> <span class=n>RegionCoprocessorEnvironment</span> <span class=n>env</span><span class=o>;</span>

  <span class=kd>public</span> <span class=nf>RowCountEndpoint</span><span class=o>()</span> <span class=o>{</span>
  <span class=o>}</span>

  <span class=cm>/**
</span><span class=cm>   * Just returns a reference to this object, which implements the RowCounterService interface.
</span><span class=cm>   */</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>Service</span> <span class=nf>getService</span><span class=o>()</span> <span class=o>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
  <span class=o>}</span>

  <span class=cm>/**
</span><span class=cm>   * 返回表的行数
</span><span class=cm>   */</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>getRowCount</span><span class=o>(</span><span class=n>RpcController</span> <span class=n>controller</span><span class=o>,</span> <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountRequest</span> <span class=n>request</span><span class=o>,</span>
                          <span class=n>RpcCallback</span><span class=o>&lt;</span><span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountResponse</span><span class=o>&gt;</span> <span class=n>done</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>Scan</span> <span class=n>scan</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Scan</span><span class=o>();</span>
    <span class=n>scan</span><span class=o>.</span><span class=na>setFilter</span><span class=o>(</span><span class=k>new</span> <span class=n>FirstKeyOnlyFilter</span><span class=o>());</span>
    <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountResponse</span> <span class=n>response</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=n>InternalScanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=k>try</span> <span class=o>{</span>
      <span class=n>scanner</span> <span class=o>=</span> <span class=n>env</span><span class=o>.</span><span class=na>getRegion</span><span class=o>().</span><span class=na>getScanner</span><span class=o>(</span><span class=n>scan</span><span class=o>);</span>
      <span class=n>List</span><span class=o>&lt;</span><span class=n>Cell</span><span class=o>&gt;</span> <span class=n>results</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Cell</span><span class=o>&gt;();</span>
      <span class=kt>boolean</span> <span class=n>hasMore</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
      <span class=kt>byte</span><span class=o>[]</span> <span class=n>lastRow</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
      <span class=kt>long</span> <span class=n>count</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
      <span class=k>do</span> <span class=o>{</span>
        <span class=n>hasMore</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>next</span><span class=o>(</span><span class=n>results</span><span class=o>);</span>
        <span class=k>for</span> <span class=o>(</span><span class=n>Cell</span> <span class=n>kv</span> <span class=o>:</span> <span class=n>results</span><span class=o>)</span> <span class=o>{</span>
          <span class=kt>byte</span><span class=o>[]</span> <span class=n>currentRow</span> <span class=o>=</span> <span class=n>CellUtil</span><span class=o>.</span><span class=na>cloneRow</span><span class=o>(</span><span class=n>kv</span><span class=o>);</span>
          <span class=k>if</span> <span class=o>(</span><span class=n>lastRow</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>Bytes</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>lastRow</span><span class=o>,</span> <span class=n>currentRow</span><span class=o>))</span> <span class=o>{</span>
            <span class=n>lastRow</span> <span class=o>=</span> <span class=n>currentRow</span><span class=o>;</span>
            <span class=n>count</span><span class=o>++;</span>
          <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>results</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
      <span class=o>}</span> <span class=k>while</span> <span class=o>(</span><span class=n>hasMore</span><span class=o>);</span>

      <span class=n>response</span> <span class=o>=</span> <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountResponse</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
          <span class=o>.</span><span class=na>setCount</span><span class=o>(</span><span class=n>count</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>ResponseConverter</span><span class=o>.</span><span class=na>setControllerException</span><span class=o>(</span><span class=n>controller</span><span class=o>,</span> <span class=n>ioe</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>scanner</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>try</span> <span class=o>{</span>
          <span class=n>scanner</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{}</span>
      <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>done</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
  <span class=o>}</span>

  <span class=cm>/**
</span><span class=cm>   * 返回表中 KV 的数量
</span><span class=cm>   */</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>getKeyValueCount</span><span class=o>(</span><span class=n>RpcController</span> <span class=n>controller</span><span class=o>,</span> <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountRequest</span> <span class=n>request</span><span class=o>,</span>
                               <span class=n>RpcCallback</span><span class=o>&lt;</span><span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountResponse</span><span class=o>&gt;</span> <span class=n>done</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountResponse</span> <span class=n>response</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=n>InternalScanner</span> <span class=n>scanner</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
    <span class=k>try</span> <span class=o>{</span>
      <span class=n>scanner</span> <span class=o>=</span> <span class=n>env</span><span class=o>.</span><span class=na>getRegion</span><span class=o>().</span><span class=na>getScanner</span><span class=o>(</span><span class=k>new</span> <span class=n>Scan</span><span class=o>());</span>
      <span class=n>List</span><span class=o>&lt;</span><span class=n>Cell</span><span class=o>&gt;</span> <span class=n>results</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Cell</span><span class=o>&gt;();</span>
      <span class=kt>boolean</span> <span class=n>hasMore</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
      <span class=kt>long</span> <span class=n>count</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
      <span class=k>do</span> <span class=o>{</span>
        <span class=n>hasMore</span> <span class=o>=</span> <span class=n>scanner</span><span class=o>.</span><span class=na>next</span><span class=o>(</span><span class=n>results</span><span class=o>);</span>
        <span class=k>for</span> <span class=o>(</span><span class=n>Cell</span> <span class=n>kv</span> <span class=o>:</span> <span class=n>results</span><span class=o>)</span> <span class=o>{</span>
          <span class=n>count</span><span class=o>++;</span>
        <span class=o>}</span>
        <span class=n>results</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
      <span class=o>}</span> <span class=k>while</span> <span class=o>(</span><span class=n>hasMore</span><span class=o>);</span>

      <span class=n>response</span> <span class=o>=</span> <span class=n>ExampleProtos</span><span class=o>.</span><span class=na>CountResponse</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>()</span>
          <span class=o>.</span><span class=na>setCount</span><span class=o>(</span><span class=n>count</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ioe</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>ResponseConverter</span><span class=o>.</span><span class=na>setControllerException</span><span class=o>(</span><span class=n>controller</span><span class=o>,</span> <span class=n>ioe</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>scanner</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>try</span> <span class=o>{</span>
          <span class=n>scanner</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{}</span>
      <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>done</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>response</span><span class=o>);</span>
  <span class=o>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>start</span><span class=o>(</span><span class=n>CoprocessorEnvironment</span> <span class=n>env</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>env</span> <span class=k>instanceof</span> <span class=n>RegionCoprocessorEnvironment</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>this</span><span class=o>.</span><span class=na>env</span> <span class=o>=</span> <span class=o>(</span><span class=n>RegionCoprocessorEnvironment</span><span class=o>)</span><span class=n>env</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>CoprocessorException</span><span class=o>(</span><span class=s>&#34;Must be loaded on a table region!&#34;</span><span class=o>);</span>
    <span class=o>}</span>
  <span class=o>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>stop</span><span class=o>(</span><span class=n>CoprocessorEnvironment</span> <span class=n>env</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
    <span class=c1>// nothing to do
</span><span class=c1></span>  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于 HBase 内部使用 protobuf 协议进行通信，所以这个例子定义了名为 <code>Examples.proto</code> 的文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=kn>package</span> <span class=nn>hbase</span><span class=o>.</span><span class=n>pb</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>java_package</span> <span class=o>=</span> <span class=s>&#34;org.apache.hadoop.hbase.coprocessor.example.generated&#34;</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>java_outer_classname</span> <span class=o>=</span> <span class=s>&#34;ExampleProtos&#34;</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>java_generic_services</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>java_generate_equals_and_hash</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>optimize_for</span> <span class=o>=</span> <span class=n>SPEED</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>CountRequest</span> <span class=p>{</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>CountResponse</span> <span class=p>{</span><span class=err>
</span><span class=err></span>     <span class=k>required</span> <span class=kt>int64</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span> <span class=p>[</span><span class=k>default</span> <span class=o>=</span> <span class=mi>0</span><span class=p>];</span>   <span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>service</span> <span class=n>RowCountService</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=k>rpc</span> <span class=n>getRowCount</span><span class=p>(</span><span class=n>CountRequest</span><span class=p>)</span><span class=err>
</span><span class=err></span>        <span class=k>returns</span> <span class=p>(</span><span class=n>CountResponse</span><span class=p>);</span><span class=err>
</span><span class=err></span>    <span class=k>rpc</span> <span class=n>getKeyValueCount</span><span class=p>(</span><span class=n>CountRequest</span><span class=p>)</span><span class=err>
</span><span class=err></span>        <span class=k>returns</span> <span class=p>(</span><span class=n>CountResponse</span><span class=p>);</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></td></tr></table>
</div>
</div><p>由于 RowCountEndpoint 类是 HBase 自带的例子，所以在我们的 HBase 类路径下已经加载了这个类，在实际的应用中，我们需要将 Examples.proto 文件生成对应的类，并将相关的类进行编译打包（具体如何编译可以参见 《在 IDEA 中使用 Maven 编译 proto 文件》）。因为这个类 HBase 其实已经编译好了，所以我就不再进行介绍了，直接讲如何部署。</p>
<h2 id=协处理器部署>协处理器部署</h2>
<p>协处理器的部署有很多种方法，这里我将一一进行介绍。</p>
<p>通过 hbase-site.xml 文件进行配置</p>
<p>我们可以直接在 hbase-site.xml 文件里面进行配置，配置完之后需要重启 HBase 集群，而且这个配置是全局影响的。如下设置：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;property&gt;</span>
    <span class=nt>&lt;name&gt;</span>hbase.coprocessor.region.classes<span class=nt>&lt;/name&gt;</span>
    <span class=nt>&lt;value&gt;</span>org.apache.hadoop.hbase.coprocessor.RowCountEndpoint<span class=nt>&lt;/value&gt;</span>
<span class=nt>&lt;/property&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>因为 RowCountEndpoint 这个类是 HBase 自带的，如果是我们自定义的 Endpoint，我们需要将打包好的 jar 包放到所有节点的 $HBASE_HOME/lib/ 路径下。</p>
<h3 id=通过-hbase-shell-配置>通过 HBase Shell 配置</h3>
<p>如果我们只想对某一张表设置 Endpoint，那么可以直接在 HBase Shell 中进行配置，如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>hbase(main): &gt; alter &#39;iteblog&#39;, &#39;coprocessor&#39; =&gt; &#39;|org.apache.hadoop.hbase.coprocessor.example.RowCountEndpoint ||&#39;
</code></pre></td></tr></table>
</div>
</div><p>说明：上面的 coprocessor 设置的值为 &lsquo;|org.apache.hadoop.hbase.coprocessor.example.RowCountEndpoint ||'，它的值主要由四部分组成。&lsquo;coprocessor&rsquo; => &lsquo;Jar File Path|Class Name|Priority|Arguments&rsquo;。其中</p>
<ul>
<li>
<p><code>Jar File Path</code>：协处理器实现类所在 Jar 包的路径，这个路径要求所有的 RegionServer 能够读取得到。比如放在所有 RegionServer 的本地磁盘；比较推荐的做法是将文件放到 HDFS 上。如果没有设置这个值，那么将直接从 HBase 服务的 classpath 中读取。</p>
</li>
<li>
<p>Class Name：协处理器实现类的类名称，包括包名。</p>
</li>
<li>
<p>Priority：协处理器的优先级，是一个整数。如果同一个钩子函数有多个协处理器实现，那么将按照优先级执行。如果没有指定，将按照默认优先级执行。</p>
</li>
<li>
<p>Arguments：传递给协处理器实现类的参数列表，可以不指定。</p>
</li>
</ul>
<p>这四个部分使用 | 符号进行分割。</p>
<h3 id=通过-hbase-api-配置>通过 HBase API 配置</h3>
<p>除了可以通过 HBase Shell 和 hbase-site.xml 配置文件来加载协处理器，还可以通过 Client API 来加载协处理器。具体的方法是调用 HTableDescriptor 的 addCoprocessor 方法。该方法有两种调用形式：</p>
<ul>
<li>
<p>addCoprocessor(String className)：传入类名。该方法类似通过配置来加载协处理器，用户需要先把jar包分发到各个 RegionServer 的 $HBASE_HOME/lib 目录下。</p>
</li>
<li>
<p>addCoprocessor(String className, Path jarFilePath, int priority, final Map kvs)：该方法类似通过 Shell 来加载协处理器。通过调用该方法可以同时传入协处理器的 className 以及 jar 所在的路径，priority 是协处理器的执行优先级，kvs 是给协处理器预定义的参数。</p>
</li>
</ul>
<p>使用如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>HTableDescriptor</span> <span class=n>htd</span><span class=o>=</span><span class=k>new</span> <span class=n>HTableDescriptor</span><span class=o>(</span><span class=s>&#34;testTable&#34;</span><span class=o>);</span>
<span class=n>htd</span><span class=o>.</span><span class=na>setValue</span><span class=o>(</span><span class=s>&#34;CORPROCESSOR$1&#34;</span> <span class=o>,</span> 
<span class=n>path</span><span class=o>.</span><span class=na>toString</span><span class=o>+</span><span class=s>&#34;|&#34;</span><span class=o>+</span><span class=n>RowCountEndpoint</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getCanonicalName</span><span class=o>()+</span><span class=s>&#34;|&#34;</span><span class=o>+</span><span class=n>Coprocessor</span><span class=o>.</span><span class=na>Priority</span><span class=o>.</span><span class=na>USER</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=如何判断协处理器设置生效>如何判断协处理器设置生效</h3>
<p>可以通过 HBase Shell 提供的 describe 命令查看的</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>
</code></pre></td></tr></table>
</div>
</div><h2 id=使用协处理器>使用协处理器</h2>
<p>通过上面几步，我们已经为表设置好了协处理器，现在我们可以编写客户端程序来调用这个协处理器，主要通过 HTable 的 coprocessorService 方法实现，这个方法主要由三种实现：</p>
<ul>
<li>
<p>coprocessorService(byte[] row)：这个通过 row 来定位对应的 Region，然后在这个 Region 上运行相关的协处理器代码。</p>
</li>
<li>
<p>coprocessorService(final Class<t> service, byte[] startKey, byte[] endKey, final Batch.Call&lt;T,R> callable)：service 指定是调用哪个协处理器实现类，因为一个 Region 上可以部署多个协处理器，客户端必须通过指定 Service 类来区分究竟需要调用哪个协处理器提供的服务。startKey 和 endKey 主要用于确定需要与那些 Region 进行交互。callable 定义了如何调用协处理器，用户通过重载该接口的 call() 方法来实现客户端的逻辑。在 call() 方法内，可以调用 RPC，并对返回值进行任意处理。</p>
</li>
<li>
<p>coprocessorService(final Class<t> service, byte[] startKey, byte[] endKey, final Batch.Call&lt;T,R> callable, final Batch.Callback<r> callback)：这个方法和第二个比较多了一个 callback，coprocessorService 会为每一个 RPC 返回结果调用该 callback，用户可以在 callback 中执行需要的逻辑，比如执行 sum 累加。第二个方法，每个 Region 协处理器 RPC 的返回结果先放入一个列表，所有的 Region 都返回后，用户代码再从该列表中取出每一个结果进行累加；用这种方法，直接在 callback 中进行累加，省掉了创建结果集合和遍历该集合的开销，效率会更高一些。</p>
</li>
</ul>
<p>这里我们调用第二种方法，具体的代码如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java>
</code></pre></td></tr></table>
</div>
</div><p>运行这段代码，就可以快速算出 iteblog 表的总行数。如果我们把 counter.getRowCount(controller, request, rpcCallback); 修改成 counter.getKeyValueCount(controller, request, rpcCallback);，那么将会返回 iteblog 表 KV 的总数。上面查询运行的流程可以用下面的图来表示</p>
<p><img src=assets/2020-04-03-12-59-01-image.png alt></p>
<p>图中 Client A 的过程就是上面程序的处理流程，主要是并行 RPC 请求。从图中可以看到，这个表的所有 Region 都会参与计算，每个 Region 计算出自己的总数，然后返回给客户端，所有的 Region 结果最后存储在 Map results 中，其中 Key 是每个 Region 的名字，Value 就是这个 Region 计算到的行数。我们只需要遍历这个 Map，然后将所有 Region 计算的行数加起来就是整个表的行数。</p>
<p>如果我们仅仅想计算某个 row 对应的 Region 的行数，可以实现如下：</p>
<p>上面代码可以返回 row-890 所在 Region 的行数，由于这个 Row 只对应于一个 Region，所以上面代码的运行流程见上图的 Client B 运行过程。可以看出，这个程序仅仅发出一个 RPC 请求。</p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p><a href=https://blog.csdn.net/scgaliguodong123_/article/details/46714201>HBase协处理器及实例_大数据_吃果冻不吐果冻皮-CSDN博客</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/wangmin1983/article/details/83507353>实际动手编写HBase Coprocessor_大数据_功夫熊猫-CSDN博客</a></p>
</li>
<li>
<p><a href=https://cloud.tencent.com/developer/article/1158195>https://cloud.tencent.com/developer/article/1158195</a></p>
</li>
<li></li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2021-10-10
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/architech/>architech</a>
<a href=https://justice.bj.cn/tags/hbase/>hbase</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/30.architech/hbase/hbase%E6%BA%90%E7%A0%81/hbase%E5%86%99%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">hbase写流程</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/hbase/hbase%E6%BA%90%E7%A0%81/hbase%E8%AF%BB%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/>
<span class="next-text nav-default">HBase读流程解析</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/L2Dwidget.min.js></script>
<script src=/js/L2Dwidget.0.min.js></script>
<script src=/js/l2d.js></script>
</body>
</html>