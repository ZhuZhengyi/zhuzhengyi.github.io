<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>HBase - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="HBase 简介 Apache HBase是基于Hadoop构建的一个分布式、可伸缩的海量数据存储系统。HDFS为Hbase提供底层数据存储服务，Zookeeper">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/30.architech/hbase/hbase%E5%9F%BA%E7%A1%80/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="HBase">
<meta property="og:description" content="HBase 简介 Apache HBase是基于Hadoop构建的一个分布式、可伸缩的海量数据存储系统。HDFS为Hbase提供底层数据存储服务，Zookeeper">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/30.architech/hbase/hbase%E5%9F%BA%E7%A1%80/"><meta property="article:section" content="post">
<meta property="article:modified_time" content="2020-12-25T10:57:29+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="HBase">
<meta itemprop=description content="HBase 简介 Apache HBase是基于Hadoop构建的一个分布式、可伸缩的海量数据存储系统。HDFS为Hbase提供底层数据存储服务，Zookeeper">
<meta itemprop=dateModified content="2020-12-25T10:57:29+08:00">
<meta itemprop=wordCount content="5144">
<meta itemprop=keywords content="architech,hbase,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="HBase">
<meta name=twitter:description content="HBase 简介 Apache HBase是基于Hadoop构建的一个分布式、可伸缩的海量数据存储系统。HDFS为Hbase提供底层数据存储服务，Zookeeper"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>HBase</h1>
<div class=post-meta>
<time datetime=2020-12-25 class=post-time>
2020-09-256 10:297:100
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/system/> system </a>
<a href=https://justice.bj.cn/categories/hbase/> hbase </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a>
<ul>
<li><a href=#特点><strong>特点</strong></a></li>
<li><a href=#对比><strong>对比</strong></a></li>
<li><a href=#应用场景>应用场景</a></li>
</ul>
</li>
<li><a href=#架构>架构</a></li>
<li><a href=#基本概念>基本概念</a>
<ul>
<li><a href=#基本操作>基本操作</a></li>
</ul>
</li>
<li><a href=#重要数据结构>重要数据结构</a>
<ul>
<li><a href=#hregionserver>HRegionServer</a></li>
<li><a href=#hregion>HRegion</a></li>
<li><a href=#memstore写缓存>MemStore（写缓存）</a></li>
<li><a href=#blockcache读缓存>BlockCache（读缓存）</a></li>
<li><a href=#hlogwal>HLog（WAL）</a></li>
<li><a href=#hfile>HFile</a></li>
</ul>
</li>
<li><a href=#关键流程>关键流程</a>
<ul>
<li><a href=#region定位>Region定位</a></li>
<li><a href=#写流程>写流程</a></li>
<li><a href=#storefile的合并compaction和拆分split>StoreFile的合并(Compaction)和拆分(Split)</a></li>
<li><a href=#读流程>读流程</a></li>
</ul>
</li>
<li><a href=#6-总结>6. 总结</a></li>
<li><a href=#参考>参考</a></li>
<li><a href=#注解>注解</a></li>
<li><a href=#参考-1>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=hbase>HBase</h1>
<h2 id=简介>简介</h2>
<p>Apache HBase是基于Hadoop构建的一个<strong>分布式</strong>、<strong>可伸缩</strong>的<strong>海量数据存储系统</strong>。HDFS为Hbase提供底层数据存储服务，Zookeeper为Hbase提供稳定服务和Failover机制，MapReduce为Hbase提供高性能的计算能力，是一个通过大量廉价的机器解决海量数据的高速存储和读取的分布式数据库解决方案。</p>
<h3 id=特点><strong>特点</strong></h3>
<ul>
<li><strong>海量存储</strong>：单表支持几十亿行，几百万列，数千个版本的数据，TB/PB级别；</li>
<li><strong>无模式</strong>：每行都有一个可排序的主键和任意多的列，列可以根据需要动态的增加，同一张表中不同的行可以有截然不同的列；</li>
<li><strong>列式存储</strong>：列族存储；</li>
<li><strong>易扩展</strong>：横向扩展(RegionServer)，提高并发能力；纵向扩展(hdfs)，提高存储容量</li>
<li><strong>高并发</strong>：在并发的情况下，Hbase的单个IO延迟下降并不多</li>
<li><strong>稀疏</strong>：空数据不占用存储空间。</li>
</ul>
<h3 id=对比><strong>对比</strong></h3>
<table>
<thead>
<tr>
<th style=text-align:left></th>
<th style=text-align:left>RDBMS</th>
<th style=text-align:left>HBase</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><strong>硬件架构</strong></td>
<td style=text-align:left>传统的多核系统，硬件成本昂贵</td>
<td style=text-align:left>分布式集群，硬件成本低廉</td>
</tr>
<tr>
<td style=text-align:left><strong>数据库大小</strong></td>
<td style=text-align:left>GB,TB</td>
<td style=text-align:left>PB</td>
</tr>
<tr>
<td style=text-align:left><strong>扩展性</strong></td>
<td style=text-align:left>横向扩展和纵向扩展较差</td>
<td style=text-align:left>很方便进行横向扩展和纵向扩展</td>
</tr>
<tr>
<td style=text-align:left><strong>容错性</strong></td>
<td style=text-align:left>一般需要额外硬件设备实现 HA 机制</td>
<td style=text-align:left>结合HDFS提供可靠的数据冗余，由于由多个节点组成，所以不担心一点或几点宕机</td>
</tr>
<tr>
<td style=text-align:left><strong>吞吐量</strong></td>
<td style=text-align:left>百万查询/每秒</td>
<td style=text-align:left>数千查询/每秒</td>
</tr>
<tr>
<td style=text-align:left><strong>数据保护</strong></td>
<td style=text-align:left>替换</td>
<td style=text-align:left>保留</td>
</tr>
<tr>
<td style=text-align:left><strong>存储模式</strong></td>
<td style=text-align:left>行存储，密集</td>
<td style=text-align:left>列族存储，稀疏</td>
</tr>
<tr>
<td style=text-align:left><strong>数据类型</strong></td>
<td style=text-align:left>丰富</td>
<td style=text-align:left>字节数组</td>
</tr>
<tr>
<td style=text-align:left><strong>事务支持</strong></td>
<td style=text-align:left>全面的ACID事务支持，表级</td>
<td style=text-align:left>行级</td>
</tr>
<tr>
<td style=text-align:left><strong>查询语言</strong></td>
<td style=text-align:left>SQL</td>
<td style=text-align:left>Java API</td>
</tr>
<tr>
<td style=text-align:left><strong>索引</strong></td>
<td style=text-align:left>灵活多个</td>
<td style=text-align:left>Row-Key</td>
</tr>
</tbody>
</table>
<h3 id=应用场景>应用场景</h3>
<p>Hbase是一个通过廉价PC机器集群来存储海量数据的分布式数据库解决方案。它比较适合的场景概括如下：</p>
<ul>
<li>
<p>巨量大（百T、PB级别）</p>
</li>
<li>
<p>查询简单（基于rowkey或者rowkey范围查询）</p>
</li>
<li>
<p>不涉及到复杂的关联</p>
</li>
</ul>
<p>典型应用场景：</p>
<ul>
<li>海量订单流水数据（长久保存） 交易记录 数据库历史数据；</li>
<li>交易记录；</li>
<li>日志、监控类数据；</li>
<li>对象存储：不少的头条类、新闻类的的新闻、网页、图片存储在HBase之中，一些病毒公司的病毒库也是存储在HBase之中；</li>
<li>时序数据：HBase之上有OpenTSDB模块，可以满足时序类场景的需求；</li>
<li>推荐画像：特别是用户的画像，是一个比较大的稀疏矩阵，蚂蚁的风控就是构建在HBase之上；</li>
<li>时空数据：主要是轨迹、气象网格之类，滴滴打车的轨迹数据主要存在HBase之中，另外在技术所有大一点的数据量的车联网企业，数据都是存在HBase之中；</li>
<li>CubeDB OLAP：Kylin一个cube分析工具，底层的数据就是存储在HBase之中，不少客户自己基于离线计算构建cube存储在hbase之中，满足在线报表查询的需求；</li>
<li>消息/订单：在电信领域、银行领域，不少的订单查询底层的存储，另外不少通信、消息同步的应用构建在HBase之上；</li>
<li>Feeds流：典型的应用就是xx朋友圈类似的应用；</li>
<li>NewSQL：之上有Phoenix的插件，可以满足二级索引、SQL的需求，对接传统数据需要SQL非事务的需求；</li>
</ul>
<h2 id=架构>架构</h2>
<p>架构图</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-15-1506395765370_9254_1506395767893-20180619102505360.png alt=img></p>
<ul>
<li><strong>Client</strong>：访问hbase的客户端，并提供缓存；</li>
<li><strong>Zookeeper</strong>：提供元数据查询、集群配置、状态监控及HA；</li>
<li><strong>HMaster</strong>：协调、监控RS集群状态，Region分配、负载均衡、提供DDL表操作功能；</li>
<li><strong>HRegionServer</strong>：管理HRegion，与底层FS交互，读写；</li>
<li><strong>HDFS</strong>: 数据文件存储；</li>
</ul>
<h2 id=基本概念>基本概念</h2>
<ul>
<li>
<p><strong>Table</strong>（表）：数据的逻辑视图；</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-22-SouthEast.png alt=img></p>
</li>
<li>
<p><strong>Row Key</strong>（行键）：表中每条记录的全局唯一主键，字节数组，字典排序，最大64K。尽量现在合适的Row Key 是数据相近的数据分布在同一个Region中，提高效率；</p>
</li>
<li>
<p><strong>Region</strong>（分区）：表会按Row Key拆分成一定大小的Key Range，每个“Key Range”称为一个Region；</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-29-image-20180619102331372.png alt=image-20180619102331372></p>
</li>
<li>
<p>列族（Column Family）：包含多个列数据，同一个CF的列数据存储在一个文件中，读取时可一次读取；建议1-3个CF；</p>
</li>
<li>
<p>时间戳（Timestamp）：时间戳用于区分数据的不同版本，最新的时间戳在最前面，通过时间戳简化了数据的更新和删除操作；</p>
</li>
<li>
<p>值（Key Value）：数据值</p>
</li>
</ul>
<h3 id=基本操作>基本操作</h3>
<ul>
<li>get：根据 (row_key, cf, name ) -> value</li>
<li>scan: 更加条件获取批量的数据；</li>
<li>put：插入更新；</li>
<li>delete：删除数据；</li>
</ul>
<h2 id=重要数据结构>重要数据结构</h2>
<h3 id=hregionserver>HRegionServer</h3>
<ul>
<li>每个RegionServer 包含一个 WAL（预写日志文件），一个BlockCache（读缓存），0到多个（默认最多1000）Region；</li>
<li>每个Region包含多个Store（对应CF的数量），每个Store包含1个MemStore（写缓存），0-多个HFile；</li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-35-regionserver.png alt=regionserver></p>
<h3 id=hregion>HRegion</h3>
<ul>
<li>HBase通过RowKey将表水平切割成多个HRegion，一个HRegion有一个startKey和endKey的row key，包含了从startKey到endKey范围内的所有的行（包含startKey，但不包含endKey）</li>
<li>每个Regions被HMaster分配到某个RegionServe上，这些RegionServer负责数据的读取和写入。一个RegionServer可以服务多个region。数量大概是1000个。</li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-41-Center.png alt=img></p>
<h3 id=memstore写缓存>MemStore（写缓存）</h3>
<ul>
<li>MemStore 用来缓存写数据的，写入数据的keyValues；</li>
<li>当memStore的大小达到一个阀值（默认128MB）时，memStore会被flush到文件HFile；</li>
</ul>
<h3 id=blockcache读缓存>BlockCache（读缓存）</h3>
<ul>
<li>BlockCache用来缓存读数据，每个RegionServer维持一个BlockCache；；</li>
<li>BlockCache由Block组成，Block默认大小64K；</li>
<li>默认BlockCache将Block分成3个优先队列：Single，Multi，InMemory，用于提高Cache效率。</li>
<li>BlockCache大小是固定的，可由参数hfile.block.cache.size，默认是RegionServer堆内存的40%；</li>
<li>BlockCache实现方案：<strong>LRUBlockCache</strong>，<strong>SlabCache</strong>，<strong>BucketCache</strong>；</li>
</ul>
<h3 id=hlogwal>HLog（WAL）</h3>
<ul>
<li>
<p>每一个RegionServer有一个WAL Log文件(1.0后可配置多个)；</p>
</li>
<li>
<p>WAL Log 文件为顺序写入，速度很快；</p>
</li>
<li>
<p>WAL Log 文件只append，不更改；</p>
</li>
<li>
<p>由于WAL 文件可由HDFS自动生成副本，发生故障时，可通过副本进行恢复；</p>
</li>
<li>
<p>MemStore 在内存中的数据失效后，可由WAL文件进行恢复；</p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-48-1506396165989_1943_1506396168304.png alt=img></p>
</li>
</ul>
<h3 id=hfile>HFile</h3>
<p>HFile是Hbase数据在磁盘上的存储文件，在HDFS上的存储目录结构为 <em>表名/region名/列族名/HFiles</em>，HFile存储了一个多级索引(multi-layered index), 通过多级索引就可以快速得到数据(工作机制类似于b+tree)</p>
<ul>
<li>Key-Value按照升序排列</li>
<li>Key-Value存储在以64KB为单位的Block里</li>
<li>每个Block有一个叶索引(leaf-index), 记录Block的位置</li>
<li>每个Block的最后一个Key(<em>译注: 最后一个key也是最大的key</em>), 放入中间索引(intermediate index)</li>
<li>根索引(root index)指向中间索引</li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-38-55-1356783866_3720.png alt=img></p>
<h2 id=关键流程>关键流程</h2>
<h3 id=region定位>Region定位</h3>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-39-01-1506396002537_2157_1506396004590.png alt=img></p>
<h3 id=写流程>写流程</h3>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-39-06-20150723174212472.png alt=img></p>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-39-13-1506396036453_6524_1506396038477.png alt=img></p>
<ol>
<li>
<p>client 向zk查询应该写入到哪个RS；</p>
</li>
<li>
<p>将数据append到RS的WAL中；</p>
</li>
<li>
<p>将数据写入到MemStore中，写操作返回；</p>
</li>
<li>
<p>MemStore达到一定条件<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，则把数据flush到HFile文件中。</p>
</li>
<li>
<p>当HFile文件数量达到一定阈值，会触发<strong>合并</strong>（compaction）操作；当单个HFile大小超过一定阈值后，会触发<strong>拆分</strong>（split）操作。</p>
</li>
</ol>
<h3 id=storefile的合并compaction和拆分split>StoreFile的合并(Compaction)和拆分(Split)</h3>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-39-18-20150723175721133.gif alt=img></p>
<p><strong>Compaction</strong>分为两种：</p>
<ol>
<li>
<p><strong>minor compaction</strong>：把多个小HFile合并成一个大HFile，主要是为了提高读效率（因为一个row可能散布在多个HFile文件中）。minor compaction不做任何删除数据、过期数据的清理工作。</p>
</li>
<li>
<p><strong>major compaction</strong>：把给定region的一个列族的所有HFile合并成一个文件，major compaction会丢弃有删除标记的或过期的内容，释放占用的空间。</p>
<p>minor合并是轻量级的，可以频繁发生；major合并相当耗资源，不要经常使用，且通常需要手工触发。</p>
</li>
</ol>
<p><strong>Split</strong>操作过程完成的非常快，因为原始的数据文件并不会被改变，系统只是简单的创建两个Reference文件指向原始的数据文件，每个Reference文件管理原始文件一半的数据。Reference文件名字是一个ID，它使用被参考的region的名字的hash作为前缀，例如：1278437856009925445.3323223323。Reference文件只含有非常少量的信息，这些信息包括被分割的原始region的key以及这个文件管理前半段还是后半段。只有当系统做compaction的时候原始数据文件才会被分割成两个独立的文件并放到相应的region目录下面，同时原始数据文件和那些Reference文件也会被清除。</p>
<h3 id=读流程>读流程</h3>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-39-24-firstread.png alt=firstread></p>
<ol>
<li>Client先从Zookeeper中获取托管META表的RegionServer。</li>
<li>Client查询.META.服务，来获取需要访问的RowKey对应的Region Server。Client将这些信息与META表位置一起缓存起来。</li>
<li>Client从相应的Region Server获取该行的数据。</li>
<li>之后的查询都是从 client 缓存读取 meta 信息从对应的 region server 查询；(如果缓存中查询不到对应的数据那么将从第一步重新开始)</li>
</ol>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-20-39-30-readamplification.png alt=img></p>
<p>具体从RegionServer中读数据的过程</p>
<ol>
<li>先从BlockCache（<strong>读缓存</strong>）中找对应的 row；</li>
<li>如果缓存里找不到，那就去查询 MemStore（<strong>写缓存</strong>）找对应的最近的写数据；</li>
<li>如果两个地方都没用，那么就会根据 BlockCache 中的 B+ Tree Index（mentioned above）以及 Bloom Filter找 HFile 里的数据；</li>
<li>两个缓存无法命中且大量 HFile 未合并的时候，将有可能对很多的 HFiles 进行读操作（这叫 <strong>读放大（Read Amplification</strong>）。</li>
</ol>
<h2 id=6-总结>6. 总结</h2>
<ul>
<li>HDFS + ZooKeeper 提供了高可用和数据可靠存储的能力；</li>
<li>通过CF + Region 的相关设计，将数据进行按序物理分片，实现了数据的海量扩展；</li>
<li>通过WAL + MemStore 的相关设计，将随机写转化为顺序写，实现了写操作的性能优化；</li>
<li>通过 BlockCache + HFile 的相关设计 ，将随机读操作；</li>
</ul>
<h2 id=参考>参考</h2>
<ol>
<li>
<p><a href=http://hbase.apache.org/book.html>Apache HBase ™ Reference Guide</a></p>
</li>
<li>
<p><a href=https://www.ibm.com/developerworks/cn/analytics/library/ba-cn-bigdata-hbase/index.html>HBase 深入浅出</a></p>
</li>
<li>
<p><a href=https://zhuanlan.zhihu.com/p/30414252>深度分析HBase架构</a></p>
</li>
<li>
<p><a href=http://www.blogjava.net/DLevin/archive/2015/08/22/426877.html>深入HBase架构解析（一）</a></p>
</li>
<li>
<p><a href=http://www.blogjava.net/DLevin/archive/2015/08/22/426950.html>深入HBase架构解析（二）</a></p>
</li>
<li>
<p><a href=http://leonlibraries.github.io/2017/05/18/%E4%BB%8ELSM%E5%88%B0HBase/>从 LSM Tree 到 HBase</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/u011331430/article/details/79036441>一张图秒懂HBase（HBase架构图）</a></p>
<h2 id=注解>注解</h2>
</li>
</ol>
<p>HBase会在如下几种情况下触发flush操作，需要注意的是MemStore的最小flush单元是HRegion而不是单个MemStore。可想而知，如果一个HRegion中Memstore过多，每次flush的开销必然会很大，因此我们也建议在进行表设计的时候尽量减少ColumnFamily的个数。</p>
<ol>
<li>Memstore级别限制：当Region中任意一个MemStore的大小达到了上限（hbase.hregion.memstore.flush.size，默认128MB），会触发Memstore刷新。</li>
<li>Region级别限制：当Region中所有Memstore的大小总和达到了上限（hbase.hregion.memstore.block.multiplier * hbase.hregion.memstore.flush.size，默认 2* 128M = 256M），会触发memstore刷新。</li>
<li>Region Server级别限制：当一个Region Server中所有Memstore的大小总和达到了上限（hbase.regionserver.global.memstore.upperLimit ＊ hbase_heapsize，默认 40%的JVM内存使用量），会触发部分Memstore刷新。Flush顺序是按照Memstore由大到小执行，先Flush Memstore最大的Region，再执行次大的，直至总体Memstore内存使用量低于阈值（hbase.regionserver.global.memstore.lowerLimit ＊ hbase_heapsize，默认 38%的JVM内存使用量）。</li>
<li>当一个Region Server中HLog数量达到上限（可通过参数hbase.regionserver.maxlogs配置）时，系统会选取最早的一个 HLog对应的一个或多个Region进行flush</li>
<li>HBase定期刷新Memstore：默认周期为1小时，确保Memstore不会长时间没有持久化。为避免所有的MemStore在同一时间都进行flush导致的问题，定期的flush操作有20000左右的随机延时。</li>
<li>手动执行flush：用户可以通过shell命令 flush ‘tablename’或者flush ‘region name’分别对一个表或者一个Region进行flush。</li>
<li><a href=http://www.dataguru.cn/article-9479-1.html>http://www.dataguru.cn/article-9479-1.html</a></li>
</ol>
<h2 id=参考-1>参考</h2>
<ol>
<li>
<p><a href=https://jimolonely.github.io/2019/08/28/java/060-hbase-shell-hex-decode/>hbase shell里编码原理与解析 | 在我的世界</a></p>
</li>
<li></li>
</ol>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p><strong>Memstore Flush触发条件</strong>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2020-09-256 10:297:100
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/architech/>architech</a>
<a href=https://justice.bj.cn/tags/hbase/>hbase</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/30.architech/hazelcast/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Hazelcast</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/hbase/hbase-region-split/>
<span class="next-text nav-default">HBase Region Split</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2021
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
</body>
</html>