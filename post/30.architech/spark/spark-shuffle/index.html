<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Spark 文件 IO 分析 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Spark 文件 IO 分析 1. Spark 简介 Spark 是一种是基于内存计算的大数据并行计算框架，主要分为 Driver、Worker 两个组件，可通过 yarn，mesos、k8">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/30.architech/spark/spark-shuffle/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Spark 文件 IO 分析">
<meta property="og:description" content="Spark 文件 IO 分析 1. Spark 简介 Spark 是一种是基于内存计算的大数据并行计算框架，主要分为 Driver、Worker 两个组件，可通过 yarn，mesos、k8">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/30.architech/spark/spark-shuffle/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-01-20T00:00:00+00:00">
<meta property="article:modified_time" content="2022-01-20T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Spark 文件 IO 分析">
<meta itemprop=description content="Spark 文件 IO 分析 1. Spark 简介 Spark 是一种是基于内存计算的大数据并行计算框架，主要分为 Driver、Worker 两个组件，可通过 yarn，mesos、k8"><meta itemprop=datePublished content="2022-01-20T00:00:00+00:00">
<meta itemprop=dateModified content="2022-01-20T00:00:00+00:00">
<meta itemprop=wordCount content="2973">
<meta itemprop=keywords content="architech,spark,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Spark 文件 IO 分析">
<meta name=twitter:description content="Spark 文件 IO 分析 1. Spark 简介 Spark 是一种是基于内存计算的大数据并行计算框架，主要分为 Driver、Worker 两个组件，可通过 yarn，mesos、k8"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Spark 文件 IO 分析</h1>
<div class=post-meta>
<time datetime=2022-01-20 class=post-time>
2022-01-20
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/architech/> architech </a>
<a href=https://justice.bj.cn/categories/spark/> spark </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#1-spark-简介>1. Spark 简介</a></li>
<li><a href=#2-spark-计算模型>2. Spark 计算模型</a></li>
<li><a href=#3-spark-shuffle>3. Spark Shuffle</a>
<ul>
<li><a href=#shuffle-write>Shuffle Write</a></li>
<li><a href=#shuffle-read>Shuffle Read</a></li>
</ul>
</li>
<li><a href=#4-spark-shuffle-改进>4. Spark Shuffle 改进</a>
<ul>
<li><a href=#41-external-shuffle-service>4.1 External Shuffle Service</a></li>
<li><a href=#42-spark-1529spark-1529-support-dfs-based-shuffle-in-addition-to-netty-shuffle---asf-jirahttpsissuesapacheorgjirabrowsespark-1529>4.2 [SPARK-1529](<a href=https://issues.apache.org/jira/browse/SPARK-1529>[SPARK-1529] Support DFS based shuffle in addition to Netty shuffle - ASF JIRA</a>)</a></li>
<li><a href=#43-httpsissuesapacheorgjirabrowsespark-25299>4.3 <a href=https://issues.apache.org/jira/browse/SPARK-25299>https://issues.apache.org/jira/browse/SPARK-25299</a></a></li>
<li><a href=#44-splash>4.4 Splash</a></li>
<li><a href=#45-alluxio-for-shuffle>4.5 Alluxio for Shuffle</a></li>
</ul>
</li>
<li><a href=#5-spark-shuffle-with-chubaofs>5. Spark Shuffle with ChubaoFS</a>
<ul>
<li><a href=#方案-1fuseclientcsi>方案 1：FuseClient/CSI</a></li>
<li><a href=#方案-2native-sdk-接口>方案 2：Native SDK 接口</a></li>
<li><a href=#方案-3splash--fuseclientnativesdk>方案 3：Splash + FuseClient/NativeSDK</a></li>
</ul>
</li>
<li><a href=#rss>RSS</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=spark-文件-io-分析>Spark 文件 IO 分析</h1>
<hr>
<h2 id=1-spark-简介>1. Spark 简介</h2>
<p>Spark 是一种是基于内存计算的大数据并行计算框架，主要分为 Driver、Worker 两个组件，可通过 yarn，mesos、k8s 进行调度。其主要架构如下：</p>
<hr>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/01/20-11-33-12-2022-01-20-11-33-00-image.png alt></p>
<p>其中：</p>
<ul>
<li>
<p>DriverNode：复制任务的提交及任务上下文相关的处理；</p>
</li>
<li>
<p>WorkerNode：复制任务的执行，每个 workerNode 可并行执行多个 executor，每个 executor</p>
</li>
</ul>
<h2 id=2-spark-计算模型>2. Spark 计算模型</h2>
<p>Spark 将数据抽象为RDD(弹性数据集)，并根据数据的依赖关系将RDD计算过程划分为一个个stage，RDD随着计算在各个stage中随着计算，在计算过程中需要处理大量数据，其涉及的 IO 主要包括以下几个：</p>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-53-31-2020-02-28-09-24-02-image.png?token=AARMIEVIQE4ND7JBHD4V6PC7B7AWU" alt></p>
<hr>
<ul>
<li>
<p><strong>输入</strong>：任务开始从外部数据源读取以构建输入 RDD，支持多种实现接口：hdfs, file, s3 等；</p>
</li>
<li>
<p><strong>输出</strong>：计算任务结束后的数据输出，写入到外部存储；</p>
</li>
<li>
<p><strong>Shuffle</strong>：两个 stage 之间的数据操作，包括可分为 shuffle write，shuffle read 两个阶段；</p>
</li>
<li>
<p><strong>Spill</strong>：Shuffle 过程中有些操作需要大量的内存，为避免 jvm 的 oom，需要将缓存数据临时存入磁盘中，这个过程称为 spill；</p>
</li>
</ul>
<hr>
<h2 id=3-spark-shuffle>3. Spark Shuffle</h2>
<p>Spark 2 个 Stage间需要对所有中间数据进行重排，这个过程称为Shuffle。Shuffle 过程需要操作大量的数据，无法全部在内存中完成，因此数据需要进行存储到磁盘中。Shuffle过程分为Shuffle Write 和 Shuffle Read两个阶段。</p>
<p>Shuffle Write将上一个 stage 的 输出数据写入磁盘中，并且把数据位置元信息上报到 driver 的中， Shuffle Read在下一个 stage 开始，根据数据位置元信息，拉取对应的数据作为该stage的输入。</p>
<hr>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-53-39-2020-01-21-15-56-38-image.png?token=AARMIETM4ITB45WP3FYARUK7B7AXE" alt></p>
<hr>
<h3 id=shuffle-write>Shuffle Write</h3>
<p>shuffle write 由上一个 stage 的 ShuffleMapTask 执行，基本过程是将上一个 stage 的数据重新按下一个 stage 的 Reduce 任务重新分区，便于下一个 stage 处理。</p>
<p>spark 中 shuffle write 有 3 种具体的实现，基本流程如下：</p>
<ol>
<li>
<p>shuffleMapTask 将数据(records)写入根据 key 做到内存缓冲区中（每个 partition 对应一个 bucket 缓存区），如果开启了 spill，则检查是否需要 spill。</p>
</li>
<li>
<p>若需要 spill，将集合中的数据根据 partitionId 和 key（若需要）分区和顺序溢写到一个临时的磁盘文件，并释放内存新建一个 map 放数据，每次溢写都是写一个新的临时文件。</p>
</li>
<li>
<p>写完后，需要将所有的临时文件进行合并(merge)，此时需要将所有的临时文件读取出来，并合并写入最终磁盘文件中，并根据索引文件记录分区映射关系；</p>
</li>
<li>
<p>最后 executor 将文件地址封装到 MapStatus，通过 MapOutputTrackerWorker 发送给 Driver 的 MapOutputTrackerMaste；</p>
</li>
<li>
<p>在 SortShuffleWriter 中，文件合并前，需要先使用 externalsort 对数据进行排序，此时可能会触发 spill 生成很多的临时小文件。</p>
</li>
</ol>
<hr>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-54-17-2020-01-20-17-32-11-image.png?token=AARMIEVGAURFDEMH5HETJO27B7AZQ" alt></p>
<hr>
<p>shuffle write 默认有三种实现：</p>
<ul>
<li>
<p>BypassMergeSortShuffleWriter：通过hash将map先按partition输出到不同的临时文件中，最后按分区合并到一个data文件中，并生成一个index文件记录每个分区在data文件中的位置；</p>
</li>
<li>
<p>SortShuffleWriter：先在内存中对数据进行排序(堆排，中间可能spill许多临时文件)，；</p>
</li>
<li>
<p>UnsafeShuffleWriter：SortShuffleWriter 的改进，使用序列化后的数组进行排序</p>
</li>
</ul>
<hr>
<h3 id=shuffle-read>Shuffle Read</h3>
<p>shuffle read 是在下一个 stage 的开始之前的 ResultTask 中执行，主要作用是获取前一个 stage 各个节点的对应分区的数据数据，以供 reduce 处理。</p>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-54-25-2020-01-20-17-51-58-image.png?token=AARMIEVM6VDNXU6TNFLBBCS7B7A2O" alt></p>
<hr>
<p>Shuffle Read 主要分为 fetch 和 aggreation 两个步骤：</p>
<ul>
<li>fetch</li>
</ul>
<ol>
<li>
<p>shuffle read 开始后，通过 BlockTransferService 从 Driver 获取 ShuffleMapTask 上报的 write mapOut 生成的文件，</p>
</li>
<li>
<p>根据文件是否在同一个节点分别调用 getRemoteValues 和 getLocalValue 拉取对应分区的 FileSegment；</p>
</li>
<li>
<p>拉取的数据放着内存缓冲区中，根据<code>spark.shuffle.spill</code>参数判断是否需要 spill 到磁盘。缓冲区大小由<code>spark.reducer.maxMbInFlight</code>（默认：5MB）设置。</p>
</li>
</ol>
<ul>
<li>aggregate</li>
</ul>
<p>spark shuffle write 后的数据不一定是全局有序的，在合并时，使用 hashmap 来处理从 filesegment 反序列化后生成的 record。</p>
<hr>
<h2 id=4-spark-shuffle-改进>4. Spark Shuffle 改进</h2>
<p>shuffle 作为连接 spark stage 中间的过程，涉及大量的数据操作，是整个计算过程的一大瓶颈，为此对 shuffle 问题及改进一直在进行。</p>
<hr>
<h3 id=41-external-shuffle-service>4.1 External Shuffle Service</h3>
<p>Spark 支持单独的服务来处理读取请求。这个单独的服务叫做 ExternalShuffleService，运行在每台主机上，管理该主机的所有 Executor 节点生成的 shuffle 数据。</p>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-54-40-2020-01-13-10-58-11-image.png?token=AARMIETC53OSQITSP5MZQMC7B7A3I" alt></p>
<hr>
<p>ESS 存在的问题：</p>
<ul>
<li>
<p>External Shuffle Service 存在失效问题；</p>
</li>
<li>
<p>与 executor 节点紧密部署，不利于隔离，尤其在容器环境；</p>
</li>
</ul>
<p><strong>计算与存储未分离</strong></p>
<hr>
<h3 id=42-spark-1529spark-1529-support-dfs-based-shuffle-in-addition-to-netty-shuffle---asf-jirahttpsissuesapacheorgjirabrowsespark-1529>4.2 [SPARK-1529](<a href=https://issues.apache.org/jira/browse/SPARK-1529>[SPARK-1529] Support DFS based shuffle in addition to Netty shuffle - ASF JIRA</a>)</h3>
<p>扩展了 shuffle 的文件系统接口，在 localFileSystem 上增加了 DistributedFileSystem，支持 HDFS 来存储 shuffle 数据，未实现，问题：spill 过程中可能产生很多小文件，hdfs 小文件写性能差（ ~15%）</p>
<hr>
<h3 id=43-httpsissuesapacheorgjirabrowsespark-25299>4.3 <a href=https://issues.apache.org/jira/browse/SPARK-25299>https://issues.apache.org/jira/browse/SPARK-25299</a></h3>
<p>讨论了现有 external shuffle service 的不足，提出了几种使用远程存储的改进方案；</p>
<p>在官方 Spark Issue 中提到了用分布式文件系统代替本地磁盘进行 shuffle 数据存取的提案。</p>
<hr>
<h3 id=44-splash>4.4 Splash</h3>
<p><a href=https://github.com/MemVerge/splash>https://github.com/MemVerge/splash</a></p>
<p>支持不同存储插件的 shuffle 管理组件，支持 hdfs、nfs、s3 等多种存储接口。</p>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-54-53-2020-01-21-15-07-54-image.png?token=AARMIEVMKYL3PHGHCIXHH2K7B7A4G" alt></p>
<hr>
<h3 id=45-alluxio-for-shuffle>4.5 Alluxio for Shuffle</h3>
<p>搜狗使用 alluxio 来存储 shuffle 数据实践<a href=https://zhuanlan.zhihu.com/p/89384057># 搜狗实战案例：基于 Alluxio 优化 Spark Shuffle 性能</a></p>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-55-04-2020-01-21-17-45-45-image.png?token=AARMIEXNAT27INOAH3WTI5C7B7A4Q" alt></p>
<p>效果：</p>
<ol>
<li>
<p>ReduceTask 可以直接从 Alluxio 获取所需 shuffle 数据，无需重算，避免原生的 Spark 会报 shuffle fetch failure 从而导致出现重算错误；</p>
</li>
<li>
<p>性能能够得到了比较大的提升；</p>
</li>
</ol>
<hr>
<h2 id=5-spark-shuffle-with-chubaofs>5. Spark Shuffle with ChubaoFS</h2>
<p>chubaofs 作为分布式文件系统，同时支持顺序写、随机写，支持大文件批量写的同时对小文件进行有比较好的优化性能，为解决 spark shuffle 的问题提供了很好的选择</p>
<hr>
<h3 id=方案-1fuseclientcsi>方案 1：FuseClient/CSI</h3>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-55-14-2020-01-22-11-05-43-image.png?token=AARMIEUZE4ONMAK2DDXUV3C7B7A5C" alt></p>
<hr>
<p>该方案主要使用 chubaofs 的 fuseclient 挂载 chubaofs 共享目录到 spark 的<code>spark.local.dir</code>本地目录上，使用 chubaofs fuseclient 为 spark shuffle 提供分布式共享存储</p>
<p>优点：</p>
<ul>
<li>可直接在现有 spark 平台使用，无开发量；</li>
</ul>
<p>缺点：</p>
<ul>
<li>shuffle read 阶段，存在间接重复传输问题，占用网络带宽；</li>
<li>fuse client / csi 部署</li>
</ul>
<hr>
<h3 id=方案-2native-sdk-接口>方案 2：Native SDK 接口</h3>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-55-22-2020-01-22-11-04-14-image.png?token=AARMIESIQRDFKLXFBIHUDW27B7A5S" alt></p>
<hr>
<p>该方案通过在 Spark 中集成 ChubaoFS native SDK 方式使用 ChubaoFS，Spark 的 driver，worker 通过 native sdk 获取数据。</p>
<p>优点：</p>
<ul>
<li>
<p>避免 shuffle read 数据重复传输；</p>
</li>
<li>
<p>支持 shuffle 文件合并选项，优化性能；</p>
</li>
</ul>
<p>缺点：</p>
<ul>
<li>
<p>需要开发 chubao fs native sdk 接口；</p>
</li>
<li>
<p>需要开发 spark chubaofs shuffle filestore 接口；</p>
</li>
</ul>
<hr>
<h3 id=方案-3splash--fuseclientnativesdk>方案 3：Splash + FuseClient/NativeSDK</h3>
<p><img src="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2020/07/16-10-55-31-2020-01-22-11-03-20-image.png?token=AARMIEURB5CK6QSVKGZEELC7B7A6C" alt></p>
<hr>
<p>该方案使用 splash 提供的共享存储目录接入 chubaofs，提供 spark shuffle 提供共享存储</p>
<p>优点：</p>
<ul>
<li>
<p>splash 作为插件，和 spark 源码相对独立；</p>
</li>
<li>
<p>fetch 不存在两次读问题；</p>
</li>
<li>
<p>开发工作量少；</p>
</li>
</ul>
<p>缺点：</p>
<ul>
<li>splash 没有经过验证，不够成熟；</li>
</ul>
<hr>
<h2 id=rss>RSS</h2>
<p>remote shuffle service， 是 JD 大数据 spark 团队自研的 shuffle service，是针对 spark 官方 ESS 的不足做的一个改进，其改进有如下几点：</p>
<ol>
<li>
<p>将 ess 原来的每个 executor node 部署独立出来，成为单独的服务集群，并提供 shuffle write/shuffle read 功能（原 ess 主要提供 shuffle read）；</p>
</li>
<li>
<p>优化 reduce 流程；</p>
</li>
<li>
<p>实现 executor 的存储计算分离，有利于容器化部署及资源调度；</p>
</li>
</ol>
<p>其后端存储初期使用本地文件系统，后期将使用分布式存储(alluxio,cfs 等)；</p>
<hr>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/01/20-11-31-26-2022-01-20-11-31-18-image.png alt></p>
<hr>
<p>优点：</p>
<ol>
<li>只需与 rss 适配，开发量少；</li>
</ol>
<p>缺点：</p>
<ol>
<li>依赖 rss；</li>
</ol>
<hr>
<h2 id=参考>参考</h2>
<ol>
<li>
<p><a href=https://xuechendi.github.io/2019/04/15/Spark-Shuffle-and-Spill-Explained>https://xuechendi.github.io/2019/04/15/Spark-Shuffle-and-Spill-Explained</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/u012369535/article/details/90757029>https://blog.csdn.net/u012369535/article/details/90757029</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/u012369535/article/details/90757029>https://blog.csdn.net/u012369535/article/details/90757029</a></p>
</li>
<li>
<p><a href=https://zhuanlan.zhihu.com/p/55954840>https://zhuanlan.zhihu.com/p/55954840</a></p>
</li>
<li>
<p><a href=http://chengfeng96.com/blog/2019/03/20/Spark-Shuffle%E8%B0%83%E7%A0%94%E7%AC%94%E8%AE%B0/>http://chengfeng96.com/blog/2019/03/20/Spark-Shuffle%E8%B0%83%E7%A0%94%E7%AC%94%E8%AE%B0/</a></p>
</li>
<li>
<p><a href="https://docs.google.com/document/d/1uCkzGGVG17oGC6BJ75TpzLAZNorvrAU3FRd2X-rVHSM/edit#heading=h.f360gce84q8o">[SPARK-25299][DISCUSSION] Improving Spark Shuffle Reliability - Google 文档</a></p>
</li>
<li>
<p><a href=https://www.waitingforcode.com/apache-spark/external-shuffle-service-apache-spark/read>https://www.waitingforcode.com/apache-spark/external-shuffle-service-apache-spark/read</a></p>
</li>
<li>
<p><a href=https://zhmin.github.io/2019/08/05/spark-external-shuffle-service/>https://zhmin.github.io/2019/08/05/spark-external-shuffle-service/</a></p>
</li>
<li>
<p><a href=https://zh.wikipedia.org/wiki/MapReduce>MapReduce - 维基百科，自由的百科全书</a></p>
</li>
<li>
<p><a href=https://bbs.huaweicloud.com/blogs/118178>https://bbs.huaweicloud.com/blogs/118178</a></p>
</li>
<li>
<p><a href=http://jerryshao.me/2014/01/04/spark-shuffle-detail-investigation/>http://jerryshao.me/2014/01/04/spark-shuffle-detail-investigation/</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/w1992wishes/article/details/88750748>【Spark】Spark 存储原理&ndash;读数据过程_w1992wishes 的博客-CSDN 博客</a></p>
</li>
<li>
<p><a href="http://kmanong.top/kmn/qxw/form/article?id=12487&cate=93">http://kmanong.top/kmn/qxw/form/article?id=12487&cate=93</a></p>
</li>
<li>
<p><a href=https://github.com/rkannan82/spark/commits/dfs_shuffle>https://github.com/rkannan82/spark/commits/dfs_shuffle</a></p>
</li>
<li>
<p><a href=https://issues.apache.org/jira/browse/SPARK-1529>[SPARK-1529] Support DFS based shuffle in addition to Netty shuffle - ASF JIRA</a></p>
</li>
<li>
<p><a href=https://docs.google.com/document/d/1uCkzGGVG17oGC6BJ75TpzLAZNorvrAU3FRd2X-rVHSM/edit#>[SPARK-25299][DISCUSSION] Improving Spark Shuffle Reliability - Google 文档</a></p>
</li>
<li>
<p><a href=https://lists.apache.org/thread.html/4e8734c0d76cd94ca70d70e7de2ea4ebef1852490dc9d319d70606c3@1461694815@%3Cdev.spark.apache.org%3E>Pony Mail!</a></p>
</li>
<li>
<p><a href=https://zhuanlan.zhihu.com/p/89384057># 搜狗实战案例：基于 Alluxio 优化 Spark Shuffle 性能</a></p>
</li>
<li>
<p><a href=https://github.com/apache/spark/pull/22777>https://github.com/apache/spark/pull/22777</a></p>
</li>
<li>
<p><a href=https://github.com/MemVerge/splash/>GitHub - MemVerge/splash: Splash, a flexible Spark shuffle manager that supports user-defined storage backends for shuffle data storage and exchange</a>:</p>
</li>
<li>
<p><a href=https://github.com/apache/spark/pull/22005>[SPARK-16817][CORE][WIP] Use Alluxio to improve stability of shuffle by replication of shuffle data by Chopinxb · Pull Request #22005 · apache/spark · GitHub</a>: alluxio shuffle manager, Use Alluxio to improve stability of shuffle by replication of shuffle dataloyiit</p>
</li>
<li>
<p><a href=https://git.jd.com/weixiuli/spark-shuffle-service/issues/1>https://git.jd.com/weixiuli/spark-shuffle-service/issues/1</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/b6ecl1k7BS8O/article/details/84949433>Apache Spark Shuffle I/O 在 Facebook 的优化_Hadoop技术博文-CSDN博客</a></p>
</li>
<li>
<p><a href=https://www.cnblogs.com/ChouYarn/p/7169472.html>Spark源码阅读之存储体系&ndash;存储体系概述与shuffle服务 - ChouYarn - 博客园</a></p>
</li>
<li>
<p><a href=https://zhangchenchen.github.io/2018/09/26/deep-in-spark-shuffle/>Inf&ndash; 深入理解 Spark shuffle | Solar</a></p>
</li>
<li>
<p><a href=https://toutiao.io/posts/eicdjo/preview>彻底搞懂 Spark 的 shuffle 过程（shuffle write） - 开发者头条</a></p>
</li>
<li>
<p><a href=http://shiyanjun.cn/archives/1655.html>简单之美 | Spark Shuffle过程分析：Map阶段处理流程</a></p>
</li>
<li>
<p><a href=https://blog.csdn.net/don_chiang709/article/details/85340236>Spark Shuffle Read 阶段里的 fetch block 源码分析_大数据_don_chiang709的专栏-CSDN博客</a></p>
</li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-01-20
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/architech/>architech</a>
<a href=https://justice.bj.cn/tags/spark/>spark</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/30.architech/rocksdb/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">RocksDB</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/spark/spark-25299/>
<span class="next-text nav-default">SPARK-25299- 改进Spark Shuffle可靠性</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/L2Dwidget.min.js></script>
<script src=/js/L2Dwidget.0.min.js></script>
<script src=/js/l2d.js></script>
</body>
</html>