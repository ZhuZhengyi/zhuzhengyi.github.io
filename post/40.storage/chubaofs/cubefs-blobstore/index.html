<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.88.1"><meta name=theme-color content="#eee"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=referrer content="no-referrer"><title>CubeFS-BlobStore | Justice's Site</title><link rel=stylesheet href=/css/meme.min.516ab7337db6de3c307c75f58928f2de3d7df97a43ca0f88175b174618dbbb98.css><script src=/js/meme.min.a47e8b4e30b64bdbf742f15475cc3b6a642c07cbb9b9557e194a898081a8a42d.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Justice"><meta name=description content="CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(E……"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Justice's Site"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Justice's Site"><meta name=msapplication-starturl content="../../../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2022-05-21T21:27:53+08:00","dateModified":"2024-05-05T03:28:47+00:00","url":"https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/","headline":"CubeFS-BlobStore","description":"CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(E……","inLanguage":"zh-cn","articleSection":"post","wordCount":12579,"image":["https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png","https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/28-16-20-30-2022-02-28-16-20-19-image.png","https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/28-17-40-09-2022-02-28-17-39-53-image.png","https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/28-17-41-54-2022-02-28-17-41-44-image.png","https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-44-35-2022-02-08-10-44-24-image.png","https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-45-04-2022-02-08-10-44-59-image.png"],"author":{"@type":"Person","description":"Viva La Vida","email":"justice_103@126.com","image":"https://justice.bj.cn/icons/apple-touch-icon.png","url":"https://io-oi.me/","name":"Justice"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"Justice's Site","logo":{"@type":"ImageObject","url":"https://justice.bj.cn/icons/apple-touch-icon.png"},"url":"https://justice.bj.cn"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://justice.bj.cn"}}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@reuixiy"><meta name=twitter:creator content="@reuixiy"><meta property="og:title" content="CubeFS-BlobStore"><meta property="og:description" content="CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(E……"><meta property="og:url" content="https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/"><meta property="og:site_name" content="Justice's Site"><meta property="og:locale" content="zh-cn"><meta property="og:image" content="https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-05-21T21:27:53+08:00"><meta property="article:modified_time" content="2024-05-05T03:28:47+00:00"><meta property="article:section" content="post"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>Justice's Site</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/><span class=menu-item-name>主页</span></a></li><li class=menu-item><a href=/post/><span class=menu-item-name>点滴</span></a></li><li class=menu-item><a href=/tags/><span class=menu-item-name>标签</span></a></li><li class=menu-item><a href=/categories/><span class=menu-item-name>分类</span></a></li><li class=menu-item><a href=/about><span class=menu-item-name>关于</span></a></li><li class=menu-item><a href=http://passer-by.com/pacman/><span class=menu-item-name>更多</span></a></li><li class=menu-item><a id=theme-switcher href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a></li><a id=search-btn href=# class="menu-item search-item" data-target=search-modal><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="16" width="16" class="search-icon" data-type="search"><path fill="currentcolor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg></a></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=post data-toc-num=true><h1 class="post-title p-name">CubeFS-BlobStore</h1><div class=post-meta><time datetime=2022-05-21T21:27:53+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2022.5.21</time>
<time datetime=2024-05-05T03:28:47+00:00 class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M4e2 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V160h352v298a6 6 0 01-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2024.5.5</time>
<span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href=/post/ class="category-link p-category">滴水穿石</a></span>
<span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;12579</span>
<span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;26&nbsp;分钟</span></div><nav class=contents><h2 id=contents class=contents-title>目录</h2><ol class=toc><li><a id=contents:简介 href=#简介>简介</a></li><li><a id=contents:架构 href=#架构>架构</a></li><li><a id=contents:组件 href=#组件>组件</a></li><li><a id=contents:资源 href=#资源>资源</a></li><li><a id=contents:erasercode href=#erasercode>EraserCode</a></li><li><a id=contents:table href=#table>Table</a></li><li><a id=contents:组件详情 href=#组件详情>组件详情</a><ol><li><a id=contents:access访问接入点 href=#access访问接入点>Access(访问接入点)</a><ol><li><a id=contents:access-client href=#access-client>Access Client</a></li></ol></li><li><a id=contents:allocator资源分配器 href=#allocator资源分配器>Allocator(资源分配器)</a></li><li><a id=contents:clustermgr集群管理器 href=#clustermgr集群管理器>ClusterMgr(集群管理器)</a><ol><li><a id=contents:cluster集群 href=#cluster集群>Cluster(集群)</a></li><li><a id=contents:volume卷 href=#volume卷>Volume(卷)</a></li></ol></li><li><a id=contents:blobnode href=#blobnode>BlobNode</a><ol><li><a id=contents:blobnode中disk href=#blobnode中disk>blobnode中disk</a></li><li><a id=contents:配置文件 href=#配置文件>配置文件</a></li><li><a id=contents:存储格式 href=#存储格式>存储格式</a></li><li><a id=contents:disk磁盘 href=#disk磁盘>Disk(磁盘)</a></li><li><a id=contents:chunk href=#chunk>Chunk</a></li><li><a id=contents:shard href=#shard>Shard</a></li></ol></li><li><a id=contents:mqproxy消息代理 href=#mqproxy消息代理>MQProxy(消息代理)</a></li><li><a id=contents:scheduler任务调度器 href=#scheduler任务调度器>Scheduler(任务调度器)</a></li><li><a id=contents:tinker修补器 href=#tinker修补器>Tinker(修补器)</a></li><li><a id=contents:worker href=#worker>Worker()</a></li><li><a id=contents:cli href=#cli>Cli</a></li></ol></li><li><a id=contents:外部组件 href=#外部组件>外部组件</a><ol><li><a id=contents:consul href=#consul>Consul</a></li><li><a id=contents:mongodb href=#mongodb>MongoDB</a></li><li><a id=contents:kafka href=#kafka>Kafka</a></li><li><a id=contents:redis href=#redis>Redis</a></li></ol></li><li><a id=contents:参数 href=#参数>参数</a><ol><li><a id=contents:blobnode-1 href=#blobnode-1>BlobNode</a></li></ol></li><li><a id=contents:关键流程 href=#关键流程>关键流程</a><ol><li><a id=contents:创建卷createvolume href=#创建卷createvolume>创建卷(CreateVolume)</a></li><li><a id=contents:写入put href=#写入put>写入(Put)</a><ol><li><a id=contents:access-client-1 href=#access-client-1>access-client</a></li><li><a id=contents:access href=#access>access</a></li><li><a id=contents:blobnode-2 href=#blobnode-2>blobnode</a></li></ol></li><li><a id=contents:读取get href=#读取get>读取(Get)</a><ol><li><a id=contents:access-client-2 href=#access-client-2>access-client</a></li><li><a id=contents:access-1 href=#access-1>access</a></li><li><a id=contents:blobnode-3 href=#blobnode-3>blobnode</a></li></ol></li><li><a id=contents:删除delete href=#删除delete>删除(Delete)</a></li><li><a id=contents:合并compact href=#合并compact>合并(Compact)</a></li><li><a id=contents:iotype href=#iotype>IOType</a></li></ol></li><li><a id=contents:安全 href=#安全>安全</a></li><li><a id=contents:参考 href=#参考>参考</a></li></ol></nav><div class="post-body e-content"><h1 id=cubefs-blobstore><a href=#cubefs-blobstore class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:cubefs-blobstore class=headings>CubeFS-BlobStore</a></h1><h2 id=简介><a href=#简介 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:简介 class=headings>简介</a></h2><ul><li><p>CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(EB)的分布式存储系统。</p></li><li><p>采用纠删码中的Reed-Solomon编码，对比三副本，以更低的存储成本提供更高的数据耐久性保障，支持多种纠删码模式和多可用区部署，</p></li><li><p>同时针对小文件做了专门优化，可满足不同业务场景的存储需求。</p></li></ul><h2 id=架构><a href=#架构 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:架构 class=headings>架构</a></h2><p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png alt></p><h2 id=组件><a href=#组件 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:组件 class=headings>组件</a></h2><p>blobstore包含如下组件：</p><div class=table-container><table><thead><tr><th>模块</th><th>描述</th><th>功能</th><th>依赖组件</th><th>本地存储</th><th>部署</th><th>部署数量</th></tr></thead><tbody><tr><td>ClusterMgr</td><td>集群管理</td><td>负责集群管理和卷的生成</td><td>consul</td><td>有</td><td>可跨机房部署，多机房</td><td>>=3</td></tr><tr><td>Allocator</td><td>集群管理代理</td><td>提供数据写入资源id的分配</td><td>ClusterMgr</td><td>无</td><td></td><td>>=1</td></tr><tr><td>Access</td><td>接入模块</td><td>对外提供数据读、写和删除接口</td><td>Redis,consul</td><td>无</td><td>单节点部署，一个机房部署一个，</td><td>>=1</td></tr><tr><td>BlobNode</td><td>blob存储</td><td>提供存储资源</td><td>ClusterMgr</td><td>有</td><td></td><td></td></tr><tr><td>Worker</td><td>blob任务执行模块</td><td>卷修补、迁移和回收任务执行模块</td><td>BlobNode，Scheduler</td><td>无</td><td></td><td>>=1</td></tr><tr><td>Scheduler</td><td>异步任务调度中心</td><td>卷修补、迁移和回收任务的生成和调度</td><td>mongodb</td><td>无</td><td>一个cluster至少一个</td><td>>=1</td></tr><tr><td>MQProxy</td><td>异步消息代理</td><td>修补和删除操作消息保存模块,用于后续异步执行</td><td>kafka</td><td>无</td><td></td><td>>=1</td></tr><tr><td>Tinker</td><td>后台数据整理管理模块</td><td>修补和删除操作异步执行模块</td><td>kafka，mongodb</td><td>无</td><td></td><td>>=1</td></tr><tr><td>Cli</td><td>cli工具</td><td>提供cli管理操作</td><td>consul，redis</td><td>无</td><td></td><td>>=</td></tr><tr><td>Consul</td><td>注册管理</td><td>提供节点、组件注册；</td><td></td><td></td><td></td><td>必选</td></tr><tr><td>MongoDB</td><td>mongodb</td><td>为scheduler提供存储</td><td></td><td></td><td></td><td>必须</td></tr><tr><td>Kafaka</td><td>消息队列服务</td><td>scheduler任务调度消息队列</td><td></td><td></td><td></td><td>必须</td></tr><tr><td>Redis</td><td>缓存服务</td><td>为access,cli访问clustermgr提供缓存加速</td><td></td><td></td><td></td><td>可选</td></tr><tr><td>Zookeeper</td><td></td><td>为kafka提供注册服务</td><td></td><td></td><td></td><td></td></tr></tbody></table></div><p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/28-16-20-30-2022-02-28-16-20-19-image.png alt></p><h2 id=资源><a href=#资源 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:资源 class=headings>资源</a></h2><ul><li><p><strong>Region(区域)</strong>: 一个region可包含多个cluster；</p></li><li><p><strong>Cluster(集群)</strong>：一个Cluster是由多个相同cluster_id的clustermgr组成，可以提供完整的Blobstore服务的单位。cluster可以跨机房部署，多个跨机房clustermgr通过raft组成一个cluster；</p></li><li><p><strong>Idc(数据中心/机房)</strong>: 一个cluster可以跨多个idc部署；</p></li><li><p><strong>Rack(机架)</strong>：机房内一个机柜; 同一机架内的机器在一个交换机内，可以拥有很低的网络访问延迟和很高的网络带宽；</p></li><li><p><strong>AZ(Available Zone)</strong>：EC 中数据块的有效分区数，一个集群中，AZ的数量要和 IDC个数匹配；</p></li><li><p><strong>Node(节点)</strong>: 对应一台物理机或容器实例；</p></li><li><p><strong>Disk(物理磁盘)</strong>: 一块已格式化好，并被挂载到某一目录的物理磁盘或一个目录；</p></li><li><p><strong>Chunk(数据簇)</strong>：每个Disk的空间被划分为多个Chunk，Chunk对应一个Chunk File；</p></li><li><p><strong>Volume(逻辑卷)</strong>: 逻辑卷是面对用户的存储资源管理抽象视图，一个Volume包含多个Unit；</p></li><li><p><strong>Unit(逻辑卷数据单元)</strong>: 逻辑卷的数据组织单元。Unit主要包含了Vuid和bid两个字段；</p></li><li><p><strong>Location(定位)</strong>：数据在blobstore中的定位，一个location中的数据由多个blob组成；</p></li><li><p><strong>Blob(数据段)</strong>: Blob是location中的一段数据，每个Blob是EC编解码的一个数据块, Blob最大默认:4MB；</p></li><li><p><strong>Shard(数据分片)</strong>：一块Blob数据在ec encode时，根据编码策略，切分成多个分片Shard，每个分片称为一个shard；</p></li></ul><h2 id=erasercode><a href=#erasercode class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:erasercode class=headings>EraserCode</a></h2><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// ec参数
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Tactic</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>N</span>         <span class=kt>int</span>   <span class=c1>//数据块个数；
</span><span class=c1></span>    <span class=nx>M</span>         <span class=kt>int</span>   <span class=c1>//校验块个数;
</span><span class=c1></span>    <span class=nx>L</span>         <span class=kt>int</span>   <span class=c1>//LRC中，本地校验块个数；
</span><span class=c1></span>    <span class=nx>AZCount</span>   <span class=kt>int</span>   <span class=c1>//分区个数;
</span><span class=c1></span>    <span class=nx>PutQuorum</span> <span class=kt>int</span>   <span class=c1>//写操作时，最少写成功的数据块个数, 
</span><span class=c1></span>                    <span class=c1>// 为了保证写入时，有一个az挂掉后还能恢复数，最小写入块数必须&gt;=(N+M)/AZCount+N
</span><span class=c1></span>    <span class=nx>GetQuorum</span> <span class=kt>int</span>   <span class=c1>//读操作时，最少读成功的数据块个数;
</span><span class=c1></span>    <span class=nx>MinShardSize</span> <span class=kt>int</span> <span class=c1>//每个数据块最小大小；
</span><span class=c1></span>                     <span class=c1>//当1en(data) &lt; MinShardSize*N, 每个shard大小为MinShardSize, 后面不够的填0
</span><span class=c1></span>                     <span class=c1>//当len(data) &gt; MinShardSize*N, 每个shard大小为[len(data)/N], 后面填0;
</span><span class=c1></span><span class=p>}</span>
<span class=c1>// 定义的ec算法
</span><span class=c1></span><span class=kd>var</span> <span class=nx>constCodeModeTactic</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>CodeMode</span><span class=p>]</span><span class=nx>Tactic</span><span class=p>{</span>
    <span class=nx>EC15P12</span><span class=p>:</span>   <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>24</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P6</span><span class=p>:</span>     <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC16P20L2</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>AZCounect</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>34</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P10L2</span><span class=p>:</span>  <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>14</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>

    <span class=c1>// single az
</span><span class=c1></span>    <span class=nx>EC12P4</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC16P4</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC3P3</span><span class=p>:</span>  <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC10P4</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>13</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P3</span><span class=p>:</span>  <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=c1>// for env test
</span><span class=c1></span>    <span class=nx>EC6P3L3</span><span class=p>:</span>       <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P6Align0</span><span class=p>:</span>   <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize0B</span><span class=p>},</span>
    <span class=nx>EC6P6Align512</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize512B</span><span class=p>},</span>
    <span class=nx>EC4P4L2</span><span class=p>:</span>       <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
<span class=p>}</span>


<span class=c1>//vol layout ep:EC6P10L2
</span><span class=c1>//|----N------|--------M----------------|--L--|
</span><span class=c1>//|0,1,2,3,4,5|6,7,8,9,10,11,12,13,14,15|16,17|
</span><span class=c1>// global stripe:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15], n=6 m=10
</span><span class=c1>// two local stripes:
</span><span class=c1>// local stripe1:[0,1,2,  6, 7, 8, 9,10, 16] n=8 m=1
</span><span class=c1>// local stripe2:[3,4,5, 11,12,13,14,15, 17] n=8 m=1
</span></code></pre></td></tr></table></div></div></div><h2 id=table><a href=#table class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:table class=headings>Table</a></h2><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// normaldb
</span><span class=c1></span>    <span class=nx>scopeCF</span>            <span class=p>=</span> <span class=s>&#34;scope&#34;</span>        <span class=c1>//分配的bid范围
</span><span class=c1></span>    <span class=nx>diskCF</span>             <span class=p>=</span> <span class=s>&#34;disk&#34;</span>         <span class=c1>//
</span><span class=c1></span>    <span class=nx>configCF</span>           <span class=p>=</span> <span class=s>&#34;config&#34;</span>
    <span class=nx>diskDropCF</span>         <span class=p>=</span> <span class=s>&#34;disk_drop&#34;</span>
    <span class=nx>serviceCF</span>          <span class=p>=</span> <span class=s>&#34;service&#34;</span>
    <span class=nx>diskStatusIndexCF</span>  <span class=p>=</span> <span class=s>&#34;disk-status&#34;</span>
    <span class=nx>diskHostIndexCF</span>    <span class=p>=</span> <span class=s>&#34;disk-host&#34;</span>
    <span class=nx>diskIDCIndexCF</span>     <span class=p>=</span> <span class=s>&#34;disk-idc&#34;</span>
    <span class=nx>diskIDCRackIndexCF</span> <span class=p>=</span> <span class=s>&#34;disk-idc-rack&#34;</span>

<span class=c1>// volumedb
</span><span class=c1></span>    <span class=nx>volumeCF</span>                <span class=p>=</span> <span class=s>&#34;volume&#34;</span>
    <span class=nx>volumeUnitCF</span>            <span class=p>=</span> <span class=s>&#34;volume_unit&#34;</span>
    <span class=nx>volumeTokenCF</span>           <span class=p>=</span> <span class=s>&#34;volume_token&#34;</span>
    <span class=nx>volumeTaskCF</span>            <span class=p>=</span> <span class=s>&#34;volume_task&#34;</span>
    <span class=nx>transitedVolumeCF</span>       <span class=p>=</span> <span class=s>&#34;transited_volume&#34;</span>
    <span class=nx>transitedVolumeUnitCF</span>   <span class=p>=</span> <span class=s>&#34;transited_volume_unit&#34;</span>
    <span class=nx>volumeUnitDiskIDIndexCF</span> <span class=p>=</span> <span class=s>&#34;volumeUnit_DiskID&#34;</span>

<span class=c1>// raftdb
</span></code></pre></td></tr></table></div></div></div><h2 id=组件详情><a href=#组件详情 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:组件详情 class=headings>组件详情</a></h2><h3 id=access访问接入点><a href=#access访问接入点 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:access访问接入点 class=headings>Access(访问接入点)</a></h3><ul><li><p>access是面向client，提供访问api接口的组件；</p></li><li><p>access为无状态节点；</p></li><li><p>一个access为一个<code>region</code>下的所有<code>cluster</code>提供访问接入点;</p></li><li><p>access主要提供如下rpc：</p><ul><li><p>/put: put数据，动态分配location, 默认最大size：5GB;</p></li><li><p>/putAt: 将数据put到指定的location；</p></li><li><p>/get: 根据location读取数据；</p></li><li><p>/delete：删除指定location的数据；</p></li><li><p>/deleteblob: 删除指定blob;</p></li><li><p>/alloc: 分配blob;</p></li><li><p>/sign: 签名;</p></li></ul></li><li><p>启动时，会从<code>consul_agent_addr</code>获取配置region的cluster信息加载到当前节点内存中;</p></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Location: 一次put的数据位置信息；
</span><span class=c1>//
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Location</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>_</span>         <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>ClusterID</span> <span class=nx>proto</span><span class=p>.</span><span class=nx>ClusterID</span>   <span class=s>`json:&#34;cluster_id&#34;`</span>
    <span class=nx>CodeMode</span>  <span class=nx>codemode</span><span class=p>.</span><span class=nx>CodeMode</span> <span class=s>`json:&#34;code_mode&#34;`</span>
    <span class=nx>Size</span>      <span class=kt>uint64</span>            <span class=s>`json:&#34;size&#34;`</span>
    <span class=nx>BlobSize</span>  <span class=kt>uint32</span>            <span class=s>`json:&#34;blob_size&#34;`</span>
    <span class=nx>Crc</span>       <span class=kt>uint32</span>            <span class=s>`json:&#34;crc&#34;`</span>
    <span class=nx>Blobs</span>     <span class=p>[]</span><span class=nx>SliceInfo</span>       <span class=s>`json:&#34;blobs&#34;`</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Blob</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Bid</span>  <span class=nx>proto</span><span class=p>.</span><span class=nx>BlobID</span>
    <span class=nx>Vid</span>  <span class=nx>proto</span><span class=p>.</span><span class=nx>Vid</span>
    <span class=nx>Size</span> <span class=kt>uint32</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>SliceInfo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>_</span>      <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>MinBid</span> <span class=nx>proto</span><span class=p>.</span><span class=nx>BlobID</span> <span class=s>`json:&#34;min_bid&#34;`</span>
    <span class=nx>Vid</span>    <span class=nx>proto</span><span class=p>.</span><span class=nx>Vid</span>    <span class=s>`json:&#34;vid&#34;`</span>
    <span class=nx>Count</span>  <span class=kt>uint32</span>       <span class=s>`json:&#34;count&#34;`</span>
<span class=p>}</span>

    <span class=nx>MaxLocationBlobs</span> <span class=kt>uint32</span> <span class=p>=</span> <span class=mi>4</span>    <span class=c1>//location中最大blob数量，4个
</span><span class=c1></span>    <span class=nx>MaxDeleteLocations</span> <span class=kt>int</span> <span class=p>=</span> <span class=mi>1024</span>  <span class=c1>//delete请求中最多包含location数：1024
</span><span class=c1></span>    <span class=nx>MaxBlobSize</span> <span class=kt>uint32</span> <span class=p>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>25</span>    <span class=c1>// location中单个blob最大size：32MB
</span></code></pre></td></tr></table></div></div></div><ul><li>配置文件</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//access.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9500&#34;</span><span class=p>,</span>
    <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/access/&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;consul_agent_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1:8500&#34;</span><span class=p>,</span>    <span class=err>//</span>
    <span class=nt>&#34;service_register&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;consul_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1:8500&#34;</span><span class=p>,</span>
        <span class=nt>&#34;service_ip&#34;</span><span class=p>:</span> <span class=s2>&#34;x.x.x.x&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;stream&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;idc&#34;</span><span class=p>,</span>
        <span class=nt>&#34;cluster_config&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;region&#34;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h4 id=access-client><a href=#access-client class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:access-client class=headings>Access Client</a></h4><ul><li><p>access client 为访问access 提供api；</p></li><li><p>access client api通过配置文件中的<code>PriorityAddrs</code>或consul 来连接access；</p></li><li><p>每次api发送请求时，会从发现的所有access中随机选择<code>MaxHostRetry</code>(默认：3)个依次给access发送api请求，如果一个请求发送成功，则成功返回；</p></li><li><p>access client 主要 提供3个api：</p><ul><li><p>Put(): 写入数据, 返回数据location；</p></li><li><p>Get(): 根据location，获取数据内容；</p></li><li><p>Delete(): 删除指定location的数据；</p></li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// API access api for s3
</span><span class=c1>// To trace request id, the ctx is better WithRequestID(ctx, rid).
</span><span class=c1></span><span class=kd>type</span> <span class=nx>API</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=c1>// Put object once if size is not greater than MaxSizePutOnce, otherwise put blobs one by one.
</span><span class=c1></span>    <span class=c1>// return a location and map of hash summary bytes you excepted.
</span><span class=c1></span>    <span class=nf>Put</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>PutArgs</span><span class=p>)</span> <span class=p>(</span><span class=nx>location</span> <span class=nx>Location</span><span class=p>,</span> <span class=nx>hashSumMap</span> <span class=nx>HashSumMap</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
    <span class=c1>// Get object, range is supported.
</span><span class=c1></span>    <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>GetArgs</span><span class=p>)</span> <span class=p>(</span><span class=nx>body</span> <span class=nx>io</span><span class=p>.</span><span class=nx>ReadCloser</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
    <span class=c1>// Delete all blobs in these locations.
</span><span class=c1></span>    <span class=c1>// return failed locations which have yet been deleted if error is not nil.
</span><span class=c1></span>    <span class=nf>Delete</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>DeleteArgs</span><span class=p>)</span> <span class=p>(</span><span class=nx>failedLocations</span> <span class=p>[]</span><span class=nx>Location</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h3 id=allocator资源分配器><a href=#allocator资源分配器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:allocator资源分配器 class=headings>Allocator(资源分配器)</a></h3><ul><li><p>allocator主要为accessor提供volume/alloc, list两个接口，负责vid,bid的分配；</p></li><li><p>allocator启动时，将自身组成到clustermgr的服务中；</p></li><li><p>allocator内置了<code>volumeMgr</code>, <code>bidmgr</code>；</p><ul><li><p>volumeMgr：负责volume的分配的管理。启动时，开启后台线程，将clusterMgr上的所有<code>volInfo</code>加载到allocate内存中；</p></li><li><p>bidMgr：负责volume 的bid range分配；</p></li></ul></li><li><p>rpc：</p><ul><li><p>/volume/alloc:</p></li><li><p>/volume/list:</p></li></ul></li><li><p>配置文件：</p></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//</span> <span class=err>allocator.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9100&#34;</span><span class=p>,</span>
    <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9100&#34;</span><span class=p>,</span>
    <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span><span class=p>,</span>
    <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span>
            <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span>
            <span class=s2>&#34;http://127.0.0.1:10000&#34;</span>
        <span class=p>]</span>
    <span class=p>},</span>
    <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>1</span>
    <span class=p>},</span>
    <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/allocator/&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h3 id=clustermgr集群管理器><a href=#clustermgr集群管理器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:clustermgr集群管理器 class=headings>ClusterMgr(集群管理器)</a></h3><ul><li><p>clustermgr用于集群相关信息的管理；</p></li><li><p>clustermgr内部由多个管理器组成，包括：</p><ul><li><p>ServiceMgr(服务管理)：管理集群中的各个Service, 包括：allocator，mqproxy, tinker；</p></li><li><p>ConfigMgr(配置管理): cluster_config, 集群的全局配置；</p></li><li><p>VolumeMgr(逻辑卷管理)：负责volume的allocate，状态监测等, ;</p></li><li><p>DiskMgr(磁盘管理)：管理集群内所有blobnode磁盘；</p></li><li><p>ScopeMgr(Bid管理)：id分配管理；</p></li></ul></li><li><p>clustermgr内置kvdb(目前为rocksdb)来保存各种管理器的相关数据；</p></li><li><p>多个clustermgr通过raft保证kvdb数据在多个节点的同步以保证高可用；</p></li><li><p>clustermgr周期性(参数<code>cluster_report_interval_s</code>，默认：60s)的将clusterinfo汇报给<code>consul_agent_addr</code>上，以<code>ebs/&lt;region>/clusters/&lt;clusterID>:&lt;clusterInfo></code>；</p></li><li><p>leader clustermgr周期性的(默认: 10s)检查并更新disk状态；</p></li><li></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//</span> <span class=err>clustermgr.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;max_procs&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span><span class=s2>&#34;:9998&#34;</span><span class=p>,</span>
    <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;z0&#34;</span><span class=p>],</span>
    <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;test-region&#34;</span><span class=p>,</span>
    <span class=nt>&#34;readonly&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;chunk_size&#34;</span><span class=p>:</span> <span class=mi>16777216</span><span class=p>,</span>
    <span class=nt>&#34;consul_agent_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1:8500&#34;</span><span class=p>,</span>  <span class=err>//option,</span> <span class=err>default:</span> <span class=err>127.0.0.1:8500</span>
    <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>1</span>
    <span class=p>},</span>
    <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/clustermgr/&#34;</span><span class=p>,</span>
        <span class=nt>&#34;backup&#34;</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span>
        <span class=nt>&#34;log_file_suffix&#34;</span><span class=p>:</span> <span class=s2>&#34;.log&#34;</span><span class=p>,</span>
        <span class=nt>&#34;rotate_new&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
        <span class=nt>&#34;chunkbits&#34;</span><span class=p>:</span> <span class=mi>14</span>

    <span class=p>},</span>
    <span class=nt>&#34;auth&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;enable_auth&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
        <span class=nt>&#34;secret&#34;</span><span class=p>:</span> <span class=s2>&#34;testsecret&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;normal_db_path&#34;</span><span class=p>:</span><span class=s2>&#34;/tmp/normaldb0&#34;</span><span class=p>,</span>
    <span class=nt>&#34;normal_db_option&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;create_if_missing&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
    <span class=nt>&#34;code_mode_policies&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span><span class=nt>&#34;mode_name&#34;</span><span class=p>:</span><span class=s2>&#34;EC3P3&#34;</span><span class=p>,</span><span class=nt>&#34;min_size&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&#34;max_size&#34;</span><span class=p>:</span><span class=mi>1024</span><span class=p>,</span><span class=nt>&#34;size_ratio&#34;</span><span class=p>:</span><span class=mf>0.2</span><span class=p>,</span><span class=nt>&#34;enable&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
        <span class=p>{</span><span class=nt>&#34;mode_name&#34;</span><span class=p>:</span><span class=s2>&#34;EC6P6&#34;</span><span class=p>,</span><span class=nt>&#34;min_size&#34;</span><span class=p>:</span><span class=mi>1025</span><span class=p>,</span><span class=nt>&#34;max_size&#34;</span><span class=p>:</span><span class=mi>2048</span><span class=p>,</span><span class=nt>&#34;size_ratio&#34;</span><span class=p>:</span><span class=mf>0.8</span><span class=p>,</span><span class=nt>&#34;enable&#34;</span><span class=p>:</span><span class=kc>false</span><span class=p>}</span>
    <span class=p>],</span>
    <span class=nt>&#34;volume_mgr_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;volume_db_path&#34;</span><span class=p>:</span><span class=s2>&#34;/tmp/volumedb0&#34;</span><span class=p>,</span>
        <span class=nt>&#34;volume_db_option&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;create_if_missing&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
        <span class=nt>&#34;min_allocable_volume_count&#34;</span><span class=p>:</span><span class=mi>4</span><span class=p>,</span>
        <span class=nt>&#34;each_allocator_volume_threshold&#34;</span><span class=p>:</span><span class=mi>500</span><span class=p>,</span>
        <span class=nt>&#34;retain_time_s&#34;</span><span class=p>:</span><span class=mi>600</span>
    <span class=p>},</span>
    <span class=nt>&#34;cluster_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;disk_repair&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;balance&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;disk_drop&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;blob_delete&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;shard_repair&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;vol_inspect&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;init_volume_num&#34;</span><span class=p>:</span><span class=mi>100</span><span class=p>,</span>
        <span class=nt>&#34;volume_reserve_size&#34;</span><span class=p>:</span><span class=mi>10485760</span><span class=p>,</span>
        <span class=nt>&#34;data_node_heartbeat_interval_s&#34;</span><span class=p>:</span> <span class=mi>60</span>
    <span class=p>},</span>
    <span class=nt>&#34;raft_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;raft_db_path&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/raftdb0&#34;</span><span class=p>,</span>
        <span class=nt>&#34;raft_db_option&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;create_if_missing&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
        <span class=nt>&#34;snapshot_patch_num&#34;</span><span class=p>:</span> <span class=mi>64</span><span class=p>,</span>
        <span class=nt>&#34;server_config&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;nodeId&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
            <span class=nt>&#34;listen_port&#34;</span><span class=p>:</span> <span class=mi>10110</span><span class=p>,</span>
            <span class=nt>&#34;raft_wal_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/raftwal0&#34;</span><span class=p>,</span>
            <span class=nt>&#34;peers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;1&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10110&#34;</span><span class=p>,</span><span class=nt>&#34;2&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10111&#34;</span><span class=p>,</span><span class=nt>&#34;3&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10112&#34;</span><span class=p>}</span>
        <span class=p>},</span>
        <span class=nt>&#34;raft_node_config&#34;</span><span class=p>:{</span>
            <span class=nt>&#34;flush_num_interval&#34;</span><span class=p>:</span> <span class=mi>10000</span><span class=p>,</span>
            <span class=nt>&#34;flush_time_interval_s&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
            <span class=nt>&#34;truncate_num_interval&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
            <span class=nt>&#34;node_protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;http://&#34;</span><span class=p>,</span>
            <span class=nt>&#34;nodes&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;1&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:9998&#34;</span><span class=p>,</span> <span class=nt>&#34;2&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:9999&#34;</span><span class=p>,</span> <span class=nt>&#34;3&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10000&#34;</span><span class=p>}</span>
        <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>&#34;disk_mgr_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;refresh_interval_s&#34;</span><span class=p>:</span> <span class=mi>300</span><span class=p>,</span>
        <span class=nt>&#34;rack_aware&#34;</span><span class=p>:</span><span class=kc>false</span><span class=p>,</span>
        <span class=nt>&#34;host_aware&#34;</span><span class=p>:</span><span class=kc>false</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h4 id=cluster集群><a href=#cluster集群 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:cluster集群 class=headings>Cluster(集群)</a></h4><ul><li><p>一个cluster由多个cluster_id相同的多个clustermgr节点组成；</p></li><li><p>一个cluster中的多个clustermgr通过raft组成一个raft group进行数据复制同步；</p></li><li><p>一个region中可包含多个cluster，同一region下的cluster注册为consul下的多个服务；</p></li><li><p>数据put时，access根据配置的region，会随机在region下选择一个cluster来put数据，返回的location中包含cluster_id用以指明所在cluster；</p></li></ul><h4 id=volume卷><a href=#volume卷 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:volume卷 class=headings>Volume(卷)</a></h4><ul><li><p>Volume是数据管理逻辑单元，是面向客户端的数据视图；</p></li><li><p>基本信息</p><ul><li><p>vid(32bits)</p></li><li><p>CodeMode: 编码模式</p></li><li><p>Status: 状态</p></li><li><p>HealthScore: 健康分</p></li><li><p>Total: 总空间</p></li><li><p>Free: 可用空间</p></li><li><p>Used: 已使用空间</p></li><li><p>CreateByNodeID: 创建NodeID</p></li></ul></li><li><p>Volume Status</p><ul><li><p>idle: volume刚创建时，尚未被分配的volume状态；</p></li><li><p>active: volume分配给某一个allocator后的状态；</p></li><li><p>lock:</p></li><li><p>unlocking</p></li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//卷信息
</span><span class=c1></span><span class=kd>type</span> <span class=nx>VolumeInfo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Units</span> <span class=p>[]</span><span class=nx>Unit</span>
    <span class=nx>VolumeInfoBase</span>
<span class=p>}</span>
<span class=c1>//卷单元
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Unit</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Vuid</span>       <span class=nx>proto</span><span class=p>.</span><span class=nx>Vuid</span> 
    <span class=nx>DiskID</span>     <span class=nx>proto</span><span class=p>.</span><span class=nx>DiskID</span>
    <span class=nx>Host</span>       <span class=kt>string</span>
<span class=p>}</span>

<span class=c1>// clustermgr/srv.go
</span><span class=c1></span>    <span class=nx>BidScopeName</span>             <span class=p>=</span> <span class=s>&#34;bid&#34;</span>
    <span class=nx>MaxBidCount</span>              <span class=p>=</span> <span class=mi>100000</span>
    <span class=nx>DefaultChunkSize</span>         <span class=p>=</span> <span class=mi>17179869184</span>
    <span class=nx>DefaultVolumeReserveSize</span> <span class=p>=</span> <span class=mi>10485760</span>

    <span class=nx>defaultClusterReportIntervalS</span>   <span class=p>=</span> <span class=mi>60</span>
    <span class=nx>defaultHeartbeatNotifyIntervalS</span> <span class=p>=</span> <span class=mi>10</span>
    <span class=nx>defaultMaxHeartbeatNotifyNum</span>    <span class=p>=</span> <span class=mi>2000</span>
    <span class=nx>defaultMetricReportIntervalM</span>    <span class=p>=</span> <span class=mi>2</span>
</code></pre></td></tr></table></div></div></div><h3 id=blobnode><a href=#blobnode class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:blobnode class=headings>BlobNode</a></h3><ul><li><p>BlobNode是blob管理节点，提供数据的blob存储管理；</p></li><li><p>blobnode启动时，将扫描并加载配置文件下的disk，然后后<code>clusterMgr</code>上已有的disk进行对比，如果<code>clusterMgr</code>中<code>not found</code>，则<code>AddDisk</code>到<code>clusterMgr</code>的管理器中；</p></li><li><p>启动时开启如下全局协程：</p><ul><li><p>loopHeartbeatToClusterMgr(): 周期性(默认：30s)维持和<code>clusterMgr</code>间的心跳；</p></li><li><p>loopReportChunkInfoToClusterMgr()：周期性(默认：57s)向<code>clusterMgr</code>汇报chunkInfo;</p></li><li><p>loopGcRubbishChunkFile(): 周期(默认：60min)检查chunkfile，执行垃圾回收任务；</p></li><li><p>loopCleanExpiredStatFile(): 周期()清理过期stat文件(/tmp/shm/目录下的iostat文件)；</p></li></ul></li></ul><h4 id=blobnode中disk><a href=#blobnode中disk class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:blobnode中disk class=headings>blobnode中disk</a></h4><ul><li><p>blobnode中disk由配置文件中<code>disks</code>项指定，一个blobnode可以包含多个disk;</p></li><li><p>blobnode启动时，先通过rpc从<code>clusterMgr</code>获取该host所有已经注册的disk；</p></li><li><p>然后根据配置文件, 逐个加载disk；</p></li><li><p>每个disk包含.sys, meta等子目录，</p><ul><li><p>.sys目录里面保存disk的格式相关信息；</p></li><li><p>.meta里面使用rocksdb来记录chunk相关的元数据信息；</p></li><li><p>.data目录包含chunkfile;</p></li></ul></li><li><p>blobnode disk加载流程：</p><ul><li><p>通过配置文件获取disk根目录；</p></li><li><p>加载磁盘format信息。通过读取.sys目录下的format.json内获取disk format信息(包括DiskID), 如果该文件不存在，则从<code>clusterMgr</code>分配一个新的DiskID, 并注册disk到clusterMgr的table中;</p></li><li><p>打开meta目录下的rocksdb，初始化化superblock;</p></li><li><p>从meta db中读取<code>diskinfo</code>来加载diskinfo；</p></li><li><p>设置disk iostat 相关数据结构；</p></li><li><p>启动loop相关后台协程</p></li><li><ul><li><p><code>ds.loopCleanChunk</code>: 清理已released 的chunk；</p></li><li><p><code>ds.loopCompactFile</code>: compact chunk file;</p></li><li><p><code>ds.loopDiskUsage</code>:</p></li><li><p><code>ds.loopCleanTrash</code>:</p></li><li><p><code>ds.loopMetricReport</code>:</p></li></ul></li><li><p>加载好的diskStorage记录在map[diskID]<code>Disks</code> 中;</p></li></ul></li><li><p>blobnode rpc:</p><ul><li><p>/chunk/create</p></li><li><p>/chunk/release</p></li><li><p>/chunk/compact</p></li><li><p>...</p></li><li><p>/shard/get/...</p></li><li><p>/shard/put/....</p></li><li><p>/shard/delete/...</p></li></ul></li></ul><h4 id=配置文件><a href=#配置文件 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:配置文件 class=headings>配置文件</a></h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//</span> <span class=err>blobnode.conf</span>
<span class=p>{</span>
  <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:8899&#34;</span><span class=p>,</span>
  <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
  <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span><span class=p>,</span>
  <span class=nt>&#34;rack&#34;</span><span class=p>:</span> <span class=s2>&#34;testrack&#34;</span><span class=p>,</span>
  <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8899&#34;</span><span class=p>,</span>
  <span class=nt>&#34;disks&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk2&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk3&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk4&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk5&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk6&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span>
      <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span>
      <span class=s2>&#34;http://127.0.0.1:10000&#34;</span>
    <span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/blobnode.log&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/auditlog&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h4 id=存储格式><a href=#存储格式 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:存储格式 class=headings>存储格式</a></h4><ul><li>volume->chunk</li></ul><p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/28-17-40-09-2022-02-28-17-39-53-image.png alt></p><ul><li>chunk->shard</li></ul><p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/28-17-41-54-2022-02-28-17-41-44-image.png alt></p><h4 id=disk磁盘><a href=#disk磁盘 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:disk磁盘 class=headings>Disk(磁盘)</a></h4><ul><li><p>Disk是BlobNode节点上一个格式化后挂载到某一目录的物理磁盘，用来存储具体的数据；</p></li><li><p>Disk基本信息包括：</p><ul><li><p>DiskID: 磁盘ID(uint32), 1~1^31-1；</p></li><li><p>ClusterID: 所属ClusterID(uint32)；</p></li><li><p>Idc: Idc</p></li><li><p>Path：</p></li><li><p>Host：</p></li><li><p>Status</p></li><li><p>ReadOnly: 是否只读</p></li></ul></li><li><p>Disk Status包括：</p><ul><li><p>Normal: 正常</p></li><li><p>Broken:</p></li><li><p>Repairing</p></li><li><p>Repaired</p></li><li><p>Droped</p></li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// disk format
</span><span class=c1>// blobnode/core/format.go
</span><span class=c1></span><span class=cm>/*
</span><span class=cm> * ${diskRoot}/
</span><span class=cm> *         - .sys/                 //disk
</span><span class=cm> *          - .format.json         //disk 格式信息；
</span><span class=cm> *          - .format.json.tmp
</span><span class=cm> *         - .trash/                //回收站，被清理的chunk
</span><span class=cm> *         - data/                  //disk数据信息, chunk file
</span><span class=cm>            - &lt;chunkID1&gt;file     // chunk file 1  (最多8196个chunk)
</span><span class=cm>            - &lt;chunkID2&gt;file     // chunk file 2 
</span><span class=cm> *         - meta/                  //disk元信息
</span><span class=cm>            - superblock/        //disk超级块，disk meta kvdb
</span><span class=cm>*/</span>

<span class=c1>// 磁盘格式信息受保护域，
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FormatInfoProtectedField</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>DiskID</span>  <span class=nx>proto</span><span class=p>.</span><span class=nx>DiskID</span> <span class=s>`json:&#34;diskid&#34;`</span>    <span class=c1>//
</span><span class=c1></span>    <span class=nx>Version</span> <span class=kt>uint8</span>        <span class=s>`json:&#34;version&#34;`</span>   <span class=c1>//
</span><span class=c1></span>    <span class=nx>Ctime</span>   <span class=kt>int64</span>        <span class=s>`json:&#34;ctime&#34;`</span>     <span class=c1>//
</span><span class=c1></span>    <span class=nx>Format</span>  <span class=kt>string</span>       <span class=s>`json:&#34;format&#34;`</span>    <span class=c1>//disk格式，当前只支持fs
</span><span class=c1></span><span class=p>}</span>
<span class=c1>//磁盘格式信息
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FormatInfo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>FormatInfoProtectedField</span>
    <span class=nx>CheckSum</span> <span class=kt>uint32</span> <span class=s>`json:&#34;check_sum&#34;`</span>
<span class=p>}</span>

<span class=c1>//disk metadb(rocksdb)
</span><span class=c1>//    k       ----        v
</span><span class=c1>// disk/&lt;diskid&gt;        [diskid]  
</span><span class=c1>// chunk/&lt;chunkid&gt;      [chunkid]
</span><span class=c1>// vuid/&lt;vuid&gt;          [vuid]
</span><span class=c1>// diskinfo             [diskmeta]
</span><span class=c1></span>
<span class=c1>//DiskMeta
</span><span class=c1></span><span class=kd>type</span> <span class=nx>DiskMeta</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>FormatInfo</span>
    <span class=nx>Host</span>       <span class=kt>string</span>           <span class=s>`json:&#34;host&#34;`</span>
    <span class=nx>Path</span>       <span class=kt>string</span>           <span class=s>`json:&#34;path&#34;`</span>
    <span class=nx>Status</span>     <span class=nx>proto</span><span class=p>.</span><span class=nx>DiskStatus</span> <span class=s>`json:&#34;status&#34;`</span>
    <span class=nx>Registered</span> <span class=kt>bool</span>             <span class=s>`json:&#34;registered&#34;`</span>
    <span class=nx>Readonly</span>   <span class=kt>bool</span>             <span class=s>`json:&#34;readonly&#34;`</span>
    <span class=nx>Mtime</span>      <span class=kt>int64</span>            <span class=s>`json:&#34;mtime&#34;`</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h4 id=chunk><a href=#chunk class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:chunk class=headings>Chunk</a></h4><ul><li><p>Chunk是对Disk上具体数据的一种抽象，当前的chunk实现为一个file；</p></li><li><p>chunk file 位于disk的data目录下, 以chunkID为名的file；</p></li><li><p>chunkID组成：<code>vuid+&lt;创建chunk时的时间戳></code>；</p></li><li><p>每个chunk由多个连续的shard组成，</p></li></ul><ul><li><p>一个disk默认最多chunk数<code>DefaultMaxChunks</code>：8192;</p></li><li><p>一个chunk默认最大size<code>DefaultMaxChunk</code>: 1TiB;</p></li><li><p>默认chunk size<code>DefaultChunkSize</code>：16GiB;</p></li></ul><ul><li><p>chunk status:</p><ul><li><p>Default:</p></li><li><p>Normal:</p></li><li><p>ReadOnly:</p></li><li><p>Release:</p></li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// cubufs-blobstore/blobnode/core/shard.go
</span><span class=c1></span>
<span class=c1>// chunk datafile format:
</span><span class=c1>//  --------------
</span><span class=c1>// | chunk  header | (4k)
</span><span class=c1>//  --------------
</span><span class=c1>// |    shard    |         ----------------------
</span><span class=c1>// |    shard    |        |  header (32 Bytes) |
</span><span class=c1>// |    shard    | ----&gt;  |  data   (...)      |
</span><span class=c1>// |    shard    |        |  footer (8 Bytes)  |
</span><span class=c1>// |    ....    |        ----------------------
</span><span class=c1>//
</span><span class=c1>// Chunkdata header format:
</span><span class=c1>//  --------------
</span><span class=c1>// | magic number |   ---- 4 bytes
</span><span class=c1>// | version      |   ---- 1 byte
</span><span class=c1>// | parent chunk |   ---- 16 byte    //compact前的chunk   
</span><span class=c1>// | create time  |   ---- 8 byte
</span><span class=c1>// | padding      |   ---- aligned with shard padding size ( 4k-4-1-16-8)
</span><span class=c1></span>
<span class=c1>// shard
</span><span class=c1>// shard header format:
</span><span class=c1>// ---------------------
</span><span class=c1>// |crc(header)(uint32)|
</span><span class=c1>// |  magic  (uint32)  |
</span><span class=c1>// |  bid    (int64)   |
</span><span class=c1>// |  vuid   (uint64)  |
</span><span class=c1>// |  size   (uint32)  |
</span><span class=c1>// | padding (4 bytes) |
</span><span class=c1>// ---------------------
</span><span class=c1>//
</span><span class=c1>// shard data format.
</span><span class=c1>//  --------------
</span><span class=c1>// | block        |   ---- 64 KiB
</span><span class=c1>// | block        |   ---- 64 KiB
</span><span class=c1>// | block        |   ---- 64 KiB
</span><span class=c1>//  ---------------
</span><span class=c1>//
</span><span class=c1>// block format.
</span><span class=c1>//  --------------
</span><span class=c1>// | crc          |   ---- 4 Byte
</span><span class=c1>// | data         |   ---- (64 KiB - 4)
</span><span class=c1>//  ---------------
</span><span class=c1>//
</span><span class=c1>// footer format:
</span><span class=c1>// ----------------------
</span><span class=c1>// |  magic   (int32)   |
</span><span class=c1>// | crc(shard) (int32) |
</span><span class=c1>// | padding  (0 bytes) |
</span><span class=c1>// ----------------------
</span><span class=c1></span>

<span class=c1>// Chunkdata has a header (4k).
</span><span class=c1>// Chunkdata header format:
</span><span class=c1>//  --------------
</span><span class=c1>// | magic number |   ---- 4 bytes
</span><span class=c1>// | version      |   ---- 1 byte
</span><span class=c1>// | parent chunk |   ---- 16 byte
</span><span class=c1>// | create time  |   ---- 8 byte
</span><span class=c1>// | padding      |   ---- aligned with shard padding size ( 4k-4-1-16-8)
</span><span class=c1>//  --------------
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    ....      |
</span><span class=c1></span>
<span class=kd>type</span> <span class=nx>ChunkHeader</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>magic</span>       <span class=p>[</span><span class=nx>_chunkMagicSize</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>version</span>     <span class=kt>byte</span>
    <span class=nx>parentChunk</span> <span class=nx>bnapi</span><span class=p>.</span><span class=nx>ChunkId</span>
    <span class=nx>createTime</span>  <span class=kt>int64</span>
<span class=p>}</span>

<span class=c1>// Chunk ID
</span><span class=c1>// vuid + timestamp
</span><span class=c1></span><span class=kd>const</span> <span class=p>(</span>
    <span class=nx>chunkVuidLen</span>      <span class=p>=</span> <span class=mi>8</span>
    <span class=nx>chunkTimestmapLen</span> <span class=p>=</span> <span class=mi>8</span>
    <span class=nx>ChunkIdLength</span>     <span class=p>=</span> <span class=nx>chunkVuidLen</span> <span class=o>+</span> <span class=nx>chunkTimestmapLen</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div></div><h4 id=shard><a href=#shard class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:shard class=headings>Shard</a></h4><ul><li><p>shard是chunk中用于存储一个ec编码</p></li><li><p>shard status:</p><ul><li><p>Default:</p></li><li><p>Normal:</p></li><li><p>MarkDelete:</p></li></ul></li></ul><h3 id=mqproxy消息代理><a href=#mqproxy消息代理 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:mqproxy消息代理 class=headings>MQProxy(消息代理)</a></h3><ul><li>mqproxy为kafka mq代理，作为异步消息传输通道；</li><li>启动时，将自身作为 service注册到<code>clustermsg</code>中的service table中；</li><li>mqproxy接收<code>access</code>下发的<code>shardRepardMsg</code>和<code>blobDeleteMsg</code>消息，发送到kafka中，最后被<code>scheduler</code>消费；</li><li>scheduler中的<code>inspectMgr</code>在巡检时，如果发现丢失的shard，将给mqproxy发送<code>shardRepairedMsg</code>;</li><li>提供rpc接口：<ul><li>/repairmsg: shard修复消息；</li><li>/deletemsg: blob删除消息；</li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//mqproxy.conf</span>
<span class=p>{</span>
  <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9600&#34;</span><span class=p>,</span>
  <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
  <span class=nt>&#34;cm_cfg&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http://127.0.0.1:7000&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:7010&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:7020&#34;</span><span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;blob_delete_topic&#34;</span><span class=p>:</span> <span class=s2>&#34;blob_delete&#34;</span><span class=p>,</span>
    <span class=nt>&#34;shard_repair_topic&#34;</span><span class=p>:</span> <span class=s2>&#34;shard_repair&#34;</span><span class=p>,</span>
    <span class=nt>&#34;shard_repair_priority_topic&#34;</span><span class=p>:</span> <span class=s2>&#34;shard_repair_prior&#34;</span><span class=p>,</span>
    <span class=nt>&#34;msg_sender&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;broker_list&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;127.0.0.1:9092&#34;</span><span class=p>]</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>&#34;service_register&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9600&#34;</span><span class=p>,</span>
    <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/mqproxy.log&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/mqproxy&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h3 id=scheduler任务调度器><a href=#scheduler任务调度器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:scheduler任务调度器 class=headings>Scheduler(任务调度器)</a></h3><ul><li><code>scheduler</code>提供所在cluster后台任务调度服务;</li><li>内置多种管理器，来对各种任务进行管理：<ul><li>ClusterTopoMgr: 集群拓扑管理器, 周期性(默认：5min)的从<code>clustermgr</code>获取配置集群的disk信息，然后构建拓扑信息；</li><li>BalanceMgr：数据平衡管理器, 周期性(默认：5s)收集disk分布情况，构建MigrateMgr任务，使数据自动保证平衡；</li><li>MigrateMgr: 迁移管理器, 分为自动、手动迁移管理器两种。自动迁移管理器由BalanceMgr管理；手动迁移管理器由api调用触发：</li><li>DiskDropMgr：下线磁盘管理器，负责；</li><li>RepairMgr：shard修复任务管理器，管理下发shardreapirmsg task;</li><li>InspectMgr: 巡检管理器, 巡检vol，发现坏的blob时，给mqproxy发送<code>ShardRepairMsg</code>；</li></ul></li><li>启动时，先根据配置文件初始化各个管理器 ，再从mongo中加载已有的task，最后使各个mgr run起来；</li><li>scheduler内置service table, tinker和worker组件在启动时，会将自身注册到scheduler的service table中；</li><li>各管理器生成task，并插入到相应的mongdb task table中；</li><li></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json>  <span class=err>//</span> <span class=err>scheduler.conf</span>
  <span class=p>{</span>
   <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9800&#34;</span><span class=p>,</span>         <span class=err>#</span> <span class=err>服务端口</span>
   <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>              <span class=err>#</span> <span class=err>集群id</span>
   <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>               <span class=err>#</span> <span class=err>clustermgr地址</span>
     <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:10000&#34;</span><span class=p>]</span>
   <span class=p>},</span>
   <span class=nt>&#34;database&#34;</span><span class=p>:</span> <span class=p>{</span>                 <span class=err>#</span> <span class=err>后台任务相关配置</span>
     <span class=nt>&#34;mongo&#34;</span><span class=p>:</span> <span class=p>{</span>
       <span class=nt>&#34;uri&#34;</span><span class=p>:</span> <span class=s2>&#34;mongodb://127.0.0.1:27017&#34;</span> <span class=err>#</span> <span class=err>mongodb</span> <span class=err>地址</span>
     <span class=p>},</span>
     <span class=nt>&#34;db_name&#34;</span><span class=p>:</span> <span class=s2>&#34;scheduler&#34;</span>      <span class=err>#</span> <span class=err>数据库名</span>
   <span class=p>},</span>
   <span class=nt>&#34;task_archive_store_db&#34;</span><span class=p>:</span> <span class=p>{</span>    <span class=err>#</span> <span class=err>后台任务备份表</span>
     <span class=nt>&#34;mongo&#34;</span><span class=p>:</span> <span class=p>{</span>
       <span class=nt>&#34;uri&#34;</span><span class=p>:</span> <span class=s2>&#34;mongodb://127.0.0.1:27017&#34;</span> <span class=err>#</span> <span class=err>mongodb</span> <span class=err>地址</span>
     <span class=p>},</span>
     <span class=nt>&#34;db_name&#34;</span><span class=p>:</span> <span class=s2>&#34;task_archive_store&#34;</span> <span class=err>#</span> <span class=err>数据库名</span>
   <span class=p>},</span>
   <span class=nt>&#34;log&#34;</span><span class=p>:{</span>                         <span class=err>#</span> <span class=err>运行日志相关配置</span>
     <span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span>                    <span class=err>#</span> <span class=err>0:debug,</span> <span class=err>1:info,</span> <span class=err>2:warn,</span> <span class=err>3:error,</span> <span class=err>4:panic,</span> <span class=err>5:fatal</span>
     <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/scheduler.log&#34;</span> <span class=err>#</span> <span class=err>运行日志文件，会自动轮转</span>
   <span class=p>},</span>
   <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>                    <span class=err>#</span> <span class=err>审计日志相关配置</span>
     <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/scheduler&#34;</span> <span class=err>#</span> <span class=err>审计日志目录</span>
   <span class=p>}</span>
  <span class=p>}</span>
</code></pre></td></tr></table></div></div></div><ul><li>rpc:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// scheduler/startup.go
</span><span class=c1></span>    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/task/acquire&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskAcquire</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/reclaim&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskReclaim</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/cancel&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskCancel</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/complete&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskComplete</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/manual/migrate/task/add&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPManualMigrateTaskAdd</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/inspect/acquire&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPInspectAcquire</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/inspect/complete&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPInspectComplete</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/report&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskReport</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/renewal&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskRenewal</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/balance/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPBalanceTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/repair/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPRepairTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/drop/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPDropTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/manual/migrate/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPManualMigrateTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/stats&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPStats</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/service/list&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceList</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/service/register&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceRegister</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/service/get&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceGet</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/service/delete&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceDelete</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
</code></pre></td></tr></table></div></div></div><h3 id=tinker修补器><a href=#tinker修补器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:tinker修补器 class=headings>Tinker(修补器)</a></h3><ul><li>启动时，将自身注册到<code>scheduler</code>的service服务列表中；</li><li>内置<code>shardRepairMgr</code>, <code>BlobDeleteMgr</code>, 执行shard repair，blob delete任务；</li><li>从kafka mq中消费相应的消息, 并通过rpc通知<code>worker</code>执行相应的任务;</li><li>tinker使用mongodb保存kafka offset和<code>orphanShard</code>;</li><li>rpc:<ul><li>/update/vol:</li><li>/stats:</li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//tinker.conf</span>
<span class=p>{</span>
   <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9700&#34;</span><span class=p>,</span>           <span class=err>#</span> <span class=err>服务端口</span>
   <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span>                 <span class=err>#</span> <span class=err>集群id</span>
   <span class=nt>&#34;database_conf&#34;</span><span class=p>:</span> <span class=p>{</span>              <span class=err>#</span> <span class=err>mongodb相关配置</span>
       <span class=nt>&#34;mongo&#34;</span><span class=p>:</span> <span class=p>{</span>
         <span class=nt>&#34;uri&#34;</span><span class=p>:</span> <span class=s2>&#34;mongodb://127.0.0.1:27017&#34;</span> <span class=err>#</span> <span class=err>mongodb地址</span>
       <span class=p>},</span>
       <span class=nt>&#34;db_name&#34;</span><span class=p>:</span> <span class=s2>&#34;tinker&#34;</span>         <span class=err>#</span> <span class=err>数据库名</span>
   <span class=p>},</span>
   <span class=nt>&#34;shard_repair&#34;</span><span class=p>:{</span>                <span class=err>#</span> <span class=err>数据修补相关配置</span>
        <span class=nt>&#34;broker_list&#34;</span><span class=p>:[</span><span class=s2>&#34;127.0.0.1:9092&#34;</span><span class=p>],</span> <span class=err>#</span> <span class=err>kafka</span> <span class=err>地址</span>
        <span class=nt>&#34;priority_topics&#34;</span><span class=p>:[</span>        <span class=err>#</span> <span class=err>修补主题配置</span>
            <span class=p>{</span>
                 <span class=nt>&#34;priority&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span>     <span class=err>#</span> <span class=err>修复优先级，数值越大优先级越高</span>
                 <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;shard_repair&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
                 <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>  <span class=err>#</span> <span class=err>消费分区</span>
            <span class=p>},</span>
            <span class=p>{</span>
                <span class=nt>&#34;priority&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span>      <span class=err>#</span> <span class=err>修复优先级，数值越大优先级越高</span>
                <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;shard_repair_prior&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
                <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>   <span class=err>#</span> <span class=err>消费分区</span>
             <span class=p>}</span>
        <span class=p>],</span>
        <span class=nt>&#34;fail_topic&#34;</span><span class=p>:{</span>             <span class=err>#</span> <span class=err>修补主题消费配置</span>
             <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;shard_repair_failed&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
             <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>      <span class=err>#</span> <span class=err>消费分区</span>
        <span class=p>}</span>
   <span class=p>},</span>   
    <span class=nt>&#34;blob_delete&#34;</span><span class=p>:{</span>                 <span class=err>#</span> <span class=err>数据删除相关配置</span>
         <span class=nt>&#34;broker_list&#34;</span><span class=p>:[</span><span class=s2>&#34;127.0.0.1:9092&#34;</span><span class=p>],</span> <span class=err>#</span> <span class=err>kafka地址</span>
         <span class=nt>&#34;normal_topic&#34;</span><span class=p>:{</span>          <span class=err>#</span> <span class=err>删除消息消费配置</span>
             <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;blob_delete&#34;</span><span class=p>,</span><span class=err>#</span> <span class=err>主题</span>
             <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>      <span class=err>#</span> <span class=err>消费分区</span>
         <span class=p>},</span>
         <span class=nt>&#34;fail_topic&#34;</span><span class=p>:{</span>            <span class=err>#</span> <span class=err>删除失败消息消费配置</span>
             <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;fail_blob_delete&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
             <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>      <span class=err>#</span> <span class=err>分区</span>
         <span class=p>},</span>
         <span class=nt>&#34;safe_delay_time_h&#34;</span><span class=p>:</span><span class=mi>72</span><span class=p>,</span>   <span class=err>#</span> <span class=err>删除保护期</span>
         <span class=nt>&#34;dellog&#34;</span><span class=p>:{</span>                <span class=err>#</span> <span class=err>删除记录相关配置</span>
             <span class=nt>&#34;dir&#34;</span><span class=p>:</span> <span class=s2>&#34;./delete_log&#34;</span> <span class=err>#</span> <span class=err>删除日志目录</span>
         <span class=p>}</span>
    <span class=p>},</span> 
    <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#</span> <span class=err>clustermgr地址</span>
         <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:10000&#34;</span><span class=p>]</span>
     <span class=p>},</span>
     <span class=nt>&#34;scheduler&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#</span> <span class=err>scheduler服务地址</span>
         <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9800&#34;</span>
     <span class=p>},</span>
     <span class=nt>&#34;service_register&#34;</span><span class=p>:{</span> <span class=err>#</span> <span class=err>自身服务注册信息</span>
         <span class=nt>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;http://127.0.0.1:9700&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>服务地址</span>
         <span class=nt>&#34;idc&#34;</span><span class=p>:</span><span class=s2>&#34;z0&#34;</span> <span class=err>#</span> <span class=err>服务所属机房</span>
     <span class=p>},</span>
     <span class=nt>&#34;log&#34;</span><span class=p>:{</span> <span class=err>#</span> <span class=err>运行日志相关配置</span>
         <span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span> <span class=err>#</span> <span class=err>0:debug,</span> <span class=err>1:info,</span> <span class=err>2:warn,</span> <span class=err>3:error,</span> <span class=err>4:panic,</span> <span class=err>5:fatal</span>
         <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/tinker.log&#34;</span> <span class=err>#</span> <span class=err>运行日志文件，会自动轮转</span>
     <span class=p>},</span>
     <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#</span> <span class=err>审计日志相关配置</span>
         <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/tinker&#34;</span> <span class=err>#</span> <span class=err>审计日志目录</span>
     <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h3 id=worker><a href=#worker class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:worker class=headings>Worker()</a></h3><ul><li><p>执行tinker下发(rpc api)的shard repair, blob delete任务；</p></li><li><p>启动时，将自身注册到<code>scheduler</code>的service 列表中；</p></li><li><p>周期性(默认: 500ms)的从<code>scheduler</code>获取task(调用scheduler rpc：<code>/task/acquire</code>), 并执行task(包括: Repair, Balance, DiskDrop, ManualMigrate, Inspect)；</p></li><li><p>rpc api:</p><ul><li><p>/shard/repair</p></li><li><p>/stats</p></li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json>  <span class=err>//worker.conf</span>
  <span class=p>{</span>
   <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9910&#34;</span><span class=p>,</span>                <span class=err>#</span> <span class=err>服务端口</span>
   <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>                     <span class=err>#</span> <span class=err>集群id</span>
   <span class=nt>&#34;service_register&#34;</span><span class=p>:</span> <span class=p>{</span>                <span class=err>#</span> <span class=err>自身服务consul注册信息</span>
     <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9910&#34;</span><span class=p>,</span>   <span class=err>#</span> <span class=err>服务地址</span>
     <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span>                        <span class=err>#</span> <span class=err>服务所属机房</span>
   <span class=p>},</span>
   <span class=nt>&#34;scheduler&#34;</span><span class=p>:</span> <span class=p>{</span>                       <span class=err>#</span> <span class=err>scheduler服务相关配置</span>
     <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9800&#34;</span>    <span class=err>#</span> <span class=err>服务地址</span>
   <span class=p>},</span>
   <span class=nt>&#34;dropped_bid_record&#34;</span><span class=p>:</span> <span class=p>{</span>              <span class=err>#</span> <span class=err>丢弃blob</span> <span class=err>id原因记录</span>
     <span class=nt>&#34;dir&#34;</span><span class=p>:</span> <span class=s2>&#34;./dropped&#34;</span>                 <span class=err>#</span> <span class=err>记录目录</span>
   <span class=p>},</span>
   <span class=nt>&#34;log&#34;</span><span class=p>:{</span>                              <span class=err>#</span> <span class=err>运行日志相关配置</span>
     <span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span>                         <span class=err>#</span> <span class=err>0:debug,</span> <span class=err>1:info,</span> <span class=err>2:warn,</span> <span class=err>3:error,</span> <span class=err>4:panic,</span> <span class=err>5:fatal</span>
     <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/worker.log&#34;</span>      <span class=err>#</span> <span class=err>运行日志文件，会自动轮转</span>
   <span class=p>},</span>
   <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>                        <span class=err>#</span> <span class=err>审计日志相关配置</span>
     <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/worker&#34;</span>      <span class=err>#</span> <span class=err>审计日志目录</span>
   <span class=p>}</span>
  <span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h3 id=cli><a href=#cli class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:cli class=headings>Cli</a></h3><ul><li><p>cli是blobstore提供的一个命令行工具，用于对blobstore进行管理操作；</p></li><li><p>cli通过<code>access-clinet</code>api 提供和access交互的能力；</p></li><li><p>cli可配置redis来缓存；</p></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//cli.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;access&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;conn_mode&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>                          <span class=err>//4:</span> <span class=err>no</span> <span class=err>timeout</span>
        <span class=nt>&#34;consul_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8500&#34;</span><span class=p>,</span>  <span class=err>//</span>
        <span class=nt>&#34;max_host_retry&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;max_part_retry&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;max_size_put_once&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;priority_addrs&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;http://localhost:9500&#34;</span><span class=p>,</span>
            <span class=s2>&#34;http://127.0.0.1:9500&#34;</span>
        <span class=p>],</span>
        <span class=nt>&#34;service_interval_ms&#34;</span><span class=p>:</span> <span class=mi>0</span>
    <span class=p>},</span>
    <span class=nt>&#34;redis_addrs&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>&#34;127.0.0.1:6379&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;redis_user&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;redis_pass&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;cm_addrs&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>&#34;http://localhost:9998&#34;</span><span class=p>,</span>
        <span class=s2>&#34;http://127.0.0.1:9998&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;verbose&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;vverbose&#34;</span><span class=p>:</span> <span class=kc>false</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h2 id=外部组件><a href=#外部组件 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:外部组件 class=headings>外部组件</a></h2><h3 id=consul><a href=#consul class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:consul class=headings>Consul</a></h3><ul><li>提供cluster信息注册，查询服务；</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// ConsulRegisterPath
</span><span class=c1></span>                   <span class=nx>key</span>                             <span class=nx>value</span>
<span class=nx>clusterMgr</span><span class=p>:</span> <span class=nx>ebs</span><span class=o>/</span><span class=p>&lt;</span><span class=nx>region</span><span class=p>&gt;</span><span class=o>/</span><span class=nx>clusters</span><span class=o>/</span><span class=p>&lt;</span><span class=nx>cluster_id</span><span class=p>&gt;</span> <span class=p>:</span>  <span class=p>&lt;</span><span class=nx>cluster_info</span><span class=p>&gt;</span>
</code></pre></td></tr></table></div></div></div><h3 id=mongodb><a href=#mongodb class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:mongodb class=headings>MongoDB</a></h3><ul><li><p>mongodb用于存储scheduler模块调度信息；</p></li><li></li></ul><div class=table-container><table><thead><tr><th>db</th><th>dafault table</th><th>config key</th><th>说明</th><th>模块</th></tr></thead><tbody><tr><td>scheduler</td><td></td><td>"database:db_name"</td><td></td><td>scheduler.conf</td></tr><tr><td></td><td>balance_tbl</td><td></td><td></td><td></td></tr><tr><td></td><td>disk_drop_tbl</td><td></td><td></td><td></td></tr><tr><td></td><td>repair_tbl</td><td></td><td></td><td></td></tr><tr><td></td><td>inspect_checkpoint_tbl</td><td></td><td></td><td></td></tr><tr><td></td><td>manual_migrate_tbl</td><td></td><td></td><td></td></tr><tr><td></td><td>svr_register_tbl</td><td></td><td></td><td></td></tr><tr><td></td><td>tasks_tbl</td><td></td><td></td><td></td></tr></tbody></table></div><h3 id=kafka><a href=#kafka class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:kafka class=headings>Kafka</a></h3><ul><li><p>用于组件间异步 任务消息传递, mqproxy对其相关操作进行封装；</p></li><li><p>主要用来传递<code>shardRepair</code>和<code>blobDelete</code>两类消息；</p></li><li></li></ul><h3 id=redis><a href=#redis class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:redis class=headings>Redis</a></h3><ul><li><p>为access访问cm volume提供缓存；</p></li><li><p>缓存expires：30-60min;</p></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//redis key
</span><span class=c1></span><span class=nx>GroupVolumeKey</span>   <span class=s>&#34;get-volume-&lt;cvid&gt;&#34;</span>
<span class=nx>RedisVolumeKey</span>   <span class=s>&#34;access/volume/&lt;clusterID&gt;/&lt;vid&gt;&#34;</span>  <span class=nx>Value</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>VolumePly</span><span class=p>{}</span>
</code></pre></td></tr></table></div></div></div><h2 id=参数><a href=#参数 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:参数 class=headings>参数</a></h2><h3 id=blobnode-1><a href=#blobnode-1 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:blobnode-1 class=headings>BlobNode</a></h3><ul><li><p>一个disk默认最多chunk数<code>DefaultMaxChunks</code>：8192;</p></li><li><p>一个chunk默认最大size<code>DefaultMaxChunk</code>: 1TiB;</p></li><li><p>默认chunk size<code>DefaultChunkSize</code>：16GiB;</p></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//blobnode/core/config.go
</span><span class=c1></span>
    <span class=nx>DefaultDiskReservedSpaceB</span>           <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>60</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=c1>// 60 GiB
</span><span class=c1></span>    <span class=nx>DefaultChunkSize</span>                    <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>16</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=c1>// 16 GiB
</span><span class=c1></span>    <span class=nx>DefaultMaxChunks</span>                    <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>13</span><span class=p>)</span>  <span class=c1>// 8192
</span><span class=c1></span>    <span class=nx>DefaultChunkReleaseProtectionM</span>      <span class=p>=</span> <span class=mi>1440</span>            <span class=c1>// 1 days
</span><span class=c1></span>    <span class=nx>DefaultChunkGcCreateTimeProtectionM</span> <span class=p>=</span> <span class=mi>1440</span>            <span class=c1>// 1 days
</span><span class=c1></span>    <span class=nx>DefaultChunkGcModifyTimeProtectionM</span> <span class=p>=</span> <span class=mi>1440</span>            <span class=c1>// 1 days
</span><span class=c1></span>    <span class=nx>DefaultChunkCompactIntervalSec</span>      <span class=p>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>60</span>         <span class=c1>// 10 min
</span><span class=c1></span>    <span class=nx>DefaultChunkCleanIntervalSec</span>        <span class=p>=</span> <span class=mi>60</span>              <span class=c1>// 1 min
</span><span class=c1></span>    <span class=nx>DefaultDiskUsageIntervalSec</span>         <span class=p>=</span> <span class=mi>60</span>              <span class=c1>// 1 min
</span><span class=c1></span>    <span class=nx>DefaultDiskCleanTrashIntervalSec</span>    <span class=p>=</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span>         <span class=c1>// 60 min
</span><span class=c1></span>    <span class=nx>DefaultDiskTrashProtectionM</span>         <span class=p>=</span> <span class=mi>2880</span>            <span class=c1>// 2 days
</span><span class=c1></span>    <span class=nx>DefaultCompactBatchSize</span>             <span class=p>=</span> <span class=mi>1024</span>            <span class=c1>// 1024 counts
</span><span class=c1></span>    <span class=nx>DefaultCompactMinSizeThreshold</span>      <span class=p>=</span> <span class=mi>16</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span>  <span class=c1>// 16 GiB
</span><span class=c1></span>    <span class=nx>DefaultCompactTriggerThreshold</span>      <span class=p>=</span> <span class=mi>1</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>40</span><span class=p>)</span>   <span class=c1>// 1 TiB
</span><span class=c1></span>    <span class=nx>DefaultMetricReportIntervalS</span>        <span class=p>=</span> <span class=mi>30</span>              <span class=c1>// 30 Sec
</span><span class=c1></span>    <span class=nx>DefaultCompactEmptyRateThreshold</span>    <span class=p>=</span> <span class=nb>float64</span><span class=p>(</span><span class=mf>0.8</span><span class=p>)</span>    <span class=c1>// 80% rate
</span><span class=c1></span>
<span class=c1>// blobnode/core/disk/disk.go
</span><span class=c1></span>    <span class=nx>MaxChunkSize</span>    <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>1024</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=c1>// 1024 GiB, 一个disk chunk最大size，
</span><span class=c1></span>
<span class=c1>// access config
</span><span class=c1></span><span class=nx>defaultMaxObjectSize</span> <span class=kt>int64</span> <span class=p>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>30</span><span class=p>)</span>  <span class=c1>//单个object最大put大小；
</span></code></pre></td></tr></table></div></div></div><h2 id=关键流程><a href=#关键流程 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:关键流程 class=headings>关键流程</a></h2><h3 id=创建卷createvolume><a href=#创建卷createvolume class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:创建卷createvolume class=headings>创建卷(CreateVolume)</a></h3><ul><li><p><code>ClusterMgr</code>启动后，会根据配置为每种ec策略预先创建一定数量的Volume用于分配；</p></li><li><p>入口为clusterMgr中volumeMgr的<code>createVolume()</code>函数；</p></li><li><p>先通过<code>scopMgr.Alloc</code> 分配一个新vid;</p></li><li><p>根据mode获取unitCount(为tactic的N+M+L);</p></li><li><p>初始化volume units信息vuInfos；</p></li><li><p>初始化volInfo；</p></li><li><p>通过raft执行initCreateVolume指令，将volume信息记录到transitedTable中；</p></li><li><p>通过<code>allocChunkForAllUnits</code>为vol所有的units分配chunk;</p><ul><li><p>allocChunkForAllUnits会根据vol的编码策略，将chunk随机分布到不同idc上；</p></li><li><p>通过blobnode ChunkCreate rpc调用在blobnode上创建chunk;</p></li></ul></li><li><p>通过raft执行CreateVolume指令，删除transitedTbl中的volume units，将volume units相关信息记录到volumeTbl中 ；</p></li></ul><h3 id=写入put><a href=#写入put class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:写入put class=headings>写入(Put)</a></h3><ul><li><p>put提供将数据写入到blobstore中的能力；</p></li><li></li></ul><p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-44-35-2022-02-08-10-44-24-image.png alt></p><p>Put流程从access-client中的<code>Put()</code>方法开始：</p><h4 id=access-client-1><a href=#access-client-1 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:access-client-1 class=headings>access-client</a></h4><ul><li><p>access-client <code>Put()</code>流程：</p><ul><li><p>根据数据判断，如果size == 0， 返回空location；</p></li><li><p>Size &lt;= MaxSizePutOnec(默认：256MB) ，通过<code>putObject()</code>单个对象上传；</p></li><li><p>否则，通过<code>putParts</code>分块上传：</p></li></ul></li><li><p>putObject流程：</p><ul><li><p>数据size小于PutOnce缓存(默认: 8MB)，把数据一次读入buffer中；</p></li><li><p>调用access put rpc将数据put上去；</p></li><li><p>返回location;</p></li></ul></li><li><p>putParts流程：</p><ul><li><p>通过rpc 从access中alloc一个location和tokens</p></li><li><p>启动一个后台goroutine，将数据按<code>config.PartConcurrenc（默认：4）</code>读取到buffer中；</p></li><li><p>将buffer中的数据增加token，cid，vid等相关信息组装为一个parts；</p></li><li><p>通过<code>putPartsBatch</code>将parts批量上传；</p></li></ul></li></ul><h4 id=access><a href=#access class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:access class=headings>access</a></h4><ul><li><p>access put rpc的入口为<code>service.Put</code>, 其处理流程如下：</p><ul><li><p>ParseArgs(args)解析参数；</p></li><li><p>args.IsValid()判断参数是否有效；</p></li><li><p>根据args中的hashes设置hasherMap;</p></li><li><p>调用<code>streamHandler.Put()</code></p></li><li><p>通过hasherMap计算返回的hashSumMap;</p></li></ul></li><li><p>stream_put Put()流程：</p><ul><li><p>如果size>maxObjectSize(默认：256MB), 返回错误；</p></li><li><p>如果hasherMap个数>0; 复制一个reader用于计算hash；</p></li><li><p>调用SelectCodeMode(size)，根据大小选择一个合适的纠删码策略；</p></li><li><p>根据access配置<code>MaxBlobSize</code>，设置blobSize(默认: 4MB)；</p></li><li><p>调用<code>allocFromAllocatorWithHystrix()</code>, 根据纠删码、size, blobSize，从allocator分配<code>clusterID,blobs</code>, blob个数由size, blobSize计算而来；</p></li><li><p>根据要读取blob的大小和纠删码策略，在编码器encoder中<code>ec.NewBuffer()</code>一块ec.Buffer；</p></li><li><p>通过<code>ec.Split()</code>将ec.Buffer中数据缓存切分为对应编码的<code>shards</code>;</p></li><li><p>依次处理各个blob：</p><ul><li><p>读取blob数据填充到ec.Buffer的dataBuf中；</p></li><li><p>调用对应编码器的<code>Encode()</code>将shards进行编码；</p></li><li><p>通过<code>writeToBlobnodesWithHystrix()</code>将shards写入到blobnode中；</p></li><li><p>如果有写入出错的个数>0, 则调用<code>RepairMsgBg()</code>，往<code>mqproxy</code>发送repair消息<code>sendRepairMsgBg</code>；</p></li></ul></li><li><p>上传过程如果不成功，通过<code>clearGarbage()</code>清理无用垃圾数据；</p></li></ul></li><li><p><code>ec.NewBuffer()</code>建立编码缓冲区流程：</p><ul><li><p>根据dataSize和编码策略数据分片数shardN，计算每个分片的大小<code>shardSize=(dataSize+shardN-1)/shardN</code>;</p></li><li><p>根据分片大小shardSize和策略参数，计算编码总缓冲大小<code>ecSize=shardSize*(N+M+L)</code>;</p></li><li><p>从内存池中申请ecSize大小的缓存buf；</p></li><li><p>根据参数设置buf中的不同部分；</p></li><li><p>返回设置好的Buffer；</p></li></ul></li><li><p><code>writeToBlobnodes()</code>数据写入到blobnode流程：</p><ul><li>根据clusterID、vid参数获取volume；</li><li>获取volume中的ec相关参数(包括：tactic，putQuorum等)；</li><li>根据volume中的units, 开启goroutine，通过<code>h.blobnodeClient.PutShard()</code>往blobnode节点同时发送写入shard请求；</li><li>等待请求发送完后，如果写入成功的个数<code>writtenNum>=putQuorum</code>成功写入标准()，则写入成功；</li><li>否则, 判断当AZCount >=3时，如果一个AZ down掉，判断剩下的AZ是否每个shard都写入成功，如果是，则也可以判断写入成功；</li><li>否则写入不成功，返回错误；</li></ul></li></ul><h4 id=blobnode-2><a href=#blobnode-2 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:blobnode-2 class=headings>blobnode</a></h4><ul><li><p>blobnode <code>ShardPut_()</code>:</p><ul><li>ShardPut_接收<code>access</code>节点发送的PutShard Rpc调用，执行shard put 写入shard数据操作；</li></ul></li><li><p>datafile Write():</p><ul><li><p>根据<code>Shard.Size</code>大小， 计算(Alignphysize)写入到chunkfile中的编码后物理大小phySize(Shard 包含header，footer和block crc)；</p></li><li><p>根据phySize在datafile中分配待写入空间(allocSpace), 更新变量(cd.wOff)写入偏移(偏移需和4k对齐),并获取旧的(cd.wOff)作为<code>shard.Offset</code>本次shard写入偏移；</p></li><li><p>写入shard header数据到chunk file；</p></li><li><p><code>crc32block.NewEncoder</code>新建一个crc编码写入器，通过编码器将数据编码，并写入到chunkfile的shard header数据区后面；</p></li><li><p>写入shard footer数据到 chunk file；</p></li><li></li></ul></li></ul><h3 id=读取get><a href=#读取get class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:读取get class=headings>读取(Get)</a></h3><p><img src=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-45-04-2022-02-08-10-44-59-image.png alt></p><h4 id=access-client-2><a href=#access-client-2 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:access-client-2 class=headings>access-client</a></h4><ul><li><p>access-client 中get入口为<code>api/access/client.go (c *client)Get()</code>；</p></li><li><p>先检查get参数有效性，如果size 为0，直接返回空；</p></li><li><p>然后随机顺序向多个access发送get rpc请求，返回第一个成功的请求；</p></li></ul><h4 id=access-1><a href=#access-1 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:access-1 class=headings>access</a></h4><ul><li><p>access 由<code>access/stream_get.go （h *Handler)Get()</code>负责get rpc 入口；</p></li><li><p>先调用<code>genLocationBlobs</code>根据参数<code>location,offset,readSize</code>获取location中需要读取的blobs；</p></li><li><p>在根据location获取clusterMgr controller sc;</p></li><li><p>如果<code>len(blobs)== 1</code>, 如果大小较小，直接调用<code>getDataShardOnly()</code>读取blob数据；</p></li><li><p>开启一个后台协程，依次通过<code>readOneBlob</code>从blobnode读取blobs中的每个blob的数据，通过chan传送个主流程</p></li><li><p>主流程依次接收读取的数据，并写入到get结果的buffer中；</p></li><li><p>读取一个blob数据<code>access/readOneBlob()</code>:</p><ul><li><p>根据BlobSize和编码策略，分配一块新的EC buffer<code>GetBufferSizes()</code>；</p></li><li><p>// 1. try to min-read shards byte</p></li><li><p>// 2. if failed try to read next shard to reconstruct</p></li><li><p> // 3. write the the right offset bytes to writer</p></li></ul></li></ul><h4 id=blobnode-3><a href=#blobnode-3 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:blobnode-3 class=headings>blobnode</a></h4><ul><li><p>ShardGet_:</p></li><li></li></ul><h3 id=删除delete><a href=#删除delete class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:删除delete class=headings>删除(Delete)</a></h3><ul><li><p>删除调用了punch hole来是否被删除的data；</p></li><li><p>通过compact异步对碎片化过多的chunkfile进行整理；</p></li></ul><h3 id=合并compact><a href=#合并compact class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:合并compact class=headings>合并(Compact)</a></h3><ul><li><p>compact用于在后台整理chunkfile，由blobnode提供了rpc api；</p></li><li><p>chunkfile 是否需要compact（<code>NeedCompact</code>）:</p><ul><li>chunk file size >= <code>conf.CompactTriggerThredshold(默认：1TiB)</code>，return true；</li><li>chunk file size > <code>conf.CompactMinSizeThreshold(默认: 16GB)</code>且chunkfile 稀疏率>=80%(<code>CompactEnptyRateThreshold</code>参数);</li></ul></li><li><p>blobnode/core/chunk/chunk.doCompact():</p></li></ul><h3 id=iotype><a href=#iotype class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:iotype class=headings>IOType</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go>    <span class=nx>NormalIO</span>     <span class=nx>IOType</span> <span class=p>=</span> <span class=kc>iota</span> <span class=c1>// From: external: user io: read/write
</span><span class=c1></span>    <span class=nx>BackgroundIO</span>               <span class=c1>// From: external: repair, chunk transfer, delete
</span><span class=c1></span>    <span class=nx>CompactIO</span>                  <span class=c1>// From: internal: chunk compact
</span><span class=c1></span>    <span class=nx>DeleteIO</span>                   <span class=c1>// From: external: delete io
</span><span class=c1></span>    <span class=nx>InternalIO</span>                 <span class=c1>// From: internal: io, such rubbish clean, batch delete
</span></code></pre></td></tr></table></div></div></div><h2 id=安全><a href=#安全 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:安全 class=headings>安全</a></h2><ul><li>uptoken</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// token between alloc and putat
</span><span class=c1></span>    <span class=c1>// TokenSize max size of token array
</span><span class=c1></span>    <span class=c1>// clusterID + vid + bid + count + time + size
</span><span class=c1></span>    <span class=nx>TokenSize</span> <span class=p>=</span> <span class=mi>4</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>+</span> <span class=mi>10</span> <span class=o>+</span> <span class=mi>5</span> <span class=o>+</span> <span class=mi>5</span> <span class=o>+</span> <span class=mi>5</span>

<span class=c1>// UploadToken token between alloc and putat
</span><span class=c1>// [0:8]   hmac (8) first 8 bytes of sha1 summary
</span><span class=c1>// [8:16]  minBid (8) in the SliceInfo
</span><span class=c1>// [16:20] count (4) in the SliceInfo
</span><span class=c1>// [20:24] time (4) expired unix utc time, 0 means not expired
</span><span class=c1></span><span class=kd>type</span> <span class=nx>UploadToken</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Data</span>   <span class=p>[</span><span class=nx>TokenSize</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>Offset</span> <span class=kt>uint8</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h2 id=参考><a href=#参考 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:参考 class=headings>参考</a></h2><ol><li><p><a href=https://cubefs.readthedocs.io/zh_CN/latest/design/blobstore.html target=_blank rel=noopener>https://cubefs.readthedocs.io/zh_CN/latest/design/blobstore.html</a></p></li><li><p><a href=https://www.cnblogs.com/itlz/p/14090193.html target=_blank rel=noopener>详解Hadoop3.x新特性功能-HDFS纠删码 - 五分钟学大数据 - 博客园</a></p></li><li><p><a href="https://blog.csdn.net/shelldon/article/details/54144730?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_default&utm_relevant_index=1" target=_blank rel=noopener>Erasure Code - EC纠删码原理_shelldon的专栏-CSDN博客_ec纠删码</a></p></li></ol></div><ul class=post-copyright><li class="copyright-item author"><span class=copyright-item-text>作者</span>：<a href=https://io-oi.me/ class="p-author h-card" target=_blank rel=noopener>Justice</a></li><li class="copyright-item link"><span class=copyright-item-text>链接</span>：<a href=/post/40.storage/chubaofs/cubefs-blobstore/ target=_blank rel=noopener>https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/</a></li><li class="copyright-item license"><span class=copyright-item-text>许可</span>：<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></li></ul></article><div class=updated-badge-container><span title="Updated @ 2024-05-05 03:28:47 UTC" style=cursor:help><svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2024-05-05</text><text x="915" y="140" textLength="650" transform="scale(.1)">2024-05-05</text></g></svg></span></div><div class=post-share><div class=share-items><div class="share-item facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&hashtag=%23storage" title=分享到「Facebook」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a></div><div class="share-item mastodon"><a href="/fedishare.html#title=CubeFS-BlobStore&description=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6&url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/" title=分享到「Mastodon」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon mastodon-icon"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></a></div><div class="share-item fediverse"><a href="/fedishare.html#title=CubeFS-BlobStore&description=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6&url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/" title=分享到「Fediverse」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="64 163 873 873" class="icon fediverse-icon"><defs><linearGradient id="fediverse-gradient"><stop offset="0" stop-color="#ff0101"/><stop offset="10%" stop-color="#9501ff"/><stop offset="50%" stop-color="#ffca01"/><stop offset="75%" stop-color="#01a3ff"/><stop offset="100%" stop-color="#65ff01"/></linearGradient></defs><path d="M539 176q-32 0-55 22t-25 55 20.5 58 56 27 58.5-20.5 27-56-20.5-59T544 176h-5zm-87 95-232 118q20 20 25 48l231-118q-19-20-24-48zm167 27q-13 25-38 38l183 184q13-25 39-38zM477 320 342 585l40 40 143-280q-28-5-48-25zm104 16q-22 11-46 10l-8-1 21 132 56 9zM155 370q-32 0-55 22.5t-25 55 20.5 58 56.5 27 59-21 26.5-56-21-58.5-55.5-27h-6zm90 68q1 9 1 18-1 19-10 35l132 21 26-50zm225 36-26 51 311 49q-1-8-1-17 1-19 10-36zm372 6q-32 1-55 23t-24.5 55 21 58 56 27 58.5-20.5 27-56.5-20.5-59-56.5-27h-6zM236 493q-13 25-39 38l210 210 51-25zm-40 38q-21 11-44 10l-9-1 40 256q21-10 45-9l8 1zm364 22 48 311q21-10 44-9l10 1-46-294zm195 23-118 60 8 56 135-68q-20-20-25-48zm26 49-119 231q28 5 48 25l119-231q-28-5-48-25zM306 654l-68 134q28 5 48 25l60-119zm262 17-281 143q19 20 24 48l265-135zM513 771l-51 25 106 107q13-25 39-38zM222 795q-32 0-55.5 22.5t-25 55 21 57.5 56 27 58.5-20.5 27-56-20.5-58.5-56.5-27h-5zm89 68q2 9 1 18-1 19-9 35l256 41q-1-9-1-18 1-18 10-35zm335 0q-32 0-55 22.5t-24.5 55 20.5 58 56 27 59-21 27-56-20.5-58.5-56.5-27h-6z"/></svg></a></div><div class="share-item twitter"><a href="https://twitter.com/share?url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&text=CubeFS-BlobStore&hashtags=storage,chubaofs,&via=reuixiy" title=分享到「Twitter」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a></div><div class="share-item linkedin"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&title=CubeFS-BlobStore&summary=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6&source=Justice%27s%20Site" title=分享到「LinkedIn」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div><div class="share-item telegram"><a href="https://t.me/share/url?url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&text=CubeFS-BlobStore" title=分享到「Telegram」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a></div><div class="share-item weibo"><a href="https://service.weibo.com/share/share.php?&url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&title=CubeFS-BlobStore&pic=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png&searchPic=false" title=分享到「新浪微博」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon weibo-icon"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7.0 395.3.0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></a></div><div class="share-item douban"><a href="https://www.douban.com/share/service?href=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&name=CubeFS-BlobStore&text=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6" title=分享到「豆瓣」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon douban-icon"><path d="M.643.92v2.412h22.714V.92H.643zm1.974 4.926v9.42h18.764v-9.42H2.617zm2.72 2.408H18.69v4.605H5.338V8.254zm1.657 7.412-2.512.938c1.037 1.461 1.87 2.825 2.512 4.091H0v2.385h24v-2.385h-6.678c.818-1.176 1.589-2.543 2.303-4.091l-2.73-.938a29.952 29.952.0 01-2.479 5.03h-4.75c-.786-1.962-1.677-3.641-2.672-5.03z"/></svg></a></div><div class="share-item qq"><a href="https://connect.qq.com/widget/shareqq/index.html?url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&title=CubeFS-BlobStore&summary=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6&pics=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png&site=Justice%27s%20Site" title=分享到「QQ」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741.0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792.0.0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a></div><div class="share-item qzone"><a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&title=CubeFS-BlobStore&summary=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6&pics=https://raw.githubusercontent.com/ZhuZhengyi/notebook-images/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png&site=Justice%27s%20Site" title="分享到「QQ 空间」" target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon qzone-icon"><path d="M23.985 9.202c-.032-.099-.127-.223-.334-.258-.207-.036-7.351-1.406-7.351-1.406s-.105-.022-.198-.07c-.092-.047-.127-.167-.127-.167S12.447.956 12.349.77C12.25.583 12.104.532 12 .532s-.251.051-.349.238c-.098.186-3.626 6.531-3.626 6.531s-.035.12-.128.167c-.092.047-.197.07-.197.07S.556 8.908.348 8.943c-.208.036-.302.16-.333.258a.477.477.0 00.125.449l5.362 5.49s.072.08.119.172c.016.104.005.21.005.21s-1.189 7.242-1.22 7.45.075.369.159.43c.083.062.233.106.421.013.189-.093 6.812-3.261 6.812-3.261s.098-.044.201-.061.201.061.201.061 6.623 3.168 6.812 3.261c.188.094.338.049.421-.013a.463.463.0 00.159-.43c-.021-.14-.93-5.677-.93-5.677.876-.54 1.425-1.039 1.849-1.747-2.594.969-6.006 1.717-9.415 1.866-.915.041-2.41.097-3.473-.015-.678-.071-1.17-.144-1.243-.438-.053-.215.054-.46.545-.831a2640.5 2640.5.0 012.861-2.155c1.285-.968 3.559-2.47 3.559-2.731.0-.285-2.144-.781-4.037-.781-1.945.0-2.275.132-2.811.168-.488.034-.769.005-.804-.138-.06-.248.183-.389.588-.568.709-.314 1.86-.594 1.984-.626.194-.052 3.082-.805 5.618-.535 1.318.14 3.244.668 3.244 1.276.0.342-1.721 1.494-3.225 2.597-1.149.843-2.217 1.561-2.217 1.688.0.342 3.533 1.241 6.689 1.01l.003-.022c.048-.092.119-.172.119-.172l5.362-5.49a.477.477.0 00.127-.449z"/></svg></a></div><div class="share-item pocket"><a href="https://getpocket.com/edit.php?url=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/" title=分享到「Pocket」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon pocket-icon"><path d="M407.6 64h-367C18.5 64 0 82.5.0 104.6v135.2C0 364.5 99.7 464 224.2 464c124 0 223.8-99.5 223.8-224.2V104.6c0-22.4-17.7-40.6-40.4-40.6zm-162 268.5c-12.4 11.8-31.4 11.1-42.4.0C89.5 223.6 88.3 227.4 88.3 209.3c0-16.9 13.8-30.7 30.7-30.7 17 0 16.1 3.8 105.2 89.3 90.6-86.9 88.6-89.3 105.5-89.3 16.9.0 30.7 13.8 30.7 30.7.0 17.8-2.9 15.7-114.8 123.2z"/></svg></a></div><div class="share-item hackernews"><a href="https://news.ycombinator.com/submitlink?u=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/&t=CubeFS-BlobStore" title="分享到Hacker News" target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon hackernews-icon"><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4.0.1.0.3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></a></div><div class="share-item qrcode"><div class=qrcode-container title=通过「二维码」><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id=qrcode-img></div></div><script src=https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js></script>
<script>const typeNumber=0,errorCorrectionLevel='L',qr=qrcode(typeNumber,errorCorrectionLevel);qr.addData('https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/'),qr.make(),document.getElementById('qrcode-img').innerHTML=qr.createImgTag()</script></div><div class="share-item email"><a href="mailto:?subject=CubeFS-BlobStore&body=CubeFS-BlobStore%20%e7%ae%80%e4%bb%8b%20CubeFS-BlobStore%e6%98%af%e4%b8%80%e4%b8%aa%e9%ab%98%e5%8f%af%e9%9d%a0%e3%80%81%e9%ab%98%e5%8f%af%e7%94%a8%e3%80%81%e4%bd%8e%e6%88%90%e6%9c%ac%e3%80%81%e6%94%af%e6%8c%81%e8%b6%85%e5%a4%a7%e8%a7%84%e6%a8%a1%28E%e2%80%a6%e2%80%a6%0Ahttps://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/" title=通过「电子邮件」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon email-icon"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a></div></div></div><div class=related-posts><h2 class=related-title>相关文章：<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6.0-12-5.4-12-12v-92h-92c-6.6.0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6.0 12 5.4 12 12v92h92c6.6.0 12 5.4 12 12v56z"/></svg></h2><ul class=related-list><li class=related-item><a href=/post/40.storage/chubaofs/chubaofs-metanode/ class=related-link>ChubaoFS MetaNode</a></li><li class=related-item><a href=/post/40.storage/chubaofs/chubaofs-vs-nfs%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/ class=related-link>ChubaoFS vs NFS 性能对比测试</a></li><li class=related-item><a href=/post/40.storage/chubaofs/chubaofs-%E5%9F%BA%E7%A1%80/ class=related-link>ChubaoFS 基础</a></li><li class=related-item><a href=/post/40.storage/chubaofs/chubaofs-s3/ class=related-link>chubaofs-s3</a></li><li class=related-item><a href=/post/40.storage/chubaofs/chubaofs-datanode/ class=related-link>ChubaoFS DataNode</a></li></ul></div><div class=post-tags><a href=/tags/storage/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>storage</a>
<a href=/tags/chubaofs/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>chubaofs</a></div><ul class=post-nav><li class=post-nav-prev><a href=/post/21.linux/cpu%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ rel=prev>&lt; CPU基础</a></li><li class=post-nav-next><a href=/post/30.architech/delta-lake/ rel=next>Delta Lake ></a></li></ul><div id=utterances></div></div></main><script>let indexURL="https://justice.bj.cn/index.json",includeSectionsInSearch=["post"],search_no_results="0 results for",search_initial_message=""</script><div class="search-modal dark" aria-hidden=true style=--color-primary:#7f0ec6><div data-target=close-search-modal class=search-modal-overlay></div><div class=search-wrapper data-image=true data-description=true data-tags=true data-categories=true><div class=search-wrapper-header><label for=search-modal-input style=margin-top:-1px><span class=sr-only>search icon</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-icon" data-type="search"><path fill="currentcolor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-reset" data-type="reset"><path fill="currentcolor" d="M256 512A256 256 0 10256 0a256 256 0 100 512zM175 175c9.4-9.4 24.6-9.4 33.9.0l47 47 47-47c9.4-9.4 24.6-9.4 33.9.0s9.4 24.6.0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6.0 33.9s-24.6 9.4-33.9.0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9.0s-9.4-24.6.0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6.0-33.9z"/></svg></label>
<input id=search-modal-input type=text data-search-input autocomplete=off aria-label=Search placeholder></div><div class=search-wrapper-body><div class=search-result data-search-result></div><span class=search-result-empty></span></div><div class=search-wrapper-footer><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" viewBox="0 0 16 16"><path d="M3.204 11h9.592L8 5.519 3.204 11zm-.753-.659 4.796-5.48a1 1 0 011.506.0l4.796 5.48c.566.647.106 1.659-.753 1.659H3.204a1 1 0 01-.753-1.659z"/></svg></kbd><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" style="margin-top:1px" viewBox="0 0 16 16"><path d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 001.506.0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 00-.753 1.659z"/></svg></kbd>to navigate</span>
<span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentcolor" style="display:inline-block" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M14.5 1.5a.5.5.0 01.5.5v4.8a2.5 2.5.0 01-2.5 2.5H2.707l3.347 3.346a.5.5.0 01-.708.708l-4.2-4.2a.5.5.0 010-.708l4-4a.5.5.0 11.708.708L2.707 8.3H12.5A1.5 1.5.0 0014 6.8V2a.5.5.0 01.5-.5z"/></svg></kbd>to select</span>
<span class=search-result-info></span>
<span data-target=close-search-modal><kbd>ESC</kbd> to close</span></div></div></div><template id=search-result-item-template><div class=search-result-item>#{ isset image }<div class=search-result-item-image>#{image}</div>#{ end }<div class=search-result-item-body><a href=#{slug} class=search-result-item-title>#{title}</a>
#{ isset description }<p class=search-result-item-description>#{description}</p>#{ end }<p class=search-result-item-content>#{content}</p><div class=search-result-item-taxonomies>#{ isset categories }<div><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" viewBox="0 0 16 16" style="margin-top:-2px"><path d="M11 0H3A2 2 0 001 2v12a2 2 0 002 2h8a2 2 0 002-2 2 2 0 002-2V4a2 2 0 00-2-2 2 2 0 00-2-2zm2 3a1 1 0 011 1v8a1 1 0 01-1 1V3zM2 2a1 1 0 011-1h8a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V2z"/></svg>#{categories}</div>#{ end }
#{ isset tags }<div><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" viewBox="0 0 16 16"><path d="M3 2v4.586l7 7L14.586 9l-7-7H3zM2 2a1 1 0 011-1h4.586a1 1 0 01.707.293l7 7a1 1 0 010 1.414l-4.586 4.586a1 1 0 01-1.414.0l-7-7A1 1 0 012 6.586V2z"/><path d="M5.5 5a.5.5.0 110-1 .5.5.0 010 1zm0 1a1.5 1.5.0 100-3 1.5 1.5.0 000 3zM1 7.086a1 1 0 00.293.707L8.75 15.25l-.043.043a1 1 0 01-1.414.0l-7-7A1 1 0 010 7.586V3a1 1 0 011-1v5.086z"/></svg>#{tags}</div>#{ end }</div></div></div></template><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;1969–2024&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Justice</div><div class=powered-by>Powered by <a href=https://github.com/gohugoio/hugo target=_blank rel=noopener>Hugo</a> | Theme is <a href=https://github.com/reuixiy/hugo-theme-meme target=_blank rel=noopener>MemE</a></div><div class=site-copyright><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></div><ul class=socials><li class=socials-item><a href=/rss.xml target=_blank rel="external noopener" title=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li><li class=socials-item><a href=mailto:reuixiy@gmail.com target=_blank rel="external noopener" title=Email><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></a></li><li class=socials-item><a href=https://github.com/reuixiy target=_blank rel="external noopener" title=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a></li><li class=socials-item><a href=https://twitter.com/reuixiy target=_blank rel="external noopener" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a></li><li class=socials-item><a href=https://t.me/yixiuer target=_blank rel="external noopener" title=Telegram><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon social-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a></li></ul></div></footer></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css><script>if(typeof renderMathInElement=='undefined'){const a=b=>{const a=document.createElement('script');a.defer=!0,a.crossOrigin='anonymous',Object.keys(b).forEach(c=>{a[c]=b[c]}),document.body.appendChild(a)};a({src:'https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js',onload:()=>{a({src:'https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/mhchem.min.js',onload:()=>{a({src:'https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js',onload:()=>{renderKaTex()}})}})}})}else renderKaTex();function renderKaTex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})}</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){const a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script>
<script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(a=>{a.parentElement.outerHTML=`<div class="mermaid">${a.innerText}</div>`});const mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script>function loadComments(){(function(){const b=document.getElementById("utterances");if(!b)return;const a=document.createElement('script');a.src='https://utteranc.es/client.js',a.async=!0,a.crossOrigin='anonymous',a.setAttribute('repo','ZhuZhengyi/gh_comment'),a.setAttribute('issue-term','pathname');const c=getCurrentTheme()==='dark';c?a.setAttribute('theme','photon-dark'):a.setAttribute('theme','github-light'),b.appendChild(a)})()}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script>
<script>let imgNodes=document.querySelectorAll('div.post-body img');imgNodes=Array.from(imgNodes).filter(a=>a.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>