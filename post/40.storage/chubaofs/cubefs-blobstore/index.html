<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>CubeFS-BlobStore - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(EB)的分布式存储系统。 采用纠删码中的Reed-Solom">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.2f6e4d7e6e51da09470910b5f0d41a7d2c517dbe97416dd268a18bb7334c4ff8.css integrity="sha256-L25Nfm5R2glHCRC18NQafSxRfb6XQW3SaKGLtzNMT/g=" media=screen crossorigin=anonymous>
<meta property="og:title" content="CubeFS-BlobStore">
<meta property="og:description" content="CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(EB)的分布式存储系统。 采用纠删码中的Reed-Solom">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/40.storage/chubaofs/cubefs-blobstore/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2022-03-07T00:00:00+00:00">
<meta property="article:modified_time" content="2022-03-07T00:00:00+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="CubeFS-BlobStore">
<meta itemprop=description content="CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(EB)的分布式存储系统。 采用纠删码中的Reed-Solom"><meta itemprop=datePublished content="2022-03-07T00:00:00+00:00">
<meta itemprop=dateModified content="2022-03-07T00:00:00+00:00">
<meta itemprop=wordCount content="12579">
<meta itemprop=keywords content="storage,chubaofs,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="CubeFS-BlobStore">
<meta name=twitter:description content="CubeFS-BlobStore 简介 CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(EB)的分布式存储系统。 采用纠删码中的Reed-Solom"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='002186711602136249422:q1gkomof_em',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>CubeFS-BlobStore</h1>
<div class=post-meta>
<time datetime=2022-03-07 class=post-time>
2022-03-07
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/storage/> storage </a>
<a href=https://justice.bj.cn/categories/chubaofs/> chubaofs </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#架构>架构</a></li>
<li><a href=#组件>组件</a></li>
<li><a href=#资源>资源</a></li>
<li><a href=#erasercode>EraserCode</a></li>
<li><a href=#table>Table</a></li>
<li><a href=#组件详情>组件详情</a>
<ul>
<li><a href=#access访问接入点>Access(访问接入点)</a></li>
<li><a href=#allocator资源分配器>Allocator(资源分配器)</a></li>
<li><a href=#clustermgr集群管理器>ClusterMgr(集群管理器)</a></li>
<li><a href=#blobnode>BlobNode</a></li>
<li><a href=#mqproxy消息代理>MQProxy(消息代理)</a></li>
<li><a href=#scheduler任务调度器>Scheduler(任务调度器)</a></li>
<li><a href=#tinker修补器>Tinker(修补器)</a></li>
<li><a href=#worker>Worker()</a></li>
<li><a href=#cli>Cli</a></li>
</ul>
</li>
<li><a href=#外部组件>外部组件</a>
<ul>
<li><a href=#consul>Consul</a></li>
<li><a href=#mongodb>MongoDB</a></li>
<li><a href=#kafka>Kafka</a></li>
<li><a href=#redis>Redis</a></li>
</ul>
</li>
<li><a href=#参数>参数</a>
<ul>
<li><a href=#blobnode-1>BlobNode</a></li>
</ul>
</li>
<li><a href=#关键流程>关键流程</a>
<ul>
<li><a href=#创建卷createvolume>创建卷(CreateVolume)</a></li>
<li><a href=#写入put>写入(Put)</a></li>
<li><a href=#读取get>读取(Get)</a></li>
<li><a href=#删除delete>删除(Delete)</a></li>
<li><a href=#合并compact>合并(Compact)</a></li>
<li><a href=#iotype>IOType</a></li>
</ul>
</li>
<li><a href=#安全>安全</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=cubefs-blobstore>CubeFS-BlobStore</h1>
<h2 id=简介>简介</h2>
<ul>
<li>
<p>CubeFS-BlobStore是一个高可靠、高可用、低成本、支持超大规模(EB)的分布式存储系统。</p>
</li>
<li>
<p>采用纠删码中的Reed-Solomon编码，对比三副本，以更低的存储成本提供更高的数据耐久性保障，支持多种纠删码模式和多可用区部署，</p>
</li>
<li>
<p>同时针对小文件做了专门优化，可满足不同业务场景的存储需求。</p>
</li>
</ul>
<h2 id=架构>架构</h2>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/08-10-42-13-2022-02-08-10-42-09-image.png alt></p>
<h2 id=组件>组件</h2>
<p>blobstore包含如下组件：</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
<th>功能</th>
<th>依赖组件</th>
<th>本地存储</th>
<th>部署</th>
<th>部署数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClusterMgr</td>
<td>集群管理</td>
<td>负责集群管理和卷的生成</td>
<td>consul</td>
<td>有</td>
<td>可跨机房部署，多机房</td>
<td>>=3</td>
</tr>
<tr>
<td>Allocator</td>
<td>集群管理代理</td>
<td>提供数据写入资源id的分配</td>
<td>ClusterMgr</td>
<td>无</td>
<td></td>
<td>>=1</td>
</tr>
<tr>
<td>Access</td>
<td>接入模块</td>
<td>对外提供数据读、写和删除接口</td>
<td>Redis,consul</td>
<td>无</td>
<td>单节点部署，一个机房部署一个，</td>
<td>>=1</td>
</tr>
<tr>
<td>BlobNode</td>
<td>blob存储</td>
<td>提供存储资源</td>
<td>ClusterMgr</td>
<td>有</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Worker</td>
<td>blob任务执行模块</td>
<td>卷修补、迁移和回收任务执行模块</td>
<td>BlobNode，Scheduler</td>
<td>无</td>
<td></td>
<td>>=1</td>
</tr>
<tr>
<td>Scheduler</td>
<td>异步任务调度中心</td>
<td>卷修补、迁移和回收任务的生成和调度</td>
<td>mongodb</td>
<td>无</td>
<td>一个cluster至少一个</td>
<td>>=1</td>
</tr>
<tr>
<td>MQProxy</td>
<td>异步消息代理</td>
<td>修补和删除操作消息保存模块,用于后续异步执行</td>
<td>kafka</td>
<td>无</td>
<td></td>
<td>>=1</td>
</tr>
<tr>
<td>Tinker</td>
<td>后台数据整理管理模块</td>
<td>修补和删除操作异步执行模块</td>
<td>kafka，mongodb</td>
<td>无</td>
<td></td>
<td>>=1</td>
</tr>
<tr>
<td>Cli</td>
<td>cli工具</td>
<td>提供cli管理操作</td>
<td>consul，redis</td>
<td>无</td>
<td></td>
<td>>=</td>
</tr>
<tr>
<td>Consul</td>
<td>注册管理</td>
<td>提供节点、组件注册；</td>
<td></td>
<td></td>
<td></td>
<td>必选</td>
</tr>
<tr>
<td>MongoDB</td>
<td>mongodb</td>
<td>为scheduler提供存储</td>
<td></td>
<td></td>
<td></td>
<td>必须</td>
</tr>
<tr>
<td>Kafaka</td>
<td>消息队列服务</td>
<td>scheduler任务调度消息队列</td>
<td></td>
<td></td>
<td></td>
<td>必须</td>
</tr>
<tr>
<td>Redis</td>
<td>缓存服务</td>
<td>为access,cli访问clustermgr提供缓存加速</td>
<td></td>
<td></td>
<td></td>
<td>可选</td>
</tr>
<tr>
<td>Zookeeper</td>
<td></td>
<td>为kafka提供注册服务</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/28-16-20-30-2022-02-28-16-20-19-image.png alt></p>
<h2 id=资源>资源</h2>
<ul>
<li>
<p><strong>Region(区域)</strong>: 一个region可包含多个cluster；</p>
</li>
<li>
<p><strong>Cluster(集群)</strong>：一个Cluster是由多个相同cluster_id的clustermgr组成，可以提供完整的Blobstore服务的单位。cluster可以跨机房部署，多个跨机房clustermgr通过raft组成一个cluster；</p>
</li>
<li>
<p><strong>Idc(数据中心/机房)</strong>: 一个cluster可以跨多个idc部署；</p>
</li>
<li>
<p><strong>Rack(机架)</strong>：机房内一个机柜; 同一机架内的机器在一个交换机内，可以拥有很低的网络访问延迟和很高的网络带宽；</p>
</li>
<li>
<p><strong>AZ(Available Zone)</strong>：EC 中数据块的有效分区数，一个集群中，AZ的数量要和 IDC个数匹配；</p>
</li>
<li>
<p><strong>Node(节点)</strong>: 对应一台物理机或容器实例；</p>
</li>
<li>
<p><strong>Disk(物理磁盘)</strong>: 一块已格式化好，并被挂载到某一目录的物理磁盘或一个目录；</p>
</li>
<li>
<p><strong>Chunk(数据簇)</strong>：每个Disk的空间被划分为多个Chunk，Chunk对应一个Chunk File；</p>
</li>
<li>
<p><strong>Volume(逻辑卷)</strong>: 逻辑卷是面对用户的存储资源管理抽象视图，一个Volume包含多个Unit；</p>
</li>
<li>
<p><strong>Unit(逻辑卷数据单元)</strong>: 逻辑卷的数据组织单元。Unit主要包含了Vuid和bid两个字段；</p>
</li>
<li>
<p><strong>Location(定位)</strong>：数据在blobstore中的定位，一个location中的数据由多个blob组成；</p>
</li>
<li>
<p><strong>Blob(数据段)</strong>: Blob是location中的一段数据，每个Blob是EC编解码的一个数据块, Blob最大默认:4MB；</p>
</li>
<li>
<p><strong>Shard(数据分片)</strong>：一块Blob数据在ec encode时，根据编码策略，切分成多个分片Shard，每个分片称为一个shard；</p>
</li>
</ul>
<h2 id=erasercode>EraserCode</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// ec参数
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Tactic</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>N</span>         <span class=kt>int</span>   <span class=c1>//数据块个数；
</span><span class=c1></span>    <span class=nx>M</span>         <span class=kt>int</span>   <span class=c1>//校验块个数;
</span><span class=c1></span>    <span class=nx>L</span>         <span class=kt>int</span>   <span class=c1>//LRC中，本地校验块个数；
</span><span class=c1></span>    <span class=nx>AZCount</span>   <span class=kt>int</span>   <span class=c1>//分区个数;
</span><span class=c1></span>    <span class=nx>PutQuorum</span> <span class=kt>int</span>   <span class=c1>//写操作时，最少写成功的数据块个数, 
</span><span class=c1></span>                    <span class=c1>// 为了保证写入时，有一个az挂掉后还能恢复数，最小写入块数必须&gt;=(N+M)/AZCount+N
</span><span class=c1></span>    <span class=nx>GetQuorum</span> <span class=kt>int</span>   <span class=c1>//读操作时，最少读成功的数据块个数;
</span><span class=c1></span>    <span class=nx>MinShardSize</span> <span class=kt>int</span> <span class=c1>//每个数据块最小大小；
</span><span class=c1></span>                     <span class=c1>//当1en(data) &lt; MinShardSize*N, 每个shard大小为MinShardSize, 后面不够的填0
</span><span class=c1></span>                     <span class=c1>//当len(data) &gt; MinShardSize*N, 每个shard大小为[len(data)/N], 后面填0;
</span><span class=c1></span><span class=p>}</span>
<span class=c1>// 定义的ec算法
</span><span class=c1></span><span class=kd>var</span> <span class=nx>constCodeModeTactic</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>CodeMode</span><span class=p>]</span><span class=nx>Tactic</span><span class=p>{</span>
    <span class=nx>EC15P12</span><span class=p>:</span>   <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>24</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P6</span><span class=p>:</span>     <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC16P20L2</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>AZCounect</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>34</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P10L2</span><span class=p>:</span>  <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>14</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>

    <span class=c1>// single az
</span><span class=c1></span>    <span class=nx>EC12P4</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>15</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC16P4</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC3P3</span><span class=p>:</span>  <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC10P4</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>13</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P3</span><span class=p>:</span>  <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=c1>// for env test
</span><span class=c1></span>    <span class=nx>EC6P3L3</span><span class=p>:</span>       <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
    <span class=nx>EC6P6Align0</span><span class=p>:</span>   <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize0B</span><span class=p>},</span>
    <span class=nx>EC6P6Align512</span><span class=p>:</span> <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize512B</span><span class=p>},</span>
    <span class=nx>EC4P4L2</span><span class=p>:</span>       <span class=p>{</span><span class=nx>N</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>M</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=nx>L</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>AZCount</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>PutQuorum</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>GetQuorum</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>MinShardSize</span><span class=p>:</span> <span class=nx>alignSize2KB</span><span class=p>},</span>
<span class=p>}</span>


<span class=c1>//vol layout ep:EC6P10L2
</span><span class=c1>//|----N------|--------M----------------|--L--|
</span><span class=c1>//|0,1,2,3,4,5|6,7,8,9,10,11,12,13,14,15|16,17|
</span><span class=c1>// global stripe:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15], n=6 m=10
</span><span class=c1>// two local stripes:
</span><span class=c1>// local stripe1:[0,1,2,  6, 7, 8, 9,10, 16] n=8 m=1
</span><span class=c1>// local stripe2:[3,4,5, 11,12,13,14,15, 17] n=8 m=1
</span></code></pre></td></tr></table>
</div>
</div><h2 id=table>Table</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// normaldb
</span><span class=c1></span>    <span class=nx>scopeCF</span>            <span class=p>=</span> <span class=s>&#34;scope&#34;</span>        <span class=c1>//分配的bid范围
</span><span class=c1></span>    <span class=nx>diskCF</span>             <span class=p>=</span> <span class=s>&#34;disk&#34;</span>         <span class=c1>//
</span><span class=c1></span>    <span class=nx>configCF</span>           <span class=p>=</span> <span class=s>&#34;config&#34;</span>
    <span class=nx>diskDropCF</span>         <span class=p>=</span> <span class=s>&#34;disk_drop&#34;</span>
    <span class=nx>serviceCF</span>          <span class=p>=</span> <span class=s>&#34;service&#34;</span>
    <span class=nx>diskStatusIndexCF</span>  <span class=p>=</span> <span class=s>&#34;disk-status&#34;</span>
    <span class=nx>diskHostIndexCF</span>    <span class=p>=</span> <span class=s>&#34;disk-host&#34;</span>
    <span class=nx>diskIDCIndexCF</span>     <span class=p>=</span> <span class=s>&#34;disk-idc&#34;</span>
    <span class=nx>diskIDCRackIndexCF</span> <span class=p>=</span> <span class=s>&#34;disk-idc-rack&#34;</span>

<span class=c1>// volumedb
</span><span class=c1></span>    <span class=nx>volumeCF</span>                <span class=p>=</span> <span class=s>&#34;volume&#34;</span>
    <span class=nx>volumeUnitCF</span>            <span class=p>=</span> <span class=s>&#34;volume_unit&#34;</span>
    <span class=nx>volumeTokenCF</span>           <span class=p>=</span> <span class=s>&#34;volume_token&#34;</span>
    <span class=nx>volumeTaskCF</span>            <span class=p>=</span> <span class=s>&#34;volume_task&#34;</span>
    <span class=nx>transitedVolumeCF</span>       <span class=p>=</span> <span class=s>&#34;transited_volume&#34;</span>
    <span class=nx>transitedVolumeUnitCF</span>   <span class=p>=</span> <span class=s>&#34;transited_volume_unit&#34;</span>
    <span class=nx>volumeUnitDiskIDIndexCF</span> <span class=p>=</span> <span class=s>&#34;volumeUnit_DiskID&#34;</span>

<span class=c1>// raftdb
</span></code></pre></td></tr></table>
</div>
</div><h2 id=组件详情>组件详情</h2>
<h3 id=access访问接入点>Access(访问接入点)</h3>
<ul>
<li>
<p>access是面向client，提供访问api接口的组件；</p>
</li>
<li>
<p>access为无状态节点；</p>
</li>
<li>
<p>一个access为一个<code>region</code>下的所有<code>cluster</code>提供访问接入点;</p>
</li>
<li>
<p>access主要提供如下rpc：</p>
<ul>
<li>
<p>/put: put数据，动态分配location, 默认最大size：5GB;</p>
</li>
<li>
<p>/putAt: 将数据put到指定的location；</p>
</li>
<li>
<p>/get: 根据location读取数据；</p>
</li>
<li>
<p>/delete：删除指定location的数据；</p>
</li>
<li>
<p>/deleteblob: 删除指定blob;</p>
</li>
<li>
<p>/alloc: 分配blob;</p>
</li>
<li>
<p>/sign: 签名;</p>
</li>
</ul>
</li>
<li>
<p>启动时，会从<code>consul_agent_addr</code>获取配置region的cluster信息加载到当前节点内存中;</p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Location: 一次put的数据位置信息；
</span><span class=c1>//
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Location</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>_</span>         <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>ClusterID</span> <span class=nx>proto</span><span class=p>.</span><span class=nx>ClusterID</span>   <span class=s>`json:&#34;cluster_id&#34;`</span>
    <span class=nx>CodeMode</span>  <span class=nx>codemode</span><span class=p>.</span><span class=nx>CodeMode</span> <span class=s>`json:&#34;code_mode&#34;`</span>
    <span class=nx>Size</span>      <span class=kt>uint64</span>            <span class=s>`json:&#34;size&#34;`</span>
    <span class=nx>BlobSize</span>  <span class=kt>uint32</span>            <span class=s>`json:&#34;blob_size&#34;`</span>
    <span class=nx>Crc</span>       <span class=kt>uint32</span>            <span class=s>`json:&#34;crc&#34;`</span>
    <span class=nx>Blobs</span>     <span class=p>[]</span><span class=nx>SliceInfo</span>       <span class=s>`json:&#34;blobs&#34;`</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Blob</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Bid</span>  <span class=nx>proto</span><span class=p>.</span><span class=nx>BlobID</span>
    <span class=nx>Vid</span>  <span class=nx>proto</span><span class=p>.</span><span class=nx>Vid</span>
    <span class=nx>Size</span> <span class=kt>uint32</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>SliceInfo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>_</span>      <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>MinBid</span> <span class=nx>proto</span><span class=p>.</span><span class=nx>BlobID</span> <span class=s>`json:&#34;min_bid&#34;`</span>
    <span class=nx>Vid</span>    <span class=nx>proto</span><span class=p>.</span><span class=nx>Vid</span>    <span class=s>`json:&#34;vid&#34;`</span>
    <span class=nx>Count</span>  <span class=kt>uint32</span>       <span class=s>`json:&#34;count&#34;`</span>
<span class=p>}</span>

    <span class=nx>MaxLocationBlobs</span> <span class=kt>uint32</span> <span class=p>=</span> <span class=mi>4</span>    <span class=c1>//location中最大blob数量，4个
</span><span class=c1></span>    <span class=nx>MaxDeleteLocations</span> <span class=kt>int</span> <span class=p>=</span> <span class=mi>1024</span>  <span class=c1>//delete请求中最多包含location数：1024
</span><span class=c1></span>    <span class=nx>MaxBlobSize</span> <span class=kt>uint32</span> <span class=p>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>25</span>    <span class=c1>// location中单个blob最大size：32MB
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>配置文件</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//access.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9500&#34;</span><span class=p>,</span>
    <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/access/&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;consul_agent_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1:8500&#34;</span><span class=p>,</span>    <span class=err>//</span>
    <span class=nt>&#34;service_register&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;consul_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1:8500&#34;</span><span class=p>,</span>
        <span class=nt>&#34;service_ip&#34;</span><span class=p>:</span> <span class=s2>&#34;x.x.x.x&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;stream&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;idc&#34;</span><span class=p>,</span>
        <span class=nt>&#34;cluster_config&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;region&#34;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=access-client>Access Client</h4>
<ul>
<li>
<p>access client 为访问access 提供api；</p>
</li>
<li>
<p>access client api通过配置文件中的<code>PriorityAddrs</code>或consul 来连接access；</p>
</li>
<li>
<p>每次api发送请求时，会从发现的所有access中随机选择<code>MaxHostRetry</code>(默认：3)个依次给access发送api请求，如果一个请求发送成功，则成功返回；</p>
</li>
<li>
<p>access client 主要 提供3个api：</p>
<ul>
<li>
<p>Put(): 写入数据, 返回数据location；</p>
</li>
<li>
<p>Get(): 根据location，获取数据内容；</p>
</li>
<li>
<p>Delete(): 删除指定location的数据；</p>
</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// API access api for s3
</span><span class=c1>// To trace request id, the ctx is better WithRequestID(ctx, rid).
</span><span class=c1></span><span class=kd>type</span> <span class=nx>API</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=c1>// Put object once if size is not greater than MaxSizePutOnce, otherwise put blobs one by one.
</span><span class=c1></span>    <span class=c1>// return a location and map of hash summary bytes you excepted.
</span><span class=c1></span>    <span class=nf>Put</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>PutArgs</span><span class=p>)</span> <span class=p>(</span><span class=nx>location</span> <span class=nx>Location</span><span class=p>,</span> <span class=nx>hashSumMap</span> <span class=nx>HashSumMap</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
    <span class=c1>// Get object, range is supported.
</span><span class=c1></span>    <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>GetArgs</span><span class=p>)</span> <span class=p>(</span><span class=nx>body</span> <span class=nx>io</span><span class=p>.</span><span class=nx>ReadCloser</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
    <span class=c1>// Delete all blobs in these locations.
</span><span class=c1></span>    <span class=c1>// return failed locations which have yet been deleted if error is not nil.
</span><span class=c1></span>    <span class=nf>Delete</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>DeleteArgs</span><span class=p>)</span> <span class=p>(</span><span class=nx>failedLocations</span> <span class=p>[]</span><span class=nx>Location</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=allocator资源分配器>Allocator(资源分配器)</h3>
<ul>
<li>
<p>allocator主要为accessor提供volume/alloc, list两个接口，负责vid,bid的分配；</p>
</li>
<li>
<p>allocator启动时，将自身组成到clustermgr的服务中；</p>
</li>
<li>
<p>allocator内置了<code>volumeMgr</code>, <code>bidmgr</code>；</p>
<ul>
<li>
<p>volumeMgr：负责volume的分配的管理。启动时，开启后台线程，将clusterMgr上的所有<code>volInfo</code>加载到allocate内存中；</p>
</li>
<li>
<p>bidMgr：负责volume 的bid range分配；</p>
</li>
</ul>
</li>
<li>
<p>rpc：</p>
<ul>
<li>
<p>/volume/alloc:</p>
</li>
<li>
<p>/volume/list:</p>
</li>
</ul>
</li>
<li>
<p>配置文件：</p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//</span> <span class=err>allocator.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9100&#34;</span><span class=p>,</span>
    <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9100&#34;</span><span class=p>,</span>
    <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span><span class=p>,</span>
    <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span>
            <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span>
            <span class=s2>&#34;http://127.0.0.1:10000&#34;</span>
        <span class=p>]</span>
    <span class=p>},</span>
    <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>1</span>
    <span class=p>},</span>
    <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/allocator/&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=clustermgr集群管理器>ClusterMgr(集群管理器)</h3>
<ul>
<li>
<p>clustermgr用于集群相关信息的管理；</p>
</li>
<li>
<p>clustermgr内部由多个管理器组成，包括：</p>
<ul>
<li>
<p>ServiceMgr(服务管理)：管理集群中的各个Service, 包括：allocator，mqproxy, tinker；</p>
</li>
<li>
<p>ConfigMgr(配置管理): cluster_config, 集群的全局配置；</p>
</li>
<li>
<p>VolumeMgr(逻辑卷管理)：负责volume的allocate，状态监测等, ;</p>
</li>
<li>
<p>DiskMgr(磁盘管理)：管理集群内所有blobnode磁盘；</p>
</li>
<li>
<p>ScopeMgr(Bid管理)：id分配管理；</p>
</li>
</ul>
</li>
<li>
<p>clustermgr内置kvdb(目前为rocksdb)来保存各种管理器的相关数据；</p>
</li>
<li>
<p>多个clustermgr通过raft保证kvdb数据在多个节点的同步以保证高可用；</p>
</li>
<li>
<p>clustermgr周期性(参数<code>cluster_report_interval_s</code>，默认：60s)的将clusterinfo汇报给<code>consul_agent_addr</code>上，以<code>ebs/&lt;region>/clusters/&lt;clusterID>:&lt;clusterInfo></code>；</p>
</li>
<li>
<p>leader clustermgr周期性的(默认: 10s)检查并更新disk状态；</p>
</li>
<li></li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//</span> <span class=err>clustermgr.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;max_procs&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span><span class=s2>&#34;:9998&#34;</span><span class=p>,</span>
    <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span>
    <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;z0&#34;</span><span class=p>],</span>
    <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;test-region&#34;</span><span class=p>,</span>
    <span class=nt>&#34;readonly&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;chunk_size&#34;</span><span class=p>:</span> <span class=mi>16777216</span><span class=p>,</span>
    <span class=nt>&#34;consul_agent_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1:8500&#34;</span><span class=p>,</span>  <span class=err>//option,</span> <span class=err>default:</span> <span class=err>127.0.0.1:8500</span>
    <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>1</span>
    <span class=p>},</span>
    <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/clustermgr/&#34;</span><span class=p>,</span>
        <span class=nt>&#34;backup&#34;</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span>
        <span class=nt>&#34;log_file_suffix&#34;</span><span class=p>:</span> <span class=s2>&#34;.log&#34;</span><span class=p>,</span>
        <span class=nt>&#34;rotate_new&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
        <span class=nt>&#34;chunkbits&#34;</span><span class=p>:</span> <span class=mi>14</span>

    <span class=p>},</span>
    <span class=nt>&#34;auth&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;enable_auth&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
        <span class=nt>&#34;secret&#34;</span><span class=p>:</span> <span class=s2>&#34;testsecret&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;normal_db_path&#34;</span><span class=p>:</span><span class=s2>&#34;/tmp/normaldb0&#34;</span><span class=p>,</span>
    <span class=nt>&#34;normal_db_option&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;create_if_missing&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
    <span class=nt>&#34;code_mode_policies&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span><span class=nt>&#34;mode_name&#34;</span><span class=p>:</span><span class=s2>&#34;EC3P3&#34;</span><span class=p>,</span><span class=nt>&#34;min_size&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&#34;max_size&#34;</span><span class=p>:</span><span class=mi>1024</span><span class=p>,</span><span class=nt>&#34;size_ratio&#34;</span><span class=p>:</span><span class=mf>0.2</span><span class=p>,</span><span class=nt>&#34;enable&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
        <span class=p>{</span><span class=nt>&#34;mode_name&#34;</span><span class=p>:</span><span class=s2>&#34;EC6P6&#34;</span><span class=p>,</span><span class=nt>&#34;min_size&#34;</span><span class=p>:</span><span class=mi>1025</span><span class=p>,</span><span class=nt>&#34;max_size&#34;</span><span class=p>:</span><span class=mi>2048</span><span class=p>,</span><span class=nt>&#34;size_ratio&#34;</span><span class=p>:</span><span class=mf>0.8</span><span class=p>,</span><span class=nt>&#34;enable&#34;</span><span class=p>:</span><span class=kc>false</span><span class=p>}</span>
    <span class=p>],</span>
    <span class=nt>&#34;volume_mgr_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;volume_db_path&#34;</span><span class=p>:</span><span class=s2>&#34;/tmp/volumedb0&#34;</span><span class=p>,</span>
        <span class=nt>&#34;volume_db_option&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;create_if_missing&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
        <span class=nt>&#34;min_allocable_volume_count&#34;</span><span class=p>:</span><span class=mi>4</span><span class=p>,</span>
        <span class=nt>&#34;each_allocator_volume_threshold&#34;</span><span class=p>:</span><span class=mi>500</span><span class=p>,</span>
        <span class=nt>&#34;retain_time_s&#34;</span><span class=p>:</span><span class=mi>600</span>
    <span class=p>},</span>
    <span class=nt>&#34;cluster_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;disk_repair&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;balance&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;disk_drop&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;blob_delete&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;shard_repair&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;vol_inspect&#34;</span><span class=p>:</span><span class=s2>&#34;Disable&#34;</span><span class=p>,</span>
        <span class=nt>&#34;init_volume_num&#34;</span><span class=p>:</span><span class=mi>100</span><span class=p>,</span>
        <span class=nt>&#34;volume_reserve_size&#34;</span><span class=p>:</span><span class=mi>10485760</span><span class=p>,</span>
        <span class=nt>&#34;data_node_heartbeat_interval_s&#34;</span><span class=p>:</span> <span class=mi>60</span>
    <span class=p>},</span>
    <span class=nt>&#34;raft_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;raft_db_path&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/raftdb0&#34;</span><span class=p>,</span>
        <span class=nt>&#34;raft_db_option&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;create_if_missing&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>},</span>
        <span class=nt>&#34;snapshot_patch_num&#34;</span><span class=p>:</span> <span class=mi>64</span><span class=p>,</span>
        <span class=nt>&#34;server_config&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;nodeId&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
            <span class=nt>&#34;listen_port&#34;</span><span class=p>:</span> <span class=mi>10110</span><span class=p>,</span>
            <span class=nt>&#34;raft_wal_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/raftwal0&#34;</span><span class=p>,</span>
            <span class=nt>&#34;peers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;1&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10110&#34;</span><span class=p>,</span><span class=nt>&#34;2&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10111&#34;</span><span class=p>,</span><span class=nt>&#34;3&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10112&#34;</span><span class=p>}</span>
        <span class=p>},</span>
        <span class=nt>&#34;raft_node_config&#34;</span><span class=p>:{</span>
            <span class=nt>&#34;flush_num_interval&#34;</span><span class=p>:</span> <span class=mi>10000</span><span class=p>,</span>
            <span class=nt>&#34;flush_time_interval_s&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
            <span class=nt>&#34;truncate_num_interval&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
            <span class=nt>&#34;node_protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;http://&#34;</span><span class=p>,</span>
            <span class=nt>&#34;nodes&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;1&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:9998&#34;</span><span class=p>,</span> <span class=nt>&#34;2&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:9999&#34;</span><span class=p>,</span> <span class=nt>&#34;3&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1:10000&#34;</span><span class=p>}</span>
        <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>&#34;disk_mgr_config&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;refresh_interval_s&#34;</span><span class=p>:</span> <span class=mi>300</span><span class=p>,</span>
        <span class=nt>&#34;rack_aware&#34;</span><span class=p>:</span><span class=kc>false</span><span class=p>,</span>
        <span class=nt>&#34;host_aware&#34;</span><span class=p>:</span><span class=kc>false</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=cluster集群>Cluster(集群)</h4>
<ul>
<li>
<p>一个cluster由多个cluster_id相同的多个clustermgr节点组成；</p>
</li>
<li>
<p>一个cluster中的多个clustermgr通过raft组成一个raft group进行数据复制同步；</p>
</li>
<li>
<p>一个region中可包含多个cluster，同一region下的cluster注册为consul下的多个服务；</p>
</li>
<li>
<p>数据put时，access根据配置的region，会随机在region下选择一个cluster来put数据，返回的location中包含cluster_id用以指明所在cluster；</p>
</li>
</ul>
<h4 id=volume卷>Volume(卷)</h4>
<ul>
<li>
<p>Volume是数据管理逻辑单元，是面向客户端的数据视图；</p>
</li>
<li>
<p>基本信息</p>
<ul>
<li>
<p>vid(32bits)</p>
</li>
<li>
<p>CodeMode: 编码模式</p>
</li>
<li>
<p>Status: 状态</p>
</li>
<li>
<p>HealthScore: 健康分</p>
</li>
<li>
<p>Total: 总空间</p>
</li>
<li>
<p>Free: 可用空间</p>
</li>
<li>
<p>Used: 已使用空间</p>
</li>
<li>
<p>CreateByNodeID: 创建NodeID</p>
</li>
</ul>
</li>
<li>
<p>Volume Status</p>
<ul>
<li>
<p>idle: volume刚创建时，尚未被分配的volume状态；</p>
</li>
<li>
<p>active: volume分配给某一个allocator后的状态；</p>
</li>
<li>
<p>lock:</p>
</li>
<li>
<p>unlocking</p>
</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//卷信息
</span><span class=c1></span><span class=kd>type</span> <span class=nx>VolumeInfo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Units</span> <span class=p>[]</span><span class=nx>Unit</span>
    <span class=nx>VolumeInfoBase</span>
<span class=p>}</span>
<span class=c1>//卷单元
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Unit</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Vuid</span>       <span class=nx>proto</span><span class=p>.</span><span class=nx>Vuid</span> 
    <span class=nx>DiskID</span>     <span class=nx>proto</span><span class=p>.</span><span class=nx>DiskID</span>
    <span class=nx>Host</span>       <span class=kt>string</span>
<span class=p>}</span>

<span class=c1>// clustermgr/srv.go
</span><span class=c1></span>    <span class=nx>BidScopeName</span>             <span class=p>=</span> <span class=s>&#34;bid&#34;</span>
    <span class=nx>MaxBidCount</span>              <span class=p>=</span> <span class=mi>100000</span>
    <span class=nx>DefaultChunkSize</span>         <span class=p>=</span> <span class=mi>17179869184</span>
    <span class=nx>DefaultVolumeReserveSize</span> <span class=p>=</span> <span class=mi>10485760</span>

    <span class=nx>defaultClusterReportIntervalS</span>   <span class=p>=</span> <span class=mi>60</span>
    <span class=nx>defaultHeartbeatNotifyIntervalS</span> <span class=p>=</span> <span class=mi>10</span>
    <span class=nx>defaultMaxHeartbeatNotifyNum</span>    <span class=p>=</span> <span class=mi>2000</span>
    <span class=nx>defaultMetricReportIntervalM</span>    <span class=p>=</span> <span class=mi>2</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=blobnode>BlobNode</h3>
<ul>
<li>
<p>BlobNode是blob管理节点，提供数据的blob存储管理；</p>
</li>
<li>
<p>blobnode启动时，将扫描并加载配置文件下的disk，然后后<code>clusterMgr</code>上已有的disk进行对比，如果<code>clusterMgr</code>中<code>not found</code>，则<code>AddDisk</code>到<code>clusterMgr</code>的管理器中；</p>
</li>
<li>
<p>启动时开启如下全局协程：</p>
<ul>
<li>
<p>loopHeartbeatToClusterMgr(): 周期性(默认：30s)维持和<code>clusterMgr</code>间的心跳；</p>
</li>
<li>
<p>loopReportChunkInfoToClusterMgr()：周期性(默认：57s)向<code>clusterMgr</code>汇报chunkInfo;</p>
</li>
<li>
<p>loopGcRubbishChunkFile(): 周期(默认：60min)检查chunkfile，执行垃圾回收任务；</p>
</li>
<li>
<p>loopCleanExpiredStatFile(): 周期()清理过期stat文件(/tmp/shm/目录下的iostat文件)；</p>
</li>
</ul>
</li>
</ul>
<h4 id=blobnode中disk>blobnode中disk</h4>
<ul>
<li>
<p>blobnode中disk由配置文件中<code>disks</code>项指定，一个blobnode可以包含多个disk;</p>
</li>
<li>
<p>blobnode启动时，先通过rpc从<code>clusterMgr</code>获取该host所有已经注册的disk；</p>
</li>
<li>
<p>然后根据配置文件, 逐个加载disk；</p>
</li>
<li>
<p>每个disk包含.sys, meta等子目录，</p>
<ul>
<li>
<p>.sys目录里面保存disk的格式相关信息；</p>
</li>
<li>
<p>.meta里面使用rocksdb来记录chunk相关的元数据信息；</p>
</li>
<li>
<p>.data目录包含chunkfile;</p>
</li>
</ul>
</li>
<li>
<p>blobnode disk加载流程：</p>
<ul>
<li>
<p>通过配置文件获取disk根目录；</p>
</li>
<li>
<p>加载磁盘format信息。通过读取.sys目录下的format.json内获取disk format信息(包括DiskID), 如果该文件不存在，则从<code>clusterMgr</code>分配一个新的DiskID, 并注册disk到clusterMgr的table中;</p>
</li>
<li>
<p>打开meta目录下的rocksdb，初始化化superblock;</p>
</li>
<li>
<p>从meta db中读取<code>diskinfo</code>来加载diskinfo；</p>
</li>
<li>
<p>设置disk iostat 相关数据结构；</p>
</li>
<li>
<p>启动loop相关后台协程</p>
</li>
<li>
<ul>
<li>
<p><code>ds.loopCleanChunk</code>: 清理已released 的chunk；</p>
</li>
<li>
<p><code>ds.loopCompactFile</code>: compact chunk file;</p>
</li>
<li>
<p><code>ds.loopDiskUsage</code>:</p>
</li>
<li>
<p><code>ds.loopCleanTrash</code>:</p>
</li>
<li>
<p><code>ds.loopMetricReport</code>:</p>
</li>
</ul>
</li>
<li>
<p>加载好的diskStorage记录在map[diskID]<code>Disks</code> 中;</p>
</li>
</ul>
</li>
<li>
<p>blobnode rpc:</p>
<ul>
<li>
<p>/chunk/create</p>
</li>
<li>
<p>/chunk/release</p>
</li>
<li>
<p>/chunk/compact</p>
</li>
<li>
<p>&mldr;</p>
</li>
<li>
<p>/shard/get/&mldr;</p>
</li>
<li>
<p>/shard/put/&mldr;.</p>
</li>
<li>
<p>/shard/delete/&mldr;</p>
</li>
</ul>
</li>
</ul>
<h4 id=配置文件>配置文件</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//</span> <span class=err>blobnode.conf</span>
<span class=p>{</span>
  <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:8899&#34;</span><span class=p>,</span>
  <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
  <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span><span class=p>,</span>
  <span class=nt>&#34;rack&#34;</span><span class=p>:</span> <span class=s2>&#34;testrack&#34;</span><span class=p>,</span>
  <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8899&#34;</span><span class=p>,</span>
  <span class=nt>&#34;disks&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk1&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk2&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk3&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk4&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk5&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/disks/disk6&#34;</span><span class=p>,</span>
      <span class=nt>&#34;auto_format&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>&#34;max_chunks&#34;</span><span class=p>:</span> <span class=mi>1024</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span>
      <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span>
      <span class=s2>&#34;http://127.0.0.1:10000&#34;</span>
    <span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/blobnode.log&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./run/auditlog&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=存储格式>存储格式</h4>
<ul>
<li>volume->chunk</li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/28-17-40-09-2022-02-28-17-39-53-image.png alt></p>
<ul>
<li>chunk->shard</li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/28-17-41-54-2022-02-28-17-41-44-image.png alt></p>
<h4 id=disk磁盘>Disk(磁盘)</h4>
<ul>
<li>
<p>Disk是BlobNode节点上一个格式化后挂载到某一目录的物理磁盘，用来存储具体的数据；</p>
</li>
<li>
<p>Disk基本信息包括：</p>
<ul>
<li>
<p>DiskID: 磁盘ID(uint32), 1~1^31-1；</p>
</li>
<li>
<p>ClusterID: 所属ClusterID(uint32)；</p>
</li>
<li>
<p>Idc: Idc</p>
</li>
<li>
<p>Path：</p>
</li>
<li>
<p>Host：</p>
</li>
<li>
<p>Status</p>
</li>
<li>
<p>ReadOnly: 是否只读</p>
</li>
</ul>
</li>
<li>
<p>Disk Status包括：</p>
<ul>
<li>
<p>Normal: 正常</p>
</li>
<li>
<p>Broken:</p>
</li>
<li>
<p>Repairing</p>
</li>
<li>
<p>Repaired</p>
</li>
<li>
<p>Droped</p>
</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// disk format
</span><span class=c1>// blobnode/core/format.go
</span><span class=c1></span><span class=cm>/*
</span><span class=cm> * ${diskRoot}/
</span><span class=cm> *         - .sys/                 //disk
</span><span class=cm> *          - .format.json         //disk 格式信息；
</span><span class=cm> *          - .format.json.tmp
</span><span class=cm> *         - .trash/                //回收站，被清理的chunk
</span><span class=cm> *         - data/                  //disk数据信息, chunk file
</span><span class=cm>            - &lt;chunkID1&gt;file     // chunk file 1  (最多8196个chunk)
</span><span class=cm>            - &lt;chunkID2&gt;file     // chunk file 2 
</span><span class=cm> *         - meta/                  //disk元信息
</span><span class=cm>            - superblock/        //disk超级块，disk meta kvdb
</span><span class=cm>*/</span>

<span class=c1>// 磁盘格式信息受保护域，
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FormatInfoProtectedField</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>DiskID</span>  <span class=nx>proto</span><span class=p>.</span><span class=nx>DiskID</span> <span class=s>`json:&#34;diskid&#34;`</span>    <span class=c1>//
</span><span class=c1></span>    <span class=nx>Version</span> <span class=kt>uint8</span>        <span class=s>`json:&#34;version&#34;`</span>   <span class=c1>//
</span><span class=c1></span>    <span class=nx>Ctime</span>   <span class=kt>int64</span>        <span class=s>`json:&#34;ctime&#34;`</span>     <span class=c1>//
</span><span class=c1></span>    <span class=nx>Format</span>  <span class=kt>string</span>       <span class=s>`json:&#34;format&#34;`</span>    <span class=c1>//disk格式，当前只支持fs
</span><span class=c1></span><span class=p>}</span>
<span class=c1>//磁盘格式信息
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FormatInfo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>FormatInfoProtectedField</span>
    <span class=nx>CheckSum</span> <span class=kt>uint32</span> <span class=s>`json:&#34;check_sum&#34;`</span>
<span class=p>}</span>

<span class=c1>//disk metadb(rocksdb)
</span><span class=c1>//    k       ----        v
</span><span class=c1>// disk/&lt;diskid&gt;        [diskid]  
</span><span class=c1>// chunk/&lt;chunkid&gt;      [chunkid]
</span><span class=c1>// vuid/&lt;vuid&gt;          [vuid]
</span><span class=c1>// diskinfo             [diskmeta]
</span><span class=c1></span>
<span class=c1>//DiskMeta
</span><span class=c1></span><span class=kd>type</span> <span class=nx>DiskMeta</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>FormatInfo</span>
    <span class=nx>Host</span>       <span class=kt>string</span>           <span class=s>`json:&#34;host&#34;`</span>
    <span class=nx>Path</span>       <span class=kt>string</span>           <span class=s>`json:&#34;path&#34;`</span>
    <span class=nx>Status</span>     <span class=nx>proto</span><span class=p>.</span><span class=nx>DiskStatus</span> <span class=s>`json:&#34;status&#34;`</span>
    <span class=nx>Registered</span> <span class=kt>bool</span>             <span class=s>`json:&#34;registered&#34;`</span>
    <span class=nx>Readonly</span>   <span class=kt>bool</span>             <span class=s>`json:&#34;readonly&#34;`</span>
    <span class=nx>Mtime</span>      <span class=kt>int64</span>            <span class=s>`json:&#34;mtime&#34;`</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=chunk>Chunk</h4>
<ul>
<li>
<p>Chunk是对Disk上具体数据的一种抽象，当前的chunk实现为一个file；</p>
</li>
<li>
<p>chunk file 位于disk的data目录下, 以chunkID为名的file；</p>
</li>
<li>
<p>chunkID组成：<code>vuid+&lt;创建chunk时的时间戳></code>；</p>
</li>
<li>
<p>每个chunk由多个连续的shard组成，</p>
</li>
</ul>
<ul>
<li>
<p>一个disk默认最多chunk数<code>DefaultMaxChunks</code>：8192;</p>
</li>
<li>
<p>一个chunk默认最大size<code>DefaultMaxChunk</code>: 1TiB;</p>
</li>
<li>
<p>默认chunk size<code>DefaultChunkSize</code>：16GiB;</p>
</li>
</ul>
<ul>
<li>
<p>chunk status:</p>
<ul>
<li>
<p>Default:</p>
</li>
<li>
<p>Normal:</p>
</li>
<li>
<p>ReadOnly:</p>
</li>
<li>
<p>Release:</p>
</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// cubufs-blobstore/blobnode/core/shard.go
</span><span class=c1></span>
<span class=c1>// chunk datafile format:
</span><span class=c1>//  --------------
</span><span class=c1>// | chunk  header | (4k)
</span><span class=c1>//  --------------
</span><span class=c1>// |    shard    |         ----------------------
</span><span class=c1>// |    shard    |        |  header (32 Bytes) |
</span><span class=c1>// |    shard    | ----&gt;  |  data   (...)      |
</span><span class=c1>// |    shard    |        |  footer (8 Bytes)  |
</span><span class=c1>// |    ....    |        ----------------------
</span><span class=c1>//
</span><span class=c1>// Chunkdata header format:
</span><span class=c1>//  --------------
</span><span class=c1>// | magic number |   ---- 4 bytes
</span><span class=c1>// | version      |   ---- 1 byte
</span><span class=c1>// | parent chunk |   ---- 16 byte    //compact前的chunk   
</span><span class=c1>// | create time  |   ---- 8 byte
</span><span class=c1>// | padding      |   ---- aligned with shard padding size ( 4k-4-1-16-8)
</span><span class=c1></span>
<span class=c1>// shard
</span><span class=c1>// shard header format:
</span><span class=c1>// ---------------------
</span><span class=c1>// |crc(header)(uint32)|
</span><span class=c1>// |  magic  (uint32)  |
</span><span class=c1>// |  bid    (int64)   |
</span><span class=c1>// |  vuid   (uint64)  |
</span><span class=c1>// |  size   (uint32)  |
</span><span class=c1>// | padding (4 bytes) |
</span><span class=c1>// ---------------------
</span><span class=c1>//
</span><span class=c1>// shard data format.
</span><span class=c1>//  --------------
</span><span class=c1>// | block        |   ---- 64 KiB
</span><span class=c1>// | block        |   ---- 64 KiB
</span><span class=c1>// | block        |   ---- 64 KiB
</span><span class=c1>//  ---------------
</span><span class=c1>//
</span><span class=c1>// block format.
</span><span class=c1>//  --------------
</span><span class=c1>// | crc          |   ---- 4 Byte
</span><span class=c1>// | data         |   ---- (64 KiB - 4)
</span><span class=c1>//  ---------------
</span><span class=c1>//
</span><span class=c1>// footer format:
</span><span class=c1>// ----------------------
</span><span class=c1>// |  magic   (int32)   |
</span><span class=c1>// | crc(shard) (int32) |
</span><span class=c1>// | padding  (0 bytes) |
</span><span class=c1>// ----------------------
</span><span class=c1></span>

<span class=c1>// Chunkdata has a header (4k).
</span><span class=c1>// Chunkdata header format:
</span><span class=c1>//  --------------
</span><span class=c1>// | magic number |   ---- 4 bytes
</span><span class=c1>// | version      |   ---- 1 byte
</span><span class=c1>// | parent chunk |   ---- 16 byte
</span><span class=c1>// | create time  |   ---- 8 byte
</span><span class=c1>// | padding      |   ---- aligned with shard padding size ( 4k-4-1-16-8)
</span><span class=c1>//  --------------
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    shard     |
</span><span class=c1>// |    ....      |
</span><span class=c1></span>
<span class=kd>type</span> <span class=nx>ChunkHeader</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>magic</span>       <span class=p>[</span><span class=nx>_chunkMagicSize</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>version</span>     <span class=kt>byte</span>
    <span class=nx>parentChunk</span> <span class=nx>bnapi</span><span class=p>.</span><span class=nx>ChunkId</span>
    <span class=nx>createTime</span>  <span class=kt>int64</span>
<span class=p>}</span>

<span class=c1>// Chunk ID
</span><span class=c1>// vuid + timestamp
</span><span class=c1></span><span class=kd>const</span> <span class=p>(</span>
    <span class=nx>chunkVuidLen</span>      <span class=p>=</span> <span class=mi>8</span>
    <span class=nx>chunkTimestmapLen</span> <span class=p>=</span> <span class=mi>8</span>
    <span class=nx>ChunkIdLength</span>     <span class=p>=</span> <span class=nx>chunkVuidLen</span> <span class=o>+</span> <span class=nx>chunkTimestmapLen</span>
<span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=shard>Shard</h4>
<ul>
<li>
<p>shard是chunk中用于存储一个ec编码</p>
</li>
<li>
<p>shard status:</p>
<ul>
<li>
<p>Default:</p>
</li>
<li>
<p>Normal:</p>
</li>
<li>
<p>MarkDelete:</p>
</li>
</ul>
</li>
</ul>
<h3 id=mqproxy消息代理>MQProxy(消息代理)</h3>
<ul>
<li>mqproxy为kafka mq代理，作为异步消息传输通道；</li>
<li>启动时，将自身作为 service注册到<code>clustermsg</code>中的service table中；</li>
<li>mqproxy接收<code>access</code>下发的<code>shardRepardMsg</code>和<code>blobDeleteMsg</code>消息，发送到kafka中，最后被<code>scheduler</code>消费；</li>
<li>scheduler中的<code>inspectMgr</code>在巡检时，如果发现丢失的shard，将给mqproxy发送<code>shardRepairedMsg</code>;</li>
<li>提供rpc接口：
<ul>
<li>/repairmsg: shard修复消息；</li>
<li>/deletemsg: blob删除消息；</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//mqproxy.conf</span>
<span class=p>{</span>
  <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9600&#34;</span><span class=p>,</span>
  <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
  <span class=nt>&#34;cm_cfg&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http://127.0.0.1:7000&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:7010&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:7020&#34;</span><span class=p>]</span>
  <span class=p>},</span>
  <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;blob_delete_topic&#34;</span><span class=p>:</span> <span class=s2>&#34;blob_delete&#34;</span><span class=p>,</span>
    <span class=nt>&#34;shard_repair_topic&#34;</span><span class=p>:</span> <span class=s2>&#34;shard_repair&#34;</span><span class=p>,</span>
    <span class=nt>&#34;shard_repair_priority_topic&#34;</span><span class=p>:</span> <span class=s2>&#34;shard_repair_prior&#34;</span><span class=p>,</span>
    <span class=nt>&#34;msg_sender&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;broker_list&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;127.0.0.1:9092&#34;</span><span class=p>]</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>&#34;service_register&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9600&#34;</span><span class=p>,</span>
    <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/mqproxy.log&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/mqproxy&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=scheduler任务调度器>Scheduler(任务调度器)</h3>
<ul>
<li><code>scheduler</code>提供所在cluster后台任务调度服务;</li>
<li>内置多种管理器，来对各种任务进行管理：
<ul>
<li>ClusterTopoMgr: 集群拓扑管理器, 周期性(默认：5min)的从<code>clustermgr</code>获取配置集群的disk信息，然后构建拓扑信息；</li>
<li>BalanceMgr：数据平衡管理器, 周期性(默认：5s)收集disk分布情况，构建MigrateMgr任务，使数据自动保证平衡；</li>
<li>MigrateMgr: 迁移管理器, 分为自动、手动迁移管理器两种。自动迁移管理器由BalanceMgr管理；手动迁移管理器由api调用触发：</li>
<li>DiskDropMgr：下线磁盘管理器，负责；</li>
<li>RepairMgr：shard修复任务管理器，管理下发shardreapirmsg task;</li>
<li>InspectMgr: 巡检管理器, 巡检vol，发现坏的blob时，给mqproxy发送<code>ShardRepairMsg</code>；</li>
</ul>
</li>
<li>启动时，先根据配置文件初始化各个管理器 ，再从mongo中加载已有的task，最后使各个mgr run起来；</li>
<li>scheduler内置service table, tinker和worker组件在启动时，会将自身注册到scheduler的service table中；</li>
<li>各管理器生成task，并插入到相应的mongdb task table中；</li>
<li></li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json>  <span class=err>//</span> <span class=err>scheduler.conf</span>
  <span class=p>{</span>
   <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9800&#34;</span><span class=p>,</span>         <span class=err>#</span> <span class=err>服务端口</span>
   <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>              <span class=err>#</span> <span class=err>集群id</span>
   <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span>               <span class=err>#</span> <span class=err>clustermgr地址</span>
     <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:10000&#34;</span><span class=p>]</span>
   <span class=p>},</span>
   <span class=nt>&#34;database&#34;</span><span class=p>:</span> <span class=p>{</span>                 <span class=err>#</span> <span class=err>后台任务相关配置</span>
     <span class=nt>&#34;mongo&#34;</span><span class=p>:</span> <span class=p>{</span>
       <span class=nt>&#34;uri&#34;</span><span class=p>:</span> <span class=s2>&#34;mongodb://127.0.0.1:27017&#34;</span> <span class=err>#</span> <span class=err>mongodb</span> <span class=err>地址</span>
     <span class=p>},</span>
     <span class=nt>&#34;db_name&#34;</span><span class=p>:</span> <span class=s2>&#34;scheduler&#34;</span>      <span class=err>#</span> <span class=err>数据库名</span>
   <span class=p>},</span>
   <span class=nt>&#34;task_archive_store_db&#34;</span><span class=p>:</span> <span class=p>{</span>    <span class=err>#</span> <span class=err>后台任务备份表</span>
     <span class=nt>&#34;mongo&#34;</span><span class=p>:</span> <span class=p>{</span>
       <span class=nt>&#34;uri&#34;</span><span class=p>:</span> <span class=s2>&#34;mongodb://127.0.0.1:27017&#34;</span> <span class=err>#</span> <span class=err>mongodb</span> <span class=err>地址</span>
     <span class=p>},</span>
     <span class=nt>&#34;db_name&#34;</span><span class=p>:</span> <span class=s2>&#34;task_archive_store&#34;</span> <span class=err>#</span> <span class=err>数据库名</span>
   <span class=p>},</span>
   <span class=nt>&#34;log&#34;</span><span class=p>:{</span>                         <span class=err>#</span> <span class=err>运行日志相关配置</span>
     <span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span>                    <span class=err>#</span> <span class=err>0:debug,</span> <span class=err>1:info,</span> <span class=err>2:warn,</span> <span class=err>3:error,</span> <span class=err>4:panic,</span> <span class=err>5:fatal</span>
     <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/scheduler.log&#34;</span> <span class=err>#</span> <span class=err>运行日志文件，会自动轮转</span>
   <span class=p>},</span>
   <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>                    <span class=err>#</span> <span class=err>审计日志相关配置</span>
     <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/scheduler&#34;</span> <span class=err>#</span> <span class=err>审计日志目录</span>
   <span class=p>}</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>rpc:</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// scheduler/startup.go
</span><span class=c1></span>    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/task/acquire&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskAcquire</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/reclaim&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskReclaim</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/cancel&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskCancel</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/complete&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskComplete</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/manual/migrate/task/add&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPManualMigrateTaskAdd</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/inspect/acquire&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPInspectAcquire</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/inspect/complete&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPInspectComplete</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/report&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskReport</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/task/renewal&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPTaskRenewal</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/balance/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPBalanceTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/repair/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPRepairTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/drop/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPDropTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/manual/migrate/task/detail&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPManualMigrateTaskDetail</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/stats&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPStats</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/service/list&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceList</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/service/register&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceRegister</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/service/get&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceGet</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsQuery</span><span class=p>())</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/service/delete&#34;</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>HTTPServiceDelete</span><span class=p>,</span> <span class=nx>rpc</span><span class=p>.</span><span class=nf>OptArgsBody</span><span class=p>())</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=tinker修补器>Tinker(修补器)</h3>
<ul>
<li>启动时，将自身注册到<code>scheduler</code>的service服务列表中；</li>
<li>内置<code>shardRepairMgr</code>, <code>BlobDeleteMgr</code>, 执行shard repair，blob delete任务；</li>
<li>从kafka mq中消费相应的消息, 并通过rpc通知<code>worker</code>执行相应的任务;</li>
<li>tinker使用mongodb保存kafka offset和<code>orphanShard</code>;</li>
<li>rpc:
<ul>
<li>/update/vol:</li>
<li>/stats:</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//tinker.conf</span>
<span class=p>{</span>
   <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9700&#34;</span><span class=p>,</span>           <span class=err>#</span> <span class=err>服务端口</span>
   <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span>                 <span class=err>#</span> <span class=err>集群id</span>
   <span class=nt>&#34;database_conf&#34;</span><span class=p>:</span> <span class=p>{</span>              <span class=err>#</span> <span class=err>mongodb相关配置</span>
       <span class=nt>&#34;mongo&#34;</span><span class=p>:</span> <span class=p>{</span>
         <span class=nt>&#34;uri&#34;</span><span class=p>:</span> <span class=s2>&#34;mongodb://127.0.0.1:27017&#34;</span> <span class=err>#</span> <span class=err>mongodb地址</span>
       <span class=p>},</span>
       <span class=nt>&#34;db_name&#34;</span><span class=p>:</span> <span class=s2>&#34;tinker&#34;</span>         <span class=err>#</span> <span class=err>数据库名</span>
   <span class=p>},</span>
   <span class=nt>&#34;shard_repair&#34;</span><span class=p>:{</span>                <span class=err>#</span> <span class=err>数据修补相关配置</span>
        <span class=nt>&#34;broker_list&#34;</span><span class=p>:[</span><span class=s2>&#34;127.0.0.1:9092&#34;</span><span class=p>],</span> <span class=err>#</span> <span class=err>kafka</span> <span class=err>地址</span>
        <span class=nt>&#34;priority_topics&#34;</span><span class=p>:[</span>        <span class=err>#</span> <span class=err>修补主题配置</span>
            <span class=p>{</span>
                 <span class=nt>&#34;priority&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span>     <span class=err>#</span> <span class=err>修复优先级，数值越大优先级越高</span>
                 <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;shard_repair&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
                 <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>  <span class=err>#</span> <span class=err>消费分区</span>
            <span class=p>},</span>
            <span class=p>{</span>
                <span class=nt>&#34;priority&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span>      <span class=err>#</span> <span class=err>修复优先级，数值越大优先级越高</span>
                <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;shard_repair_prior&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
                <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>   <span class=err>#</span> <span class=err>消费分区</span>
             <span class=p>}</span>
        <span class=p>],</span>
        <span class=nt>&#34;fail_topic&#34;</span><span class=p>:{</span>             <span class=err>#</span> <span class=err>修补主题消费配置</span>
             <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;shard_repair_failed&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
             <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>      <span class=err>#</span> <span class=err>消费分区</span>
        <span class=p>}</span>
   <span class=p>},</span>   
    <span class=nt>&#34;blob_delete&#34;</span><span class=p>:{</span>                 <span class=err>#</span> <span class=err>数据删除相关配置</span>
         <span class=nt>&#34;broker_list&#34;</span><span class=p>:[</span><span class=s2>&#34;127.0.0.1:9092&#34;</span><span class=p>],</span> <span class=err>#</span> <span class=err>kafka地址</span>
         <span class=nt>&#34;normal_topic&#34;</span><span class=p>:{</span>          <span class=err>#</span> <span class=err>删除消息消费配置</span>
             <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;blob_delete&#34;</span><span class=p>,</span><span class=err>#</span> <span class=err>主题</span>
             <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>      <span class=err>#</span> <span class=err>消费分区</span>
         <span class=p>},</span>
         <span class=nt>&#34;fail_topic&#34;</span><span class=p>:{</span>            <span class=err>#</span> <span class=err>删除失败消息消费配置</span>
             <span class=nt>&#34;topic&#34;</span><span class=p>:</span><span class=s2>&#34;fail_blob_delete&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>主题</span>
             <span class=nt>&#34;partitions&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>]</span>      <span class=err>#</span> <span class=err>分区</span>
         <span class=p>},</span>
         <span class=nt>&#34;safe_delay_time_h&#34;</span><span class=p>:</span><span class=mi>72</span><span class=p>,</span>   <span class=err>#</span> <span class=err>删除保护期</span>
         <span class=nt>&#34;dellog&#34;</span><span class=p>:{</span>                <span class=err>#</span> <span class=err>删除记录相关配置</span>
             <span class=nt>&#34;dir&#34;</span><span class=p>:</span> <span class=s2>&#34;./delete_log&#34;</span> <span class=err>#</span> <span class=err>删除日志目录</span>
         <span class=p>}</span>
    <span class=p>},</span> 
    <span class=nt>&#34;clustermgr&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#</span> <span class=err>clustermgr地址</span>
         <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http://127.0.0.1:9998&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:9999&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:10000&#34;</span><span class=p>]</span>
     <span class=p>},</span>
     <span class=nt>&#34;scheduler&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#</span> <span class=err>scheduler服务地址</span>
         <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9800&#34;</span>
     <span class=p>},</span>
     <span class=nt>&#34;service_register&#34;</span><span class=p>:{</span> <span class=err>#</span> <span class=err>自身服务注册信息</span>
         <span class=nt>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;http://127.0.0.1:9700&#34;</span><span class=p>,</span> <span class=err>#</span> <span class=err>服务地址</span>
         <span class=nt>&#34;idc&#34;</span><span class=p>:</span><span class=s2>&#34;z0&#34;</span> <span class=err>#</span> <span class=err>服务所属机房</span>
     <span class=p>},</span>
     <span class=nt>&#34;log&#34;</span><span class=p>:{</span> <span class=err>#</span> <span class=err>运行日志相关配置</span>
         <span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span> <span class=err>#</span> <span class=err>0:debug,</span> <span class=err>1:info,</span> <span class=err>2:warn,</span> <span class=err>3:error,</span> <span class=err>4:panic,</span> <span class=err>5:fatal</span>
         <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/tinker.log&#34;</span> <span class=err>#</span> <span class=err>运行日志文件，会自动轮转</span>
     <span class=p>},</span>
     <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=err>#</span> <span class=err>审计日志相关配置</span>
         <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/tinker&#34;</span> <span class=err>#</span> <span class=err>审计日志目录</span>
     <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=worker>Worker()</h3>
<ul>
<li>
<p>执行tinker下发(rpc api)的shard repair, blob delete任务；</p>
</li>
<li>
<p>启动时，将自身注册到<code>scheduler</code>的service 列表中；</p>
</li>
<li>
<p>周期性(默认: 500ms)的从<code>scheduler</code>获取task(调用scheduler rpc：<code>/task/acquire</code>), 并执行task(包括: Repair, Balance, DiskDrop, ManualMigrate, Inspect)；</p>
</li>
<li>
<p>rpc api:</p>
<ul>
<li>
<p>/shard/repair</p>
</li>
<li>
<p>/stats</p>
</li>
</ul>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json>  <span class=err>//worker.conf</span>
  <span class=p>{</span>
   <span class=nt>&#34;bind_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;:9910&#34;</span><span class=p>,</span>                <span class=err>#</span> <span class=err>服务端口</span>
   <span class=nt>&#34;cluster_id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>                     <span class=err>#</span> <span class=err>集群id</span>
   <span class=nt>&#34;service_register&#34;</span><span class=p>:</span> <span class=p>{</span>                <span class=err>#</span> <span class=err>自身服务consul注册信息</span>
     <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9910&#34;</span><span class=p>,</span>   <span class=err>#</span> <span class=err>服务地址</span>
     <span class=nt>&#34;idc&#34;</span><span class=p>:</span> <span class=s2>&#34;z0&#34;</span>                        <span class=err>#</span> <span class=err>服务所属机房</span>
   <span class=p>},</span>
   <span class=nt>&#34;scheduler&#34;</span><span class=p>:</span> <span class=p>{</span>                       <span class=err>#</span> <span class=err>scheduler服务相关配置</span>
     <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:9800&#34;</span>    <span class=err>#</span> <span class=err>服务地址</span>
   <span class=p>},</span>
   <span class=nt>&#34;dropped_bid_record&#34;</span><span class=p>:</span> <span class=p>{</span>              <span class=err>#</span> <span class=err>丢弃blob</span> <span class=err>id原因记录</span>
     <span class=nt>&#34;dir&#34;</span><span class=p>:</span> <span class=s2>&#34;./dropped&#34;</span>                 <span class=err>#</span> <span class=err>记录目录</span>
   <span class=p>},</span>
   <span class=nt>&#34;log&#34;</span><span class=p>:{</span>                              <span class=err>#</span> <span class=err>运行日志相关配置</span>
     <span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span>                         <span class=err>#</span> <span class=err>0:debug,</span> <span class=err>1:info,</span> <span class=err>2:warn,</span> <span class=err>3:error,</span> <span class=err>4:panic,</span> <span class=err>5:fatal</span>
     <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/tmp/worker.log&#34;</span>      <span class=err>#</span> <span class=err>运行日志文件，会自动轮转</span>
   <span class=p>},</span>
   <span class=nt>&#34;auditlog&#34;</span><span class=p>:</span> <span class=p>{</span>                        <span class=err>#</span> <span class=err>审计日志相关配置</span>
     <span class=nt>&#34;logdir&#34;</span><span class=p>:</span> <span class=s2>&#34;./auditlog/worker&#34;</span>      <span class=err>#</span> <span class=err>审计日志目录</span>
   <span class=p>}</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=cli>Cli</h3>
<ul>
<li>
<p>cli是blobstore提供的一个命令行工具，用于对blobstore进行管理操作；</p>
</li>
<li>
<p>cli通过<code>access-clinet</code>api 提供和access交互的能力；</p>
</li>
<li>
<p>cli可配置redis来缓存；</p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>//cli.conf</span>
<span class=p>{</span>
    <span class=nt>&#34;access&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;conn_mode&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>                          <span class=err>//4:</span> <span class=err>no</span> <span class=err>timeout</span>
        <span class=nt>&#34;consul_addr&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8500&#34;</span><span class=p>,</span>  <span class=err>//</span>
        <span class=nt>&#34;max_host_retry&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;max_part_retry&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;max_size_put_once&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nt>&#34;priority_addrs&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;http://localhost:9500&#34;</span><span class=p>,</span>
            <span class=s2>&#34;http://127.0.0.1:9500&#34;</span>
        <span class=p>],</span>
        <span class=nt>&#34;service_interval_ms&#34;</span><span class=p>:</span> <span class=mi>0</span>
    <span class=p>},</span>
    <span class=nt>&#34;redis_addrs&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>&#34;127.0.0.1:6379&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;redis_user&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;redis_pass&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
    <span class=nt>&#34;cm_addrs&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>&#34;http://localhost:9998&#34;</span><span class=p>,</span>
        <span class=s2>&#34;http://127.0.0.1:9998&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;verbose&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;vverbose&#34;</span><span class=p>:</span> <span class=kc>false</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=外部组件>外部组件</h2>
<h3 id=consul>Consul</h3>
<ul>
<li>提供cluster信息注册，查询服务；</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// ConsulRegisterPath
</span><span class=c1></span>                   <span class=nx>key</span>                             <span class=nx>value</span>
<span class=nx>clusterMgr</span><span class=p>:</span> <span class=nx>ebs</span><span class=o>/</span><span class=p>&lt;</span><span class=nx>region</span><span class=p>&gt;</span><span class=o>/</span><span class=nx>clusters</span><span class=o>/</span><span class=p>&lt;</span><span class=nx>cluster_id</span><span class=p>&gt;</span> <span class=p>:</span>  <span class=p>&lt;</span><span class=nx>cluster_info</span><span class=p>&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=mongodb>MongoDB</h3>
<ul>
<li>
<p>mongodb用于存储scheduler模块调度信息；</p>
</li>
<li></li>
</ul>
<table>
<thead>
<tr>
<th>db</th>
<th>dafault table</th>
<th>config key</th>
<th>说明</th>
<th>模块</th>
</tr>
</thead>
<tbody>
<tr>
<td>scheduler</td>
<td></td>
<td>&ldquo;database:db_name&rdquo;</td>
<td></td>
<td>scheduler.conf</td>
</tr>
<tr>
<td></td>
<td>balance_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>disk_drop_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>repair_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>inspect_checkpoint_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>manual_migrate_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>svr_register_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>tasks_tbl</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id=kafka>Kafka</h3>
<ul>
<li>
<p>用于组件间异步 任务消息传递, mqproxy对其相关操作进行封装；</p>
</li>
<li>
<p>主要用来传递<code>shardRepair</code>和<code>blobDelete</code>两类消息；</p>
</li>
<li></li>
</ul>
<h3 id=redis>Redis</h3>
<ul>
<li>
<p>为access访问cm volume提供缓存；</p>
</li>
<li>
<p>缓存expires：30-60min;</p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//redis key
</span><span class=c1></span><span class=nx>GroupVolumeKey</span>   <span class=s>&#34;get-volume-&lt;cvid&gt;&#34;</span>
<span class=nx>RedisVolumeKey</span>   <span class=s>&#34;access/volume/&lt;clusterID&gt;/&lt;vid&gt;&#34;</span>  <span class=nx>Value</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>VolumePly</span><span class=p>{}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=参数>参数</h2>
<h3 id=blobnode-1>BlobNode</h3>
<ul>
<li>
<p>一个disk默认最多chunk数<code>DefaultMaxChunks</code>：8192;</p>
</li>
<li>
<p>一个chunk默认最大size<code>DefaultMaxChunk</code>: 1TiB;</p>
</li>
<li>
<p>默认chunk size<code>DefaultChunkSize</code>：16GiB;</p>
</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>//blobnode/core/config.go
</span><span class=c1></span>
    <span class=nx>DefaultDiskReservedSpaceB</span>           <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>60</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=c1>// 60 GiB
</span><span class=c1></span>    <span class=nx>DefaultChunkSize</span>                    <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>16</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=c1>// 16 GiB
</span><span class=c1></span>    <span class=nx>DefaultMaxChunks</span>                    <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>13</span><span class=p>)</span>  <span class=c1>// 8192
</span><span class=c1></span>    <span class=nx>DefaultChunkReleaseProtectionM</span>      <span class=p>=</span> <span class=mi>1440</span>            <span class=c1>// 1 days
</span><span class=c1></span>    <span class=nx>DefaultChunkGcCreateTimeProtectionM</span> <span class=p>=</span> <span class=mi>1440</span>            <span class=c1>// 1 days
</span><span class=c1></span>    <span class=nx>DefaultChunkGcModifyTimeProtectionM</span> <span class=p>=</span> <span class=mi>1440</span>            <span class=c1>// 1 days
</span><span class=c1></span>    <span class=nx>DefaultChunkCompactIntervalSec</span>      <span class=p>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>60</span>         <span class=c1>// 10 min
</span><span class=c1></span>    <span class=nx>DefaultChunkCleanIntervalSec</span>        <span class=p>=</span> <span class=mi>60</span>              <span class=c1>// 1 min
</span><span class=c1></span>    <span class=nx>DefaultDiskUsageIntervalSec</span>         <span class=p>=</span> <span class=mi>60</span>              <span class=c1>// 1 min
</span><span class=c1></span>    <span class=nx>DefaultDiskCleanTrashIntervalSec</span>    <span class=p>=</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span>         <span class=c1>// 60 min
</span><span class=c1></span>    <span class=nx>DefaultDiskTrashProtectionM</span>         <span class=p>=</span> <span class=mi>2880</span>            <span class=c1>// 2 days
</span><span class=c1></span>    <span class=nx>DefaultCompactBatchSize</span>             <span class=p>=</span> <span class=mi>1024</span>            <span class=c1>// 1024 counts
</span><span class=c1></span>    <span class=nx>DefaultCompactMinSizeThreshold</span>      <span class=p>=</span> <span class=mi>16</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span>  <span class=c1>// 16 GiB
</span><span class=c1></span>    <span class=nx>DefaultCompactTriggerThreshold</span>      <span class=p>=</span> <span class=mi>1</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>40</span><span class=p>)</span>   <span class=c1>// 1 TiB
</span><span class=c1></span>    <span class=nx>DefaultMetricReportIntervalS</span>        <span class=p>=</span> <span class=mi>30</span>              <span class=c1>// 30 Sec
</span><span class=c1></span>    <span class=nx>DefaultCompactEmptyRateThreshold</span>    <span class=p>=</span> <span class=nb>float64</span><span class=p>(</span><span class=mf>0.8</span><span class=p>)</span>    <span class=c1>// 80% rate
</span><span class=c1></span>
<span class=c1>// blobnode/core/disk/disk.go
</span><span class=c1></span>    <span class=nx>MaxChunkSize</span>    <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>1024</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>)</span> <span class=c1>// 1024 GiB, 一个disk chunk最大size，
</span><span class=c1></span>
<span class=c1>// access config
</span><span class=c1></span><span class=nx>defaultMaxObjectSize</span> <span class=kt>int64</span> <span class=p>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>30</span><span class=p>)</span>  <span class=c1>//单个object最大put大小；
</span></code></pre></td></tr></table>
</div>
</div><h2 id=关键流程>关键流程</h2>
<h3 id=创建卷createvolume>创建卷(CreateVolume)</h3>
<ul>
<li>
<p><code>ClusterMgr</code>启动后，会根据配置为每种ec策略预先创建一定数量的Volume用于分配；</p>
</li>
<li>
<p>入口为clusterMgr中volumeMgr的<code>createVolume()</code>函数；</p>
</li>
<li>
<p>先通过<code>scopMgr.Alloc</code> 分配一个新vid;</p>
</li>
<li>
<p>根据mode获取unitCount(为tactic的N+M+L);</p>
</li>
<li>
<p>初始化volume units信息vuInfos；</p>
</li>
<li>
<p>初始化volInfo；</p>
</li>
<li>
<p>通过raft执行initCreateVolume指令，将volume信息记录到transitedTable中；</p>
</li>
<li>
<p>通过<code>allocChunkForAllUnits</code>为vol所有的units分配chunk;</p>
<ul>
<li>
<p>allocChunkForAllUnits会根据vol的编码策略，将chunk随机分布到不同idc上；</p>
</li>
<li>
<p>通过blobnode ChunkCreate rpc调用在blobnode上创建chunk;</p>
</li>
</ul>
</li>
<li>
<p>通过raft执行CreateVolume指令，删除transitedTbl中的volume units，将volume units相关信息记录到volumeTbl中 ；</p>
</li>
</ul>
<h3 id=写入put>写入(Put)</h3>
<ul>
<li>
<p>put提供将数据写入到blobstore中的能力；</p>
</li>
<li></li>
</ul>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/08-10-44-35-2022-02-08-10-44-24-image.png alt></p>
<p>Put流程从access-client中的<code>Put()</code>方法开始：</p>
<h4 id=access-client-1>access-client</h4>
<ul>
<li>
<p>access-client <code>Put()</code>流程：</p>
<ul>
<li>
<p>根据数据判断，如果size == 0， 返回空location；</p>
</li>
<li>
<p>Size &lt;= MaxSizePutOnec(默认：256MB) ，通过<code>putObject()</code>单个对象上传；</p>
</li>
<li>
<p>否则，通过<code>putParts</code>分块上传：</p>
</li>
</ul>
</li>
<li>
<p>putObject流程：</p>
<ul>
<li>
<p>数据size小于PutOnce缓存(默认: 8MB)，把数据一次读入buffer中；</p>
</li>
<li>
<p>调用access put rpc将数据put上去；</p>
</li>
<li>
<p>返回location;</p>
</li>
</ul>
</li>
<li>
<p>putParts流程：</p>
<ul>
<li>
<p>通过rpc 从access中alloc一个location和tokens</p>
</li>
<li>
<p>启动一个后台goroutine，将数据按<code>config.PartConcurrenc（默认：4）</code>读取到buffer中；</p>
</li>
<li>
<p>将buffer中的数据增加token，cid，vid等相关信息组装为一个parts；</p>
</li>
<li>
<p>通过<code>putPartsBatch</code>将parts批量上传；</p>
</li>
</ul>
</li>
</ul>
<h4 id=access>access</h4>
<ul>
<li>
<p>access put rpc的入口为<code>service.Put</code>, 其处理流程如下：</p>
<ul>
<li>
<p>ParseArgs(args)解析参数；</p>
</li>
<li>
<p>args.IsValid()判断参数是否有效；</p>
</li>
<li>
<p>根据args中的hashes设置hasherMap;</p>
</li>
<li>
<p>调用<code>streamHandler.Put()</code></p>
</li>
<li>
<p>通过hasherMap计算返回的hashSumMap;</p>
</li>
</ul>
</li>
<li>
<p>stream_put Put()流程：</p>
<ul>
<li>
<p>如果size>maxObjectSize(默认：256MB), 返回错误；</p>
</li>
<li>
<p>如果hasherMap个数>0; 复制一个reader用于计算hash；</p>
</li>
<li>
<p>调用SelectCodeMode(size)，根据大小选择一个合适的纠删码策略；</p>
</li>
<li>
<p>根据access配置<code>MaxBlobSize</code>，设置blobSize(默认: 4MB)；</p>
</li>
<li>
<p>调用<code>allocFromAllocatorWithHystrix()</code>, 根据纠删码、size, blobSize，从allocator分配<code>clusterID,blobs</code>, blob个数由size, blobSize计算而来；</p>
</li>
<li>
<p>根据要读取blob的大小和纠删码策略，在编码器encoder中<code>ec.NewBuffer()</code>一块ec.Buffer；</p>
</li>
<li>
<p>通过<code>ec.Split()</code>将ec.Buffer中数据缓存切分为对应编码的<code>shards</code>;</p>
</li>
<li>
<p>依次处理各个blob：</p>
<ul>
<li>
<p>读取blob数据填充到ec.Buffer的dataBuf中；</p>
</li>
<li>
<p>调用对应编码器的<code>Encode()</code>将shards进行编码；</p>
</li>
<li>
<p>通过<code>writeToBlobnodesWithHystrix()</code>将shards写入到blobnode中；</p>
</li>
<li>
<p>如果有写入出错的个数>0, 则调用<code>RepairMsgBg()</code>，往<code>mqproxy</code>发送repair消息<code>sendRepairMsgBg</code>；</p>
</li>
</ul>
</li>
<li>
<p>上传过程如果不成功，通过<code>clearGarbage()</code>清理无用垃圾数据；</p>
</li>
</ul>
</li>
<li>
<p><code>ec.NewBuffer()</code>建立编码缓冲区流程：</p>
<ul>
<li>
<p>根据dataSize和编码策略数据分片数shardN，计算每个分片的大小<code>shardSize=(dataSize+shardN-1)/shardN</code>;</p>
</li>
<li>
<p>根据分片大小shardSize和策略参数，计算编码总缓冲大小<code>ecSize=shardSize*(N+M+L)</code>;</p>
</li>
<li>
<p>从内存池中申请ecSize大小的缓存buf；</p>
</li>
<li>
<p>根据参数设置buf中的不同部分；</p>
</li>
<li>
<p>返回设置好的Buffer；</p>
</li>
</ul>
</li>
<li>
<p><code>writeToBlobnodes()</code>数据写入到blobnode流程：</p>
<ul>
<li>根据clusterID、vid参数获取volume；</li>
<li>获取volume中的ec相关参数(包括：tactic，putQuorum等)；</li>
<li>根据volume中的units, 开启goroutine，通过<code>h.blobnodeClient.PutShard()</code>往blobnode节点同时发送写入shard请求；</li>
<li>等待请求发送完后，如果写入成功的个数<code>writtenNum>=putQuorum</code>成功写入标准()，则写入成功；</li>
<li>否则, 判断当AZCount >=3时，如果一个AZ down掉，判断剩下的AZ是否每个shard都写入成功，如果是，则也可以判断写入成功；</li>
<li>否则写入不成功，返回错误；</li>
</ul>
</li>
</ul>
<h4 id=blobnode-2>blobnode</h4>
<ul>
<li>
<p>blobnode <code>ShardPut_()</code>:</p>
<ul>
<li>ShardPut_接收<code>access</code>节点发送的PutShard Rpc调用，执行shard put 写入shard数据操作；</li>
</ul>
</li>
<li>
<p>datafile Write():</p>
<ul>
<li>
<p>根据<code>Shard.Size</code>大小， 计算(Alignphysize)写入到chunkfile中的编码后物理大小phySize(Shard 包含header，footer和block crc)；</p>
</li>
<li>
<p>根据phySize在datafile中分配待写入空间(allocSpace), 更新变量(cd.wOff)写入偏移(偏移需和4k对齐),并获取旧的(cd.wOff)作为<code>shard.Offset</code>本次shard写入偏移；</p>
</li>
<li>
<p>写入shard header数据到chunk file；</p>
</li>
<li>
<p><code>crc32block.NewEncoder</code>新建一个crc编码写入器，通过编码器将数据编码，并写入到chunkfile的shard header数据区后面；</p>
</li>
<li>
<p>写入shard footer数据到 chunk file；</p>
</li>
<li></li>
</ul>
</li>
</ul>
<h3 id=读取get>读取(Get)</h3>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2022/02/08-10-45-04-2022-02-08-10-44-59-image.png alt></p>
<h4 id=access-client-2>access-client</h4>
<ul>
<li>
<p>access-client 中get入口为<code>api/access/client.go (c *client)Get()</code>；</p>
</li>
<li>
<p>先检查get参数有效性，如果size 为0，直接返回空；</p>
</li>
<li>
<p>然后随机顺序向多个access发送get rpc请求，返回第一个成功的请求；</p>
</li>
</ul>
<h4 id=access-1>access</h4>
<ul>
<li>
<p>access 由<code>access/stream_get.go （h *Handler)Get()</code>负责get rpc 入口；</p>
</li>
<li>
<p>先调用<code>genLocationBlobs</code>根据参数<code>location,offset,readSize</code>获取location中需要读取的blobs；</p>
</li>
<li>
<p>在根据location获取clusterMgr controller sc;</p>
</li>
<li>
<p>如果<code>len(blobs)== 1</code>, 如果大小较小，直接调用<code>getDataShardOnly()</code>读取blob数据；</p>
</li>
<li>
<p>开启一个后台协程，依次通过<code>readOneBlob</code>从blobnode读取blobs中的每个blob的数据，通过chan传送个主流程</p>
</li>
<li>
<p>主流程依次接收读取的数据，并写入到get结果的buffer中；</p>
</li>
<li>
<p>读取一个blob数据<code>access/readOneBlob()</code>:</p>
<ul>
<li>
<p>根据BlobSize和编码策略，分配一块新的EC buffer<code>GetBufferSizes()</code>；</p>
</li>
<li>
<p>// 1. try to min-read shards byte</p>
</li>
<li>
<p>// 2. if failed try to read next shard to reconstruct</p>
</li>
<li>
<p> // 3. write the the right offset bytes to writer</p>
</li>
</ul>
</li>
</ul>
<h4 id=blobnode-3>blobnode</h4>
<ul>
<li>
<p>ShardGet_:</p>
</li>
<li></li>
</ul>
<h3 id=删除delete>删除(Delete)</h3>
<ul>
<li>
<p>删除调用了punch hole来是否被删除的data；</p>
</li>
<li>
<p>通过compact异步对碎片化过多的chunkfile进行整理；</p>
</li>
</ul>
<h3 id=合并compact>合并(Compact)</h3>
<ul>
<li>
<p>compact用于在后台整理chunkfile，由blobnode提供了rpc api；</p>
</li>
<li>
<p>chunkfile 是否需要compact（<code>NeedCompact</code>）:</p>
<ul>
<li>chunk file size >= <code>conf.CompactTriggerThredshold(默认：1TiB)</code>，return true；</li>
<li>chunk file size > <code>conf.CompactMinSizeThreshold(默认: 16GB)</code>且chunkfile 稀疏率>=80%(<code>CompactEnptyRateThreshold</code>参数);</li>
</ul>
</li>
<li>
<p>blobnode/core/chunk/chunk.doCompact():</p>
</li>
</ul>
<h3 id=iotype>IOType</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go>    <span class=nx>NormalIO</span>     <span class=nx>IOType</span> <span class=p>=</span> <span class=kc>iota</span> <span class=c1>// From: external: user io: read/write
</span><span class=c1></span>    <span class=nx>BackgroundIO</span>               <span class=c1>// From: external: repair, chunk transfer, delete
</span><span class=c1></span>    <span class=nx>CompactIO</span>                  <span class=c1>// From: internal: chunk compact
</span><span class=c1></span>    <span class=nx>DeleteIO</span>                   <span class=c1>// From: external: delete io
</span><span class=c1></span>    <span class=nx>InternalIO</span>                 <span class=c1>// From: internal: io, such rubbish clean, batch delete
</span></code></pre></td></tr></table>
</div>
</div><h2 id=安全>安全</h2>
<ul>
<li>uptoken</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// token between alloc and putat
</span><span class=c1></span>    <span class=c1>// TokenSize max size of token array
</span><span class=c1></span>    <span class=c1>// clusterID + vid + bid + count + time + size
</span><span class=c1></span>    <span class=nx>TokenSize</span> <span class=p>=</span> <span class=mi>4</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>+</span> <span class=mi>10</span> <span class=o>+</span> <span class=mi>5</span> <span class=o>+</span> <span class=mi>5</span> <span class=o>+</span> <span class=mi>5</span>

<span class=c1>// UploadToken token between alloc and putat
</span><span class=c1>// [0:8]   hmac (8) first 8 bytes of sha1 summary
</span><span class=c1>// [8:16]  minBid (8) in the SliceInfo
</span><span class=c1>// [16:20] count (4) in the SliceInfo
</span><span class=c1>// [20:24] time (4) expired unix utc time, 0 means not expired
</span><span class=c1></span><span class=kd>type</span> <span class=nx>UploadToken</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Data</span>   <span class=p>[</span><span class=nx>TokenSize</span><span class=p>]</span><span class=kt>byte</span>
    <span class=nx>Offset</span> <span class=kt>uint8</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=参考>参考</h2>
<ol>
<li>
<p><a href=https://cubefs.readthedocs.io/zh_CN/latest/design/blobstore.html>https://cubefs.readthedocs.io/zh_CN/latest/design/blobstore.html</a></p>
</li>
<li>
<p><a href=https://www.cnblogs.com/itlz/p/14090193.html>详解Hadoop3.x新特性功能-HDFS纠删码 - 五分钟学大数据 - 博客园</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/shelldon/article/details/54144730?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_default&utm_relevant_index=1">Erasure Code - EC纠删码原理_shelldon的专栏-CSDN博客_ec纠删码</a></p>
</li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2022-03-07
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/storage/>storage</a>
<a href=https://justice.bj.cn/tags/chubaofs/>chubaofs</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/leetcode/doc/239.%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%9C%80%E5%A4%A7%E5%80%BC/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">滑动窗口最大值</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/40.storage/chubaofs/cubefs-blobstore%E9%85%8D%E7%BD%AE/>
<span class="next-text nav-default">CubeFS-BlobStore配置</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js></script>
</body>
</html>