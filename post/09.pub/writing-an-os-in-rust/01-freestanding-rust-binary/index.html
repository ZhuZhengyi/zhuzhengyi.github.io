<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>使用Rust编写操作系统（一）：独立式可执行程序 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="使用Rust编写操作系统（一）：独立式可执行程序 我们的第一步，是在不连接标准库的前提下，创建独立的Rust可执行文件。无需底层操作系统的支撑">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/09.pub/writing-an-os-in-rust/01-freestanding-rust-binary/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="使用Rust编写操作系统（一）：独立式可执行程序">
<meta property="og:description" content="使用Rust编写操作系统（一）：独立式可执行程序 我们的第一步，是在不连接标准库的前提下，创建独立的Rust可执行文件。无需底层操作系统的支撑">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/09.pub/writing-an-os-in-rust/01-freestanding-rust-binary/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2024-03-07T11:58:54+08:00">
<meta property="article:modified_time" content="2024-03-07T11:58:54+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="使用Rust编写操作系统（一）：独立式可执行程序">
<meta itemprop=description content="使用Rust编写操作系统（一）：独立式可执行程序 我们的第一步，是在不连接标准库的前提下，创建独立的Rust可执行文件。无需底层操作系统的支撑"><meta itemprop=datePublished content="2024-03-07T11:58:54+08:00">
<meta itemprop=dateModified content="2024-03-07T11:58:54+08:00">
<meta itemprop=wordCount content="5843">
<meta itemprop=keywords content="pub,writing-an-os-in-rust,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="使用Rust编写操作系统（一）：独立式可执行程序">
<meta name=twitter:description content="使用Rust编写操作系统（一）：独立式可执行程序 我们的第一步，是在不连接标准库的前提下，创建独立的Rust可执行文件。无需底层操作系统的支撑"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>使用Rust编写操作系统（一）：独立式可执行程序</h1>
<div class=post-meta>
<time datetime=2024-03-07 class=post-time>
2024-03-07 11:58:54
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/pub/> pub </a>
<a href=https://justice.bj.cn/categories/writing-an-os-in-rust/> writing-an-os-in-rust </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#禁用标准库>禁用标准库</a>
<ul>
<li><a href=#no_std属性>no_std属性</a></li>
</ul>
</li>
<li><a href=#实现panic处理函数>实现panic处理函数</a></li>
<li><a href=#eh_personality语言项>eh_personality语言项</a>
<ul>
<li><a href=#禁用栈展开>禁用栈展开</a></li>
</ul>
</li>
<li><a href=#start语言项>start语言项</a>
<ul>
<li><a href=#重写入口点>重写入口点</a></li>
</ul>
</li>
<li><a href=#链接器错误>链接器错误</a>
<ul>
<li><a href=#编译为裸机目标>编译为裸机目标</a></li>
<li><a href=#链接器参数>链接器参数</a></li>
</ul>
</li>
<li><a href=#小结>小结</a></li>
<li><a href=#下篇预告>下篇预告</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=使用rust编写操作系统一独立式可执行程序>使用Rust编写操作系统（一）：独立式可执行程序</h1>
<p>我们的第一步，是在不连接标准库的前提下，创建独立的Rust可执行文件。无需底层操作系统的支撑，这将能让在<strong>裸机</strong>（<a href=https://en.wikipedia.org/wiki/Bare_machine>bare metal</a>）上运行Rust代码成为现实。</p>
<h2 id=简介>简介</h2>
<p>要编写一个操作系统内核，我们的代码应当不基于任何的操作系统特性。这意味着我们不能使用线程、文件、堆内存、网络、随机数、标准输出，或其它任何需要特定硬件和操作系统抽象的特性；这其实讲得通，因为我们正在编写自己的硬件驱动和操作系统。</p>
<p>实现这一点，意味着我们不能使用<a href=https://doc.rust-lang.org/std/>Rust标准库</a>的大部分；但还有很多Rust特性是我们依然可以使用的。比如说，我们可以使用<a href=https://doc.rust-lang.org/book/ch13-02-iterators.html>迭代器</a>、<a href=https://doc.rust-lang.org/book/ch13-01-closures.html>闭包</a>、<a href=https://doc.rust-lang.org/book/ch06-00-enums.html>模式匹配</a>、<a href=https://doc.rust-lang.org/core/option/>Option</a>、<a href=https://doc.rust-lang.org/core/result/index.html>Result</a>、<a href=https://doc.rust-lang.org/core/macro.write.html>字符串格式化</a>，当然还有<a href=https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html>所有权系统</a>。这些功能让我们能够编写表达性强、高层抽象的操作系统，而无需操心<a href=https://www.nayuki.io/page/undefined-behavior-in-c-and-cplusplus-programs>未定义行为</a>和<a href=https://tonyarcieri.com/it-s-time-for-a-memory-safety-intervention>内存安全</a>。</p>
<p>为了用Rust编写一个操作系统内核，我们需要独立于操作系统，创建一个可执行程序。这样的可执行程序常被称作<strong>独立式可执行程序</strong>（freestanding executable）或<strong>裸机程序</strong>(bare-metal executable)。</p>
<p>在这篇文章里，我们将逐步地创建一个独立式可执行程序，并且详细解释为什么每个步骤都是必须的。如果读者只对最终的代码感兴趣，可以跳转到本篇文章的小结部分。</p>
<h2 id=禁用标准库>禁用标准库</h2>
<p>在默认情况下，所有的Rust<strong>包</strong>（crate）都会链接<strong>标准库</strong>（<a href=https://doc.rust-lang.org/std/>standard library</a>），而标准库依赖于操作系统功能，如线程、文件系统、网络。标准库还与<strong>Rust的C语言标准库实现库</strong>（libc）相关联，它也是和操作系统紧密交互的。既然我们的计划是编写自己的操作系统，我们就可以不使用任何与操作系统相关的库——因此我们必须禁用<strong>标准库自动引用</strong>（automatic inclusion）。使用<a href=https://doc.rust-lang.org/book/first-edition/using-rust-without-the-standard-library.html>no_std属性</a>可以实现这一点。</p>
<p>我们可以从创建一个新的cargo项目开始。最简单的办法是使用下面的命令：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>&gt; cargo new blog_os
</code></pre></td></tr></table>
</div>
</div><p>这里，我把项目命名为<code>blog_os</code>，当然读者也可以选择自己的项目名称。这里，cargo默认为我们添加了<code>--bin</code>选项，说明我们将要创建一个可执行文件（而不是一个库）；cargo还为我们添加了<code>--edition 2018</code>标签，指明项目的包要使用Rust的<strong>2018版次</strong>（<a href=https://rust-lang-nursery.github.io/edition-guide/rust-2018/index.html>2018 edition</a>）。当我们执行这行指令的时候，cargo为我们创建的目录结构如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-text data-lang=text>blog_os
├── Cargo.toml
└── src
    └── main.rs
</code></pre></td></tr></table>
</div>
</div><p>在这里，<code>Cargo.toml</code>文件包含了包的<strong>配置</strong>（configuration），比如包的名称、作者、<a href=http://semver.org/>semver版本</a>和项目依赖项；<code>src/main.rs</code>文件包含包的<strong>根模块</strong>（root module）和main函数。我们可以使用<code>cargo build</code>来编译这个包，然后在<code>target/debug</code>文件夹内找到编译好的<code>blog_os</code>二进制文件。</p>
<h3 id=no_std属性>no_std属性</h3>
<p>现在我们的包依然隐式地与标准库链接。为了禁用这种链接，我们可以尝试添加<a href=https://doc.rust-lang.org/book/first-edition/using-rust-without-the-standard-library.html>no_std属性</a>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=c1>// main.rs
</span><span class=c1></span><span class=w>
</span><span class=w></span><span class=cp>#![no_std]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;Hello, world!&#34;</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>看起来非常顺利。但我们使用<code>cargo build</code>来编译时，却出现了下面的错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>error</span>: <span class=nc>cannot</span><span class=w> </span><span class=n>find</span><span class=w> </span><span class=kr>macro</span><span class=w> </span><span class=err>`</span><span class=n>println</span><span class=o>!</span><span class=err>`</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>scope</span><span class=w>
</span><span class=w> </span><span class=o>-</span>-&gt; <span class=nc>src</span><span class=err>\</span><span class=n>main</span><span class=p>.</span><span class=n>rs</span>:<span class=mi>4</span>:<span class=mi>5</span><span class=w>
</span><span class=w>  </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;Hello, world!&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>  </span><span class=o>|</span><span class=w>     </span><span class=o>^^^^^^^</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>出现这个错误的原因是，<a href=https://doc.rust-lang.org/std/macro.println.html>println!宏</a>是标准库的一部分，而我们的项目不再依赖标准库。我们选择不再打印字符串。这也能解释得通，因为<code>println!</code>将会向<strong>标准输出</strong>（<a href=https://en.wikipedia.org/wiki/Standard_streams#Standard_output_.28stdout.29>standard output</a>）打印字符，它依赖于特殊的文件描述符；这个特性是由操作系统提供的。</p>
<p>所以我们可以移除这行代码，这样main函数就是空的了。再次编译：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=c1>// main.rs
</span><span class=c1></span><span class=w>
</span><span class=w></span><span class=cp>#![no_std]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=o>&gt;</span><span class=w> </span><span class=n>cargo</span><span class=w> </span><span class=n>build</span><span class=w>
</span><span class=w></span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=o>`</span><span class=c1>#[panic_handler]` function required, but not found
</span><span class=c1></span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>language</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=n>required</span><span class=p>,</span><span class=w> </span><span class=n>but</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=n>found</span><span class=p>:</span><span class=w> </span><span class=o>`</span><span class=n>eh_personality</span><span class=o>`</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>现在我们发现，代码缺少一个<code>#[panic_handler]</code>函数和一个<strong>语言项</strong>（language item）。</p>
<h2 id=实现panic处理函数>实现panic处理函数</h2>
<p><code>panic_handler</code>属性被用于定义一个函数；在程序panic时，这个函数将会被调用。标准库中提供了自己的panic处理函数，但在<code>no_std</code>环境中，我们需要定义自己的panic处理函数：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=c1>// in main.rs
</span><span class=c1></span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>core</span>::<span class=n>panic</span>::<span class=n>PanicInfo</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=sd>/// 这个函数将在panic时被调用
</span><span class=sd></span><span class=cp>#[panic_handler]</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>panic</span><span class=p>(</span><span class=n>_info</span>: <span class=kp>&amp;</span><span class=nc>PanicInfo</span><span class=p>)</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>类型为<a href=https://doc.rust-lang.org/nightly/core/panic/struct.PanicInfo.html>PanicInfo</a>的参数包含了panic发生的文件名、代码行数和可选的错误信息。这个函数从不返回，所以他被标记为<strong>发散函数</strong>（<a href=https://doc.rust-lang.org/book/first-edition/functions.html#diverging-functions>diverging function</a>）。发散函数的返回类型称作<strong>Never类型</strong>（<a href=https://doc.rust-lang.org/nightly/std/primitive.never.html>&ldquo;never&rdquo; type</a>），记为<code>!</code>。对这个函数，我们目前能做的事情很少，所以我们只需编写一个无限循环<code>loop {}</code>。</p>
<h2 id=eh_personality语言项>eh_personality语言项</h2>
<p>语言项是一些编译器需求的特殊函数或类型。举例来说，Rust的<a href=https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html>Copy</a> trait是一个这样的语言项，告诉编译器哪些类型需要遵循<strong>复制语义</strong>（<a href=https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html>copy semantics</a>）——当我们查找<code>Copy</code> trait的<a href=https://github.com/rust-lang/rust/blob/485397e49a02a3b7ff77c17e4a3f16c653925cb3/src/libcore/marker.rs#L296-L299>实现</a>时，我们会发现，一个特殊的<code>#[lang = "copy"]</code>属性将它定义为了一个语言项，达到与编译器联系的目的。</p>
<p>我们可以自己实现语言项，但这只应该是最后的手段：目前来看，语言项是高度不稳定的语言细节实现，它们不会经过编译期类型检查（所以编译器甚至不确保它们的参数类型是否正确）。幸运的是，我们有更稳定的方式，来修复上面的语言项错误。</p>
<p><code>eh_personality</code>语言项标记的函数，将被用于实现<strong>栈展开</strong>（<a href=http://www.bogotobogo.com/cplusplus/stackunwinding.php>stack unwinding</a>）。在使用标准库的情况下，当panic发生时，Rust将使用栈展开，来运行在栈上活跃的所有变量的<strong>析构函数</strong>（destructor）——这确保了所有使用的内存都被释放，允许调用程序的<strong>父进程</strong>（parent thread）捕获panic，处理并继续运行。但是，栈展开是一个复杂的过程，如Linux的<a href=http://www.nongnu.org/libunwind/>libunwind</a>或Windows的<strong>结构化异常处理</strong>（<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680657(v=vs.85).aspx">structured exception handling, SEH</a>），通常需要依赖于操作系统的库；所以我们不在自己编写的操作系统中使用它。</p>
<h3 id=禁用栈展开>禁用栈展开</h3>
<p>在其它一些情况下，栈展开不是迫切需求的功能；因此，Rust提供了<strong>panic时中止</strong>（<a href=https://github.com/rust-lang/rust/pull/32900>abort on panic</a>）的选项。这个选项能禁用栈展开相关的标志信息生成，也因此能缩小生成的二进制程序的长度。有许多方式能打开这个选项，最简单的方式是把下面的几行设置代码加入我们的<code>Cargo.toml</code>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=nx>profile</span><span class=p>.</span><span class=nx>dev</span><span class=p>]</span>
<span class=nx>panic</span> <span class=p>=</span> <span class=s2>&#34;abort&#34;</span>

<span class=p>[</span><span class=nx>profile</span><span class=p>.</span><span class=nx>release</span><span class=p>]</span>
<span class=nx>panic</span> <span class=p>=</span> <span class=s2>&#34;abort&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>这些选项能将<strong>dev配置</strong>（dev profile）和<strong>release配置</strong>（release profile）的panic策略设为<code>abort</code>。<code>dev</code>配置适用于<code>cargo build</code>，而<code>release</code>配置适用于<code>cargo build --release</code>。现在编译器应该不再要求我们提供<code>eh_personality</code>语言项实现。</p>
<p>现在我们已经修复了出现的两个错误，可以信心满满地开始编译了。然而，尝试编译运行后，一个新的错误出现了：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>&gt; cargo build
error: requires <span class=sb>`</span>start<span class=sb>`</span> lang_item
</code></pre></td></tr></table>
</div>
</div><h2 id=start语言项>start语言项</h2>
<p>这里，我们的程序遗失了<code>start</code>语言项，它将定义一个程序的<strong>入口点</strong>（entry point）。</p>
<p>我们通常会认为，当运行一个程序时，首先被调用的是<code>main</code>函数。但是，大多数语言都拥有一个<strong>运行时系统</strong>（<a href=https://en.wikipedia.org/wiki/Runtime_system>runtime system</a>），它通常为<strong>垃圾回收</strong>（garbage collection）或<strong>绿色线程</strong>（software threads，或green threads）服务，如Java的GC或Go语言的协程（goroutine）；这个运行时系统需要在main函数前启动，因为它需要让程序初始化。</p>
<p>一个典型的使用标准库的Rust程序，它的运行将从名为<code>crt0</code>的运行时库开始。<code>crt0</code>意为C runtime zero，它能建立一个适合运行C语言程序的环境，这包含了栈的创建和可执行程序参数的传入。这之后，这个运行时库会调用<a href=https://github.com/rust-lang/rust/blob/bb4d1491466d8239a7a5fd68bd605e3276e97afb/src/libstd/rt.rs#L32-L73>Rust的运行时入口点</a>，这个入口点被称作<strong>start语言项</strong>（&ldquo;start&rdquo; language item）。Rust只拥有一个极小的运行时，它只拥有较少的功能，如爆栈检测和打印<strong>堆栈轨迹</strong>（stack trace）。这之后，运行时将会调用main函数。</p>
<p>我们的独立式可执行程序并不能访问Rust运行时或<code>crt0</code>库，所以我们需要定义自己的入口点。实现一个<code>start</code>语言项并不能解决问题，因为这之后程序依然要求<code>crt0</code>库。所以，我们要做的是，直接重写整个<code>crt0</code>库和它定义的入口点。</p>
<h3 id=重写入口点>重写入口点</h3>
<p>要告诉Rust编译器我们不使用预定义的入口点，我们可以添加<code>#![no_main]</code>属性。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#![no_std]</span><span class=w>
</span><span class=w></span><span class=cp>#![no_main]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>core</span>::<span class=n>panic</span>::<span class=n>PanicInfo</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=sd>/// 这个函数将在panic时被调用
</span><span class=sd></span><span class=cp>#[panic_handler]</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>panic</span><span class=p>(</span><span class=n>_info</span>: <span class=kp>&amp;</span><span class=nc>PanicInfo</span><span class=p>)</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>读者也许会注意到，我们移除了<code>main</code>函数。很显然，既然没有底层已有的运行时调用它，<code>main</code>函数将不会被运行。为了重写操作系统的入口点，我们转而编写一个<code>_start</code>函数：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[no_mangle]</span><span class=w>
</span><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>_start</span><span class=p>()</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>我们使用<code>no_mangle</code>标记这个函数，来对它禁用<strong>名称重整</strong>（<a href=https://en.wikipedia.org/wiki/Name_mangling>name mangling</a>）——这确保Rust编译器输出一个名为<code>_start</code>的函数；否则，编译器可能最终生成名为<code>_ZN3blog_os4_start7hb173fedf945531caE</code>的函数，无法让链接器正确辨别。</p>
<p>我们还将函数标记为<code>extern "C"</code>，告诉编译器这个函数应当使用<a href=https://en.wikipedia.org/wiki/Calling_convention>C语言的调用约定</a>，而不是Rust语言的调用约定。函数名为<code>_start</code>，是因为大多数系统默认使用这个名字作为入口点名称。</p>
<p>与前文的<code>panic</code>函数类似，这个函数的返回值类型为<code>!</code>——它定义了一个发散函数，或者说一个不允许返回的函数。这一点是必要的，因为这个入口点不将被任何函数调用，但将直接被操作系统或<strong>引导程序</strong>（bootloader）调用。所以作为函数返回的替换，这个入口点应该调用，比如操作系统提供的<strong>exit系统调用</strong>（<a href=https://en.wikipedia.org/wiki/Exit_(system_call)>&ldquo;exit&rdquo; system call</a>）函数。在我们编写操作系统的情况下，关机应该是一个合适的选择，因为<strong>当一个独立式可执行程序返回时，不会留下任何需要做的事情</strong>（there is nothing to do if a freestanding binary returns）。暂时来看，我们可以添加一个无限循环，这样可以符合返回值的类型。</p>
<p>如果我们现在编译这段程序，会出来一大段不太好看的<strong>链接器错误</strong>（linker error）。</p>
<h2 id=链接器错误>链接器错误</h2>
<p><strong>链接器</strong>（linker）是一个程序，它将生成的目标文件组合为一个可执行文件。不同的操作系统如Windows、macOS、Linux，规定了不同的可执行文件格式，因此也各有自己的链接器，抛出不同的错误；但这些错误的根本原因还是相同的：链接器的默认配置假定程序依赖于C语言的运行时环境，但我们的程序并不依赖于它。</p>
<p>为了解决这个错误，我们需要告诉链接器，它不应该包含（include）C语言运行环境。我们可以选择提供特定的<strong>链接器参数</strong>（linker argument），也可以选择编译为<strong>裸机目标</strong>（bare metal target）。</p>
<h3 id=编译为裸机目标>编译为裸机目标</h3>
<p>在默认情况下，Rust尝试适配当前的系统环境，编译可执行程序。举个栗子，如果你使用<code>x86_64</code>平台的Windows系统，Rust将尝试编译一个扩展名为<code>.exe</code>的Windows可执行程序，并使用<code>x86_64</code>指令集。这个环境又被称作你的<strong>宿主系统</strong>（&ldquo;host&rdquo; system）。</p>
<p>为了描述不同的环境，Rust使用一个称为<strong>目标三元组</strong>（target triple）的字符串。要查看当前系统的目标三元组，我们可以运行<code>$ rustc --version --verbose</code>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>rustc 1.35.0-nightly (474e7a648 2019-04-07)
binary: rustc
commit-hash: 474e7a6486758ea6fc761893b1a49cd9076fb0ab
commit-date: 2019-04-07
host: x86_64-unknown-linux-gnu
release: 1.35.0-nightly
LLVM version: 8.0
</code></pre></td></tr></table>
</div>
</div><p>上面这段输出来自于<code>x86_64</code>平台下的Linux系统。我们能看到，<code>host</code>字段的值为三元组<code>x86_64-unknown-linux-gnu</code>，它分为以下几个部分：CPU架构<code>x86_64</code>；供应商<code>unknown</code>；操作系统<code>linux</code>和<a href=https://en.wikipedia.org/wiki/Application_binary_interface>二进制接口</a><code>gnu</code>。</p>
<p>Rust编译器尝试为当前系统的三元组编译，并假定底层有一个类似于Windows或Linux的操作系统提供C语言运行环境——这将导致链接器错误。所以，为了避免这个错误，我们可以另选一个底层没有操作系统的运行环境。</p>
<p>这样的运行环境被称作裸机环境，例如目标三元组<code>thumbv7em-none-eabihf</code>描述了一个ARM<strong>嵌入式系统</strong>（<a href=https://en.wikipedia.org/wiki/Embedded_system>embedded system</a>）。我们暂时不需要了解它的细节，只需要知道这个环境底层没有操作系统——这是由三元组中的<code>none</code>描述的。我们需要用rustup安装这个目标：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>rustup target add thumbv7em-none-eabihf
</code></pre></td></tr></table>
</div>
</div><p>这行命令将为目标下载一个标准库和core库。这之后，我们就能为这个目标构建独立式可执行程序了：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo build --target thumbv7em-none-eabihf
</code></pre></td></tr></table>
</div>
</div><p>我们传递了<code>--target</code>参数，来为裸机目标系统<strong>交叉编译</strong>（<a href=https://en.wikipedia.org/wiki/Cross_compiler>cross compile</a>）我们的程序。我们的目标并不包括操作系统，所以链接器不会试着链接C语言运行环境，因此构建过程成功完成，不会产生链接器错误。</p>
<p>我们将使用这个方法编写自己的操作系统内核。我们不将编译到<code>thumbv7em-none-eabihf</code>，而是使用描述<code>x86_64</code>环境的<strong>自定义目标</strong>（<a href=https://doc.rust-lang.org/rustc/targets/custom.html>custom target</a>）。在下篇文章中，我们将详细描述一些相关的细节。</p>
<h3 id=链接器参数>链接器参数</h3>
<p>我们也可以选择不编译到裸机系统，因为传递特定的参数也能解决链接器错误问题。虽然我们不将在后文中使用这个方法，为了教程的完整性，我们也撰写了专门的短文，来提供这个途径的解决方案。</p>
<p><a href=./appendix-a-linker-arguments.md>链接器参数</a></p>
<h2 id=小结>小结</h2>
<p>一个用Rust编写的最小化的独立式可执行程序应该长这样：</p>
<p><code>src/main.rs</code>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#![no_std]</span><span class=w> </span><span class=c1>// 不链接Rust标准库
</span><span class=c1></span><span class=cp>#![no_main]</span><span class=w> </span><span class=c1>// 禁用所有Rust层级的入口点
</span><span class=c1></span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>core</span>::<span class=n>panic</span>::<span class=n>PanicInfo</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[no_mangle]</span><span class=w> </span><span class=c1>// 不重整函数名
</span><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>_start</span><span class=p>()</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=c1>// 因为编译器会寻找一个名为`_start`的函数，所以这个函数就是入口点
</span><span class=c1></span><span class=w>    </span><span class=c1>// 默认命名为`_start`
</span><span class=c1></span><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=sd>/// 这个函数将在panic时被调用
</span><span class=sd></span><span class=cp>#[panic_handler]</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>panic</span><span class=p>(</span><span class=n>_info</span>: <span class=kp>&amp;</span><span class=nc>PanicInfo</span><span class=p>)</span><span class=w> </span>-&gt; <span class=o>!</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p><code>Cargo.toml</code>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=nx>package</span><span class=p>]</span>
<span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;crate_name&#34;</span>
<span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.1.0&#34;</span>
<span class=nx>authors</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;Author Name &lt;author@example.com&gt;&#34;</span><span class=p>]</span>

<span class=c># 使用`cargo build`编译时需要的配置</span>
<span class=p>[</span><span class=nx>profile</span><span class=p>.</span><span class=nx>dev</span><span class=p>]</span>
<span class=nx>panic</span> <span class=p>=</span> <span class=s2>&#34;abort&#34;</span> <span class=c># 禁用panic时栈展开</span>

<span class=c># 使用`cargo build --release`编译时需要的配置</span>
<span class=p>[</span><span class=nx>profile</span><span class=p>.</span><span class=nx>release</span><span class=p>]</span>
<span class=nx>panic</span> <span class=p>=</span> <span class=s2>&#34;abort&#34;</span> <span class=c># 禁用panic时栈展开</span>
</code></pre></td></tr></table>
</div>
</div><p>选用任意一个裸机目标来编译。比如对<code>thumbv7em-none-eabihf</code>，我们使用以下命令：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>cargo build --target thumbv7em-none-eabihf
</code></pre></td></tr></table>
</div>
</div><p>要注意的是，现在我们的代码只是一个Rust编写的独立式可执行程序的一个例子。运行这个二进制程序还需要很多准备，比如在<code>_start</code>函数之前需要一个已经预加载完毕的栈。所以为了真正运行这样的程序，我们还有很多事情需要做。</p>
<h2 id=下篇预告>下篇预告</h2>
<p>基于这篇文章的成果，下一篇文章要做的更深。我们将详细讲述编写一个最小的操作系统内核需要的步骤：如何配置特定的编译目标，如何将可执行程序与引导程序拼接，以及如何把一些特定的字符串打印到屏幕上。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2024-03-07 11:58:54
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/pub/>pub</a>
<a href=https://justice.bj.cn/tags/writing-an-os-in-rust/>writing-an-os-in-rust</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/leetcode/106.%E4%BB%8E%E4%B8%AD%E5%BA%8F%E4%B8%8E%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86%E5%BA%8F%E5%88%97%E6%9E%84%E9%80%A0%E4%BA%8C%E5%8F%89%E6%A0%91/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">从中序与后序遍历序列构造二叉树</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/09.pub/writing-an-os-in-rust/07-hardware-interrupts/>
<span class="next-text nav-default">使用Rust编写操作系统（七）：硬件中断</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</body>
</html>