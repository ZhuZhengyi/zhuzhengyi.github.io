<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>使用Rust编写操作系统（附录一）：链接器参数 - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=referrer content="no-referrer">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="使用Rust编写操作系统（附录一）：链接器参数 用Rust编写操作系统时，我们可能遇到一些链接器错误。这篇文章中，我们不将更换编译目标，而传送">
<meta name=keywords content="tech,it,blog">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/09.pub/writing-an-os-in-rust/appendix-a-linker-arguments/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="使用Rust编写操作系统（附录一）：链接器参数">
<meta property="og:description" content="使用Rust编写操作系统（附录一）：链接器参数 用Rust编写操作系统时，我们可能遇到一些链接器错误。这篇文章中，我们不将更换编译目标，而传送">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/09.pub/writing-an-os-in-rust/appendix-a-linker-arguments/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2024-03-07T11:58:54+08:00">
<meta property="article:modified_time" content="2024-03-07T11:58:54+08:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="使用Rust编写操作系统（附录一）：链接器参数">
<meta itemprop=description content="使用Rust编写操作系统（附录一）：链接器参数 用Rust编写操作系统时，我们可能遇到一些链接器错误。这篇文章中，我们不将更换编译目标，而传送"><meta itemprop=datePublished content="2024-03-07T11:58:54+08:00">
<meta itemprop=dateModified content="2024-03-07T11:58:54+08:00">
<meta itemprop=wordCount content="2933">
<meta itemprop=keywords content="pub,writing-an-os-in-rust,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="使用Rust编写操作系统（附录一）：链接器参数">
<meta name=twitter:description content="使用Rust编写操作系统（附录一）：链接器参数 用Rust编写操作系统时，我们可能遇到一些链接器错误。这篇文章中，我们不将更换编译目标，而传送"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div id=fastSearch>
<input id=searchInput tabindex=0>
<ul id=searchResults>
</ul>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=http://passer-by.com/pacman/ rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=search-btn class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>使用Rust编写操作系统（附录一）：链接器参数</h1>
<div class=post-meta>
<time datetime=2024-03-07 class=post-time>
2024-03-07 11:58:54
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/pub/> pub </a>
<a href=https://justice.bj.cn/categories/writing-an-os-in-rust/> writing-an-os-in-rust </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#linux>Linux</a></li>
<li><a href=#windows>Windows</a></li>
<li><a href=#macos>macOS</a></li>
<li><a href=#统一所有的编译命令>统一所有的编译命令</a></li>
<li><a href=#我们应该这么做吗>我们应该这么做吗？</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=使用rust编写操作系统附录一链接器参数>使用Rust编写操作系统（附录一）：链接器参数</h1>
<p>用Rust编写操作系统时，我们可能遇到一些链接器错误。这篇文章中，我们不将更换编译目标，而传送特定的链接器参数，尝试修复错误。我们将在常用系统Linux、Windows和macOS下，举例编写裸机应用时，可能出现的一些链接器错误；我们将逐个处理它们，还将讨论这种方式开发的必要性。</p>
<p>要注意的是，可执行程序在不同操作系统下格式各异；所以在不同平台下，参数和错误信息可能略有不同。</p>
<h2 id=linux>Linux</h2>
<p>我们在Linux下尝试编写裸机程序，可能出现这样的链接器错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linking</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=o>`</span><span class=n>cc</span><span class=o>`</span><span class=w> </span><span class=n>failed</span><span class=p>:</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>  </span><span class=o>|</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cc&#34;</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>gcc</span><span class=o>/</span><span class=p>..</span><span class=o>/</span><span class=n>x86_64</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>/</span><span class=n>Scrt1</span><span class=p>.</span><span class=n>o</span><span class=p>:</span><span class=w> </span><span class=k>In</span><span class=w> </span><span class=n>function</span><span class=w> </span><span class=o>`</span><span class=sa>_start</span><span class=s1>&#39;:
</span><span class=s1>          (.text+0x12): undefined reference to `__libc_csu_fini&#39;</span><span class=w>
</span><span class=w>          </span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>gcc</span><span class=o>/</span><span class=p>..</span><span class=o>/</span><span class=n>x86_64</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>/</span><span class=n>Scrt1</span><span class=p>.</span><span class=n>o</span><span class=p>:</span><span class=w> </span><span class=k>In</span><span class=w> </span><span class=n>function</span><span class=w> </span><span class=o>`</span><span class=sa>_start</span><span class=s1>&#39;:
</span><span class=s1>          (.text+0x19): undefined reference to `__libc_csu_init&#39;</span><span class=w>
</span><span class=w>          </span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>gcc</span><span class=o>/</span><span class=p>..</span><span class=o>/</span><span class=n>x86_64</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>/</span><span class=n>Scrt1</span><span class=p>.</span><span class=n>o</span><span class=p>:</span><span class=w> </span><span class=k>In</span><span class=w> </span><span class=n>function</span><span class=w> </span><span class=o>`</span><span class=sa>_start</span><span class=s1>&#39;:
</span><span class=s1>          (.text+0x25): undefined reference to `__libc_start_main&#39;</span><span class=w>
</span><span class=w>          </span><span class=n>collect2</span><span class=p>:</span><span class=w> </span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>ld</span><span class=w> </span><span class=n>returned</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>status</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>这里遇到的问题是，链接器将默认引用C语言运行时的启动流程，或者也被描述为<code>_start</code>函数。它将使用我们在<code>no_std</code>下被排除的C语言标准库实现库<code>libc</code>，因此链接器不能解析相关的引用，得到“undefined reference”问题。为解决这个问题，我们需要告诉链接器，它不应该引用C语言使用的启动流程——我们可以添加<code>-nostartfiles</code>标签来做到这一点。</p>
<p>要通过cargo添加参数到链接器，我们使用<code>cargo rustc</code>命令。这个命令的作用和<code>cargo build</code>相同，但允许开发者向下层的Rust编译器<code>rustc</code>传递参数。另外，<code>rustc</code>提供一个<code>-C link-arg</code>标签，它能够传递所需的参数到链接器。综上所述，我们可以编写下面的命令：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo rustc -- -C link-arg=-nostartfiles
</code></pre></td></tr></table>
</div>
</div><p>这样之后，我们的包应该能成功编译，作为Linux系统下的独立式可执行程序了。这里我们没有显式指定入口点函数的名称，因为链接器将默认使用函数名<code>_start</code>。</p>
<h2 id=windows>Windows</h2>
<p>在Windows系统下，可能有不一样的链接器错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>error: linking with `link.exe` failed: exit code: 1561
  |
  = note: &#34;C:\\Program Files (x86)\\…\\link.exe&#34; […]
  = note: LINK : fatal error LNK1561: entry point must be defined
</code></pre></td></tr></table>
</div>
</div><p>链接器错误提示“必须定义入口点”，意味着它没有找到入口点。在Windows系统下，默认的入口点函数名<a href=https://docs.microsoft.com/en-us/cpp/build/reference/entry-entry-point-symbol>由使用的子系统决定</a>。对<code>CONSOLE</code>子系统，链接器将寻找名为<code>mainCRTStartup</code>的函数；而对<code>WINDOWS</code>子系统，它将寻找<code>WinMainCRTStartup</code>。我们的<code>_start</code>函数并非这两个名称：为了使用它，我们可以向链接器传递<code>/ENTRY</code>参数：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo rustc -- -C link-arg=/ENTRY:_start
</code></pre></td></tr></table>
</div>
</div><p>我们也能从这里的参数的格式中看到，Windows系统下的链接器在使用方法上，与Linux下的有较大不同。</p>
<p>运行命令，我们得到了另一个链接器错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>error: linking with `link.exe` failed: exit code: 1221
  |
  = note: &#34;C:\\Program Files (x86)\\…\\link.exe&#34; […]
  = note: LINK : fatal error LNK1221: a subsystem can&#39;t be inferred and must be
          defined
</code></pre></td></tr></table>
</div>
</div><p>产生这个错误，是由于Windows可执行程序可以使用不同的<strong>子系统</strong>（<a href=https://docs.microsoft.com/en-us/cpp/build/reference/entry-entry-point-symbol>subsystem</a>）。对一般的Windows程序，使用的子系统将由入口点的函数名推断而来：如果入口点是<code>main</code>函数，将使用<code>CONSOLE</code>子系统；如果是<code>WinMain</code>函数，则使用<code>WINDOWS</code>子系统。由于我们的<code>_start</code>函数名称与上两者不同，我们需要显式指定使用的子系统：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo rustc -- -C link-args=&#34;/ENTRY:_start /SUBSYSTEM:console&#34;
</code></pre></td></tr></table>
</div>
</div><p>这里我们使用<code>CONSOLE</code>子系统，但<code>WINDOWS</code>子系统也是可行的。这里，我们使用复数参数<code>link-args</code>代替多个<code>-C link-arg</code>，因为后者要求把所有参数依次列出，比较占用空间。</p>
<p>使用这行命令后，我们的可执行程序应该能在Windows下运行了。</p>
<h2 id=macos>macOS</h2>
<p>如果使用macOS系统开发，我们可能遇到这样的链接器错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linking</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=o>`</span><span class=n>cc</span><span class=o>`</span><span class=w> </span><span class=n>failed</span><span class=p>:</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>  </span><span class=o>|</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cc&#34;</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=n>ld</span><span class=p>:</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=nf>point</span><span class=w> </span><span class=p>(</span><span class=n>_main</span><span class=p>)</span><span class=w> </span><span class=n>undefined</span><span class=p>.</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>architecture</span><span class=w> </span><span class=n>x86_64</span><span class=w>
</span><span class=w>          </span><span class=n>clang</span><span class=p>:</span><span class=w> </span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linker</span><span class=w> </span><span class=n>command</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>这个错误消息告诉我们，链接器不能找到默认的入口点函数，它被命名为<code>main</code>——出于一些原因，macOS的所有函数名都被加以下划线<code>_</code>前缀。要设置入口点函数到<code>_start</code>，我们传送链接器参数<code>-e</code>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo rustc -- -C link-args=&#34;-e __start&#34;
</code></pre></td></tr></table>
</div>
</div><p><code>-e</code>参数指定了入口点的名称。由于每个macOS下的函数都有下划线<code>_</code>前缀，我们应该命名入口点函数为<code>__start</code>，而不是<code>_start</code>。</p>
<p>运行这行命令，现在出现了这样的链接器错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linking</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=o>`</span><span class=n>cc</span><span class=o>`</span><span class=w> </span><span class=n>failed</span><span class=p>:</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>  </span><span class=o>|</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cc&#34;</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=n>ld</span><span class=p>:</span><span class=w> </span><span class=n>dynamic</span><span class=w> </span><span class=n>main</span><span class=w> </span><span class=n>executables</span><span class=w> </span><span class=n>must</span><span class=w> </span><span class=n>link</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>libSystem</span><span class=p>.</span><span class=n>dylib</span><span class=w>
</span><span class=w>          </span><span class=k>for</span><span class=w> </span><span class=n>architecture</span><span class=w> </span><span class=n>x86_64</span><span class=w>
</span><span class=w>          </span><span class=n>clang</span><span class=p>:</span><span class=w> </span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linker</span><span class=w> </span><span class=n>command</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>这个错误的原因是，macOS<a href=https://developer.apple.com/library/content/qa/qa1118/_index.html>并不官方支持静态链接的二进制库</a>，而要求程序默认链接到<code>libSystem</code>库。要链接到静态二进制库，我们把<code>-static</code>标签传送到链接器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo rustc -- -C link-args=&#34;-e __start -static&#34;
</code></pre></td></tr></table>
</div>
</div><p>运行修改后的命令。链接器似乎并不满意，又给我们抛出新的错误：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linking</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=o>`</span><span class=n>cc</span><span class=o>`</span><span class=w> </span><span class=n>failed</span><span class=p>:</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>  </span><span class=o>|</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cc&#34;</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>note</span><span class=p>:</span><span class=w> </span><span class=n>ld</span><span class=p>:</span><span class=w> </span><span class=n>library</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=n>found</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=o>-</span><span class=n>lcrt0</span><span class=p>.</span><span class=n>o</span><span class=w>
</span><span class=w>          </span><span class=n>clang</span><span class=p>:</span><span class=w> </span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>linker</span><span class=w> </span><span class=n>command</span><span class=w> </span><span class=n>failed</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=k>exit</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>[</span><span class=err>…</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>出现这个错误的原因是，macOS上的程序默认链接到<code>crt0</code>（C runtime zero）库。这和Linux系统上遇到的问题相似，我们可以添加一个<code>-nostartfiles</code>链接器参数：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo rustc -- -C link-args=&#34;-e __start -static -nostartfiles&#34;
</code></pre></td></tr></table>
</div>
</div><p>现在，我们的程序应该能够在macOS上成功编译了。</p>
<h2 id=统一所有的编译命令>统一所有的编译命令</h2>
<p>我们的裸机程序已经可以在多个平台上编译，但对每个平台，我们不得不记忆和使用不同的编译命令。为了避免这么做，我们创建<code>.cargo/config</code>文件，为每个平台填写对应的命令：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=c># in .cargo/config</span>

<span class=p>[</span><span class=nx>target</span><span class=p>.</span><span class=s1>&#39;cfg(target_os = &#34;linux&#34;)&#39;</span><span class=p>]</span>
<span class=nx>rustflags</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;-C&#34;</span><span class=p>,</span> <span class=s2>&#34;link-arg=-nostartfiles&#34;</span><span class=p>]</span>

<span class=p>[</span><span class=nx>target</span><span class=p>.</span><span class=s1>&#39;cfg(target_os = &#34;windows&#34;)&#39;</span><span class=p>]</span>
<span class=nx>rustflags</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;-C&#34;</span><span class=p>,</span> <span class=s2>&#34;link-args=/ENTRY:_start /SUBSYSTEM:console&#34;</span><span class=p>]</span>

<span class=p>[</span><span class=nx>target</span><span class=p>.</span><span class=s1>&#39;cfg(target_os = &#34;macos&#34;)&#39;</span><span class=p>]</span>
<span class=nx>rustflags</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;-C&#34;</span><span class=p>,</span> <span class=s2>&#34;link-args=-e __start -static -nostartfiles&#34;</span><span class=p>]</span>
</code></pre></td></tr></table>
</div>
</div><p>这里，<code>rustflags</code>参数包含的内容，将被自动添加到每次<code>rustc</code>调用中。我们可以在<a href=https://doc.rust-lang.org/cargo/reference/config.html>官方文档</a>中找到更多关于<code>.cargo/config</code>文件的说明。</p>
<p>做完这一步后，我们使用简单的一行指令——</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cargo build
</code></pre></td></tr></table>
</div>
</div><p>——就能在三个不同的平台上编译裸机程序了。</p>
<h2 id=我们应该这么做吗>我们应该这么做吗？</h2>
<p>虽然通过上文的方式，的确可以面向多个系统编译独立式可执行程序，但这可能不是一个好的途径。这么描述的原因是，我们的可执行程序仍然需要其它准备，比如在<code>_start</code>函数调用前一个加载完毕的栈。不使用C语言运行环境的前提下，这些准备可能并没有全部完成——这可能导致程序运行失败，比如说会抛出臭名昭著的段错误。</p>
<p>如果我们要为给定的操作系统创建最小的二进制程序，可以试着使用<code>libc</code>库并设定<code>#[start]</code>标记。<a href=https://doc.rust-lang.org/1.16.0/book/no-stdlib.html>有一篇官方文档</a>给出了较好的建议。</p>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2024-03-07 11:58:54
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/alipay_reward_qrcode.png>
<span>支付宝打赏</span>
</label>
<label class=qr-code-image for=reward>
<img class=image src=/image/bitcoin_reward_qrcode.png>
<span>比特币打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/pub/>pub</a>
<a href=https://justice.bj.cn/tags/writing-an-os-in-rust/>writing-an-os-in-rust</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/09.pub/writing-an-os-in-rust/04-testing/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">使用Rust编写操作系统（四）：内核测试</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/09.pub/writing-an-os-in-rust/appendix-c-disable-simd/>
<span class="next-text nav-default">使用Rust编写操作系统（附录三）：禁用SIMD</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2024
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=/js/fuse.min.js></script>
<script src=/js/fastsearch.js></script>
</body>
</html>