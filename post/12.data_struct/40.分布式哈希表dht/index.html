<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>分布式哈希表(DHT) - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="分布式哈希表(DHT) 简介 分布式哈希表(DHT, Distributed Hash Table)是分布式系统中，用来将一个键（key）的集合分散到所有节点。这里的节点类似哈">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/12.data_struct/40.%E5%88%86%E5%B8%83%E5%BC%8F%E5%93%88%E5%B8%8C%E8%A1%A8dht/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="分布式哈希表(DHT)">
<meta property="og:description" content="分布式哈希表(DHT) 简介 分布式哈希表(DHT, Distributed Hash Table)是分布式系统中，用来将一个键（key）的集合分散到所有节点。这里的节点类似哈">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/12.data_struct/40.%E5%88%86%E5%B8%83%E5%BC%8F%E5%93%88%E5%B8%8C%E8%A1%A8dht/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-09-28T23:23:44+00:00">
<meta property="article:modified_time" content="2021-09-28T23:23:44+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="分布式哈希表(DHT)">
<meta itemprop=description content="分布式哈希表(DHT) 简介 分布式哈希表(DHT, Distributed Hash Table)是分布式系统中，用来将一个键（key）的集合分散到所有节点。这里的节点类似哈"><meta itemprop=datePublished content="2021-09-28T23:23:44+00:00">
<meta itemprop=dateModified content="2021-09-28T23:23:44+00:00">
<meta itemprop=wordCount content="5553">
<meta itemprop=keywords content="data_struct,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="分布式哈希表(DHT)">
<meta name=twitter:description content="分布式哈希表(DHT) 简介 分布式哈希表(DHT, Distributed Hash Table)是分布式系统中，用来将一个键（key）的集合分散到所有节点。这里的节点类似哈"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='05bff2da94121334a',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>分布式哈希表(DHT)</h1>
<div class=post-meta>
<time datetime=2021-09-28 class=post-time>
2021-09-28 23:23:44
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/data_struct/> data_struct </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#dht>DHT</a></li>
<li><a href=#分布式哈希与一致性哈希>分布式哈希与一致性哈希</a></li>
<li><a href=#kademlia-算法>Kademlia 算法</a>
<ul>
<li><a href=#映射规则><strong>映射规则</strong></a></li>
<li><a href=#二叉树的拆分规则><strong>二叉树的拆分规则</strong></a></li>
<li><a href=#拆子树><strong>拆子树</strong></a></li>
<li><a href=#kademlia-协议><strong>Kademlia 协议</strong></a></li>
<li><a href=#定位节点><strong>定位节点</strong></a></li>
<li><a href=#定位资源><strong>定位资源</strong></a></li>
<li><a href=#加入网络><strong>加入网络</strong></a></li>
</ul>
</li>
<li><a href=#kad-在-p2p-网络中的应用>kad 在 p2p 网络中的应用</a></li>
<li><a href=#参考资料>参考资料</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=分布式哈希表dht>分布式哈希表(DHT)</h1>
<h2 id=简介>简介</h2>
<p>分布式哈希表(DHT, Distributed Hash Table)是分布式系统中，用来将一个键（key）的集合分散到所有节点。这里的节点类似哈希表中的存储位置。分布式哈希表通常是为了拥有大量节点的系统，而且系统的节点常常会加入或离开。</p>
<h2 id=dht>DHT</h2>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-21-20-49-2020-03-08-15-47-23-image.png alt></p>
<p>分布式哈希表的用于发点对点系统(P2P)，像是 Napster、Gnutella、BitTorrent 及 Freenet。这些系统使用分散在互联网上的各项资源以提供文件分享服务，特别在带宽及硬盘存储空间上受益良多。</p>
<p>这些系统使用不同的方法来解决如何找到拥有某数据的节点的问题。</p>
<ul>
<li>
<p>Napster 使用中央的索引服务器：每个节点加入网络的同时，会将他们所拥有的文件列表发送给服务器，这使得服务器可以进行搜索并将结果回传给进行查询的节点。但中央索引服务器让整个系统易受攻击，且可能造成法律问题；</p>
</li>
<li>
<p>Gnutella 和相似的网络改用大量查询模式（flooding query model）：每次搜索都会把查询消息广播给网络上的所有节点。虽然这个方式能够防止单点故障（single point of failure），但比起 Napster 来说却极没效率；</p>
</li>
<li>
<p>Freenet 使用了完全分布式的系统，但它建置了一套使用经验法则的基于键的路由方法（key based routing）。在这个方法中，每个文件与一个键相结合，而拥有相似键的文件会倾向被相似的节点构成的集合所保管。于是查询消息就可以根据它所提供的键被路由到该集合，而不需要经过所有的节点。然而，Freenet 并不保证存在网络上的数据在查询时一定会被找到。</p>
</li>
</ul>
<p>分布式哈希表为了达到 Gnutella 与 Freenet 的分散性（decentralization）以及 Napster 的效率与正确结果，使用了较为结构化的基于键的路由方法。不过分布式哈希表也有个 Freenet 有的缺点，就是只能作精确搜索，而不能只提供部分的关键字；但这个功能可以在分布式哈希表的上层实现。</p>
<p>最初的四项分布式哈希表技术——内容可定址网络（Content addressable network，CAN）、Chord（Chord project）、Pastry（Pastry (DHT)），以及 Tapestry (DHT)（Tapestry (DHT)）皆同时于 2001 年发表。从那时开始，相关的研究便一直十分活跃。在学术领域以外，分布式哈希表技术已经被应用在 BitTorrent 及 CoralCDN（Coral Content Distribution Network）等。</p>
<p>分布式散列表本质上强调以下特性：</p>
<ul>
<li><strong>离散性</strong>：构成系统的节点并没有任何中央式的协调机制。</li>
<li><strong>伸缩性</strong>：即使有成千上万个节点，系统仍然应该十分有效率。</li>
<li><strong>容错性</strong>：即使节点不断地加入、离开或是停止工作，系统仍然必须达到一定的可靠度。</li>
</ul>
<p>要达到以上的目标，有一个关键的技术：任一个节点只需要与系统中的部分节点沟通，当成员改变的时候，只有一部分的工作（例如数据或键的发送，哈希表的改变等）必须要完成。</p>
<p>分布式散列表的结构可以分成几个主要的组件。其基础是一个抽象的<code>键空间</code>（keyspace），例如说所有<strong>160</strong>位长的字符串集合。<code>键空间分区</code>（keyspace partitioning）将<code>键空间</code>分区成数个，并指定到在此系统的节点中。而<code>延展网络</code>则连接这些节点，并让他们能够借由在<code>键空间</code>内的任一值找到拥有该值的节点。</p>
<p>假设<code>键空间</code>是一个 160 位长的字符串集合。为了在分布式散列表中存储一个文件，名称为<code>filename</code>且内容为<code>data</code>，我们计算出<code>filename</code>的 SHA1 散列值——一个 160 位的键<code>k</code>——并将消息<code>put(k,data)</code>送给分布式散列表中的任意参与节点。此消息在延展网络中被路由，直到抵达在键空间分区中被指定负责存储关键值<code>k</code>的节点。而<code>(k,data)</code>即存储在该节点。其他的节点只需要重新计算<code>filename</code>的散列值<code>k</code>，然后提交消息<code>get(k)</code>给分布式哈希表中的任意参与节点，以此来找与<code>k</code>相关的数据。此消息也会在延展网络中被路由到负责存储<code>k</code>的节点。而此节点则会负责传回存储的数据<code>data</code>。</p>
<p>基本上，就是一种映射 key 和节点的算法以及路由的算法。</p>
<p>其一为保证任何的路由路径长度必须尽量短，因而请求能快速地被完成；<br>
其二为任一节点的邻近节点数目（又称最大节点度（Degree (graph theory)））必须尽量少，因此维护的花费不会过多。</p>
<h2 id=分布式哈希与一致性哈希>分布式哈希与一致性哈希</h2>
<p>分布式哈希和一致性哈希有什么区别呢？lintong 的<a href=https://www.jianshu.com/p/7beeb52376cc>分布式哈希与一致性哈希</a>  一文对它做了清晰而简洁的解释。</p>
<ul>
<li><strong>分布式哈希</strong>: 将哈希表分散在不同的节点上，并且能提供相应的方法来查找， 比如 DHT 算法；</li>
<li><strong>一致性哈希</strong>: 当节点宕机或者扩容的时候，需要重新哈希，一致性哈希实现的 DHT 避免对大量的数据重新哈希, 比如<a href=https://en.wikipedia.org/wiki/Chord_(peer-to-peer)>Chord DHT</a>. 所以一致性哈希是 DHT 的一种实现，避免在节点变化的时候出现的全部重新哈希的现象.</li>
</ul>
<p>其它的 DHT 的分区实现(Keyspace partitioning)还有:</p>
<ul>
<li><strong>Rendezvous hashing</strong>: 最高随机权重哈希。每个 client 都会获得服务节点相同的指示符<code>{S1, S2, ..., Sn }</code>， 对于键<code>k</code>, client 使用相同的哈希函数计算服务节点的权重<code>w1 = h(S1, k), w2 = h(S2, k), ..., wn = h(Sn, k)</code>，然后总是选择最高权重的节点。</li>
<li><strong>Locality-preserving hashing</strong>: 相近的键总是指派给相近的对象。</li>
</ul>
<h2 id=kademlia-算法>Kademlia 算法</h2>
<p><strong>Kademlia</strong>是一种通过 DHT 的协议算法，它是由 Petar 和 David 在 2002 年为 P2P 网络而设计的。Kademlia 规定了网络的结构，也规定了通过节点查询进行信息交换的方式。<br>
Kademlia 网络节点之间使用<strong>UDP</strong>进行通讯。参与通讯的所有节点形成一张虚拟网（或者叫做覆盖网）。这些节点通过一组数字（或称为节点 ID）来进行身份标识。节点 ID 不仅可以用来做身份标识，还可以用来进行值定位（值通常是文件的散列或者关键词）。</p>
<p>当我们在网络中搜索某些值（即通常搜索存储文件散列或关键词的节点）的时候，Kademlia 算法需要知道与这些值相关的键，然后逐步在网络中开始搜索。每一步都会找到一些节点，这些节点的 ID 与键更为接近，如果有节点直接返回搜索的值或者再也无法找到与键更为接近的节点 ID 的时候搜索便会停止。</p>
<p>这种搜索值的方法是非常高效的：与其他的分布式哈希表的实现类似，在一个包含 n 个节点的系统的值的搜索中，Kademlia 仅访问<code>O(log(n))</code>个节点。</p>
<p><code>Kademlia</code>简称为<code>Kad</code>,它使用了一个精妙的算法，来计算节点之间的"距离" (这里的距离不是地理空间的距离，而是路由的跳数)，这个算法就是<code>XOR</code>操作(异或)，因为这个操作和距离的计算类似：</p>
<ul>
<li><code>(A ⊕ B) == (B ⊕ A)</code>: XOR 符合“交换律”，具备对称性。A 和 B 的距离从哪一个节点计算都是相同的。</li>
<li><code>(A ⊕ A) == 0</code>: 反身性，自己和自己的距离为零。</li>
<li><code>(A ⊕ B) > 0</code>: 两个不同的 key 之间的距离必大于零。</li>
<li><code>(A ⊕ B) + (B ⊕ C) >= (A ⊕ C)</code>: 三角不等式, A 经过 B 到 C 的距离总是大于 A 直接到 C 的距离。</li>
</ul>
<p>(精妙啊!是如何想起和距离计算联系在一起的？)</p>
<p>Kad 使用 160 位的哈希算法（比如 SHA1），完整的 key 用二进制表示有 160 位，这样可以容纳 2160 个节点，可以说是不计其数了。</p>
<p>Kad 把 key 映射到一个二叉树，每一个 key 都是这个二叉树的<code>叶子</code>。</p>
<h3 id=映射规则><strong>映射规则</strong></h3>
<ol>
<li>先把 key 以二进制形式表示，然后从高位到低位依次处理。</li>
<li>二进制的第 n 个位就对应了二叉树的第 n 层</li>
<li>如果该位是 1，进入左子树，是 0 则进入右子树（这只是人为约定，反过来处理也可以）</li>
<li>全部位都处理完后，这个 key 就对应了二叉树上的某个叶子</li>
</ol>
<h3 id=二叉树的拆分规则><strong>二叉树的拆分规则</strong></h3>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/12-21-21-16-2020-03-08-15-50-47-image.png alt></p>
<p>对每一个节点，都可以<strong>按照自己的视角</strong>对整个二叉树进行拆分成最多 160 个子树。</p>
<p>拆分的规则是：先从根节点开始，把<strong>不包含</strong>自己的那个子树拆分出来；然后在剩下的子树再拆分不包含自己的第二层子树；以此类推，直到最后只剩下自己。</p>
<p>Kad 默认的散列值空间是  <code>m=160</code>（散列值有 160 bit），因此拆分出来的子树<strong>最多</strong>有 160 个（考虑到实际的节点数<strong>远远小于</strong>2160，子树的个数会明显小于 160）。</p>
<p>对于每一个节点而言，当它以自己的视角完成子树拆分后，会得到 n 个子树；对于每个子树，如果它都能知道里面的一个节点，那么它就可以利用这 n 个节点进行递归路由，从而到达整个二叉树的<strong>任何一个</strong>节点。</p>
<h3 id=拆子树><strong>拆子树</strong></h3>
<p>每个节点在完成子树拆分后，只需要知道每个子树里面的一个节点，就足以实现全遍历。但是考虑到健壮性（节点可能宕机或者退出），光知道<strong>一个</strong>显然是不够的，需要知道<strong>多个</strong>才比较保险。</p>
<p>所以 Kad 论文中给出了一个<code>K-桶（K-bucket）</code>的概念。也就是说：每个节点在完成子树拆分后，要记录每个子树里面的  <code>K</code>  个节点。这里所说的  <code>K</code>  值是一个<strong>系统级</strong>的常量。由使用 Kad 的软件系统自己设定（比如 BT 下载使用的 Kad 网络，K 设定为 8）。</p>
<p><strong>K 桶</strong>其实就是<strong>路由表</strong>。对于某个节点而言，如果<strong>以它自己为视角</strong>拆分了  <strong>n</strong>  个子树，那么它就需要维护  <strong>n</strong>  个路由表，并且每个路由表的<strong>上限</strong>是 K。</p>
<p>说 K 只是一个<strong>上限</strong>，是因为有两种情况使得 K 桶的尺寸会小于 K:</p>
<ol>
<li>距离越近的子树就越小。如果整个子树<strong>可能存在的</strong>节点数小于 K，那么该子树的 K 桶尺寸永远也不可能达到 K。(这是由于 K 桶对应的距离越近，节点数越少)</li>
<li>有些子树虽然实际上线的节点数超过 K，但是因为种种原因，没有收集到该子树足够多的节点，这也会使得该子树的 K 桶尺寸小于 K。</li>
</ol>
<p>如果选择这 K 个节点呢？<br>
Kademlia 选择把那些长时间在线的节点存入 K 桶，这一方法增长了未来某一时刻有效节点的数量，同时也提供了更为稳定的网络。当某个 K 桶已满，而又发现了相应于该桶的新节点的时候，那么，就首先检查 K 桶中最早访问的节点，假如该节点仍然存活，那么新节点就被安排到一个附属列表中（作为一个替代缓存）.只有当 K 桶中的某个节点停止响应的时候，替代 cache 才被使用。换句话说，新发现的节点只有在老的节点消失后才被使用。</p>
<h3 id=kademlia-协议><strong>Kademlia 协议</strong></h3>
<p>Kademlia 协议共有四种消息。</p>
<ul>
<li><strong>PING</strong>消息: 用来测试节点是否仍然在线。</li>
<li><strong>STORE</strong>消息: 在某个节点中存储一个键值对。</li>
<li><strong>FIND_NODE</strong>消息: 消息请求的接收者将返回自己桶中离请求键值最近的 K 个节点。</li>
<li><strong>FIND_VALUE</strong>消息: 与 FIND_NODE 一样，不过当请求的接收者存有请求者所请求的键的时候，它将返回相应键的值。</li>
</ul>
<p>每一个 RPC 消息中都包含一个发起者加入的随机值，这一点确保响应消息在收到的时候能够与前面发送的请求消息匹配。</p>
<h3 id=定位节点><strong>定位节点</strong></h3>
<p>节点查询可以异步进行，也可以同时进行，同时查询的数量由 α 表示，一般是 3。</p>
<ol>
<li>由查询发起者从自己的 k-桶中筛选出若干距离目标 ID 最近的节点，并向这些节点同时发送异步查询请求；</li>
<li>被查询节点收到请求之后，将从自己的 k-桶中找出自己所知道的距离查询目标 ID 最近的若干个节点，并返回给发起者；</li>
<li>发起者在收到这些返回信息之后，更新自己的结果列表，再次从自己所有已知的距离目标较近的节点中挑选出若干没有请求过的，并重复步骤 1；</li>
<li>上述步骤不断重复，直至无法获得比查询者当前已知的 k 个节点更接近目标的活动节点为止。</li>
<li>在查询过程中，没有及时响应的节点将立即被排除；查询者必须保证最终获得的 k 个最节点都是活动的。</li>
</ol>
<h3 id=定位资源><strong>定位资源</strong></h3>
<p>通过把资源信息与键进行映射，资源即可进行定位，杂凑表是典型的用来映射的手段。由于以前的 STORE 消息，存储节点将会有对应 STORE 所存储的相关资源的信息。定位资源时，如果一个节点存有相应的资源的值的时候，它就返回该资源，搜索便结束了，除了该点以外，定位资源与定位离键最近的节点的过程相似。</p>
<p>考虑到节点未必都在线的情况，资源的值被存在多个节点上（节点中的 K 个），并且，为了提供冗余，还有可能在更多的节点上储存值。储存值的节点将定期搜索网络中与储存值所对应的键接近的 K 个节点并且把值复制到这些节点上，这些节点可作为那些下线的节点的补充。另外还有缓存技术。</p>
<h3 id=加入网络><strong>加入网络</strong></h3>
<ol>
<li>新节点 A 必须知道某个引导节点 B，并把它加入到自己相应的 K-桶中</li>
<li>生成一个随机的节点 ID,直到离开网络，该节点会一直使用该 ID 号</li>
<li>向 B（A 目前知道的唯一节点）发起一个查询请求（FIND_NODE），请求的 ID 是自己（就是查询自己）</li>
<li>B 收到该请求之后，会先把 A 的 ID 加入自己的相应的 K-桶中。并且根据 FIND_NODE 请求的约定，B 会找到 K 个最接近 A 的节点，并返回给 A</li>
<li>A 收到这 K 个节点的 ID 之后，把他们加入自己的 K-桶</li>
<li>然后 A 会继续向刚刚拿到的这批节点(还未发送过请求的节点)发送查询请求（协议类型 FIND_NODE），如此往复，直至 A 建立了足够详细的路由表。</li>
<li>这种“自我定位”将使得 Kad 的其他节点（收到请求的节点）能够使用 A 的 ID 填充他们的 K-桶，同时也能够使用那些查询过程的中间节点来填充 A 的 K-桶。这已过程既让 A 获得了详细的路由表，也让其它节点知道了 A 节点的加入</li>
</ol>
<h2 id=kad-在-p2p-网络中的应用>kad 在 p2p 网络中的应用</h2>
<p>Kademlia 可在文件分享网络中使用，通过制作 Kademlia 关键字搜索，我们能够在文件分享网络中找到我们需要的文件以供我们下载。由于没有中央服务器存储文件的索引，这部分工作就被平均地分配到所有的客户端中去：</p>
<p>假如一个节点希望分享某个文件，它先根据文件的内容来处理该文件，通过运算，把文件的内容散列成一组数字，该数字在文件分享网络中可被用来标识文件。这组散列数字必须和节点 ID 有同样的长度，<br>
然后，该节点便在网络中搜索 ID 值与文件的散列值相近的节点，并把它自己的 IP 地址存储在那些搜索到的节点上，也就是说，它把自己作为文件的源进行了发布。正在进行文件搜索的客户端将使用 Kademlia 协议来寻找网络上 ID 值与希望寻找的文件的散列值最近的那个节点，然后取得存储在那个节点上的文件源列表。<br>
由于一个键可以对应很多值，即同一个文件可以有多个源，每一个存储源列表的节点可能有不同的文件的源的信息，这样的话，源列表可以从与键值相近的 K 个节点获得。</p>
<p>文件的散列值通常可以从其他的一些特别的 Internet 链接的地方获得，或者被包含在从其他某处获得的索引文件中。<br>
文件名的搜索可以使用关键词来实现，文件名可以分割成连续的几个关键词，这些关键词都可以散列并且可以和相应的文件名和文件散列储存在网络中。搜索者可以使用其中的某个关键词，联系 ID 值与关键词散列最近的那个节点，取得包含该关键词的文件列表。由于在文件列表中的文件都有相关的散列值，通过该散列值就可利用上述通常取文件的方法获得要搜索的文件。</p>
<h2 id=参考资料>参考资料</h2>
<ol>
<li><a href=https://zh.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E5%BC%8F%E9%9B%9C%E6%B9%8A%E8%A1%A8>https://zh.wikipedia.org/wiki/分散式雜湊表</a></li>
<li><a href=https://en.wikipedia.org/wiki/Distributed_hash_table>https://en.wikipedia.org/wiki/Distributed_hash_table</a></li>
<li><a href=https://baike.baidu.com/item/DHT/1007999>DHT（一种分布式存储方法）_百度百科</a></li>
<li><a href=https://www.jianshu.com/p/7beeb52376cc>分布式哈希与一致性哈希 - 简书</a></li>
<li><a href=https://program-think.blogspot.com/2017/09/Introduction-DHT-Kademlia-Chord.html>https://program-think.blogspot.com/2017/09/Introduction-DHT-Kademlia-Chord.html</a></li>
<li><a href=https://colobu.com/2018/03/26/distributed-hash-table/>https://colobu.com/2018/03/26/distributed-hash-table/</a></li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2021-09-28 23:23:44
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/data_struct/>data_struct</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/12.data_struct/tailq/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">TAILQ-双向有尾队列</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/12.data_struct/00.%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>
<span class="next-text nav-default">基础数据结构</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/l2d/L2Dwidget.min.js></script>
<script src=/js/l2d/L2Dwidget.0.min.js></script>
<script src=/js/l2d/L2Dwidget.init.js></script>
</body>
</html>