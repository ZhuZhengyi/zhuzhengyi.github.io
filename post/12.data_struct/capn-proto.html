<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Cap'n_Proto - Justice的小站</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Justice">
<meta name=description content="Cap&amp;rsquo;n Proto 简介 Cap’n Proto 是非常快速的数据交换格式和基于容量的 RPC 系统， Cap&amp;rsquo;n Proto没有任何encoding/decoding步骤，Cap&rsqu">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://justice.bj.cn/post/12.data_struct/capn-proto.html>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.34a0cf3583dc0fd6b4e3fe24a36c076984feee75ebc2792cff33928ccdcfc628.css integrity="sha256-NKDPNYPcD9a04/4ko2wHaYT+7nXrwnks/zOSjM3Pxig=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Cap'n_Proto">
<meta property="og:description" content="Cap&rsquo;n Proto 简介 Cap’n Proto 是非常快速的数据交换格式和基于容量的 RPC 系统， Cap&rsquo;n Proto没有任何encoding/decoding步骤，Cap&rsqu">
<meta property="og:type" content="article">
<meta property="og:url" content="https://justice.bj.cn/post/12.data_struct/capn-proto.html"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-10-10T15:57:04+00:00">
<meta property="article:modified_time" content="2021-10-10T15:57:04+00:00"><meta property="og:site_name" content="Justice的小站">
<meta itemprop=name content="Cap'n_Proto">
<meta itemprop=description content="Cap&rsquo;n Proto 简介 Cap’n Proto 是非常快速的数据交换格式和基于容量的 RPC 系统， Cap&rsquo;n Proto没有任何encoding/decoding步骤，Cap&rsqu"><meta itemprop=datePublished content="2021-10-10T15:57:04+00:00">
<meta itemprop=dateModified content="2021-10-10T15:57:04+00:00">
<meta itemprop=wordCount content="3987">
<meta itemprop=keywords content="data_struct,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Cap'n_Proto">
<meta name=twitter:description content="Cap&rsquo;n Proto 简介 Cap’n Proto 是非常快速的数据交换格式和基于容量的 RPC 系统， Cap&rsquo;n Proto没有任何encoding/decoding步骤，Cap&rsqu"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Justice's Blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=mobile-menu-item>
<a id=openSearchMobile class="mobile-menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<div class=modal-dialog>
<div class=modal-content>
<div id=closeSearch title=Close class=close>X</div>
<div class=modal-header>
<div class=modal-title>Search</div>
</div>
<div class=modal-body>
<script>(function(){var c='05bff2da94121334a',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src=(document.location.protocol=='https:'?'https:':'http:')+'//cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script>
<gcse:search></gcse:search>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Justice's Blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/>主页</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/post/>点滴</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/tags/>标签</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://justice.bj.cn/categories/>分类</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://gohugo.io rel=noopener target=_blank>
更多
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6 21.568 21.632 54.144 54.208 54.144 54.208C534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92.0.0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"/><path d="M841.152 457.152c-30.528.0-54.784 24.512-54.784 54.656V786.56H237.696V237.696h206.016c6.656.0 10.752.0 13.248.0 30.72.0 55.04-24.512 55.04-54.848C512 152.32 487.36 128 456.96 128H183.04C153.216 128 128 152.576 128 182.848c0 3.136.256 6.272.768 9.28C128.256 195.136 128 198.272 128 201.408v639.488c0 .064.0.192.0.256.0.128.0.192.0.32.0 30.528 24.512 54.784 54.784 54.784H829.76c6.592.0 9.728.0 11.712.0 28.736.0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344v-20.352V561.408v-49.28C896 481.792 871.424 457.152 841.152 457.152z"/></svg>
</i>
</a>
</li>
<li class=menu-item>
<a id=openSearch class="menu-item-link menu-item-search" href=#>
<i class=iconfont><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="18" height="18" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M973.81454219 973.81454219a91.78207815 91.78207815.0 01-129.80999631.0L682.0297247 811.83972101a425.48527711 425.48527711.0 01-230.35931791 68.16531768 428.3346319 428.3346319.0 11428.3346319-428.3346319A425.48527711 425.48527711.0 01811.83972101 682.0297247l162.02961656 161.97482118a91.83687354 91.83687354.0 01-.05479538 129.80999631zm-522.1441354-828.1209266a305.97679241 305.97679241.0 100 611.95358361 305.97679241 305.97679241.0 000-611.95358361z"/></svg>
</i>
</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Cap'n_Proto</h1>
<div class=post-meta>
<time datetime=2021-10-10 class=post-time>
2021-10-10 15:57:04
</time>
<div class=post-category>
<a href=https://justice.bj.cn/categories/data_struct.html> data_struct </a>
</div>
<span id=busuanzi_container_page_pv>
| 阅读 <span id=busuanzi_value_page_pv></span>
</span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#简介>简介</a></li>
<li><a href=#特性>特性</a></li>
<li><a href=#原理>原理</a></li>
<li><a href=#example>Example</a></li>
<li><a href=#参考>参考</a>
<ul>
<li><a href=#注释>注释</a></li>
<li><a href=#内置类型>内置类型</a></li>
<li><a href=#结构体>结构体</a></li>
<li><a href=#联合>联合</a></li>
<li><a href=#群组>群组</a></li>
<li><a href=#动态类型域>动态类型域</a></li>
<li><a href=#枚举>枚举</a></li>
<li><a href=#接口>接口</a></li>
<li><a href=#泛型>泛型</a></li>
<li><a href=#泛型方法>泛型方法</a></li>
<li><a href=#常量>常量</a></li>
<li><a href=#嵌套作用域以及别名>嵌套，作用域以及别名</a></li>
<li><a href=#导入>导入</a></li>
<li><a href=#注解>注解</a></li>
<li><a href=#唯一id>唯一ID</a></li>
</ul>
</li>
<li><a href=#升级协议>升级协议</a></li>
<li><a href=#参考-1>参考</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<h1 id=capn-proto>Cap&rsquo;n Proto</h1>
<h2 id=简介>简介</h2>
<p>Cap’n Proto 是非常快速的数据交换格式和基于容量的 RPC 系统， Cap&rsquo;n Proto没有任何encoding/decoding步骤，Cap&rsquo;n Proto编码的数据格式跟在内存里面的布局是一致的，所以可以直接将编码好的structure直接字节存放到硬盘上面。</p>
<p>Cap&rsquo;n Proto的编码是方案是独立于任何平台的，但在现在的CPU上面（小端序）会有更高的性能。数据的组织类似compiler组织struct：固定宽度，固定偏移，以及合适的内存对齐，对于可变的数组使用pointer嵌入，而pointer也是使用的偏移存放而不是绝对地址。整数使用的是小端序，因为多数现代CPU都是小端序的。</p>
<p>其实如果熟悉C或者C++的结构体，就可以知道Cap&rsquo;n Proto的编码方式就跟struct的内存布局差不多。</p>
<h2 id=特性>特性</h2>
<ul>
<li>
<p><strong>增量读取</strong></p>
</li>
<li>
<p><strong>随机访问</strong></p>
</li>
<li>
<p><strong>mmap</strong></p>
</li>
<li>
<p><strong>内部语言通信</strong>：C++</p>
</li>
<li>
<p><strong>Arena 分配</strong></p>
</li>
<li>
<p><strong>极小的生成代码</strong></p>
</li>
<li>
<p><strong>极小的运行时库</strong></p>
</li>
<li>
<p><strong>Time-traveling RPC</strong></p>
</li>
</ul>
<h2 id=原理>原理</h2>
<p><img src=https://gitee.com/justice/gitnote-img-bed/raw/master/2020/11/13-09-51-17-2020-07-18-09-58-12-image.png alt></p>
<h2 id=example>Example</h2>
<p>跟Protobuf一样，Cap&rsquo;n Proto也需要定义描述文件，然后通过capnp的编译器编译成特定语言的对象使用。一个描述文件的简单例子:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=err>@</span><span class=mh>0xdbb9ad1f14bf0b36</span><span class=p>;</span>  <span class=c1># unique file ID, generated by `capnp id`</span>

<span class=n>struct</span> <span class=no>Person</span> <span class=p>{</span>
  <span class=nb>name</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Text</span><span class=p>;</span>
  <span class=n>birthdate</span> <span class=err>@</span><span class=mi>3</span> <span class=ss>:Date</span><span class=p>;</span>

  <span class=n>email</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Text</span><span class=p>;</span>
  <span class=n>phones</span> <span class=err>@</span><span class=mi>2</span> <span class=ss>:List</span><span class=p>(</span><span class=no>PhoneNumber</span><span class=p>);</span>

  <span class=n>struct</span> <span class=no>PhoneNumber</span> <span class=p>{</span>
    <span class=n>number</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Text</span><span class=p>;</span>
    <span class=n>type</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Type</span><span class=p>;</span>

    <span class=n>enum</span> <span class=no>Type</span> <span class=p>{</span>
      <span class=n>mobile</span> <span class=err>@</span><span class=mi>0</span><span class=p>;</span>
      <span class=n>home</span> <span class=err>@</span><span class=mi>1</span><span class=p>;</span>
      <span class=n>work</span> <span class=err>@</span><span class=mi>2</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>struct</span> <span class=no>Date</span> <span class=p>{</span>
  <span class=n>year</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Int16</span><span class=p>;</span>
  <span class=n>month</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:UInt8</span><span class=p>;</span>
  <span class=n>day</span> <span class=err>@</span><span class=mi>2</span> <span class=ss>:UInt8</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>几个需要关注的地方:</p>
<ul>
<li>类型是定义在名字后面的，通常来说，对于一个变量来说，我们可能最关注的是它的名字，一个好的命名，就很容易让大家知道是干啥的。譬如上面的name一看就知道是表示的用户的名字。这点跟c语言是反的，它是先类型，在变量名，不过很多后续的语言，譬如go，rust等都是先名字，再类型了。</li>
<li><code>@N</code>用来给struct里面的field进行编号，编号从0开始，而且必须是连续的（这点跟Protobuf不一样）。上面birthdate虽然看起来在email和phones的前面，但是它的编号较大，实际编码的时候会放到后面。</li>
</ul>
<h2 id=参考>参考</h2>
<h3 id=注释>注释</h3>
<p>使用 <code>#</code>进行注释，注释应该跟在定义的后面，或者新启一行：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Date</span> <span class=p>{</span>
  <span class=c1># A standard Gregorian calendar date.</span>

  <span class=n>year</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Int16</span><span class=p>;</span>
  <span class=c1># The year.  Must include the century.</span>
  <span class=c1># Negative value indicates BC.</span>

  <span class=n>month</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:UInt8</span><span class=p>;</span>   <span class=c1># Month number, 1-12.</span>
  <span class=n>day</span> <span class=err>@</span><span class=mi>2</span> <span class=ss>:UInt8</span><span class=p>;</span>     <span class=c1># Day number, 1-30.</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=内置类型>内置类型</h3>
<p>原生支持的数据类型如下：</p>
<ul>
<li><strong>Void:</strong> <code>Void</code></li>
<li><strong>Boolean:</strong> <code>Bool</code></li>
<li><strong>Integers:</strong> <code>Int8</code>, <code>Int16</code>, <code>Int32</code>, <code>Int64</code></li>
<li><strong>Unsigned integers:</strong> <code>UInt8</code>, <code>UInt16</code>, <code>UInt32</code>, <code>UInt64</code></li>
<li><strong>Floating-point:</strong> <code>Float32</code>, <code>Float64</code></li>
<li><strong>Blobs:</strong> <code>Text</code>, <code>Data</code></li>
<li><strong>Lists:</strong> <code>List(T)</code></li>
</ul>
<p>需要注意:</p>
<ul>
<li><code>Void</code>只有一个可能的值，使用0 bits进行编码，通常很少使用，但是可以作为union的member。</li>
<li><code>Text</code>通常是UTF-8编码的，使用NULL结尾的字符串。</li>
<li><code>Data</code>是任意二进制数据。</li>
<li><code>List</code>是一个泛型类型，我们可以用特定类型去特化实现，譬如<code>List(Int32)</code>就是一个Int32的List。</li>
</ul>
<h3 id=结构体>结构体</h3>
<p>结构体其实类似于c的struct，field的有名字，有类型定义，同时需要编号：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Person</span> <span class=p>{</span>
  <span class=nb>name</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Text</span><span class=p>;</span>
  <span class=n>email</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Text</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Field也可以有默认值:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>foo</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Int32</span> <span class=o>=</span> <span class=mi>123</span><span class=p>;</span>
<span class=n>bar</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Text</span> <span class=o>=</span> <span class=s2>&#34;blah&#34;</span><span class=p>;</span>
<span class=n>baz</span> <span class=err>@</span><span class=mi>2</span> <span class=ss>:List</span><span class=p>(</span><span class=no>Bool</span><span class=p>)</span> <span class=o>=</span> <span class=o>[</span> <span class=kp>true</span><span class=p>,</span> <span class=kp>false</span><span class=p>,</span> <span class=kp>false</span><span class=p>,</span> <span class=kp>true</span> <span class=o>]</span><span class=p>;</span>
<span class=n>qux</span> <span class=err>@</span><span class=mi>3</span> <span class=ss>:Person</span> <span class=o>=</span> <span class=p>(</span><span class=nb>name</span> <span class=o>=</span> <span class=s2>&#34;Bob&#34;</span><span class=p>,</span> <span class=n>email</span> <span class=o>=</span> <span class=s2>&#34;bob@example.com&#34;</span><span class=p>);</span>
<span class=n>corge</span> <span class=err>@</span><span class=mi>4</span> <span class=ss>:Void</span> <span class=o>=</span> <span class=n>void</span><span class=p>;</span>
<span class=n>grault</span> <span class=err>@</span><span class=mi>5</span> <span class=ss>:Data</span> <span class=o>=</span> <span class=mi>0</span><span class=n>x</span><span class=s2>&#34;a1 40 33&#34;</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=联合>联合</h3>
<p>Union是定义在struct里面同一个位置的一组fields，一次只能允许一个field被设置，我们使用不一样的tag来获知当前哪个field被设置了，不同于c里面的union，它不是类型，只是简单的fields聚合。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Person</span> <span class=p>{</span>
  <span class=c1># ...</span>

  <span class=n>employment</span> <span class=ss>:union</span> <span class=p>{</span>
    <span class=n>unemployed</span> <span class=err>@</span><span class=mi>4</span> <span class=ss>:Void</span><span class=p>;</span>
    <span class=n>employer</span> <span class=err>@</span><span class=mi>5</span> <span class=ss>:Company</span><span class=p>;</span>
    <span class=n>school</span> <span class=err>@</span><span class=mi>6</span> <span class=ss>:School</span><span class=p>;</span>
    <span class=n>selfEmployed</span> <span class=err>@</span><span class=mi>7</span> <span class=ss>:Void</span><span class=p>;</span>
    <span class=c1># We assume that a person is only one of these.</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>union可以没有名字，但是一个struct里面最多只能包含一个没名字的union:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Shape</span> <span class=p>{</span>
  <span class=n>area</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Float64</span><span class=p>;</span>

  <span class=n>union</span> <span class=p>{</span>
    <span class=n>circle</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Float64</span><span class=p>;</span>      <span class=c1># radius</span>
    <span class=n>square</span> <span class=err>@</span><span class=mi>2</span> <span class=ss>:Float64</span><span class=p>;</span>      <span class=c1># width</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>对于union，我们需要注意:</p>
<ul>
<li>Union里面的field需要跟struct的field一起编号。</li>
<li>我们在上面的union中使用了<code>Void</code>类型，这个类型没有任何额外的信息，仅仅是为了跟其他状态区分。</li>
<li>通常，当一个struct初始化的时候，在union里面具有最小number field会被默认的设置，如果不想默认设置任何field，我们可以用在union里面的最小number定义一个unset的field。</li>
<li>我们可以将当前存在的field加入一个新的union，并且不会破坏当前数据的兼容性。</li>
</ul>
<h3 id=群组>群组</h3>
<p>我们通过group将一组fields封装到特定的作用域里面：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Person</span> <span class=p>{</span>
  <span class=c1># ...</span>

  <span class=c1># Note:  This is a terrible way to use groups, and meant</span>
  <span class=c1>#   only to demonstrate the syntax.</span>
  <span class=n>address</span> <span class=ss>:group</span> <span class=p>{</span>
    <span class=n>houseNumber</span> <span class=err>@</span><span class=mi>8</span> <span class=ss>:UInt32</span><span class=p>;</span>
    <span class=n>street</span> <span class=err>@</span><span class=mi>9</span> <span class=ss>:Text</span><span class=p>;</span>
    <span class=n>city</span> <span class=err>@</span><span class=mi>10</span> <span class=ss>:Text</span><span class=p>;</span>
    <span class=n>country</span> <span class=err>@</span><span class=mi>11</span> <span class=ss>:Text</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Group并不是struct里面独立的一个对象，它里面的fields仍然是struct的fields，需要跟其他struct的fields一起编号。</p>
<p>通常在一个struct里面使用group其实没啥大的意思，但是在union里面就比较有趣了:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Shape</span> <span class=p>{</span>
  <span class=n>area</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Float64</span><span class=p>;</span>

  <span class=n>union</span> <span class=p>{</span>
    <span class=n>circle</span> <span class=ss>:group</span> <span class=p>{</span>
      <span class=n>radius</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Float64</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>rectangle</span> <span class=ss>:group</span> <span class=p>{</span>
      <span class=n>width</span> <span class=err>@</span><span class=mi>2</span> <span class=ss>:Float64</span><span class=p>;</span>
      <span class=n>height</span> <span class=err>@</span><span class=mi>3</span> <span class=ss>:Float64</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在union里面使用group，我们很好的将field进行了自说明，现在看到radius，我们就知道它是circle的变量，而不需要额外的注释了。</p>
<p>当然，使用group，对于后续协议升级也是很有帮助的，在最开始的时候，我们的shape是square，但是现在想支持rectangle，如果需要额外的加入一个field。如果有group，我们仅仅需要添加一个新的group就可以了。</p>
<h3 id=动态类型域>动态类型域</h3>
<p>Struct可以定义field的类型为<code>AnyPointer</code>，类似于c里面的<code>void*</code>.</p>
<h3 id=枚举>枚举</h3>
<p>Enum就是一组符号值的集合:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>enum</span> <span class=no>Rfc3092Variable</span> <span class=p>{</span>
  <span class=n>foo</span> <span class=err>@</span><span class=mi>0</span><span class=p>;</span>
  <span class=n>bar</span> <span class=err>@</span><span class=mi>1</span><span class=p>;</span>
  <span class=n>baz</span> <span class=err>@</span><span class=mi>2</span><span class=p>;</span>
  <span class=n>qux</span> <span class=err>@</span><span class=mi>3</span><span class=p>;</span>
  <span class=c1># ...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Enum的成员必须从0开始编号，在c语言里面，enum通常都是数字类型的，但是在Cap&rsquo;n Proto里面，它还可以是其他值。</p>
<h3 id=接口>接口</h3>
<p>Interface是一组methods的集合，各个method可以有参数，有返回值，methods也必须从0开始编号。Interface支持继承，同样也支持多继承。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>interface</span> <span class=no>Node</span> <span class=p>{</span>
  <span class=n>isDirectory</span> <span class=err>@</span><span class=mi>0</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>result</span> <span class=ss>:Bool</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>interface</span> <span class=no>Directory</span> <span class=n>extends</span><span class=p>(</span><span class=no>Node</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>list</span> <span class=err>@</span><span class=mi>0</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=ss>list</span><span class=p>:</span> <span class=no>List</span><span class=p>(</span><span class=no>Entry</span><span class=p>));</span>
  <span class=n>struct</span> <span class=no>Entry</span> <span class=p>{</span>
    <span class=nb>name</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Text</span><span class=p>;</span>
    <span class=n>node</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Node</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>create</span> <span class=err>@</span><span class=mi>1</span> <span class=p>(</span><span class=nb>name</span> <span class=ss>:Text</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>file</span> <span class=ss>:File</span><span class=p>);</span>
  <span class=n>mkdir</span> <span class=err>@</span><span class=mi>2</span> <span class=p>(</span><span class=nb>name</span> <span class=ss>:Text</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>directory</span> <span class=ss>:Directory</span><span class=p>);</span>
  <span class=nb>open</span> <span class=err>@</span><span class=mi>3</span> <span class=p>(</span><span class=nb>name</span> <span class=ss>:Text</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>node</span> <span class=ss>:Node</span><span class=p>);</span>
  <span class=n>delete</span> <span class=err>@</span><span class=mi>4</span> <span class=p>(</span><span class=nb>name</span> <span class=ss>:Text</span><span class=p>);</span>
  <span class=n>link</span> <span class=err>@</span><span class=mi>5</span> <span class=p>(</span><span class=nb>name</span> <span class=ss>:Text</span><span class=p>,</span> <span class=n>node</span> <span class=ss>:Node</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>interface</span> <span class=no>File</span> <span class=n>extends</span><span class=p>(</span><span class=no>Node</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>size</span> <span class=err>@</span><span class=mi>0</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=ss>size</span><span class=p>:</span> <span class=no>UInt64</span><span class=p>);</span>
  <span class=n>read</span> <span class=err>@</span><span class=mi>1</span> <span class=p>(</span><span class=n>startAt</span> <span class=ss>:UInt64</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>amount</span> <span class=ss>:UInt64</span> <span class=o>=</span> <span class=mh>0xffffffffffffffff</span><span class=p>)</span>
       <span class=o>-&gt;</span> <span class=p>(</span><span class=ss>data</span><span class=p>:</span> <span class=no>Data</span><span class=p>);</span>
  <span class=c1># Default params = read entire file.</span>

  <span class=n>write</span> <span class=err>@</span><span class=mi>2</span> <span class=p>(</span><span class=n>startAt</span> <span class=ss>:UInt64</span><span class=p>,</span> <span class=n>data</span> <span class=ss>:Data</span><span class=p>);</span>
  <span class=n>truncate</span> <span class=err>@</span><span class=mi>3</span> <span class=p>(</span><span class=n>size</span> <span class=ss>:UInt64</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=泛型>泛型</h3>
<p>我们可以定义泛型的struct或者interface</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=n>struct</span> <span class=no>Map</span><span class=p>(</span><span class=no>Key</span><span class=p>,</span> <span class=no>Value</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>entries</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:List</span><span class=p>(</span><span class=no>Entry</span><span class=p>);</span>
  <span class=n>struct</span> <span class=no>Entry</span> <span class=p>{</span>
    <span class=n>key</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Key</span><span class=p>;</span>
    <span class=n>value</span> <span class=err>@</span><span class=mi>1</span> <span class=ss>:Value</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>struct</span> <span class=no>People</span> <span class=p>{</span>
  <span class=n>byName</span> <span class=err>@</span><span class=mi>0</span> <span class=ss>:Map</span><span class=p>(</span><span class=no>Text</span><span class=p>,</span> <span class=no>Person</span><span class=p>);</span>
  <span class=c1># Maps names to Person instances.</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在上面的例子中，我们定义了一个泛型的Map，然后在People里面用Text，Person作为参数来特化这个Map，如果我们了解c++的模板，就可以知道他们差不多。</p>
<h3 id=泛型方法>泛型方法</h3>
<p>interface也可以提供泛型method：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>interface</span> <span class=nc>Assignable</span><span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=p>{</span>
  <span class=err>#</span> <span class=n>A</span> <span class=n>generic</span> <span class=k>interface</span><span class=p>,</span> <span class=n>with</span> <span class=n>non</span><span class=p>-</span><span class=n>generic</span> <span class=n>methods</span><span class=p>.</span>
  <span class=k>get</span> <span class=err>@</span><span class=m>0</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>value</span> <span class=p>:</span><span class=n>T</span><span class=p>);</span>
  <span class=k>set</span> <span class=err>@</span><span class=m>1</span> <span class=p>(</span><span class=n>value</span> <span class=p>:</span><span class=n>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>();</span>
<span class=p>}</span>

<span class=k>interface</span> <span class=nc>AssignableFactory</span> <span class=p>{</span>
  <span class=n>newAssignable</span> <span class=err>@</span><span class=m>0</span> <span class=p>[</span><span class=n>T</span><span class=p>]</span> <span class=p>(</span><span class=n>initialValue</span> <span class=p>:</span><span class=n>T</span><span class=p>)</span>
      <span class=o>-&gt;</span> <span class=p>(</span><span class=n>assignable</span> <span class=p>:</span><span class=n>Assignable</span><span class=p>(</span><span class=n>T</span><span class=p>));</span>
  <span class=err>#</span> <span class=n>A</span> <span class=n>generic</span> <span class=n>method</span><span class=p>.</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们首先定义了一个泛型的interface，然后在对应的factory里面，创建这个interface的method就是泛型的method。</p>
<h3 id=常量>常量</h3>
<p>我们可以用const来定义常量</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>const</span> <span class=nl>pi</span> <span class=p>:</span><span class=n>Float32</span> <span class=o>=</span> <span class=mf>3.14159</span><span class=p>;</span>
<span class=k>const</span> <span class=nl>bob</span> <span class=p>:</span><span class=n>Person</span> <span class=o>=</span> <span class=p>(</span><span class=n>name</span> <span class=o>=</span> <span class=s>&#34;Bob&#34;</span><span class=p>,</span> <span class=n>email</span> <span class=o>=</span> <span class=s>&#34;bob@example.com&#34;</span><span class=p>);</span>
<span class=k>const</span> <span class=nl>secret</span> <span class=p>:</span><span class=n>Data</span> <span class=o>=</span> <span class=mi>0</span><span class=n>x</span><span class=s>&#34;9f98739c2b53835e 6720a00907abd42f&#34;</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>我们可以直接引用这些常量</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=k>const</span> <span class=nl>foo</span> <span class=p>:</span><span class=n>Int32</span> <span class=o>=</span> <span class=mi>123</span><span class=p>;</span>
<span class=k>const</span> <span class=nl>bar</span> <span class=p>:</span><span class=n>Text</span> <span class=o>=</span> <span class=s>&#34;Hello&#34;</span><span class=p>;</span>
<span class=k>const</span> <span class=nl>baz</span> <span class=p>:</span><span class=n>SomeStruct</span> <span class=o>=</span> <span class=p>(</span><span class=kt>id</span> <span class=o>=</span> <span class=p>.</span><span class=n>foo</span><span class=p>,</span> <span class=n>message</span> <span class=o>=</span> <span class=p>.</span><span class=n>bar</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>通常常量都都定义在全局scope里面，我们通过<code>.</code>来进行引用获取。</p>
<h3 id=嵌套作用域以及别名>嵌套，作用域以及别名</h3>
<p>我们可以在struct或者interface里面嵌套常量，别名或者新的类型定义。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=nc>Foo</span> <span class=p>{</span>
  <span class=k>struct</span> <span class=nc>Bar</span> <span class=p>{</span>
    <span class=cp>#...
</span><span class=cp></span>  <span class=p>}</span>
  <span class=n>bar</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>Bar</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>struct</span> <span class=nc>Baz</span> <span class=p>{</span>
  <span class=n>bar</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>Foo</span><span class=p>.</span><span class=n>Bar</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面Baz里面我们通过<code>Foo.Bar</code>来进行类型的获取。</p>
<p>我们可以使用using对一个类型设置别名。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=nc>Qux</span> <span class=p>{</span>
  <span class=k>using</span> <span class=n>Foo</span><span class=p>.</span><span class=n>Bar</span><span class=p>;</span>
  <span class=n>bar</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>Bar</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>struct</span> <span class=nc>Corge</span> <span class=p>{</span>
  <span class=k>using</span> <span class=n>T</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>.</span><span class=n>Bar</span><span class=p>;</span>
  <span class=n>bar</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>T</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=导入>导入</h3>
<p>我们通过import导入其他文件的类型定义</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>struct</span> <span class=nc>Foo</span> <span class=p>{</span>
  <span class=cp># Use type &#34;Baz&#34; defined in bar.capnp.
</span><span class=cp></span>  <span class=n>baz</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>import</span> <span class=s>&#34;bar.capnp&#34;</span><span class=p>.</span><span class=n>Baz</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以直接使用using来设置别名</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>using</span> <span class=n>Bar</span> <span class=o>=</span> <span class=n>import</span> <span class=s>&#34;bar.capnp&#34;</span><span class=p>;</span>

<span class=k>struct</span> <span class=nc>Foo</span> <span class=p>{</span>
  <span class=cp># Use type &#34;Baz&#34; defined in bar.capnp.
</span><span class=cp></span>  <span class=n>baz</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>Bar</span><span class=p>.</span><span class=n>Baz</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>或者这样</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=k>using</span> <span class=n>import</span> <span class=s>&#34;bar.capnp&#34;</span><span class=p>.</span><span class=n>Baz</span><span class=p>;</span>

<span class=k>struct</span> <span class=nc>Foo</span> <span class=p>{</span>
  <span class=n>baz</span> <span class=err>@</span><span class=mi>0</span> <span class=o>:</span><span class=n>Baz</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=注解>注解</h3>
<p>有时候我们需要在Cap&rsquo;n Proto上面附加一些不属于Cap&rsquo;n Proto的自有协议。这就是Annotation，不过话说真有必要吗？这里还是先忽略吧。</p>
<h3 id=唯一id>唯一ID</h3>
<p>每个Cap&rsquo;n Proto文件都必须有唯一的一个64bit ID，使用<code>capnp id</code>生成。譬如最开始例子里面的file ID</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=err>#</span> <span class=nt>file</span> <span class=nt>ID</span>
<span class=p>@</span><span class=k>0xdbb9ad1f14bf0b36</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>其实struct，enum这些的也需要定义ID，但默认情况下面，我们都是自动生成的。</p>
<p>64位的ID还是很可能冲突的，但是实际不用考虑这样的情况，反而是错误的使用（譬如copy了一个example但没有更改file ID）更可能导致冲突。</p>
<h2 id=升级协议>升级协议</h2>
<p>如果我们要升级定义的协议，需要注意：</p>
<ul>
<li>新的类型，常量或者别名可以添加到任何地方，他们不会影响现有的类型。</li>
<li>新的fields，enumerants以及methods需要使用比之前都要大的编号。</li>
<li>新加入到method里面的参数必须添加到参数列表的最后，并且有默认值。</li>
<li>成员可以随意在文件里面变换位置，只要number不变。</li>
<li>符号名字可以任意更改，只要ID和number别换就行了。但要注意默认生成的ID是根据父ID以及name来生成的，所以我们需要通过<code>capnp compile -ocapnp myschema.capnp</code>找到这个名字关联的ID并且在改名后显示的定义。</li>
<li>类型定义可以移动到任意的作用域，只要ID显示声明。</li>
<li>一个field可以被移入union或者group里面，就像在struct里面替换了以前的field，新加入了一个group或者union。</li>
<li>一个非泛型的类型可以变成泛型。（话说对于泛型的研究后续在考虑吧，总觉得没必要弄得这么复杂）</li>
</ul>
<p>有一些操作是不安全的：</p>
<ul>
<li>别更改field，method或者enum的number号。</li>
<li>别更改field，method参数的类型或者默认值。</li>
<li>别更改type的ID。</li>
<li>别随便更改没有显示ID的类型名字。</li>
<li>不能将没有显示ID的类型随便移到其他的作用域里面。</li>
<li>不能将一个已经存在的field移入/移除到一个已经存在的union里面。</li>
</ul>
<h2 id=参考-1>参考</h2>
<ol>
<li>
<p><a href=https://capnproto.org/otherlang.html>Cap&rsquo;n Proto: Other Languages</a></p>
</li>
<li></li>
</ol>
</div>
<div class=post-copyright>
<p class=copyright-item>
<span class=item-title>文章作者</span>
<span class=item-content>Justice</span>
</p>
<p class=copyright-item>
<span class=item-title>上次更新</span>
<span class=item-content>
2021-10-10 15:57:04
</span>
</p>
<p class=copyright-item>
<span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span>
</p>
</div>
<div class=post-reward>
<input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label>
<div class=qr-code>
<label class=qr-code-image for=reward>
<img class=image src=/image/wx_reward_qrcode.png>
<span>微信打赏</span>
</label>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://justice.bj.cn/tags/data_struct.html>data_struct</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/40.storage/etcd-raft.html>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Etcd_Raft</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/30.architech/graphdb/orientdb.html>
<span class="next-text nav-default">OrientDB</span>
<span class="prev-text nav-mobile">下一篇</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
<div class="post bg-white">
<script src=https://utteranc.es/client.js repo=ZhuZhengyi/gh_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=mailto:justice_103@126.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a>
<a href=https://justice.bj.cn/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2000 -
2022
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Justice
</span></span>
<span id=busuanzi_container>
访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript>window.MathJax={showProcessingMessages:!1,messageStyle:'none'}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css integrity=sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js integrity=sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{})})</script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script>$("#openSearch, #openSearchMobile").click(function(){$(".modal-dialog").addClass("visible")}),$("#closeSearch").click(function(){$(".modal-dialog").removeClass("visible")}),$(document).click(function(a){$(a.target).closest(".modal-content, #openSearch, #openSearchMobile").length||$("body").find(".modal-dialog").removeClass("visible")})</script>
<script src=/js/l2d/L2Dwidget.min.js></script>
<script src=/js/l2d/L2Dwidget.0.min.js></script>
<script src=/js/l2d/L2Dwidget.init.js></script>
</body>
</html>